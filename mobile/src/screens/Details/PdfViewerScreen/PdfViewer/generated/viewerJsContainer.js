
  const bundle = 'LyoqCiAqIEBsaWNzdGFydCBUaGUgZm9sbG93aW5nIGlzIHRoZSBlbnRpcmUgbGljZW5zZSBub3RpY2UgZm9yIHRoZQogKiBKYXZhc2NyaXB0IGNvZGUgaW4gdGhpcyBwYWdlCiAqCiAqIENvcHlyaWdodCAyMDIwIE1vemlsbGEgRm91bmRhdGlvbgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLgogKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICoKICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMAogKgogKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsCiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgogKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKgogKiBAbGljZW5kIFRoZSBhYm92ZSBpcyB0aGUgZW50aXJlIGxpY2Vuc2Ugbm90aWNlIGZvciB0aGUKICogSmF2YXNjcmlwdCBjb2RlIGluIHRoaXMgcGFnZQogKi8KCi8qKioqKiovIChmdW5jdGlvbihtb2R1bGVzKSB7IC8vIHdlYnBhY2tCb290c3RyYXAKLyoqKioqKi8gCS8vIFRoZSBtb2R1bGUgY2FjaGUKLyoqKioqKi8gCXZhciBpbnN0YWxsZWRNb2R1bGVzID0ge307Ci8qKioqKiovCi8qKioqKiovIAkvLyBUaGUgcmVxdWlyZSBmdW5jdGlvbgovKioqKioqLyAJZnVuY3Rpb24gX193ZWJwYWNrX3JlcXVpcmVfXyhtb2R1bGVJZCkgewovKioqKioqLwovKioqKioqLyAJCS8vIENoZWNrIGlmIG1vZHVsZSBpcyBpbiBjYWNoZQovKioqKioqLyAJCWlmKGluc3RhbGxlZE1vZHVsZXNbbW9kdWxlSWRdKSB7Ci8qKioqKiovIAkJCXJldHVybiBpbnN0YWxsZWRNb2R1bGVzW21vZHVsZUlkXS5leHBvcnRzOwovKioqKioqLyAJCX0KLyoqKioqKi8gCQkvLyBDcmVhdGUgYSBuZXcgbW9kdWxlIChhbmQgcHV0IGl0IGludG8gdGhlIGNhY2hlKQovKioqKioqLyAJCXZhciBtb2R1bGUgPSBpbnN0YWxsZWRNb2R1bGVzW21vZHVsZUlkXSA9IHsKLyoqKioqKi8gCQkJaTogbW9kdWxlSWQsCi8qKioqKiovIAkJCWw6IGZhbHNlLAovKioqKioqLyAJCQlleHBvcnRzOiB7fQovKioqKioqLyAJCX07Ci8qKioqKiovCi8qKioqKiovIAkJLy8gRXhlY3V0ZSB0aGUgbW9kdWxlIGZ1bmN0aW9uCi8qKioqKiovIAkJbW9kdWxlc1ttb2R1bGVJZF0uY2FsbChtb2R1bGUuZXhwb3J0cywgbW9kdWxlLCBtb2R1bGUuZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXyk7Ci8qKioqKiovCi8qKioqKiovIAkJLy8gRmxhZyB0aGUgbW9kdWxlIGFzIGxvYWRlZAovKioqKioqLyAJCW1vZHVsZS5sID0gdHJ1ZTsKLyoqKioqKi8KLyoqKioqKi8gCQkvLyBSZXR1cm4gdGhlIGV4cG9ydHMgb2YgdGhlIG1vZHVsZQovKioqKioqLyAJCXJldHVybiBtb2R1bGUuZXhwb3J0czsKLyoqKioqKi8gCX0KLyoqKioqKi8KLyoqKioqKi8KLyoqKioqKi8gCS8vIGV4cG9zZSB0aGUgbW9kdWxlcyBvYmplY3QgKF9fd2VicGFja19tb2R1bGVzX18pCi8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fLm0gPSBtb2R1bGVzOwovKioqKioqLwovKioqKioqLyAJLy8gZXhwb3NlIHRoZSBtb2R1bGUgY2FjaGUKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18uYyA9IGluc3RhbGxlZE1vZHVsZXM7Ci8qKioqKiovCi8qKioqKiovIAkvLyBkZWZpbmUgZ2V0dGVyIGZ1bmN0aW9uIGZvciBoYXJtb255IGV4cG9ydHMKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18uZCA9IGZ1bmN0aW9uKGV4cG9ydHMsIG5hbWUsIGdldHRlcikgewovKioqKioqLyAJCWlmKCFfX3dlYnBhY2tfcmVxdWlyZV9fLm8oZXhwb3J0cywgbmFtZSkpIHsKLyoqKioqKi8gCQkJT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIG5hbWUsIHsgZW51bWVyYWJsZTogdHJ1ZSwgZ2V0OiBnZXR0ZXIgfSk7Ci8qKioqKiovIAkJfQovKioqKioqLyAJfTsKLyoqKioqKi8KLyoqKioqKi8gCS8vIGRlZmluZSBfX2VzTW9kdWxlIG9uIGV4cG9ydHMKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18uciA9IGZ1bmN0aW9uKGV4cG9ydHMpIHsKLyoqKioqKi8gCQlpZih0eXBlb2YgU3ltYm9sICE9PSAndW5kZWZpbmVkJyAmJiBTeW1ib2wudG9TdHJpbmdUYWcpIHsKLyoqKioqKi8gCQkJT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogJ01vZHVsZScgfSk7Ci8qKioqKiovIAkJfQovKioqKioqLyAJCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsgdmFsdWU6IHRydWUgfSk7Ci8qKioqKiovIAl9OwovKioqKioqLwovKioqKioqLyAJLy8gY3JlYXRlIGEgZmFrZSBuYW1lc3BhY2Ugb2JqZWN0Ci8qKioqKiovIAkvLyBtb2RlICYgMTogdmFsdWUgaXMgYSBtb2R1bGUgaWQsIHJlcXVpcmUgaXQKLyoqKioqKi8gCS8vIG1vZGUgJiAyOiBtZXJnZSBhbGwgcHJvcGVydGllcyBvZiB2YWx1ZSBpbnRvIHRoZSBucwovKioqKioqLyAJLy8gbW9kZSAmIDQ6IHJldHVybiB2YWx1ZSB3aGVuIGFscmVhZHkgbnMgb2JqZWN0Ci8qKioqKiovIAkvLyBtb2RlICYgOHwxOiBiZWhhdmUgbGlrZSByZXF1aXJlCi8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fLnQgPSBmdW5jdGlvbih2YWx1ZSwgbW9kZSkgewovKioqKioqLyAJCWlmKG1vZGUgJiAxKSB2YWx1ZSA9IF9fd2VicGFja19yZXF1aXJlX18odmFsdWUpOwovKioqKioqLyAJCWlmKG1vZGUgJiA4KSByZXR1cm4gdmFsdWU7Ci8qKioqKiovIAkJaWYoKG1vZGUgJiA0KSAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmIHZhbHVlICYmIHZhbHVlLl9fZXNNb2R1bGUpIHJldHVybiB2YWx1ZTsKLyoqKioqKi8gCQl2YXIgbnMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwovKioqKioqLyAJCV9fd2VicGFja19yZXF1aXJlX18ucihucyk7Ci8qKioqKiovIAkJT2JqZWN0LmRlZmluZVByb3BlcnR5KG5zLCAnZGVmYXVsdCcsIHsgZW51bWVyYWJsZTogdHJ1ZSwgdmFsdWU6IHZhbHVlIH0pOwovKioqKioqLyAJCWlmKG1vZGUgJiAyICYmIHR5cGVvZiB2YWx1ZSAhPSAnc3RyaW5nJykgZm9yKHZhciBrZXkgaW4gdmFsdWUpIF9fd2VicGFja19yZXF1aXJlX18uZChucywga2V5LCBmdW5jdGlvbihrZXkpIHsgcmV0dXJuIHZhbHVlW2tleV07IH0uYmluZChudWxsLCBrZXkpKTsKLyoqKioqKi8gCQlyZXR1cm4gbnM7Ci8qKioqKiovIAl9OwovKioqKioqLwovKioqKioqLyAJLy8gZ2V0RGVmYXVsdEV4cG9ydCBmdW5jdGlvbiBmb3IgY29tcGF0aWJpbGl0eSB3aXRoIG5vbi1oYXJtb255IG1vZHVsZXMKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18ubiA9IGZ1bmN0aW9uKG1vZHVsZSkgewovKioqKioqLyAJCXZhciBnZXR0ZXIgPSBtb2R1bGUgJiYgbW9kdWxlLl9fZXNNb2R1bGUgPwovKioqKioqLyAJCQlmdW5jdGlvbiBnZXREZWZhdWx0KCkgeyByZXR1cm4gbW9kdWxlWydkZWZhdWx0J107IH0gOgovKioqKioqLyAJCQlmdW5jdGlvbiBnZXRNb2R1bGVFeHBvcnRzKCkgeyByZXR1cm4gbW9kdWxlOyB9OwovKioqKioqLyAJCV9fd2VicGFja19yZXF1aXJlX18uZChnZXR0ZXIsICdhJywgZ2V0dGVyKTsKLyoqKioqKi8gCQlyZXR1cm4gZ2V0dGVyOwovKioqKioqLyAJfTsKLyoqKioqKi8KLyoqKioqKi8gCS8vIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbAovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXy5vID0gZnVuY3Rpb24ob2JqZWN0LCBwcm9wZXJ0eSkgeyByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwgcHJvcGVydHkpOyB9OwovKioqKioqLwovKioqKioqLyAJLy8gX193ZWJwYWNrX3B1YmxpY19wYXRoX18KLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18ucCA9ICIiOwovKioqKioqLwovKioqKioqLwovKioqKioqLyAJLy8gTG9hZCBlbnRyeSBtb2R1bGUgYW5kIHJldHVybiBleHBvcnRzCi8qKioqKiovIAlyZXR1cm4gX193ZWJwYWNrX3JlcXVpcmVfXyhfX3dlYnBhY2tfcmVxdWlyZV9fLnMgPSAwKTsKLyoqKioqKi8gfSkKLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KLyoqKioqKi8gKFsKLyogMCAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoidXNlIHN0cmljdCI7CgoKOwp2YXIgcGRmanNXZWJBcHAsIHBkZmpzV2ViQXBwT3B0aW9uczsKewogIHBkZmpzV2ViQXBwID0gX193ZWJwYWNrX3JlcXVpcmVfXygxKTsKICBwZGZqc1dlYkFwcE9wdGlvbnMgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpOwp9CjsKewogIF9fd2VicGFja19yZXF1aXJlX18oMzYpOwp9CjsKewogIF9fd2VicGFja19yZXF1aXJlX18oNDEpOwp9CgpmdW5jdGlvbiBnZXRWaWV3ZXJDb25maWd1cmF0aW9uKCkgewogIHJldHVybiB7CiAgICBhcHBDb250YWluZXI6IGRvY3VtZW50LmJvZHksCiAgICBtYWluQ29udGFpbmVyOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgidmlld2VyQ29udGFpbmVyIiksCiAgICB2aWV3ZXJDb250YWluZXI6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ2aWV3ZXIiKSwKICAgIGV2ZW50QnVzOiBudWxsLAogICAgdG9vbGJhcjogewogICAgICBjb250YWluZXI6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ0b29sYmFyVmlld2VyIiksCiAgICAgIG51bVBhZ2VzOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibnVtUGFnZXMiKSwKICAgICAgcGFnZU51bWJlcjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInBhZ2VOdW1iZXIiKSwKICAgICAgc2NhbGVTZWxlY3RDb250YWluZXI6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzY2FsZVNlbGVjdENvbnRhaW5lciIpLAogICAgICBzY2FsZVNlbGVjdDogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInNjYWxlU2VsZWN0IiksCiAgICAgIGN1c3RvbVNjYWxlT3B0aW9uOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY3VzdG9tU2NhbGVPcHRpb24iKSwKICAgICAgcHJldmlvdXM6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJwcmV2aW91cyIpLAogICAgICBuZXh0OiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibmV4dCIpLAogICAgICB6b29tSW46IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ6b29tSW4iKSwKICAgICAgem9vbU91dDogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInpvb21PdXQiKSwKICAgICAgdmlld0ZpbmQ6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ2aWV3RmluZCIpLAogICAgICBvcGVuRmlsZTogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm9wZW5GaWxlIiksCiAgICAgIHByaW50OiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicHJpbnQiKSwKICAgICAgcHJlc2VudGF0aW9uTW9kZUJ1dHRvbjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInByZXNlbnRhdGlvbk1vZGUiKSwKICAgICAgZG93bmxvYWQ6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJkb3dubG9hZCIpLAogICAgICB2aWV3Qm9va21hcms6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ2aWV3Qm9va21hcmsiKQogICAgfSwKICAgIHNlY29uZGFyeVRvb2xiYXI6IHsKICAgICAgdG9vbGJhcjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInNlY29uZGFyeVRvb2xiYXIiKSwKICAgICAgdG9nZ2xlQnV0dG9uOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgic2Vjb25kYXJ5VG9vbGJhclRvZ2dsZSIpLAogICAgICB0b29sYmFyQnV0dG9uQ29udGFpbmVyOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgic2Vjb25kYXJ5VG9vbGJhckJ1dHRvbkNvbnRhaW5lciIpLAogICAgICBwcmVzZW50YXRpb25Nb2RlQnV0dG9uOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgic2Vjb25kYXJ5UHJlc2VudGF0aW9uTW9kZSIpLAogICAgICBvcGVuRmlsZUJ1dHRvbjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInNlY29uZGFyeU9wZW5GaWxlIiksCiAgICAgIHByaW50QnV0dG9uOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgic2Vjb25kYXJ5UHJpbnQiKSwKICAgICAgZG93bmxvYWRCdXR0b246IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzZWNvbmRhcnlEb3dubG9hZCIpLAogICAgICB2aWV3Qm9va21hcmtCdXR0b246IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzZWNvbmRhcnlWaWV3Qm9va21hcmsiKSwKICAgICAgZmlyc3RQYWdlQnV0dG9uOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZmlyc3RQYWdlIiksCiAgICAgIGxhc3RQYWdlQnV0dG9uOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibGFzdFBhZ2UiKSwKICAgICAgcGFnZVJvdGF0ZUN3QnV0dG9uOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicGFnZVJvdGF0ZUN3IiksCiAgICAgIHBhZ2VSb3RhdGVDY3dCdXR0b246IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJwYWdlUm90YXRlQ2N3IiksCiAgICAgIGN1cnNvclNlbGVjdFRvb2xCdXR0b246IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjdXJzb3JTZWxlY3RUb29sIiksCiAgICAgIGN1cnNvckhhbmRUb29sQnV0dG9uOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY3Vyc29ySGFuZFRvb2wiKSwKICAgICAgc2Nyb2xsVmVydGljYWxCdXR0b246IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzY3JvbGxWZXJ0aWNhbCIpLAogICAgICBzY3JvbGxIb3Jpem9udGFsQnV0dG9uOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgic2Nyb2xsSG9yaXpvbnRhbCIpLAogICAgICBzY3JvbGxXcmFwcGVkQnV0dG9uOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgic2Nyb2xsV3JhcHBlZCIpLAogICAgICBzcHJlYWROb25lQnV0dG9uOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgic3ByZWFkTm9uZSIpLAogICAgICBzcHJlYWRPZGRCdXR0b246IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzcHJlYWRPZGQiKSwKICAgICAgc3ByZWFkRXZlbkJ1dHRvbjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInNwcmVhZEV2ZW4iKSwKICAgICAgZG9jdW1lbnRQcm9wZXJ0aWVzQnV0dG9uOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZG9jdW1lbnRQcm9wZXJ0aWVzIikKICAgIH0sCiAgICBmdWxsc2NyZWVuOiB7CiAgICAgIGNvbnRleHRGaXJzdFBhZ2U6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjb250ZXh0Rmlyc3RQYWdlIiksCiAgICAgIGNvbnRleHRMYXN0UGFnZTogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImNvbnRleHRMYXN0UGFnZSIpLAogICAgICBjb250ZXh0UGFnZVJvdGF0ZUN3OiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY29udGV4dFBhZ2VSb3RhdGVDdyIpLAogICAgICBjb250ZXh0UGFnZVJvdGF0ZUNjdzogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImNvbnRleHRQYWdlUm90YXRlQ2N3IikKICAgIH0sCiAgICBzaWRlYmFyOiB7CiAgICAgIG91dGVyQ29udGFpbmVyOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgib3V0ZXJDb250YWluZXIiKSwKICAgICAgdmlld2VyQ29udGFpbmVyOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgidmlld2VyQ29udGFpbmVyIiksCiAgICAgIHRvZ2dsZUJ1dHRvbjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInNpZGViYXJUb2dnbGUiKSwKICAgICAgdGh1bWJuYWlsQnV0dG9uOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgidmlld1RodW1ibmFpbCIpLAogICAgICBvdXRsaW5lQnV0dG9uOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgidmlld091dGxpbmUiKSwKICAgICAgYXR0YWNobWVudHNCdXR0b246IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ2aWV3QXR0YWNobWVudHMiKSwKICAgICAgdGh1bWJuYWlsVmlldzogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInRodW1ibmFpbFZpZXciKSwKICAgICAgb3V0bGluZVZpZXc6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJvdXRsaW5lVmlldyIpLAogICAgICBhdHRhY2htZW50c1ZpZXc6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJhdHRhY2htZW50c1ZpZXciKQogICAgfSwKICAgIHNpZGViYXJSZXNpemVyOiB7CiAgICAgIG91dGVyQ29udGFpbmVyOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgib3V0ZXJDb250YWluZXIiKSwKICAgICAgcmVzaXplcjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInNpZGViYXJSZXNpemVyIikKICAgIH0sCiAgICBmaW5kQmFyOiB7CiAgICAgIGJhcjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImZpbmRiYXIiKSwKICAgICAgdG9nZ2xlQnV0dG9uOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgidmlld0ZpbmQiKSwKICAgICAgZmluZEZpZWxkOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZmluZElucHV0IiksCiAgICAgIGhpZ2hsaWdodEFsbENoZWNrYm94OiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZmluZEhpZ2hsaWdodEFsbCIpLAogICAgICBjYXNlU2Vuc2l0aXZlQ2hlY2tib3g6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJmaW5kTWF0Y2hDYXNlIiksCiAgICAgIGVudGlyZVdvcmRDaGVja2JveDogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImZpbmRFbnRpcmVXb3JkIiksCiAgICAgIGZpbmRNc2c6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJmaW5kTXNnIiksCiAgICAgIGZpbmRSZXN1bHRzQ291bnQ6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJmaW5kUmVzdWx0c0NvdW50IiksCiAgICAgIGZpbmRQcmV2aW91c0J1dHRvbjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImZpbmRQcmV2aW91cyIpLAogICAgICBmaW5kTmV4dEJ1dHRvbjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImZpbmROZXh0IikKICAgIH0sCiAgICBwYXNzd29yZE92ZXJsYXk6IHsKICAgICAgb3ZlcmxheU5hbWU6ICJwYXNzd29yZE92ZXJsYXkiLAogICAgICBjb250YWluZXI6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJwYXNzd29yZE92ZXJsYXkiKSwKICAgICAgbGFiZWw6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJwYXNzd29yZFRleHQiKSwKICAgICAgaW5wdXQ6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJwYXNzd29yZCIpLAogICAgICBzdWJtaXRCdXR0b246IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJwYXNzd29yZFN1Ym1pdCIpLAogICAgICBjYW5jZWxCdXR0b246IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJwYXNzd29yZENhbmNlbCIpCiAgICB9LAogICAgZG9jdW1lbnRQcm9wZXJ0aWVzOiB7CiAgICAgIG92ZXJsYXlOYW1lOiAiZG9jdW1lbnRQcm9wZXJ0aWVzT3ZlcmxheSIsCiAgICAgIGNvbnRhaW5lcjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImRvY3VtZW50UHJvcGVydGllc092ZXJsYXkiKSwKICAgICAgY2xvc2VCdXR0b246IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJkb2N1bWVudFByb3BlcnRpZXNDbG9zZSIpLAogICAgICBmaWVsZHM6IHsKICAgICAgICBmaWxlTmFtZTogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImZpbGVOYW1lRmllbGQiKSwKICAgICAgICBmaWxlU2l6ZTogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImZpbGVTaXplRmllbGQiKSwKICAgICAgICB0aXRsZTogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInRpdGxlRmllbGQiKSwKICAgICAgICBhdXRob3I6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJhdXRob3JGaWVsZCIpLAogICAgICAgIHN1YmplY3Q6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzdWJqZWN0RmllbGQiKSwKICAgICAgICBrZXl3b3JkczogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImtleXdvcmRzRmllbGQiKSwKICAgICAgICBjcmVhdGlvbkRhdGU6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjcmVhdGlvbkRhdGVGaWVsZCIpLAogICAgICAgIG1vZGlmaWNhdGlvbkRhdGU6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJtb2RpZmljYXRpb25EYXRlRmllbGQiKSwKICAgICAgICBjcmVhdG9yOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY3JlYXRvckZpZWxkIiksCiAgICAgICAgcHJvZHVjZXI6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJwcm9kdWNlckZpZWxkIiksCiAgICAgICAgdmVyc2lvbjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInZlcnNpb25GaWVsZCIpLAogICAgICAgIHBhZ2VDb3VudDogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInBhZ2VDb3VudEZpZWxkIiksCiAgICAgICAgcGFnZVNpemU6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJwYWdlU2l6ZUZpZWxkIiksCiAgICAgICAgbGluZWFyaXplZDogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImxpbmVhcml6ZWRGaWVsZCIpCiAgICAgIH0KICAgIH0sCiAgICBlcnJvcldyYXBwZXI6IHsKICAgICAgY29udGFpbmVyOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZXJyb3JXcmFwcGVyIiksCiAgICAgIGVycm9yTWVzc2FnZTogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImVycm9yTWVzc2FnZSIpLAogICAgICBjbG9zZUJ1dHRvbjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImVycm9yQ2xvc2UiKSwKICAgICAgZXJyb3JNb3JlSW5mbzogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImVycm9yTW9yZUluZm8iKSwKICAgICAgbW9yZUluZm9CdXR0b246IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJlcnJvclNob3dNb3JlIiksCiAgICAgIGxlc3NJbmZvQnV0dG9uOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZXJyb3JTaG93TGVzcyIpCiAgICB9LAogICAgcHJpbnRDb250YWluZXI6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJwcmludENvbnRhaW5lciIpLAogICAgb3BlbkZpbGVJbnB1dE5hbWU6ICJmaWxlSW5wdXQiLAogICAgZGVidWdnZXJTY3JpcHRQYXRoOiAiLi9kZWJ1Z2dlci5qcyIKICB9Owp9CgpmdW5jdGlvbiB3ZWJWaWV3ZXJMb2FkKCkgewogIHZhciBjb25maWcgPSBnZXRWaWV3ZXJDb25maWd1cmF0aW9uKCk7CiAgd2luZG93LlBERlZpZXdlckFwcGxpY2F0aW9uID0gcGRmanNXZWJBcHAuUERGVmlld2VyQXBwbGljYXRpb247CiAgd2luZG93LlBERlZpZXdlckFwcGxpY2F0aW9uT3B0aW9ucyA9IHBkZmpzV2ViQXBwT3B0aW9ucy5BcHBPcHRpb25zOwogIHZhciBldmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCJDdXN0b21FdmVudCIpOwogIGV2ZW50LmluaXRDdXN0b21FdmVudCgid2Vidmlld2VybG9hZGVkIiwgdHJ1ZSwgdHJ1ZSwgewogICAgc291cmNlOiB3aW5kb3cKICB9KTsKCiAgdHJ5IHsKICAgIHBhcmVudC5kb2N1bWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICB9IGNhdGNoIChleCkgewogICAgY29uc29sZS5lcnJvcigid2Vidmlld2VybG9hZGVkOiAiLmNvbmNhdChleCkpOwogICAgZG9jdW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgfQoKICBwZGZqc1dlYkFwcC5QREZWaWV3ZXJBcHBsaWNhdGlvbi5ydW4oY29uZmlnKTsKfQoKaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJpbnRlcmFjdGl2ZSIgfHwgZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIikgewogIHdlYlZpZXdlckxvYWQoKTsKfSBlbHNlIHsKICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgd2ViVmlld2VyTG9hZCwgdHJ1ZSk7Cn0KCi8qKiovIH0pLAovKiAxICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuUERGUHJpbnRTZXJ2aWNlRmFjdG9yeSA9IGV4cG9ydHMuRGVmYXVsdEV4dGVybmFsU2VydmljZXMgPSBleHBvcnRzLlBERlZpZXdlckFwcGxpY2F0aW9uID0gdm9pZCAwOwoKdmFyIF9yZWdlbmVyYXRvciA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX193ZWJwYWNrX3JlcXVpcmVfXygyKSk7Cgp2YXIgX3VpX3V0aWxzID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1KTsKCnZhciBfYXBwX29wdGlvbnMgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpOwoKdmFyIF9wZGZqc0xpYiA9IF9fd2VicGFja19yZXF1aXJlX18oOCk7Cgp2YXIgX3BkZl9jdXJzb3JfdG9vbHMgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDkpOwoKdmFyIF9wZGZfcmVuZGVyaW5nX3F1ZXVlID0gX193ZWJwYWNrX3JlcXVpcmVfXygxMSk7Cgp2YXIgX3BkZl9zaWRlYmFyID0gX193ZWJwYWNrX3JlcXVpcmVfXygxMik7Cgp2YXIgX292ZXJsYXlfbWFuYWdlciA9IF9fd2VicGFja19yZXF1aXJlX18oMTMpOwoKdmFyIF9wYXNzd29yZF9wcm9tcHQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDE0KTsKCnZhciBfcGRmX2F0dGFjaG1lbnRfdmlld2VyID0gX193ZWJwYWNrX3JlcXVpcmVfXygxNSk7Cgp2YXIgX3BkZl9kb2N1bWVudF9wcm9wZXJ0aWVzID0gX193ZWJwYWNrX3JlcXVpcmVfXygxNik7Cgp2YXIgX3BkZl9maW5kX2JhciA9IF9fd2VicGFja19yZXF1aXJlX18oMTcpOwoKdmFyIF9wZGZfZmluZF9jb250cm9sbGVyID0gX193ZWJwYWNrX3JlcXVpcmVfXygxOCk7Cgp2YXIgX3BkZl9oaXN0b3J5ID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMCk7Cgp2YXIgX3BkZl9saW5rX3NlcnZpY2UgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIxKTsKCnZhciBfcGRmX291dGxpbmVfdmlld2VyID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMik7Cgp2YXIgX3BkZl9wcmVzZW50YXRpb25fbW9kZSA9IF9fd2VicGFja19yZXF1aXJlX18oMjMpOwoKdmFyIF9wZGZfc2lkZWJhcl9yZXNpemVyID0gX193ZWJwYWNrX3JlcXVpcmVfXygyNCk7Cgp2YXIgX3BkZl90aHVtYm5haWxfdmlld2VyID0gX193ZWJwYWNrX3JlcXVpcmVfXygyNSk7Cgp2YXIgX3BkZl92aWV3ZXIgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDI3KTsKCnZhciBfc2Vjb25kYXJ5X3Rvb2xiYXIgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMyKTsKCnZhciBfdG9vbGJhciA9IF9fd2VicGFja19yZXF1aXJlX18oMzQpOwoKdmFyIF92aWV3X2hpc3RvcnkgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDM1KTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ICJkZWZhdWx0Ijogb2JqIH07IH0KCmZ1bmN0aW9uIF9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyKG8sIGFsbG93QXJyYXlMaWtlKSB7IHZhciBpdDsgaWYgKHR5cGVvZiBTeW1ib2wgPT09ICJ1bmRlZmluZWQiIHx8IG9bU3ltYm9sLml0ZXJhdG9yXSA9PSBudWxsKSB7IGlmIChBcnJheS5pc0FycmF5KG8pIHx8IChpdCA9IF91bnN1cHBvcnRlZEl0ZXJhYmxlVG9BcnJheShvKSkgfHwgYWxsb3dBcnJheUxpa2UgJiYgbyAmJiB0eXBlb2Ygby5sZW5ndGggPT09ICJudW1iZXIiKSB7IGlmIChpdCkgbyA9IGl0OyB2YXIgaSA9IDA7IHZhciBGID0gZnVuY3Rpb24gRigpIHt9OyByZXR1cm4geyBzOiBGLCBuOiBmdW5jdGlvbiBuKCkgeyBpZiAoaSA+PSBvLmxlbmd0aCkgcmV0dXJuIHsgZG9uZTogdHJ1ZSB9OyByZXR1cm4geyBkb25lOiBmYWxzZSwgdmFsdWU6IG9baSsrXSB9OyB9LCBlOiBmdW5jdGlvbiBlKF9lMikgeyB0aHJvdyBfZTI7IH0sIGY6IEYgfTsgfSB0aHJvdyBuZXcgVHlwZUVycm9yKCJJbnZhbGlkIGF0dGVtcHQgdG8gaXRlcmF0ZSBub24taXRlcmFibGUgaW5zdGFuY2UuXG5JbiBvcmRlciB0byBiZSBpdGVyYWJsZSwgbm9uLWFycmF5IG9iamVjdHMgbXVzdCBoYXZlIGEgW1N5bWJvbC5pdGVyYXRvcl0oKSBtZXRob2QuIik7IH0gdmFyIG5vcm1hbENvbXBsZXRpb24gPSB0cnVlLCBkaWRFcnIgPSBmYWxzZSwgZXJyOyByZXR1cm4geyBzOiBmdW5jdGlvbiBzKCkgeyBpdCA9IG9bU3ltYm9sLml0ZXJhdG9yXSgpOyB9LCBuOiBmdW5jdGlvbiBuKCkgeyB2YXIgc3RlcCA9IGl0Lm5leHQoKTsgbm9ybWFsQ29tcGxldGlvbiA9IHN0ZXAuZG9uZTsgcmV0dXJuIHN0ZXA7IH0sIGU6IGZ1bmN0aW9uIGUoX2UzKSB7IGRpZEVyciA9IHRydWU7IGVyciA9IF9lMzsgfSwgZjogZnVuY3Rpb24gZigpIHsgdHJ5IHsgaWYgKCFub3JtYWxDb21wbGV0aW9uICYmIGl0WyJyZXR1cm4iXSAhPSBudWxsKSBpdFsicmV0dXJuIl0oKTsgfSBmaW5hbGx5IHsgaWYgKGRpZEVycikgdGhyb3cgZXJyOyB9IH0gfTsgfQoKZnVuY3Rpb24gX3NsaWNlZFRvQXJyYXkoYXJyLCBpKSB7IHJldHVybiBfYXJyYXlXaXRoSG9sZXMoYXJyKSB8fCBfaXRlcmFibGVUb0FycmF5TGltaXQoYXJyLCBpKSB8fCBfdW5zdXBwb3J0ZWRJdGVyYWJsZVRvQXJyYXkoYXJyLCBpKSB8fCBfbm9uSXRlcmFibGVSZXN0KCk7IH0KCmZ1bmN0aW9uIF9ub25JdGVyYWJsZVJlc3QoKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkludmFsaWQgYXR0ZW1wdCB0byBkZXN0cnVjdHVyZSBub24taXRlcmFibGUgaW5zdGFuY2UuXG5JbiBvcmRlciB0byBiZSBpdGVyYWJsZSwgbm9uLWFycmF5IG9iamVjdHMgbXVzdCBoYXZlIGEgW1N5bWJvbC5pdGVyYXRvcl0oKSBtZXRob2QuIik7IH0KCmZ1bmN0aW9uIF91bnN1cHBvcnRlZEl0ZXJhYmxlVG9BcnJheShvLCBtaW5MZW4pIHsgaWYgKCFvKSByZXR1cm47IGlmICh0eXBlb2YgbyA9PT0gInN0cmluZyIpIHJldHVybiBfYXJyYXlMaWtlVG9BcnJheShvLCBtaW5MZW4pOyB2YXIgbiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvKS5zbGljZSg4LCAtMSk7IGlmIChuID09PSAiT2JqZWN0IiAmJiBvLmNvbnN0cnVjdG9yKSBuID0gby5jb25zdHJ1Y3Rvci5uYW1lOyBpZiAobiA9PT0gIk1hcCIgfHwgbiA9PT0gIlNldCIpIHJldHVybiBBcnJheS5mcm9tKG8pOyBpZiAobiA9PT0gIkFyZ3VtZW50cyIgfHwgL14oPzpVaXxJKW50KD86OHwxNnwzMikoPzpDbGFtcGVkKT9BcnJheSQvLnRlc3QobikpIHJldHVybiBfYXJyYXlMaWtlVG9BcnJheShvLCBtaW5MZW4pOyB9CgpmdW5jdGlvbiBfYXJyYXlMaWtlVG9BcnJheShhcnIsIGxlbikgeyBpZiAobGVuID09IG51bGwgfHwgbGVuID4gYXJyLmxlbmd0aCkgbGVuID0gYXJyLmxlbmd0aDsgZm9yICh2YXIgaSA9IDAsIGFycjIgPSBuZXcgQXJyYXkobGVuKTsgaSA8IGxlbjsgaSsrKSB7IGFycjJbaV0gPSBhcnJbaV07IH0gcmV0dXJuIGFycjI7IH0KCmZ1bmN0aW9uIF9pdGVyYWJsZVRvQXJyYXlMaW1pdChhcnIsIGkpIHsgaWYgKHR5cGVvZiBTeW1ib2wgPT09ICJ1bmRlZmluZWQiIHx8ICEoU3ltYm9sLml0ZXJhdG9yIGluIE9iamVjdChhcnIpKSkgcmV0dXJuOyB2YXIgX2FyciA9IFtdOyB2YXIgX24gPSB0cnVlOyB2YXIgX2QgPSBmYWxzZTsgdmFyIF9lID0gdW5kZWZpbmVkOyB0cnkgeyBmb3IgKHZhciBfaSA9IGFycltTeW1ib2wuaXRlcmF0b3JdKCksIF9zOyAhKF9uID0gKF9zID0gX2kubmV4dCgpKS5kb25lKTsgX24gPSB0cnVlKSB7IF9hcnIucHVzaChfcy52YWx1ZSk7IGlmIChpICYmIF9hcnIubGVuZ3RoID09PSBpKSBicmVhazsgfSB9IGNhdGNoIChlcnIpIHsgX2QgPSB0cnVlOyBfZSA9IGVycjsgfSBmaW5hbGx5IHsgdHJ5IHsgaWYgKCFfbiAmJiBfaVsicmV0dXJuIl0gIT0gbnVsbCkgX2lbInJldHVybiJdKCk7IH0gZmluYWxseSB7IGlmIChfZCkgdGhyb3cgX2U7IH0gfSByZXR1cm4gX2FycjsgfQoKZnVuY3Rpb24gX2FycmF5V2l0aEhvbGVzKGFycikgeyBpZiAoQXJyYXkuaXNBcnJheShhcnIpKSByZXR1cm4gYXJyOyB9CgpmdW5jdGlvbiBhc3luY0dlbmVyYXRvclN0ZXAoZ2VuLCByZXNvbHZlLCByZWplY3QsIF9uZXh0LCBfdGhyb3csIGtleSwgYXJnKSB7IHRyeSB7IHZhciBpbmZvID0gZ2VuW2tleV0oYXJnKTsgdmFyIHZhbHVlID0gaW5mby52YWx1ZTsgfSBjYXRjaCAoZXJyb3IpIHsgcmVqZWN0KGVycm9yKTsgcmV0dXJuOyB9IGlmIChpbmZvLmRvbmUpIHsgcmVzb2x2ZSh2YWx1ZSk7IH0gZWxzZSB7IFByb21pc2UucmVzb2x2ZSh2YWx1ZSkudGhlbihfbmV4dCwgX3Rocm93KTsgfSB9CgpmdW5jdGlvbiBfYXN5bmNUb0dlbmVyYXRvcihmbikgeyByZXR1cm4gZnVuY3Rpb24gKCkgeyB2YXIgc2VsZiA9IHRoaXMsIGFyZ3MgPSBhcmd1bWVudHM7IHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7IHZhciBnZW4gPSBmbi5hcHBseShzZWxmLCBhcmdzKTsgZnVuY3Rpb24gX25leHQodmFsdWUpIHsgYXN5bmNHZW5lcmF0b3JTdGVwKGdlbiwgcmVzb2x2ZSwgcmVqZWN0LCBfbmV4dCwgX3Rocm93LCAibmV4dCIsIHZhbHVlKTsgfSBmdW5jdGlvbiBfdGhyb3coZXJyKSB7IGFzeW5jR2VuZXJhdG9yU3RlcChnZW4sIHJlc29sdmUsIHJlamVjdCwgX25leHQsIF90aHJvdywgInRocm93IiwgZXJyKTsgfSBfbmV4dCh1bmRlZmluZWQpOyB9KTsgfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsgfSB9CgpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfQoKZnVuY3Rpb24gX2NyZWF0ZUNsYXNzKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH0KCnZhciBERUZBVUxUX1NDQUxFX0RFTFRBID0gMS4xOwp2YXIgRElTQUJMRV9BVVRPX0ZFVENIX0xPQURJTkdfQkFSX1RJTUVPVVQgPSA1MDAwOwp2YXIgRk9SQ0VfUEFHRVNfTE9BREVEX1RJTUVPVVQgPSAxMDAwMDsKdmFyIFdIRUVMX1pPT01fRElTQUJMRURfVElNRU9VVCA9IDEwMDA7CnZhciBFTkFCTEVfUEVSTUlTU0lPTlNfQ0xBU1MgPSAiZW5hYmxlUGVybWlzc2lvbnMiOwp2YXIgVmlld09uTG9hZCA9IHsKICBVTktOT1dOOiAtMSwKICBQUkVWSU9VUzogMCwKICBJTklUSUFMOiAxCn07Cgp2YXIgRGVmYXVsdEV4dGVybmFsU2VydmljZXMgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIERlZmF1bHRFeHRlcm5hbFNlcnZpY2VzKCkgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIERlZmF1bHRFeHRlcm5hbFNlcnZpY2VzKTsKCiAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBpbml0aWFsaXplIERlZmF1bHRFeHRlcm5hbFNlcnZpY2VzLiIpOwogIH0KCiAgX2NyZWF0ZUNsYXNzKERlZmF1bHRFeHRlcm5hbFNlcnZpY2VzLCBudWxsLCBbewogICAga2V5OiAidXBkYXRlRmluZENvbnRyb2xTdGF0ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdXBkYXRlRmluZENvbnRyb2xTdGF0ZShkYXRhKSB7fQogIH0sIHsKICAgIGtleTogInVwZGF0ZUZpbmRNYXRjaGVzQ291bnQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHVwZGF0ZUZpbmRNYXRjaGVzQ291bnQoZGF0YSkge30KICB9LCB7CiAgICBrZXk6ICJpbml0UGFzc2l2ZUxvYWRpbmciLAogICAgdmFsdWU6IGZ1bmN0aW9uIGluaXRQYXNzaXZlTG9hZGluZyhjYWxsYmFja3MpIHt9CiAgfSwgewogICAga2V5OiAiZmFsbGJhY2siLAogICAgdmFsdWU6IGZ1bmN0aW9uIGZhbGxiYWNrKGRhdGEsIGNhbGxiYWNrKSB7fQogIH0sIHsKICAgIGtleTogInJlcG9ydFRlbGVtZXRyeSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVwb3J0VGVsZW1ldHJ5KGRhdGEpIHt9CiAgfSwgewogICAga2V5OiAiY3JlYXRlRG93bmxvYWRNYW5hZ2VyIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVEb3dubG9hZE1hbmFnZXIob3B0aW9ucykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIk5vdCBpbXBsZW1lbnRlZDogY3JlYXRlRG93bmxvYWRNYW5hZ2VyIik7CiAgICB9CiAgfSwgewogICAga2V5OiAiY3JlYXRlUHJlZmVyZW5jZXMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZVByZWZlcmVuY2VzKCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIk5vdCBpbXBsZW1lbnRlZDogY3JlYXRlUHJlZmVyZW5jZXMiKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJjcmVhdGVMMTBuIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVMMTBuKG9wdGlvbnMpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJOb3QgaW1wbGVtZW50ZWQ6IGNyZWF0ZUwxMG4iKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJzdXBwb3J0c0ludGVncmF0ZWRGaW5kIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gKDAsIF9wZGZqc0xpYi5zaGFkb3cpKHRoaXMsICJzdXBwb3J0c0ludGVncmF0ZWRGaW5kIiwgZmFsc2UpOwogICAgfQogIH0sIHsKICAgIGtleTogInN1cHBvcnRzRG9jdW1lbnRGb250cyIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuICgwLCBfcGRmanNMaWIuc2hhZG93KSh0aGlzLCAic3VwcG9ydHNEb2N1bWVudEZvbnRzIiwgdHJ1ZSk7CiAgICB9CiAgfSwgewogICAga2V5OiAic3VwcG9ydGVkTW91c2VXaGVlbFpvb21Nb2RpZmllcktleXMiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiAoMCwgX3BkZmpzTGliLnNoYWRvdykodGhpcywgInN1cHBvcnRlZE1vdXNlV2hlZWxab29tTW9kaWZpZXJLZXlzIiwgewogICAgICAgIGN0cmxLZXk6IHRydWUsCiAgICAgICAgbWV0YUtleTogdHJ1ZQogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJpc0luQXV0b21hdGlvbiIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuICgwLCBfcGRmanNMaWIuc2hhZG93KSh0aGlzLCAiaXNJbkF1dG9tYXRpb24iLCBmYWxzZSk7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gRGVmYXVsdEV4dGVybmFsU2VydmljZXM7Cn0oKTsKCmV4cG9ydHMuRGVmYXVsdEV4dGVybmFsU2VydmljZXMgPSBEZWZhdWx0RXh0ZXJuYWxTZXJ2aWNlczsKdmFyIFBERlZpZXdlckFwcGxpY2F0aW9uID0gewogIGluaXRpYWxCb29rbWFyazogZG9jdW1lbnQubG9jYXRpb24uaGFzaC5zdWJzdHJpbmcoMSksCiAgX2luaXRpYWxpemVkQ2FwYWJpbGl0eTogKDAsIF9wZGZqc0xpYi5jcmVhdGVQcm9taXNlQ2FwYWJpbGl0eSkoKSwKICBmZWxsYmFjazogZmFsc2UsCiAgYXBwQ29uZmlnOiBudWxsLAogIHBkZkRvY3VtZW50OiBudWxsLAogIHBkZkxvYWRpbmdUYXNrOiBudWxsLAogIHByaW50U2VydmljZTogbnVsbCwKICBwZGZWaWV3ZXI6IG51bGwsCiAgcGRmVGh1bWJuYWlsVmlld2VyOiBudWxsLAogIHBkZlJlbmRlcmluZ1F1ZXVlOiBudWxsLAogIHBkZlByZXNlbnRhdGlvbk1vZGU6IG51bGwsCiAgcGRmRG9jdW1lbnRQcm9wZXJ0aWVzOiBudWxsLAogIHBkZkxpbmtTZXJ2aWNlOiBudWxsLAogIHBkZkhpc3Rvcnk6IG51bGwsCiAgcGRmU2lkZWJhcjogbnVsbCwKICBwZGZTaWRlYmFyUmVzaXplcjogbnVsbCwKICBwZGZPdXRsaW5lVmlld2VyOiBudWxsLAogIHBkZkF0dGFjaG1lbnRWaWV3ZXI6IG51bGwsCiAgcGRmQ3Vyc29yVG9vbHM6IG51bGwsCiAgc3RvcmU6IG51bGwsCiAgZG93bmxvYWRNYW5hZ2VyOiBudWxsLAogIG92ZXJsYXlNYW5hZ2VyOiBudWxsLAogIHByZWZlcmVuY2VzOiBudWxsLAogIHRvb2xiYXI6IG51bGwsCiAgc2Vjb25kYXJ5VG9vbGJhcjogbnVsbCwKICBldmVudEJ1czogbnVsbCwKICBsMTBuOiBudWxsLAogIGlzSW5pdGlhbFZpZXdTZXQ6IGZhbHNlLAogIGRvd25sb2FkQ29tcGxldGU6IGZhbHNlLAogIGlzVmlld2VyRW1iZWRkZWQ6IHdpbmRvdy5wYXJlbnQgIT09IHdpbmRvdywKICB1cmw6ICIiLAogIGJhc2VVcmw6ICIiLAogIGV4dGVybmFsU2VydmljZXM6IERlZmF1bHRFeHRlcm5hbFNlcnZpY2VzLAogIF9ib3VuZEV2ZW50czoge30sCiAgY29udGVudERpc3Bvc2l0aW9uRmlsZW5hbWU6IG51bGwsCiAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gaW5pdGlhbGl6ZShhcHBDb25maWcpIHsKICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgcmV0dXJuIF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ubWFyayhmdW5jdGlvbiBfY2FsbGVlKCkgewogICAgICB2YXIgYXBwQ29udGFpbmVyOwogICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ud3JhcChmdW5jdGlvbiBfY2FsbGVlJChfY29udGV4dCkgewogICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0LnByZXYgPSBfY29udGV4dC5uZXh0KSB7CiAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICBfdGhpcy5wcmVmZXJlbmNlcyA9IF90aGlzLmV4dGVybmFsU2VydmljZXMuY3JlYXRlUHJlZmVyZW5jZXMoKTsKICAgICAgICAgICAgICBfdGhpcy5hcHBDb25maWcgPSBhcHBDb25maWc7CiAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDQ7CiAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLl9yZWFkUHJlZmVyZW5jZXMoKTsKCiAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICBfY29udGV4dC5uZXh0ID0gNjsKICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuX3BhcnNlSGFzaFBhcmFtZXRlcnMoKTsKCiAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICBfY29udGV4dC5uZXh0ID0gODsKICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuX2luaXRpYWxpemVMMTBuKCk7CgogICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgaWYgKF90aGlzLmlzVmlld2VyRW1iZWRkZWQgJiYgX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuZ2V0KCJleHRlcm5hbExpbmtUYXJnZXQiKSA9PT0gX3BkZmpzTGliLkxpbmtUYXJnZXQuTk9ORSkgewogICAgICAgICAgICAgICAgX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuc2V0KCJleHRlcm5hbExpbmtUYXJnZXQiLCBfcGRmanNMaWIuTGlua1RhcmdldC5UT1ApOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDExOwogICAgICAgICAgICAgIHJldHVybiBfdGhpcy5faW5pdGlhbGl6ZVZpZXdlckNvbXBvbmVudHMoKTsKCiAgICAgICAgICAgIGNhc2UgMTE6CiAgICAgICAgICAgICAgX3RoaXMuYmluZEV2ZW50cygpOwoKICAgICAgICAgICAgICBfdGhpcy5iaW5kV2luZG93RXZlbnRzKCk7CgogICAgICAgICAgICAgIGFwcENvbnRhaW5lciA9IGFwcENvbmZpZy5hcHBDb250YWluZXIgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKICAgICAgICAgICAgICBfdGhpcy5sMTBuLnRyYW5zbGF0ZShhcHBDb250YWluZXIpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgX3RoaXMuZXZlbnRCdXMuZGlzcGF0Y2goImxvY2FsaXplZCIsIHsKICAgICAgICAgICAgICAgICAgc291cmNlOiBfdGhpcwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIF90aGlzLl9pbml0aWFsaXplZENhcGFiaWxpdHkucmVzb2x2ZSgpOwoKICAgICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQuc3RvcCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwgX2NhbGxlZSk7CiAgICB9KSkoKTsKICB9LAogIF9yZWFkUHJlZmVyZW5jZXM6IGZ1bmN0aW9uIF9yZWFkUHJlZmVyZW5jZXMoKSB7CiAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICByZXR1cm4gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JbImRlZmF1bHQiXS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUyKCkgewogICAgICB2YXIgcHJlZnMsIG5hbWU7CiAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JbImRlZmF1bHQiXS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUyJChfY29udGV4dDIpIHsKICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgc3dpdGNoIChfY29udGV4dDIucHJldiA9IF9jb250ZXh0Mi5uZXh0KSB7CiAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICBpZiAoIV9hcHBfb3B0aW9ucy5BcHBPcHRpb25zLmdldCgiZGlzYWJsZVByZWZlcmVuY2VzIikpIHsKICAgICAgICAgICAgICAgIF9jb250ZXh0Mi5uZXh0ID0gMjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Mi5hYnJ1cHQoInJldHVybiIpOwoKICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgIF9jb250ZXh0Mi5wcmV2ID0gMjsKICAgICAgICAgICAgICBfY29udGV4dDIubmV4dCA9IDU7CiAgICAgICAgICAgICAgcmV0dXJuIF90aGlzMi5wcmVmZXJlbmNlcy5nZXRBbGwoKTsKCiAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICBwcmVmcyA9IF9jb250ZXh0Mi5zZW50OwoKICAgICAgICAgICAgICBmb3IgKG5hbWUgaW4gcHJlZnMpIHsKICAgICAgICAgICAgICAgIF9hcHBfb3B0aW9ucy5BcHBPcHRpb25zLnNldChuYW1lLCBwcmVmc1tuYW1lXSk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBfY29udGV4dDIubmV4dCA9IDEyOwogICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSA5OgogICAgICAgICAgICAgIF9jb250ZXh0Mi5wcmV2ID0gOTsKICAgICAgICAgICAgICBfY29udGV4dDIudDAgPSBfY29udGV4dDJbImNhdGNoIl0oMik7CiAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigiX3JlYWRQcmVmZXJlbmNlczogXCIiLmNvbmNhdChfY29udGV4dDIudDAubWVzc2FnZSwgIlwiLiIpKTsKCiAgICAgICAgICAgIGNhc2UgMTI6CiAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Mi5zdG9wKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCBfY2FsbGVlMiwgbnVsbCwgW1syLCA5XV0pOwogICAgfSkpKCk7CiAgfSwKICBfcGFyc2VIYXNoUGFyYW1ldGVyczogZnVuY3Rpb24gX3BhcnNlSGFzaFBhcmFtZXRlcnMoKSB7CiAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICByZXR1cm4gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JbImRlZmF1bHQiXS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUzKCkgewogICAgICB2YXIgaGFzaCwgaGFzaFBhcmFtcywgd2FpdE9uLCB2aWV3ZXIsIGVuYWJsZWQ7CiAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JbImRlZmF1bHQiXS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUzJChfY29udGV4dDMpIHsKICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgc3dpdGNoIChfY29udGV4dDMucHJldiA9IF9jb250ZXh0My5uZXh0KSB7CiAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICBpZiAoX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuZ2V0KCJwZGZCdWdFbmFibGVkIikpIHsKICAgICAgICAgICAgICAgIF9jb250ZXh0My5uZXh0ID0gMjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0My5hYnJ1cHQoInJldHVybiIsIHVuZGVmaW5lZCk7CgogICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgaGFzaCA9IGRvY3VtZW50LmxvY2F0aW9uLmhhc2guc3Vic3RyaW5nKDEpOwoKICAgICAgICAgICAgICBpZiAoaGFzaCkgewogICAgICAgICAgICAgICAgX2NvbnRleHQzLm5leHQgPSA1OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzLmFicnVwdCgicmV0dXJuIiwgdW5kZWZpbmVkKTsKCiAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICBoYXNoUGFyYW1zID0gKDAsIF91aV91dGlscy5wYXJzZVF1ZXJ5U3RyaW5nKShoYXNoKSwgd2FpdE9uID0gW107CgogICAgICAgICAgICAgIGlmICgiZGlzYWJsZXdvcmtlciIgaW4gaGFzaFBhcmFtcyAmJiBoYXNoUGFyYW1zLmRpc2FibGV3b3JrZXIgPT09ICJ0cnVlIikgewogICAgICAgICAgICAgICAgd2FpdE9uLnB1c2gobG9hZEZha2VXb3JrZXIoKSk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZiAoImRpc2FibGVyYW5nZSIgaW4gaGFzaFBhcmFtcykgewogICAgICAgICAgICAgICAgX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuc2V0KCJkaXNhYmxlUmFuZ2UiLCBoYXNoUGFyYW1zLmRpc2FibGVyYW5nZSA9PT0gInRydWUiKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGlmICgiZGlzYWJsZXN0cmVhbSIgaW4gaGFzaFBhcmFtcykgewogICAgICAgICAgICAgICAgX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuc2V0KCJkaXNhYmxlU3RyZWFtIiwgaGFzaFBhcmFtcy5kaXNhYmxlc3RyZWFtID09PSAidHJ1ZSIpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKCJkaXNhYmxlYXV0b2ZldGNoIiBpbiBoYXNoUGFyYW1zKSB7CiAgICAgICAgICAgICAgICBfYXBwX29wdGlvbnMuQXBwT3B0aW9ucy5zZXQoImRpc2FibGVBdXRvRmV0Y2giLCBoYXNoUGFyYW1zLmRpc2FibGVhdXRvZmV0Y2ggPT09ICJ0cnVlIik7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZiAoImRpc2FibGVmb250ZmFjZSIgaW4gaGFzaFBhcmFtcykgewogICAgICAgICAgICAgICAgX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuc2V0KCJkaXNhYmxlRm9udEZhY2UiLCBoYXNoUGFyYW1zLmRpc2FibGVmb250ZmFjZSA9PT0gInRydWUiKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGlmICgiZGlzYWJsZWhpc3RvcnkiIGluIGhhc2hQYXJhbXMpIHsKICAgICAgICAgICAgICAgIF9hcHBfb3B0aW9ucy5BcHBPcHRpb25zLnNldCgiZGlzYWJsZUhpc3RvcnkiLCBoYXNoUGFyYW1zLmRpc2FibGVoaXN0b3J5ID09PSAidHJ1ZSIpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKCJ3ZWJnbCIgaW4gaGFzaFBhcmFtcykgewogICAgICAgICAgICAgICAgX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuc2V0KCJlbmFibGVXZWJHTCIsIGhhc2hQYXJhbXMud2ViZ2wgPT09ICJ0cnVlIik7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZiAoInZlcmJvc2l0eSIgaW4gaGFzaFBhcmFtcykgewogICAgICAgICAgICAgICAgX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuc2V0KCJ2ZXJib3NpdHkiLCBoYXNoUGFyYW1zLnZlcmJvc2l0eSB8IDApOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKCEoInRleHRsYXllciIgaW4gaGFzaFBhcmFtcykpIHsKICAgICAgICAgICAgICAgIF9jb250ZXh0My5uZXh0ID0gMjM7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIF9jb250ZXh0My50MCA9IGhhc2hQYXJhbXMudGV4dGxheWVyOwogICAgICAgICAgICAgIF9jb250ZXh0My5uZXh0ID0gX2NvbnRleHQzLnQwID09PSAib2ZmIiA/IDE4IDogX2NvbnRleHQzLnQwID09PSAidmlzaWJsZSIgPyAyMCA6IF9jb250ZXh0My50MCA9PT0gInNoYWRvdyIgPyAyMCA6IF9jb250ZXh0My50MCA9PT0gImhvdmVyIiA/IDIwIDogMjM7CiAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlIDE4OgogICAgICAgICAgICAgIF9hcHBfb3B0aW9ucy5BcHBPcHRpb25zLnNldCgidGV4dExheWVyTW9kZSIsIF91aV91dGlscy5UZXh0TGF5ZXJNb2RlLkRJU0FCTEUpOwoKICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzLmFicnVwdCgiYnJlYWsiLCAyMyk7CgogICAgICAgICAgICBjYXNlIDIwOgogICAgICAgICAgICAgIHZpZXdlciA9IF90aGlzMy5hcHBDb25maWcudmlld2VyQ29udGFpbmVyOwogICAgICAgICAgICAgIHZpZXdlci5jbGFzc0xpc3QuYWRkKCJ0ZXh0TGF5ZXItIiArIGhhc2hQYXJhbXMudGV4dGxheWVyKTsKICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzLmFicnVwdCgiYnJlYWsiLCAyMyk7CgogICAgICAgICAgICBjYXNlIDIzOgogICAgICAgICAgICAgIGlmICgicGRmYnVnIiBpbiBoYXNoUGFyYW1zKSB7CiAgICAgICAgICAgICAgICBfYXBwX29wdGlvbnMuQXBwT3B0aW9ucy5zZXQoInBkZkJ1ZyIsIHRydWUpOwoKICAgICAgICAgICAgICAgIF9hcHBfb3B0aW9ucy5BcHBPcHRpb25zLnNldCgiZm9udEV4dHJhUHJvcGVydGllcyIsIHRydWUpOwoKICAgICAgICAgICAgICAgIGVuYWJsZWQgPSBoYXNoUGFyYW1zLnBkZmJ1Zy5zcGxpdCgiLCIpOwogICAgICAgICAgICAgICAgd2FpdE9uLnB1c2gobG9hZEFuZEVuYWJsZVBERkJ1ZyhlbmFibGVkKSk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZiAoImxvY2FsZSIgaW4gaGFzaFBhcmFtcykgewogICAgICAgICAgICAgICAgX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuc2V0KCJsb2NhbGUiLCBoYXNoUGFyYW1zLmxvY2FsZSk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzLmFicnVwdCgicmV0dXJuIiwgUHJvbWlzZS5hbGwod2FpdE9uKVsiY2F0Y2giXShmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCJfcGFyc2VIYXNoUGFyYW1ldGVyczogXCIiLmNvbmNhdChyZWFzb24ubWVzc2FnZSwgIlwiLiIpKTsKICAgICAgICAgICAgICB9KSk7CgogICAgICAgICAgICBjYXNlIDI2OgogICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMuc3RvcCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwgX2NhbGxlZTMpOwogICAgfSkpKCk7CiAgfSwKICBfaW5pdGlhbGl6ZUwxMG46IGZ1bmN0aW9uIF9pbml0aWFsaXplTDEwbigpIHsKICAgIHZhciBfdGhpczQgPSB0aGlzOwoKICAgIHJldHVybiBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclsiZGVmYXVsdCJdLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTQoKSB7CiAgICAgIHZhciBkaXI7CiAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JbImRlZmF1bHQiXS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU0JChfY29udGV4dDQpIHsKICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgc3dpdGNoIChfY29udGV4dDQucHJldiA9IF9jb250ZXh0NC5uZXh0KSB7CiAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICBfdGhpczQubDEwbiA9IF90aGlzNC5leHRlcm5hbFNlcnZpY2VzLmNyZWF0ZUwxMG4oewogICAgICAgICAgICAgICAgbG9jYWxlOiBfYXBwX29wdGlvbnMuQXBwT3B0aW9ucy5nZXQoImxvY2FsZSIpCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgX2NvbnRleHQ0Lm5leHQgPSAzOwogICAgICAgICAgICAgIHJldHVybiBfdGhpczQubDEwbi5nZXREaXJlY3Rpb24oKTsKCiAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICBkaXIgPSBfY29udGV4dDQuc2VudDsKICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaHRtbCIpWzBdLmRpciA9IGRpcjsKCiAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ0LnN0b3AoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIF9jYWxsZWU0KTsKICAgIH0pKSgpOwogIH0sCiAgX2luaXRpYWxpemVWaWV3ZXJDb21wb25lbnRzOiBmdW5jdGlvbiBfaW5pdGlhbGl6ZVZpZXdlckNvbXBvbmVudHMoKSB7CiAgICB2YXIgX3RoaXM1ID0gdGhpczsKCiAgICByZXR1cm4gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JbImRlZmF1bHQiXS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU1KCkgewogICAgICB2YXIgYXBwQ29uZmlnLCBldmVudEJ1cywgcGRmUmVuZGVyaW5nUXVldWUsIHBkZkxpbmtTZXJ2aWNlLCBkb3dubG9hZE1hbmFnZXIsIGZpbmRDb250cm9sbGVyLCBjb250YWluZXIsIHZpZXdlcjsKICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclsiZGVmYXVsdCJdLndyYXAoZnVuY3Rpb24gX2NhbGxlZTUkKF9jb250ZXh0NSkgewogICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0NS5wcmV2ID0gX2NvbnRleHQ1Lm5leHQpIHsKICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgIGFwcENvbmZpZyA9IF90aGlzNS5hcHBDb25maWc7CiAgICAgICAgICAgICAgZXZlbnRCdXMgPSBhcHBDb25maWcuZXZlbnRCdXMgfHwgbmV3IF91aV91dGlscy5FdmVudEJ1cyh7CiAgICAgICAgICAgICAgICBpc0luQXV0b21hdGlvbjogX3RoaXM1LmV4dGVybmFsU2VydmljZXMuaXNJbkF1dG9tYXRpb24KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBfdGhpczUuZXZlbnRCdXMgPSBldmVudEJ1czsKICAgICAgICAgICAgICBfdGhpczUub3ZlcmxheU1hbmFnZXIgPSBuZXcgX292ZXJsYXlfbWFuYWdlci5PdmVybGF5TWFuYWdlcigpOwogICAgICAgICAgICAgIHBkZlJlbmRlcmluZ1F1ZXVlID0gbmV3IF9wZGZfcmVuZGVyaW5nX3F1ZXVlLlBERlJlbmRlcmluZ1F1ZXVlKCk7CiAgICAgICAgICAgICAgcGRmUmVuZGVyaW5nUXVldWUub25JZGxlID0gX3RoaXM1LmNsZWFudXAuYmluZChfdGhpczUpOwogICAgICAgICAgICAgIF90aGlzNS5wZGZSZW5kZXJpbmdRdWV1ZSA9IHBkZlJlbmRlcmluZ1F1ZXVlOwogICAgICAgICAgICAgIHBkZkxpbmtTZXJ2aWNlID0gbmV3IF9wZGZfbGlua19zZXJ2aWNlLlBERkxpbmtTZXJ2aWNlKHsKICAgICAgICAgICAgICAgIGV2ZW50QnVzOiBldmVudEJ1cywKICAgICAgICAgICAgICAgIGV4dGVybmFsTGlua1RhcmdldDogX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuZ2V0KCJleHRlcm5hbExpbmtUYXJnZXQiKSwKICAgICAgICAgICAgICAgIGV4dGVybmFsTGlua1JlbDogX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuZ2V0KCJleHRlcm5hbExpbmtSZWwiKSwKICAgICAgICAgICAgICAgIGlnbm9yZURlc3RpbmF0aW9uWm9vbTogX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuZ2V0KCJpZ25vcmVEZXN0aW5hdGlvblpvb20iKQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIF90aGlzNS5wZGZMaW5rU2VydmljZSA9IHBkZkxpbmtTZXJ2aWNlOwogICAgICAgICAgICAgIGRvd25sb2FkTWFuYWdlciA9IF90aGlzNS5leHRlcm5hbFNlcnZpY2VzLmNyZWF0ZURvd25sb2FkTWFuYWdlcih7CiAgICAgICAgICAgICAgICBkaXNhYmxlQ3JlYXRlT2JqZWN0VVJMOiBfYXBwX29wdGlvbnMuQXBwT3B0aW9ucy5nZXQoImRpc2FibGVDcmVhdGVPYmplY3RVUkwiKQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIF90aGlzNS5kb3dubG9hZE1hbmFnZXIgPSBkb3dubG9hZE1hbmFnZXI7CiAgICAgICAgICAgICAgZmluZENvbnRyb2xsZXIgPSBuZXcgX3BkZl9maW5kX2NvbnRyb2xsZXIuUERGRmluZENvbnRyb2xsZXIoewogICAgICAgICAgICAgICAgbGlua1NlcnZpY2U6IHBkZkxpbmtTZXJ2aWNlLAogICAgICAgICAgICAgICAgZXZlbnRCdXM6IGV2ZW50QnVzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgX3RoaXM1LmZpbmRDb250cm9sbGVyID0gZmluZENvbnRyb2xsZXI7CiAgICAgICAgICAgICAgY29udGFpbmVyID0gYXBwQ29uZmlnLm1haW5Db250YWluZXI7CiAgICAgICAgICAgICAgdmlld2VyID0gYXBwQ29uZmlnLnZpZXdlckNvbnRhaW5lcjsKICAgICAgICAgICAgICBfdGhpczUucGRmVmlld2VyID0gbmV3IF9wZGZfdmlld2VyLlBERlZpZXdlcih7CiAgICAgICAgICAgICAgICBjb250YWluZXI6IGNvbnRhaW5lciwKICAgICAgICAgICAgICAgIHZpZXdlcjogdmlld2VyLAogICAgICAgICAgICAgICAgZXZlbnRCdXM6IGV2ZW50QnVzLAogICAgICAgICAgICAgICAgcmVuZGVyaW5nUXVldWU6IHBkZlJlbmRlcmluZ1F1ZXVlLAogICAgICAgICAgICAgICAgbGlua1NlcnZpY2U6IHBkZkxpbmtTZXJ2aWNlLAogICAgICAgICAgICAgICAgZG93bmxvYWRNYW5hZ2VyOiBkb3dubG9hZE1hbmFnZXIsCiAgICAgICAgICAgICAgICBmaW5kQ29udHJvbGxlcjogZmluZENvbnRyb2xsZXIsCiAgICAgICAgICAgICAgICByZW5kZXJlcjogX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuZ2V0KCJyZW5kZXJlciIpLAogICAgICAgICAgICAgICAgZW5hYmxlV2ViR0w6IF9hcHBfb3B0aW9ucy5BcHBPcHRpb25zLmdldCgiZW5hYmxlV2ViR0wiKSwKICAgICAgICAgICAgICAgIGwxMG46IF90aGlzNS5sMTBuLAogICAgICAgICAgICAgICAgdGV4dExheWVyTW9kZTogX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuZ2V0KCJ0ZXh0TGF5ZXJNb2RlIiksCiAgICAgICAgICAgICAgICBpbWFnZVJlc291cmNlc1BhdGg6IF9hcHBfb3B0aW9ucy5BcHBPcHRpb25zLmdldCgiaW1hZ2VSZXNvdXJjZXNQYXRoIiksCiAgICAgICAgICAgICAgICByZW5kZXJJbnRlcmFjdGl2ZUZvcm1zOiBfYXBwX29wdGlvbnMuQXBwT3B0aW9ucy5nZXQoInJlbmRlckludGVyYWN0aXZlRm9ybXMiKSwKICAgICAgICAgICAgICAgIGVuYWJsZVByaW50QXV0b1JvdGF0ZTogX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuZ2V0KCJlbmFibGVQcmludEF1dG9Sb3RhdGUiKSwKICAgICAgICAgICAgICAgIHVzZU9ubHlDc3Nab29tOiBfYXBwX29wdGlvbnMuQXBwT3B0aW9ucy5nZXQoInVzZU9ubHlDc3Nab29tIiksCiAgICAgICAgICAgICAgICBtYXhDYW52YXNQaXhlbHM6IF9hcHBfb3B0aW9ucy5BcHBPcHRpb25zLmdldCgibWF4Q2FudmFzUGl4ZWxzIikKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZGZSZW5kZXJpbmdRdWV1ZS5zZXRWaWV3ZXIoX3RoaXM1LnBkZlZpZXdlcik7CiAgICAgICAgICAgICAgcGRmTGlua1NlcnZpY2Uuc2V0Vmlld2VyKF90aGlzNS5wZGZWaWV3ZXIpOwogICAgICAgICAgICAgIF90aGlzNS5wZGZUaHVtYm5haWxWaWV3ZXIgPSBuZXcgX3BkZl90aHVtYm5haWxfdmlld2VyLlBERlRodW1ibmFpbFZpZXdlcih7CiAgICAgICAgICAgICAgICBjb250YWluZXI6IGFwcENvbmZpZy5zaWRlYmFyLnRodW1ibmFpbFZpZXcsCiAgICAgICAgICAgICAgICByZW5kZXJpbmdRdWV1ZTogcGRmUmVuZGVyaW5nUXVldWUsCiAgICAgICAgICAgICAgICBsaW5rU2VydmljZTogcGRmTGlua1NlcnZpY2UsCiAgICAgICAgICAgICAgICBsMTBuOiBfdGhpczUubDEwbgogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBkZlJlbmRlcmluZ1F1ZXVlLnNldFRodW1ibmFpbFZpZXdlcihfdGhpczUucGRmVGh1bWJuYWlsVmlld2VyKTsKICAgICAgICAgICAgICBfdGhpczUucGRmSGlzdG9yeSA9IG5ldyBfcGRmX2hpc3RvcnkuUERGSGlzdG9yeSh7CiAgICAgICAgICAgICAgICBsaW5rU2VydmljZTogcGRmTGlua1NlcnZpY2UsCiAgICAgICAgICAgICAgICBldmVudEJ1czogZXZlbnRCdXMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZGZMaW5rU2VydmljZS5zZXRIaXN0b3J5KF90aGlzNS5wZGZIaXN0b3J5KTsKCiAgICAgICAgICAgICAgaWYgKCFfdGhpczUuc3VwcG9ydHNJbnRlZ3JhdGVkRmluZCkgewogICAgICAgICAgICAgICAgX3RoaXM1LmZpbmRCYXIgPSBuZXcgX3BkZl9maW5kX2Jhci5QREZGaW5kQmFyKGFwcENvbmZpZy5maW5kQmFyLCBldmVudEJ1cywgX3RoaXM1LmwxMG4pOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgX3RoaXM1LnBkZkRvY3VtZW50UHJvcGVydGllcyA9IG5ldyBfcGRmX2RvY3VtZW50X3Byb3BlcnRpZXMuUERGRG9jdW1lbnRQcm9wZXJ0aWVzKGFwcENvbmZpZy5kb2N1bWVudFByb3BlcnRpZXMsIF90aGlzNS5vdmVybGF5TWFuYWdlciwgZXZlbnRCdXMsIF90aGlzNS5sMTBuKTsKICAgICAgICAgICAgICBfdGhpczUucGRmQ3Vyc29yVG9vbHMgPSBuZXcgX3BkZl9jdXJzb3JfdG9vbHMuUERGQ3Vyc29yVG9vbHMoewogICAgICAgICAgICAgICAgY29udGFpbmVyOiBjb250YWluZXIsCiAgICAgICAgICAgICAgICBldmVudEJ1czogZXZlbnRCdXMsCiAgICAgICAgICAgICAgICBjdXJzb3JUb29sT25Mb2FkOiBfYXBwX29wdGlvbnMuQXBwT3B0aW9ucy5nZXQoImN1cnNvclRvb2xPbkxvYWQiKQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIF90aGlzNS50b29sYmFyID0gbmV3IF90b29sYmFyLlRvb2xiYXIoYXBwQ29uZmlnLnRvb2xiYXIsIGV2ZW50QnVzLCBfdGhpczUubDEwbik7CiAgICAgICAgICAgICAgX3RoaXM1LnNlY29uZGFyeVRvb2xiYXIgPSBuZXcgX3NlY29uZGFyeV90b29sYmFyLlNlY29uZGFyeVRvb2xiYXIoYXBwQ29uZmlnLnNlY29uZGFyeVRvb2xiYXIsIGNvbnRhaW5lciwgZXZlbnRCdXMpOwoKICAgICAgICAgICAgICBpZiAoX3RoaXM1LnN1cHBvcnRzRnVsbHNjcmVlbikgewogICAgICAgICAgICAgICAgX3RoaXM1LnBkZlByZXNlbnRhdGlvbk1vZGUgPSBuZXcgX3BkZl9wcmVzZW50YXRpb25fbW9kZS5QREZQcmVzZW50YXRpb25Nb2RlKHsKICAgICAgICAgICAgICAgICAgY29udGFpbmVyOiBjb250YWluZXIsCiAgICAgICAgICAgICAgICAgIHBkZlZpZXdlcjogX3RoaXM1LnBkZlZpZXdlciwKICAgICAgICAgICAgICAgICAgZXZlbnRCdXM6IGV2ZW50QnVzLAogICAgICAgICAgICAgICAgICBjb250ZXh0TWVudUl0ZW1zOiBhcHBDb25maWcuZnVsbHNjcmVlbgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBfdGhpczUucGFzc3dvcmRQcm9tcHQgPSBuZXcgX3Bhc3N3b3JkX3Byb21wdC5QYXNzd29yZFByb21wdChhcHBDb25maWcucGFzc3dvcmRPdmVybGF5LCBfdGhpczUub3ZlcmxheU1hbmFnZXIsIF90aGlzNS5sMTBuKTsKICAgICAgICAgICAgICBfdGhpczUucGRmT3V0bGluZVZpZXdlciA9IG5ldyBfcGRmX291dGxpbmVfdmlld2VyLlBERk91dGxpbmVWaWV3ZXIoewogICAgICAgICAgICAgICAgY29udGFpbmVyOiBhcHBDb25maWcuc2lkZWJhci5vdXRsaW5lVmlldywKICAgICAgICAgICAgICAgIGV2ZW50QnVzOiBldmVudEJ1cywKICAgICAgICAgICAgICAgIGxpbmtTZXJ2aWNlOiBwZGZMaW5rU2VydmljZQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIF90aGlzNS5wZGZBdHRhY2htZW50Vmlld2VyID0gbmV3IF9wZGZfYXR0YWNobWVudF92aWV3ZXIuUERGQXR0YWNobWVudFZpZXdlcih7CiAgICAgICAgICAgICAgICBjb250YWluZXI6IGFwcENvbmZpZy5zaWRlYmFyLmF0dGFjaG1lbnRzVmlldywKICAgICAgICAgICAgICAgIGV2ZW50QnVzOiBldmVudEJ1cywKICAgICAgICAgICAgICAgIGRvd25sb2FkTWFuYWdlcjogZG93bmxvYWRNYW5hZ2VyCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgX3RoaXM1LnBkZlNpZGViYXIgPSBuZXcgX3BkZl9zaWRlYmFyLlBERlNpZGViYXIoewogICAgICAgICAgICAgICAgZWxlbWVudHM6IGFwcENvbmZpZy5zaWRlYmFyLAogICAgICAgICAgICAgICAgcGRmVmlld2VyOiBfdGhpczUucGRmVmlld2VyLAogICAgICAgICAgICAgICAgcGRmVGh1bWJuYWlsVmlld2VyOiBfdGhpczUucGRmVGh1bWJuYWlsVmlld2VyLAogICAgICAgICAgICAgICAgZXZlbnRCdXM6IGV2ZW50QnVzLAogICAgICAgICAgICAgICAgbDEwbjogX3RoaXM1LmwxMG4KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBfdGhpczUucGRmU2lkZWJhci5vblRvZ2dsZWQgPSBfdGhpczUuZm9yY2VSZW5kZXJpbmcuYmluZChfdGhpczUpOwogICAgICAgICAgICAgIF90aGlzNS5wZGZTaWRlYmFyUmVzaXplciA9IG5ldyBfcGRmX3NpZGViYXJfcmVzaXplci5QREZTaWRlYmFyUmVzaXplcihhcHBDb25maWcuc2lkZWJhclJlc2l6ZXIsIGV2ZW50QnVzLCBfdGhpczUubDEwbik7CgogICAgICAgICAgICBjYXNlIDM0OgogICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDUuc3RvcCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwgX2NhbGxlZTUpOwogICAgfSkpKCk7CiAgfSwKICBydW46IGZ1bmN0aW9uIHJ1bihjb25maWcpIHsKICAgIHRoaXMuaW5pdGlhbGl6ZShjb25maWcpLnRoZW4od2ViVmlld2VySW5pdGlhbGl6ZWQpOwogIH0sCgogIGdldCBpbml0aWFsaXplZCgpIHsKICAgIHJldHVybiB0aGlzLl9pbml0aWFsaXplZENhcGFiaWxpdHkuc2V0dGxlZDsKICB9LAoKICBnZXQgaW5pdGlhbGl6ZWRQcm9taXNlKCkgewogICAgcmV0dXJuIHRoaXMuX2luaXRpYWxpemVkQ2FwYWJpbGl0eS5wcm9taXNlOwogIH0sCgogIHpvb21JbjogZnVuY3Rpb24gem9vbUluKHRpY2tzKSB7CiAgICBpZiAodGhpcy5wZGZWaWV3ZXIuaXNJblByZXNlbnRhdGlvbk1vZGUpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBuZXdTY2FsZSA9IHRoaXMucGRmVmlld2VyLmN1cnJlbnRTY2FsZTsKCiAgICBkbyB7CiAgICAgIG5ld1NjYWxlID0gKG5ld1NjYWxlICogREVGQVVMVF9TQ0FMRV9ERUxUQSkudG9GaXhlZCgyKTsKICAgICAgbmV3U2NhbGUgPSBNYXRoLmNlaWwobmV3U2NhbGUgKiAxMCkgLyAxMDsKICAgICAgbmV3U2NhbGUgPSBNYXRoLm1pbihfdWlfdXRpbHMuTUFYX1NDQUxFLCBuZXdTY2FsZSk7CiAgICB9IHdoaWxlICgtLXRpY2tzID4gMCAmJiBuZXdTY2FsZSA8IF91aV91dGlscy5NQVhfU0NBTEUpOwoKICAgIHRoaXMucGRmVmlld2VyLmN1cnJlbnRTY2FsZVZhbHVlID0gbmV3U2NhbGU7CiAgfSwKICB6b29tT3V0OiBmdW5jdGlvbiB6b29tT3V0KHRpY2tzKSB7CiAgICBpZiAodGhpcy5wZGZWaWV3ZXIuaXNJblByZXNlbnRhdGlvbk1vZGUpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBuZXdTY2FsZSA9IHRoaXMucGRmVmlld2VyLmN1cnJlbnRTY2FsZTsKCiAgICBkbyB7CiAgICAgIG5ld1NjYWxlID0gKG5ld1NjYWxlIC8gREVGQVVMVF9TQ0FMRV9ERUxUQSkudG9GaXhlZCgyKTsKICAgICAgbmV3U2NhbGUgPSBNYXRoLmZsb29yKG5ld1NjYWxlICogMTApIC8gMTA7CiAgICAgIG5ld1NjYWxlID0gTWF0aC5tYXgoX3VpX3V0aWxzLk1JTl9TQ0FMRSwgbmV3U2NhbGUpOwogICAgfSB3aGlsZSAoLS10aWNrcyA+IDAgJiYgbmV3U2NhbGUgPiBfdWlfdXRpbHMuTUlOX1NDQUxFKTsKCiAgICB0aGlzLnBkZlZpZXdlci5jdXJyZW50U2NhbGVWYWx1ZSA9IG5ld1NjYWxlOwogIH0sCiAgem9vbVJlc2V0OiBmdW5jdGlvbiB6b29tUmVzZXQoKSB7CiAgICBpZiAodGhpcy5wZGZWaWV3ZXIuaXNJblByZXNlbnRhdGlvbk1vZGUpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHRoaXMucGRmVmlld2VyLmN1cnJlbnRTY2FsZVZhbHVlID0gX3VpX3V0aWxzLkRFRkFVTFRfU0NBTEVfVkFMVUU7CiAgfSwKCiAgZ2V0IHBhZ2VzQ291bnQoKSB7CiAgICByZXR1cm4gdGhpcy5wZGZEb2N1bWVudCA/IHRoaXMucGRmRG9jdW1lbnQubnVtUGFnZXMgOiAwOwogIH0sCgogIGdldCBwYWdlKCkgewogICAgcmV0dXJuIHRoaXMucGRmVmlld2VyLmN1cnJlbnRQYWdlTnVtYmVyOwogIH0sCgogIHNldCBwYWdlKHZhbCkgewogICAgdGhpcy5wZGZWaWV3ZXIuY3VycmVudFBhZ2VOdW1iZXIgPSB2YWw7CiAgfSwKCiAgZ2V0IHByaW50aW5nKCkgewogICAgcmV0dXJuICEhdGhpcy5wcmludFNlcnZpY2U7CiAgfSwKCiAgZ2V0IHN1cHBvcnRzUHJpbnRpbmcoKSB7CiAgICByZXR1cm4gUERGUHJpbnRTZXJ2aWNlRmFjdG9yeS5pbnN0YW5jZS5zdXBwb3J0c1ByaW50aW5nOwogIH0sCgogIGdldCBzdXBwb3J0c0Z1bGxzY3JlZW4oKSB7CiAgICB2YXIgc3VwcG9ydDsKICAgIHZhciBkb2MgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CiAgICBzdXBwb3J0ID0gISEoZG9jLnJlcXVlc3RGdWxsc2NyZWVuIHx8IGRvYy5tb3pSZXF1ZXN0RnVsbFNjcmVlbiB8fCBkb2Mud2Via2l0UmVxdWVzdEZ1bGxTY3JlZW4gfHwgZG9jLm1zUmVxdWVzdEZ1bGxzY3JlZW4pOwoKICAgIGlmIChkb2N1bWVudC5mdWxsc2NyZWVuRW5hYmxlZCA9PT0gZmFsc2UgfHwgZG9jdW1lbnQubW96RnVsbFNjcmVlbkVuYWJsZWQgPT09IGZhbHNlIHx8IGRvY3VtZW50LndlYmtpdEZ1bGxzY3JlZW5FbmFibGVkID09PSBmYWxzZSB8fCBkb2N1bWVudC5tc0Z1bGxzY3JlZW5FbmFibGVkID09PSBmYWxzZSkgewogICAgICBzdXBwb3J0ID0gZmFsc2U7CiAgICB9CgogICAgcmV0dXJuICgwLCBfcGRmanNMaWIuc2hhZG93KSh0aGlzLCAic3VwcG9ydHNGdWxsc2NyZWVuIiwgc3VwcG9ydCk7CiAgfSwKCiAgZ2V0IHN1cHBvcnRzSW50ZWdyYXRlZEZpbmQoKSB7CiAgICByZXR1cm4gdGhpcy5leHRlcm5hbFNlcnZpY2VzLnN1cHBvcnRzSW50ZWdyYXRlZEZpbmQ7CiAgfSwKCiAgZ2V0IHN1cHBvcnRzRG9jdW1lbnRGb250cygpIHsKICAgIHJldHVybiB0aGlzLmV4dGVybmFsU2VydmljZXMuc3VwcG9ydHNEb2N1bWVudEZvbnRzOwogIH0sCgogIGdldCBsb2FkaW5nQmFyKCkgewogICAgdmFyIGJhciA9IG5ldyBfdWlfdXRpbHMuUHJvZ3Jlc3NCYXIoIiNsb2FkaW5nQmFyIik7CiAgICByZXR1cm4gKDAsIF9wZGZqc0xpYi5zaGFkb3cpKHRoaXMsICJsb2FkaW5nQmFyIiwgYmFyKTsKICB9LAoKICBnZXQgc3VwcG9ydGVkTW91c2VXaGVlbFpvb21Nb2RpZmllcktleXMoKSB7CiAgICByZXR1cm4gdGhpcy5leHRlcm5hbFNlcnZpY2VzLnN1cHBvcnRlZE1vdXNlV2hlZWxab29tTW9kaWZpZXJLZXlzOwogIH0sCgogIGluaXRQYXNzaXZlTG9hZGluZzogZnVuY3Rpb24gaW5pdFBhc3NpdmVMb2FkaW5nKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCJOb3QgaW1wbGVtZW50ZWQ6IGluaXRQYXNzaXZlTG9hZGluZyIpOwogIH0sCiAgc2V0VGl0bGVVc2luZ1VybDogZnVuY3Rpb24gc2V0VGl0bGVVc2luZ1VybCgpIHsKICAgIHZhciB1cmwgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6ICIiOwogICAgdGhpcy51cmwgPSB1cmw7CiAgICB0aGlzLmJhc2VVcmwgPSB1cmwuc3BsaXQoIiMiKVswXTsKICAgIHZhciB0aXRsZSA9ICgwLCBfdWlfdXRpbHMuZ2V0UERGRmlsZU5hbWVGcm9tVVJMKSh1cmwsICIiKTsKCiAgICBpZiAoIXRpdGxlKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdGl0bGUgPSBkZWNvZGVVUklDb21wb25lbnQoKDAsIF9wZGZqc0xpYi5nZXRGaWxlbmFtZUZyb21VcmwpKHVybCkpIHx8IHVybDsKICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICB0aXRsZSA9IHVybDsKICAgICAgfQogICAgfQoKICAgIHRoaXMuc2V0VGl0bGUodGl0bGUpOwogIH0sCiAgc2V0VGl0bGU6IGZ1bmN0aW9uIHNldFRpdGxlKHRpdGxlKSB7CiAgICBpZiAodGhpcy5pc1ZpZXdlckVtYmVkZGVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBkb2N1bWVudC50aXRsZSA9IHRpdGxlOwogIH0sCiAgY2xvc2U6IGZ1bmN0aW9uIGNsb3NlKCkgewogICAgdmFyIF90aGlzNiA9IHRoaXM7CgogICAgcmV0dXJuIF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ubWFyayhmdW5jdGlvbiBfY2FsbGVlNigpIHsKICAgICAgdmFyIGVycm9yV3JhcHBlciwgcHJvbWlzZTsKICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclsiZGVmYXVsdCJdLndyYXAoZnVuY3Rpb24gX2NhbGxlZTYkKF9jb250ZXh0NikgewogICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0Ni5wcmV2ID0gX2NvbnRleHQ2Lm5leHQpIHsKICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgIGVycm9yV3JhcHBlciA9IF90aGlzNi5hcHBDb25maWcuZXJyb3JXcmFwcGVyLmNvbnRhaW5lcjsKICAgICAgICAgICAgICBlcnJvcldyYXBwZXIuc2V0QXR0cmlidXRlKCJoaWRkZW4iLCAidHJ1ZSIpOwoKICAgICAgICAgICAgICBpZiAoX3RoaXM2LnBkZkxvYWRpbmdUYXNrKSB7CiAgICAgICAgICAgICAgICBfY29udGV4dDYubmV4dCA9IDQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDYuYWJydXB0KCJyZXR1cm4iLCB1bmRlZmluZWQpOwoKICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgIHByb21pc2UgPSBfdGhpczYucGRmTG9hZGluZ1Rhc2suZGVzdHJveSgpOwogICAgICAgICAgICAgIF90aGlzNi5wZGZMb2FkaW5nVGFzayA9IG51bGw7CgogICAgICAgICAgICAgIGlmIChfdGhpczYucGRmRG9jdW1lbnQpIHsKICAgICAgICAgICAgICAgIF90aGlzNi5wZGZEb2N1bWVudCA9IG51bGw7CgogICAgICAgICAgICAgICAgX3RoaXM2LnBkZlRodW1ibmFpbFZpZXdlci5zZXREb2N1bWVudChudWxsKTsKCiAgICAgICAgICAgICAgICBfdGhpczYucGRmVmlld2VyLnNldERvY3VtZW50KG51bGwpOwoKICAgICAgICAgICAgICAgIF90aGlzNi5wZGZMaW5rU2VydmljZS5zZXREb2N1bWVudChudWxsKTsKCiAgICAgICAgICAgICAgICBfdGhpczYucGRmRG9jdW1lbnRQcm9wZXJ0aWVzLnNldERvY3VtZW50KG51bGwpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgd2ViVmlld2VyUmVzZXRQZXJtaXNzaW9ucygpOwogICAgICAgICAgICAgIF90aGlzNi5zdG9yZSA9IG51bGw7CiAgICAgICAgICAgICAgX3RoaXM2LmlzSW5pdGlhbFZpZXdTZXQgPSBmYWxzZTsKICAgICAgICAgICAgICBfdGhpczYuZG93bmxvYWRDb21wbGV0ZSA9IGZhbHNlOwogICAgICAgICAgICAgIF90aGlzNi51cmwgPSAiIjsKICAgICAgICAgICAgICBfdGhpczYuYmFzZVVybCA9ICIiOwogICAgICAgICAgICAgIF90aGlzNi5jb250ZW50RGlzcG9zaXRpb25GaWxlbmFtZSA9IG51bGw7CgogICAgICAgICAgICAgIF90aGlzNi5wZGZTaWRlYmFyLnJlc2V0KCk7CgogICAgICAgICAgICAgIF90aGlzNi5wZGZPdXRsaW5lVmlld2VyLnJlc2V0KCk7CgogICAgICAgICAgICAgIF90aGlzNi5wZGZBdHRhY2htZW50Vmlld2VyLnJlc2V0KCk7CgogICAgICAgICAgICAgIGlmIChfdGhpczYucGRmSGlzdG9yeSkgewogICAgICAgICAgICAgICAgX3RoaXM2LnBkZkhpc3RvcnkucmVzZXQoKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGlmIChfdGhpczYuZmluZEJhcikgewogICAgICAgICAgICAgICAgX3RoaXM2LmZpbmRCYXIucmVzZXQoKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIF90aGlzNi50b29sYmFyLnJlc2V0KCk7CgogICAgICAgICAgICAgIF90aGlzNi5zZWNvbmRhcnlUb29sYmFyLnJlc2V0KCk7CgogICAgICAgICAgICAgIGlmICh0eXBlb2YgUERGQnVnICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgUERGQnVnLmNsZWFudXAoKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDYuYWJydXB0KCJyZXR1cm4iLCBwcm9taXNlKTsKCiAgICAgICAgICAgIGNhc2UgMjM6CiAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ni5zdG9wKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCBfY2FsbGVlNik7CiAgICB9KSkoKTsKICB9LAogIG9wZW46IGZ1bmN0aW9uIG9wZW4oZmlsZSwgYXJncykgewogICAgdmFyIF90aGlzNyA9IHRoaXM7CgogICAgcmV0dXJuIF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ubWFyayhmdW5jdGlvbiBfY2FsbGVlNygpIHsKICAgICAgdmFyIHdvcmtlclBhcmFtZXRlcnMsIGtleSwgcGFyYW1ldGVycywgYXBpUGFyYW1ldGVycywgX2tleSwgdmFsdWUsIF9rZXkyLCBfdmFsdWUsIGxvYWRpbmdUYXNrOwoKICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclsiZGVmYXVsdCJdLndyYXAoZnVuY3Rpb24gX2NhbGxlZTckKF9jb250ZXh0NykgewogICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0Ny5wcmV2ID0gX2NvbnRleHQ3Lm5leHQpIHsKICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgIGlmICghX3RoaXM3LnBkZkxvYWRpbmdUYXNrKSB7CiAgICAgICAgICAgICAgICBfY29udGV4dDcubmV4dCA9IDM7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIF9jb250ZXh0Ny5uZXh0ID0gMzsKICAgICAgICAgICAgICByZXR1cm4gX3RoaXM3LmNsb3NlKCk7CgogICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgd29ya2VyUGFyYW1ldGVycyA9IF9hcHBfb3B0aW9ucy5BcHBPcHRpb25zLmdldEFsbChfYXBwX29wdGlvbnMuT3B0aW9uS2luZC5XT1JLRVIpOwoKICAgICAgICAgICAgICBmb3IgKGtleSBpbiB3b3JrZXJQYXJhbWV0ZXJzKSB7CiAgICAgICAgICAgICAgICBfcGRmanNMaWIuR2xvYmFsV29ya2VyT3B0aW9uc1trZXldID0gd29ya2VyUGFyYW1ldGVyc1trZXldOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcGFyYW1ldGVycyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CgogICAgICAgICAgICAgIGlmICh0eXBlb2YgZmlsZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIF90aGlzNy5zZXRUaXRsZVVzaW5nVXJsKGZpbGUpOwoKICAgICAgICAgICAgICAgIHBhcmFtZXRlcnMudXJsID0gZmlsZTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGZpbGUgJiYgImJ5dGVMZW5ndGgiIGluIGZpbGUpIHsKICAgICAgICAgICAgICAgIHBhcmFtZXRlcnMuZGF0YSA9IGZpbGU7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChmaWxlLnVybCAmJiBmaWxlLm9yaWdpbmFsVXJsKSB7CiAgICAgICAgICAgICAgICBfdGhpczcuc2V0VGl0bGVVc2luZ1VybChmaWxlLm9yaWdpbmFsVXJsKTsKCiAgICAgICAgICAgICAgICBwYXJhbWV0ZXJzLnVybCA9IGZpbGUudXJsOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgYXBpUGFyYW1ldGVycyA9IF9hcHBfb3B0aW9ucy5BcHBPcHRpb25zLmdldEFsbChfYXBwX29wdGlvbnMuT3B0aW9uS2luZC5BUEkpOwoKICAgICAgICAgICAgICBmb3IgKF9rZXkgaW4gYXBpUGFyYW1ldGVycykgewogICAgICAgICAgICAgICAgdmFsdWUgPSBhcGlQYXJhbWV0ZXJzW19rZXldOwoKICAgICAgICAgICAgICAgIGlmIChfa2V5ID09PSAiZG9jQmFzZVVybCIgJiYgIXZhbHVlKSB7fQoKICAgICAgICAgICAgICAgIHBhcmFtZXRlcnNbX2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgICAgICAgICBmb3IgKF9rZXkyIGluIGFyZ3MpIHsKICAgICAgICAgICAgICAgICAgX3ZhbHVlID0gYXJnc1tfa2V5Ml07CgogICAgICAgICAgICAgICAgICBpZiAoX2tleTIgPT09ICJsZW5ndGgiKSB7CiAgICAgICAgICAgICAgICAgICAgX3RoaXM3LnBkZkRvY3VtZW50UHJvcGVydGllcy5zZXRGaWxlU2l6ZShfdmFsdWUpOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBwYXJhbWV0ZXJzW19rZXkyXSA9IF92YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGxvYWRpbmdUYXNrID0gKDAsIF9wZGZqc0xpYi5nZXREb2N1bWVudCkocGFyYW1ldGVycyk7CiAgICAgICAgICAgICAgX3RoaXM3LnBkZkxvYWRpbmdUYXNrID0gbG9hZGluZ1Rhc2s7CgogICAgICAgICAgICAgIGxvYWRpbmdUYXNrLm9uUGFzc3dvcmQgPSBmdW5jdGlvbiAodXBkYXRlQ2FsbGJhY2ssIHJlYXNvbikgewogICAgICAgICAgICAgICAgX3RoaXM3LnBkZkxpbmtTZXJ2aWNlLmV4dGVybmFsTGlua0VuYWJsZWQgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICBfdGhpczcucGFzc3dvcmRQcm9tcHQuc2V0VXBkYXRlQ2FsbGJhY2sodXBkYXRlQ2FsbGJhY2ssIHJlYXNvbik7CgogICAgICAgICAgICAgICAgX3RoaXM3LnBhc3N3b3JkUHJvbXB0Lm9wZW4oKTsKICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICBsb2FkaW5nVGFzay5vblByb2dyZXNzID0gZnVuY3Rpb24gKF9yZWYpIHsKICAgICAgICAgICAgICAgIHZhciBsb2FkZWQgPSBfcmVmLmxvYWRlZCwKICAgICAgICAgICAgICAgICAgICB0b3RhbCA9IF9yZWYudG90YWw7CgogICAgICAgICAgICAgICAgX3RoaXM3LnByb2dyZXNzKGxvYWRlZCAvIHRvdGFsKTsKICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICBsb2FkaW5nVGFzay5vblVuc3VwcG9ydGVkRmVhdHVyZSA9IF90aGlzNy5mYWxsYmFjay5iaW5kKF90aGlzNyk7CiAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ny5hYnJ1cHQoInJldHVybiIsIGxvYWRpbmdUYXNrLnByb21pc2UudGhlbihmdW5jdGlvbiAocGRmRG9jdW1lbnQpIHsKICAgICAgICAgICAgICAgIF90aGlzNy5sb2FkKHBkZkRvY3VtZW50KTsKICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAoZXhjZXB0aW9uKSB7CiAgICAgICAgICAgICAgICBpZiAobG9hZGluZ1Rhc2sgIT09IF90aGlzNy5wZGZMb2FkaW5nVGFzaykgewogICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBtZXNzYWdlID0gZXhjZXB0aW9uICYmIGV4Y2VwdGlvbi5tZXNzYWdlOwogICAgICAgICAgICAgICAgdmFyIGxvYWRpbmdFcnJvck1lc3NhZ2U7CgogICAgICAgICAgICAgICAgaWYgKGV4Y2VwdGlvbiBpbnN0YW5jZW9mIF9wZGZqc0xpYi5JbnZhbGlkUERGRXhjZXB0aW9uKSB7CiAgICAgICAgICAgICAgICAgIGxvYWRpbmdFcnJvck1lc3NhZ2UgPSBfdGhpczcubDEwbi5nZXQoImludmFsaWRfZmlsZV9lcnJvciIsIG51bGwsICJJbnZhbGlkIG9yIGNvcnJ1cHRlZCBQREYgZmlsZS4iKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZXhjZXB0aW9uIGluc3RhbmNlb2YgX3BkZmpzTGliLk1pc3NpbmdQREZFeGNlcHRpb24pIHsKICAgICAgICAgICAgICAgICAgbG9hZGluZ0Vycm9yTWVzc2FnZSA9IF90aGlzNy5sMTBuLmdldCgibWlzc2luZ19maWxlX2Vycm9yIiwgbnVsbCwgIk1pc3NpbmcgUERGIGZpbGUuIik7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGV4Y2VwdGlvbiBpbnN0YW5jZW9mIF9wZGZqc0xpYi5VbmV4cGVjdGVkUmVzcG9uc2VFeGNlcHRpb24pIHsKICAgICAgICAgICAgICAgICAgbG9hZGluZ0Vycm9yTWVzc2FnZSA9IF90aGlzNy5sMTBuLmdldCgidW5leHBlY3RlZF9yZXNwb25zZV9lcnJvciIsIG51bGwsICJVbmV4cGVjdGVkIHNlcnZlciByZXNwb25zZS4iKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGxvYWRpbmdFcnJvck1lc3NhZ2UgPSBfdGhpczcubDEwbi5nZXQoImxvYWRpbmdfZXJyb3IiLCBudWxsLCAiQW4gZXJyb3Igb2NjdXJyZWQgd2hpbGUgbG9hZGluZyB0aGUgUERGLiIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBsb2FkaW5nRXJyb3JNZXNzYWdlLnRoZW4oZnVuY3Rpb24gKG1zZykgewogICAgICAgICAgICAgICAgICBfdGhpczcuZXJyb3IobXNnLCB7CiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZQogICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgIHRocm93IGV4Y2VwdGlvbjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgIGNhc2UgMTY6CiAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ny5zdG9wKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCBfY2FsbGVlNyk7CiAgICB9KSkoKTsKICB9LAogIGRvd25sb2FkOiBmdW5jdGlvbiBkb3dubG9hZCgpIHsKICAgIHZhciBfdGhpczggPSB0aGlzOwoKICAgIGZ1bmN0aW9uIGRvd25sb2FkQnlVcmwoKSB7CiAgICAgIGRvd25sb2FkTWFuYWdlci5kb3dubG9hZFVybCh1cmwsIGZpbGVuYW1lKTsKICAgIH0KCiAgICB2YXIgdXJsID0gdGhpcy5iYXNlVXJsOwogICAgdmFyIGZpbGVuYW1lID0gdGhpcy5jb250ZW50RGlzcG9zaXRpb25GaWxlbmFtZSB8fCAoMCwgX3VpX3V0aWxzLmdldFBERkZpbGVOYW1lRnJvbVVSTCkodGhpcy51cmwpOwogICAgdmFyIGRvd25sb2FkTWFuYWdlciA9IHRoaXMuZG93bmxvYWRNYW5hZ2VyOwoKICAgIGRvd25sb2FkTWFuYWdlci5vbmVycm9yID0gZnVuY3Rpb24gKGVycikgewogICAgICBfdGhpczguZXJyb3IoIlBERiBmYWlsZWQgdG8gZG93bmxvYWQ6ICIuY29uY2F0KGVycikpOwogICAgfTsKCiAgICBpZiAoIXRoaXMucGRmRG9jdW1lbnQgfHwgIXRoaXMuZG93bmxvYWRDb21wbGV0ZSkgewogICAgICBkb3dubG9hZEJ5VXJsKCk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzLnBkZkRvY3VtZW50LmdldERhdGEoKS50aGVuKGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIHZhciBibG9iID0gbmV3IEJsb2IoW2RhdGFdLCB7CiAgICAgICAgdHlwZTogImFwcGxpY2F0aW9uL3BkZiIKICAgICAgfSk7CiAgICAgIGRvd25sb2FkTWFuYWdlci5kb3dubG9hZChibG9iLCB1cmwsIGZpbGVuYW1lKTsKICAgIH0pWyJjYXRjaCJdKGRvd25sb2FkQnlVcmwpOwogIH0sCiAgZmFsbGJhY2s6IGZ1bmN0aW9uIGZhbGxiYWNrKGZlYXR1cmVJZCkgewogICAgaWYgKHRoaXMuZmVsbGJhY2spIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHRoaXMuZmVsbGJhY2sgPSB0cnVlOwogICAgdGhpcy5leHRlcm5hbFNlcnZpY2VzLmZhbGxiYWNrKHsKICAgICAgZmVhdHVyZUlkOiBmZWF0dXJlSWQsCiAgICAgIHVybDogdGhpcy5iYXNlVXJsCiAgICB9LCBmdW5jdGlvbiByZXNwb25zZShkb3dubG9hZCkgewogICAgICBpZiAoIWRvd25sb2FkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5kb3dubG9hZCgpOwogICAgfSk7CiAgfSwKICBlcnJvcjogZnVuY3Rpb24gZXJyb3IobWVzc2FnZSwgbW9yZUluZm8pIHsKICAgIHZhciBtb3JlSW5mb1RleHQgPSBbdGhpcy5sMTBuLmdldCgiZXJyb3JfdmVyc2lvbl9pbmZvIiwgewogICAgICB2ZXJzaW9uOiBfcGRmanNMaWIudmVyc2lvbiB8fCAiPyIsCiAgICAgIGJ1aWxkOiBfcGRmanNMaWIuYnVpbGQgfHwgIj8iCiAgICB9LCAiUERGLmpzIHZ7e3ZlcnNpb259fSAoYnVpbGQ6IHt7YnVpbGR9fSkiKV07CgogICAgaWYgKG1vcmVJbmZvKSB7CiAgICAgIG1vcmVJbmZvVGV4dC5wdXNoKHRoaXMubDEwbi5nZXQoImVycm9yX21lc3NhZ2UiLCB7CiAgICAgICAgbWVzc2FnZTogbW9yZUluZm8ubWVzc2FnZQogICAgICB9LCAiTWVzc2FnZToge3ttZXNzYWdlfX0iKSk7CgogICAgICBpZiAobW9yZUluZm8uc3RhY2spIHsKICAgICAgICBtb3JlSW5mb1RleHQucHVzaCh0aGlzLmwxMG4uZ2V0KCJlcnJvcl9zdGFjayIsIHsKICAgICAgICAgIHN0YWNrOiBtb3JlSW5mby5zdGFjawogICAgICAgIH0sICJTdGFjazoge3tzdGFja319IikpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmIChtb3JlSW5mby5maWxlbmFtZSkgewogICAgICAgICAgbW9yZUluZm9UZXh0LnB1c2godGhpcy5sMTBuLmdldCgiZXJyb3JfZmlsZSIsIHsKICAgICAgICAgICAgZmlsZTogbW9yZUluZm8uZmlsZW5hbWUKICAgICAgICAgIH0sICJGaWxlOiB7e2ZpbGV9fSIpKTsKICAgICAgICB9CgogICAgICAgIGlmIChtb3JlSW5mby5saW5lTnVtYmVyKSB7CiAgICAgICAgICBtb3JlSW5mb1RleHQucHVzaCh0aGlzLmwxMG4uZ2V0KCJlcnJvcl9saW5lIiwgewogICAgICAgICAgICBsaW5lOiBtb3JlSW5mby5saW5lTnVtYmVyCiAgICAgICAgICB9LCAiTGluZToge3tsaW5lfX0iKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgdmFyIGVycm9yV3JhcHBlckNvbmZpZyA9IHRoaXMuYXBwQ29uZmlnLmVycm9yV3JhcHBlcjsKICAgIHZhciBlcnJvcldyYXBwZXIgPSBlcnJvcldyYXBwZXJDb25maWcuY29udGFpbmVyOwogICAgZXJyb3JXcmFwcGVyLnJlbW92ZUF0dHJpYnV0ZSgiaGlkZGVuIik7CiAgICB2YXIgZXJyb3JNZXNzYWdlID0gZXJyb3JXcmFwcGVyQ29uZmlnLmVycm9yTWVzc2FnZTsKICAgIGVycm9yTWVzc2FnZS50ZXh0Q29udGVudCA9IG1lc3NhZ2U7CiAgICB2YXIgY2xvc2VCdXR0b24gPSBlcnJvcldyYXBwZXJDb25maWcuY2xvc2VCdXR0b247CgogICAgY2xvc2VCdXR0b24ub25jbGljayA9IGZ1bmN0aW9uICgpIHsKICAgICAgZXJyb3JXcmFwcGVyLnNldEF0dHJpYnV0ZSgiaGlkZGVuIiwgInRydWUiKTsKICAgIH07CgogICAgdmFyIGVycm9yTW9yZUluZm8gPSBlcnJvcldyYXBwZXJDb25maWcuZXJyb3JNb3JlSW5mbzsKICAgIHZhciBtb3JlSW5mb0J1dHRvbiA9IGVycm9yV3JhcHBlckNvbmZpZy5tb3JlSW5mb0J1dHRvbjsKICAgIHZhciBsZXNzSW5mb0J1dHRvbiA9IGVycm9yV3JhcHBlckNvbmZpZy5sZXNzSW5mb0J1dHRvbjsKCiAgICBtb3JlSW5mb0J1dHRvbi5vbmNsaWNrID0gZnVuY3Rpb24gKCkgewogICAgICBlcnJvck1vcmVJbmZvLnJlbW92ZUF0dHJpYnV0ZSgiaGlkZGVuIik7CiAgICAgIG1vcmVJbmZvQnV0dG9uLnNldEF0dHJpYnV0ZSgiaGlkZGVuIiwgInRydWUiKTsKICAgICAgbGVzc0luZm9CdXR0b24ucmVtb3ZlQXR0cmlidXRlKCJoaWRkZW4iKTsKICAgICAgZXJyb3JNb3JlSW5mby5zdHlsZS5oZWlnaHQgPSBlcnJvck1vcmVJbmZvLnNjcm9sbEhlaWdodCArICJweCI7CiAgICB9OwoKICAgIGxlc3NJbmZvQnV0dG9uLm9uY2xpY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGVycm9yTW9yZUluZm8uc2V0QXR0cmlidXRlKCJoaWRkZW4iLCAidHJ1ZSIpOwogICAgICBtb3JlSW5mb0J1dHRvbi5yZW1vdmVBdHRyaWJ1dGUoImhpZGRlbiIpOwogICAgICBsZXNzSW5mb0J1dHRvbi5zZXRBdHRyaWJ1dGUoImhpZGRlbiIsICJ0cnVlIik7CiAgICB9OwoKICAgIG1vcmVJbmZvQnV0dG9uLm9uY29udGV4dG1lbnUgPSBfdWlfdXRpbHMubm9Db250ZXh0TWVudUhhbmRsZXI7CiAgICBsZXNzSW5mb0J1dHRvbi5vbmNvbnRleHRtZW51ID0gX3VpX3V0aWxzLm5vQ29udGV4dE1lbnVIYW5kbGVyOwogICAgY2xvc2VCdXR0b24ub25jb250ZXh0bWVudSA9IF91aV91dGlscy5ub0NvbnRleHRNZW51SGFuZGxlcjsKICAgIG1vcmVJbmZvQnV0dG9uLnJlbW92ZUF0dHJpYnV0ZSgiaGlkZGVuIik7CiAgICBsZXNzSW5mb0J1dHRvbi5zZXRBdHRyaWJ1dGUoImhpZGRlbiIsICJ0cnVlIik7CiAgICBQcm9taXNlLmFsbChtb3JlSW5mb1RleHQpLnRoZW4oZnVuY3Rpb24gKHBhcnRzKSB7CiAgICAgIGVycm9yTW9yZUluZm8udmFsdWUgPSBwYXJ0cy5qb2luKCJcbiIpOwogICAgfSk7CiAgfSwKICBwcm9ncmVzczogZnVuY3Rpb24gcHJvZ3Jlc3MobGV2ZWwpIHsKICAgIHZhciBfdGhpczkgPSB0aGlzOwoKICAgIGlmICh0aGlzLmRvd25sb2FkQ29tcGxldGUpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBwZXJjZW50ID0gTWF0aC5yb3VuZChsZXZlbCAqIDEwMCk7CgogICAgaWYgKHBlcmNlbnQgPiB0aGlzLmxvYWRpbmdCYXIucGVyY2VudCB8fCBpc05hTihwZXJjZW50KSkgewogICAgICB0aGlzLmxvYWRpbmdCYXIucGVyY2VudCA9IHBlcmNlbnQ7CiAgICAgIHZhciBkaXNhYmxlQXV0b0ZldGNoID0gdGhpcy5wZGZEb2N1bWVudCA/IHRoaXMucGRmRG9jdW1lbnQubG9hZGluZ1BhcmFtcy5kaXNhYmxlQXV0b0ZldGNoIDogX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuZ2V0KCJkaXNhYmxlQXV0b0ZldGNoIik7CgogICAgICBpZiAoZGlzYWJsZUF1dG9GZXRjaCAmJiBwZXJjZW50KSB7CiAgICAgICAgaWYgKHRoaXMuZGlzYWJsZUF1dG9GZXRjaExvYWRpbmdCYXJUaW1lb3V0KSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5kaXNhYmxlQXV0b0ZldGNoTG9hZGluZ0JhclRpbWVvdXQpOwogICAgICAgICAgdGhpcy5kaXNhYmxlQXV0b0ZldGNoTG9hZGluZ0JhclRpbWVvdXQgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5sb2FkaW5nQmFyLnNob3coKTsKICAgICAgICB0aGlzLmRpc2FibGVBdXRvRmV0Y2hMb2FkaW5nQmFyVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgX3RoaXM5LmxvYWRpbmdCYXIuaGlkZSgpOwoKICAgICAgICAgIF90aGlzOS5kaXNhYmxlQXV0b0ZldGNoTG9hZGluZ0JhclRpbWVvdXQgPSBudWxsOwogICAgICAgIH0sIERJU0FCTEVfQVVUT19GRVRDSF9MT0FESU5HX0JBUl9USU1FT1VUKTsKICAgICAgfQogICAgfQogIH0sCiAgbG9hZDogZnVuY3Rpb24gbG9hZChwZGZEb2N1bWVudCkgewogICAgdmFyIF90aGlzMTAgPSB0aGlzOwoKICAgIHRoaXMucGRmRG9jdW1lbnQgPSBwZGZEb2N1bWVudDsKICAgIHBkZkRvY3VtZW50LmdldERvd25sb2FkSW5mbygpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICBfdGhpczEwLmRvd25sb2FkQ29tcGxldGUgPSB0cnVlOwoKICAgICAgX3RoaXMxMC5sb2FkaW5nQmFyLmhpZGUoKTsKCiAgICAgIGZpcnN0UGFnZVByb21pc2UudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgX3RoaXMxMC5ldmVudEJ1cy5kaXNwYXRjaCgiZG9jdW1lbnRsb2FkZWQiLCB7CiAgICAgICAgICBzb3VyY2U6IF90aGlzMTAKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9KTsKICAgIHZhciBwYWdlTGF5b3V0UHJvbWlzZSA9IHBkZkRvY3VtZW50LmdldFBhZ2VMYXlvdXQoKVsiY2F0Y2giXShmdW5jdGlvbiAoKSB7fSk7CiAgICB2YXIgcGFnZU1vZGVQcm9taXNlID0gcGRmRG9jdW1lbnQuZ2V0UGFnZU1vZGUoKVsiY2F0Y2giXShmdW5jdGlvbiAoKSB7fSk7CiAgICB2YXIgb3BlbkFjdGlvblByb21pc2UgPSBwZGZEb2N1bWVudC5nZXRPcGVuQWN0aW9uKClbImNhdGNoIl0oZnVuY3Rpb24gKCkge30pOwogICAgdGhpcy50b29sYmFyLnNldFBhZ2VzQ291bnQocGRmRG9jdW1lbnQubnVtUGFnZXMsIGZhbHNlKTsKICAgIHRoaXMuc2Vjb25kYXJ5VG9vbGJhci5zZXRQYWdlc0NvdW50KHBkZkRvY3VtZW50Lm51bVBhZ2VzKTsKICAgIHZhciBiYXNlRG9jdW1lbnRVcmw7CiAgICBiYXNlRG9jdW1lbnRVcmwgPSBudWxsOwogICAgdGhpcy5wZGZMaW5rU2VydmljZS5zZXREb2N1bWVudChwZGZEb2N1bWVudCwgYmFzZURvY3VtZW50VXJsKTsKICAgIHRoaXMucGRmRG9jdW1lbnRQcm9wZXJ0aWVzLnNldERvY3VtZW50KHBkZkRvY3VtZW50LCB0aGlzLnVybCk7CiAgICB2YXIgcGRmVmlld2VyID0gdGhpcy5wZGZWaWV3ZXI7CiAgICBwZGZWaWV3ZXIuc2V0RG9jdW1lbnQocGRmRG9jdW1lbnQpOwogICAgdmFyIGZpcnN0UGFnZVByb21pc2UgPSBwZGZWaWV3ZXIuZmlyc3RQYWdlUHJvbWlzZSwKICAgICAgICBvbmVQYWdlUmVuZGVyZWQgPSBwZGZWaWV3ZXIub25lUGFnZVJlbmRlcmVkLAogICAgICAgIHBhZ2VzUHJvbWlzZSA9IHBkZlZpZXdlci5wYWdlc1Byb21pc2U7CiAgICB2YXIgcGRmVGh1bWJuYWlsVmlld2VyID0gdGhpcy5wZGZUaHVtYm5haWxWaWV3ZXI7CiAgICBwZGZUaHVtYm5haWxWaWV3ZXIuc2V0RG9jdW1lbnQocGRmRG9jdW1lbnQpOwogICAgdmFyIHN0b3JlZFByb21pc2UgPSAodGhpcy5zdG9yZSA9IG5ldyBfdmlld19oaXN0b3J5LlZpZXdIaXN0b3J5KHBkZkRvY3VtZW50LmZpbmdlcnByaW50KSkuZ2V0TXVsdGlwbGUoewogICAgICBwYWdlOiBudWxsLAogICAgICB6b29tOiBfdWlfdXRpbHMuREVGQVVMVF9TQ0FMRV9WQUxVRSwKICAgICAgc2Nyb2xsTGVmdDogIjAiLAogICAgICBzY3JvbGxUb3A6ICIwIiwKICAgICAgcm90YXRpb246IG51bGwsCiAgICAgIHNpZGViYXJWaWV3OiBfcGRmX3NpZGViYXIuU2lkZWJhclZpZXcuVU5LTk9XTiwKICAgICAgc2Nyb2xsTW9kZTogX3VpX3V0aWxzLlNjcm9sbE1vZGUuVU5LTk9XTiwKICAgICAgc3ByZWFkTW9kZTogX3VpX3V0aWxzLlNwcmVhZE1vZGUuVU5LTk9XTgogICAgfSlbImNhdGNoIl0oZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIH0pOwogICAgZmlyc3RQYWdlUHJvbWlzZS50aGVuKGZ1bmN0aW9uIChwZGZQYWdlKSB7CiAgICAgIF90aGlzMTAubG9hZGluZ0Jhci5zZXRXaWR0aChfdGhpczEwLmFwcENvbmZpZy52aWV3ZXJDb250YWluZXIpOwoKICAgICAgUHJvbWlzZS5hbGwoW191aV91dGlscy5hbmltYXRpb25TdGFydGVkLCBzdG9yZWRQcm9taXNlLCBwYWdlTGF5b3V0UHJvbWlzZSwgcGFnZU1vZGVQcm9taXNlLCBvcGVuQWN0aW9uUHJvbWlzZV0pLnRoZW4oIC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIF9yZWYzID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JbImRlZmF1bHQiXS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU4KF9yZWYyKSB7CiAgICAgICAgICB2YXIgX3JlZjQsIHRpbWVTdGFtcCwgc3RvcmVkLCBwYWdlTGF5b3V0LCBwYWdlTW9kZSwgb3BlbkFjdGlvbiwgdmlld09uTG9hZCwgaW5pdGlhbEJvb2ttYXJrLCB6b29tLCBoYXNoLCByb3RhdGlvbiwgc2lkZWJhclZpZXcsIHNjcm9sbE1vZGUsIHNwcmVhZE1vZGU7CgogICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclsiZGVmYXVsdCJdLndyYXAoZnVuY3Rpb24gX2NhbGxlZTgkKF9jb250ZXh0OCkgewogICAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ4LnByZXYgPSBfY29udGV4dDgubmV4dCkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICBfcmVmNCA9IF9zbGljZWRUb0FycmF5KF9yZWYyLCA1KSwgdGltZVN0YW1wID0gX3JlZjRbMF0sIHN0b3JlZCA9IF9yZWY0WzFdLCBwYWdlTGF5b3V0ID0gX3JlZjRbMl0sIHBhZ2VNb2RlID0gX3JlZjRbM10sIG9wZW5BY3Rpb24gPSBfcmVmNFs0XTsKICAgICAgICAgICAgICAgICAgdmlld09uTG9hZCA9IF9hcHBfb3B0aW9ucy5BcHBPcHRpb25zLmdldCgidmlld09uTG9hZCIpOwoKICAgICAgICAgICAgICAgICAgX3RoaXMxMC5faW5pdGlhbGl6ZVBkZkhpc3RvcnkoewogICAgICAgICAgICAgICAgICAgIGZpbmdlcnByaW50OiBwZGZEb2N1bWVudC5maW5nZXJwcmludCwKICAgICAgICAgICAgICAgICAgICB2aWV3T25Mb2FkOiB2aWV3T25Mb2FkLAogICAgICAgICAgICAgICAgICAgIGluaXRpYWxEZXN0OiBvcGVuQWN0aW9uICYmIG9wZW5BY3Rpb24uZGVzdAogICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgIGluaXRpYWxCb29rbWFyayA9IF90aGlzMTAuaW5pdGlhbEJvb2ttYXJrOwogICAgICAgICAgICAgICAgICB6b29tID0gX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuZ2V0KCJkZWZhdWx0Wm9vbVZhbHVlIik7CiAgICAgICAgICAgICAgICAgIGhhc2ggPSB6b29tID8gInpvb209Ii5jb25jYXQoem9vbSkgOiBudWxsOwogICAgICAgICAgICAgICAgICByb3RhdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgICAgIHNpZGViYXJWaWV3ID0gX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuZ2V0KCJzaWRlYmFyVmlld09uTG9hZCIpOwogICAgICAgICAgICAgICAgICBzY3JvbGxNb2RlID0gX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuZ2V0KCJzY3JvbGxNb2RlT25Mb2FkIik7CiAgICAgICAgICAgICAgICAgIHNwcmVhZE1vZGUgPSBfYXBwX29wdGlvbnMuQXBwT3B0aW9ucy5nZXQoInNwcmVhZE1vZGVPbkxvYWQiKTsKCiAgICAgICAgICAgICAgICAgIGlmIChzdG9yZWQucGFnZSAmJiB2aWV3T25Mb2FkICE9PSBWaWV3T25Mb2FkLklOSVRJQUwpIHsKICAgICAgICAgICAgICAgICAgICBoYXNoID0gInBhZ2U9Ii5jb25jYXQoc3RvcmVkLnBhZ2UsICImem9vbT0iKS5jb25jYXQoem9vbSB8fCBzdG9yZWQuem9vbSwgIiwiKSArICIiLmNvbmNhdChzdG9yZWQuc2Nyb2xsTGVmdCwgIiwiKS5jb25jYXQoc3RvcmVkLnNjcm9sbFRvcCk7CiAgICAgICAgICAgICAgICAgICAgcm90YXRpb24gPSBwYXJzZUludChzdG9yZWQucm90YXRpb24sIDEwKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHNpZGViYXJWaWV3ID09PSBfcGRmX3NpZGViYXIuU2lkZWJhclZpZXcuVU5LTk9XTikgewogICAgICAgICAgICAgICAgICAgICAgc2lkZWJhclZpZXcgPSBzdG9yZWQuc2lkZWJhclZpZXcgfCAwOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHNjcm9sbE1vZGUgPT09IF91aV91dGlscy5TY3JvbGxNb2RlLlVOS05PV04pIHsKICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbE1vZGUgPSBzdG9yZWQuc2Nyb2xsTW9kZSB8IDA7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoc3ByZWFkTW9kZSA9PT0gX3VpX3V0aWxzLlNwcmVhZE1vZGUuVU5LTk9XTikgewogICAgICAgICAgICAgICAgICAgICAgc3ByZWFkTW9kZSA9IHN0b3JlZC5zcHJlYWRNb2RlIHwgMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmIChwYWdlTW9kZSAmJiBzaWRlYmFyVmlldyA9PT0gX3BkZl9zaWRlYmFyLlNpZGViYXJWaWV3LlVOS05PV04pIHsKICAgICAgICAgICAgICAgICAgICBzaWRlYmFyVmlldyA9IGFwaVBhZ2VNb2RlVG9TaWRlYmFyVmlldyhwYWdlTW9kZSk7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmIChwYWdlTGF5b3V0ICYmIHNwcmVhZE1vZGUgPT09IF91aV91dGlscy5TcHJlYWRNb2RlLlVOS05PV04pIHsKICAgICAgICAgICAgICAgICAgICBzcHJlYWRNb2RlID0gYXBpUGFnZUxheW91dFRvU3ByZWFkTW9kZShwYWdlTGF5b3V0KTsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgX3RoaXMxMC5zZXRJbml0aWFsVmlldyhoYXNoLCB7CiAgICAgICAgICAgICAgICAgICAgcm90YXRpb246IHJvdGF0aW9uLAogICAgICAgICAgICAgICAgICAgIHNpZGViYXJWaWV3OiBzaWRlYmFyVmlldywKICAgICAgICAgICAgICAgICAgICBzY3JvbGxNb2RlOiBzY3JvbGxNb2RlLAogICAgICAgICAgICAgICAgICAgIHNwcmVhZE1vZGU6IHNwcmVhZE1vZGUKICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICBfdGhpczEwLmV2ZW50QnVzLmRpc3BhdGNoKCJkb2N1bWVudGluaXQiLCB7CiAgICAgICAgICAgICAgICAgICAgc291cmNlOiBfdGhpczEwCiAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgaWYgKCFfdGhpczEwLmlzVmlld2VyRW1iZWRkZWQpIHsKICAgICAgICAgICAgICAgICAgICBwZGZWaWV3ZXIuZm9jdXMoKTsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgX3RoaXMxMC5faW5pdGlhbGl6ZVBlcm1pc3Npb25zKHBkZkRvY3VtZW50KTsKCiAgICAgICAgICAgICAgICAgIF9jb250ZXh0OC5uZXh0ID0gMTk7CiAgICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJhY2UoW3BhZ2VzUHJvbWlzZSwgbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUpIHsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KHJlc29sdmUsIEZPUkNFX1BBR0VTX0xPQURFRF9USU1FT1VUKTsKICAgICAgICAgICAgICAgICAgfSldKTsKCiAgICAgICAgICAgICAgICBjYXNlIDE5OgogICAgICAgICAgICAgICAgICBpZiAoISghaW5pdGlhbEJvb2ttYXJrICYmICFoYXNoKSkgewogICAgICAgICAgICAgICAgICAgIF9jb250ZXh0OC5uZXh0ID0gMjE7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDguYWJydXB0KCJyZXR1cm4iKTsKCiAgICAgICAgICAgICAgICBjYXNlIDIxOgogICAgICAgICAgICAgICAgICBpZiAoIXBkZlZpZXdlci5oYXNFcXVhbFBhZ2VTaXplcykgewogICAgICAgICAgICAgICAgICAgIF9jb250ZXh0OC5uZXh0ID0gMjM7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDguYWJydXB0KCJyZXR1cm4iKTsKCiAgICAgICAgICAgICAgICBjYXNlIDIzOgogICAgICAgICAgICAgICAgICBfdGhpczEwLmluaXRpYWxCb29rbWFyayA9IGluaXRpYWxCb29rbWFyazsKICAgICAgICAgICAgICAgICAgcGRmVmlld2VyLmN1cnJlbnRTY2FsZVZhbHVlID0gcGRmVmlld2VyLmN1cnJlbnRTY2FsZVZhbHVlOwoKICAgICAgICAgICAgICAgICAgX3RoaXMxMC5zZXRJbml0aWFsVmlldyhoYXNoKTsKCiAgICAgICAgICAgICAgICBjYXNlIDI2OgogICAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0OC5zdG9wKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LCBfY2FsbGVlOCk7CiAgICAgICAgfSkpOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKF94KSB7CiAgICAgICAgICByZXR1cm4gX3JlZjMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9OwogICAgICB9KCkpWyJjYXRjaCJdKGZ1bmN0aW9uICgpIHsKICAgICAgICBfdGhpczEwLnNldEluaXRpYWxWaWV3KCk7CiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgIHBkZlZpZXdlci51cGRhdGUoKTsKICAgICAgfSk7CiAgICB9KTsKICAgIHBhZ2VzUHJvbWlzZS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgX3RoaXMxMC5faW5pdGlhbGl6ZUF1dG9QcmludChwZGZEb2N1bWVudCwgb3BlbkFjdGlvblByb21pc2UpOwogICAgfSk7CiAgICBvbmVQYWdlUmVuZGVyZWQudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgIHBkZkRvY3VtZW50LmdldE91dGxpbmUoKS50aGVuKGZ1bmN0aW9uIChvdXRsaW5lKSB7CiAgICAgICAgX3RoaXMxMC5wZGZPdXRsaW5lVmlld2VyLnJlbmRlcih7CiAgICAgICAgICBvdXRsaW5lOiBvdXRsaW5lCiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICBwZGZEb2N1bWVudC5nZXRBdHRhY2htZW50cygpLnRoZW4oZnVuY3Rpb24gKGF0dGFjaG1lbnRzKSB7CiAgICAgICAgX3RoaXMxMC5wZGZBdHRhY2htZW50Vmlld2VyLnJlbmRlcih7CiAgICAgICAgICBhdHRhY2htZW50czogYXR0YWNobWVudHMKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9KTsKCiAgICB0aGlzLl9pbml0aWFsaXplUGFnZUxhYmVscyhwZGZEb2N1bWVudCk7CgogICAgdGhpcy5faW5pdGlhbGl6ZU1ldGFkYXRhKHBkZkRvY3VtZW50KTsKICB9LAogIF9pbml0aWFsaXplQXV0b1ByaW50OiBmdW5jdGlvbiBfaW5pdGlhbGl6ZUF1dG9QcmludChwZGZEb2N1bWVudCwgb3BlbkFjdGlvblByb21pc2UpIHsKICAgIHZhciBfdGhpczExID0gdGhpczsKCiAgICByZXR1cm4gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JbImRlZmF1bHQiXS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU5KCkgewogICAgICB2YXIgX3lpZWxkJFByb21pc2UkYWxsLCBfeWllbGQkUHJvbWlzZSRhbGwyLCBvcGVuQWN0aW9uLCBqYXZhU2NyaXB0LCB0cmlnZ2VyQXV0b1ByaW50LCBfaXRlcmF0b3IsIF9zdGVwLCBqczsKCiAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JbImRlZmF1bHQiXS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU5JChfY29udGV4dDkpIHsKICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgc3dpdGNoIChfY29udGV4dDkucHJldiA9IF9jb250ZXh0OS5uZXh0KSB7CiAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICBfY29udGV4dDkubmV4dCA9IDI7CiAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFtvcGVuQWN0aW9uUHJvbWlzZSwgcGRmRG9jdW1lbnQuZ2V0SmF2YVNjcmlwdCgpXSk7CgogICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgX3lpZWxkJFByb21pc2UkYWxsID0gX2NvbnRleHQ5LnNlbnQ7CiAgICAgICAgICAgICAgX3lpZWxkJFByb21pc2UkYWxsMiA9IF9zbGljZWRUb0FycmF5KF95aWVsZCRQcm9taXNlJGFsbCwgMik7CiAgICAgICAgICAgICAgb3BlbkFjdGlvbiA9IF95aWVsZCRQcm9taXNlJGFsbDJbMF07CiAgICAgICAgICAgICAgamF2YVNjcmlwdCA9IF95aWVsZCRQcm9taXNlJGFsbDJbMV07CgogICAgICAgICAgICAgIGlmICghKHBkZkRvY3VtZW50ICE9PSBfdGhpczExLnBkZkRvY3VtZW50KSkgewogICAgICAgICAgICAgICAgX2NvbnRleHQ5Lm5leHQgPSA4OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ5LmFicnVwdCgicmV0dXJuIik7CgogICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgdHJpZ2dlckF1dG9QcmludCA9IGZhbHNlOwoKICAgICAgICAgICAgICBpZiAob3BlbkFjdGlvbiAmJiBvcGVuQWN0aW9uLmFjdGlvbiA9PT0gIlByaW50IikgewogICAgICAgICAgICAgICAgdHJpZ2dlckF1dG9QcmludCA9IHRydWU7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZiAoIWphdmFTY3JpcHQpIHsKICAgICAgICAgICAgICAgIF9jb250ZXh0OS5uZXh0ID0gMzE7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGphdmFTY3JpcHQuc29tZShmdW5jdGlvbiAoanMpIHsKICAgICAgICAgICAgICAgIGlmICghanMpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiV2FybmluZzogSmF2YVNjcmlwdCBpcyBub3Qgc3VwcG9ydGVkIik7CgogICAgICAgICAgICAgICAgX3RoaXMxMS5mYWxsYmFjayhfcGRmanNMaWIuVU5TVVBQT1JURURfRkVBVFVSRVMuamF2YVNjcmlwdCk7CgogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGlmICh0cmlnZ2VyQXV0b1ByaW50KSB7CiAgICAgICAgICAgICAgICBfY29udGV4dDkubmV4dCA9IDMxOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBfaXRlcmF0b3IgPSBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcihqYXZhU2NyaXB0KTsKICAgICAgICAgICAgICBfY29udGV4dDkucHJldiA9IDE0OwoKICAgICAgICAgICAgICBfaXRlcmF0b3IucygpOwoKICAgICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgICAgICBpZiAoKF9zdGVwID0gX2l0ZXJhdG9yLm4oKSkuZG9uZSkgewogICAgICAgICAgICAgICAgX2NvbnRleHQ5Lm5leHQgPSAyMzsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAganMgPSBfc3RlcC52YWx1ZTsKCiAgICAgICAgICAgICAgaWYgKCEoanMgJiYgX3VpX3V0aWxzLkF1dG9QcmludFJlZ0V4cC50ZXN0KGpzKSkpIHsKICAgICAgICAgICAgICAgIF9jb250ZXh0OS5uZXh0ID0gMjE7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHRyaWdnZXJBdXRvUHJpbnQgPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDkuYWJydXB0KCJicmVhayIsIDIzKTsKCiAgICAgICAgICAgIGNhc2UgMjE6CiAgICAgICAgICAgICAgX2NvbnRleHQ5Lm5leHQgPSAxNjsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgMjM6CiAgICAgICAgICAgICAgX2NvbnRleHQ5Lm5leHQgPSAyODsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgMjU6CiAgICAgICAgICAgICAgX2NvbnRleHQ5LnByZXYgPSAyNTsKICAgICAgICAgICAgICBfY29udGV4dDkudDAgPSBfY29udGV4dDlbImNhdGNoIl0oMTQpOwoKICAgICAgICAgICAgICBfaXRlcmF0b3IuZShfY29udGV4dDkudDApOwoKICAgICAgICAgICAgY2FzZSAyODoKICAgICAgICAgICAgICBfY29udGV4dDkucHJldiA9IDI4OwoKICAgICAgICAgICAgICBfaXRlcmF0b3IuZigpOwoKICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ5LmZpbmlzaCgyOCk7CgogICAgICAgICAgICBjYXNlIDMxOgogICAgICAgICAgICAgIGlmIChfdGhpczExLnN1cHBvcnRzUHJpbnRpbmcpIHsKICAgICAgICAgICAgICAgIF9jb250ZXh0OS5uZXh0ID0gMzM7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDkuYWJydXB0KCJyZXR1cm4iKTsKCiAgICAgICAgICAgIGNhc2UgMzM6CiAgICAgICAgICAgICAgaWYgKHRyaWdnZXJBdXRvUHJpbnQpIHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICB3aW5kb3cucHJpbnQoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNhc2UgMzQ6CiAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0OS5zdG9wKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCBfY2FsbGVlOSwgbnVsbCwgW1sxNCwgMjUsIDI4LCAzMV1dKTsKICAgIH0pKSgpOwogIH0sCiAgX2luaXRpYWxpemVNZXRhZGF0YTogZnVuY3Rpb24gX2luaXRpYWxpemVNZXRhZGF0YShwZGZEb2N1bWVudCkgewogICAgdmFyIF90aGlzMTIgPSB0aGlzOwoKICAgIHJldHVybiBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclsiZGVmYXVsdCJdLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTEwKCkgewogICAgICB2YXIgX3lpZWxkJHBkZkRvY3VtZW50JGdlLCBpbmZvLCBtZXRhZGF0YSwgY29udGVudERpc3Bvc2l0aW9uRmlsZW5hbWUsIHBkZlRpdGxlLCBpbmZvVGl0bGUsIG1ldGFkYXRhVGl0bGUsIHZlcnNpb25JZCwgS05PV05fVkVSU0lPTlMsIGdlbmVyYXRvcklkLCBLTk9XTl9HRU5FUkFUT1JTLCBwcm9kdWNlciwgZm9ybVR5cGU7CgogICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ud3JhcChmdW5jdGlvbiBfY2FsbGVlMTAkKF9jb250ZXh0MTApIHsKICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgc3dpdGNoIChfY29udGV4dDEwLnByZXYgPSBfY29udGV4dDEwLm5leHQpIHsKICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgIF9jb250ZXh0MTAubmV4dCA9IDI7CiAgICAgICAgICAgICAgcmV0dXJuIHBkZkRvY3VtZW50LmdldE1ldGFkYXRhKCk7CgogICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgX3lpZWxkJHBkZkRvY3VtZW50JGdlID0gX2NvbnRleHQxMC5zZW50OwogICAgICAgICAgICAgIGluZm8gPSBfeWllbGQkcGRmRG9jdW1lbnQkZ2UuaW5mbzsKICAgICAgICAgICAgICBtZXRhZGF0YSA9IF95aWVsZCRwZGZEb2N1bWVudCRnZS5tZXRhZGF0YTsKICAgICAgICAgICAgICBjb250ZW50RGlzcG9zaXRpb25GaWxlbmFtZSA9IF95aWVsZCRwZGZEb2N1bWVudCRnZS5jb250ZW50RGlzcG9zaXRpb25GaWxlbmFtZTsKCiAgICAgICAgICAgICAgaWYgKCEocGRmRG9jdW1lbnQgIT09IF90aGlzMTIucGRmRG9jdW1lbnQpKSB7CiAgICAgICAgICAgICAgICBfY29udGV4dDEwLm5leHQgPSA4OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMC5hYnJ1cHQoInJldHVybiIpOwoKICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgIF90aGlzMTIuZG9jdW1lbnRJbmZvID0gaW5mbzsKICAgICAgICAgICAgICBfdGhpczEyLm1ldGFkYXRhID0gbWV0YWRhdGE7CiAgICAgICAgICAgICAgX3RoaXMxMi5jb250ZW50RGlzcG9zaXRpb25GaWxlbmFtZSA9IGNvbnRlbnREaXNwb3NpdGlvbkZpbGVuYW1lOwogICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJQREYgIi5jb25jYXQocGRmRG9jdW1lbnQuZmluZ2VycHJpbnQsICIgWyIpLmNvbmNhdChpbmZvLlBERkZvcm1hdFZlcnNpb24sICIgIikgKyAiIi5jb25jYXQoKGluZm8uUHJvZHVjZXIgfHwgIi0iKS50cmltKCksICIgLyAiKS5jb25jYXQoKGluZm8uQ3JlYXRvciB8fCAiLSIpLnRyaW0oKSwgIl0gIikgKyAiKFBERi5qczogIi5jb25jYXQoX3BkZmpzTGliLnZlcnNpb24gfHwgIi0iKSArICIiLmNvbmNhdChfdGhpczEyLnBkZlZpZXdlci5lbmFibGVXZWJHTCA/ICIgW1dlYkdMXSIgOiAiIiwgIikiKSk7CiAgICAgICAgICAgICAgaW5mb1RpdGxlID0gaW5mbyAmJiBpbmZvLlRpdGxlOwoKICAgICAgICAgICAgICBpZiAoaW5mb1RpdGxlKSB7CiAgICAgICAgICAgICAgICBwZGZUaXRsZSA9IGluZm9UaXRsZTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIG1ldGFkYXRhVGl0bGUgPSBtZXRhZGF0YSAmJiBtZXRhZGF0YS5nZXQoImRjOnRpdGxlIik7CgogICAgICAgICAgICAgIGlmIChtZXRhZGF0YVRpdGxlKSB7CiAgICAgICAgICAgICAgICBpZiAobWV0YWRhdGFUaXRsZSAhPT0gIlVudGl0bGVkIiAmJiAhL1tcdUZGRjAtXHVGRkZGXS9nLnRlc3QobWV0YWRhdGFUaXRsZSkpIHsKICAgICAgICAgICAgICAgICAgcGRmVGl0bGUgPSBtZXRhZGF0YVRpdGxlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKHBkZlRpdGxlKSB7CiAgICAgICAgICAgICAgICBfdGhpczEyLnNldFRpdGxlKCIiLmNvbmNhdChwZGZUaXRsZSwgIiAtICIpLmNvbmNhdChjb250ZW50RGlzcG9zaXRpb25GaWxlbmFtZSB8fCBkb2N1bWVudC50aXRsZSkpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29udGVudERpc3Bvc2l0aW9uRmlsZW5hbWUpIHsKICAgICAgICAgICAgICAgIF90aGlzMTIuc2V0VGl0bGUoY29udGVudERpc3Bvc2l0aW9uRmlsZW5hbWUpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKGluZm8uSXNBY3JvRm9ybVByZXNlbnQpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiV2FybmluZzogQWNyb0Zvcm0vWEZBIGlzIG5vdCBzdXBwb3J0ZWQiKTsKCiAgICAgICAgICAgICAgICBfdGhpczEyLmZhbGxiYWNrKF9wZGZqc0xpYi5VTlNVUFBPUlRFRF9GRUFUVVJFUy5mb3Jtcyk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB2ZXJzaW9uSWQgPSAib3RoZXIiOwogICAgICAgICAgICAgIEtOT1dOX1ZFUlNJT05TID0gWyIxLjAiLCAiMS4xIiwgIjEuMiIsICIxLjMiLCAiMS40IiwgIjEuNSIsICIxLjYiLCAiMS43IiwgIjEuOCIsICIxLjkiLCAiMi4wIiwgIjIuMSIsICIyLjIiLCAiMi4zIl07CgogICAgICAgICAgICAgIGlmIChLTk9XTl9WRVJTSU9OUy5pbmNsdWRlcyhpbmZvLlBERkZvcm1hdFZlcnNpb24pKSB7CiAgICAgICAgICAgICAgICB2ZXJzaW9uSWQgPSAidiIuY29uY2F0KGluZm8uUERGRm9ybWF0VmVyc2lvbi5yZXBsYWNlKCIuIiwgIl8iKSk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBnZW5lcmF0b3JJZCA9ICJvdGhlciI7CiAgICAgICAgICAgICAgS05PV05fR0VORVJBVE9SUyA9IFsiYWNyb2JhdCBkaXN0aWxsZXIiLCAiYWNyb2JhdCBwZGZ3cml0ZXIiLCAiYWRvYmUgbGl2ZWN5Y2xlIiwgImFkb2JlIHBkZiBsaWJyYXJ5IiwgImFkb2JlIHBob3Rvc2hvcCIsICJnaG9zdHNjcmlwdCIsICJ0Y3BkZiIsICJjYWlybyIsICJkdmlwZGZtIiwgImR2aXBzIiwgInBkZnRleCIsICJwZGZraXQiLCAiaXRleHQiLCAicHJpbmNlIiwgInF1YXJreHByZXNzIiwgIm1hYyBvcyB4IiwgIm1pY3Jvc29mdCIsICJvcGVub2ZmaWNlIiwgIm9yYWNsZSIsICJsdXJhZG9jdW1lbnQiLCAicGRmLXhjaGFuZ2UiLCAiYW50ZW5uYSBob3VzZSIsICJhc3Bvc2UuY2VsbHMiLCAiZnBkZiJdOwoKICAgICAgICAgICAgICBpZiAoaW5mby5Qcm9kdWNlcikgewogICAgICAgICAgICAgICAgcHJvZHVjZXIgPSBpbmZvLlByb2R1Y2VyLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICBLTk9XTl9HRU5FUkFUT1JTLnNvbWUoZnVuY3Rpb24gKGdlbmVyYXRvcikgewogICAgICAgICAgICAgICAgICBpZiAoIXByb2R1Y2VyLmluY2x1ZGVzKGdlbmVyYXRvcikpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGdlbmVyYXRvcklkID0gZ2VuZXJhdG9yLnJlcGxhY2UoL1sgLlwtXS9nLCAiXyIpOwogICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgZm9ybVR5cGUgPSBudWxsOwoKICAgICAgICAgICAgICBpZiAoaW5mby5Jc0Fjcm9Gb3JtUHJlc2VudCkgewogICAgICAgICAgICAgICAgZm9ybVR5cGUgPSBpbmZvLklzWEZBUHJlc2VudCA/ICJ4ZmEiIDogImFjcm9mb3JtIjsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIF90aGlzMTIuZXh0ZXJuYWxTZXJ2aWNlcy5yZXBvcnRUZWxlbWV0cnkoewogICAgICAgICAgICAgICAgdHlwZTogImRvY3VtZW50SW5mbyIsCiAgICAgICAgICAgICAgICB2ZXJzaW9uOiB2ZXJzaW9uSWQsCiAgICAgICAgICAgICAgICBnZW5lcmF0b3I6IGdlbmVyYXRvcklkLAogICAgICAgICAgICAgICAgZm9ybVR5cGU6IGZvcm1UeXBlCiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBjYXNlIDI3OgogICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDEwLnN0b3AoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIF9jYWxsZWUxMCk7CiAgICB9KSkoKTsKICB9LAogIF9pbml0aWFsaXplUGFnZUxhYmVsczogZnVuY3Rpb24gX2luaXRpYWxpemVQYWdlTGFiZWxzKHBkZkRvY3VtZW50KSB7CiAgICB2YXIgX3RoaXMxMyA9IHRoaXM7CgogICAgcmV0dXJuIF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ubWFyayhmdW5jdGlvbiBfY2FsbGVlMTEoKSB7CiAgICAgIHZhciBsYWJlbHMsIG51bUxhYmVscywgaSwgcGRmVmlld2VyLCBwZGZUaHVtYm5haWxWaWV3ZXIsIHRvb2xiYXI7CiAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JbImRlZmF1bHQiXS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUxMSQoX2NvbnRleHQxMSkgewogICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MTEucHJldiA9IF9jb250ZXh0MTEubmV4dCkgewogICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgX2NvbnRleHQxMS5uZXh0ID0gMjsKICAgICAgICAgICAgICByZXR1cm4gcGRmRG9jdW1lbnQuZ2V0UGFnZUxhYmVscygpOwoKICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgIGxhYmVscyA9IF9jb250ZXh0MTEuc2VudDsKCiAgICAgICAgICAgICAgaWYgKCEocGRmRG9jdW1lbnQgIT09IF90aGlzMTMucGRmRG9jdW1lbnQpKSB7CiAgICAgICAgICAgICAgICBfY29udGV4dDExLm5leHQgPSA1OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMS5hYnJ1cHQoInJldHVybiIpOwoKICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgIGlmICghKCFsYWJlbHMgfHwgX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuZ2V0KCJkaXNhYmxlUGFnZUxhYmVscyIpKSkgewogICAgICAgICAgICAgICAgX2NvbnRleHQxMS5uZXh0ID0gNzsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTEuYWJydXB0KCJyZXR1cm4iKTsKCiAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICBudW1MYWJlbHMgPSBsYWJlbHMubGVuZ3RoOwoKICAgICAgICAgICAgICBpZiAoIShudW1MYWJlbHMgIT09IF90aGlzMTMucGFnZXNDb3VudCkpIHsKICAgICAgICAgICAgICAgIF9jb250ZXh0MTEubmV4dCA9IDExOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCJUaGUgbnVtYmVyIG9mIFBhZ2UgTGFiZWxzIGRvZXMgbm90IG1hdGNoIHRoZSBudW1iZXIgb2YgcGFnZXMgaW4gdGhlIGRvY3VtZW50LiIpOwogICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDExLmFicnVwdCgicmV0dXJuIik7CgogICAgICAgICAgICBjYXNlIDExOgogICAgICAgICAgICAgIGkgPSAwOwoKICAgICAgICAgICAgICB3aGlsZSAoaSA8IG51bUxhYmVscyAmJiBsYWJlbHNbaV0gPT09IChpICsgMSkudG9TdHJpbmcoKSkgewogICAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKCEoaSA9PT0gbnVtTGFiZWxzKSkgewogICAgICAgICAgICAgICAgX2NvbnRleHQxMS5uZXh0ID0gMTU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDExLmFicnVwdCgicmV0dXJuIik7CgogICAgICAgICAgICBjYXNlIDE1OgogICAgICAgICAgICAgIHBkZlZpZXdlciA9IF90aGlzMTMucGRmVmlld2VyLCBwZGZUaHVtYm5haWxWaWV3ZXIgPSBfdGhpczEzLnBkZlRodW1ibmFpbFZpZXdlciwgdG9vbGJhciA9IF90aGlzMTMudG9vbGJhcjsKICAgICAgICAgICAgICBwZGZWaWV3ZXIuc2V0UGFnZUxhYmVscyhsYWJlbHMpOwogICAgICAgICAgICAgIHBkZlRodW1ibmFpbFZpZXdlci5zZXRQYWdlTGFiZWxzKGxhYmVscyk7CiAgICAgICAgICAgICAgdG9vbGJhci5zZXRQYWdlc0NvdW50KG51bUxhYmVscywgdHJ1ZSk7CiAgICAgICAgICAgICAgdG9vbGJhci5zZXRQYWdlTnVtYmVyKHBkZlZpZXdlci5jdXJyZW50UGFnZU51bWJlciwgcGRmVmlld2VyLmN1cnJlbnRQYWdlTGFiZWwpOwoKICAgICAgICAgICAgY2FzZSAyMDoKICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMS5zdG9wKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCBfY2FsbGVlMTEpOwogICAgfSkpKCk7CiAgfSwKICBfaW5pdGlhbGl6ZVBkZkhpc3Rvcnk6IGZ1bmN0aW9uIF9pbml0aWFsaXplUGRmSGlzdG9yeShfcmVmNSkgewogICAgdmFyIGZpbmdlcnByaW50ID0gX3JlZjUuZmluZ2VycHJpbnQsCiAgICAgICAgdmlld09uTG9hZCA9IF9yZWY1LnZpZXdPbkxvYWQsCiAgICAgICAgX3JlZjUkaW5pdGlhbERlc3QgPSBfcmVmNS5pbml0aWFsRGVzdCwKICAgICAgICBpbml0aWFsRGVzdCA9IF9yZWY1JGluaXRpYWxEZXN0ID09PSB2b2lkIDAgPyBudWxsIDogX3JlZjUkaW5pdGlhbERlc3Q7CgogICAgaWYgKHRoaXMuaXNWaWV3ZXJFbWJlZGRlZCB8fCBfYXBwX29wdGlvbnMuQXBwT3B0aW9ucy5nZXQoImRpc2FibGVIaXN0b3J5IikpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHRoaXMucGRmSGlzdG9yeS5pbml0aWFsaXplKHsKICAgICAgZmluZ2VycHJpbnQ6IGZpbmdlcnByaW50LAogICAgICByZXNldEhpc3Rvcnk6IHZpZXdPbkxvYWQgPT09IFZpZXdPbkxvYWQuSU5JVElBTCwKICAgICAgdXBkYXRlVXJsOiBfYXBwX29wdGlvbnMuQXBwT3B0aW9ucy5nZXQoImhpc3RvcnlVcGRhdGVVcmwiKQogICAgfSk7CgogICAgaWYgKHRoaXMucGRmSGlzdG9yeS5pbml0aWFsQm9va21hcmspIHsKICAgICAgdGhpcy5pbml0aWFsQm9va21hcmsgPSB0aGlzLnBkZkhpc3RvcnkuaW5pdGlhbEJvb2ttYXJrOwogICAgICB0aGlzLmluaXRpYWxSb3RhdGlvbiA9IHRoaXMucGRmSGlzdG9yeS5pbml0aWFsUm90YXRpb247CiAgICB9CgogICAgaWYgKGluaXRpYWxEZXN0ICYmICF0aGlzLmluaXRpYWxCb29rbWFyayAmJiB2aWV3T25Mb2FkID09PSBWaWV3T25Mb2FkLlVOS05PV04pIHsKICAgICAgdGhpcy5pbml0aWFsQm9va21hcmsgPSBKU09OLnN0cmluZ2lmeShpbml0aWFsRGVzdCk7CiAgICAgIHRoaXMucGRmSGlzdG9yeS5wdXNoKHsKICAgICAgICBleHBsaWNpdERlc3Q6IGluaXRpYWxEZXN0LAogICAgICAgIHBhZ2VOdW1iZXI6IG51bGwKICAgICAgfSk7CiAgICB9CiAgfSwKICBfaW5pdGlhbGl6ZVBlcm1pc3Npb25zOiBmdW5jdGlvbiBfaW5pdGlhbGl6ZVBlcm1pc3Npb25zKHBkZkRvY3VtZW50KSB7CiAgICB2YXIgX3RoaXMxNCA9IHRoaXM7CgogICAgcmV0dXJuIF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ubWFyayhmdW5jdGlvbiBfY2FsbGVlMTIoKSB7CiAgICAgIHZhciBwZXJtaXNzaW9uczsKICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclsiZGVmYXVsdCJdLndyYXAoZnVuY3Rpb24gX2NhbGxlZTEyJChfY29udGV4dDEyKSB7CiAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQxMi5wcmV2ID0gX2NvbnRleHQxMi5uZXh0KSB7CiAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICBfY29udGV4dDEyLm5leHQgPSAyOwogICAgICAgICAgICAgIHJldHVybiBwZGZEb2N1bWVudC5nZXRQZXJtaXNzaW9ucygpOwoKICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgIHBlcm1pc3Npb25zID0gX2NvbnRleHQxMi5zZW50OwoKICAgICAgICAgICAgICBpZiAoIShwZGZEb2N1bWVudCAhPT0gX3RoaXMxNC5wZGZEb2N1bWVudCkpIHsKICAgICAgICAgICAgICAgIF9jb250ZXh0MTIubmV4dCA9IDU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDEyLmFicnVwdCgicmV0dXJuIik7CgogICAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgICAgaWYgKCEoIXBlcm1pc3Npb25zIHx8ICFfYXBwX29wdGlvbnMuQXBwT3B0aW9ucy5nZXQoImVuYWJsZVBlcm1pc3Npb25zIikpKSB7CiAgICAgICAgICAgICAgICBfY29udGV4dDEyLm5leHQgPSA3OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMi5hYnJ1cHQoInJldHVybiIpOwoKICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgIGlmICghcGVybWlzc2lvbnMuaW5jbHVkZXMoX3BkZmpzTGliLlBlcm1pc3Npb25GbGFnLkNPUFkpKSB7CiAgICAgICAgICAgICAgICBfdGhpczE0LmFwcENvbmZpZy52aWV3ZXJDb250YWluZXIuY2xhc3NMaXN0LmFkZChFTkFCTEVfUEVSTUlTU0lPTlNfQ0xBU1MpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMi5zdG9wKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCBfY2FsbGVlMTIpOwogICAgfSkpKCk7CiAgfSwKICBzZXRJbml0aWFsVmlldzogZnVuY3Rpb24gc2V0SW5pdGlhbFZpZXcoc3RvcmVkSGFzaCkgewogICAgdmFyIF90aGlzMTUgPSB0aGlzOwoKICAgIHZhciBfcmVmNiA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDoge30sCiAgICAgICAgcm90YXRpb24gPSBfcmVmNi5yb3RhdGlvbiwKICAgICAgICBzaWRlYmFyVmlldyA9IF9yZWY2LnNpZGViYXJWaWV3LAogICAgICAgIHNjcm9sbE1vZGUgPSBfcmVmNi5zY3JvbGxNb2RlLAogICAgICAgIHNwcmVhZE1vZGUgPSBfcmVmNi5zcHJlYWRNb2RlOwoKICAgIHZhciBzZXRSb3RhdGlvbiA9IGZ1bmN0aW9uIHNldFJvdGF0aW9uKGFuZ2xlKSB7CiAgICAgIGlmICgoMCwgX3VpX3V0aWxzLmlzVmFsaWRSb3RhdGlvbikoYW5nbGUpKSB7CiAgICAgICAgX3RoaXMxNS5wZGZWaWV3ZXIucGFnZXNSb3RhdGlvbiA9IGFuZ2xlOwogICAgICB9CiAgICB9OwoKICAgIHZhciBzZXRWaWV3ZXJNb2RlcyA9IGZ1bmN0aW9uIHNldFZpZXdlck1vZGVzKHNjcm9sbCwgc3ByZWFkKSB7CiAgICAgIGlmICgoMCwgX3VpX3V0aWxzLmlzVmFsaWRTY3JvbGxNb2RlKShzY3JvbGwpKSB7CiAgICAgICAgX3RoaXMxNS5wZGZWaWV3ZXIuc2Nyb2xsTW9kZSA9IHNjcm9sbDsKICAgICAgfQoKICAgICAgaWYgKCgwLCBfdWlfdXRpbHMuaXNWYWxpZFNwcmVhZE1vZGUpKHNwcmVhZCkpIHsKICAgICAgICBfdGhpczE1LnBkZlZpZXdlci5zcHJlYWRNb2RlID0gc3ByZWFkOwogICAgICB9CiAgICB9OwoKICAgIHRoaXMuaXNJbml0aWFsVmlld1NldCA9IHRydWU7CiAgICB0aGlzLnBkZlNpZGViYXIuc2V0SW5pdGlhbFZpZXcoc2lkZWJhclZpZXcpOwogICAgc2V0Vmlld2VyTW9kZXMoc2Nyb2xsTW9kZSwgc3ByZWFkTW9kZSk7CgogICAgaWYgKHRoaXMuaW5pdGlhbEJvb2ttYXJrKSB7CiAgICAgIHNldFJvdGF0aW9uKHRoaXMuaW5pdGlhbFJvdGF0aW9uKTsKICAgICAgZGVsZXRlIHRoaXMuaW5pdGlhbFJvdGF0aW9uOwogICAgICB0aGlzLnBkZkxpbmtTZXJ2aWNlLnNldEhhc2godGhpcy5pbml0aWFsQm9va21hcmspOwogICAgICB0aGlzLmluaXRpYWxCb29rbWFyayA9IG51bGw7CiAgICB9IGVsc2UgaWYgKHN0b3JlZEhhc2gpIHsKICAgICAgc2V0Um90YXRpb24ocm90YXRpb24pOwogICAgICB0aGlzLnBkZkxpbmtTZXJ2aWNlLnNldEhhc2goc3RvcmVkSGFzaCk7CiAgICB9CgogICAgdGhpcy50b29sYmFyLnNldFBhZ2VOdW1iZXIodGhpcy5wZGZWaWV3ZXIuY3VycmVudFBhZ2VOdW1iZXIsIHRoaXMucGRmVmlld2VyLmN1cnJlbnRQYWdlTGFiZWwpOwogICAgdGhpcy5zZWNvbmRhcnlUb29sYmFyLnNldFBhZ2VOdW1iZXIodGhpcy5wZGZWaWV3ZXIuY3VycmVudFBhZ2VOdW1iZXIpOwoKICAgIGlmICghdGhpcy5wZGZWaWV3ZXIuY3VycmVudFNjYWxlVmFsdWUpIHsKICAgICAgdGhpcy5wZGZWaWV3ZXIuY3VycmVudFNjYWxlVmFsdWUgPSBfdWlfdXRpbHMuREVGQVVMVF9TQ0FMRV9WQUxVRTsKICAgIH0KICB9LAogIGNsZWFudXA6IGZ1bmN0aW9uIGNsZWFudXAoKSB7CiAgICBpZiAoIXRoaXMucGRmRG9jdW1lbnQpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHRoaXMucGRmVmlld2VyLmNsZWFudXAoKTsKICAgIHRoaXMucGRmVGh1bWJuYWlsVmlld2VyLmNsZWFudXAoKTsKCiAgICBpZiAodGhpcy5wZGZWaWV3ZXIucmVuZGVyZXIgIT09IF91aV91dGlscy5SZW5kZXJlclR5cGUuU1ZHKSB7CiAgICAgIHRoaXMucGRmRG9jdW1lbnQuY2xlYW51cCgpOwogICAgfQogIH0sCiAgZm9yY2VSZW5kZXJpbmc6IGZ1bmN0aW9uIGZvcmNlUmVuZGVyaW5nKCkgewogICAgdGhpcy5wZGZSZW5kZXJpbmdRdWV1ZS5wcmludGluZyA9IHRoaXMucHJpbnRpbmc7CiAgICB0aGlzLnBkZlJlbmRlcmluZ1F1ZXVlLmlzVGh1bWJuYWlsVmlld0VuYWJsZWQgPSB0aGlzLnBkZlNpZGViYXIuaXNUaHVtYm5haWxWaWV3VmlzaWJsZTsKICAgIHRoaXMucGRmUmVuZGVyaW5nUXVldWUucmVuZGVySGlnaGVzdFByaW9yaXR5KCk7CiAgfSwKICBiZWZvcmVQcmludDogZnVuY3Rpb24gYmVmb3JlUHJpbnQoKSB7CiAgICB2YXIgX3RoaXMxNiA9IHRoaXM7CgogICAgaWYgKHRoaXMucHJpbnRTZXJ2aWNlKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoIXRoaXMuc3VwcG9ydHNQcmludGluZykgewogICAgICB0aGlzLmwxMG4uZ2V0KCJwcmludGluZ19ub3Rfc3VwcG9ydGVkIiwgbnVsbCwgIldhcm5pbmc6IFByaW50aW5nIGlzIG5vdCBmdWxseSBzdXBwb3J0ZWQgYnkgdGhpcyBicm93c2VyLiIpLnRoZW4oZnVuY3Rpb24gKHByaW50TWVzc2FnZSkgewogICAgICAgIF90aGlzMTYuZXJyb3IocHJpbnRNZXNzYWdlKTsKICAgICAgfSk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoIXRoaXMucGRmVmlld2VyLnBhZ2VWaWV3c1JlYWR5KSB7CiAgICAgIHRoaXMubDEwbi5nZXQoInByaW50aW5nX25vdF9yZWFkeSIsIG51bGwsICJXYXJuaW5nOiBUaGUgUERGIGlzIG5vdCBmdWxseSBsb2FkZWQgZm9yIHByaW50aW5nLiIpLnRoZW4oZnVuY3Rpb24gKG5vdFJlYWR5TWVzc2FnZSkgewogICAgICAgIHdpbmRvdy5hbGVydChub3RSZWFkeU1lc3NhZ2UpOwogICAgICB9KTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBwYWdlc092ZXJ2aWV3ID0gdGhpcy5wZGZWaWV3ZXIuZ2V0UGFnZXNPdmVydmlldygpOwogICAgdmFyIHByaW50Q29udGFpbmVyID0gdGhpcy5hcHBDb25maWcucHJpbnRDb250YWluZXI7CiAgICB2YXIgcHJpbnRTZXJ2aWNlID0gUERGUHJpbnRTZXJ2aWNlRmFjdG9yeS5pbnN0YW5jZS5jcmVhdGVQcmludFNlcnZpY2UodGhpcy5wZGZEb2N1bWVudCwgcGFnZXNPdmVydmlldywgcHJpbnRDb250YWluZXIsIHRoaXMubDEwbik7CiAgICB0aGlzLnByaW50U2VydmljZSA9IHByaW50U2VydmljZTsKICAgIHRoaXMuZm9yY2VSZW5kZXJpbmcoKTsKICAgIHByaW50U2VydmljZS5sYXlvdXQoKTsKICAgIHRoaXMuZXh0ZXJuYWxTZXJ2aWNlcy5yZXBvcnRUZWxlbWV0cnkoewogICAgICB0eXBlOiAicHJpbnQiCiAgICB9KTsKICB9LAogIGFmdGVyUHJpbnQ6IGZ1bmN0aW9uIGFmdGVyUHJpbnQoKSB7CiAgICBpZiAodGhpcy5wcmludFNlcnZpY2UpIHsKICAgICAgdGhpcy5wcmludFNlcnZpY2UuZGVzdHJveSgpOwogICAgICB0aGlzLnByaW50U2VydmljZSA9IG51bGw7CiAgICB9CgogICAgdGhpcy5mb3JjZVJlbmRlcmluZygpOwogIH0sCiAgcm90YXRlUGFnZXM6IGZ1bmN0aW9uIHJvdGF0ZVBhZ2VzKGRlbHRhKSB7CiAgICBpZiAoIXRoaXMucGRmRG9jdW1lbnQpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBuZXdSb3RhdGlvbiA9ICh0aGlzLnBkZlZpZXdlci5wYWdlc1JvdGF0aW9uICsgMzYwICsgZGVsdGEpICUgMzYwOwogICAgdGhpcy5wZGZWaWV3ZXIucGFnZXNSb3RhdGlvbiA9IG5ld1JvdGF0aW9uOwogIH0sCiAgcmVxdWVzdFByZXNlbnRhdGlvbk1vZGU6IGZ1bmN0aW9uIHJlcXVlc3RQcmVzZW50YXRpb25Nb2RlKCkgewogICAgaWYgKCF0aGlzLnBkZlByZXNlbnRhdGlvbk1vZGUpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHRoaXMucGRmUHJlc2VudGF0aW9uTW9kZS5yZXF1ZXN0KCk7CiAgfSwKICBiaW5kRXZlbnRzOiBmdW5jdGlvbiBiaW5kRXZlbnRzKCkgewogICAgdmFyIGV2ZW50QnVzID0gdGhpcy5ldmVudEJ1cywKICAgICAgICBfYm91bmRFdmVudHMgPSB0aGlzLl9ib3VuZEV2ZW50czsKICAgIF9ib3VuZEV2ZW50cy5iZWZvcmVQcmludCA9IHRoaXMuYmVmb3JlUHJpbnQuYmluZCh0aGlzKTsKICAgIF9ib3VuZEV2ZW50cy5hZnRlclByaW50ID0gdGhpcy5hZnRlclByaW50LmJpbmQodGhpcyk7CgogICAgZXZlbnRCdXMuX29uKCJyZXNpemUiLCB3ZWJWaWV3ZXJSZXNpemUpOwoKICAgIGV2ZW50QnVzLl9vbigiaGFzaGNoYW5nZSIsIHdlYlZpZXdlckhhc2hjaGFuZ2UpOwoKICAgIGV2ZW50QnVzLl9vbigiYmVmb3JlcHJpbnQiLCBfYm91bmRFdmVudHMuYmVmb3JlUHJpbnQpOwoKICAgIGV2ZW50QnVzLl9vbigiYWZ0ZXJwcmludCIsIF9ib3VuZEV2ZW50cy5hZnRlclByaW50KTsKCiAgICBldmVudEJ1cy5fb24oInBhZ2VyZW5kZXJlZCIsIHdlYlZpZXdlclBhZ2VSZW5kZXJlZCk7CgogICAgZXZlbnRCdXMuX29uKCJ1cGRhdGV2aWV3YXJlYSIsIHdlYlZpZXdlclVwZGF0ZVZpZXdhcmVhKTsKCiAgICBldmVudEJ1cy5fb24oInBhZ2VjaGFuZ2luZyIsIHdlYlZpZXdlclBhZ2VDaGFuZ2luZyk7CgogICAgZXZlbnRCdXMuX29uKCJzY2FsZWNoYW5naW5nIiwgd2ViVmlld2VyU2NhbGVDaGFuZ2luZyk7CgogICAgZXZlbnRCdXMuX29uKCJyb3RhdGlvbmNoYW5naW5nIiwgd2ViVmlld2VyUm90YXRpb25DaGFuZ2luZyk7CgogICAgZXZlbnRCdXMuX29uKCJzaWRlYmFydmlld2NoYW5nZWQiLCB3ZWJWaWV3ZXJTaWRlYmFyVmlld0NoYW5nZWQpOwoKICAgIGV2ZW50QnVzLl9vbigicGFnZW1vZGUiLCB3ZWJWaWV3ZXJQYWdlTW9kZSk7CgogICAgZXZlbnRCdXMuX29uKCJuYW1lZGFjdGlvbiIsIHdlYlZpZXdlck5hbWVkQWN0aW9uKTsKCiAgICBldmVudEJ1cy5fb24oInByZXNlbnRhdGlvbm1vZGVjaGFuZ2VkIiwgd2ViVmlld2VyUHJlc2VudGF0aW9uTW9kZUNoYW5nZWQpOwoKICAgIGV2ZW50QnVzLl9vbigicHJlc2VudGF0aW9ubW9kZSIsIHdlYlZpZXdlclByZXNlbnRhdGlvbk1vZGUpOwoKICAgIGV2ZW50QnVzLl9vbigicHJpbnQiLCB3ZWJWaWV3ZXJQcmludCk7CgogICAgZXZlbnRCdXMuX29uKCJkb3dubG9hZCIsIHdlYlZpZXdlckRvd25sb2FkKTsKCiAgICBldmVudEJ1cy5fb24oImZpcnN0cGFnZSIsIHdlYlZpZXdlckZpcnN0UGFnZSk7CgogICAgZXZlbnRCdXMuX29uKCJsYXN0cGFnZSIsIHdlYlZpZXdlckxhc3RQYWdlKTsKCiAgICBldmVudEJ1cy5fb24oIm5leHRwYWdlIiwgd2ViVmlld2VyTmV4dFBhZ2UpOwoKICAgIGV2ZW50QnVzLl9vbigicHJldmlvdXNwYWdlIiwgd2ViVmlld2VyUHJldmlvdXNQYWdlKTsKCiAgICBldmVudEJ1cy5fb24oInpvb21pbiIsIHdlYlZpZXdlclpvb21Jbik7CgogICAgZXZlbnRCdXMuX29uKCJ6b29tb3V0Iiwgd2ViVmlld2VyWm9vbU91dCk7CgogICAgZXZlbnRCdXMuX29uKCJ6b29tcmVzZXQiLCB3ZWJWaWV3ZXJab29tUmVzZXQpOwoKICAgIGV2ZW50QnVzLl9vbigicGFnZW51bWJlcmNoYW5nZWQiLCB3ZWJWaWV3ZXJQYWdlTnVtYmVyQ2hhbmdlZCk7CgogICAgZXZlbnRCdXMuX29uKCJzY2FsZWNoYW5nZWQiLCB3ZWJWaWV3ZXJTY2FsZUNoYW5nZWQpOwoKICAgIGV2ZW50QnVzLl9vbigicm90YXRlY3ciLCB3ZWJWaWV3ZXJSb3RhdGVDdyk7CgogICAgZXZlbnRCdXMuX29uKCJyb3RhdGVjY3ciLCB3ZWJWaWV3ZXJSb3RhdGVDY3cpOwoKICAgIGV2ZW50QnVzLl9vbigic3dpdGNoc2Nyb2xsbW9kZSIsIHdlYlZpZXdlclN3aXRjaFNjcm9sbE1vZGUpOwoKICAgIGV2ZW50QnVzLl9vbigic2Nyb2xsbW9kZWNoYW5nZWQiLCB3ZWJWaWV3ZXJTY3JvbGxNb2RlQ2hhbmdlZCk7CgogICAgZXZlbnRCdXMuX29uKCJzd2l0Y2hzcHJlYWRtb2RlIiwgd2ViVmlld2VyU3dpdGNoU3ByZWFkTW9kZSk7CgogICAgZXZlbnRCdXMuX29uKCJzcHJlYWRtb2RlY2hhbmdlZCIsIHdlYlZpZXdlclNwcmVhZE1vZGVDaGFuZ2VkKTsKCiAgICBldmVudEJ1cy5fb24oImRvY3VtZW50cHJvcGVydGllcyIsIHdlYlZpZXdlckRvY3VtZW50UHJvcGVydGllcyk7CgogICAgZXZlbnRCdXMuX29uKCJmaW5kIiwgd2ViVmlld2VyRmluZCk7CgogICAgZXZlbnRCdXMuX29uKCJmaW5kZnJvbXVybGhhc2giLCB3ZWJWaWV3ZXJGaW5kRnJvbVVybEhhc2gpOwoKICAgIGV2ZW50QnVzLl9vbigidXBkYXRlZmluZG1hdGNoZXNjb3VudCIsIHdlYlZpZXdlclVwZGF0ZUZpbmRNYXRjaGVzQ291bnQpOwoKICAgIGV2ZW50QnVzLl9vbigidXBkYXRlZmluZGNvbnRyb2xzdGF0ZSIsIHdlYlZpZXdlclVwZGF0ZUZpbmRDb250cm9sU3RhdGUpOwoKICAgIGV2ZW50QnVzLl9vbigiZmlsZWlucHV0Y2hhbmdlIiwgd2ViVmlld2VyRmlsZUlucHV0Q2hhbmdlKTsKCiAgICBldmVudEJ1cy5fb24oIm9wZW5maWxlIiwgd2ViVmlld2VyT3BlbkZpbGUpOwogIH0sCiAgYmluZFdpbmRvd0V2ZW50czogZnVuY3Rpb24gYmluZFdpbmRvd0V2ZW50cygpIHsKICAgIHZhciBldmVudEJ1cyA9IHRoaXMuZXZlbnRCdXMsCiAgICAgICAgX2JvdW5kRXZlbnRzID0gdGhpcy5fYm91bmRFdmVudHM7CgogICAgX2JvdW5kRXZlbnRzLndpbmRvd1Jlc2l6ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgZXZlbnRCdXMuZGlzcGF0Y2goInJlc2l6ZSIsIHsKICAgICAgICBzb3VyY2U6IHdpbmRvdwogICAgICB9KTsKICAgIH07CgogICAgX2JvdW5kRXZlbnRzLndpbmRvd0hhc2hDaGFuZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGV2ZW50QnVzLmRpc3BhdGNoKCJoYXNoY2hhbmdlIiwgewogICAgICAgIHNvdXJjZTogd2luZG93LAogICAgICAgIGhhc2g6IGRvY3VtZW50LmxvY2F0aW9uLmhhc2guc3Vic3RyaW5nKDEpCiAgICAgIH0pOwogICAgfTsKCiAgICBfYm91bmRFdmVudHMud2luZG93QmVmb3JlUHJpbnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGV2ZW50QnVzLmRpc3BhdGNoKCJiZWZvcmVwcmludCIsIHsKICAgICAgICBzb3VyY2U6IHdpbmRvdwogICAgICB9KTsKICAgIH07CgogICAgX2JvdW5kRXZlbnRzLndpbmRvd0FmdGVyUHJpbnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGV2ZW50QnVzLmRpc3BhdGNoKCJhZnRlcnByaW50IiwgewogICAgICAgIHNvdXJjZTogd2luZG93CiAgICAgIH0pOwogICAgfTsKCiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigidmlzaWJpbGl0eWNoYW5nZSIsIHdlYlZpZXdlclZpc2liaWxpdHlDaGFuZ2UpOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoIndoZWVsIiwgd2ViVmlld2VyV2hlZWwsIHsKICAgICAgcGFzc2l2ZTogZmFsc2UKICAgIH0pOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgd2ViVmlld2VyQ2xpY2spOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCB3ZWJWaWV3ZXJLZXlEb3duKTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJyZXNpemUiLCBfYm91bmRFdmVudHMud2luZG93UmVzaXplKTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJoYXNoY2hhbmdlIiwgX2JvdW5kRXZlbnRzLndpbmRvd0hhc2hDaGFuZ2UpOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImJlZm9yZXByaW50IiwgX2JvdW5kRXZlbnRzLndpbmRvd0JlZm9yZVByaW50KTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJhZnRlcnByaW50IiwgX2JvdW5kRXZlbnRzLndpbmRvd0FmdGVyUHJpbnQpOwogIH0sCiAgdW5iaW5kRXZlbnRzOiBmdW5jdGlvbiB1bmJpbmRFdmVudHMoKSB7CiAgICB2YXIgZXZlbnRCdXMgPSB0aGlzLmV2ZW50QnVzLAogICAgICAgIF9ib3VuZEV2ZW50cyA9IHRoaXMuX2JvdW5kRXZlbnRzOwoKICAgIGV2ZW50QnVzLl9vZmYoInJlc2l6ZSIsIHdlYlZpZXdlclJlc2l6ZSk7CgogICAgZXZlbnRCdXMuX29mZigiaGFzaGNoYW5nZSIsIHdlYlZpZXdlckhhc2hjaGFuZ2UpOwoKICAgIGV2ZW50QnVzLl9vZmYoImJlZm9yZXByaW50IiwgX2JvdW5kRXZlbnRzLmJlZm9yZVByaW50KTsKCiAgICBldmVudEJ1cy5fb2ZmKCJhZnRlcnByaW50IiwgX2JvdW5kRXZlbnRzLmFmdGVyUHJpbnQpOwoKICAgIGV2ZW50QnVzLl9vZmYoInBhZ2VyZW5kZXJlZCIsIHdlYlZpZXdlclBhZ2VSZW5kZXJlZCk7CgogICAgZXZlbnRCdXMuX29mZigidXBkYXRldmlld2FyZWEiLCB3ZWJWaWV3ZXJVcGRhdGVWaWV3YXJlYSk7CgogICAgZXZlbnRCdXMuX29mZigicGFnZWNoYW5naW5nIiwgd2ViVmlld2VyUGFnZUNoYW5naW5nKTsKCiAgICBldmVudEJ1cy5fb2ZmKCJzY2FsZWNoYW5naW5nIiwgd2ViVmlld2VyU2NhbGVDaGFuZ2luZyk7CgogICAgZXZlbnRCdXMuX29mZigicm90YXRpb25jaGFuZ2luZyIsIHdlYlZpZXdlclJvdGF0aW9uQ2hhbmdpbmcpOwoKICAgIGV2ZW50QnVzLl9vZmYoInNpZGViYXJ2aWV3Y2hhbmdlZCIsIHdlYlZpZXdlclNpZGViYXJWaWV3Q2hhbmdlZCk7CgogICAgZXZlbnRCdXMuX29mZigicGFnZW1vZGUiLCB3ZWJWaWV3ZXJQYWdlTW9kZSk7CgogICAgZXZlbnRCdXMuX29mZigibmFtZWRhY3Rpb24iLCB3ZWJWaWV3ZXJOYW1lZEFjdGlvbik7CgogICAgZXZlbnRCdXMuX29mZigicHJlc2VudGF0aW9ubW9kZWNoYW5nZWQiLCB3ZWJWaWV3ZXJQcmVzZW50YXRpb25Nb2RlQ2hhbmdlZCk7CgogICAgZXZlbnRCdXMuX29mZigicHJlc2VudGF0aW9ubW9kZSIsIHdlYlZpZXdlclByZXNlbnRhdGlvbk1vZGUpOwoKICAgIGV2ZW50QnVzLl9vZmYoInByaW50Iiwgd2ViVmlld2VyUHJpbnQpOwoKICAgIGV2ZW50QnVzLl9vZmYoImRvd25sb2FkIiwgd2ViVmlld2VyRG93bmxvYWQpOwoKICAgIGV2ZW50QnVzLl9vZmYoImZpcnN0cGFnZSIsIHdlYlZpZXdlckZpcnN0UGFnZSk7CgogICAgZXZlbnRCdXMuX29mZigibGFzdHBhZ2UiLCB3ZWJWaWV3ZXJMYXN0UGFnZSk7CgogICAgZXZlbnRCdXMuX29mZigibmV4dHBhZ2UiLCB3ZWJWaWV3ZXJOZXh0UGFnZSk7CgogICAgZXZlbnRCdXMuX29mZigicHJldmlvdXNwYWdlIiwgd2ViVmlld2VyUHJldmlvdXNQYWdlKTsKCiAgICBldmVudEJ1cy5fb2ZmKCJ6b29taW4iLCB3ZWJWaWV3ZXJab29tSW4pOwoKICAgIGV2ZW50QnVzLl9vZmYoInpvb21vdXQiLCB3ZWJWaWV3ZXJab29tT3V0KTsKCiAgICBldmVudEJ1cy5fb2ZmKCJ6b29tcmVzZXQiLCB3ZWJWaWV3ZXJab29tUmVzZXQpOwoKICAgIGV2ZW50QnVzLl9vZmYoInBhZ2VudW1iZXJjaGFuZ2VkIiwgd2ViVmlld2VyUGFnZU51bWJlckNoYW5nZWQpOwoKICAgIGV2ZW50QnVzLl9vZmYoInNjYWxlY2hhbmdlZCIsIHdlYlZpZXdlclNjYWxlQ2hhbmdlZCk7CgogICAgZXZlbnRCdXMuX29mZigicm90YXRlY3ciLCB3ZWJWaWV3ZXJSb3RhdGVDdyk7CgogICAgZXZlbnRCdXMuX29mZigicm90YXRlY2N3Iiwgd2ViVmlld2VyUm90YXRlQ2N3KTsKCiAgICBldmVudEJ1cy5fb2ZmKCJzd2l0Y2hzY3JvbGxtb2RlIiwgd2ViVmlld2VyU3dpdGNoU2Nyb2xsTW9kZSk7CgogICAgZXZlbnRCdXMuX29mZigic2Nyb2xsbW9kZWNoYW5nZWQiLCB3ZWJWaWV3ZXJTY3JvbGxNb2RlQ2hhbmdlZCk7CgogICAgZXZlbnRCdXMuX29mZigic3dpdGNoc3ByZWFkbW9kZSIsIHdlYlZpZXdlclN3aXRjaFNwcmVhZE1vZGUpOwoKICAgIGV2ZW50QnVzLl9vZmYoInNwcmVhZG1vZGVjaGFuZ2VkIiwgd2ViVmlld2VyU3ByZWFkTW9kZUNoYW5nZWQpOwoKICAgIGV2ZW50QnVzLl9vZmYoImRvY3VtZW50cHJvcGVydGllcyIsIHdlYlZpZXdlckRvY3VtZW50UHJvcGVydGllcyk7CgogICAgZXZlbnRCdXMuX29mZigiZmluZCIsIHdlYlZpZXdlckZpbmQpOwoKICAgIGV2ZW50QnVzLl9vZmYoImZpbmRmcm9tdXJsaGFzaCIsIHdlYlZpZXdlckZpbmRGcm9tVXJsSGFzaCk7CgogICAgZXZlbnRCdXMuX29mZigidXBkYXRlZmluZG1hdGNoZXNjb3VudCIsIHdlYlZpZXdlclVwZGF0ZUZpbmRNYXRjaGVzQ291bnQpOwoKICAgIGV2ZW50QnVzLl9vZmYoInVwZGF0ZWZpbmRjb250cm9sc3RhdGUiLCB3ZWJWaWV3ZXJVcGRhdGVGaW5kQ29udHJvbFN0YXRlKTsKCiAgICBldmVudEJ1cy5fb2ZmKCJmaWxlaW5wdXRjaGFuZ2UiLCB3ZWJWaWV3ZXJGaWxlSW5wdXRDaGFuZ2UpOwoKICAgIGV2ZW50QnVzLl9vZmYoIm9wZW5maWxlIiwgd2ViVmlld2VyT3BlbkZpbGUpOwoKICAgIF9ib3VuZEV2ZW50cy5iZWZvcmVQcmludCA9IG51bGw7CiAgICBfYm91bmRFdmVudHMuYWZ0ZXJQcmludCA9IG51bGw7CiAgfSwKICB1bmJpbmRXaW5kb3dFdmVudHM6IGZ1bmN0aW9uIHVuYmluZFdpbmRvd0V2ZW50cygpIHsKICAgIHZhciBfYm91bmRFdmVudHMgPSB0aGlzLl9ib3VuZEV2ZW50czsKICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJ2aXNpYmlsaXR5Y2hhbmdlIiwgd2ViVmlld2VyVmlzaWJpbGl0eUNoYW5nZSk7CiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigid2hlZWwiLCB3ZWJWaWV3ZXJXaGVlbCwgewogICAgICBwYXNzaXZlOiBmYWxzZQogICAgfSk7CiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigiY2xpY2siLCB3ZWJWaWV3ZXJDbGljayk7CiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsIHdlYlZpZXdlcktleURvd24pOwogICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInJlc2l6ZSIsIF9ib3VuZEV2ZW50cy53aW5kb3dSZXNpemUpOwogICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoImhhc2hjaGFuZ2UiLCBfYm91bmRFdmVudHMud2luZG93SGFzaENoYW5nZSk7CiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigiYmVmb3JlcHJpbnQiLCBfYm91bmRFdmVudHMud2luZG93QmVmb3JlUHJpbnQpOwogICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoImFmdGVycHJpbnQiLCBfYm91bmRFdmVudHMud2luZG93QWZ0ZXJQcmludCk7CiAgICBfYm91bmRFdmVudHMud2luZG93UmVzaXplID0gbnVsbDsKICAgIF9ib3VuZEV2ZW50cy53aW5kb3dIYXNoQ2hhbmdlID0gbnVsbDsKICAgIF9ib3VuZEV2ZW50cy53aW5kb3dCZWZvcmVQcmludCA9IG51bGw7CiAgICBfYm91bmRFdmVudHMud2luZG93QWZ0ZXJQcmludCA9IG51bGw7CiAgfQp9OwpleHBvcnRzLlBERlZpZXdlckFwcGxpY2F0aW9uID0gUERGVmlld2VyQXBwbGljYXRpb247CnZhciB2YWxpZGF0ZUZpbGVVUkw7CnsKICB2YXIgSE9TVEVEX1ZJRVdFUl9PUklHSU5TID0gWyJudWxsIiwgImh0dHA6Ly9tb3ppbGxhLmdpdGh1Yi5pbyIsICJodHRwczovL21vemlsbGEuZ2l0aHViLmlvIl07CgogIHZhbGlkYXRlRmlsZVVSTCA9IGZ1bmN0aW9uIHZhbGlkYXRlRmlsZVVSTChmaWxlKSB7CiAgICBpZiAoZmlsZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB0cnkgewogICAgICB2YXIgdmlld2VyT3JpZ2luID0gbmV3IFVSTCh3aW5kb3cubG9jYXRpb24uaHJlZikub3JpZ2luIHx8ICJudWxsIjsKCiAgICAgIGlmIChIT1NURURfVklFV0VSX09SSUdJTlMuaW5jbHVkZXModmlld2VyT3JpZ2luKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIF9VUkwgPSBuZXcgVVJMKGZpbGUsIHdpbmRvdy5sb2NhdGlvbi5ocmVmKSwKICAgICAgICAgIG9yaWdpbiA9IF9VUkwub3JpZ2luLAogICAgICAgICAgcHJvdG9jb2wgPSBfVVJMLnByb3RvY29sOwoKICAgICAgaWYgKG9yaWdpbiAhPT0gdmlld2VyT3JpZ2luICYmIHByb3RvY29sICE9PSAiYmxvYjoiKSB7CiAgICAgICAgLy8gdGhyb3cgbmV3IEVycm9yKCJmaWxlIG9yaWdpbiBkb2VzIG5vdCBtYXRjaCB2aWV3ZXIncyIpOwogICAgICB9CiAgICB9IGNhdGNoIChleCkgewogICAgICB2YXIgbWVzc2FnZSA9IGV4ICYmIGV4Lm1lc3NhZ2U7CiAgICAgIFBERlZpZXdlckFwcGxpY2F0aW9uLmwxMG4uZ2V0KCJsb2FkaW5nX2Vycm9yIiwgbnVsbCwgIkFuIGVycm9yIG9jY3VycmVkIHdoaWxlIGxvYWRpbmcgdGhlIFBERi4iKS50aGVuKGZ1bmN0aW9uIChsb2FkaW5nRXJyb3JNZXNzYWdlKSB7CiAgICAgICAgUERGVmlld2VyQXBwbGljYXRpb24uZXJyb3IobG9hZGluZ0Vycm9yTWVzc2FnZSwgewogICAgICAgICAgbWVzc2FnZTogbWVzc2FnZQogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgdGhyb3cgZXg7CiAgICB9CiAgfTsKfQoKZnVuY3Rpb24gbG9hZEZha2VXb3JrZXIoKSB7CiAgcmV0dXJuIF9sb2FkRmFrZVdvcmtlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9CgpmdW5jdGlvbiBfbG9hZEZha2VXb3JrZXIoKSB7CiAgX2xvYWRGYWtlV29ya2VyID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JbImRlZmF1bHQiXS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUxMygpIHsKICAgIHJldHVybiBfcmVnZW5lcmF0b3JbImRlZmF1bHQiXS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUxMyQoX2NvbnRleHQxMykgewogICAgICB3aGlsZSAoMSkgewogICAgICAgIHN3aXRjaCAoX2NvbnRleHQxMy5wcmV2ID0gX2NvbnRleHQxMy5uZXh0KSB7CiAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgIGlmICghX3BkZmpzTGliLkdsb2JhbFdvcmtlck9wdGlvbnMud29ya2VyU3JjKSB7CiAgICAgICAgICAgICAgX3BkZmpzTGliLkdsb2JhbFdvcmtlck9wdGlvbnMud29ya2VyU3JjID0gX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuZ2V0KCJ3b3JrZXJTcmMiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTMuYWJydXB0KCJyZXR1cm4iLCAoMCwgX3BkZmpzTGliLmxvYWRTY3JpcHQpKF9wZGZqc0xpYi5QREZXb3JrZXIuZ2V0V29ya2VyU3JjKCkpKTsKCiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMy5zdG9wKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCBfY2FsbGVlMTMpOwogIH0pKTsKICByZXR1cm4gX2xvYWRGYWtlV29ya2VyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn0KCmZ1bmN0aW9uIGxvYWRBbmRFbmFibGVQREZCdWcoZW5hYmxlZFRhYnMpIHsKICB2YXIgYXBwQ29uZmlnID0gUERGVmlld2VyQXBwbGljYXRpb24uYXBwQ29uZmlnOwogIHJldHVybiAoMCwgX3BkZmpzTGliLmxvYWRTY3JpcHQpKGFwcENvbmZpZy5kZWJ1Z2dlclNjcmlwdFBhdGgpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgUERGQnVnLmVuYWJsZShlbmFibGVkVGFicyk7CiAgICBQREZCdWcuaW5pdCh7CiAgICAgIE9QUzogX3BkZmpzTGliLk9QUwogICAgfSwgYXBwQ29uZmlnLm1haW5Db250YWluZXIpOwogIH0pOwp9CgpmdW5jdGlvbiB3ZWJWaWV3ZXJJbml0aWFsaXplZCgpIHsKICB2YXIgYXBwQ29uZmlnID0gUERGVmlld2VyQXBwbGljYXRpb24uYXBwQ29uZmlnOwogIHZhciBmaWxlOwogIHZhciBxdWVyeVN0cmluZyA9IGRvY3VtZW50LmxvY2F0aW9uLnNlYXJjaC5zdWJzdHJpbmcoMSk7CiAgdmFyIHBhcmFtcyA9ICgwLCBfdWlfdXRpbHMucGFyc2VRdWVyeVN0cmluZykocXVlcnlTdHJpbmcpOwogIGZpbGUgPSAiZmlsZSIgaW4gcGFyYW1zID8gcGFyYW1zLmZpbGUgOiBfYXBwX29wdGlvbnMuQXBwT3B0aW9ucy5nZXQoImRlZmF1bHRVcmwiKTsKICB2YWxpZGF0ZUZpbGVVUkwoZmlsZSk7CiAgdmFyIGZpbGVJbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgZmlsZUlucHV0LmlkID0gYXBwQ29uZmlnLm9wZW5GaWxlSW5wdXROYW1lOwogIGZpbGVJbnB1dC5jbGFzc05hbWUgPSAiZmlsZUlucHV0IjsKICBmaWxlSW5wdXQuc2V0QXR0cmlidXRlKCJ0eXBlIiwgImZpbGUiKTsKICBmaWxlSW5wdXQub25jb250ZXh0bWVudSA9IF91aV91dGlscy5ub0NvbnRleHRNZW51SGFuZGxlcjsKICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGZpbGVJbnB1dCk7CgogIGlmICghd2luZG93LkZpbGUgfHwgIXdpbmRvdy5GaWxlUmVhZGVyIHx8ICF3aW5kb3cuRmlsZUxpc3QgfHwgIXdpbmRvdy5CbG9iKSB7CiAgICBhcHBDb25maWcudG9vbGJhci5vcGVuRmlsZS5zZXRBdHRyaWJ1dGUoImhpZGRlbiIsICJ0cnVlIik7CiAgICBhcHBDb25maWcuc2Vjb25kYXJ5VG9vbGJhci5vcGVuRmlsZUJ1dHRvbi5zZXRBdHRyaWJ1dGUoImhpZGRlbiIsICJ0cnVlIik7CiAgfSBlbHNlIHsKICAgIGZpbGVJbnB1dC52YWx1ZSA9IG51bGw7CiAgfQoKICBmaWxlSW5wdXQuYWRkRXZlbnRMaXN0ZW5lcigiY2hhbmdlIiwgZnVuY3Rpb24gKGV2dCkgewogICAgdmFyIGZpbGVzID0gZXZ0LnRhcmdldC5maWxlczsKCiAgICBpZiAoIWZpbGVzIHx8IGZpbGVzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgUERGVmlld2VyQXBwbGljYXRpb24uZXZlbnRCdXMuZGlzcGF0Y2goImZpbGVpbnB1dGNoYW5nZSIsIHsKICAgICAgc291cmNlOiB0aGlzLAogICAgICBmaWxlSW5wdXQ6IGV2dC50YXJnZXQKICAgIH0pOwogIH0pOwogIGFwcENvbmZpZy5tYWluQ29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoImRyYWdvdmVyIiwgZnVuY3Rpb24gKGV2dCkgewogICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICBldnQuZGF0YVRyYW5zZmVyLmRyb3BFZmZlY3QgPSAibW92ZSI7CiAgfSk7CiAgYXBwQ29uZmlnLm1haW5Db250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcigiZHJvcCIsIGZ1bmN0aW9uIChldnQpIHsKICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpOwogICAgdmFyIGZpbGVzID0gZXZ0LmRhdGFUcmFuc2Zlci5maWxlczsKCiAgICBpZiAoIWZpbGVzIHx8IGZpbGVzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgUERGVmlld2VyQXBwbGljYXRpb24uZXZlbnRCdXMuZGlzcGF0Y2goImZpbGVpbnB1dGNoYW5nZSIsIHsKICAgICAgc291cmNlOiB0aGlzLAogICAgICBmaWxlSW5wdXQ6IGV2dC5kYXRhVHJhbnNmZXIKICAgIH0pOwogIH0pOwoKICBpZiAoIVBERlZpZXdlckFwcGxpY2F0aW9uLnN1cHBvcnRzRG9jdW1lbnRGb250cykgewogICAgX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuc2V0KCJkaXNhYmxlRm9udEZhY2UiLCB0cnVlKTsKCiAgICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5sMTBuLmdldCgid2ViX2ZvbnRzX2Rpc2FibGVkIiwgbnVsbCwgIldlYiBmb250cyBhcmUgZGlzYWJsZWQ6IHVuYWJsZSB0byB1c2UgZW1iZWRkZWQgUERGIGZvbnRzLiIpLnRoZW4oZnVuY3Rpb24gKG1zZykgewogICAgICBjb25zb2xlLndhcm4obXNnKTsKICAgIH0pOwogIH0KCiAgaWYgKCFQREZWaWV3ZXJBcHBsaWNhdGlvbi5zdXBwb3J0c1ByaW50aW5nKSB7CiAgICBhcHBDb25maWcudG9vbGJhci5wcmludC5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsKICAgIGFwcENvbmZpZy5zZWNvbmRhcnlUb29sYmFyLnByaW50QnV0dG9uLmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOwogIH0KCiAgaWYgKCFQREZWaWV3ZXJBcHBsaWNhdGlvbi5zdXBwb3J0c0Z1bGxzY3JlZW4pIHsKICAgIGFwcENvbmZpZy50b29sYmFyLnByZXNlbnRhdGlvbk1vZGVCdXR0b24uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7CiAgICBhcHBDb25maWcuc2Vjb25kYXJ5VG9vbGJhci5wcmVzZW50YXRpb25Nb2RlQnV0dG9uLmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOwogIH0KCiAgaWYgKFBERlZpZXdlckFwcGxpY2F0aW9uLnN1cHBvcnRzSW50ZWdyYXRlZEZpbmQpIHsKICAgIGFwcENvbmZpZy50b29sYmFyLnZpZXdGaW5kLmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOwogIH0KCiAgYXBwQ29uZmlnLm1haW5Db250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcigidHJhbnNpdGlvbmVuZCIsIGZ1bmN0aW9uIChldnQpIHsKICAgIGlmIChldnQudGFyZ2V0ID09PSB0aGlzKSB7CiAgICAgIFBERlZpZXdlckFwcGxpY2F0aW9uLmV2ZW50QnVzLmRpc3BhdGNoKCJyZXNpemUiLCB7CiAgICAgICAgc291cmNlOiB0aGlzCiAgICAgIH0pOwogICAgfQogIH0sIHRydWUpOwoKICB0cnkgewogICAgd2ViVmlld2VyT3BlbkZpbGVWaWFVUkwoZmlsZSk7CiAgfSBjYXRjaCAocmVhc29uKSB7CiAgICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5sMTBuLmdldCgibG9hZGluZ19lcnJvciIsIG51bGwsICJBbiBlcnJvciBvY2N1cnJlZCB3aGlsZSBsb2FkaW5nIHRoZSBQREYuIikudGhlbihmdW5jdGlvbiAobXNnKSB7CiAgICAgIFBERlZpZXdlckFwcGxpY2F0aW9uLmVycm9yKG1zZywgcmVhc29uKTsKICAgIH0pOwogIH0KfQoKdmFyIHdlYlZpZXdlck9wZW5GaWxlVmlhVVJMOwp7CiAgd2ViVmlld2VyT3BlbkZpbGVWaWFVUkwgPSBmdW5jdGlvbiB3ZWJWaWV3ZXJPcGVuRmlsZVZpYVVSTChmaWxlKSB7CiAgICBpZiAoZmlsZSAmJiBmaWxlLmxhc3RJbmRleE9mKCJmaWxlOiIsIDApID09PSAwKSB7CiAgICAgIFBERlZpZXdlckFwcGxpY2F0aW9uLnNldFRpdGxlVXNpbmdVcmwoZmlsZSk7CiAgICAgIHZhciB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKCiAgICAgIHhoci5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgUERGVmlld2VyQXBwbGljYXRpb24ub3BlbihuZXcgVWludDhBcnJheSh4aHIucmVzcG9uc2UpKTsKICAgICAgfTsKCiAgICAgIHhoci5vcGVuKCJHRVQiLCBmaWxlKTsKICAgICAgeGhyLnJlc3BvbnNlVHlwZSA9ICJhcnJheWJ1ZmZlciI7CiAgICAgIHhoci5zZW5kKCk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoZmlsZSkgewogICAgICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5vcGVuKGZpbGUpOwogICAgfQogIH07Cn0KCmZ1bmN0aW9uIHdlYlZpZXdlclJlc2V0UGVybWlzc2lvbnMoKSB7CiAgdmFyIGFwcENvbmZpZyA9IFBERlZpZXdlckFwcGxpY2F0aW9uLmFwcENvbmZpZzsKCiAgaWYgKCFhcHBDb25maWcpIHsKICAgIHJldHVybjsKICB9CgogIGFwcENvbmZpZy52aWV3ZXJDb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZShFTkFCTEVfUEVSTUlTU0lPTlNfQ0xBU1MpOwp9CgpmdW5jdGlvbiB3ZWJWaWV3ZXJQYWdlUmVuZGVyZWQoZXZ0KSB7CiAgdmFyIHBhZ2VOdW1iZXIgPSBldnQucGFnZU51bWJlcjsKICB2YXIgcGFnZUluZGV4ID0gcGFnZU51bWJlciAtIDE7CiAgdmFyIHBhZ2VWaWV3ID0gUERGVmlld2VyQXBwbGljYXRpb24ucGRmVmlld2VyLmdldFBhZ2VWaWV3KHBhZ2VJbmRleCk7CgogIGlmIChwYWdlTnVtYmVyID09PSBQREZWaWV3ZXJBcHBsaWNhdGlvbi5wYWdlKSB7CiAgICBQREZWaWV3ZXJBcHBsaWNhdGlvbi50b29sYmFyLnVwZGF0ZUxvYWRpbmdJbmRpY2F0b3JTdGF0ZShmYWxzZSk7CiAgfQoKICBpZiAoIXBhZ2VWaWV3KSB7CiAgICByZXR1cm47CiAgfQoKICBpZiAoUERGVmlld2VyQXBwbGljYXRpb24ucGRmU2lkZWJhci5pc1RodW1ibmFpbFZpZXdWaXNpYmxlKSB7CiAgICB2YXIgdGh1bWJuYWlsVmlldyA9IFBERlZpZXdlckFwcGxpY2F0aW9uLnBkZlRodW1ibmFpbFZpZXdlci5nZXRUaHVtYm5haWwocGFnZUluZGV4KTsKICAgIHRodW1ibmFpbFZpZXcuc2V0SW1hZ2UocGFnZVZpZXcpOwogIH0KCiAgaWYgKHR5cGVvZiBTdGF0cyAhPT0gInVuZGVmaW5lZCIgJiYgU3RhdHMuZW5hYmxlZCAmJiBwYWdlVmlldy5zdGF0cykgewogICAgU3RhdHMuYWRkKHBhZ2VOdW1iZXIsIHBhZ2VWaWV3LnN0YXRzKTsKICB9CgogIGlmIChwYWdlVmlldy5lcnJvcikgewogICAgUERGVmlld2VyQXBwbGljYXRpb24ubDEwbi5nZXQoInJlbmRlcmluZ19lcnJvciIsIG51bGwsICJBbiBlcnJvciBvY2N1cnJlZCB3aGlsZSByZW5kZXJpbmcgdGhlIHBhZ2UuIikudGhlbihmdW5jdGlvbiAobXNnKSB7CiAgICAgIFBERlZpZXdlckFwcGxpY2F0aW9uLmVycm9yKG1zZywgcGFnZVZpZXcuZXJyb3IpOwogICAgfSk7CiAgfQoKICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5leHRlcm5hbFNlcnZpY2VzLnJlcG9ydFRlbGVtZXRyeSh7CiAgICB0eXBlOiAicGFnZUluZm8iLAogICAgdGltZXN0YW1wOiBldnQudGltZXN0YW1wCiAgfSk7CiAgUERGVmlld2VyQXBwbGljYXRpb24ucGRmRG9jdW1lbnQuZ2V0U3RhdHMoKS50aGVuKGZ1bmN0aW9uIChzdGF0cykgewogICAgUERGVmlld2VyQXBwbGljYXRpb24uZXh0ZXJuYWxTZXJ2aWNlcy5yZXBvcnRUZWxlbWV0cnkoewogICAgICB0eXBlOiAiZG9jdW1lbnRTdGF0cyIsCiAgICAgIHN0YXRzOiBzdGF0cwogICAgfSk7CiAgfSk7Cn0KCmZ1bmN0aW9uIHdlYlZpZXdlclBhZ2VNb2RlKF9yZWY3KSB7CiAgdmFyIG1vZGUgPSBfcmVmNy5tb2RlOwogIHZhciB2aWV3OwoKICBzd2l0Y2ggKG1vZGUpIHsKICAgIGNhc2UgInRodW1icyI6CiAgICAgIHZpZXcgPSBfcGRmX3NpZGViYXIuU2lkZWJhclZpZXcuVEhVTUJTOwogICAgICBicmVhazsKCiAgICBjYXNlICJib29rbWFya3MiOgogICAgY2FzZSAib3V0bGluZSI6CiAgICAgIHZpZXcgPSBfcGRmX3NpZGViYXIuU2lkZWJhclZpZXcuT1VUTElORTsKICAgICAgYnJlYWs7CgogICAgY2FzZSAiYXR0YWNobWVudHMiOgogICAgICB2aWV3ID0gX3BkZl9zaWRlYmFyLlNpZGViYXJWaWV3LkFUVEFDSE1FTlRTOwogICAgICBicmVhazsKCiAgICBjYXNlICJub25lIjoKICAgICAgdmlldyA9IF9wZGZfc2lkZWJhci5TaWRlYmFyVmlldy5OT05FOwogICAgICBicmVhazsKCiAgICBkZWZhdWx0OgogICAgICBjb25zb2xlLmVycm9yKCdJbnZhbGlkICJwYWdlbW9kZSIgaGFzaCBwYXJhbWV0ZXI6ICcgKyBtb2RlKTsKICAgICAgcmV0dXJuOwogIH0KCiAgUERGVmlld2VyQXBwbGljYXRpb24ucGRmU2lkZWJhci5zd2l0Y2hWaWV3KHZpZXcsIHRydWUpOwp9CgpmdW5jdGlvbiB3ZWJWaWV3ZXJOYW1lZEFjdGlvbihldnQpIHsKICB2YXIgYWN0aW9uID0gZXZ0LmFjdGlvbjsKCiAgc3dpdGNoIChhY3Rpb24pIHsKICAgIGNhc2UgIkdvVG9QYWdlIjoKICAgICAgUERGVmlld2VyQXBwbGljYXRpb24uYXBwQ29uZmlnLnRvb2xiYXIucGFnZU51bWJlci5zZWxlY3QoKTsKICAgICAgYnJlYWs7CgogICAgY2FzZSAiRmluZCI6CiAgICAgIGlmICghUERGVmlld2VyQXBwbGljYXRpb24uc3VwcG9ydHNJbnRlZ3JhdGVkRmluZCkgewogICAgICAgIFBERlZpZXdlckFwcGxpY2F0aW9uLmZpbmRCYXIudG9nZ2xlKCk7CiAgICAgIH0KCiAgICAgIGJyZWFrOwogIH0KfQoKZnVuY3Rpb24gd2ViVmlld2VyUHJlc2VudGF0aW9uTW9kZUNoYW5nZWQoX3JlZjgpIHsKICB2YXIgYWN0aXZlID0gX3JlZjguYWN0aXZlLAogICAgICBzd2l0Y2hJblByb2dyZXNzID0gX3JlZjguc3dpdGNoSW5Qcm9ncmVzczsKICB2YXIgc3RhdGUgPSBfdWlfdXRpbHMuUHJlc2VudGF0aW9uTW9kZVN0YXRlLk5PUk1BTDsKCiAgaWYgKHN3aXRjaEluUHJvZ3Jlc3MpIHsKICAgIHN0YXRlID0gX3VpX3V0aWxzLlByZXNlbnRhdGlvbk1vZGVTdGF0ZS5DSEFOR0lORzsKICB9IGVsc2UgaWYgKGFjdGl2ZSkgewogICAgc3RhdGUgPSBfdWlfdXRpbHMuUHJlc2VudGF0aW9uTW9kZVN0YXRlLkZVTExTQ1JFRU47CiAgfQoKICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5wZGZWaWV3ZXIucHJlc2VudGF0aW9uTW9kZVN0YXRlID0gc3RhdGU7Cn0KCmZ1bmN0aW9uIHdlYlZpZXdlclNpZGViYXJWaWV3Q2hhbmdlZChldnQpIHsKICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5wZGZSZW5kZXJpbmdRdWV1ZS5pc1RodW1ibmFpbFZpZXdFbmFibGVkID0gUERGVmlld2VyQXBwbGljYXRpb24ucGRmU2lkZWJhci5pc1RodW1ibmFpbFZpZXdWaXNpYmxlOwogIHZhciBzdG9yZSA9IFBERlZpZXdlckFwcGxpY2F0aW9uLnN0b3JlOwoKICBpZiAoc3RvcmUgJiYgUERGVmlld2VyQXBwbGljYXRpb24uaXNJbml0aWFsVmlld1NldCkgewogICAgc3RvcmUuc2V0KCJzaWRlYmFyVmlldyIsIGV2dC52aWV3KVsiY2F0Y2giXShmdW5jdGlvbiAoKSB7fSk7CiAgfQp9CgpmdW5jdGlvbiB3ZWJWaWV3ZXJVcGRhdGVWaWV3YXJlYShldnQpIHsKICB2YXIgbG9jYXRpb24gPSBldnQubG9jYXRpb24sCiAgICAgIHN0b3JlID0gUERGVmlld2VyQXBwbGljYXRpb24uc3RvcmU7CgogIGlmIChzdG9yZSAmJiBQREZWaWV3ZXJBcHBsaWNhdGlvbi5pc0luaXRpYWxWaWV3U2V0KSB7CiAgICBzdG9yZS5zZXRNdWx0aXBsZSh7CiAgICAgIHBhZ2U6IGxvY2F0aW9uLnBhZ2VOdW1iZXIsCiAgICAgIHpvb206IGxvY2F0aW9uLnNjYWxlLAogICAgICBzY3JvbGxMZWZ0OiBsb2NhdGlvbi5sZWZ0LAogICAgICBzY3JvbGxUb3A6IGxvY2F0aW9uLnRvcCwKICAgICAgcm90YXRpb246IGxvY2F0aW9uLnJvdGF0aW9uCiAgICB9KVsiY2F0Y2giXShmdW5jdGlvbiAoKSB7fSk7CiAgfQoKICB2YXIgaHJlZiA9IFBERlZpZXdlckFwcGxpY2F0aW9uLnBkZkxpbmtTZXJ2aWNlLmdldEFuY2hvclVybChsb2NhdGlvbi5wZGZPcGVuUGFyYW1zKTsKICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5hcHBDb25maWcudG9vbGJhci52aWV3Qm9va21hcmsuaHJlZiA9IGhyZWY7CiAgUERGVmlld2VyQXBwbGljYXRpb24uYXBwQ29uZmlnLnNlY29uZGFyeVRvb2xiYXIudmlld0Jvb2ttYXJrQnV0dG9uLmhyZWYgPSBocmVmOwogIHZhciBjdXJyZW50UGFnZSA9IFBERlZpZXdlckFwcGxpY2F0aW9uLnBkZlZpZXdlci5nZXRQYWdlVmlldyhQREZWaWV3ZXJBcHBsaWNhdGlvbi5wYWdlIC0gMSk7CiAgdmFyIGxvYWRpbmcgPSBjdXJyZW50UGFnZS5yZW5kZXJpbmdTdGF0ZSAhPT0gX3BkZl9yZW5kZXJpbmdfcXVldWUuUmVuZGVyaW5nU3RhdGVzLkZJTklTSEVEOwogIFBERlZpZXdlckFwcGxpY2F0aW9uLnRvb2xiYXIudXBkYXRlTG9hZGluZ0luZGljYXRvclN0YXRlKGxvYWRpbmcpOwp9CgpmdW5jdGlvbiB3ZWJWaWV3ZXJTY3JvbGxNb2RlQ2hhbmdlZChldnQpIHsKICB2YXIgc3RvcmUgPSBQREZWaWV3ZXJBcHBsaWNhdGlvbi5zdG9yZTsKCiAgaWYgKHN0b3JlICYmIFBERlZpZXdlckFwcGxpY2F0aW9uLmlzSW5pdGlhbFZpZXdTZXQpIHsKICAgIHN0b3JlLnNldCgic2Nyb2xsTW9kZSIsIGV2dC5tb2RlKVsiY2F0Y2giXShmdW5jdGlvbiAoKSB7fSk7CiAgfQp9CgpmdW5jdGlvbiB3ZWJWaWV3ZXJTcHJlYWRNb2RlQ2hhbmdlZChldnQpIHsKICB2YXIgc3RvcmUgPSBQREZWaWV3ZXJBcHBsaWNhdGlvbi5zdG9yZTsKCiAgaWYgKHN0b3JlICYmIFBERlZpZXdlckFwcGxpY2F0aW9uLmlzSW5pdGlhbFZpZXdTZXQpIHsKICAgIHN0b3JlLnNldCgic3ByZWFkTW9kZSIsIGV2dC5tb2RlKVsiY2F0Y2giXShmdW5jdGlvbiAoKSB7fSk7CiAgfQp9CgpmdW5jdGlvbiB3ZWJWaWV3ZXJSZXNpemUoKSB7CiAgdmFyIHBkZkRvY3VtZW50ID0gUERGVmlld2VyQXBwbGljYXRpb24ucGRmRG9jdW1lbnQsCiAgICAgIHBkZlZpZXdlciA9IFBERlZpZXdlckFwcGxpY2F0aW9uLnBkZlZpZXdlcjsKCiAgaWYgKCFwZGZEb2N1bWVudCkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIGN1cnJlbnRTY2FsZVZhbHVlID0gcGRmVmlld2VyLmN1cnJlbnRTY2FsZVZhbHVlOwoKICBpZiAoY3VycmVudFNjYWxlVmFsdWUgPT09ICJhdXRvIiB8fCBjdXJyZW50U2NhbGVWYWx1ZSA9PT0gInBhZ2UtZml0IiB8fCBjdXJyZW50U2NhbGVWYWx1ZSA9PT0gInBhZ2Utd2lkdGgiKSB7CiAgICBwZGZWaWV3ZXIuY3VycmVudFNjYWxlVmFsdWUgPSBjdXJyZW50U2NhbGVWYWx1ZTsKICB9CgogIHBkZlZpZXdlci51cGRhdGUoKTsKfQoKZnVuY3Rpb24gd2ViVmlld2VySGFzaGNoYW5nZShldnQpIHsKICB2YXIgaGFzaCA9IGV2dC5oYXNoOwoKICBpZiAoIWhhc2gpIHsKICAgIHJldHVybjsKICB9CgogIGlmICghUERGVmlld2VyQXBwbGljYXRpb24uaXNJbml0aWFsVmlld1NldCkgewogICAgUERGVmlld2VyQXBwbGljYXRpb24uaW5pdGlhbEJvb2ttYXJrID0gaGFzaDsKICB9IGVsc2UgaWYgKCFQREZWaWV3ZXJBcHBsaWNhdGlvbi5wZGZIaXN0b3J5LnBvcFN0YXRlSW5Qcm9ncmVzcykgewogICAgUERGVmlld2VyQXBwbGljYXRpb24ucGRmTGlua1NlcnZpY2Uuc2V0SGFzaChoYXNoKTsKICB9Cn0KCnZhciB3ZWJWaWV3ZXJGaWxlSW5wdXRDaGFuZ2UsIHdlYlZpZXdlck9wZW5GaWxlOwp7CiAgd2ViVmlld2VyRmlsZUlucHV0Q2hhbmdlID0gZnVuY3Rpb24gd2ViVmlld2VyRmlsZUlucHV0Q2hhbmdlKGV2dCkgewogICAgaWYgKFBERlZpZXdlckFwcGxpY2F0aW9uLnBkZlZpZXdlciAmJiBQREZWaWV3ZXJBcHBsaWNhdGlvbi5wZGZWaWV3ZXIuaXNJblByZXNlbnRhdGlvbk1vZGUpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBmaWxlID0gZXZ0LmZpbGVJbnB1dC5maWxlc1swXTsKCiAgICBpZiAoIV9hcHBfb3B0aW9ucy5BcHBPcHRpb25zLmdldCgiZGlzYWJsZUNyZWF0ZU9iamVjdFVSTCIpKSB7CiAgICAgIHZhciB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGZpbGUpOwoKICAgICAgaWYgKGZpbGUubmFtZSkgewogICAgICAgIHVybCA9IHsKICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgb3JpZ2luYWxVcmw6IGZpbGUubmFtZQogICAgICAgIH07CiAgICAgIH0KCiAgICAgIFBERlZpZXdlckFwcGxpY2F0aW9uLm9wZW4odXJsKTsKICAgIH0gZWxzZSB7CiAgICAgIFBERlZpZXdlckFwcGxpY2F0aW9uLnNldFRpdGxlVXNpbmdVcmwoZmlsZS5uYW1lKTsKICAgICAgdmFyIGZpbGVSZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpOwoKICAgICAgZmlsZVJlYWRlci5vbmxvYWQgPSBmdW5jdGlvbiB3ZWJWaWV3ZXJDaGFuZ2VGaWxlUmVhZGVyT25sb2FkKGV2ZW50KSB7CiAgICAgICAgdmFyIGJ1ZmZlciA9IGV2ZW50LnRhcmdldC5yZXN1bHQ7CiAgICAgICAgUERGVmlld2VyQXBwbGljYXRpb24ub3BlbihuZXcgVWludDhBcnJheShidWZmZXIpKTsKICAgICAgfTsKCiAgICAgIGZpbGVSZWFkZXIucmVhZEFzQXJyYXlCdWZmZXIoZmlsZSk7CiAgICB9CgogICAgdmFyIGFwcENvbmZpZyA9IFBERlZpZXdlckFwcGxpY2F0aW9uLmFwcENvbmZpZzsKICAgIGFwcENvbmZpZy50b29sYmFyLnZpZXdCb29rbWFyay5zZXRBdHRyaWJ1dGUoImhpZGRlbiIsICJ0cnVlIik7CiAgICBhcHBDb25maWcuc2Vjb25kYXJ5VG9vbGJhci52aWV3Qm9va21hcmtCdXR0b24uc2V0QXR0cmlidXRlKCJoaWRkZW4iLCAidHJ1ZSIpOwogICAgYXBwQ29uZmlnLnRvb2xiYXIuZG93bmxvYWQuc2V0QXR0cmlidXRlKCJoaWRkZW4iLCAidHJ1ZSIpOwogICAgYXBwQ29uZmlnLnNlY29uZGFyeVRvb2xiYXIuZG93bmxvYWRCdXR0b24uc2V0QXR0cmlidXRlKCJoaWRkZW4iLCAidHJ1ZSIpOwogIH07CgogIHdlYlZpZXdlck9wZW5GaWxlID0gZnVuY3Rpb24gd2ViVmlld2VyT3BlbkZpbGUoZXZ0KSB7CiAgICB2YXIgb3BlbkZpbGVJbnB1dE5hbWUgPSBQREZWaWV3ZXJBcHBsaWNhdGlvbi5hcHBDb25maWcub3BlbkZpbGVJbnB1dE5hbWU7CiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChvcGVuRmlsZUlucHV0TmFtZSkuY2xpY2soKTsKICB9Owp9CgpmdW5jdGlvbiB3ZWJWaWV3ZXJQcmVzZW50YXRpb25Nb2RlKCkgewogIFBERlZpZXdlckFwcGxpY2F0aW9uLnJlcXVlc3RQcmVzZW50YXRpb25Nb2RlKCk7Cn0KCmZ1bmN0aW9uIHdlYlZpZXdlclByaW50KCkgewogIHdpbmRvdy5wcmludCgpOwp9CgpmdW5jdGlvbiB3ZWJWaWV3ZXJEb3dubG9hZCgpIHsKICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5kb3dubG9hZCgpOwp9CgpmdW5jdGlvbiB3ZWJWaWV3ZXJGaXJzdFBhZ2UoKSB7CiAgaWYgKFBERlZpZXdlckFwcGxpY2F0aW9uLnBkZkRvY3VtZW50KSB7CiAgICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5wYWdlID0gMTsKICB9Cn0KCmZ1bmN0aW9uIHdlYlZpZXdlckxhc3RQYWdlKCkgewogIGlmIChQREZWaWV3ZXJBcHBsaWNhdGlvbi5wZGZEb2N1bWVudCkgewogICAgUERGVmlld2VyQXBwbGljYXRpb24ucGFnZSA9IFBERlZpZXdlckFwcGxpY2F0aW9uLnBhZ2VzQ291bnQ7CiAgfQp9CgpmdW5jdGlvbiB3ZWJWaWV3ZXJOZXh0UGFnZSgpIHsKICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5wYWdlKys7Cn0KCmZ1bmN0aW9uIHdlYlZpZXdlclByZXZpb3VzUGFnZSgpIHsKICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5wYWdlLS07Cn0KCmZ1bmN0aW9uIHdlYlZpZXdlclpvb21JbigpIHsKICBQREZWaWV3ZXJBcHBsaWNhdGlvbi56b29tSW4oKTsKfQoKZnVuY3Rpb24gd2ViVmlld2VyWm9vbU91dCgpIHsKICBQREZWaWV3ZXJBcHBsaWNhdGlvbi56b29tT3V0KCk7Cn0KCmZ1bmN0aW9uIHdlYlZpZXdlclpvb21SZXNldCgpIHsKICBQREZWaWV3ZXJBcHBsaWNhdGlvbi56b29tUmVzZXQoKTsKfQoKZnVuY3Rpb24gd2ViVmlld2VyUGFnZU51bWJlckNoYW5nZWQoZXZ0KSB7CiAgdmFyIHBkZlZpZXdlciA9IFBERlZpZXdlckFwcGxpY2F0aW9uLnBkZlZpZXdlcjsKCiAgaWYgKGV2dC52YWx1ZSAhPT0gIiIpIHsKICAgIHBkZlZpZXdlci5jdXJyZW50UGFnZUxhYmVsID0gZXZ0LnZhbHVlOwogIH0KCiAgaWYgKGV2dC52YWx1ZSAhPT0gcGRmVmlld2VyLmN1cnJlbnRQYWdlTnVtYmVyLnRvU3RyaW5nKCkgJiYgZXZ0LnZhbHVlICE9PSBwZGZWaWV3ZXIuY3VycmVudFBhZ2VMYWJlbCkgewogICAgUERGVmlld2VyQXBwbGljYXRpb24udG9vbGJhci5zZXRQYWdlTnVtYmVyKHBkZlZpZXdlci5jdXJyZW50UGFnZU51bWJlciwgcGRmVmlld2VyLmN1cnJlbnRQYWdlTGFiZWwpOwogIH0KfQoKZnVuY3Rpb24gd2ViVmlld2VyU2NhbGVDaGFuZ2VkKGV2dCkgewogIFBERlZpZXdlckFwcGxpY2F0aW9uLnBkZlZpZXdlci5jdXJyZW50U2NhbGVWYWx1ZSA9IGV2dC52YWx1ZTsKfQoKZnVuY3Rpb24gd2ViVmlld2VyUm90YXRlQ3coKSB7CiAgUERGVmlld2VyQXBwbGljYXRpb24ucm90YXRlUGFnZXMoOTApOwp9CgpmdW5jdGlvbiB3ZWJWaWV3ZXJSb3RhdGVDY3coKSB7CiAgUERGVmlld2VyQXBwbGljYXRpb24ucm90YXRlUGFnZXMoLTkwKTsKfQoKZnVuY3Rpb24gd2ViVmlld2VyU3dpdGNoU2Nyb2xsTW9kZShldnQpIHsKICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5wZGZWaWV3ZXIuc2Nyb2xsTW9kZSA9IGV2dC5tb2RlOwp9CgpmdW5jdGlvbiB3ZWJWaWV3ZXJTd2l0Y2hTcHJlYWRNb2RlKGV2dCkgewogIFBERlZpZXdlckFwcGxpY2F0aW9uLnBkZlZpZXdlci5zcHJlYWRNb2RlID0gZXZ0Lm1vZGU7Cn0KCmZ1bmN0aW9uIHdlYlZpZXdlckRvY3VtZW50UHJvcGVydGllcygpIHsKICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5wZGZEb2N1bWVudFByb3BlcnRpZXMub3BlbigpOwp9CgpmdW5jdGlvbiB3ZWJWaWV3ZXJGaW5kKGV2dCkgewogIFBERlZpZXdlckFwcGxpY2F0aW9uLmZpbmRDb250cm9sbGVyLmV4ZWN1dGVDb21tYW5kKCJmaW5kIiArIGV2dC50eXBlLCB7CiAgICBxdWVyeTogZXZ0LnF1ZXJ5LAogICAgcGhyYXNlU2VhcmNoOiBldnQucGhyYXNlU2VhcmNoLAogICAgY2FzZVNlbnNpdGl2ZTogZXZ0LmNhc2VTZW5zaXRpdmUsCiAgICBlbnRpcmVXb3JkOiBldnQuZW50aXJlV29yZCwKICAgIGhpZ2hsaWdodEFsbDogZXZ0LmhpZ2hsaWdodEFsbCwKICAgIGZpbmRQcmV2aW91czogZXZ0LmZpbmRQcmV2aW91cwogIH0pOwp9CgpmdW5jdGlvbiB3ZWJWaWV3ZXJGaW5kRnJvbVVybEhhc2goZXZ0KSB7CiAgUERGVmlld2VyQXBwbGljYXRpb24uZmluZENvbnRyb2xsZXIuZXhlY3V0ZUNvbW1hbmQoImZpbmQiLCB7CiAgICBxdWVyeTogZXZ0LnF1ZXJ5LAogICAgcGhyYXNlU2VhcmNoOiBldnQucGhyYXNlU2VhcmNoLAogICAgY2FzZVNlbnNpdGl2ZTogZmFsc2UsCiAgICBlbnRpcmVXb3JkOiBmYWxzZSwKICAgIGhpZ2hsaWdodEFsbDogdHJ1ZSwKICAgIGZpbmRQcmV2aW91czogZmFsc2UKICB9KTsKfQoKZnVuY3Rpb24gd2ViVmlld2VyVXBkYXRlRmluZE1hdGNoZXNDb3VudChfcmVmOSkgewogIHZhciBtYXRjaGVzQ291bnQgPSBfcmVmOS5tYXRjaGVzQ291bnQ7CgogIGlmIChQREZWaWV3ZXJBcHBsaWNhdGlvbi5zdXBwb3J0c0ludGVncmF0ZWRGaW5kKSB7CiAgICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5leHRlcm5hbFNlcnZpY2VzLnVwZGF0ZUZpbmRNYXRjaGVzQ291bnQobWF0Y2hlc0NvdW50KTsKICB9IGVsc2UgewogICAgUERGVmlld2VyQXBwbGljYXRpb24uZmluZEJhci51cGRhdGVSZXN1bHRzQ291bnQobWF0Y2hlc0NvdW50KTsKICB9Cn0KCmZ1bmN0aW9uIHdlYlZpZXdlclVwZGF0ZUZpbmRDb250cm9sU3RhdGUoX3JlZjEwKSB7CiAgdmFyIHN0YXRlID0gX3JlZjEwLnN0YXRlLAogICAgICBwcmV2aW91cyA9IF9yZWYxMC5wcmV2aW91cywKICAgICAgbWF0Y2hlc0NvdW50ID0gX3JlZjEwLm1hdGNoZXNDb3VudDsKCiAgaWYgKFBERlZpZXdlckFwcGxpY2F0aW9uLnN1cHBvcnRzSW50ZWdyYXRlZEZpbmQpIHsKICAgIFBERlZpZXdlckFwcGxpY2F0aW9uLmV4dGVybmFsU2VydmljZXMudXBkYXRlRmluZENvbnRyb2xTdGF0ZSh7CiAgICAgIHJlc3VsdDogc3RhdGUsCiAgICAgIGZpbmRQcmV2aW91czogcHJldmlvdXMsCiAgICAgIG1hdGNoZXNDb3VudDogbWF0Y2hlc0NvdW50CiAgICB9KTsKICB9IGVsc2UgewogICAgUERGVmlld2VyQXBwbGljYXRpb24uZmluZEJhci51cGRhdGVVSVN0YXRlKHN0YXRlLCBwcmV2aW91cywgbWF0Y2hlc0NvdW50KTsKICB9Cn0KCmZ1bmN0aW9uIHdlYlZpZXdlclNjYWxlQ2hhbmdpbmcoZXZ0KSB7CiAgUERGVmlld2VyQXBwbGljYXRpb24udG9vbGJhci5zZXRQYWdlU2NhbGUoZXZ0LnByZXNldFZhbHVlLCBldnQuc2NhbGUpOwogIFBERlZpZXdlckFwcGxpY2F0aW9uLnBkZlZpZXdlci51cGRhdGUoKTsKfQoKZnVuY3Rpb24gd2ViVmlld2VyUm90YXRpb25DaGFuZ2luZyhldnQpIHsKICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5wZGZUaHVtYm5haWxWaWV3ZXIucGFnZXNSb3RhdGlvbiA9IGV2dC5wYWdlc1JvdGF0aW9uOwogIFBERlZpZXdlckFwcGxpY2F0aW9uLmZvcmNlUmVuZGVyaW5nKCk7CiAgUERGVmlld2VyQXBwbGljYXRpb24ucGRmVmlld2VyLmN1cnJlbnRQYWdlTnVtYmVyID0gZXZ0LnBhZ2VOdW1iZXI7Cn0KCmZ1bmN0aW9uIHdlYlZpZXdlclBhZ2VDaGFuZ2luZyhldnQpIHsKICB2YXIgcGFnZSA9IGV2dC5wYWdlTnVtYmVyOwogIFBERlZpZXdlckFwcGxpY2F0aW9uLnRvb2xiYXIuc2V0UGFnZU51bWJlcihwYWdlLCBldnQucGFnZUxhYmVsIHx8IG51bGwpOwogIFBERlZpZXdlckFwcGxpY2F0aW9uLnNlY29uZGFyeVRvb2xiYXIuc2V0UGFnZU51bWJlcihwYWdlKTsKCiAgaWYgKFBERlZpZXdlckFwcGxpY2F0aW9uLnBkZlNpZGViYXIuaXNUaHVtYm5haWxWaWV3VmlzaWJsZSkgewogICAgUERGVmlld2VyQXBwbGljYXRpb24ucGRmVGh1bWJuYWlsVmlld2VyLnNjcm9sbFRodW1ibmFpbEludG9WaWV3KHBhZ2UpOwogIH0KCiAgaWYgKHR5cGVvZiBTdGF0cyAhPT0gInVuZGVmaW5lZCIgJiYgU3RhdHMuZW5hYmxlZCkgewogICAgdmFyIHBhZ2VWaWV3ID0gUERGVmlld2VyQXBwbGljYXRpb24ucGRmVmlld2VyLmdldFBhZ2VWaWV3KHBhZ2UgLSAxKTsKCiAgICBpZiAocGFnZVZpZXcgJiYgcGFnZVZpZXcuc3RhdHMpIHsKICAgICAgU3RhdHMuYWRkKHBhZ2UsIHBhZ2VWaWV3LnN0YXRzKTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIHdlYlZpZXdlclZpc2liaWxpdHlDaGFuZ2UoZXZ0KSB7CiAgaWYgKGRvY3VtZW50LnZpc2liaWxpdHlTdGF0ZSA9PT0gInZpc2libGUiKSB7CiAgICBzZXRab29tRGlzYWJsZWRUaW1lb3V0KCk7CiAgfQp9Cgp2YXIgem9vbURpc2FibGVkVGltZW91dCA9IG51bGw7CgpmdW5jdGlvbiBzZXRab29tRGlzYWJsZWRUaW1lb3V0KCkgewogIGlmICh6b29tRGlzYWJsZWRUaW1lb3V0KSB7CiAgICBjbGVhclRpbWVvdXQoem9vbURpc2FibGVkVGltZW91dCk7CiAgfQoKICB6b29tRGlzYWJsZWRUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICB6b29tRGlzYWJsZWRUaW1lb3V0ID0gbnVsbDsKICB9LCBXSEVFTF9aT09NX0RJU0FCTEVEX1RJTUVPVVQpOwp9CgpmdW5jdGlvbiB3ZWJWaWV3ZXJXaGVlbChldnQpIHsKICB2YXIgcGRmVmlld2VyID0gUERGVmlld2VyQXBwbGljYXRpb24ucGRmVmlld2VyLAogICAgICBzdXBwb3J0ZWRNb3VzZVdoZWVsWm9vbU1vZGlmaWVyS2V5cyA9IFBERlZpZXdlckFwcGxpY2F0aW9uLnN1cHBvcnRlZE1vdXNlV2hlZWxab29tTW9kaWZpZXJLZXlzOwoKICBpZiAocGRmVmlld2VyLmlzSW5QcmVzZW50YXRpb25Nb2RlKSB7CiAgICByZXR1cm47CiAgfQoKICBpZiAoZXZ0LmN0cmxLZXkgJiYgc3VwcG9ydGVkTW91c2VXaGVlbFpvb21Nb2RpZmllcktleXMuY3RybEtleSB8fCBldnQubWV0YUtleSAmJiBzdXBwb3J0ZWRNb3VzZVdoZWVsWm9vbU1vZGlmaWVyS2V5cy5tZXRhS2V5KSB7CiAgICBldnQucHJldmVudERlZmF1bHQoKTsKCiAgICBpZiAoem9vbURpc2FibGVkVGltZW91dCB8fCBkb2N1bWVudC52aXNpYmlsaXR5U3RhdGUgPT09ICJoaWRkZW4iKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgcHJldmlvdXNTY2FsZSA9IHBkZlZpZXdlci5jdXJyZW50U2NhbGU7CiAgICB2YXIgZGVsdGEgPSAoMCwgX3VpX3V0aWxzLm5vcm1hbGl6ZVdoZWVsRXZlbnREZWx0YSkoZXZ0KTsKICAgIHZhciBNT1VTRV9XSEVFTF9ERUxUQV9QRVJfUEFHRV9TQ0FMRSA9IDMuMDsKICAgIHZhciB0aWNrcyA9IGRlbHRhICogTU9VU0VfV0hFRUxfREVMVEFfUEVSX1BBR0VfU0NBTEU7CgogICAgaWYgKHRpY2tzIDwgMCkgewogICAgICBQREZWaWV3ZXJBcHBsaWNhdGlvbi56b29tT3V0KC10aWNrcyk7CiAgICB9IGVsc2UgewogICAgICBQREZWaWV3ZXJBcHBsaWNhdGlvbi56b29tSW4odGlja3MpOwogICAgfQoKICAgIHZhciBjdXJyZW50U2NhbGUgPSBwZGZWaWV3ZXIuY3VycmVudFNjYWxlOwoKICAgIGlmIChwcmV2aW91c1NjYWxlICE9PSBjdXJyZW50U2NhbGUpIHsKICAgICAgdmFyIHNjYWxlQ29ycmVjdGlvbkZhY3RvciA9IGN1cnJlbnRTY2FsZSAvIHByZXZpb3VzU2NhbGUgLSAxOwogICAgICB2YXIgcmVjdCA9IHBkZlZpZXdlci5jb250YWluZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIHZhciBkeCA9IGV2dC5jbGllbnRYIC0gcmVjdC5sZWZ0OwogICAgICB2YXIgZHkgPSBldnQuY2xpZW50WSAtIHJlY3QudG9wOwogICAgICBwZGZWaWV3ZXIuY29udGFpbmVyLnNjcm9sbExlZnQgKz0gZHggKiBzY2FsZUNvcnJlY3Rpb25GYWN0b3I7CiAgICAgIHBkZlZpZXdlci5jb250YWluZXIuc2Nyb2xsVG9wICs9IGR5ICogc2NhbGVDb3JyZWN0aW9uRmFjdG9yOwogICAgfQogIH0gZWxzZSB7CiAgICBzZXRab29tRGlzYWJsZWRUaW1lb3V0KCk7CiAgfQp9CgpmdW5jdGlvbiB3ZWJWaWV3ZXJDbGljayhldnQpIHsKICBpZiAoIVBERlZpZXdlckFwcGxpY2F0aW9uLnNlY29uZGFyeVRvb2xiYXIuaXNPcGVuKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgYXBwQ29uZmlnID0gUERGVmlld2VyQXBwbGljYXRpb24uYXBwQ29uZmlnOwoKICBpZiAoUERGVmlld2VyQXBwbGljYXRpb24ucGRmVmlld2VyLmNvbnRhaW5zRWxlbWVudChldnQudGFyZ2V0KSB8fCBhcHBDb25maWcudG9vbGJhci5jb250YWluZXIuY29udGFpbnMoZXZ0LnRhcmdldCkgJiYgZXZ0LnRhcmdldCAhPT0gYXBwQ29uZmlnLnNlY29uZGFyeVRvb2xiYXIudG9nZ2xlQnV0dG9uKSB7CiAgICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5zZWNvbmRhcnlUb29sYmFyLmNsb3NlKCk7CiAgfQp9CgpmdW5jdGlvbiB3ZWJWaWV3ZXJLZXlEb3duKGV2dCkgewogIGlmIChQREZWaWV3ZXJBcHBsaWNhdGlvbi5vdmVybGF5TWFuYWdlci5hY3RpdmUpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBoYW5kbGVkID0gZmFsc2UsCiAgICAgIGVuc3VyZVZpZXdlckZvY3VzZWQgPSBmYWxzZTsKICB2YXIgY21kID0gKGV2dC5jdHJsS2V5ID8gMSA6IDApIHwgKGV2dC5hbHRLZXkgPyAyIDogMCkgfCAoZXZ0LnNoaWZ0S2V5ID8gNCA6IDApIHwgKGV2dC5tZXRhS2V5ID8gOCA6IDApOwogIHZhciBwZGZWaWV3ZXIgPSBQREZWaWV3ZXJBcHBsaWNhdGlvbi5wZGZWaWV3ZXI7CiAgdmFyIGlzVmlld2VySW5QcmVzZW50YXRpb25Nb2RlID0gcGRmVmlld2VyICYmIHBkZlZpZXdlci5pc0luUHJlc2VudGF0aW9uTW9kZTsKCiAgaWYgKGNtZCA9PT0gMSB8fCBjbWQgPT09IDggfHwgY21kID09PSA1IHx8IGNtZCA9PT0gMTIpIHsKICAgIHN3aXRjaCAoZXZ0LmtleUNvZGUpIHsKICAgICAgY2FzZSA3MDoKICAgICAgICBpZiAoIVBERlZpZXdlckFwcGxpY2F0aW9uLnN1cHBvcnRzSW50ZWdyYXRlZEZpbmQpIHsKICAgICAgICAgIFBERlZpZXdlckFwcGxpY2F0aW9uLmZpbmRCYXIub3BlbigpOwogICAgICAgICAgaGFuZGxlZCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNzE6CiAgICAgICAgaWYgKCFQREZWaWV3ZXJBcHBsaWNhdGlvbi5zdXBwb3J0c0ludGVncmF0ZWRGaW5kKSB7CiAgICAgICAgICB2YXIgZmluZFN0YXRlID0gUERGVmlld2VyQXBwbGljYXRpb24uZmluZENvbnRyb2xsZXIuc3RhdGU7CgogICAgICAgICAgaWYgKGZpbmRTdGF0ZSkgewogICAgICAgICAgICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5maW5kQ29udHJvbGxlci5leGVjdXRlQ29tbWFuZCgiZmluZGFnYWluIiwgewogICAgICAgICAgICAgIHF1ZXJ5OiBmaW5kU3RhdGUucXVlcnksCiAgICAgICAgICAgICAgcGhyYXNlU2VhcmNoOiBmaW5kU3RhdGUucGhyYXNlU2VhcmNoLAogICAgICAgICAgICAgIGNhc2VTZW5zaXRpdmU6IGZpbmRTdGF0ZS5jYXNlU2Vuc2l0aXZlLAogICAgICAgICAgICAgIGVudGlyZVdvcmQ6IGZpbmRTdGF0ZS5lbnRpcmVXb3JkLAogICAgICAgICAgICAgIGhpZ2hsaWdodEFsbDogZmluZFN0YXRlLmhpZ2hsaWdodEFsbCwKICAgICAgICAgICAgICBmaW5kUHJldmlvdXM6IGNtZCA9PT0gNSB8fCBjbWQgPT09IDEyCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQoKICAgICAgICAgIGhhbmRsZWQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDYxOgogICAgICBjYXNlIDEwNzoKICAgICAgY2FzZSAxODc6CiAgICAgIGNhc2UgMTcxOgogICAgICAgIGlmICghaXNWaWV3ZXJJblByZXNlbnRhdGlvbk1vZGUpIHsKICAgICAgICAgIFBERlZpZXdlckFwcGxpY2F0aW9uLnpvb21JbigpOwogICAgICAgIH0KCiAgICAgICAgaGFuZGxlZCA9IHRydWU7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDE3MzoKICAgICAgY2FzZSAxMDk6CiAgICAgIGNhc2UgMTg5OgogICAgICAgIGlmICghaXNWaWV3ZXJJblByZXNlbnRhdGlvbk1vZGUpIHsKICAgICAgICAgIFBERlZpZXdlckFwcGxpY2F0aW9uLnpvb21PdXQoKTsKICAgICAgICB9CgogICAgICAgIGhhbmRsZWQgPSB0cnVlOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0ODoKICAgICAgY2FzZSA5NjoKICAgICAgICBpZiAoIWlzVmlld2VySW5QcmVzZW50YXRpb25Nb2RlKSB7CiAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgUERGVmlld2VyQXBwbGljYXRpb24uem9vbVJlc2V0KCk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGhhbmRsZWQgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAzODoKICAgICAgICBpZiAoaXNWaWV3ZXJJblByZXNlbnRhdGlvbk1vZGUgfHwgUERGVmlld2VyQXBwbGljYXRpb24ucGFnZSA+IDEpIHsKICAgICAgICAgIFBERlZpZXdlckFwcGxpY2F0aW9uLnBhZ2UgPSAxOwogICAgICAgICAgaGFuZGxlZCA9IHRydWU7CiAgICAgICAgICBlbnN1cmVWaWV3ZXJGb2N1c2VkID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0MDoKICAgICAgICBpZiAoaXNWaWV3ZXJJblByZXNlbnRhdGlvbk1vZGUgfHwgUERGVmlld2VyQXBwbGljYXRpb24ucGFnZSA8IFBERlZpZXdlckFwcGxpY2F0aW9uLnBhZ2VzQ291bnQpIHsKICAgICAgICAgIFBERlZpZXdlckFwcGxpY2F0aW9uLnBhZ2UgPSBQREZWaWV3ZXJBcHBsaWNhdGlvbi5wYWdlc0NvdW50OwogICAgICAgICAgaGFuZGxlZCA9IHRydWU7CiAgICAgICAgICBlbnN1cmVWaWV3ZXJGb2N1c2VkID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgdmFyIGV2ZW50QnVzID0gUERGVmlld2VyQXBwbGljYXRpb24uZXZlbnRCdXM7CgogIGlmIChjbWQgPT09IDEgfHwgY21kID09PSA4KSB7CiAgICBzd2l0Y2ggKGV2dC5rZXlDb2RlKSB7CiAgICAgIGNhc2UgODM6CiAgICAgICAgZXZlbnRCdXMuZGlzcGF0Y2goImRvd25sb2FkIiwgewogICAgICAgICAgc291cmNlOiB3aW5kb3cKICAgICAgICB9KTsKICAgICAgICBoYW5kbGVkID0gdHJ1ZTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNzk6CiAgICAgICAgewogICAgICAgICAgZXZlbnRCdXMuZGlzcGF0Y2goIm9wZW5maWxlIiwgewogICAgICAgICAgICBzb3VyY2U6IHdpbmRvdwogICAgICAgICAgfSk7CiAgICAgICAgICBoYW5kbGVkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICBpZiAoY21kID09PSAzIHx8IGNtZCA9PT0gMTApIHsKICAgIHN3aXRjaCAoZXZ0LmtleUNvZGUpIHsKICAgICAgY2FzZSA4MDoKICAgICAgICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5yZXF1ZXN0UHJlc2VudGF0aW9uTW9kZSgpOwogICAgICAgIGhhbmRsZWQgPSB0cnVlOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA3MToKICAgICAgICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5hcHBDb25maWcudG9vbGJhci5wYWdlTnVtYmVyLnNlbGVjdCgpOwogICAgICAgIGhhbmRsZWQgPSB0cnVlOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgaWYgKGhhbmRsZWQpIHsKICAgIGlmIChlbnN1cmVWaWV3ZXJGb2N1c2VkICYmICFpc1ZpZXdlckluUHJlc2VudGF0aW9uTW9kZSkgewogICAgICBwZGZWaWV3ZXIuZm9jdXMoKTsKICAgIH0KCiAgICBldnQucHJldmVudERlZmF1bHQoKTsKICAgIHJldHVybjsKICB9CgogIHZhciBjdXJFbGVtZW50ID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudCB8fCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCI6Zm9jdXMiKTsKICB2YXIgY3VyRWxlbWVudFRhZ05hbWUgPSBjdXJFbGVtZW50ICYmIGN1ckVsZW1lbnQudGFnTmFtZS50b1VwcGVyQ2FzZSgpOwoKICBpZiAoY3VyRWxlbWVudFRhZ05hbWUgPT09ICJJTlBVVCIgfHwgY3VyRWxlbWVudFRhZ05hbWUgPT09ICJURVhUQVJFQSIgfHwgY3VyRWxlbWVudFRhZ05hbWUgPT09ICJTRUxFQ1QiIHx8IGN1ckVsZW1lbnQgJiYgY3VyRWxlbWVudC5pc0NvbnRlbnRFZGl0YWJsZSkgewogICAgaWYgKGV2dC5rZXlDb2RlICE9PSAyNykgewogICAgICByZXR1cm47CiAgICB9CiAgfQoKICBpZiAoY21kID09PSAwKSB7CiAgICB2YXIgdHVyblBhZ2UgPSAwLAogICAgICAgIHR1cm5Pbmx5SWZQYWdlRml0ID0gZmFsc2U7CgogICAgc3dpdGNoIChldnQua2V5Q29kZSkgewogICAgICBjYXNlIDM4OgogICAgICBjYXNlIDMzOgogICAgICAgIGlmIChwZGZWaWV3ZXIuaXNWZXJ0aWNhbFNjcm9sbGJhckVuYWJsZWQpIHsKICAgICAgICAgIHR1cm5Pbmx5SWZQYWdlRml0ID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHR1cm5QYWdlID0gLTE7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDg6CiAgICAgICAgaWYgKCFpc1ZpZXdlckluUHJlc2VudGF0aW9uTW9kZSkgewogICAgICAgICAgdHVybk9ubHlJZlBhZ2VGaXQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgdHVyblBhZ2UgPSAtMTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMzc6CiAgICAgICAgaWYgKHBkZlZpZXdlci5pc0hvcml6b250YWxTY3JvbGxiYXJFbmFibGVkKSB7CiAgICAgICAgICB0dXJuT25seUlmUGFnZUZpdCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgY2FzZSA3NToKICAgICAgY2FzZSA4MDoKICAgICAgICB0dXJuUGFnZSA9IC0xOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyNzoKICAgICAgICBpZiAoUERGVmlld2VyQXBwbGljYXRpb24uc2Vjb25kYXJ5VG9vbGJhci5pc09wZW4pIHsKICAgICAgICAgIFBERlZpZXdlckFwcGxpY2F0aW9uLnNlY29uZGFyeVRvb2xiYXIuY2xvc2UoKTsKICAgICAgICAgIGhhbmRsZWQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFQREZWaWV3ZXJBcHBsaWNhdGlvbi5zdXBwb3J0c0ludGVncmF0ZWRGaW5kICYmIFBERlZpZXdlckFwcGxpY2F0aW9uLmZpbmRCYXIub3BlbmVkKSB7CiAgICAgICAgICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5maW5kQmFyLmNsb3NlKCk7CiAgICAgICAgICBoYW5kbGVkID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0MDoKICAgICAgY2FzZSAzNDoKICAgICAgICBpZiAocGRmVmlld2VyLmlzVmVydGljYWxTY3JvbGxiYXJFbmFibGVkKSB7CiAgICAgICAgICB0dXJuT25seUlmUGFnZUZpdCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB0dXJuUGFnZSA9IDE7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDEzOgogICAgICBjYXNlIDMyOgogICAgICAgIGlmICghaXNWaWV3ZXJJblByZXNlbnRhdGlvbk1vZGUpIHsKICAgICAgICAgIHR1cm5Pbmx5SWZQYWdlRml0ID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHR1cm5QYWdlID0gMTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMzk6CiAgICAgICAgaWYgKHBkZlZpZXdlci5pc0hvcml6b250YWxTY3JvbGxiYXJFbmFibGVkKSB7CiAgICAgICAgICB0dXJuT25seUlmUGFnZUZpdCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgY2FzZSA3NDoKICAgICAgY2FzZSA3ODoKICAgICAgICB0dXJuUGFnZSA9IDE7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM2OgogICAgICAgIGlmIChpc1ZpZXdlckluUHJlc2VudGF0aW9uTW9kZSB8fCBQREZWaWV3ZXJBcHBsaWNhdGlvbi5wYWdlID4gMSkgewogICAgICAgICAgUERGVmlld2VyQXBwbGljYXRpb24ucGFnZSA9IDE7CiAgICAgICAgICBoYW5kbGVkID0gdHJ1ZTsKICAgICAgICAgIGVuc3VyZVZpZXdlckZvY3VzZWQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM1OgogICAgICAgIGlmIChpc1ZpZXdlckluUHJlc2VudGF0aW9uTW9kZSB8fCBQREZWaWV3ZXJBcHBsaWNhdGlvbi5wYWdlIDwgUERGVmlld2VyQXBwbGljYXRpb24ucGFnZXNDb3VudCkgewogICAgICAgICAgUERGVmlld2VyQXBwbGljYXRpb24ucGFnZSA9IFBERlZpZXdlckFwcGxpY2F0aW9uLnBhZ2VzQ291bnQ7CiAgICAgICAgICBoYW5kbGVkID0gdHJ1ZTsKICAgICAgICAgIGVuc3VyZVZpZXdlckZvY3VzZWQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDgzOgogICAgICAgIFBERlZpZXdlckFwcGxpY2F0aW9uLnBkZkN1cnNvclRvb2xzLnN3aXRjaFRvb2woX3BkZl9jdXJzb3JfdG9vbHMuQ3Vyc29yVG9vbC5TRUxFQ1QpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA3MjoKICAgICAgICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5wZGZDdXJzb3JUb29scy5zd2l0Y2hUb29sKF9wZGZfY3Vyc29yX3Rvb2xzLkN1cnNvclRvb2wuSEFORCk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDgyOgogICAgICAgIFBERlZpZXdlckFwcGxpY2F0aW9uLnJvdGF0ZVBhZ2VzKDkwKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMTE1OgogICAgICAgIFBERlZpZXdlckFwcGxpY2F0aW9uLnBkZlNpZGViYXIudG9nZ2xlKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CgogICAgaWYgKHR1cm5QYWdlICE9PSAwICYmICghdHVybk9ubHlJZlBhZ2VGaXQgfHwgcGRmVmlld2VyLmN1cnJlbnRTY2FsZVZhbHVlID09PSAicGFnZS1maXQiKSkgewogICAgICBpZiAodHVyblBhZ2UgPiAwKSB7CiAgICAgICAgaWYgKFBERlZpZXdlckFwcGxpY2F0aW9uLnBhZ2UgPCBQREZWaWV3ZXJBcHBsaWNhdGlvbi5wYWdlc0NvdW50KSB7CiAgICAgICAgICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5wYWdlKys7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChQREZWaWV3ZXJBcHBsaWNhdGlvbi5wYWdlID4gMSkgewogICAgICAgICAgUERGVmlld2VyQXBwbGljYXRpb24ucGFnZS0tOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaGFuZGxlZCA9IHRydWU7CiAgICB9CiAgfQoKICBpZiAoY21kID09PSA0KSB7CiAgICBzd2l0Y2ggKGV2dC5rZXlDb2RlKSB7CiAgICAgIGNhc2UgMTM6CiAgICAgIGNhc2UgMzI6CiAgICAgICAgaWYgKCFpc1ZpZXdlckluUHJlc2VudGF0aW9uTW9kZSAmJiBwZGZWaWV3ZXIuY3VycmVudFNjYWxlVmFsdWUgIT09ICJwYWdlLWZpdCIpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgaWYgKFBERlZpZXdlckFwcGxpY2F0aW9uLnBhZ2UgPiAxKSB7CiAgICAgICAgICBQREZWaWV3ZXJBcHBsaWNhdGlvbi5wYWdlLS07CiAgICAgICAgfQoKICAgICAgICBoYW5kbGVkID0gdHJ1ZTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgODI6CiAgICAgICAgUERGVmlld2VyQXBwbGljYXRpb24ucm90YXRlUGFnZXMoLTkwKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIGlmICghaGFuZGxlZCAmJiAhaXNWaWV3ZXJJblByZXNlbnRhdGlvbk1vZGUpIHsKICAgIGlmIChldnQua2V5Q29kZSA+PSAzMyAmJiBldnQua2V5Q29kZSA8PSA0MCB8fCBldnQua2V5Q29kZSA9PT0gMzIgJiYgY3VyRWxlbWVudFRhZ05hbWUgIT09ICJCVVRUT04iKSB7CiAgICAgIGVuc3VyZVZpZXdlckZvY3VzZWQgPSB0cnVlOwogICAgfQogIH0KCiAgaWYgKGVuc3VyZVZpZXdlckZvY3VzZWQgJiYgIXBkZlZpZXdlci5jb250YWluc0VsZW1lbnQoY3VyRWxlbWVudCkpIHsKICAgIHBkZlZpZXdlci5mb2N1cygpOwogIH0KCiAgaWYgKGhhbmRsZWQpIHsKICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpOwogIH0KfQoKZnVuY3Rpb24gYXBpUGFnZUxheW91dFRvU3ByZWFkTW9kZShsYXlvdXQpIHsKICBzd2l0Y2ggKGxheW91dCkgewogICAgY2FzZSAiU2luZ2xlUGFnZSI6CiAgICBjYXNlICJPbmVDb2x1bW4iOgogICAgICByZXR1cm4gX3VpX3V0aWxzLlNwcmVhZE1vZGUuTk9ORTsKCiAgICBjYXNlICJUd29Db2x1bW5MZWZ0IjoKICAgIGNhc2UgIlR3b1BhZ2VMZWZ0IjoKICAgICAgcmV0dXJuIF91aV91dGlscy5TcHJlYWRNb2RlLk9ERDsKCiAgICBjYXNlICJUd29Db2x1bW5SaWdodCI6CiAgICBjYXNlICJUd29QYWdlUmlnaHQiOgogICAgICByZXR1cm4gX3VpX3V0aWxzLlNwcmVhZE1vZGUuRVZFTjsKICB9CgogIHJldHVybiBfdWlfdXRpbHMuU3ByZWFkTW9kZS5OT05FOwp9CgpmdW5jdGlvbiBhcGlQYWdlTW9kZVRvU2lkZWJhclZpZXcobW9kZSkgewogIHN3aXRjaCAobW9kZSkgewogICAgY2FzZSAiVXNlTm9uZSI6CiAgICAgIHJldHVybiBfcGRmX3NpZGViYXIuU2lkZWJhclZpZXcuTk9ORTsKCiAgICBjYXNlICJVc2VUaHVtYnMiOgogICAgICByZXR1cm4gX3BkZl9zaWRlYmFyLlNpZGViYXJWaWV3LlRIVU1CUzsKCiAgICBjYXNlICJVc2VPdXRsaW5lcyI6CiAgICAgIHJldHVybiBfcGRmX3NpZGViYXIuU2lkZWJhclZpZXcuT1VUTElORTsKCiAgICBjYXNlICJVc2VBdHRhY2htZW50cyI6CiAgICAgIHJldHVybiBfcGRmX3NpZGViYXIuU2lkZWJhclZpZXcuQVRUQUNITUVOVFM7CgogICAgY2FzZSAiVXNlT0MiOgogIH0KCiAgcmV0dXJuIF9wZGZfc2lkZWJhci5TaWRlYmFyVmlldy5OT05FOwp9Cgp2YXIgUERGUHJpbnRTZXJ2aWNlRmFjdG9yeSA9IHsKICBpbnN0YW5jZTogewogICAgc3VwcG9ydHNQcmludGluZzogZmFsc2UsCiAgICBjcmVhdGVQcmludFNlcnZpY2U6IGZ1bmN0aW9uIGNyZWF0ZVByaW50U2VydmljZSgpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJOb3QgaW1wbGVtZW50ZWQ6IGNyZWF0ZVByaW50U2VydmljZSIpOwogICAgfQogIH0KfTsKZXhwb3J0cy5QREZQcmludFNlcnZpY2VGYWN0b3J5ID0gUERGUHJpbnRTZXJ2aWNlRmFjdG9yeTsKCi8qKiovIH0pLAovKiAyICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgptb2R1bGUuZXhwb3J0cyA9IF9fd2VicGFja19yZXF1aXJlX18oMyk7CgovKioqLyB9KSwKLyogMyAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoidXNlIHN0cmljdCI7Ci8qIFdFQlBBQ0sgVkFSIElOSkVDVElPTiAqLyhmdW5jdGlvbihtb2R1bGUpIHsKCmZ1bmN0aW9uIF90eXBlb2Yob2JqKSB7ICJAYmFiZWwvaGVscGVycyAtIHR5cGVvZiI7IGlmICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBTeW1ib2wuaXRlcmF0b3IgPT09ICJzeW1ib2wiKSB7IF90eXBlb2YgPSBmdW5jdGlvbiBfdHlwZW9mKG9iaikgeyByZXR1cm4gdHlwZW9mIG9iajsgfTsgfSBlbHNlIHsgX3R5cGVvZiA9IGZ1bmN0aW9uIF90eXBlb2Yob2JqKSB7IHJldHVybiBvYmogJiYgdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBvYmouY29uc3RydWN0b3IgPT09IFN5bWJvbCAmJiBvYmogIT09IFN5bWJvbC5wcm90b3R5cGUgPyAic3ltYm9sIiA6IHR5cGVvZiBvYmo7IH07IH0gcmV0dXJuIF90eXBlb2Yob2JqKTsgfQoKdmFyIHJ1bnRpbWUgPSBmdW5jdGlvbiAoZXhwb3J0cykgewogICJ1c2Ugc3RyaWN0IjsKCiAgdmFyIE9wID0gT2JqZWN0LnByb3RvdHlwZTsKICB2YXIgaGFzT3duID0gT3AuaGFzT3duUHJvcGVydHk7CiAgdmFyIHVuZGVmaW5lZDsKICB2YXIgJFN5bWJvbCA9IHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgPyBTeW1ib2wgOiB7fTsKICB2YXIgaXRlcmF0b3JTeW1ib2wgPSAkU3ltYm9sLml0ZXJhdG9yIHx8ICJAQGl0ZXJhdG9yIjsKICB2YXIgYXN5bmNJdGVyYXRvclN5bWJvbCA9ICRTeW1ib2wuYXN5bmNJdGVyYXRvciB8fCAiQEBhc3luY0l0ZXJhdG9yIjsKICB2YXIgdG9TdHJpbmdUYWdTeW1ib2wgPSAkU3ltYm9sLnRvU3RyaW5nVGFnIHx8ICJAQHRvU3RyaW5nVGFnIjsKCiAgZnVuY3Rpb24gd3JhcChpbm5lckZuLCBvdXRlckZuLCBzZWxmLCB0cnlMb2NzTGlzdCkgewogICAgdmFyIHByb3RvR2VuZXJhdG9yID0gb3V0ZXJGbiAmJiBvdXRlckZuLnByb3RvdHlwZSBpbnN0YW5jZW9mIEdlbmVyYXRvciA/IG91dGVyRm4gOiBHZW5lcmF0b3I7CiAgICB2YXIgZ2VuZXJhdG9yID0gT2JqZWN0LmNyZWF0ZShwcm90b0dlbmVyYXRvci5wcm90b3R5cGUpOwogICAgdmFyIGNvbnRleHQgPSBuZXcgQ29udGV4dCh0cnlMb2NzTGlzdCB8fCBbXSk7CiAgICBnZW5lcmF0b3IuX2ludm9rZSA9IG1ha2VJbnZva2VNZXRob2QoaW5uZXJGbiwgc2VsZiwgY29udGV4dCk7CiAgICByZXR1cm4gZ2VuZXJhdG9yOwogIH0KCiAgZXhwb3J0cy53cmFwID0gd3JhcDsKCiAgZnVuY3Rpb24gdHJ5Q2F0Y2goZm4sIG9iaiwgYXJnKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gewogICAgICAgIHR5cGU6ICJub3JtYWwiLAogICAgICAgIGFyZzogZm4uY2FsbChvYmosIGFyZykKICAgICAgfTsKICAgIH0gY2F0Y2ggKGVycikgewogICAgICByZXR1cm4gewogICAgICAgIHR5cGU6ICJ0aHJvdyIsCiAgICAgICAgYXJnOiBlcnIKICAgICAgfTsKICAgIH0KICB9CgogIHZhciBHZW5TdGF0ZVN1c3BlbmRlZFN0YXJ0ID0gInN1c3BlbmRlZFN0YXJ0IjsKICB2YXIgR2VuU3RhdGVTdXNwZW5kZWRZaWVsZCA9ICJzdXNwZW5kZWRZaWVsZCI7CiAgdmFyIEdlblN0YXRlRXhlY3V0aW5nID0gImV4ZWN1dGluZyI7CiAgdmFyIEdlblN0YXRlQ29tcGxldGVkID0gImNvbXBsZXRlZCI7CiAgdmFyIENvbnRpbnVlU2VudGluZWwgPSB7fTsKCiAgZnVuY3Rpb24gR2VuZXJhdG9yKCkge30KCiAgZnVuY3Rpb24gR2VuZXJhdG9yRnVuY3Rpb24oKSB7fQoKICBmdW5jdGlvbiBHZW5lcmF0b3JGdW5jdGlvblByb3RvdHlwZSgpIHt9CgogIHZhciBJdGVyYXRvclByb3RvdHlwZSA9IHt9OwoKICBJdGVyYXRvclByb3RvdHlwZVtpdGVyYXRvclN5bWJvbF0gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICB2YXIgZ2V0UHJvdG8gPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Y7CiAgdmFyIE5hdGl2ZUl0ZXJhdG9yUHJvdG90eXBlID0gZ2V0UHJvdG8gJiYgZ2V0UHJvdG8oZ2V0UHJvdG8odmFsdWVzKFtdKSkpOwoKICBpZiAoTmF0aXZlSXRlcmF0b3JQcm90b3R5cGUgJiYgTmF0aXZlSXRlcmF0b3JQcm90b3R5cGUgIT09IE9wICYmIGhhc093bi5jYWxsKE5hdGl2ZUl0ZXJhdG9yUHJvdG90eXBlLCBpdGVyYXRvclN5bWJvbCkpIHsKICAgIEl0ZXJhdG9yUHJvdG90eXBlID0gTmF0aXZlSXRlcmF0b3JQcm90b3R5cGU7CiAgfQoKICB2YXIgR3AgPSBHZW5lcmF0b3JGdW5jdGlvblByb3RvdHlwZS5wcm90b3R5cGUgPSBHZW5lcmF0b3IucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShJdGVyYXRvclByb3RvdHlwZSk7CiAgR2VuZXJhdG9yRnVuY3Rpb24ucHJvdG90eXBlID0gR3AuY29uc3RydWN0b3IgPSBHZW5lcmF0b3JGdW5jdGlvblByb3RvdHlwZTsKICBHZW5lcmF0b3JGdW5jdGlvblByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEdlbmVyYXRvckZ1bmN0aW9uOwogIEdlbmVyYXRvckZ1bmN0aW9uUHJvdG90eXBlW3RvU3RyaW5nVGFnU3ltYm9sXSA9IEdlbmVyYXRvckZ1bmN0aW9uLmRpc3BsYXlOYW1lID0gIkdlbmVyYXRvckZ1bmN0aW9uIjsKCiAgZnVuY3Rpb24gZGVmaW5lSXRlcmF0b3JNZXRob2RzKHByb3RvdHlwZSkgewogICAgWyJuZXh0IiwgInRocm93IiwgInJldHVybiJdLmZvckVhY2goZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICBwcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uIChhcmcpIHsKICAgICAgICByZXR1cm4gdGhpcy5faW52b2tlKG1ldGhvZCwgYXJnKTsKICAgICAgfTsKICAgIH0pOwogIH0KCiAgZXhwb3J0cy5pc0dlbmVyYXRvckZ1bmN0aW9uID0gZnVuY3Rpb24gKGdlbkZ1bikgewogICAgdmFyIGN0b3IgPSB0eXBlb2YgZ2VuRnVuID09PSAiZnVuY3Rpb24iICYmIGdlbkZ1bi5jb25zdHJ1Y3RvcjsKICAgIHJldHVybiBjdG9yID8gY3RvciA9PT0gR2VuZXJhdG9yRnVuY3Rpb24gfHwgKGN0b3IuZGlzcGxheU5hbWUgfHwgY3Rvci5uYW1lKSA9PT0gIkdlbmVyYXRvckZ1bmN0aW9uIiA6IGZhbHNlOwogIH07CgogIGV4cG9ydHMubWFyayA9IGZ1bmN0aW9uIChnZW5GdW4pIHsKICAgIGlmIChPYmplY3Quc2V0UHJvdG90eXBlT2YpIHsKICAgICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKGdlbkZ1biwgR2VuZXJhdG9yRnVuY3Rpb25Qcm90b3R5cGUpOwogICAgfSBlbHNlIHsKICAgICAgZ2VuRnVuLl9fcHJvdG9fXyA9IEdlbmVyYXRvckZ1bmN0aW9uUHJvdG90eXBlOwoKICAgICAgaWYgKCEodG9TdHJpbmdUYWdTeW1ib2wgaW4gZ2VuRnVuKSkgewogICAgICAgIGdlbkZ1blt0b1N0cmluZ1RhZ1N5bWJvbF0gPSAiR2VuZXJhdG9yRnVuY3Rpb24iOwogICAgICB9CiAgICB9CgogICAgZ2VuRnVuLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoR3ApOwogICAgcmV0dXJuIGdlbkZ1bjsKICB9OwoKICBleHBvcnRzLmF3cmFwID0gZnVuY3Rpb24gKGFyZykgewogICAgcmV0dXJuIHsKICAgICAgX19hd2FpdDogYXJnCiAgICB9OwogIH07CgogIGZ1bmN0aW9uIEFzeW5jSXRlcmF0b3IoZ2VuZXJhdG9yLCBQcm9taXNlSW1wbCkgewogICAgZnVuY3Rpb24gaW52b2tlKG1ldGhvZCwgYXJnLCByZXNvbHZlLCByZWplY3QpIHsKICAgICAgdmFyIHJlY29yZCA9IHRyeUNhdGNoKGdlbmVyYXRvclttZXRob2RdLCBnZW5lcmF0b3IsIGFyZyk7CgogICAgICBpZiAocmVjb3JkLnR5cGUgPT09ICJ0aHJvdyIpIHsKICAgICAgICByZWplY3QocmVjb3JkLmFyZyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IHJlY29yZC5hcmc7CiAgICAgICAgdmFyIHZhbHVlID0gcmVzdWx0LnZhbHVlOwoKICAgICAgICBpZiAodmFsdWUgJiYgX3R5cGVvZih2YWx1ZSkgPT09ICJvYmplY3QiICYmIGhhc093bi5jYWxsKHZhbHVlLCAiX19hd2FpdCIpKSB7CiAgICAgICAgICByZXR1cm4gUHJvbWlzZUltcGwucmVzb2x2ZSh2YWx1ZS5fX2F3YWl0KS50aGVuKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpbnZva2UoIm5leHQiLCB2YWx1ZSwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgaW52b2tlKCJ0aHJvdyIsIGVyciwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIFByb21pc2VJbXBsLnJlc29sdmUodmFsdWUpLnRoZW4oZnVuY3Rpb24gKHVud3JhcHBlZCkgewogICAgICAgICAgcmVzdWx0LnZhbHVlID0gdW53cmFwcGVkOwogICAgICAgICAgcmVzb2x2ZShyZXN1bHQpOwogICAgICAgIH0sIGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgcmV0dXJuIGludm9rZSgidGhyb3ciLCBlcnJvciwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICB9KTsKICAgICAgfQogICAgfQoKICAgIHZhciBwcmV2aW91c1Byb21pc2U7CgogICAgZnVuY3Rpb24gZW5xdWV1ZShtZXRob2QsIGFyZykgewogICAgICBmdW5jdGlvbiBjYWxsSW52b2tlV2l0aE1ldGhvZEFuZEFyZygpIHsKICAgICAgICByZXR1cm4gbmV3IFByb21pc2VJbXBsKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIGludm9rZShtZXRob2QsIGFyZywgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgcmV0dXJuIHByZXZpb3VzUHJvbWlzZSA9IHByZXZpb3VzUHJvbWlzZSA/IHByZXZpb3VzUHJvbWlzZS50aGVuKGNhbGxJbnZva2VXaXRoTWV0aG9kQW5kQXJnLCBjYWxsSW52b2tlV2l0aE1ldGhvZEFuZEFyZykgOiBjYWxsSW52b2tlV2l0aE1ldGhvZEFuZEFyZygpOwogICAgfQoKICAgIHRoaXMuX2ludm9rZSA9IGVucXVldWU7CiAgfQoKICBkZWZpbmVJdGVyYXRvck1ldGhvZHMoQXN5bmNJdGVyYXRvci5wcm90b3R5cGUpOwoKICBBc3luY0l0ZXJhdG9yLnByb3RvdHlwZVthc3luY0l0ZXJhdG9yU3ltYm9sXSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzOwogIH07CgogIGV4cG9ydHMuQXN5bmNJdGVyYXRvciA9IEFzeW5jSXRlcmF0b3I7CgogIGV4cG9ydHMuYXN5bmMgPSBmdW5jdGlvbiAoaW5uZXJGbiwgb3V0ZXJGbiwgc2VsZiwgdHJ5TG9jc0xpc3QsIFByb21pc2VJbXBsKSB7CiAgICBpZiAoUHJvbWlzZUltcGwgPT09IHZvaWQgMCkgUHJvbWlzZUltcGwgPSBQcm9taXNlOwogICAgdmFyIGl0ZXIgPSBuZXcgQXN5bmNJdGVyYXRvcih3cmFwKGlubmVyRm4sIG91dGVyRm4sIHNlbGYsIHRyeUxvY3NMaXN0KSwgUHJvbWlzZUltcGwpOwogICAgcmV0dXJuIGV4cG9ydHMuaXNHZW5lcmF0b3JGdW5jdGlvbihvdXRlckZuKSA/IGl0ZXIgOiBpdGVyLm5leHQoKS50aGVuKGZ1bmN0aW9uIChyZXN1bHQpIHsKICAgICAgcmV0dXJuIHJlc3VsdC5kb25lID8gcmVzdWx0LnZhbHVlIDogaXRlci5uZXh0KCk7CiAgICB9KTsKICB9OwoKICBmdW5jdGlvbiBtYWtlSW52b2tlTWV0aG9kKGlubmVyRm4sIHNlbGYsIGNvbnRleHQpIHsKICAgIHZhciBzdGF0ZSA9IEdlblN0YXRlU3VzcGVuZGVkU3RhcnQ7CiAgICByZXR1cm4gZnVuY3Rpb24gaW52b2tlKG1ldGhvZCwgYXJnKSB7CiAgICAgIGlmIChzdGF0ZSA9PT0gR2VuU3RhdGVFeGVjdXRpbmcpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkdlbmVyYXRvciBpcyBhbHJlYWR5IHJ1bm5pbmciKTsKICAgICAgfQoKICAgICAgaWYgKHN0YXRlID09PSBHZW5TdGF0ZUNvbXBsZXRlZCkgewogICAgICAgIGlmIChtZXRob2QgPT09ICJ0aHJvdyIpIHsKICAgICAgICAgIHRocm93IGFyZzsKICAgICAgICB9CgogICAgICAgIHJldHVybiBkb25lUmVzdWx0KCk7CiAgICAgIH0KCiAgICAgIGNvbnRleHQubWV0aG9kID0gbWV0aG9kOwogICAgICBjb250ZXh0LmFyZyA9IGFyZzsKCiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgdmFyIGRlbGVnYXRlID0gY29udGV4dC5kZWxlZ2F0ZTsKCiAgICAgICAgaWYgKGRlbGVnYXRlKSB7CiAgICAgICAgICB2YXIgZGVsZWdhdGVSZXN1bHQgPSBtYXliZUludm9rZURlbGVnYXRlKGRlbGVnYXRlLCBjb250ZXh0KTsKCiAgICAgICAgICBpZiAoZGVsZWdhdGVSZXN1bHQpIHsKICAgICAgICAgICAgaWYgKGRlbGVnYXRlUmVzdWx0ID09PSBDb250aW51ZVNlbnRpbmVsKSBjb250aW51ZTsKICAgICAgICAgICAgcmV0dXJuIGRlbGVnYXRlUmVzdWx0OwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbnRleHQubWV0aG9kID09PSAibmV4dCIpIHsKICAgICAgICAgIGNvbnRleHQuc2VudCA9IGNvbnRleHQuX3NlbnQgPSBjb250ZXh0LmFyZzsKICAgICAgICB9IGVsc2UgaWYgKGNvbnRleHQubWV0aG9kID09PSAidGhyb3ciKSB7CiAgICAgICAgICBpZiAoc3RhdGUgPT09IEdlblN0YXRlU3VzcGVuZGVkU3RhcnQpIHsKICAgICAgICAgICAgc3RhdGUgPSBHZW5TdGF0ZUNvbXBsZXRlZDsKICAgICAgICAgICAgdGhyb3cgY29udGV4dC5hcmc7CiAgICAgICAgICB9CgogICAgICAgICAgY29udGV4dC5kaXNwYXRjaEV4Y2VwdGlvbihjb250ZXh0LmFyZyk7CiAgICAgICAgfSBlbHNlIGlmIChjb250ZXh0Lm1ldGhvZCA9PT0gInJldHVybiIpIHsKICAgICAgICAgIGNvbnRleHQuYWJydXB0KCJyZXR1cm4iLCBjb250ZXh0LmFyZyk7CiAgICAgICAgfQoKICAgICAgICBzdGF0ZSA9IEdlblN0YXRlRXhlY3V0aW5nOwogICAgICAgIHZhciByZWNvcmQgPSB0cnlDYXRjaChpbm5lckZuLCBzZWxmLCBjb250ZXh0KTsKCiAgICAgICAgaWYgKHJlY29yZC50eXBlID09PSAibm9ybWFsIikgewogICAgICAgICAgc3RhdGUgPSBjb250ZXh0LmRvbmUgPyBHZW5TdGF0ZUNvbXBsZXRlZCA6IEdlblN0YXRlU3VzcGVuZGVkWWllbGQ7CgogICAgICAgICAgaWYgKHJlY29yZC5hcmcgPT09IENvbnRpbnVlU2VudGluZWwpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdmFsdWU6IHJlY29yZC5hcmcsCiAgICAgICAgICAgIGRvbmU6IGNvbnRleHQuZG9uZQogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgaWYgKHJlY29yZC50eXBlID09PSAidGhyb3ciKSB7CiAgICAgICAgICBzdGF0ZSA9IEdlblN0YXRlQ29tcGxldGVkOwogICAgICAgICAgY29udGV4dC5tZXRob2QgPSAidGhyb3ciOwogICAgICAgICAgY29udGV4dC5hcmcgPSByZWNvcmQuYXJnOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9CgogIGZ1bmN0aW9uIG1heWJlSW52b2tlRGVsZWdhdGUoZGVsZWdhdGUsIGNvbnRleHQpIHsKICAgIHZhciBtZXRob2QgPSBkZWxlZ2F0ZS5pdGVyYXRvcltjb250ZXh0Lm1ldGhvZF07CgogICAgaWYgKG1ldGhvZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGNvbnRleHQuZGVsZWdhdGUgPSBudWxsOwoKICAgICAgaWYgKGNvbnRleHQubWV0aG9kID09PSAidGhyb3ciKSB7CiAgICAgICAgaWYgKGRlbGVnYXRlLml0ZXJhdG9yWyJyZXR1cm4iXSkgewogICAgICAgICAgY29udGV4dC5tZXRob2QgPSAicmV0dXJuIjsKICAgICAgICAgIGNvbnRleHQuYXJnID0gdW5kZWZpbmVkOwogICAgICAgICAgbWF5YmVJbnZva2VEZWxlZ2F0ZShkZWxlZ2F0ZSwgY29udGV4dCk7CgogICAgICAgICAgaWYgKGNvbnRleHQubWV0aG9kID09PSAidGhyb3ciKSB7CiAgICAgICAgICAgIHJldHVybiBDb250aW51ZVNlbnRpbmVsOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY29udGV4dC5tZXRob2QgPSAidGhyb3ciOwogICAgICAgIGNvbnRleHQuYXJnID0gbmV3IFR5cGVFcnJvcigiVGhlIGl0ZXJhdG9yIGRvZXMgbm90IHByb3ZpZGUgYSAndGhyb3cnIG1ldGhvZCIpOwogICAgICB9CgogICAgICByZXR1cm4gQ29udGludWVTZW50aW5lbDsKICAgIH0KCiAgICB2YXIgcmVjb3JkID0gdHJ5Q2F0Y2gobWV0aG9kLCBkZWxlZ2F0ZS5pdGVyYXRvciwgY29udGV4dC5hcmcpOwoKICAgIGlmIChyZWNvcmQudHlwZSA9PT0gInRocm93IikgewogICAgICBjb250ZXh0Lm1ldGhvZCA9ICJ0aHJvdyI7CiAgICAgIGNvbnRleHQuYXJnID0gcmVjb3JkLmFyZzsKICAgICAgY29udGV4dC5kZWxlZ2F0ZSA9IG51bGw7CiAgICAgIHJldHVybiBDb250aW51ZVNlbnRpbmVsOwogICAgfQoKICAgIHZhciBpbmZvID0gcmVjb3JkLmFyZzsKCiAgICBpZiAoIWluZm8pIHsKICAgICAgY29udGV4dC5tZXRob2QgPSAidGhyb3ciOwogICAgICBjb250ZXh0LmFyZyA9IG5ldyBUeXBlRXJyb3IoIml0ZXJhdG9yIHJlc3VsdCBpcyBub3QgYW4gb2JqZWN0Iik7CiAgICAgIGNvbnRleHQuZGVsZWdhdGUgPSBudWxsOwogICAgICByZXR1cm4gQ29udGludWVTZW50aW5lbDsKICAgIH0KCiAgICBpZiAoaW5mby5kb25lKSB7CiAgICAgIGNvbnRleHRbZGVsZWdhdGUucmVzdWx0TmFtZV0gPSBpbmZvLnZhbHVlOwogICAgICBjb250ZXh0Lm5leHQgPSBkZWxlZ2F0ZS5uZXh0TG9jOwoKICAgICAgaWYgKGNvbnRleHQubWV0aG9kICE9PSAicmV0dXJuIikgewogICAgICAgIGNvbnRleHQubWV0aG9kID0gIm5leHQiOwogICAgICAgIGNvbnRleHQuYXJnID0gdW5kZWZpbmVkOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gaW5mbzsKICAgIH0KCiAgICBjb250ZXh0LmRlbGVnYXRlID0gbnVsbDsKICAgIHJldHVybiBDb250aW51ZVNlbnRpbmVsOwogIH0KCiAgZGVmaW5lSXRlcmF0b3JNZXRob2RzKEdwKTsKICBHcFt0b1N0cmluZ1RhZ1N5bWJvbF0gPSAiR2VuZXJhdG9yIjsKCiAgR3BbaXRlcmF0b3JTeW1ib2xdID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgR3AudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gIltvYmplY3QgR2VuZXJhdG9yXSI7CiAgfTsKCiAgZnVuY3Rpb24gcHVzaFRyeUVudHJ5KGxvY3MpIHsKICAgIHZhciBlbnRyeSA9IHsKICAgICAgdHJ5TG9jOiBsb2NzWzBdCiAgICB9OwoKICAgIGlmICgxIGluIGxvY3MpIHsKICAgICAgZW50cnkuY2F0Y2hMb2MgPSBsb2NzWzFdOwogICAgfQoKICAgIGlmICgyIGluIGxvY3MpIHsKICAgICAgZW50cnkuZmluYWxseUxvYyA9IGxvY3NbMl07CiAgICAgIGVudHJ5LmFmdGVyTG9jID0gbG9jc1szXTsKICAgIH0KCiAgICB0aGlzLnRyeUVudHJpZXMucHVzaChlbnRyeSk7CiAgfQoKICBmdW5jdGlvbiByZXNldFRyeUVudHJ5KGVudHJ5KSB7CiAgICB2YXIgcmVjb3JkID0gZW50cnkuY29tcGxldGlvbiB8fCB7fTsKICAgIHJlY29yZC50eXBlID0gIm5vcm1hbCI7CiAgICBkZWxldGUgcmVjb3JkLmFyZzsKICAgIGVudHJ5LmNvbXBsZXRpb24gPSByZWNvcmQ7CiAgfQoKICBmdW5jdGlvbiBDb250ZXh0KHRyeUxvY3NMaXN0KSB7CiAgICB0aGlzLnRyeUVudHJpZXMgPSBbewogICAgICB0cnlMb2M6ICJyb290IgogICAgfV07CiAgICB0cnlMb2NzTGlzdC5mb3JFYWNoKHB1c2hUcnlFbnRyeSwgdGhpcyk7CiAgICB0aGlzLnJlc2V0KHRydWUpOwogIH0KCiAgZXhwb3J0cy5rZXlzID0gZnVuY3Rpb24gKG9iamVjdCkgewogICAgdmFyIGtleXMgPSBbXTsKCiAgICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSB7CiAgICAgIGtleXMucHVzaChrZXkpOwogICAgfQoKICAgIGtleXMucmV2ZXJzZSgpOwogICAgcmV0dXJuIGZ1bmN0aW9uIG5leHQoKSB7CiAgICAgIHdoaWxlIChrZXlzLmxlbmd0aCkgewogICAgICAgIHZhciBrZXkgPSBrZXlzLnBvcCgpOwoKICAgICAgICBpZiAoa2V5IGluIG9iamVjdCkgewogICAgICAgICAgbmV4dC52YWx1ZSA9IGtleTsKICAgICAgICAgIG5leHQuZG9uZSA9IGZhbHNlOwogICAgICAgICAgcmV0dXJuIG5leHQ7CiAgICAgICAgfQogICAgICB9CgogICAgICBuZXh0LmRvbmUgPSB0cnVlOwogICAgICByZXR1cm4gbmV4dDsKICAgIH07CiAgfTsKCiAgZnVuY3Rpb24gdmFsdWVzKGl0ZXJhYmxlKSB7CiAgICBpZiAoaXRlcmFibGUpIHsKICAgICAgdmFyIGl0ZXJhdG9yTWV0aG9kID0gaXRlcmFibGVbaXRlcmF0b3JTeW1ib2xdOwoKICAgICAgaWYgKGl0ZXJhdG9yTWV0aG9kKSB7CiAgICAgICAgcmV0dXJuIGl0ZXJhdG9yTWV0aG9kLmNhbGwoaXRlcmFibGUpOwogICAgICB9CgogICAgICBpZiAodHlwZW9mIGl0ZXJhYmxlLm5leHQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICByZXR1cm4gaXRlcmFibGU7CiAgICAgIH0KCiAgICAgIGlmICghaXNOYU4oaXRlcmFibGUubGVuZ3RoKSkgewogICAgICAgIHZhciBpID0gLTEsCiAgICAgICAgICAgIG5leHQgPSBmdW5jdGlvbiBuZXh0KCkgewogICAgICAgICAgd2hpbGUgKCsraSA8IGl0ZXJhYmxlLmxlbmd0aCkgewogICAgICAgICAgICBpZiAoaGFzT3duLmNhbGwoaXRlcmFibGUsIGkpKSB7CiAgICAgICAgICAgICAgbmV4dC52YWx1ZSA9IGl0ZXJhYmxlW2ldOwogICAgICAgICAgICAgIG5leHQuZG9uZSA9IGZhbHNlOwogICAgICAgICAgICAgIHJldHVybiBuZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgbmV4dC52YWx1ZSA9IHVuZGVmaW5lZDsKICAgICAgICAgIG5leHQuZG9uZSA9IHRydWU7CiAgICAgICAgICByZXR1cm4gbmV4dDsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gbmV4dC5uZXh0ID0gbmV4dDsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB7CiAgICAgIG5leHQ6IGRvbmVSZXN1bHQKICAgIH07CiAgfQoKICBleHBvcnRzLnZhbHVlcyA9IHZhbHVlczsKCiAgZnVuY3Rpb24gZG9uZVJlc3VsdCgpIHsKICAgIHJldHVybiB7CiAgICAgIHZhbHVlOiB1bmRlZmluZWQsCiAgICAgIGRvbmU6IHRydWUKICAgIH07CiAgfQoKICBDb250ZXh0LnByb3RvdHlwZSA9IHsKICAgIGNvbnN0cnVjdG9yOiBDb250ZXh0LAogICAgcmVzZXQ6IGZ1bmN0aW9uIHJlc2V0KHNraXBUZW1wUmVzZXQpIHsKICAgICAgdGhpcy5wcmV2ID0gMDsKICAgICAgdGhpcy5uZXh0ID0gMDsKICAgICAgdGhpcy5zZW50ID0gdGhpcy5fc2VudCA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5kb25lID0gZmFsc2U7CiAgICAgIHRoaXMuZGVsZWdhdGUgPSBudWxsOwogICAgICB0aGlzLm1ldGhvZCA9ICJuZXh0IjsKICAgICAgdGhpcy5hcmcgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMudHJ5RW50cmllcy5mb3JFYWNoKHJlc2V0VHJ5RW50cnkpOwoKICAgICAgaWYgKCFza2lwVGVtcFJlc2V0KSB7CiAgICAgICAgZm9yICh2YXIgbmFtZSBpbiB0aGlzKSB7CiAgICAgICAgICBpZiAobmFtZS5jaGFyQXQoMCkgPT09ICJ0IiAmJiBoYXNPd24uY2FsbCh0aGlzLCBuYW1lKSAmJiAhaXNOYU4oK25hbWUuc2xpY2UoMSkpKSB7CiAgICAgICAgICAgIHRoaXNbbmFtZV0gPSB1bmRlZmluZWQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgc3RvcDogZnVuY3Rpb24gc3RvcCgpIHsKICAgICAgdGhpcy5kb25lID0gdHJ1ZTsKICAgICAgdmFyIHJvb3RFbnRyeSA9IHRoaXMudHJ5RW50cmllc1swXTsKICAgICAgdmFyIHJvb3RSZWNvcmQgPSByb290RW50cnkuY29tcGxldGlvbjsKCiAgICAgIGlmIChyb290UmVjb3JkLnR5cGUgPT09ICJ0aHJvdyIpIHsKICAgICAgICB0aHJvdyByb290UmVjb3JkLmFyZzsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMucnZhbDsKICAgIH0sCiAgICBkaXNwYXRjaEV4Y2VwdGlvbjogZnVuY3Rpb24gZGlzcGF0Y2hFeGNlcHRpb24oZXhjZXB0aW9uKSB7CiAgICAgIGlmICh0aGlzLmRvbmUpIHsKICAgICAgICB0aHJvdyBleGNlcHRpb247CiAgICAgIH0KCiAgICAgIHZhciBjb250ZXh0ID0gdGhpczsKCiAgICAgIGZ1bmN0aW9uIGhhbmRsZShsb2MsIGNhdWdodCkgewogICAgICAgIHJlY29yZC50eXBlID0gInRocm93IjsKICAgICAgICByZWNvcmQuYXJnID0gZXhjZXB0aW9uOwogICAgICAgIGNvbnRleHQubmV4dCA9IGxvYzsKCiAgICAgICAgaWYgKGNhdWdodCkgewogICAgICAgICAgY29udGV4dC5tZXRob2QgPSAibmV4dCI7CiAgICAgICAgICBjb250ZXh0LmFyZyA9IHVuZGVmaW5lZDsKICAgICAgICB9CgogICAgICAgIHJldHVybiAhIWNhdWdodDsKICAgICAgfQoKICAgICAgZm9yICh2YXIgaSA9IHRoaXMudHJ5RW50cmllcy5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgICAgIHZhciBlbnRyeSA9IHRoaXMudHJ5RW50cmllc1tpXTsKICAgICAgICB2YXIgcmVjb3JkID0gZW50cnkuY29tcGxldGlvbjsKCiAgICAgICAgaWYgKGVudHJ5LnRyeUxvYyA9PT0gInJvb3QiKSB7CiAgICAgICAgICByZXR1cm4gaGFuZGxlKCJlbmQiKTsKICAgICAgICB9CgogICAgICAgIGlmIChlbnRyeS50cnlMb2MgPD0gdGhpcy5wcmV2KSB7CiAgICAgICAgICB2YXIgaGFzQ2F0Y2ggPSBoYXNPd24uY2FsbChlbnRyeSwgImNhdGNoTG9jIik7CiAgICAgICAgICB2YXIgaGFzRmluYWxseSA9IGhhc093bi5jYWxsKGVudHJ5LCAiZmluYWxseUxvYyIpOwoKICAgICAgICAgIGlmIChoYXNDYXRjaCAmJiBoYXNGaW5hbGx5KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnByZXYgPCBlbnRyeS5jYXRjaExvYykgewogICAgICAgICAgICAgIHJldHVybiBoYW5kbGUoZW50cnkuY2F0Y2hMb2MsIHRydWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMucHJldiA8IGVudHJ5LmZpbmFsbHlMb2MpIHsKICAgICAgICAgICAgICByZXR1cm4gaGFuZGxlKGVudHJ5LmZpbmFsbHlMb2MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGhhc0NhdGNoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnByZXYgPCBlbnRyeS5jYXRjaExvYykgewogICAgICAgICAgICAgIHJldHVybiBoYW5kbGUoZW50cnkuY2F0Y2hMb2MsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGhhc0ZpbmFsbHkpIHsKICAgICAgICAgICAgaWYgKHRoaXMucHJldiA8IGVudHJ5LmZpbmFsbHlMb2MpIHsKICAgICAgICAgICAgICByZXR1cm4gaGFuZGxlKGVudHJ5LmZpbmFsbHlMb2MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInRyeSBzdGF0ZW1lbnQgd2l0aG91dCBjYXRjaCBvciBmaW5hbGx5Iik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgYWJydXB0OiBmdW5jdGlvbiBhYnJ1cHQodHlwZSwgYXJnKSB7CiAgICAgIGZvciAodmFyIGkgPSB0aGlzLnRyeUVudHJpZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICB2YXIgZW50cnkgPSB0aGlzLnRyeUVudHJpZXNbaV07CgogICAgICAgIGlmIChlbnRyeS50cnlMb2MgPD0gdGhpcy5wcmV2ICYmIGhhc093bi5jYWxsKGVudHJ5LCAiZmluYWxseUxvYyIpICYmIHRoaXMucHJldiA8IGVudHJ5LmZpbmFsbHlMb2MpIHsKICAgICAgICAgIHZhciBmaW5hbGx5RW50cnkgPSBlbnRyeTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGZpbmFsbHlFbnRyeSAmJiAodHlwZSA9PT0gImJyZWFrIiB8fCB0eXBlID09PSAiY29udGludWUiKSAmJiBmaW5hbGx5RW50cnkudHJ5TG9jIDw9IGFyZyAmJiBhcmcgPD0gZmluYWxseUVudHJ5LmZpbmFsbHlMb2MpIHsKICAgICAgICBmaW5hbGx5RW50cnkgPSBudWxsOwogICAgICB9CgogICAgICB2YXIgcmVjb3JkID0gZmluYWxseUVudHJ5ID8gZmluYWxseUVudHJ5LmNvbXBsZXRpb24gOiB7fTsKICAgICAgcmVjb3JkLnR5cGUgPSB0eXBlOwogICAgICByZWNvcmQuYXJnID0gYXJnOwoKICAgICAgaWYgKGZpbmFsbHlFbnRyeSkgewogICAgICAgIHRoaXMubWV0aG9kID0gIm5leHQiOwogICAgICAgIHRoaXMubmV4dCA9IGZpbmFsbHlFbnRyeS5maW5hbGx5TG9jOwogICAgICAgIHJldHVybiBDb250aW51ZVNlbnRpbmVsOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5jb21wbGV0ZShyZWNvcmQpOwogICAgfSwKICAgIGNvbXBsZXRlOiBmdW5jdGlvbiBjb21wbGV0ZShyZWNvcmQsIGFmdGVyTG9jKSB7CiAgICAgIGlmIChyZWNvcmQudHlwZSA9PT0gInRocm93IikgewogICAgICAgIHRocm93IHJlY29yZC5hcmc7CiAgICAgIH0KCiAgICAgIGlmIChyZWNvcmQudHlwZSA9PT0gImJyZWFrIiB8fCByZWNvcmQudHlwZSA9PT0gImNvbnRpbnVlIikgewogICAgICAgIHRoaXMubmV4dCA9IHJlY29yZC5hcmc7CiAgICAgIH0gZWxzZSBpZiAocmVjb3JkLnR5cGUgPT09ICJyZXR1cm4iKSB7CiAgICAgICAgdGhpcy5ydmFsID0gdGhpcy5hcmcgPSByZWNvcmQuYXJnOwogICAgICAgIHRoaXMubWV0aG9kID0gInJldHVybiI7CiAgICAgICAgdGhpcy5uZXh0ID0gImVuZCI7CiAgICAgIH0gZWxzZSBpZiAocmVjb3JkLnR5cGUgPT09ICJub3JtYWwiICYmIGFmdGVyTG9jKSB7CiAgICAgICAgdGhpcy5uZXh0ID0gYWZ0ZXJMb2M7CiAgICAgIH0KCiAgICAgIHJldHVybiBDb250aW51ZVNlbnRpbmVsOwogICAgfSwKICAgIGZpbmlzaDogZnVuY3Rpb24gZmluaXNoKGZpbmFsbHlMb2MpIHsKICAgICAgZm9yICh2YXIgaSA9IHRoaXMudHJ5RW50cmllcy5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgICAgIHZhciBlbnRyeSA9IHRoaXMudHJ5RW50cmllc1tpXTsKCiAgICAgICAgaWYgKGVudHJ5LmZpbmFsbHlMb2MgPT09IGZpbmFsbHlMb2MpIHsKICAgICAgICAgIHRoaXMuY29tcGxldGUoZW50cnkuY29tcGxldGlvbiwgZW50cnkuYWZ0ZXJMb2MpOwogICAgICAgICAgcmVzZXRUcnlFbnRyeShlbnRyeSk7CiAgICAgICAgICByZXR1cm4gQ29udGludWVTZW50aW5lbDsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiY2F0Y2giOiBmdW5jdGlvbiBfY2F0Y2godHJ5TG9jKSB7CiAgICAgIGZvciAodmFyIGkgPSB0aGlzLnRyeUVudHJpZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICB2YXIgZW50cnkgPSB0aGlzLnRyeUVudHJpZXNbaV07CgogICAgICAgIGlmIChlbnRyeS50cnlMb2MgPT09IHRyeUxvYykgewogICAgICAgICAgdmFyIHJlY29yZCA9IGVudHJ5LmNvbXBsZXRpb247CgogICAgICAgICAgaWYgKHJlY29yZC50eXBlID09PSAidGhyb3ciKSB7CiAgICAgICAgICAgIHZhciB0aHJvd24gPSByZWNvcmQuYXJnOwogICAgICAgICAgICByZXNldFRyeUVudHJ5KGVudHJ5KTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gdGhyb3duOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhyb3cgbmV3IEVycm9yKCJpbGxlZ2FsIGNhdGNoIGF0dGVtcHQiKTsKICAgIH0sCiAgICBkZWxlZ2F0ZVlpZWxkOiBmdW5jdGlvbiBkZWxlZ2F0ZVlpZWxkKGl0ZXJhYmxlLCByZXN1bHROYW1lLCBuZXh0TG9jKSB7CiAgICAgIHRoaXMuZGVsZWdhdGUgPSB7CiAgICAgICAgaXRlcmF0b3I6IHZhbHVlcyhpdGVyYWJsZSksCiAgICAgICAgcmVzdWx0TmFtZTogcmVzdWx0TmFtZSwKICAgICAgICBuZXh0TG9jOiBuZXh0TG9jCiAgICAgIH07CgogICAgICBpZiAodGhpcy5tZXRob2QgPT09ICJuZXh0IikgewogICAgICAgIHRoaXMuYXJnID0gdW5kZWZpbmVkOwogICAgICB9CgogICAgICByZXR1cm4gQ29udGludWVTZW50aW5lbDsKICAgIH0KICB9OwogIHJldHVybiBleHBvcnRzOwp9KCggZmFsc2UgPyB1bmRlZmluZWQgOiBfdHlwZW9mKG1vZHVsZSkpID09PSAib2JqZWN0IiA/IG1vZHVsZS5leHBvcnRzIDoge30pOwoKdHJ5IHsKICByZWdlbmVyYXRvclJ1bnRpbWUgPSBydW50aW1lOwp9IGNhdGNoIChhY2NpZGVudGFsU3RyaWN0TW9kZSkgewogIEZ1bmN0aW9uKCJyIiwgInJlZ2VuZXJhdG9yUnVudGltZSA9IHIiKShydW50aW1lKTsKfQovKiBXRUJQQUNLIFZBUiBJTkpFQ1RJT04gKi99LmNhbGwodGhpcywgX193ZWJwYWNrX3JlcXVpcmVfXyg0KShtb2R1bGUpKSkKCi8qKiovIH0pLAovKiA0ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChtb2R1bGUpIHsKICBpZiAoIW1vZHVsZS53ZWJwYWNrUG9seWZpbGwpIHsKICAgIG1vZHVsZS5kZXByZWNhdGUgPSBmdW5jdGlvbiAoKSB7fTsKCiAgICBtb2R1bGUucGF0aHMgPSBbXTsKICAgIGlmICghbW9kdWxlLmNoaWxkcmVuKSBtb2R1bGUuY2hpbGRyZW4gPSBbXTsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShtb2R1bGUsICJsb2FkZWQiLCB7CiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiBtb2R1bGUubDsKICAgICAgfQogICAgfSk7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobW9kdWxlLCAiaWQiLCB7CiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiBtb2R1bGUuaTsKICAgICAgfQogICAgfSk7CiAgICBtb2R1bGUud2VicGFja1BvbHlmaWxsID0gMTsKICB9CgogIHJldHVybiBtb2R1bGU7Cn07CgovKioqLyB9KSwKLyogNSAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoidXNlIHN0cmljdCI7CgoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLmlzVmFsaWRSb3RhdGlvbiA9IGlzVmFsaWRSb3RhdGlvbjsKZXhwb3J0cy5pc1ZhbGlkU2Nyb2xsTW9kZSA9IGlzVmFsaWRTY3JvbGxNb2RlOwpleHBvcnRzLmlzVmFsaWRTcHJlYWRNb2RlID0gaXNWYWxpZFNwcmVhZE1vZGU7CmV4cG9ydHMuaXNQb3J0cmFpdE9yaWVudGF0aW9uID0gaXNQb3J0cmFpdE9yaWVudGF0aW9uOwpleHBvcnRzLmNsYW1wID0gY2xhbXA7CmV4cG9ydHMuZ2V0UERGRmlsZU5hbWVGcm9tVVJMID0gZ2V0UERGRmlsZU5hbWVGcm9tVVJMOwpleHBvcnRzLm5vQ29udGV4dE1lbnVIYW5kbGVyID0gbm9Db250ZXh0TWVudUhhbmRsZXI7CmV4cG9ydHMucGFyc2VRdWVyeVN0cmluZyA9IHBhcnNlUXVlcnlTdHJpbmc7CmV4cG9ydHMuYmFja3RyYWNrQmVmb3JlQWxsVmlzaWJsZUVsZW1lbnRzID0gYmFja3RyYWNrQmVmb3JlQWxsVmlzaWJsZUVsZW1lbnRzOwpleHBvcnRzLmdldFZpc2libGVFbGVtZW50cyA9IGdldFZpc2libGVFbGVtZW50czsKZXhwb3J0cy5yb3VuZFRvRGl2aWRlID0gcm91bmRUb0RpdmlkZTsKZXhwb3J0cy5nZXRQYWdlU2l6ZUluY2hlcyA9IGdldFBhZ2VTaXplSW5jaGVzOwpleHBvcnRzLmFwcHJveGltYXRlRnJhY3Rpb24gPSBhcHByb3hpbWF0ZUZyYWN0aW9uOwpleHBvcnRzLmdldE91dHB1dFNjYWxlID0gZ2V0T3V0cHV0U2NhbGU7CmV4cG9ydHMuc2Nyb2xsSW50b1ZpZXcgPSBzY3JvbGxJbnRvVmlldzsKZXhwb3J0cy53YXRjaFNjcm9sbCA9IHdhdGNoU2Nyb2xsOwpleHBvcnRzLmJpbmFyeVNlYXJjaEZpcnN0SXRlbSA9IGJpbmFyeVNlYXJjaEZpcnN0SXRlbTsKZXhwb3J0cy5ub3JtYWxpemVXaGVlbEV2ZW50RGVsdGEgPSBub3JtYWxpemVXaGVlbEV2ZW50RGVsdGE7CmV4cG9ydHMud2FpdE9uRXZlbnRPclRpbWVvdXQgPSB3YWl0T25FdmVudE9yVGltZW91dDsKZXhwb3J0cy5tb3ZlVG9FbmRPZkFycmF5ID0gbW92ZVRvRW5kT2ZBcnJheTsKZXhwb3J0cy5XYWl0T25UeXBlID0gZXhwb3J0cy5hbmltYXRpb25TdGFydGVkID0gZXhwb3J0cy5Qcm9ncmVzc0JhciA9IGV4cG9ydHMuRXZlbnRCdXMgPSBleHBvcnRzLk51bGxMMTBuID0gZXhwb3J0cy5TcHJlYWRNb2RlID0gZXhwb3J0cy5TY3JvbGxNb2RlID0gZXhwb3J0cy5UZXh0TGF5ZXJNb2RlID0gZXhwb3J0cy5SZW5kZXJlclR5cGUgPSBleHBvcnRzLlByZXNlbnRhdGlvbk1vZGVTdGF0ZSA9IGV4cG9ydHMuVkVSVElDQUxfUEFERElORyA9IGV4cG9ydHMuU0NST0xMQkFSX1BBRERJTkcgPSBleHBvcnRzLk1BWF9BVVRPX1NDQUxFID0gZXhwb3J0cy5VTktOT1dOX1NDQUxFID0gZXhwb3J0cy5NQVhfU0NBTEUgPSBleHBvcnRzLk1JTl9TQ0FMRSA9IGV4cG9ydHMuREVGQVVMVF9TQ0FMRSA9IGV4cG9ydHMuREVGQVVMVF9TQ0FMRV9WQUxVRSA9IGV4cG9ydHMuQ1NTX1VOSVRTID0gZXhwb3J0cy5BdXRvUHJpbnRSZWdFeHAgPSB2b2lkIDA7Cgp2YXIgX3JlZ2VuZXJhdG9yID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfX3dlYnBhY2tfcmVxdWlyZV9fKDIpKTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ICJkZWZhdWx0Ijogb2JqIH07IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7IH0gfQoKZnVuY3Rpb24gX2RlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoInZhbHVlIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0KCmZ1bmN0aW9uIF9jcmVhdGVDbGFzcyhDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9CgpmdW5jdGlvbiBfdHlwZW9mKG9iaikgeyAiQGJhYmVsL2hlbHBlcnMgLSB0eXBlb2YiOyBpZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgU3ltYm9sLml0ZXJhdG9yID09PSAic3ltYm9sIikgeyBfdHlwZW9mID0gZnVuY3Rpb24gX3R5cGVvZihvYmopIHsgcmV0dXJuIHR5cGVvZiBvYmo7IH07IH0gZWxzZSB7IF90eXBlb2YgPSBmdW5jdGlvbiBfdHlwZW9mKG9iaikgeyByZXR1cm4gb2JqICYmIHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgb2JqLmNvbnN0cnVjdG9yID09PSBTeW1ib2wgJiYgb2JqICE9PSBTeW1ib2wucHJvdG90eXBlID8gInN5bWJvbCIgOiB0eXBlb2Ygb2JqOyB9OyB9IHJldHVybiBfdHlwZW9mKG9iaik7IH0KCmZ1bmN0aW9uIF9zbGljZWRUb0FycmF5KGFyciwgaSkgeyByZXR1cm4gX2FycmF5V2l0aEhvbGVzKGFycikgfHwgX2l0ZXJhYmxlVG9BcnJheUxpbWl0KGFyciwgaSkgfHwgX3Vuc3VwcG9ydGVkSXRlcmFibGVUb0FycmF5KGFyciwgaSkgfHwgX25vbkl0ZXJhYmxlUmVzdCgpOyB9CgpmdW5jdGlvbiBfbm9uSXRlcmFibGVSZXN0KCkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJJbnZhbGlkIGF0dGVtcHQgdG8gZGVzdHJ1Y3R1cmUgbm9uLWl0ZXJhYmxlIGluc3RhbmNlLlxuSW4gb3JkZXIgdG8gYmUgaXRlcmFibGUsIG5vbi1hcnJheSBvYmplY3RzIG11c3QgaGF2ZSBhIFtTeW1ib2wuaXRlcmF0b3JdKCkgbWV0aG9kLiIpOyB9CgpmdW5jdGlvbiBfdW5zdXBwb3J0ZWRJdGVyYWJsZVRvQXJyYXkobywgbWluTGVuKSB7IGlmICghbykgcmV0dXJuOyBpZiAodHlwZW9mIG8gPT09ICJzdHJpbmciKSByZXR1cm4gX2FycmF5TGlrZVRvQXJyYXkobywgbWluTGVuKTsgdmFyIG4gPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwobykuc2xpY2UoOCwgLTEpOyBpZiAobiA9PT0gIk9iamVjdCIgJiYgby5jb25zdHJ1Y3RvcikgbiA9IG8uY29uc3RydWN0b3IubmFtZTsgaWYgKG4gPT09ICJNYXAiIHx8IG4gPT09ICJTZXQiKSByZXR1cm4gQXJyYXkuZnJvbShvKTsgaWYgKG4gPT09ICJBcmd1bWVudHMiIHx8IC9eKD86VWl8SSludCg/Ojh8MTZ8MzIpKD86Q2xhbXBlZCk/QXJyYXkkLy50ZXN0KG4pKSByZXR1cm4gX2FycmF5TGlrZVRvQXJyYXkobywgbWluTGVuKTsgfQoKZnVuY3Rpb24gX2FycmF5TGlrZVRvQXJyYXkoYXJyLCBsZW4pIHsgaWYgKGxlbiA9PSBudWxsIHx8IGxlbiA+IGFyci5sZW5ndGgpIGxlbiA9IGFyci5sZW5ndGg7IGZvciAodmFyIGkgPSAwLCBhcnIyID0gbmV3IEFycmF5KGxlbik7IGkgPCBsZW47IGkrKykgeyBhcnIyW2ldID0gYXJyW2ldOyB9IHJldHVybiBhcnIyOyB9CgpmdW5jdGlvbiBfaXRlcmFibGVUb0FycmF5TGltaXQoYXJyLCBpKSB7IGlmICh0eXBlb2YgU3ltYm9sID09PSAidW5kZWZpbmVkIiB8fCAhKFN5bWJvbC5pdGVyYXRvciBpbiBPYmplY3QoYXJyKSkpIHJldHVybjsgdmFyIF9hcnIgPSBbXTsgdmFyIF9uID0gdHJ1ZTsgdmFyIF9kID0gZmFsc2U7IHZhciBfZSA9IHVuZGVmaW5lZDsgdHJ5IHsgZm9yICh2YXIgX2kgPSBhcnJbU3ltYm9sLml0ZXJhdG9yXSgpLCBfczsgIShfbiA9IChfcyA9IF9pLm5leHQoKSkuZG9uZSk7IF9uID0gdHJ1ZSkgeyBfYXJyLnB1c2goX3MudmFsdWUpOyBpZiAoaSAmJiBfYXJyLmxlbmd0aCA9PT0gaSkgYnJlYWs7IH0gfSBjYXRjaCAoZXJyKSB7IF9kID0gdHJ1ZTsgX2UgPSBlcnI7IH0gZmluYWxseSB7IHRyeSB7IGlmICghX24gJiYgX2lbInJldHVybiJdICE9IG51bGwpIF9pWyJyZXR1cm4iXSgpOyB9IGZpbmFsbHkgeyBpZiAoX2QpIHRocm93IF9lOyB9IH0gcmV0dXJuIF9hcnI7IH0KCmZ1bmN0aW9uIF9hcnJheVdpdGhIb2xlcyhhcnIpIHsgaWYgKEFycmF5LmlzQXJyYXkoYXJyKSkgcmV0dXJuIGFycjsgfQoKZnVuY3Rpb24gYXN5bmNHZW5lcmF0b3JTdGVwKGdlbiwgcmVzb2x2ZSwgcmVqZWN0LCBfbmV4dCwgX3Rocm93LCBrZXksIGFyZykgeyB0cnkgeyB2YXIgaW5mbyA9IGdlbltrZXldKGFyZyk7IHZhciB2YWx1ZSA9IGluZm8udmFsdWU7IH0gY2F0Y2ggKGVycm9yKSB7IHJlamVjdChlcnJvcik7IHJldHVybjsgfSBpZiAoaW5mby5kb25lKSB7IHJlc29sdmUodmFsdWUpOyB9IGVsc2UgeyBQcm9taXNlLnJlc29sdmUodmFsdWUpLnRoZW4oX25leHQsIF90aHJvdyk7IH0gfQoKZnVuY3Rpb24gX2FzeW5jVG9HZW5lcmF0b3IoZm4pIHsgcmV0dXJuIGZ1bmN0aW9uICgpIHsgdmFyIHNlbGYgPSB0aGlzLCBhcmdzID0gYXJndW1lbnRzOyByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgeyB2YXIgZ2VuID0gZm4uYXBwbHkoc2VsZiwgYXJncyk7IGZ1bmN0aW9uIF9uZXh0KHZhbHVlKSB7IGFzeW5jR2VuZXJhdG9yU3RlcChnZW4sIHJlc29sdmUsIHJlamVjdCwgX25leHQsIF90aHJvdywgIm5leHQiLCB2YWx1ZSk7IH0gZnVuY3Rpb24gX3Rocm93KGVycikgeyBhc3luY0dlbmVyYXRvclN0ZXAoZ2VuLCByZXNvbHZlLCByZWplY3QsIF9uZXh0LCBfdGhyb3csICJ0aHJvdyIsIGVycik7IH0gX25leHQodW5kZWZpbmVkKTsgfSk7IH07IH0KCnZhciBDU1NfVU5JVFMgPSA5Ni4wIC8gNzIuMDsKZXhwb3J0cy5DU1NfVU5JVFMgPSBDU1NfVU5JVFM7CnZhciBERUZBVUxUX1NDQUxFX1ZBTFVFID0gImF1dG8iOwpleHBvcnRzLkRFRkFVTFRfU0NBTEVfVkFMVUUgPSBERUZBVUxUX1NDQUxFX1ZBTFVFOwp2YXIgREVGQVVMVF9TQ0FMRSA9IDEuMDsKZXhwb3J0cy5ERUZBVUxUX1NDQUxFID0gREVGQVVMVF9TQ0FMRTsKdmFyIE1JTl9TQ0FMRSA9IDAuMTsKZXhwb3J0cy5NSU5fU0NBTEUgPSBNSU5fU0NBTEU7CnZhciBNQVhfU0NBTEUgPSAxMC4wOwpleHBvcnRzLk1BWF9TQ0FMRSA9IE1BWF9TQ0FMRTsKdmFyIFVOS05PV05fU0NBTEUgPSAwOwpleHBvcnRzLlVOS05PV05fU0NBTEUgPSBVTktOT1dOX1NDQUxFOwp2YXIgTUFYX0FVVE9fU0NBTEUgPSAxLjI1OwpleHBvcnRzLk1BWF9BVVRPX1NDQUxFID0gTUFYX0FVVE9fU0NBTEU7CnZhciBTQ1JPTExCQVJfUEFERElORyA9IDQwOwpleHBvcnRzLlNDUk9MTEJBUl9QQURESU5HID0gU0NST0xMQkFSX1BBRERJTkc7CnZhciBWRVJUSUNBTF9QQURESU5HID0gNTsKZXhwb3J0cy5WRVJUSUNBTF9QQURESU5HID0gVkVSVElDQUxfUEFERElORzsKdmFyIFByZXNlbnRhdGlvbk1vZGVTdGF0ZSA9IHsKICBVTktOT1dOOiAwLAogIE5PUk1BTDogMSwKICBDSEFOR0lORzogMiwKICBGVUxMU0NSRUVOOiAzCn07CmV4cG9ydHMuUHJlc2VudGF0aW9uTW9kZVN0YXRlID0gUHJlc2VudGF0aW9uTW9kZVN0YXRlOwp2YXIgUmVuZGVyZXJUeXBlID0gewogIENBTlZBUzogImNhbnZhcyIsCiAgU1ZHOiAic3ZnIgp9OwpleHBvcnRzLlJlbmRlcmVyVHlwZSA9IFJlbmRlcmVyVHlwZTsKdmFyIFRleHRMYXllck1vZGUgPSB7CiAgRElTQUJMRTogMCwKICBFTkFCTEU6IDEsCiAgRU5BQkxFX0VOSEFOQ0U6IDIKfTsKZXhwb3J0cy5UZXh0TGF5ZXJNb2RlID0gVGV4dExheWVyTW9kZTsKdmFyIFNjcm9sbE1vZGUgPSB7CiAgVU5LTk9XTjogLTEsCiAgVkVSVElDQUw6IDAsCiAgSE9SSVpPTlRBTDogMSwKICBXUkFQUEVEOiAyCn07CmV4cG9ydHMuU2Nyb2xsTW9kZSA9IFNjcm9sbE1vZGU7CnZhciBTcHJlYWRNb2RlID0gewogIFVOS05PV046IC0xLAogIE5PTkU6IDAsCiAgT0REOiAxLAogIEVWRU46IDIKfTsKZXhwb3J0cy5TcHJlYWRNb2RlID0gU3ByZWFkTW9kZTsKdmFyIEF1dG9QcmludFJlZ0V4cCA9IC9cYnByaW50XHMqXCgvOwpleHBvcnRzLkF1dG9QcmludFJlZ0V4cCA9IEF1dG9QcmludFJlZ0V4cDsKCmZ1bmN0aW9uIGZvcm1hdEwxMG5WYWx1ZSh0ZXh0LCBhcmdzKSB7CiAgaWYgKCFhcmdzKSB7CiAgICByZXR1cm4gdGV4dDsKICB9CgogIHJldHVybiB0ZXh0LnJlcGxhY2UoL1x7XHtccyooXHcrKVxzKlx9XH0vZywgZnVuY3Rpb24gKGFsbCwgbmFtZSkgewogICAgcmV0dXJuIG5hbWUgaW4gYXJncyA/IGFyZ3NbbmFtZV0gOiAie3siICsgbmFtZSArICJ9fSI7CiAgfSk7Cn0KCnZhciBOdWxsTDEwbiA9IHsKICBnZXRMYW5ndWFnZTogZnVuY3Rpb24gZ2V0TGFuZ3VhZ2UoKSB7CiAgICByZXR1cm4gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JbImRlZmF1bHQiXS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUoKSB7CiAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JbImRlZmF1bHQiXS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUkKF9jb250ZXh0KSB7CiAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQucHJldiA9IF9jb250ZXh0Lm5leHQpIHsKICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5hYnJ1cHQoInJldHVybiIsICJlbi11cyIpOwoKICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5zdG9wKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCBfY2FsbGVlKTsKICAgIH0pKSgpOwogIH0sCiAgZ2V0RGlyZWN0aW9uOiBmdW5jdGlvbiBnZXREaXJlY3Rpb24oKSB7CiAgICByZXR1cm4gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JbImRlZmF1bHQiXS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUyKCkgewogICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ud3JhcChmdW5jdGlvbiBfY2FsbGVlMiQoX2NvbnRleHQyKSB7CiAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQyLnByZXYgPSBfY29udGV4dDIubmV4dCkgewogICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Mi5hYnJ1cHQoInJldHVybiIsICJsdHIiKTsKCiAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyLnN0b3AoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIF9jYWxsZWUyKTsKICAgIH0pKSgpOwogIH0sCiAgZ2V0OiBmdW5jdGlvbiBnZXQocHJvcGVydHksIGFyZ3MsIGZhbGxiYWNrKSB7CiAgICByZXR1cm4gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JbImRlZmF1bHQiXS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUzKCkgewogICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ud3JhcChmdW5jdGlvbiBfY2FsbGVlMyQoX2NvbnRleHQzKSB7CiAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQzLnByZXYgPSBfY29udGV4dDMubmV4dCkgewogICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0My5hYnJ1cHQoInJldHVybiIsIGZvcm1hdEwxMG5WYWx1ZShmYWxsYmFjaywgYXJncykpOwoKICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMuc3RvcCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwgX2NhbGxlZTMpOwogICAgfSkpKCk7CiAgfSwKICB0cmFuc2xhdGU6IGZ1bmN0aW9uIHRyYW5zbGF0ZShlbGVtZW50KSB7CiAgICByZXR1cm4gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JbImRlZmF1bHQiXS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU0KCkgewogICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ud3JhcChmdW5jdGlvbiBfY2FsbGVlNCQoX2NvbnRleHQ0KSB7CiAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ0LnByZXYgPSBfY29udGV4dDQubmV4dCkgewogICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NC5zdG9wKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCBfY2FsbGVlNCk7CiAgICB9KSkoKTsKICB9Cn07CmV4cG9ydHMuTnVsbEwxMG4gPSBOdWxsTDEwbjsKCmZ1bmN0aW9uIGdldE91dHB1dFNjYWxlKGN0eCkgewogIHZhciBkZXZpY2VQaXhlbFJhdGlvID0gd2luZG93LmRldmljZVBpeGVsUmF0aW8gfHwgMTsKICB2YXIgYmFja2luZ1N0b3JlUmF0aW8gPSBjdHgud2Via2l0QmFja2luZ1N0b3JlUGl4ZWxSYXRpbyB8fCBjdHgubW96QmFja2luZ1N0b3JlUGl4ZWxSYXRpbyB8fCBjdHgubXNCYWNraW5nU3RvcmVQaXhlbFJhdGlvIHx8IGN0eC5vQmFja2luZ1N0b3JlUGl4ZWxSYXRpbyB8fCBjdHguYmFja2luZ1N0b3JlUGl4ZWxSYXRpbyB8fCAxOwogIHZhciBwaXhlbFJhdGlvID0gZGV2aWNlUGl4ZWxSYXRpbyAvIGJhY2tpbmdTdG9yZVJhdGlvOwogIHJldHVybiB7CiAgICBzeDogcGl4ZWxSYXRpbywKICAgIHN5OiBwaXhlbFJhdGlvLAogICAgc2NhbGVkOiBwaXhlbFJhdGlvICE9PSAxCiAgfTsKfQoKZnVuY3Rpb24gc2Nyb2xsSW50b1ZpZXcoZWxlbWVudCwgc3BvdCkgewogIHZhciBza2lwT3ZlcmZsb3dIaWRkZW5FbGVtZW50cyA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDogZmFsc2U7CiAgdmFyIHBhcmVudCA9IGVsZW1lbnQub2Zmc2V0UGFyZW50OwoKICBpZiAoIXBhcmVudCkgewogICAgY29uc29sZS5lcnJvcigib2Zmc2V0UGFyZW50IGlzIG5vdCBzZXQgLS0gY2Fubm90IHNjcm9sbCIpOwogICAgcmV0dXJuOwogIH0KCiAgdmFyIG9mZnNldFkgPSBlbGVtZW50Lm9mZnNldFRvcCArIGVsZW1lbnQuY2xpZW50VG9wOwogIHZhciBvZmZzZXRYID0gZWxlbWVudC5vZmZzZXRMZWZ0ICsgZWxlbWVudC5jbGllbnRMZWZ0OwoKICB3aGlsZSAocGFyZW50LmNsaWVudEhlaWdodCA9PT0gcGFyZW50LnNjcm9sbEhlaWdodCAmJiBwYXJlbnQuY2xpZW50V2lkdGggPT09IHBhcmVudC5zY3JvbGxXaWR0aCB8fCBza2lwT3ZlcmZsb3dIaWRkZW5FbGVtZW50cyAmJiBnZXRDb21wdXRlZFN0eWxlKHBhcmVudCkub3ZlcmZsb3cgPT09ICJoaWRkZW4iKSB7CiAgICBpZiAocGFyZW50LmRhdGFzZXQuX3NjYWxlWSkgewogICAgICBvZmZzZXRZIC89IHBhcmVudC5kYXRhc2V0Ll9zY2FsZVk7CiAgICAgIG9mZnNldFggLz0gcGFyZW50LmRhdGFzZXQuX3NjYWxlWDsKICAgIH0KCiAgICBvZmZzZXRZICs9IHBhcmVudC5vZmZzZXRUb3A7CiAgICBvZmZzZXRYICs9IHBhcmVudC5vZmZzZXRMZWZ0OwogICAgcGFyZW50ID0gcGFyZW50Lm9mZnNldFBhcmVudDsKCiAgICBpZiAoIXBhcmVudCkgewogICAgICByZXR1cm47CiAgICB9CiAgfQoKICBpZiAoc3BvdCkgewogICAgaWYgKHNwb3QudG9wICE9PSB1bmRlZmluZWQpIHsKICAgICAgb2Zmc2V0WSArPSBzcG90LnRvcDsKICAgIH0KCiAgICBpZiAoc3BvdC5sZWZ0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgb2Zmc2V0WCArPSBzcG90LmxlZnQ7CiAgICAgIHBhcmVudC5zY3JvbGxMZWZ0ID0gb2Zmc2V0WDsKICAgIH0KICB9CgogIHBhcmVudC5zY3JvbGxUb3AgPSBvZmZzZXRZOwp9CgpmdW5jdGlvbiB3YXRjaFNjcm9sbCh2aWV3QXJlYUVsZW1lbnQsIGNhbGxiYWNrKSB7CiAgdmFyIGRlYm91bmNlU2Nyb2xsID0gZnVuY3Rpb24gZGVib3VuY2VTY3JvbGwoZXZ0KSB7CiAgICBpZiAockFGKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICByQUYgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uIHZpZXdBcmVhRWxlbWVudFNjcm9sbGVkKCkgewogICAgICByQUYgPSBudWxsOwogICAgICB2YXIgY3VycmVudFggPSB2aWV3QXJlYUVsZW1lbnQuc2Nyb2xsTGVmdDsKICAgICAgdmFyIGxhc3RYID0gc3RhdGUubGFzdFg7CgogICAgICBpZiAoY3VycmVudFggIT09IGxhc3RYKSB7CiAgICAgICAgc3RhdGUucmlnaHQgPSBjdXJyZW50WCA+IGxhc3RYOwogICAgICB9CgogICAgICBzdGF0ZS5sYXN0WCA9IGN1cnJlbnRYOwogICAgICB2YXIgY3VycmVudFkgPSB2aWV3QXJlYUVsZW1lbnQuc2Nyb2xsVG9wOwogICAgICB2YXIgbGFzdFkgPSBzdGF0ZS5sYXN0WTsKCiAgICAgIGlmIChjdXJyZW50WSAhPT0gbGFzdFkpIHsKICAgICAgICBzdGF0ZS5kb3duID0gY3VycmVudFkgPiBsYXN0WTsKICAgICAgfQoKICAgICAgc3RhdGUubGFzdFkgPSBjdXJyZW50WTsKICAgICAgY2FsbGJhY2soc3RhdGUpOwogICAgfSk7CiAgfTsKCiAgdmFyIHN0YXRlID0gewogICAgcmlnaHQ6IHRydWUsCiAgICBkb3duOiB0cnVlLAogICAgbGFzdFg6IHZpZXdBcmVhRWxlbWVudC5zY3JvbGxMZWZ0LAogICAgbGFzdFk6IHZpZXdBcmVhRWxlbWVudC5zY3JvbGxUb3AsCiAgICBfZXZlbnRIYW5kbGVyOiBkZWJvdW5jZVNjcm9sbAogIH07CiAgdmFyIHJBRiA9IG51bGw7CiAgdmlld0FyZWFFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoInNjcm9sbCIsIGRlYm91bmNlU2Nyb2xsLCB0cnVlKTsKICByZXR1cm4gc3RhdGU7Cn0KCmZ1bmN0aW9uIHBhcnNlUXVlcnlTdHJpbmcocXVlcnkpIHsKICB2YXIgcGFydHMgPSBxdWVyeS5zcGxpdCgiJiIpOwogIHZhciBwYXJhbXMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwoKICBmb3IgKHZhciBpID0gMCwgaWkgPSBwYXJ0cy5sZW5ndGg7IGkgPCBpaTsgKytpKSB7CiAgICB2YXIgcGFyYW0gPSBwYXJ0c1tpXS5zcGxpdCgiPSIpOwogICAgdmFyIGtleSA9IHBhcmFtWzBdLnRvTG93ZXJDYXNlKCk7CiAgICB2YXIgdmFsdWUgPSBwYXJhbS5sZW5ndGggPiAxID8gcGFyYW1bMV0gOiBudWxsOwogICAgcGFyYW1zW2RlY29kZVVSSUNvbXBvbmVudChrZXkpXSA9IGRlY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgfQoKICByZXR1cm4gcGFyYW1zOwp9CgpmdW5jdGlvbiBiaW5hcnlTZWFyY2hGaXJzdEl0ZW0oaXRlbXMsIGNvbmRpdGlvbikgewogIHZhciBtaW5JbmRleCA9IDA7CiAgdmFyIG1heEluZGV4ID0gaXRlbXMubGVuZ3RoIC0gMTsKCiAgaWYgKG1heEluZGV4IDwgMCB8fCAhY29uZGl0aW9uKGl0ZW1zW21heEluZGV4XSkpIHsKICAgIHJldHVybiBpdGVtcy5sZW5ndGg7CiAgfQoKICBpZiAoY29uZGl0aW9uKGl0ZW1zW21pbkluZGV4XSkpIHsKICAgIHJldHVybiBtaW5JbmRleDsKICB9CgogIHdoaWxlIChtaW5JbmRleCA8IG1heEluZGV4KSB7CiAgICB2YXIgY3VycmVudEluZGV4ID0gbWluSW5kZXggKyBtYXhJbmRleCA+PiAxOwogICAgdmFyIGN1cnJlbnRJdGVtID0gaXRlbXNbY3VycmVudEluZGV4XTsKCiAgICBpZiAoY29uZGl0aW9uKGN1cnJlbnRJdGVtKSkgewogICAgICBtYXhJbmRleCA9IGN1cnJlbnRJbmRleDsKICAgIH0gZWxzZSB7CiAgICAgIG1pbkluZGV4ID0gY3VycmVudEluZGV4ICsgMTsKICAgIH0KICB9CgogIHJldHVybiBtaW5JbmRleDsKfQoKZnVuY3Rpb24gYXBwcm94aW1hdGVGcmFjdGlvbih4KSB7CiAgaWYgKE1hdGguZmxvb3IoeCkgPT09IHgpIHsKICAgIHJldHVybiBbeCwgMV07CiAgfQoKICB2YXIgeGludiA9IDEgLyB4OwogIHZhciBsaW1pdCA9IDg7CgogIGlmICh4aW52ID4gbGltaXQpIHsKICAgIHJldHVybiBbMSwgbGltaXRdOwogIH0gZWxzZSBpZiAoTWF0aC5mbG9vcih4aW52KSA9PT0geGludikgewogICAgcmV0dXJuIFsxLCB4aW52XTsKICB9CgogIHZhciB4XyA9IHggPiAxID8geGludiA6IHg7CiAgdmFyIGEgPSAwLAogICAgICBiID0gMSwKICAgICAgYyA9IDEsCiAgICAgIGQgPSAxOwoKICB3aGlsZSAodHJ1ZSkgewogICAgdmFyIHAgPSBhICsgYywKICAgICAgICBxID0gYiArIGQ7CgogICAgaWYgKHEgPiBsaW1pdCkgewogICAgICBicmVhazsKICAgIH0KCiAgICBpZiAoeF8gPD0gcCAvIHEpIHsKICAgICAgYyA9IHA7CiAgICAgIGQgPSBxOwogICAgfSBlbHNlIHsKICAgICAgYSA9IHA7CiAgICAgIGIgPSBxOwogICAgfQogIH0KCiAgdmFyIHJlc3VsdDsKCiAgaWYgKHhfIC0gYSAvIGIgPCBjIC8gZCAtIHhfKSB7CiAgICByZXN1bHQgPSB4XyA9PT0geCA/IFthLCBiXSA6IFtiLCBhXTsKICB9IGVsc2UgewogICAgcmVzdWx0ID0geF8gPT09IHggPyBbYywgZF0gOiBbZCwgY107CiAgfQoKICByZXR1cm4gcmVzdWx0Owp9CgpmdW5jdGlvbiByb3VuZFRvRGl2aWRlKHgsIGRpdikgewogIHZhciByID0geCAlIGRpdjsKICByZXR1cm4gciA9PT0gMCA/IHggOiBNYXRoLnJvdW5kKHggLSByICsgZGl2KTsKfQoKZnVuY3Rpb24gZ2V0UGFnZVNpemVJbmNoZXMoX3JlZikgewogIHZhciB2aWV3ID0gX3JlZi52aWV3LAogICAgICB1c2VyVW5pdCA9IF9yZWYudXNlclVuaXQsCiAgICAgIHJvdGF0ZSA9IF9yZWYucm90YXRlOwoKICB2YXIgX3ZpZXcgPSBfc2xpY2VkVG9BcnJheSh2aWV3LCA0KSwKICAgICAgeDEgPSBfdmlld1swXSwKICAgICAgeTEgPSBfdmlld1sxXSwKICAgICAgeDIgPSBfdmlld1syXSwKICAgICAgeTIgPSBfdmlld1szXTsKCiAgdmFyIGNoYW5nZU9yaWVudGF0aW9uID0gcm90YXRlICUgMTgwICE9PSAwOwogIHZhciB3aWR0aCA9ICh4MiAtIHgxKSAvIDcyICogdXNlclVuaXQ7CiAgdmFyIGhlaWdodCA9ICh5MiAtIHkxKSAvIDcyICogdXNlclVuaXQ7CiAgcmV0dXJuIHsKICAgIHdpZHRoOiBjaGFuZ2VPcmllbnRhdGlvbiA/IGhlaWdodCA6IHdpZHRoLAogICAgaGVpZ2h0OiBjaGFuZ2VPcmllbnRhdGlvbiA/IHdpZHRoIDogaGVpZ2h0CiAgfTsKfQoKZnVuY3Rpb24gYmFja3RyYWNrQmVmb3JlQWxsVmlzaWJsZUVsZW1lbnRzKGluZGV4LCB2aWV3cywgdG9wKSB7CiAgaWYgKGluZGV4IDwgMikgewogICAgcmV0dXJuIGluZGV4OwogIH0KCiAgdmFyIGVsdCA9IHZpZXdzW2luZGV4XS5kaXY7CiAgdmFyIHBhZ2VUb3AgPSBlbHQub2Zmc2V0VG9wICsgZWx0LmNsaWVudFRvcDsKCiAgaWYgKHBhZ2VUb3AgPj0gdG9wKSB7CiAgICBlbHQgPSB2aWV3c1tpbmRleCAtIDFdLmRpdjsKICAgIHBhZ2VUb3AgPSBlbHQub2Zmc2V0VG9wICsgZWx0LmNsaWVudFRvcDsKICB9CgogIGZvciAodmFyIGkgPSBpbmRleCAtIDI7IGkgPj0gMDsgLS1pKSB7CiAgICBlbHQgPSB2aWV3c1tpXS5kaXY7CgogICAgaWYgKGVsdC5vZmZzZXRUb3AgKyBlbHQuY2xpZW50VG9wICsgZWx0LmNsaWVudEhlaWdodCA8PSBwYWdlVG9wKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIGluZGV4ID0gaTsKICB9CgogIHJldHVybiBpbmRleDsKfQoKZnVuY3Rpb24gZ2V0VmlzaWJsZUVsZW1lbnRzKHNjcm9sbEVsLCB2aWV3cykgewogIHZhciBzb3J0QnlWaXNpYmlsaXR5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMl0gOiBmYWxzZTsKICB2YXIgaG9yaXpvbnRhbCA9IGFyZ3VtZW50cy5sZW5ndGggPiAzICYmIGFyZ3VtZW50c1szXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzNdIDogZmFsc2U7CiAgdmFyIHRvcCA9IHNjcm9sbEVsLnNjcm9sbFRvcCwKICAgICAgYm90dG9tID0gdG9wICsgc2Nyb2xsRWwuY2xpZW50SGVpZ2h0OwogIHZhciBsZWZ0ID0gc2Nyb2xsRWwuc2Nyb2xsTGVmdCwKICAgICAgcmlnaHQgPSBsZWZ0ICsgc2Nyb2xsRWwuY2xpZW50V2lkdGg7CgogIGZ1bmN0aW9uIGlzRWxlbWVudEJvdHRvbUFmdGVyVmlld1RvcCh2aWV3KSB7CiAgICB2YXIgZWxlbWVudCA9IHZpZXcuZGl2OwogICAgdmFyIGVsZW1lbnRCb3R0b20gPSBlbGVtZW50Lm9mZnNldFRvcCArIGVsZW1lbnQuY2xpZW50VG9wICsgZWxlbWVudC5jbGllbnRIZWlnaHQ7CiAgICByZXR1cm4gZWxlbWVudEJvdHRvbSA+IHRvcDsKICB9CgogIGZ1bmN0aW9uIGlzRWxlbWVudFJpZ2h0QWZ0ZXJWaWV3TGVmdCh2aWV3KSB7CiAgICB2YXIgZWxlbWVudCA9IHZpZXcuZGl2OwogICAgdmFyIGVsZW1lbnRSaWdodCA9IGVsZW1lbnQub2Zmc2V0TGVmdCArIGVsZW1lbnQuY2xpZW50TGVmdCArIGVsZW1lbnQuY2xpZW50V2lkdGg7CiAgICByZXR1cm4gZWxlbWVudFJpZ2h0ID4gbGVmdDsKICB9CgogIHZhciB2aXNpYmxlID0gW10sCiAgICAgIG51bVZpZXdzID0gdmlld3MubGVuZ3RoOwogIHZhciBmaXJzdFZpc2libGVFbGVtZW50SW5kID0gbnVtVmlld3MgPT09IDAgPyAwIDogYmluYXJ5U2VhcmNoRmlyc3RJdGVtKHZpZXdzLCBob3Jpem9udGFsID8gaXNFbGVtZW50UmlnaHRBZnRlclZpZXdMZWZ0IDogaXNFbGVtZW50Qm90dG9tQWZ0ZXJWaWV3VG9wKTsKCiAgaWYgKGZpcnN0VmlzaWJsZUVsZW1lbnRJbmQgPiAwICYmIGZpcnN0VmlzaWJsZUVsZW1lbnRJbmQgPCBudW1WaWV3cyAmJiAhaG9yaXpvbnRhbCkgewogICAgZmlyc3RWaXNpYmxlRWxlbWVudEluZCA9IGJhY2t0cmFja0JlZm9yZUFsbFZpc2libGVFbGVtZW50cyhmaXJzdFZpc2libGVFbGVtZW50SW5kLCB2aWV3cywgdG9wKTsKICB9CgogIHZhciBsYXN0RWRnZSA9IGhvcml6b250YWwgPyByaWdodCA6IC0xOwoKICBmb3IgKHZhciBpID0gZmlyc3RWaXNpYmxlRWxlbWVudEluZDsgaSA8IG51bVZpZXdzOyBpKyspIHsKICAgIHZhciB2aWV3ID0gdmlld3NbaV0sCiAgICAgICAgZWxlbWVudCA9IHZpZXcuZGl2OwogICAgdmFyIGN1cnJlbnRXaWR0aCA9IGVsZW1lbnQub2Zmc2V0TGVmdCArIGVsZW1lbnQuY2xpZW50TGVmdDsKICAgIHZhciBjdXJyZW50SGVpZ2h0ID0gZWxlbWVudC5vZmZzZXRUb3AgKyBlbGVtZW50LmNsaWVudFRvcDsKICAgIHZhciB2aWV3V2lkdGggPSBlbGVtZW50LmNsaWVudFdpZHRoLAogICAgICAgIHZpZXdIZWlnaHQgPSBlbGVtZW50LmNsaWVudEhlaWdodDsKICAgIHZhciB2aWV3UmlnaHQgPSBjdXJyZW50V2lkdGggKyB2aWV3V2lkdGg7CiAgICB2YXIgdmlld0JvdHRvbSA9IGN1cnJlbnRIZWlnaHQgKyB2aWV3SGVpZ2h0OwoKICAgIGlmIChsYXN0RWRnZSA9PT0gLTEpIHsKICAgICAgaWYgKHZpZXdCb3R0b20gPj0gYm90dG9tKSB7CiAgICAgICAgbGFzdEVkZ2UgPSB2aWV3Qm90dG9tOwogICAgICB9CiAgICB9IGVsc2UgaWYgKChob3Jpem9udGFsID8gY3VycmVudFdpZHRoIDogY3VycmVudEhlaWdodCkgPiBsYXN0RWRnZSkgewogICAgICBicmVhazsKICAgIH0KCiAgICBpZiAodmlld0JvdHRvbSA8PSB0b3AgfHwgY3VycmVudEhlaWdodCA+PSBib3R0b20gfHwgdmlld1JpZ2h0IDw9IGxlZnQgfHwgY3VycmVudFdpZHRoID49IHJpZ2h0KSB7CiAgICAgIGNvbnRpbnVlOwogICAgfQoKICAgIHZhciBoaWRkZW5IZWlnaHQgPSBNYXRoLm1heCgwLCB0b3AgLSBjdXJyZW50SGVpZ2h0KSArIE1hdGgubWF4KDAsIHZpZXdCb3R0b20gLSBib3R0b20pOwogICAgdmFyIGhpZGRlbldpZHRoID0gTWF0aC5tYXgoMCwgbGVmdCAtIGN1cnJlbnRXaWR0aCkgKyBNYXRoLm1heCgwLCB2aWV3UmlnaHQgLSByaWdodCk7CiAgICB2YXIgcGVyY2VudCA9ICh2aWV3SGVpZ2h0IC0gaGlkZGVuSGVpZ2h0KSAqICh2aWV3V2lkdGggLSBoaWRkZW5XaWR0aCkgKiAxMDAgLyB2aWV3SGVpZ2h0IC8gdmlld1dpZHRoIHwgMDsKICAgIHZpc2libGUucHVzaCh7CiAgICAgIGlkOiB2aWV3LmlkLAogICAgICB4OiBjdXJyZW50V2lkdGgsCiAgICAgIHk6IGN1cnJlbnRIZWlnaHQsCiAgICAgIHZpZXc6IHZpZXcsCiAgICAgIHBlcmNlbnQ6IHBlcmNlbnQKICAgIH0pOwogIH0KCiAgdmFyIGZpcnN0ID0gdmlzaWJsZVswXSwKICAgICAgbGFzdCA9IHZpc2libGVbdmlzaWJsZS5sZW5ndGggLSAxXTsKCiAgaWYgKHNvcnRCeVZpc2liaWxpdHkpIHsKICAgIHZpc2libGUuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgICB2YXIgcGMgPSBhLnBlcmNlbnQgLSBiLnBlcmNlbnQ7CgogICAgICBpZiAoTWF0aC5hYnMocGMpID4gMC4wMDEpIHsKICAgICAgICByZXR1cm4gLXBjOwogICAgICB9CgogICAgICByZXR1cm4gYS5pZCAtIGIuaWQ7CiAgICB9KTsKICB9CgogIHJldHVybiB7CiAgICBmaXJzdDogZmlyc3QsCiAgICBsYXN0OiBsYXN0LAogICAgdmlld3M6IHZpc2libGUKICB9Owp9CgpmdW5jdGlvbiBub0NvbnRleHRNZW51SGFuZGxlcihldnQpIHsKICBldnQucHJldmVudERlZmF1bHQoKTsKfQoKZnVuY3Rpb24gaXNEYXRhU2NoZW1hKHVybCkgewogIHZhciBpID0gMDsKICB2YXIgaWkgPSB1cmwubGVuZ3RoOwoKICB3aGlsZSAoaSA8IGlpICYmIHVybFtpXS50cmltKCkgPT09ICIiKSB7CiAgICBpKys7CiAgfQoKICByZXR1cm4gdXJsLnN1YnN0cmluZyhpLCBpICsgNSkudG9Mb3dlckNhc2UoKSA9PT0gImRhdGE6IjsKfQoKZnVuY3Rpb24gZ2V0UERGRmlsZU5hbWVGcm9tVVJMKHVybCkgewogIHZhciBkZWZhdWx0RmlsZW5hbWUgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6ICJkb2N1bWVudC5wZGYiOwoKICBpZiAodHlwZW9mIHVybCAhPT0gInN0cmluZyIpIHsKICAgIHJldHVybiBkZWZhdWx0RmlsZW5hbWU7CiAgfQoKICBpZiAoaXNEYXRhU2NoZW1hKHVybCkpIHsKICAgIGNvbnNvbGUud2FybigiZ2V0UERGRmlsZU5hbWVGcm9tVVJMOiAiICsgJ2lnbm9yaW5nICJkYXRhOiIgVVJMIGZvciBwZXJmb3JtYW5jZSByZWFzb25zLicpOwogICAgcmV0dXJuIGRlZmF1bHRGaWxlbmFtZTsKICB9CgogIHZhciByZVVSSSA9IC9eKD86KD86W146XSs6KT9cL1wvW15cL10rKT8oW14/I10qKShcP1teI10qKT8oIy4qKT8kLzsKICB2YXIgcmVGaWxlbmFtZSA9IC9bXlwvPyM9XStcLnBkZlxiKD8hLipcLnBkZlxiKS9pOwogIHZhciBzcGxpdFVSSSA9IHJlVVJJLmV4ZWModXJsKTsKICB2YXIgc3VnZ2VzdGVkRmlsZW5hbWUgPSByZUZpbGVuYW1lLmV4ZWMoc3BsaXRVUklbMV0pIHx8IHJlRmlsZW5hbWUuZXhlYyhzcGxpdFVSSVsyXSkgfHwgcmVGaWxlbmFtZS5leGVjKHNwbGl0VVJJWzNdKTsKCiAgaWYgKHN1Z2dlc3RlZEZpbGVuYW1lKSB7CiAgICBzdWdnZXN0ZWRGaWxlbmFtZSA9IHN1Z2dlc3RlZEZpbGVuYW1lWzBdOwoKICAgIGlmIChzdWdnZXN0ZWRGaWxlbmFtZS5pbmNsdWRlcygiJSIpKSB7CiAgICAgIHRyeSB7CiAgICAgICAgc3VnZ2VzdGVkRmlsZW5hbWUgPSByZUZpbGVuYW1lLmV4ZWMoZGVjb2RlVVJJQ29tcG9uZW50KHN1Z2dlc3RlZEZpbGVuYW1lKSlbMF07CiAgICAgIH0gY2F0Y2ggKGV4KSB7fQogICAgfQogIH0KCiAgcmV0dXJuIHN1Z2dlc3RlZEZpbGVuYW1lIHx8IGRlZmF1bHRGaWxlbmFtZTsKfQoKZnVuY3Rpb24gbm9ybWFsaXplV2hlZWxFdmVudERlbHRhKGV2dCkgewogIHZhciBkZWx0YSA9IE1hdGguc3FydChldnQuZGVsdGFYICogZXZ0LmRlbHRhWCArIGV2dC5kZWx0YVkgKiBldnQuZGVsdGFZKTsKICB2YXIgYW5nbGUgPSBNYXRoLmF0YW4yKGV2dC5kZWx0YVksIGV2dC5kZWx0YVgpOwoKICBpZiAoLTAuMjUgKiBNYXRoLlBJIDwgYW5nbGUgJiYgYW5nbGUgPCAwLjc1ICogTWF0aC5QSSkgewogICAgZGVsdGEgPSAtZGVsdGE7CiAgfQoKICB2YXIgTU9VU0VfRE9NX0RFTFRBX1BJWEVMX01PREUgPSAwOwogIHZhciBNT1VTRV9ET01fREVMVEFfTElORV9NT0RFID0gMTsKICB2YXIgTU9VU0VfUElYRUxTX1BFUl9MSU5FID0gMzA7CiAgdmFyIE1PVVNFX0xJTkVTX1BFUl9QQUdFID0gMzA7CgogIGlmIChldnQuZGVsdGFNb2RlID09PSBNT1VTRV9ET01fREVMVEFfUElYRUxfTU9ERSkgewogICAgZGVsdGEgLz0gTU9VU0VfUElYRUxTX1BFUl9MSU5FICogTU9VU0VfTElORVNfUEVSX1BBR0U7CiAgfSBlbHNlIGlmIChldnQuZGVsdGFNb2RlID09PSBNT1VTRV9ET01fREVMVEFfTElORV9NT0RFKSB7CiAgICBkZWx0YSAvPSBNT1VTRV9MSU5FU19QRVJfUEFHRTsKICB9CgogIHJldHVybiBkZWx0YTsKfQoKZnVuY3Rpb24gaXNWYWxpZFJvdGF0aW9uKGFuZ2xlKSB7CiAgcmV0dXJuIE51bWJlci5pc0ludGVnZXIoYW5nbGUpICYmIGFuZ2xlICUgOTAgPT09IDA7Cn0KCmZ1bmN0aW9uIGlzVmFsaWRTY3JvbGxNb2RlKG1vZGUpIHsKICByZXR1cm4gTnVtYmVyLmlzSW50ZWdlcihtb2RlKSAmJiBPYmplY3QudmFsdWVzKFNjcm9sbE1vZGUpLmluY2x1ZGVzKG1vZGUpICYmIG1vZGUgIT09IFNjcm9sbE1vZGUuVU5LTk9XTjsKfQoKZnVuY3Rpb24gaXNWYWxpZFNwcmVhZE1vZGUobW9kZSkgewogIHJldHVybiBOdW1iZXIuaXNJbnRlZ2VyKG1vZGUpICYmIE9iamVjdC52YWx1ZXMoU3ByZWFkTW9kZSkuaW5jbHVkZXMobW9kZSkgJiYgbW9kZSAhPT0gU3ByZWFkTW9kZS5VTktOT1dOOwp9CgpmdW5jdGlvbiBpc1BvcnRyYWl0T3JpZW50YXRpb24oc2l6ZSkgewogIHJldHVybiBzaXplLndpZHRoIDw9IHNpemUuaGVpZ2h0Owp9Cgp2YXIgV2FpdE9uVHlwZSA9IHsKICBFVkVOVDogImV2ZW50IiwKICBUSU1FT1VUOiAidGltZW91dCIKfTsKZXhwb3J0cy5XYWl0T25UeXBlID0gV2FpdE9uVHlwZTsKCmZ1bmN0aW9uIHdhaXRPbkV2ZW50T3JUaW1lb3V0KF9yZWYyKSB7CiAgdmFyIHRhcmdldCA9IF9yZWYyLnRhcmdldCwKICAgICAgbmFtZSA9IF9yZWYyLm5hbWUsCiAgICAgIF9yZWYyJGRlbGF5ID0gX3JlZjIuZGVsYXksCiAgICAgIGRlbGF5ID0gX3JlZjIkZGVsYXkgPT09IHZvaWQgMCA/IDAgOiBfcmVmMiRkZWxheTsKICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgaWYgKF90eXBlb2YodGFyZ2V0KSAhPT0gIm9iamVjdCIgfHwgIShuYW1lICYmIHR5cGVvZiBuYW1lID09PSAic3RyaW5nIikgfHwgIShOdW1iZXIuaXNJbnRlZ2VyKGRlbGF5KSAmJiBkZWxheSA+PSAwKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIndhaXRPbkV2ZW50T3JUaW1lb3V0IC0gaW52YWxpZCBwYXJhbWV0ZXJzLiIpOwogICAgfQoKICAgIGZ1bmN0aW9uIGhhbmRsZXIodHlwZSkgewogICAgICBpZiAodGFyZ2V0IGluc3RhbmNlb2YgRXZlbnRCdXMpIHsKICAgICAgICB0YXJnZXQuX29mZihuYW1lLCBldmVudEhhbmRsZXIpOwogICAgICB9IGVsc2UgewogICAgICAgIHRhcmdldC5yZW1vdmVFdmVudExpc3RlbmVyKG5hbWUsIGV2ZW50SGFuZGxlcik7CiAgICAgIH0KCiAgICAgIGlmICh0aW1lb3V0KSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICB9CgogICAgICByZXNvbHZlKHR5cGUpOwogICAgfQoKICAgIHZhciBldmVudEhhbmRsZXIgPSBoYW5kbGVyLmJpbmQobnVsbCwgV2FpdE9uVHlwZS5FVkVOVCk7CgogICAgaWYgKHRhcmdldCBpbnN0YW5jZW9mIEV2ZW50QnVzKSB7CiAgICAgIHRhcmdldC5fb24obmFtZSwgZXZlbnRIYW5kbGVyKTsKICAgIH0gZWxzZSB7CiAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKG5hbWUsIGV2ZW50SGFuZGxlcik7CiAgICB9CgogICAgdmFyIHRpbWVvdXRIYW5kbGVyID0gaGFuZGxlci5iaW5kKG51bGwsIFdhaXRPblR5cGUuVElNRU9VVCk7CiAgICB2YXIgdGltZW91dCA9IHNldFRpbWVvdXQodGltZW91dEhhbmRsZXIsIGRlbGF5KTsKICB9KTsKfQoKdmFyIGFuaW1hdGlvblN0YXJ0ZWQgPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkgewogIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUocmVzb2x2ZSk7Cn0pOwpleHBvcnRzLmFuaW1hdGlvblN0YXJ0ZWQgPSBhbmltYXRpb25TdGFydGVkOwoKZnVuY3Rpb24gZGlzcGF0Y2hET01FdmVudChldmVudE5hbWUpIHsKICB2YXIgYXJncyA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDogbnVsbDsKICB0aHJvdyBuZXcgRXJyb3IoIk5vdCBpbXBsZW1lbnRlZDogZGlzcGF0Y2hET01FdmVudCIpOwp9Cgp2YXIgRXZlbnRCdXMgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIEV2ZW50QnVzKG9wdGlvbnMpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBFdmVudEJ1cyk7CgogICAgdGhpcy5fbGlzdGVuZXJzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICB9CgogIF9jcmVhdGVDbGFzcyhFdmVudEJ1cywgW3sKICAgIGtleTogIm9uIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBvbihldmVudE5hbWUsIGxpc3RlbmVyKSB7CiAgICAgIHRoaXMuX29uKGV2ZW50TmFtZSwgbGlzdGVuZXIsIHsKICAgICAgICBleHRlcm5hbDogdHJ1ZQogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJvZmYiLAogICAgdmFsdWU6IGZ1bmN0aW9uIG9mZihldmVudE5hbWUsIGxpc3RlbmVyKSB7CiAgICAgIHRoaXMuX29mZihldmVudE5hbWUsIGxpc3RlbmVyLCB7CiAgICAgICAgZXh0ZXJuYWw6IHRydWUKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiZGlzcGF0Y2giLAogICAgdmFsdWU6IGZ1bmN0aW9uIGRpc3BhdGNoKGV2ZW50TmFtZSkgewogICAgICB2YXIgZXZlbnRMaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnNbZXZlbnROYW1lXTsKCiAgICAgIGlmICghZXZlbnRMaXN0ZW5lcnMgfHwgZXZlbnRMaXN0ZW5lcnMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgIHZhciBleHRlcm5hbExpc3RlbmVyczsKICAgICAgZXZlbnRMaXN0ZW5lcnMuc2xpY2UoMCkuZm9yRWFjaChmdW5jdGlvbiAoX3JlZjMpIHsKICAgICAgICB2YXIgbGlzdGVuZXIgPSBfcmVmMy5saXN0ZW5lciwKICAgICAgICAgICAgZXh0ZXJuYWwgPSBfcmVmMy5leHRlcm5hbDsKCiAgICAgICAgaWYgKGV4dGVybmFsKSB7CiAgICAgICAgICBpZiAoIWV4dGVybmFsTGlzdGVuZXJzKSB7CiAgICAgICAgICAgIGV4dGVybmFsTGlzdGVuZXJzID0gW107CiAgICAgICAgICB9CgogICAgICAgICAgZXh0ZXJuYWxMaXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBsaXN0ZW5lci5hcHBseShudWxsLCBhcmdzKTsKICAgICAgfSk7CgogICAgICBpZiAoZXh0ZXJuYWxMaXN0ZW5lcnMpIHsKICAgICAgICBleHRlcm5hbExpc3RlbmVycy5mb3JFYWNoKGZ1bmN0aW9uIChsaXN0ZW5lcikgewogICAgICAgICAgbGlzdGVuZXIuYXBwbHkobnVsbCwgYXJncyk7CiAgICAgICAgfSk7CiAgICAgICAgZXh0ZXJuYWxMaXN0ZW5lcnMgPSBudWxsOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAiX29uIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfb24oZXZlbnROYW1lLCBsaXN0ZW5lcikgewogICAgICB2YXIgb3B0aW9ucyA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDogbnVsbDsKICAgICAgdmFyIGV2ZW50TGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzW2V2ZW50TmFtZV07CgogICAgICBpZiAoIWV2ZW50TGlzdGVuZXJzKSB7CiAgICAgICAgdGhpcy5fbGlzdGVuZXJzW2V2ZW50TmFtZV0gPSBldmVudExpc3RlbmVycyA9IFtdOwogICAgICB9CgogICAgICBldmVudExpc3RlbmVycy5wdXNoKHsKICAgICAgICBsaXN0ZW5lcjogbGlzdGVuZXIsCiAgICAgICAgZXh0ZXJuYWw6IChvcHRpb25zICYmIG9wdGlvbnMuZXh0ZXJuYWwpID09PSB0cnVlCiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogIl9vZmYiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vZmYoZXZlbnROYW1lLCBsaXN0ZW5lcikgewogICAgICB2YXIgb3B0aW9ucyA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDogbnVsbDsKICAgICAgdmFyIGV2ZW50TGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzW2V2ZW50TmFtZV07CgogICAgICBpZiAoIWV2ZW50TGlzdGVuZXJzKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBmb3IgKHZhciBpID0gMCwgaWkgPSBldmVudExpc3RlbmVycy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgaWYgKGV2ZW50TGlzdGVuZXJzW2ldLmxpc3RlbmVyID09PSBsaXN0ZW5lcikgewogICAgICAgICAgZXZlbnRMaXN0ZW5lcnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH1dKTsKCiAgcmV0dXJuIEV2ZW50QnVzOwp9KCk7CgpleHBvcnRzLkV2ZW50QnVzID0gRXZlbnRCdXM7CgpmdW5jdGlvbiBjbGFtcCh2LCBtaW4sIG1heCkgewogIHJldHVybiBNYXRoLm1pbihNYXRoLm1heCh2LCBtaW4pLCBtYXgpOwp9Cgp2YXIgUHJvZ3Jlc3NCYXIgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIFByb2dyZXNzQmFyKGlkKSB7CiAgICB2YXIgX3JlZjQgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IHt9LAogICAgICAgIGhlaWdodCA9IF9yZWY0LmhlaWdodCwKICAgICAgICB3aWR0aCA9IF9yZWY0LndpZHRoLAogICAgICAgIHVuaXRzID0gX3JlZjQudW5pdHM7CgogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFByb2dyZXNzQmFyKTsKCiAgICB0aGlzLnZpc2libGUgPSB0cnVlOwogICAgdGhpcy5kaXYgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGlkICsgIiAucHJvZ3Jlc3MiKTsKICAgIHRoaXMuYmFyID0gdGhpcy5kaXYucGFyZW50Tm9kZTsKICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0IHx8IDEwMDsKICAgIHRoaXMud2lkdGggPSB3aWR0aCB8fCAxMDA7CiAgICB0aGlzLnVuaXRzID0gdW5pdHMgfHwgIiUiOwogICAgdGhpcy5kaXYuc3R5bGUuaGVpZ2h0ID0gdGhpcy5oZWlnaHQgKyB0aGlzLnVuaXRzOwogICAgdGhpcy5wZXJjZW50ID0gMDsKICB9CgogIF9jcmVhdGVDbGFzcyhQcm9ncmVzc0JhciwgW3sKICAgIGtleTogIl91cGRhdGVCYXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF91cGRhdGVCYXIoKSB7CiAgICAgIGlmICh0aGlzLl9pbmRldGVybWluYXRlKSB7CiAgICAgICAgdGhpcy5kaXYuY2xhc3NMaXN0LmFkZCgiaW5kZXRlcm1pbmF0ZSIpOwogICAgICAgIHRoaXMuZGl2LnN0eWxlLndpZHRoID0gdGhpcy53aWR0aCArIHRoaXMudW5pdHM7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLmRpdi5jbGFzc0xpc3QucmVtb3ZlKCJpbmRldGVybWluYXRlIik7CiAgICAgIHZhciBwcm9ncmVzc1NpemUgPSB0aGlzLndpZHRoICogdGhpcy5fcGVyY2VudCAvIDEwMDsKICAgICAgdGhpcy5kaXYuc3R5bGUud2lkdGggPSBwcm9ncmVzc1NpemUgKyB0aGlzLnVuaXRzOwogICAgfQogIH0sIHsKICAgIGtleTogInNldFdpZHRoIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRXaWR0aCh2aWV3ZXIpIHsKICAgICAgaWYgKCF2aWV3ZXIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBjb250YWluZXIgPSB2aWV3ZXIucGFyZW50Tm9kZTsKICAgICAgdmFyIHNjcm9sbGJhcldpZHRoID0gY29udGFpbmVyLm9mZnNldFdpZHRoIC0gdmlld2VyLm9mZnNldFdpZHRoOwoKICAgICAgaWYgKHNjcm9sbGJhcldpZHRoID4gMCkgewogICAgICAgIHRoaXMuYmFyLnN0eWxlLndpZHRoID0gImNhbGMoMTAwJSAtICIuY29uY2F0KHNjcm9sbGJhcldpZHRoLCAicHgpIik7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJoaWRlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBoaWRlKCkgewogICAgICBpZiAoIXRoaXMudmlzaWJsZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy52aXNpYmxlID0gZmFsc2U7CiAgICAgIHRoaXMuYmFyLmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOwogICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5yZW1vdmUoImxvYWRpbmdJblByb2dyZXNzIik7CiAgICB9CiAgfSwgewogICAga2V5OiAic2hvdyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2hvdygpIHsKICAgICAgaWYgKHRoaXMudmlzaWJsZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy52aXNpYmxlID0gdHJ1ZTsKICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKCJsb2FkaW5nSW5Qcm9ncmVzcyIpOwogICAgICB0aGlzLmJhci5jbGFzc0xpc3QucmVtb3ZlKCJoaWRkZW4iKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJwZXJjZW50IiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fcGVyY2VudDsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uIHNldCh2YWwpIHsKICAgICAgdGhpcy5faW5kZXRlcm1pbmF0ZSA9IGlzTmFOKHZhbCk7CiAgICAgIHRoaXMuX3BlcmNlbnQgPSBjbGFtcCh2YWwsIDAsIDEwMCk7CgogICAgICB0aGlzLl91cGRhdGVCYXIoKTsKICAgIH0KICB9XSk7CgogIHJldHVybiBQcm9ncmVzc0JhcjsKfSgpOwoKZXhwb3J0cy5Qcm9ncmVzc0JhciA9IFByb2dyZXNzQmFyOwoKZnVuY3Rpb24gbW92ZVRvRW5kT2ZBcnJheShhcnIsIGNvbmRpdGlvbikgewogIHZhciBtb3ZlZCA9IFtdLAogICAgICBsZW4gPSBhcnIubGVuZ3RoOwogIHZhciB3cml0ZSA9IDA7CgogIGZvciAodmFyIHJlYWQgPSAwOyByZWFkIDwgbGVuOyArK3JlYWQpIHsKICAgIGlmIChjb25kaXRpb24oYXJyW3JlYWRdKSkgewogICAgICBtb3ZlZC5wdXNoKGFycltyZWFkXSk7CiAgICB9IGVsc2UgewogICAgICBhcnJbd3JpdGVdID0gYXJyW3JlYWRdOwogICAgICArK3dyaXRlOwogICAgfQogIH0KCiAgZm9yICh2YXIgX3JlYWQgPSAwOyB3cml0ZSA8IGxlbjsgKytfcmVhZCwgKyt3cml0ZSkgewogICAgYXJyW3dyaXRlXSA9IG1vdmVkW19yZWFkXTsKICB9Cn0KCi8qKiovIH0pLAovKiA2ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuT3B0aW9uS2luZCA9IGV4cG9ydHMuQXBwT3B0aW9ucyA9IHZvaWQgMDsKCnZhciBfdmlld2VyX2NvbXBhdGliaWxpdHkgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDcpOwoKZnVuY3Rpb24gX3R5cGVvZihvYmopIHsgIkBiYWJlbC9oZWxwZXJzIC0gdHlwZW9mIjsgaWYgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIFN5bWJvbC5pdGVyYXRvciA9PT0gInN5bWJvbCIpIHsgX3R5cGVvZiA9IGZ1bmN0aW9uIF90eXBlb2Yob2JqKSB7IHJldHVybiB0eXBlb2Ygb2JqOyB9OyB9IGVsc2UgeyBfdHlwZW9mID0gZnVuY3Rpb24gX3R5cGVvZihvYmopIHsgcmV0dXJuIG9iaiAmJiB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIG9iai5jb25zdHJ1Y3RvciA9PT0gU3ltYm9sICYmIG9iaiAhPT0gU3ltYm9sLnByb3RvdHlwZSA/ICJzeW1ib2wiIDogdHlwZW9mIG9iajsgfTsgfSByZXR1cm4gX3R5cGVvZihvYmopOyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOyB9IH0KCmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9CgpmdW5jdGlvbiBfY3JlYXRlQ2xhc3MoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfQoKdmFyIE9wdGlvbktpbmQgPSB7CiAgVklFV0VSOiAweDAyLAogIEFQSTogMHgwNCwKICBXT1JLRVI6IDB4MDgsCiAgUFJFRkVSRU5DRTogMHg4MAp9OwpleHBvcnRzLk9wdGlvbktpbmQgPSBPcHRpb25LaW5kOwp2YXIgZGVmYXVsdE9wdGlvbnMgPSB7CiAgY3Vyc29yVG9vbE9uTG9hZDogewogICAgdmFsdWU6IDAsCiAgICBraW5kOiBPcHRpb25LaW5kLlZJRVdFUiArIE9wdGlvbktpbmQuUFJFRkVSRU5DRQogIH0sCiAgZGVmYXVsdFVybDogewogICAgdmFsdWU6ICJjb21wcmVzc2VkLnRyYWNlbW9ua2V5LXBsZGktMDkucGRmIiwKICAgIGtpbmQ6IE9wdGlvbktpbmQuVklFV0VSCiAgfSwKICBkZWZhdWx0Wm9vbVZhbHVlOiB7CiAgICB2YWx1ZTogIiIsCiAgICBraW5kOiBPcHRpb25LaW5kLlZJRVdFUiArIE9wdGlvbktpbmQuUFJFRkVSRU5DRQogIH0sCiAgZGlzYWJsZUNyZWF0ZU9iamVjdFVSTDogewogICAgdmFsdWU6IGZhbHNlLAogICAgY29tcGF0aWJpbGl0eTogX3ZpZXdlcl9jb21wYXRpYmlsaXR5LnZpZXdlckNvbXBhdGliaWxpdHlQYXJhbXMuZGlzYWJsZUNyZWF0ZU9iamVjdFVSTCwKICAgIGtpbmQ6IE9wdGlvbktpbmQuVklFV0VSCiAgfSwKICBkaXNhYmxlSGlzdG9yeTogewogICAgdmFsdWU6IGZhbHNlLAogICAga2luZDogT3B0aW9uS2luZC5WSUVXRVIKICB9LAogIGRpc2FibGVQYWdlTGFiZWxzOiB7CiAgICB2YWx1ZTogZmFsc2UsCiAgICBraW5kOiBPcHRpb25LaW5kLlZJRVdFUiArIE9wdGlvbktpbmQuUFJFRkVSRU5DRQogIH0sCiAgZW5hYmxlUGVybWlzc2lvbnM6IHsKICAgIHZhbHVlOiBmYWxzZSwKICAgIGtpbmQ6IE9wdGlvbktpbmQuVklFV0VSICsgT3B0aW9uS2luZC5QUkVGRVJFTkNFCiAgfSwKICBlbmFibGVQcmludEF1dG9Sb3RhdGU6IHsKICAgIHZhbHVlOiBmYWxzZSwKICAgIGtpbmQ6IE9wdGlvbktpbmQuVklFV0VSICsgT3B0aW9uS2luZC5QUkVGRVJFTkNFCiAgfSwKICBlbmFibGVXZWJHTDogewogICAgdmFsdWU6IGZhbHNlLAogICAga2luZDogT3B0aW9uS2luZC5WSUVXRVIgKyBPcHRpb25LaW5kLlBSRUZFUkVOQ0UKICB9LAogIGV4dGVybmFsTGlua1JlbDogewogICAgdmFsdWU6ICJub29wZW5lciBub3JlZmVycmVyIG5vZm9sbG93IiwKICAgIGtpbmQ6IE9wdGlvbktpbmQuVklFV0VSCiAgfSwKICBleHRlcm5hbExpbmtUYXJnZXQ6IHsKICAgIHZhbHVlOiAwLAogICAga2luZDogT3B0aW9uS2luZC5WSUVXRVIgKyBPcHRpb25LaW5kLlBSRUZFUkVOQ0UKICB9LAogIGhpc3RvcnlVcGRhdGVVcmw6IHsKICAgIHZhbHVlOiBmYWxzZSwKICAgIGtpbmQ6IE9wdGlvbktpbmQuVklFV0VSICsgT3B0aW9uS2luZC5QUkVGRVJFTkNFCiAgfSwKICBpZ25vcmVEZXN0aW5hdGlvblpvb206IHsKICAgIHZhbHVlOiBmYWxzZSwKICAgIGtpbmQ6IE9wdGlvbktpbmQuVklFV0VSICsgT3B0aW9uS2luZC5QUkVGRVJFTkNFCiAgfSwKICBpbWFnZVJlc291cmNlc1BhdGg6IHsKICAgIHZhbHVlOiAiLi9pbWFnZXMvIiwKICAgIGtpbmQ6IE9wdGlvbktpbmQuVklFV0VSCiAgfSwKICBtYXhDYW52YXNQaXhlbHM6IHsKICAgIHZhbHVlOiAxNjc3NzIxNiwKICAgIGNvbXBhdGliaWxpdHk6IF92aWV3ZXJfY29tcGF0aWJpbGl0eS52aWV3ZXJDb21wYXRpYmlsaXR5UGFyYW1zLm1heENhbnZhc1BpeGVscywKICAgIGtpbmQ6IE9wdGlvbktpbmQuVklFV0VSCiAgfSwKICBwZGZCdWdFbmFibGVkOiB7CiAgICB2YWx1ZTogZmFsc2UsCiAgICBraW5kOiBPcHRpb25LaW5kLlZJRVdFUiArIE9wdGlvbktpbmQuUFJFRkVSRU5DRQogIH0sCiAgcHJpbnRSZXNvbHV0aW9uOiB7CiAgICB2YWx1ZTogMTUwLAogICAga2luZDogT3B0aW9uS2luZC5WSUVXRVIKICB9LAogIHJlbmRlcmVyOiB7CiAgICB2YWx1ZTogImNhbnZhcyIsCiAgICBraW5kOiBPcHRpb25LaW5kLlZJRVdFUiArIE9wdGlvbktpbmQuUFJFRkVSRU5DRQogIH0sCiAgcmVuZGVySW50ZXJhY3RpdmVGb3JtczogewogICAgdmFsdWU6IGZhbHNlLAogICAga2luZDogT3B0aW9uS2luZC5WSUVXRVIgKyBPcHRpb25LaW5kLlBSRUZFUkVOQ0UKICB9LAogIHNpZGViYXJWaWV3T25Mb2FkOiB7CiAgICB2YWx1ZTogLTEsCiAgICBraW5kOiBPcHRpb25LaW5kLlZJRVdFUiArIE9wdGlvbktpbmQuUFJFRkVSRU5DRQogIH0sCiAgc2Nyb2xsTW9kZU9uTG9hZDogewogICAgdmFsdWU6IC0xLAogICAga2luZDogT3B0aW9uS2luZC5WSUVXRVIgKyBPcHRpb25LaW5kLlBSRUZFUkVOQ0UKICB9LAogIHNwcmVhZE1vZGVPbkxvYWQ6IHsKICAgIHZhbHVlOiAtMSwKICAgIGtpbmQ6IE9wdGlvbktpbmQuVklFV0VSICsgT3B0aW9uS2luZC5QUkVGRVJFTkNFCiAgfSwKICB0ZXh0TGF5ZXJNb2RlOiB7CiAgICB2YWx1ZTogMSwKICAgIGtpbmQ6IE9wdGlvbktpbmQuVklFV0VSICsgT3B0aW9uS2luZC5QUkVGRVJFTkNFCiAgfSwKICB1c2VPbmx5Q3NzWm9vbTogewogICAgdmFsdWU6IGZhbHNlLAogICAga2luZDogT3B0aW9uS2luZC5WSUVXRVIgKyBPcHRpb25LaW5kLlBSRUZFUkVOQ0UKICB9LAogIHZpZXdPbkxvYWQ6IHsKICAgIHZhbHVlOiAwLAogICAga2luZDogT3B0aW9uS2luZC5WSUVXRVIgKyBPcHRpb25LaW5kLlBSRUZFUkVOQ0UKICB9LAogIGNNYXBQYWNrZWQ6IHsKICAgIHZhbHVlOiB0cnVlLAogICAga2luZDogT3B0aW9uS2luZC5BUEkKICB9LAogIGNNYXBVcmw6IHsKICAgIHZhbHVlOiAiLi4vd2ViL2NtYXBzLyIsCiAgICBraW5kOiBPcHRpb25LaW5kLkFQSQogIH0sCiAgZGlzYWJsZUF1dG9GZXRjaDogewogICAgdmFsdWU6IGZhbHNlLAogICAga2luZDogT3B0aW9uS2luZC5BUEkgKyBPcHRpb25LaW5kLlBSRUZFUkVOQ0UKICB9LAogIGRpc2FibGVGb250RmFjZTogewogICAgdmFsdWU6IGZhbHNlLAogICAga2luZDogT3B0aW9uS2luZC5BUEkgKyBPcHRpb25LaW5kLlBSRUZFUkVOQ0UKICB9LAogIGRpc2FibGVSYW5nZTogewogICAgdmFsdWU6IGZhbHNlLAogICAga2luZDogT3B0aW9uS2luZC5BUEkgKyBPcHRpb25LaW5kLlBSRUZFUkVOQ0UKICB9LAogIGRpc2FibGVTdHJlYW06IHsKICAgIHZhbHVlOiBmYWxzZSwKICAgIGtpbmQ6IE9wdGlvbktpbmQuQVBJICsgT3B0aW9uS2luZC5QUkVGRVJFTkNFCiAgfSwKICBkb2NCYXNlVXJsOiB7CiAgICB2YWx1ZTogIiIsCiAgICBraW5kOiBPcHRpb25LaW5kLkFQSQogIH0sCiAgZm9udEV4dHJhUHJvcGVydGllczogewogICAgdmFsdWU6IGZhbHNlLAogICAga2luZDogT3B0aW9uS2luZC5BUEkKICB9LAogIGlzRXZhbFN1cHBvcnRlZDogewogICAgdmFsdWU6IHRydWUsCiAgICBraW5kOiBPcHRpb25LaW5kLkFQSQogIH0sCiAgbWF4SW1hZ2VTaXplOiB7CiAgICB2YWx1ZTogLTEsCiAgICBraW5kOiBPcHRpb25LaW5kLkFQSQogIH0sCiAgcGRmQnVnOiB7CiAgICB2YWx1ZTogZmFsc2UsCiAgICBraW5kOiBPcHRpb25LaW5kLkFQSQogIH0sCiAgdmVyYm9zaXR5OiB7CiAgICB2YWx1ZTogMSwKICAgIGtpbmQ6IE9wdGlvbktpbmQuQVBJCiAgfSwKICB3b3JrZXJQb3J0OiB7CiAgICB2YWx1ZTogbnVsbCwKICAgIGtpbmQ6IE9wdGlvbktpbmQuV09SS0VSCiAgfSwKICB3b3JrZXJTcmM6IHsKICAgIHZhbHVlOiAicGRmLndvcmtlci5taW4uanMiLAogICAga2luZDogT3B0aW9uS2luZC5XT1JLRVIKICB9Cn07CnsKICBkZWZhdWx0T3B0aW9ucy5kaXNhYmxlUHJlZmVyZW5jZXMgPSB7CiAgICB2YWx1ZTogZmFsc2UsCiAgICBraW5kOiBPcHRpb25LaW5kLlZJRVdFUgogIH07CiAgZGVmYXVsdE9wdGlvbnMubG9jYWxlID0gewogICAgdmFsdWU6IHR5cGVvZiBuYXZpZ2F0b3IgIT09ICJ1bmRlZmluZWQiID8gbmF2aWdhdG9yLmxhbmd1YWdlIDogImVuLVVTIiwKICAgIGtpbmQ6IE9wdGlvbktpbmQuVklFV0VSCiAgfTsKfQp2YXIgdXNlck9wdGlvbnMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwoKdmFyIEFwcE9wdGlvbnMgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIEFwcE9wdGlvbnMoKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgQXBwT3B0aW9ucyk7CgogICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgaW5pdGlhbGl6ZSBBcHBPcHRpb25zLiIpOwogIH0KCiAgX2NyZWF0ZUNsYXNzKEFwcE9wdGlvbnMsIG51bGwsIFt7CiAgICBrZXk6ICJnZXQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGdldChuYW1lKSB7CiAgICAgIHZhciB1c2VyT3B0aW9uID0gdXNlck9wdGlvbnNbbmFtZV07CgogICAgICBpZiAodXNlck9wdGlvbiAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIHVzZXJPcHRpb247CiAgICAgIH0KCiAgICAgIHZhciBkZWZhdWx0T3B0aW9uID0gZGVmYXVsdE9wdGlvbnNbbmFtZV07CgogICAgICBpZiAoZGVmYXVsdE9wdGlvbiAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIGRlZmF1bHRPcHRpb24uY29tcGF0aWJpbGl0eSB8fCBkZWZhdWx0T3B0aW9uLnZhbHVlOwogICAgICB9CgogICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQogIH0sIHsKICAgIGtleTogImdldEFsbCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0QWxsKCkgewogICAgICB2YXIga2luZCA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDogbnVsbDsKICAgICAgdmFyIG9wdGlvbnMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwoKICAgICAgZm9yICh2YXIgbmFtZSBpbiBkZWZhdWx0T3B0aW9ucykgewogICAgICAgIHZhciBkZWZhdWx0T3B0aW9uID0gZGVmYXVsdE9wdGlvbnNbbmFtZV07CgogICAgICAgIGlmIChraW5kKSB7CiAgICAgICAgICBpZiAoKGtpbmQgJiBkZWZhdWx0T3B0aW9uLmtpbmQpID09PSAwKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChraW5kID09PSBPcHRpb25LaW5kLlBSRUZFUkVOQ0UpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gZGVmYXVsdE9wdGlvbi52YWx1ZSwKICAgICAgICAgICAgICAgIHZhbHVlVHlwZSA9IF90eXBlb2YodmFsdWUpOwoKICAgICAgICAgICAgaWYgKHZhbHVlVHlwZSA9PT0gImJvb2xlYW4iIHx8IHZhbHVlVHlwZSA9PT0gInN0cmluZyIgfHwgdmFsdWVUeXBlID09PSAibnVtYmVyIiAmJiBOdW1iZXIuaXNJbnRlZ2VyKHZhbHVlKSkgewogICAgICAgICAgICAgIG9wdGlvbnNbbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHR5cGUgZm9yIHByZWZlcmVuY2U6ICIuY29uY2F0KG5hbWUpKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhciB1c2VyT3B0aW9uID0gdXNlck9wdGlvbnNbbmFtZV07CiAgICAgICAgb3B0aW9uc1tuYW1lXSA9IHVzZXJPcHRpb24gIT09IHVuZGVmaW5lZCA/IHVzZXJPcHRpb24gOiBkZWZhdWx0T3B0aW9uLmNvbXBhdGliaWxpdHkgfHwgZGVmYXVsdE9wdGlvbi52YWx1ZTsKICAgICAgfQoKICAgICAgcmV0dXJuIG9wdGlvbnM7CiAgICB9CiAgfSwgewogICAga2V5OiAic2V0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXQobmFtZSwgdmFsdWUpIHsKICAgICAgdXNlck9wdGlvbnNbbmFtZV0gPSB2YWx1ZTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJyZW1vdmUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlbW92ZShuYW1lKSB7CiAgICAgIGRlbGV0ZSB1c2VyT3B0aW9uc1tuYW1lXTsKICAgIH0KICB9XSk7CgogIHJldHVybiBBcHBPcHRpb25zOwp9KCk7CgpleHBvcnRzLkFwcE9wdGlvbnMgPSBBcHBPcHRpb25zOwoKLyoqKi8gfSksCi8qIDcgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKInVzZSBzdHJpY3QiOwoKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKZXhwb3J0cy52aWV3ZXJDb21wYXRpYmlsaXR5UGFyYW1zID0gdm9pZCAwOwp2YXIgY29tcGF0aWJpbGl0eVBhcmFtcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CnsKICB2YXIgdXNlckFnZW50ID0gdHlwZW9mIG5hdmlnYXRvciAhPT0gInVuZGVmaW5lZCIgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudCB8fCAiIjsKICB2YXIgcGxhdGZvcm0gPSB0eXBlb2YgbmF2aWdhdG9yICE9PSAidW5kZWZpbmVkIiAmJiBuYXZpZ2F0b3IucGxhdGZvcm0gfHwgIiI7CiAgdmFyIG1heFRvdWNoUG9pbnRzID0gdHlwZW9mIG5hdmlnYXRvciAhPT0gInVuZGVmaW5lZCIgJiYgbmF2aWdhdG9yLm1heFRvdWNoUG9pbnRzIHx8IDE7CiAgdmFyIGlzQW5kcm9pZCA9IC9BbmRyb2lkLy50ZXN0KHVzZXJBZ2VudCk7CiAgdmFyIGlzSUUgPSAvVHJpZGVudC8udGVzdCh1c2VyQWdlbnQpOwogIHZhciBpc0lPUyA9IC9cYihpUGFkfGlQaG9uZXxpUG9kKSg/PTspLy50ZXN0KHVzZXJBZ2VudCkgfHwgcGxhdGZvcm0gPT09ICJNYWNJbnRlbCIgJiYgbWF4VG91Y2hQb2ludHMgPiAxOwogIHZhciBpc0lPU0Nocm9tZSA9IC9DcmlPUy8udGVzdCh1c2VyQWdlbnQpOwoKICAoZnVuY3Rpb24gY2hlY2tPbkJsb2JTdXBwb3J0KCkgewogICAgaWYgKGlzSUUgfHwgaXNJT1NDaHJvbWUpIHsKICAgICAgY29tcGF0aWJpbGl0eVBhcmFtcy5kaXNhYmxlQ3JlYXRlT2JqZWN0VVJMID0gdHJ1ZTsKICAgIH0KICB9KSgpOwoKICAoZnVuY3Rpb24gY2hlY2tDYW52YXNTaXplTGltaXRhdGlvbigpIHsKICAgIGlmIChpc0lPUyB8fCBpc0FuZHJvaWQpIHsKICAgICAgY29tcGF0aWJpbGl0eVBhcmFtcy5tYXhDYW52YXNQaXhlbHMgPSA1MjQyODgwOwogICAgfQogIH0pKCk7Cn0KdmFyIHZpZXdlckNvbXBhdGliaWxpdHlQYXJhbXMgPSBPYmplY3QuZnJlZXplKGNvbXBhdGliaWxpdHlQYXJhbXMpOwpleHBvcnRzLnZpZXdlckNvbXBhdGliaWxpdHlQYXJhbXMgPSB2aWV3ZXJDb21wYXRpYmlsaXR5UGFyYW1zOwoKLyoqKi8gfSksCi8qIDggKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKInVzZSBzdHJpY3QiOwoKCnZhciBwZGZqc0xpYjsKCmlmICh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3dbInBkZmpzLWRpc3QvYnVpbGQvcGRmIl0pIHsKICBwZGZqc0xpYiA9IHdpbmRvd1sicGRmanMtZGlzdC9idWlsZC9wZGYiXTsKfSBlbHNlIHsKICBwZGZqc0xpYiA9IHJlcXVpcmUoInBkZi5taW4uanMiKTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBwZGZqc0xpYjsKCi8qKiovIH0pLAovKiA5ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuUERGQ3Vyc29yVG9vbHMgPSBleHBvcnRzLkN1cnNvclRvb2wgPSB2b2lkIDA7Cgp2YXIgX2dyYWJfdG9fcGFuID0gX193ZWJwYWNrX3JlcXVpcmVfXygxMCk7CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOyB9IH0KCmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9CgpmdW5jdGlvbiBfY3JlYXRlQ2xhc3MoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfQoKdmFyIEN1cnNvclRvb2wgPSB7CiAgU0VMRUNUOiAwLAogIEhBTkQ6IDEsCiAgWk9PTTogMgp9OwpleHBvcnRzLkN1cnNvclRvb2wgPSBDdXJzb3JUb29sOwoKdmFyIFBERkN1cnNvclRvb2xzID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICBmdW5jdGlvbiBQREZDdXJzb3JUb29scyhfcmVmKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIHZhciBjb250YWluZXIgPSBfcmVmLmNvbnRhaW5lciwKICAgICAgICBldmVudEJ1cyA9IF9yZWYuZXZlbnRCdXMsCiAgICAgICAgX3JlZiRjdXJzb3JUb29sT25Mb2FkID0gX3JlZi5jdXJzb3JUb29sT25Mb2FkLAogICAgICAgIGN1cnNvclRvb2xPbkxvYWQgPSBfcmVmJGN1cnNvclRvb2xPbkxvYWQgPT09IHZvaWQgMCA/IEN1cnNvclRvb2wuU0VMRUNUIDogX3JlZiRjdXJzb3JUb29sT25Mb2FkOwoKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBQREZDdXJzb3JUb29scyk7CgogICAgdGhpcy5jb250YWluZXIgPSBjb250YWluZXI7CiAgICB0aGlzLmV2ZW50QnVzID0gZXZlbnRCdXM7CiAgICB0aGlzLmFjdGl2ZSA9IEN1cnNvclRvb2wuU0VMRUNUOwogICAgdGhpcy5hY3RpdmVCZWZvcmVQcmVzZW50YXRpb25Nb2RlID0gbnVsbDsKICAgIHRoaXMuaGFuZFRvb2wgPSBuZXcgX2dyYWJfdG9fcGFuLkdyYWJUb1Bhbih7CiAgICAgIGVsZW1lbnQ6IHRoaXMuY29udGFpbmVyCiAgICB9KTsKCiAgICB0aGlzLl9hZGRFdmVudExpc3RlbmVycygpOwoKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICBfdGhpcy5zd2l0Y2hUb29sKGN1cnNvclRvb2xPbkxvYWQpOwogICAgfSk7CiAgfQoKICBfY3JlYXRlQ2xhc3MoUERGQ3Vyc29yVG9vbHMsIFt7CiAgICBrZXk6ICJzd2l0Y2hUb29sIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzd2l0Y2hUb29sKHRvb2wpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICBpZiAodGhpcy5hY3RpdmVCZWZvcmVQcmVzZW50YXRpb25Nb2RlICE9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAodG9vbCA9PT0gdGhpcy5hY3RpdmUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBkaXNhYmxlQWN0aXZlVG9vbCA9IGZ1bmN0aW9uIGRpc2FibGVBY3RpdmVUb29sKCkgewogICAgICAgIHN3aXRjaCAoX3RoaXMyLmFjdGl2ZSkgewogICAgICAgICAgY2FzZSBDdXJzb3JUb29sLlNFTEVDVDoKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSBDdXJzb3JUb29sLkhBTkQ6CiAgICAgICAgICAgIF90aGlzMi5oYW5kVG9vbC5kZWFjdGl2YXRlKCk7CgogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIEN1cnNvclRvb2wuWk9PTToKICAgICAgICB9CiAgICAgIH07CgogICAgICBzd2l0Y2ggKHRvb2wpIHsKICAgICAgICBjYXNlIEN1cnNvclRvb2wuU0VMRUNUOgogICAgICAgICAgZGlzYWJsZUFjdGl2ZVRvb2woKTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlIEN1cnNvclRvb2wuSEFORDoKICAgICAgICAgIGRpc2FibGVBY3RpdmVUb29sKCk7CiAgICAgICAgICB0aGlzLmhhbmRUb29sLmFjdGl2YXRlKCk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSBDdXJzb3JUb29sLlpPT006CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoInN3aXRjaFRvb2w6IFwiIi5jb25jYXQodG9vbCwgIlwiIGlzIGFuIHVuc3VwcG9ydGVkIHZhbHVlLiIpKTsKICAgICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5hY3RpdmUgPSB0b29sOwoKICAgICAgdGhpcy5fZGlzcGF0Y2hFdmVudCgpOwogICAgfQogIH0sIHsKICAgIGtleTogIl9kaXNwYXRjaEV2ZW50IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfZGlzcGF0Y2hFdmVudCgpIHsKICAgICAgdGhpcy5ldmVudEJ1cy5kaXNwYXRjaCgiY3Vyc29ydG9vbGNoYW5nZWQiLCB7CiAgICAgICAgc291cmNlOiB0aGlzLAogICAgICAgIHRvb2w6IHRoaXMuYWN0aXZlCiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogIl9hZGRFdmVudExpc3RlbmVycyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2FkZEV2ZW50TGlzdGVuZXJzKCkgewogICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgIHRoaXMuZXZlbnRCdXMuX29uKCJzd2l0Y2hjdXJzb3J0b29sIiwgZnVuY3Rpb24gKGV2dCkgewogICAgICAgIF90aGlzMy5zd2l0Y2hUb29sKGV2dC50b29sKTsKICAgICAgfSk7CgogICAgICB0aGlzLmV2ZW50QnVzLl9vbigicHJlc2VudGF0aW9ubW9kZWNoYW5nZWQiLCBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgICAgaWYgKGV2dC5zd2l0Y2hJblByb2dyZXNzKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgcHJldmlvdXNseUFjdGl2ZTsKCiAgICAgICAgaWYgKGV2dC5hY3RpdmUpIHsKICAgICAgICAgIHByZXZpb3VzbHlBY3RpdmUgPSBfdGhpczMuYWN0aXZlOwoKICAgICAgICAgIF90aGlzMy5zd2l0Y2hUb29sKEN1cnNvclRvb2wuU0VMRUNUKTsKCiAgICAgICAgICBfdGhpczMuYWN0aXZlQmVmb3JlUHJlc2VudGF0aW9uTW9kZSA9IHByZXZpb3VzbHlBY3RpdmU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHByZXZpb3VzbHlBY3RpdmUgPSBfdGhpczMuYWN0aXZlQmVmb3JlUHJlc2VudGF0aW9uTW9kZTsKICAgICAgICAgIF90aGlzMy5hY3RpdmVCZWZvcmVQcmVzZW50YXRpb25Nb2RlID0gbnVsbDsKCiAgICAgICAgICBfdGhpczMuc3dpdGNoVG9vbChwcmV2aW91c2x5QWN0aXZlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogImFjdGl2ZVRvb2wiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLmFjdGl2ZTsKICAgIH0KICB9XSk7CgogIHJldHVybiBQREZDdXJzb3JUb29sczsKfSgpOwoKZXhwb3J0cy5QREZDdXJzb3JUb29scyA9IFBERkN1cnNvclRvb2xzOwoKLyoqKi8gfSksCi8qIDEwICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuR3JhYlRvUGFuID0gR3JhYlRvUGFuOwoKZnVuY3Rpb24gR3JhYlRvUGFuKG9wdGlvbnMpIHsKICB0aGlzLmVsZW1lbnQgPSBvcHRpb25zLmVsZW1lbnQ7CiAgdGhpcy5kb2N1bWVudCA9IG9wdGlvbnMuZWxlbWVudC5vd25lckRvY3VtZW50OwoKICBpZiAodHlwZW9mIG9wdGlvbnMuaWdub3JlVGFyZ2V0ID09PSAiZnVuY3Rpb24iKSB7CiAgICB0aGlzLmlnbm9yZVRhcmdldCA9IG9wdGlvbnMuaWdub3JlVGFyZ2V0OwogIH0KCiAgdGhpcy5vbkFjdGl2ZUNoYW5nZWQgPSBvcHRpb25zLm9uQWN0aXZlQ2hhbmdlZDsKICB0aGlzLmFjdGl2YXRlID0gdGhpcy5hY3RpdmF0ZS5iaW5kKHRoaXMpOwogIHRoaXMuZGVhY3RpdmF0ZSA9IHRoaXMuZGVhY3RpdmF0ZS5iaW5kKHRoaXMpOwogIHRoaXMudG9nZ2xlID0gdGhpcy50b2dnbGUuYmluZCh0aGlzKTsKICB0aGlzLl9vbm1vdXNlZG93biA9IHRoaXMuX29ubW91c2Vkb3duLmJpbmQodGhpcyk7CiAgdGhpcy5fb25tb3VzZW1vdmUgPSB0aGlzLl9vbm1vdXNlbW92ZS5iaW5kKHRoaXMpOwogIHRoaXMuX2VuZFBhbiA9IHRoaXMuX2VuZFBhbi5iaW5kKHRoaXMpOwogIHZhciBvdmVybGF5ID0gdGhpcy5vdmVybGF5ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgb3ZlcmxheS5jbGFzc05hbWUgPSAiZ3JhYi10by1wYW4tZ3JhYmJpbmciOwp9CgpHcmFiVG9QYW4ucHJvdG90eXBlID0gewogIENTU19DTEFTU19HUkFCOiAiZ3JhYi10by1wYW4tZ3JhYiIsCiAgYWN0aXZhdGU6IGZ1bmN0aW9uIEdyYWJUb1Bhbl9hY3RpdmF0ZSgpIHsKICAgIGlmICghdGhpcy5hY3RpdmUpIHsKICAgICAgdGhpcy5hY3RpdmUgPSB0cnVlOwogICAgICB0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigibW91c2Vkb3duIiwgdGhpcy5fb25tb3VzZWRvd24sIHRydWUpOwogICAgICB0aGlzLmVsZW1lbnQuY2xhc3NMaXN0LmFkZCh0aGlzLkNTU19DTEFTU19HUkFCKTsKCiAgICAgIGlmICh0aGlzLm9uQWN0aXZlQ2hhbmdlZCkgewogICAgICAgIHRoaXMub25BY3RpdmVDaGFuZ2VkKHRydWUpOwogICAgICB9CiAgICB9CiAgfSwKICBkZWFjdGl2YXRlOiBmdW5jdGlvbiBHcmFiVG9QYW5fZGVhY3RpdmF0ZSgpIHsKICAgIGlmICh0aGlzLmFjdGl2ZSkgewogICAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwogICAgICB0aGlzLmVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigibW91c2Vkb3duIiwgdGhpcy5fb25tb3VzZWRvd24sIHRydWUpOwoKICAgICAgdGhpcy5fZW5kUGFuKCk7CgogICAgICB0aGlzLmVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZSh0aGlzLkNTU19DTEFTU19HUkFCKTsKCiAgICAgIGlmICh0aGlzLm9uQWN0aXZlQ2hhbmdlZCkgewogICAgICAgIHRoaXMub25BY3RpdmVDaGFuZ2VkKGZhbHNlKTsKICAgICAgfQogICAgfQogIH0sCiAgdG9nZ2xlOiBmdW5jdGlvbiBHcmFiVG9QYW5fdG9nZ2xlKCkgewogICAgaWYgKHRoaXMuYWN0aXZlKSB7CiAgICAgIHRoaXMuZGVhY3RpdmF0ZSgpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5hY3RpdmF0ZSgpOwogICAgfQogIH0sCiAgaWdub3JlVGFyZ2V0OiBmdW5jdGlvbiBHcmFiVG9QYW5faWdub3JlVGFyZ2V0KG5vZGUpIHsKICAgIHJldHVybiBub2RlW21hdGNoZXNTZWxlY3Rvcl0oImFbaHJlZl0sIGFbaHJlZl0gKiwgaW5wdXQsIHRleHRhcmVhLCBidXR0b24sIGJ1dHRvbiAqLCBzZWxlY3QsIG9wdGlvbiIpOwogIH0sCiAgX29ubW91c2Vkb3duOiBmdW5jdGlvbiBHcmFiVG9QYW5fX29ubW91c2Vkb3duKGV2ZW50KSB7CiAgICBpZiAoZXZlbnQuYnV0dG9uICE9PSAwIHx8IHRoaXMuaWdub3JlVGFyZ2V0KGV2ZW50LnRhcmdldCkpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChldmVudC5vcmlnaW5hbFRhcmdldCkgewogICAgICB0cnkgewogICAgICAgIGV2ZW50Lm9yaWdpbmFsVGFyZ2V0LnRhZ05hbWU7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KCiAgICB0aGlzLnNjcm9sbExlZnRTdGFydCA9IHRoaXMuZWxlbWVudC5zY3JvbGxMZWZ0OwogICAgdGhpcy5zY3JvbGxUb3BTdGFydCA9IHRoaXMuZWxlbWVudC5zY3JvbGxUb3A7CiAgICB0aGlzLmNsaWVudFhTdGFydCA9IGV2ZW50LmNsaWVudFg7CiAgICB0aGlzLmNsaWVudFlTdGFydCA9IGV2ZW50LmNsaWVudFk7CiAgICB0aGlzLmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlbW92ZSIsIHRoaXMuX29ubW91c2Vtb3ZlLCB0cnVlKTsKICAgIHRoaXMuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigibW91c2V1cCIsIHRoaXMuX2VuZFBhbiwgdHJ1ZSk7CiAgICB0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigic2Nyb2xsIiwgdGhpcy5fZW5kUGFuLCB0cnVlKTsKICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgIHZhciBmb2N1c2VkRWxlbWVudCA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7CgogICAgaWYgKGZvY3VzZWRFbGVtZW50ICYmICFmb2N1c2VkRWxlbWVudC5jb250YWlucyhldmVudC50YXJnZXQpKSB7CiAgICAgIGZvY3VzZWRFbGVtZW50LmJsdXIoKTsKICAgIH0KICB9LAogIF9vbm1vdXNlbW92ZTogZnVuY3Rpb24gR3JhYlRvUGFuX19vbm1vdXNlbW92ZShldmVudCkgewogICAgdGhpcy5lbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoInNjcm9sbCIsIHRoaXMuX2VuZFBhbiwgdHJ1ZSk7CgogICAgaWYgKGlzTGVmdE1vdXNlUmVsZWFzZWQoZXZlbnQpKSB7CiAgICAgIHRoaXMuX2VuZFBhbigpOwoKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciB4RGlmZiA9IGV2ZW50LmNsaWVudFggLSB0aGlzLmNsaWVudFhTdGFydDsKICAgIHZhciB5RGlmZiA9IGV2ZW50LmNsaWVudFkgLSB0aGlzLmNsaWVudFlTdGFydDsKICAgIHZhciBzY3JvbGxUb3AgPSB0aGlzLnNjcm9sbFRvcFN0YXJ0IC0geURpZmY7CiAgICB2YXIgc2Nyb2xsTGVmdCA9IHRoaXMuc2Nyb2xsTGVmdFN0YXJ0IC0geERpZmY7CgogICAgaWYgKHRoaXMuZWxlbWVudC5zY3JvbGxUbykgewogICAgICB0aGlzLmVsZW1lbnQuc2Nyb2xsVG8oewogICAgICAgIHRvcDogc2Nyb2xsVG9wLAogICAgICAgIGxlZnQ6IHNjcm9sbExlZnQsCiAgICAgICAgYmVoYXZpb3I6ICJpbnN0YW50IgogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuZWxlbWVudC5zY3JvbGxUb3AgPSBzY3JvbGxUb3A7CiAgICAgIHRoaXMuZWxlbWVudC5zY3JvbGxMZWZ0ID0gc2Nyb2xsTGVmdDsKICAgIH0KCiAgICBpZiAoIXRoaXMub3ZlcmxheS5wYXJlbnROb2RlKSB7CiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5vdmVybGF5KTsKICAgIH0KICB9LAogIF9lbmRQYW46IGZ1bmN0aW9uIEdyYWJUb1Bhbl9fZW5kUGFuKCkgewogICAgdGhpcy5lbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoInNjcm9sbCIsIHRoaXMuX2VuZFBhbiwgdHJ1ZSk7CiAgICB0aGlzLmRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vdXNlbW92ZSIsIHRoaXMuX29ubW91c2Vtb3ZlLCB0cnVlKTsKICAgIHRoaXMuZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigibW91c2V1cCIsIHRoaXMuX2VuZFBhbiwgdHJ1ZSk7CiAgICB0aGlzLm92ZXJsYXkucmVtb3ZlKCk7CiAgfQp9Owp2YXIgbWF0Y2hlc1NlbGVjdG9yOwpbIndlYmtpdE0iLCAibW96TSIsICJtc00iLCAib00iLCAibSJdLnNvbWUoZnVuY3Rpb24gKHByZWZpeCkgewogIHZhciBuYW1lID0gcHJlZml4ICsgImF0Y2hlcyI7CgogIGlmIChuYW1lIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkgewogICAgbWF0Y2hlc1NlbGVjdG9yID0gbmFtZTsKICB9CgogIG5hbWUgKz0gIlNlbGVjdG9yIjsKCiAgaWYgKG5hbWUgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KSB7CiAgICBtYXRjaGVzU2VsZWN0b3IgPSBuYW1lOwogIH0KCiAgcmV0dXJuIG1hdGNoZXNTZWxlY3RvcjsKfSk7CnZhciBpc05vdElFb3JJc0lFMTBwbHVzID0gIWRvY3VtZW50LmRvY3VtZW50TW9kZSB8fCBkb2N1bWVudC5kb2N1bWVudE1vZGUgPiA5Owp2YXIgY2hyb21lID0gd2luZG93LmNocm9tZTsKdmFyIGlzQ2hyb21lMTVPck9wZXJhMTVwbHVzID0gY2hyb21lICYmIChjaHJvbWUud2Vic3RvcmUgfHwgY2hyb21lLmFwcCk7CnZhciBpc1NhZmFyaTZwbHVzID0gL0FwcGxlLy50ZXN0KG5hdmlnYXRvci52ZW5kb3IpICYmIC9WZXJzaW9uXC8oWzYtOV1cZCp8WzEtNV1cZCspLy50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpOwoKZnVuY3Rpb24gaXNMZWZ0TW91c2VSZWxlYXNlZChldmVudCkgewogIGlmICgiYnV0dG9ucyIgaW4gZXZlbnQgJiYgaXNOb3RJRW9ySXNJRTEwcGx1cykgewogICAgcmV0dXJuICEoZXZlbnQuYnV0dG9ucyAmIDEpOwogIH0KCiAgaWYgKGlzQ2hyb21lMTVPck9wZXJhMTVwbHVzIHx8IGlzU2FmYXJpNnBsdXMpIHsKICAgIHJldHVybiBldmVudC53aGljaCA9PT0gMDsKICB9CgogIHJldHVybiBmYWxzZTsKfQoKLyoqKi8gfSksCi8qIDExICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuUERGUmVuZGVyaW5nUXVldWUgPSBleHBvcnRzLlJlbmRlcmluZ1N0YXRlcyA9IHZvaWQgMDsKCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7IH0gfQoKZnVuY3Rpb24gX2RlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoInZhbHVlIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0KCmZ1bmN0aW9uIF9jcmVhdGVDbGFzcyhDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9Cgp2YXIgQ0xFQU5VUF9USU1FT1VUID0gMzAwMDA7CnZhciBSZW5kZXJpbmdTdGF0ZXMgPSB7CiAgSU5JVElBTDogMCwKICBSVU5OSU5HOiAxLAogIFBBVVNFRDogMiwKICBGSU5JU0hFRDogMwp9OwpleHBvcnRzLlJlbmRlcmluZ1N0YXRlcyA9IFJlbmRlcmluZ1N0YXRlczsKCnZhciBQREZSZW5kZXJpbmdRdWV1ZSA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gUERGUmVuZGVyaW5nUXVldWUoKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgUERGUmVuZGVyaW5nUXVldWUpOwoKICAgIHRoaXMucGRmVmlld2VyID0gbnVsbDsKICAgIHRoaXMucGRmVGh1bWJuYWlsVmlld2VyID0gbnVsbDsKICAgIHRoaXMub25JZGxlID0gbnVsbDsKICAgIHRoaXMuaGlnaGVzdFByaW9yaXR5UGFnZSA9IG51bGw7CiAgICB0aGlzLmlkbGVUaW1lb3V0ID0gbnVsbDsKICAgIHRoaXMucHJpbnRpbmcgPSBmYWxzZTsKICAgIHRoaXMuaXNUaHVtYm5haWxWaWV3RW5hYmxlZCA9IGZhbHNlOwogIH0KCiAgX2NyZWF0ZUNsYXNzKFBERlJlbmRlcmluZ1F1ZXVlLCBbewogICAga2V5OiAic2V0Vmlld2VyIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRWaWV3ZXIocGRmVmlld2VyKSB7CiAgICAgIHRoaXMucGRmVmlld2VyID0gcGRmVmlld2VyOwogICAgfQogIH0sIHsKICAgIGtleTogInNldFRodW1ibmFpbFZpZXdlciIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2V0VGh1bWJuYWlsVmlld2VyKHBkZlRodW1ibmFpbFZpZXdlcikgewogICAgICB0aGlzLnBkZlRodW1ibmFpbFZpZXdlciA9IHBkZlRodW1ibmFpbFZpZXdlcjsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJpc0hpZ2hlc3RQcmlvcml0eSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gaXNIaWdoZXN0UHJpb3JpdHkodmlldykgewogICAgICByZXR1cm4gdGhpcy5oaWdoZXN0UHJpb3JpdHlQYWdlID09PSB2aWV3LnJlbmRlcmluZ0lkOwogICAgfQogIH0sIHsKICAgIGtleTogInJlbmRlckhpZ2hlc3RQcmlvcml0eSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVySGlnaGVzdFByaW9yaXR5KGN1cnJlbnRseVZpc2libGVQYWdlcykgewogICAgICBpZiAodGhpcy5pZGxlVGltZW91dCkgewogICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmlkbGVUaW1lb3V0KTsKICAgICAgICB0aGlzLmlkbGVUaW1lb3V0ID0gbnVsbDsKICAgICAgfQoKICAgICAgaWYgKHRoaXMucGRmVmlld2VyLmZvcmNlUmVuZGVyaW5nKGN1cnJlbnRseVZpc2libGVQYWdlcykpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnBkZlRodW1ibmFpbFZpZXdlciAmJiB0aGlzLmlzVGh1bWJuYWlsVmlld0VuYWJsZWQpIHsKICAgICAgICBpZiAodGhpcy5wZGZUaHVtYm5haWxWaWV3ZXIuZm9yY2VSZW5kZXJpbmcoKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHRoaXMucHJpbnRpbmcpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLm9uSWRsZSkgewogICAgICAgIHRoaXMuaWRsZVRpbWVvdXQgPSBzZXRUaW1lb3V0KHRoaXMub25JZGxlLmJpbmQodGhpcyksIENMRUFOVVBfVElNRU9VVCk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJnZXRIaWdoZXN0UHJpb3JpdHkiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGdldEhpZ2hlc3RQcmlvcml0eSh2aXNpYmxlLCB2aWV3cywgc2Nyb2xsZWREb3duKSB7CiAgICAgIHZhciB2aXNpYmxlVmlld3MgPSB2aXNpYmxlLnZpZXdzOwogICAgICB2YXIgbnVtVmlzaWJsZSA9IHZpc2libGVWaWV3cy5sZW5ndGg7CgogICAgICBpZiAobnVtVmlzaWJsZSA9PT0gMCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG51bVZpc2libGU7ICsraSkgewogICAgICAgIHZhciB2aWV3ID0gdmlzaWJsZVZpZXdzW2ldLnZpZXc7CgogICAgICAgIGlmICghdGhpcy5pc1ZpZXdGaW5pc2hlZCh2aWV3KSkgewogICAgICAgICAgcmV0dXJuIHZpZXc7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoc2Nyb2xsZWREb3duKSB7CiAgICAgICAgdmFyIG5leHRQYWdlSW5kZXggPSB2aXNpYmxlLmxhc3QuaWQ7CgogICAgICAgIGlmICh2aWV3c1tuZXh0UGFnZUluZGV4XSAmJiAhdGhpcy5pc1ZpZXdGaW5pc2hlZCh2aWV3c1tuZXh0UGFnZUluZGV4XSkpIHsKICAgICAgICAgIHJldHVybiB2aWV3c1tuZXh0UGFnZUluZGV4XTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHByZXZpb3VzUGFnZUluZGV4ID0gdmlzaWJsZS5maXJzdC5pZCAtIDI7CgogICAgICAgIGlmICh2aWV3c1twcmV2aW91c1BhZ2VJbmRleF0gJiYgIXRoaXMuaXNWaWV3RmluaXNoZWQodmlld3NbcHJldmlvdXNQYWdlSW5kZXhdKSkgewogICAgICAgICAgcmV0dXJuIHZpZXdzW3ByZXZpb3VzUGFnZUluZGV4XTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBudWxsOwogICAgfQogIH0sIHsKICAgIGtleTogImlzVmlld0ZpbmlzaGVkIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBpc1ZpZXdGaW5pc2hlZCh2aWV3KSB7CiAgICAgIHJldHVybiB2aWV3LnJlbmRlcmluZ1N0YXRlID09PSBSZW5kZXJpbmdTdGF0ZXMuRklOSVNIRUQ7CiAgICB9CiAgfSwgewogICAga2V5OiAicmVuZGVyVmlldyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyVmlldyh2aWV3KSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBzd2l0Y2ggKHZpZXcucmVuZGVyaW5nU3RhdGUpIHsKICAgICAgICBjYXNlIFJlbmRlcmluZ1N0YXRlcy5GSU5JU0hFRDoKICAgICAgICAgIHJldHVybiBmYWxzZTsKCiAgICAgICAgY2FzZSBSZW5kZXJpbmdTdGF0ZXMuUEFVU0VEOgogICAgICAgICAgdGhpcy5oaWdoZXN0UHJpb3JpdHlQYWdlID0gdmlldy5yZW5kZXJpbmdJZDsKICAgICAgICAgIHZpZXcucmVzdW1lKCk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSBSZW5kZXJpbmdTdGF0ZXMuUlVOTklORzoKICAgICAgICAgIHRoaXMuaGlnaGVzdFByaW9yaXR5UGFnZSA9IHZpZXcucmVuZGVyaW5nSWQ7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSBSZW5kZXJpbmdTdGF0ZXMuSU5JVElBTDoKICAgICAgICAgIHRoaXMuaGlnaGVzdFByaW9yaXR5UGFnZSA9IHZpZXcucmVuZGVyaW5nSWQ7CiAgICAgICAgICB2aWV3LmRyYXcoKVsiZmluYWxseSJdKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgX3RoaXMucmVuZGVySGlnaGVzdFByaW9yaXR5KCk7CiAgICAgICAgICB9KVsiY2F0Y2giXShmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoInJlbmRlclZpZXc6IFwiIi5jb25jYXQocmVhc29uLCAiXCIiKSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9XSk7CgogIHJldHVybiBQREZSZW5kZXJpbmdRdWV1ZTsKfSgpOwoKZXhwb3J0cy5QREZSZW5kZXJpbmdRdWV1ZSA9IFBERlJlbmRlcmluZ1F1ZXVlOwoKLyoqKi8gfSksCi8qIDEyICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuUERGU2lkZWJhciA9IGV4cG9ydHMuU2lkZWJhclZpZXcgPSB2b2lkIDA7Cgp2YXIgX3VpX3V0aWxzID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1KTsKCnZhciBfcGRmX3JlbmRlcmluZ19xdWV1ZSA9IF9fd2VicGFja19yZXF1aXJlX18oMTEpOwoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsgfSB9CgpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfQoKZnVuY3Rpb24gX2NyZWF0ZUNsYXNzKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH0KCnZhciBVSV9OT1RJRklDQVRJT05fQ0xBU1MgPSAicGRmU2lkZWJhck5vdGlmaWNhdGlvbiI7CnZhciBTaWRlYmFyVmlldyA9IHsKICBVTktOT1dOOiAtMSwKICBOT05FOiAwLAogIFRIVU1CUzogMSwKICBPVVRMSU5FOiAyLAogIEFUVEFDSE1FTlRTOiAzLAogIExBWUVSUzogNAp9OwpleHBvcnRzLlNpZGViYXJWaWV3ID0gU2lkZWJhclZpZXc7Cgp2YXIgUERGU2lkZWJhciA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gUERGU2lkZWJhcihfcmVmKSB7CiAgICB2YXIgZWxlbWVudHMgPSBfcmVmLmVsZW1lbnRzLAogICAgICAgIHBkZlZpZXdlciA9IF9yZWYucGRmVmlld2VyLAogICAgICAgIHBkZlRodW1ibmFpbFZpZXdlciA9IF9yZWYucGRmVGh1bWJuYWlsVmlld2VyLAogICAgICAgIGV2ZW50QnVzID0gX3JlZi5ldmVudEJ1cywKICAgICAgICBfcmVmJGwxMG4gPSBfcmVmLmwxMG4sCiAgICAgICAgbDEwbiA9IF9yZWYkbDEwbiA9PT0gdm9pZCAwID8gX3VpX3V0aWxzLk51bGxMMTBuIDogX3JlZiRsMTBuLAogICAgICAgIF9yZWYkZGlzYWJsZU5vdGlmaWNhdCA9IF9yZWYuZGlzYWJsZU5vdGlmaWNhdGlvbiwKICAgICAgICBkaXNhYmxlTm90aWZpY2F0aW9uID0gX3JlZiRkaXNhYmxlTm90aWZpY2F0ID09PSB2b2lkIDAgPyBmYWxzZSA6IF9yZWYkZGlzYWJsZU5vdGlmaWNhdDsKCiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgUERGU2lkZWJhcik7CgogICAgdGhpcy5pc09wZW4gPSBmYWxzZTsKICAgIHRoaXMuYWN0aXZlID0gU2lkZWJhclZpZXcuVEhVTUJTOwogICAgdGhpcy5pc0luaXRpYWxWaWV3U2V0ID0gZmFsc2U7CiAgICB0aGlzLm9uVG9nZ2xlZCA9IG51bGw7CiAgICB0aGlzLnBkZlZpZXdlciA9IHBkZlZpZXdlcjsKICAgIHRoaXMucGRmVGh1bWJuYWlsVmlld2VyID0gcGRmVGh1bWJuYWlsVmlld2VyOwogICAgdGhpcy5vdXRlckNvbnRhaW5lciA9IGVsZW1lbnRzLm91dGVyQ29udGFpbmVyOwogICAgdGhpcy52aWV3ZXJDb250YWluZXIgPSBlbGVtZW50cy52aWV3ZXJDb250YWluZXI7CiAgICB0aGlzLnRvZ2dsZUJ1dHRvbiA9IGVsZW1lbnRzLnRvZ2dsZUJ1dHRvbjsKICAgIHRoaXMudGh1bWJuYWlsQnV0dG9uID0gZWxlbWVudHMudGh1bWJuYWlsQnV0dG9uOwogICAgdGhpcy5vdXRsaW5lQnV0dG9uID0gZWxlbWVudHMub3V0bGluZUJ1dHRvbjsKICAgIHRoaXMuYXR0YWNobWVudHNCdXR0b24gPSBlbGVtZW50cy5hdHRhY2htZW50c0J1dHRvbjsKICAgIHRoaXMudGh1bWJuYWlsVmlldyA9IGVsZW1lbnRzLnRodW1ibmFpbFZpZXc7CiAgICB0aGlzLm91dGxpbmVWaWV3ID0gZWxlbWVudHMub3V0bGluZVZpZXc7CiAgICB0aGlzLmF0dGFjaG1lbnRzVmlldyA9IGVsZW1lbnRzLmF0dGFjaG1lbnRzVmlldzsKICAgIHRoaXMuZXZlbnRCdXMgPSBldmVudEJ1czsKICAgIHRoaXMubDEwbiA9IGwxMG47CiAgICB0aGlzLl9kaXNhYmxlTm90aWZpY2F0aW9uID0gZGlzYWJsZU5vdGlmaWNhdGlvbjsKCiAgICB0aGlzLl9hZGRFdmVudExpc3RlbmVycygpOwogIH0KCiAgX2NyZWF0ZUNsYXNzKFBERlNpZGViYXIsIFt7CiAgICBrZXk6ICJyZXNldCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVzZXQoKSB7CiAgICAgIHRoaXMuaXNJbml0aWFsVmlld1NldCA9IGZhbHNlOwoKICAgICAgdGhpcy5faGlkZVVJTm90aWZpY2F0aW9uKG51bGwpOwoKICAgICAgdGhpcy5zd2l0Y2hWaWV3KFNpZGViYXJWaWV3LlRIVU1CUyk7CiAgICAgIHRoaXMub3V0bGluZUJ1dHRvbi5kaXNhYmxlZCA9IGZhbHNlOwogICAgICB0aGlzLmF0dGFjaG1lbnRzQnV0dG9uLmRpc2FibGVkID0gZmFsc2U7CiAgICB9CiAgfSwgewogICAga2V5OiAic2V0SW5pdGlhbFZpZXciLAogICAgdmFsdWU6IGZ1bmN0aW9uIHNldEluaXRpYWxWaWV3KCkgewogICAgICB2YXIgdmlldyA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDogU2lkZWJhclZpZXcuTk9ORTsKCiAgICAgIGlmICh0aGlzLmlzSW5pdGlhbFZpZXdTZXQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMuaXNJbml0aWFsVmlld1NldCA9IHRydWU7CgogICAgICBpZiAodmlldyA9PT0gU2lkZWJhclZpZXcuTk9ORSB8fCB2aWV3ID09PSBTaWRlYmFyVmlldy5VTktOT1dOKSB7CiAgICAgICAgdGhpcy5fZGlzcGF0Y2hFdmVudCgpOwoKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5fc3dpdGNoVmlldyh2aWV3LCB0cnVlKSkgewogICAgICAgIHRoaXMuX2Rpc3BhdGNoRXZlbnQoKTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogInN3aXRjaFZpZXciLAogICAgdmFsdWU6IGZ1bmN0aW9uIHN3aXRjaFZpZXcodmlldykgewogICAgICB2YXIgZm9yY2VPcGVuID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiBmYWxzZTsKCiAgICAgIHRoaXMuX3N3aXRjaFZpZXcodmlldywgZm9yY2VPcGVuKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfc3dpdGNoVmlldyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3N3aXRjaFZpZXcodmlldykgewogICAgICB2YXIgZm9yY2VPcGVuID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiBmYWxzZTsKICAgICAgdmFyIGlzVmlld0NoYW5nZWQgPSB2aWV3ICE9PSB0aGlzLmFjdGl2ZTsKICAgICAgdmFyIHNob3VsZEZvcmNlUmVuZGVyaW5nID0gZmFsc2U7CgogICAgICBzd2l0Y2ggKHZpZXcpIHsKICAgICAgICBjYXNlIFNpZGViYXJWaWV3Lk5PTkU6CiAgICAgICAgICBpZiAodGhpcy5pc09wZW4pIHsKICAgICAgICAgICAgdGhpcy5jbG9zZSgpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgICAgIGNhc2UgU2lkZWJhclZpZXcuVEhVTUJTOgogICAgICAgICAgaWYgKHRoaXMuaXNPcGVuICYmIGlzVmlld0NoYW5nZWQpIHsKICAgICAgICAgICAgc2hvdWxkRm9yY2VSZW5kZXJpbmcgPSB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlIFNpZGViYXJWaWV3Lk9VVExJTkU6CiAgICAgICAgICBpZiAodGhpcy5vdXRsaW5lQnV0dG9uLmRpc2FibGVkKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KCiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSBTaWRlYmFyVmlldy5BVFRBQ0hNRU5UUzoKICAgICAgICAgIGlmICh0aGlzLmF0dGFjaG1lbnRzQnV0dG9uLmRpc2FibGVkKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KCiAgICAgICAgICBicmVhazsKCiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIlBERlNpZGViYXIuX3N3aXRjaFZpZXc6IFwiIi5jb25jYXQodmlldywgIlwiIGlzIG5vdCBhIHZhbGlkIHZpZXcuIikpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICB0aGlzLmFjdGl2ZSA9IHZpZXc7CiAgICAgIHRoaXMudGh1bWJuYWlsQnV0dG9uLmNsYXNzTGlzdC50b2dnbGUoInRvZ2dsZWQiLCB2aWV3ID09PSBTaWRlYmFyVmlldy5USFVNQlMpOwogICAgICB0aGlzLm91dGxpbmVCdXR0b24uY2xhc3NMaXN0LnRvZ2dsZSgidG9nZ2xlZCIsIHZpZXcgPT09IFNpZGViYXJWaWV3Lk9VVExJTkUpOwogICAgICB0aGlzLmF0dGFjaG1lbnRzQnV0dG9uLmNsYXNzTGlzdC50b2dnbGUoInRvZ2dsZWQiLCB2aWV3ID09PSBTaWRlYmFyVmlldy5BVFRBQ0hNRU5UUyk7CiAgICAgIHRoaXMudGh1bWJuYWlsVmlldy5jbGFzc0xpc3QudG9nZ2xlKCJoaWRkZW4iLCB2aWV3ICE9PSBTaWRlYmFyVmlldy5USFVNQlMpOwogICAgICB0aGlzLm91dGxpbmVWaWV3LmNsYXNzTGlzdC50b2dnbGUoImhpZGRlbiIsIHZpZXcgIT09IFNpZGViYXJWaWV3Lk9VVExJTkUpOwogICAgICB0aGlzLmF0dGFjaG1lbnRzVmlldy5jbGFzc0xpc3QudG9nZ2xlKCJoaWRkZW4iLCB2aWV3ICE9PSBTaWRlYmFyVmlldy5BVFRBQ0hNRU5UUyk7CgogICAgICBpZiAoZm9yY2VPcGVuICYmICF0aGlzLmlzT3BlbikgewogICAgICAgIHRoaXMub3BlbigpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICBpZiAoc2hvdWxkRm9yY2VSZW5kZXJpbmcpIHsKICAgICAgICB0aGlzLl91cGRhdGVUaHVtYm5haWxWaWV3ZXIoKTsKCiAgICAgICAgdGhpcy5fZm9yY2VSZW5kZXJpbmcoKTsKICAgICAgfQoKICAgICAgaWYgKGlzVmlld0NoYW5nZWQpIHsKICAgICAgICB0aGlzLl9kaXNwYXRjaEV2ZW50KCk7CiAgICAgIH0KCiAgICAgIHRoaXMuX2hpZGVVSU5vdGlmaWNhdGlvbih0aGlzLmFjdGl2ZSk7CgogICAgICByZXR1cm4gaXNWaWV3Q2hhbmdlZDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJvcGVuIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBvcGVuKCkgewogICAgICBpZiAodGhpcy5pc09wZW4pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMuaXNPcGVuID0gdHJ1ZTsKICAgICAgdGhpcy50b2dnbGVCdXR0b24uY2xhc3NMaXN0LmFkZCgidG9nZ2xlZCIpOwogICAgICB0aGlzLm91dGVyQ29udGFpbmVyLmNsYXNzTGlzdC5hZGQoInNpZGViYXJNb3ZpbmciLCAic2lkZWJhck9wZW4iKTsKCiAgICAgIGlmICh0aGlzLmFjdGl2ZSA9PT0gU2lkZWJhclZpZXcuVEhVTUJTKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlVGh1bWJuYWlsVmlld2VyKCk7CiAgICAgIH0KCiAgICAgIHRoaXMuX2ZvcmNlUmVuZGVyaW5nKCk7CgogICAgICB0aGlzLl9kaXNwYXRjaEV2ZW50KCk7CgogICAgICB0aGlzLl9oaWRlVUlOb3RpZmljYXRpb24odGhpcy5hY3RpdmUpOwogICAgfQogIH0sIHsKICAgIGtleTogImNsb3NlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjbG9zZSgpIHsKICAgICAgaWYgKCF0aGlzLmlzT3BlbikgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5pc09wZW4gPSBmYWxzZTsKICAgICAgdGhpcy50b2dnbGVCdXR0b24uY2xhc3NMaXN0LnJlbW92ZSgidG9nZ2xlZCIpOwogICAgICB0aGlzLm91dGVyQ29udGFpbmVyLmNsYXNzTGlzdC5hZGQoInNpZGViYXJNb3ZpbmciKTsKICAgICAgdGhpcy5vdXRlckNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCJzaWRlYmFyT3BlbiIpOwoKICAgICAgdGhpcy5fZm9yY2VSZW5kZXJpbmcoKTsKCiAgICAgIHRoaXMuX2Rpc3BhdGNoRXZlbnQoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJ0b2dnbGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHRvZ2dsZSgpIHsKICAgICAgaWYgKHRoaXMuaXNPcGVuKSB7CiAgICAgICAgdGhpcy5jbG9zZSgpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMub3BlbigpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAiX2Rpc3BhdGNoRXZlbnQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9kaXNwYXRjaEV2ZW50KCkgewogICAgICB0aGlzLmV2ZW50QnVzLmRpc3BhdGNoKCJzaWRlYmFydmlld2NoYW5nZWQiLCB7CiAgICAgICAgc291cmNlOiB0aGlzLAogICAgICAgIHZpZXc6IHRoaXMudmlzaWJsZVZpZXcKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiX2ZvcmNlUmVuZGVyaW5nIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfZm9yY2VSZW5kZXJpbmcoKSB7CiAgICAgIGlmICh0aGlzLm9uVG9nZ2xlZCkgewogICAgICAgIHRoaXMub25Ub2dnbGVkKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5wZGZWaWV3ZXIuZm9yY2VSZW5kZXJpbmcoKTsKICAgICAgICB0aGlzLnBkZlRodW1ibmFpbFZpZXdlci5mb3JjZVJlbmRlcmluZygpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAiX3VwZGF0ZVRodW1ibmFpbFZpZXdlciIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3VwZGF0ZVRodW1ibmFpbFZpZXdlcigpIHsKICAgICAgdmFyIHBkZlZpZXdlciA9IHRoaXMucGRmVmlld2VyLAogICAgICAgICAgcGRmVGh1bWJuYWlsVmlld2VyID0gdGhpcy5wZGZUaHVtYm5haWxWaWV3ZXI7CiAgICAgIHZhciBwYWdlc0NvdW50ID0gcGRmVmlld2VyLnBhZ2VzQ291bnQ7CgogICAgICBmb3IgKHZhciBwYWdlSW5kZXggPSAwOyBwYWdlSW5kZXggPCBwYWdlc0NvdW50OyBwYWdlSW5kZXgrKykgewogICAgICAgIHZhciBwYWdlVmlldyA9IHBkZlZpZXdlci5nZXRQYWdlVmlldyhwYWdlSW5kZXgpOwoKICAgICAgICBpZiAocGFnZVZpZXcgJiYgcGFnZVZpZXcucmVuZGVyaW5nU3RhdGUgPT09IF9wZGZfcmVuZGVyaW5nX3F1ZXVlLlJlbmRlcmluZ1N0YXRlcy5GSU5JU0hFRCkgewogICAgICAgICAgdmFyIHRodW1ibmFpbFZpZXcgPSBwZGZUaHVtYm5haWxWaWV3ZXIuZ2V0VGh1bWJuYWlsKHBhZ2VJbmRleCk7CiAgICAgICAgICB0aHVtYm5haWxWaWV3LnNldEltYWdlKHBhZ2VWaWV3KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHBkZlRodW1ibmFpbFZpZXdlci5zY3JvbGxUaHVtYm5haWxJbnRvVmlldyhwZGZWaWV3ZXIuY3VycmVudFBhZ2VOdW1iZXIpOwogICAgfQogIH0sIHsKICAgIGtleTogIl9zaG93VUlOb3RpZmljYXRpb24iLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9zaG93VUlOb3RpZmljYXRpb24odmlldykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgaWYgKHRoaXMuX2Rpc2FibGVOb3RpZmljYXRpb24pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMubDEwbi5nZXQoInRvZ2dsZV9zaWRlYmFyX25vdGlmaWNhdGlvbi50aXRsZSIsIG51bGwsICJUb2dnbGUgU2lkZWJhciAoZG9jdW1lbnQgY29udGFpbnMgb3V0bGluZS9hdHRhY2htZW50cykiKS50aGVuKGZ1bmN0aW9uIChtc2cpIHsKICAgICAgICBfdGhpcy50b2dnbGVCdXR0b24udGl0bGUgPSBtc2c7CiAgICAgIH0pOwoKICAgICAgaWYgKCF0aGlzLmlzT3BlbikgewogICAgICAgIHRoaXMudG9nZ2xlQnV0dG9uLmNsYXNzTGlzdC5hZGQoVUlfTk9USUZJQ0FUSU9OX0NMQVNTKTsKICAgICAgfSBlbHNlIGlmICh2aWV3ID09PSB0aGlzLmFjdGl2ZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgc3dpdGNoICh2aWV3KSB7CiAgICAgICAgY2FzZSBTaWRlYmFyVmlldy5PVVRMSU5FOgogICAgICAgICAgdGhpcy5vdXRsaW5lQnV0dG9uLmNsYXNzTGlzdC5hZGQoVUlfTk9USUZJQ0FUSU9OX0NMQVNTKTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlIFNpZGViYXJWaWV3LkFUVEFDSE1FTlRTOgogICAgICAgICAgdGhpcy5hdHRhY2htZW50c0J1dHRvbi5jbGFzc0xpc3QuYWRkKFVJX05PVElGSUNBVElPTl9DTEFTUyk7CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogIl9oaWRlVUlOb3RpZmljYXRpb24iLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9oaWRlVUlOb3RpZmljYXRpb24odmlldykgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIGlmICh0aGlzLl9kaXNhYmxlTm90aWZpY2F0aW9uKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgcmVtb3ZlTm90aWZpY2F0aW9uID0gZnVuY3Rpb24gcmVtb3ZlTm90aWZpY2F0aW9uKHNpZGViYXJWaWV3KSB7CiAgICAgICAgc3dpdGNoIChzaWRlYmFyVmlldykgewogICAgICAgICAgY2FzZSBTaWRlYmFyVmlldy5PVVRMSU5FOgogICAgICAgICAgICBfdGhpczIub3V0bGluZUJ1dHRvbi5jbGFzc0xpc3QucmVtb3ZlKFVJX05PVElGSUNBVElPTl9DTEFTUyk7CgogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIFNpZGViYXJWaWV3LkFUVEFDSE1FTlRTOgogICAgICAgICAgICBfdGhpczIuYXR0YWNobWVudHNCdXR0b24uY2xhc3NMaXN0LnJlbW92ZShVSV9OT1RJRklDQVRJT05fQ0xBU1MpOwoKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgaWYgKCF0aGlzLmlzT3BlbiAmJiB2aWV3ICE9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLnRvZ2dsZUJ1dHRvbi5jbGFzc0xpc3QucmVtb3ZlKFVJX05PVElGSUNBVElPTl9DTEFTUyk7CgogICAgICBpZiAodmlldyAhPT0gbnVsbCkgewogICAgICAgIHJlbW92ZU5vdGlmaWNhdGlvbih2aWV3KTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGZvciAodmlldyBpbiBTaWRlYmFyVmlldykgewogICAgICAgIHJlbW92ZU5vdGlmaWNhdGlvbihTaWRlYmFyVmlld1t2aWV3XSk7CiAgICAgIH0KCiAgICAgIHRoaXMubDEwbi5nZXQoInRvZ2dsZV9zaWRlYmFyLnRpdGxlIiwgbnVsbCwgIlRvZ2dsZSBTaWRlYmFyIikudGhlbihmdW5jdGlvbiAobXNnKSB7CiAgICAgICAgX3RoaXMyLnRvZ2dsZUJ1dHRvbi50aXRsZSA9IG1zZzsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiX2FkZEV2ZW50TGlzdGVuZXJzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfYWRkRXZlbnRMaXN0ZW5lcnMoKSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgdGhpcy52aWV3ZXJDb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcigidHJhbnNpdGlvbmVuZCIsIGZ1bmN0aW9uIChldnQpIHsKICAgICAgICBpZiAoZXZ0LnRhcmdldCA9PT0gX3RoaXMzLnZpZXdlckNvbnRhaW5lcikgewogICAgICAgICAgX3RoaXMzLm91dGVyQ29udGFpbmVyLmNsYXNzTGlzdC5yZW1vdmUoInNpZGViYXJNb3ZpbmciKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICB0aGlzLnRvZ2dsZUJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgICBfdGhpczMudG9nZ2xlKCk7CiAgICAgIH0pOwogICAgICB0aGlzLnRodW1ibmFpbEJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgICBfdGhpczMuc3dpdGNoVmlldyhTaWRlYmFyVmlldy5USFVNQlMpOwogICAgICB9KTsKICAgICAgdGhpcy5vdXRsaW5lQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzMy5zd2l0Y2hWaWV3KFNpZGViYXJWaWV3Lk9VVExJTkUpOwogICAgICB9KTsKICAgICAgdGhpcy5vdXRsaW5lQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoImRibGNsaWNrIiwgZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzMy5ldmVudEJ1cy5kaXNwYXRjaCgidG9nZ2xlb3V0bGluZXRyZWUiLCB7CiAgICAgICAgICBzb3VyY2U6IF90aGlzMwogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgdGhpcy5hdHRhY2htZW50c0J1dHRvbi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgICBfdGhpczMuc3dpdGNoVmlldyhTaWRlYmFyVmlldy5BVFRBQ0hNRU5UUyk7CiAgICAgIH0pOwoKICAgICAgdGhpcy5ldmVudEJ1cy5fb24oIm91dGxpbmVsb2FkZWQiLCBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgICAgdmFyIG91dGxpbmVDb3VudCA9IGV2dC5vdXRsaW5lQ291bnQ7CiAgICAgICAgX3RoaXMzLm91dGxpbmVCdXR0b24uZGlzYWJsZWQgPSAhb3V0bGluZUNvdW50OwoKICAgICAgICBpZiAob3V0bGluZUNvdW50KSB7CiAgICAgICAgICBfdGhpczMuX3Nob3dVSU5vdGlmaWNhdGlvbihTaWRlYmFyVmlldy5PVVRMSU5FKTsKICAgICAgICB9IGVsc2UgaWYgKF90aGlzMy5hY3RpdmUgPT09IFNpZGViYXJWaWV3Lk9VVExJTkUpIHsKICAgICAgICAgIF90aGlzMy5zd2l0Y2hWaWV3KFNpZGViYXJWaWV3LlRIVU1CUyk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHRoaXMuZXZlbnRCdXMuX29uKCJhdHRhY2htZW50c2xvYWRlZCIsIGZ1bmN0aW9uIChldnQpIHsKICAgICAgICBpZiAoZXZ0LmF0dGFjaG1lbnRzQ291bnQpIHsKICAgICAgICAgIF90aGlzMy5hdHRhY2htZW50c0J1dHRvbi5kaXNhYmxlZCA9IGZhbHNlOwoKICAgICAgICAgIF90aGlzMy5fc2hvd1VJTm90aWZpY2F0aW9uKFNpZGViYXJWaWV3LkFUVEFDSE1FTlRTKTsKCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChfdGhpczMuYXR0YWNobWVudHNWaWV3Lmhhc0NoaWxkTm9kZXMoKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgX3RoaXMzLmF0dGFjaG1lbnRzQnV0dG9uLmRpc2FibGVkID0gdHJ1ZTsKCiAgICAgICAgICBpZiAoX3RoaXMzLmFjdGl2ZSA9PT0gU2lkZWJhclZpZXcuQVRUQUNITUVOVFMpIHsKICAgICAgICAgICAgX3RoaXMzLnN3aXRjaFZpZXcoU2lkZWJhclZpZXcuVEhVTUJTKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CgogICAgICB0aGlzLmV2ZW50QnVzLl9vbigicHJlc2VudGF0aW9ubW9kZWNoYW5nZWQiLCBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgICAgaWYgKCFldnQuYWN0aXZlICYmICFldnQuc3dpdGNoSW5Qcm9ncmVzcyAmJiBfdGhpczMuaXNUaHVtYm5haWxWaWV3VmlzaWJsZSkgewogICAgICAgICAgX3RoaXMzLl91cGRhdGVUaHVtYm5haWxWaWV3ZXIoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogInZpc2libGVWaWV3IiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5pc09wZW4gPyB0aGlzLmFjdGl2ZSA6IFNpZGViYXJWaWV3Lk5PTkU7CiAgICB9CiAgfSwgewogICAga2V5OiAiaXNUaHVtYm5haWxWaWV3VmlzaWJsZSIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuaXNPcGVuICYmIHRoaXMuYWN0aXZlID09PSBTaWRlYmFyVmlldy5USFVNQlM7CiAgICB9CiAgfSwgewogICAga2V5OiAiaXNPdXRsaW5lVmlld1Zpc2libGUiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLmlzT3BlbiAmJiB0aGlzLmFjdGl2ZSA9PT0gU2lkZWJhclZpZXcuT1VUTElORTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJpc0F0dGFjaG1lbnRzVmlld1Zpc2libGUiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLmlzT3BlbiAmJiB0aGlzLmFjdGl2ZSA9PT0gU2lkZWJhclZpZXcuQVRUQUNITUVOVFM7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gUERGU2lkZWJhcjsKfSgpOwoKZXhwb3J0cy5QREZTaWRlYmFyID0gUERGU2lkZWJhcjsKCi8qKiovIH0pLAovKiAxMyAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoidXNlIHN0cmljdCI7CgoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLk92ZXJsYXlNYW5hZ2VyID0gdm9pZCAwOwoKdmFyIF9yZWdlbmVyYXRvciA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX193ZWJwYWNrX3JlcXVpcmVfXygyKSk7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAiZGVmYXVsdCI6IG9iaiB9OyB9CgpmdW5jdGlvbiBhc3luY0dlbmVyYXRvclN0ZXAoZ2VuLCByZXNvbHZlLCByZWplY3QsIF9uZXh0LCBfdGhyb3csIGtleSwgYXJnKSB7IHRyeSB7IHZhciBpbmZvID0gZ2VuW2tleV0oYXJnKTsgdmFyIHZhbHVlID0gaW5mby52YWx1ZTsgfSBjYXRjaCAoZXJyb3IpIHsgcmVqZWN0KGVycm9yKTsgcmV0dXJuOyB9IGlmIChpbmZvLmRvbmUpIHsgcmVzb2x2ZSh2YWx1ZSk7IH0gZWxzZSB7IFByb21pc2UucmVzb2x2ZSh2YWx1ZSkudGhlbihfbmV4dCwgX3Rocm93KTsgfSB9CgpmdW5jdGlvbiBfYXN5bmNUb0dlbmVyYXRvcihmbikgeyByZXR1cm4gZnVuY3Rpb24gKCkgeyB2YXIgc2VsZiA9IHRoaXMsIGFyZ3MgPSBhcmd1bWVudHM7IHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7IHZhciBnZW4gPSBmbi5hcHBseShzZWxmLCBhcmdzKTsgZnVuY3Rpb24gX25leHQodmFsdWUpIHsgYXN5bmNHZW5lcmF0b3JTdGVwKGdlbiwgcmVzb2x2ZSwgcmVqZWN0LCBfbmV4dCwgX3Rocm93LCAibmV4dCIsIHZhbHVlKTsgfSBmdW5jdGlvbiBfdGhyb3coZXJyKSB7IGFzeW5jR2VuZXJhdG9yU3RlcChnZW4sIHJlc29sdmUsIHJlamVjdCwgX25leHQsIF90aHJvdywgInRocm93IiwgZXJyKTsgfSBfbmV4dCh1bmRlZmluZWQpOyB9KTsgfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsgfSB9CgpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfQoKZnVuY3Rpb24gX2NyZWF0ZUNsYXNzKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH0KCnZhciBPdmVybGF5TWFuYWdlciA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gT3ZlcmxheU1hbmFnZXIoKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgT3ZlcmxheU1hbmFnZXIpOwoKICAgIHRoaXMuX292ZXJsYXlzID0ge307CiAgICB0aGlzLl9hY3RpdmUgPSBudWxsOwogICAgdGhpcy5fa2V5RG93bkJvdW5kID0gdGhpcy5fa2V5RG93bi5iaW5kKHRoaXMpOwogIH0KCiAgX2NyZWF0ZUNsYXNzKE92ZXJsYXlNYW5hZ2VyLCBbewogICAga2V5OiAicmVnaXN0ZXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9yZWdpc3RlciA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ubWFyayhmdW5jdGlvbiBfY2FsbGVlKG5hbWUsIGVsZW1lbnQpIHsKICAgICAgICB2YXIgY2FsbGVyQ2xvc2VNZXRob2QsCiAgICAgICAgICAgIGNhbkZvcmNlQ2xvc2UsCiAgICAgICAgICAgIGNvbnRhaW5lciwKICAgICAgICAgICAgX2FyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclsiZGVmYXVsdCJdLndyYXAoZnVuY3Rpb24gX2NhbGxlZSQoX2NvbnRleHQpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQucHJldiA9IF9jb250ZXh0Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBjYWxsZXJDbG9zZU1ldGhvZCA9IF9hcmdzLmxlbmd0aCA+IDIgJiYgX2FyZ3NbMl0gIT09IHVuZGVmaW5lZCA/IF9hcmdzWzJdIDogbnVsbDsKICAgICAgICAgICAgICAgIGNhbkZvcmNlQ2xvc2UgPSBfYXJncy5sZW5ndGggPiAzICYmIF9hcmdzWzNdICE9PSB1bmRlZmluZWQgPyBfYXJnc1szXSA6IGZhbHNlOwoKICAgICAgICAgICAgICAgIGlmICghKCFuYW1lIHx8ICFlbGVtZW50IHx8ICEoY29udGFpbmVyID0gZWxlbWVudC5wYXJlbnROb2RlKSkpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDY7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTm90IGVub3VnaCBwYXJhbWV0ZXJzLiIpOwoKICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX292ZXJsYXlzW25hbWVdKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0Lm5leHQgPSA4OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBvdmVybGF5IGlzIGFscmVhZHkgcmVnaXN0ZXJlZC4iKTsKCiAgICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgICAgdGhpcy5fb3ZlcmxheXNbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IGVsZW1lbnQsCiAgICAgICAgICAgICAgICAgIGNvbnRhaW5lcjogY29udGFpbmVyLAogICAgICAgICAgICAgICAgICBjYWxsZXJDbG9zZU1ldGhvZDogY2FsbGVyQ2xvc2VNZXRob2QsCiAgICAgICAgICAgICAgICAgIGNhbkZvcmNlQ2xvc2U6IGNhbkZvcmNlQ2xvc2UKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgIGNhc2UgOToKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWUsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiByZWdpc3RlcihfeCwgX3gyKSB7CiAgICAgICAgcmV0dXJuIF9yZWdpc3Rlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gcmVnaXN0ZXI7CiAgICB9KCkKICB9LCB7CiAgICBrZXk6ICJ1bnJlZ2lzdGVyIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfdW5yZWdpc3RlciA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ubWFyayhmdW5jdGlvbiBfY2FsbGVlMihuYW1lKSB7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclsiZGVmYXVsdCJdLndyYXAoZnVuY3Rpb24gX2NhbGxlZTIkKF9jb250ZXh0MikgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDIucHJldiA9IF9jb250ZXh0Mi5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgaWYgKHRoaXMuX292ZXJsYXlzW25hbWVdKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0Mi5uZXh0ID0gNDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgb3ZlcmxheSBkb2VzIG5vdCBleGlzdC4iKTsKCiAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgaWYgKCEodGhpcy5fYWN0aXZlID09PSBuYW1lKSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDIubmV4dCA9IDY7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIG92ZXJsYXkgY2Fubm90IGJlIHJlbW92ZWQgd2hpbGUgaXQgaXMgYWN0aXZlLiIpOwoKICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5fb3ZlcmxheXNbbmFtZV07CgogICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Mi5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMiwgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIHVucmVnaXN0ZXIoX3gzKSB7CiAgICAgICAgcmV0dXJuIF91bnJlZ2lzdGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB1bnJlZ2lzdGVyOwogICAgfSgpCiAgfSwgewogICAga2V5OiAib3BlbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX29wZW4gPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclsiZGVmYXVsdCJdLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTMobmFtZSkgewogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JbImRlZmF1bHQiXS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUzJChfY29udGV4dDMpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQzLnByZXYgPSBfY29udGV4dDMubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9vdmVybGF5c1tuYW1lXSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIG92ZXJsYXkgZG9lcyBub3QgZXhpc3QuIik7CgogICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgIGlmICghdGhpcy5fYWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0My5uZXh0ID0gMTQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghdGhpcy5fb3ZlcmxheXNbbmFtZV0uY2FuRm9yY2VDbG9zZSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuX2Nsb3NlVGhyb3VnaENhbGxlcigpOwoKICAgICAgICAgICAgICAgIF9jb250ZXh0My5uZXh0ID0gMTQ7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgY2FzZSA5OgogICAgICAgICAgICAgICAgaWYgKCEodGhpcy5fYWN0aXZlID09PSBuYW1lKSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDEzOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBvdmVybGF5IGlzIGFscmVhZHkgYWN0aXZlLiIpOwoKICAgICAgICAgICAgICBjYXNlIDEzOgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbm90aGVyIG92ZXJsYXkgaXMgY3VycmVudGx5IGFjdGl2ZS4iKTsKCiAgICAgICAgICAgICAgY2FzZSAxNDoKICAgICAgICAgICAgICAgIHRoaXMuX2FjdGl2ZSA9IG5hbWU7CgogICAgICAgICAgICAgICAgdGhpcy5fb3ZlcmxheXNbdGhpcy5fYWN0aXZlXS5lbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoImhpZGRlbiIpOwoKICAgICAgICAgICAgICAgIHRoaXMuX292ZXJsYXlzW3RoaXMuX2FjdGl2ZV0uY29udGFpbmVyLmNsYXNzTGlzdC5yZW1vdmUoImhpZGRlbiIpOwoKICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgdGhpcy5fa2V5RG93bkJvdW5kKTsKCiAgICAgICAgICAgICAgY2FzZSAxODoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0My5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMywgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIG9wZW4oX3g0KSB7CiAgICAgICAgcmV0dXJuIF9vcGVuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBvcGVuOwogICAgfSgpCiAgfSwgewogICAga2V5OiAiY2xvc2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9jbG9zZSA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ubWFyayhmdW5jdGlvbiBfY2FsbGVlNChuYW1lKSB7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclsiZGVmYXVsdCJdLndyYXAoZnVuY3Rpb24gX2NhbGxlZTQkKF9jb250ZXh0NCkgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDQucHJldiA9IF9jb250ZXh0NC5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgaWYgKHRoaXMuX292ZXJsYXlzW25hbWVdKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0NC5uZXh0ID0gNDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgb3ZlcmxheSBkb2VzIG5vdCBleGlzdC4iKTsKCiAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2FjdGl2ZSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDQubmV4dCA9IDg7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIG92ZXJsYXkgaXMgY3VycmVudGx5IG5vdCBhY3RpdmUuIik7CgogICAgICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgICAgIGlmICghKHRoaXMuX2FjdGl2ZSAhPT0gbmFtZSkpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ0Lm5leHQgPSAxMDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbm90aGVyIG92ZXJsYXkgaXMgY3VycmVudGx5IGFjdGl2ZS4iKTsKCiAgICAgICAgICAgICAgY2FzZSAxMDoKICAgICAgICAgICAgICAgIHRoaXMuX292ZXJsYXlzW3RoaXMuX2FjdGl2ZV0uY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOwoKICAgICAgICAgICAgICAgIHRoaXMuX292ZXJsYXlzW3RoaXMuX2FjdGl2ZV0uZWxlbWVudC5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsKCiAgICAgICAgICAgICAgICB0aGlzLl9hY3RpdmUgPSBudWxsOwogICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoImtleWRvd24iLCB0aGlzLl9rZXlEb3duQm91bmQpOwoKICAgICAgICAgICAgICBjYXNlIDE0OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ0LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWU0LCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gY2xvc2UoX3g1KSB7CiAgICAgICAgcmV0dXJuIF9jbG9zZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gY2xvc2U7CiAgICB9KCkKICB9LCB7CiAgICBrZXk6ICJfa2V5RG93biIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2tleURvd24oZXZ0KSB7CiAgICAgIGlmICh0aGlzLl9hY3RpdmUgJiYgZXZ0LmtleUNvZGUgPT09IDI3KSB7CiAgICAgICAgdGhpcy5fY2xvc2VUaHJvdWdoQ2FsbGVyKCk7CgogICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAiX2Nsb3NlVGhyb3VnaENhbGxlciIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2Nsb3NlVGhyb3VnaENhbGxlcigpIHsKICAgICAgaWYgKHRoaXMuX292ZXJsYXlzW3RoaXMuX2FjdGl2ZV0uY2FsbGVyQ2xvc2VNZXRob2QpIHsKICAgICAgICB0aGlzLl9vdmVybGF5c1t0aGlzLl9hY3RpdmVdLmNhbGxlckNsb3NlTWV0aG9kKCk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9hY3RpdmUpIHsKICAgICAgICB0aGlzLmNsb3NlKHRoaXMuX2FjdGl2ZSk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJhY3RpdmUiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9hY3RpdmU7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gT3ZlcmxheU1hbmFnZXI7Cn0oKTsKCmV4cG9ydHMuT3ZlcmxheU1hbmFnZXIgPSBPdmVybGF5TWFuYWdlcjsKCi8qKiovIH0pLAovKiAxNCAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoidXNlIHN0cmljdCI7CgoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLlBhc3N3b3JkUHJvbXB0ID0gdm9pZCAwOwoKdmFyIF91aV91dGlscyA9IF9fd2VicGFja19yZXF1aXJlX18oNSk7Cgp2YXIgX3BkZmpzTGliID0gX193ZWJwYWNrX3JlcXVpcmVfXyg4KTsKCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7IH0gfQoKZnVuY3Rpb24gX2RlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoInZhbHVlIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0KCmZ1bmN0aW9uIF9jcmVhdGVDbGFzcyhDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9Cgp2YXIgUGFzc3dvcmRQcm9tcHQgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIFBhc3N3b3JkUHJvbXB0KG9wdGlvbnMsIG92ZXJsYXlNYW5hZ2VyKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIHZhciBsMTBuID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMl0gOiBfdWlfdXRpbHMuTnVsbEwxMG47CgogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFBhc3N3b3JkUHJvbXB0KTsKCiAgICB0aGlzLm92ZXJsYXlOYW1lID0gb3B0aW9ucy5vdmVybGF5TmFtZTsKICAgIHRoaXMuY29udGFpbmVyID0gb3B0aW9ucy5jb250YWluZXI7CiAgICB0aGlzLmxhYmVsID0gb3B0aW9ucy5sYWJlbDsKICAgIHRoaXMuaW5wdXQgPSBvcHRpb25zLmlucHV0OwogICAgdGhpcy5zdWJtaXRCdXR0b24gPSBvcHRpb25zLnN1Ym1pdEJ1dHRvbjsKICAgIHRoaXMuY2FuY2VsQnV0dG9uID0gb3B0aW9ucy5jYW5jZWxCdXR0b247CiAgICB0aGlzLm92ZXJsYXlNYW5hZ2VyID0gb3ZlcmxheU1hbmFnZXI7CiAgICB0aGlzLmwxMG4gPSBsMTBuOwogICAgdGhpcy51cGRhdGVDYWxsYmFjayA9IG51bGw7CiAgICB0aGlzLnJlYXNvbiA9IG51bGw7CiAgICB0aGlzLnN1Ym1pdEJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIHRoaXMudmVyaWZ5LmJpbmQodGhpcykpOwogICAgdGhpcy5jYW5jZWxCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCB0aGlzLmNsb3NlLmJpbmQodGhpcykpOwogICAgdGhpcy5pbnB1dC5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgaWYgKGUua2V5Q29kZSA9PT0gMTMpIHsKICAgICAgICBfdGhpcy52ZXJpZnkoKTsKICAgICAgfQogICAgfSk7CiAgICB0aGlzLm92ZXJsYXlNYW5hZ2VyLnJlZ2lzdGVyKHRoaXMub3ZlcmxheU5hbWUsIHRoaXMuY29udGFpbmVyLCB0aGlzLmNsb3NlLmJpbmQodGhpcyksIHRydWUpOwogIH0KCiAgX2NyZWF0ZUNsYXNzKFBhc3N3b3JkUHJvbXB0LCBbewogICAga2V5OiAib3BlbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gb3BlbigpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICB0aGlzLm92ZXJsYXlNYW5hZ2VyLm9wZW4odGhpcy5vdmVybGF5TmFtZSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgX3RoaXMyLmlucHV0LmZvY3VzKCk7CgogICAgICAgIHZhciBwcm9tcHRTdHJpbmc7CgogICAgICAgIGlmIChfdGhpczIucmVhc29uID09PSBfcGRmanNMaWIuUGFzc3dvcmRSZXNwb25zZXMuSU5DT1JSRUNUX1BBU1NXT1JEKSB7CiAgICAgICAgICBwcm9tcHRTdHJpbmcgPSBfdGhpczIubDEwbi5nZXQoInBhc3N3b3JkX2ludmFsaWQiLCBudWxsLCAiSW52YWxpZCBwYXNzd29yZC4gUGxlYXNlIHRyeSBhZ2Fpbi4iKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcHJvbXB0U3RyaW5nID0gX3RoaXMyLmwxMG4uZ2V0KCJwYXNzd29yZF9sYWJlbCIsIG51bGwsICJFbnRlciB0aGUgcGFzc3dvcmQgdG8gb3BlbiB0aGlzIFBERiBmaWxlLiIpOwogICAgICAgIH0KCiAgICAgICAgcHJvbXB0U3RyaW5nLnRoZW4oZnVuY3Rpb24gKG1zZykgewogICAgICAgICAgX3RoaXMyLmxhYmVsLnRleHRDb250ZW50ID0gbXNnOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJjbG9zZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY2xvc2UoKSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgdGhpcy5vdmVybGF5TWFuYWdlci5jbG9zZSh0aGlzLm92ZXJsYXlOYW1lKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICBfdGhpczMuaW5wdXQudmFsdWUgPSAiIjsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAidmVyaWZ5IiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2ZXJpZnkoKSB7CiAgICAgIHZhciBwYXNzd29yZCA9IHRoaXMuaW5wdXQudmFsdWU7CgogICAgICBpZiAocGFzc3dvcmQgJiYgcGFzc3dvcmQubGVuZ3RoID4gMCkgewogICAgICAgIHRoaXMuY2xvc2UoKTsKICAgICAgICB0aGlzLnVwZGF0ZUNhbGxiYWNrKHBhc3N3b3JkKTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogInNldFVwZGF0ZUNhbGxiYWNrIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRVcGRhdGVDYWxsYmFjayh1cGRhdGVDYWxsYmFjaywgcmVhc29uKSB7CiAgICAgIHRoaXMudXBkYXRlQ2FsbGJhY2sgPSB1cGRhdGVDYWxsYmFjazsKICAgICAgdGhpcy5yZWFzb24gPSByZWFzb247CiAgICB9CiAgfV0pOwoKICByZXR1cm4gUGFzc3dvcmRQcm9tcHQ7Cn0oKTsKCmV4cG9ydHMuUGFzc3dvcmRQcm9tcHQgPSBQYXNzd29yZFByb21wdDsKCi8qKiovIH0pLAovKiAxNSAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoidXNlIHN0cmljdCI7CgoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLlBERkF0dGFjaG1lbnRWaWV3ZXIgPSB2b2lkIDA7Cgp2YXIgX3BkZmpzTGliID0gX193ZWJwYWNrX3JlcXVpcmVfXyg4KTsKCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7IH0gfQoKZnVuY3Rpb24gX2RlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoInZhbHVlIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0KCmZ1bmN0aW9uIF9jcmVhdGVDbGFzcyhDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9Cgp2YXIgUERGQXR0YWNobWVudFZpZXdlciA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gUERGQXR0YWNobWVudFZpZXdlcihfcmVmKSB7CiAgICB2YXIgY29udGFpbmVyID0gX3JlZi5jb250YWluZXIsCiAgICAgICAgZXZlbnRCdXMgPSBfcmVmLmV2ZW50QnVzLAogICAgICAgIGRvd25sb2FkTWFuYWdlciA9IF9yZWYuZG93bmxvYWRNYW5hZ2VyOwoKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBQREZBdHRhY2htZW50Vmlld2VyKTsKCiAgICB0aGlzLmNvbnRhaW5lciA9IGNvbnRhaW5lcjsKICAgIHRoaXMuZXZlbnRCdXMgPSBldmVudEJ1czsKICAgIHRoaXMuZG93bmxvYWRNYW5hZ2VyID0gZG93bmxvYWRNYW5hZ2VyOwogICAgdGhpcy5yZXNldCgpOwoKICAgIHRoaXMuZXZlbnRCdXMuX29uKCJmaWxlYXR0YWNobWVudGFubm90YXRpb24iLCB0aGlzLl9hcHBlbmRBdHRhY2htZW50LmJpbmQodGhpcykpOwogIH0KCiAgX2NyZWF0ZUNsYXNzKFBERkF0dGFjaG1lbnRWaWV3ZXIsIFt7CiAgICBrZXk6ICJyZXNldCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVzZXQoKSB7CiAgICAgIHZhciBrZWVwUmVuZGVyZWRDYXBhYmlsaXR5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiBmYWxzZTsKICAgICAgdGhpcy5hdHRhY2htZW50cyA9IG51bGw7CiAgICAgIHRoaXMuY29udGFpbmVyLnRleHRDb250ZW50ID0gIiI7CgogICAgICBpZiAoIWtlZXBSZW5kZXJlZENhcGFiaWxpdHkpIHsKICAgICAgICB0aGlzLl9yZW5kZXJlZENhcGFiaWxpdHkgPSAoMCwgX3BkZmpzTGliLmNyZWF0ZVByb21pc2VDYXBhYmlsaXR5KSgpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAiX2Rpc3BhdGNoRXZlbnQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9kaXNwYXRjaEV2ZW50KGF0dGFjaG1lbnRzQ291bnQpIHsKICAgICAgdGhpcy5fcmVuZGVyZWRDYXBhYmlsaXR5LnJlc29sdmUoKTsKCiAgICAgIHRoaXMuZXZlbnRCdXMuZGlzcGF0Y2goImF0dGFjaG1lbnRzbG9hZGVkIiwgewogICAgICAgIHNvdXJjZTogdGhpcywKICAgICAgICBhdHRhY2htZW50c0NvdW50OiBhdHRhY2htZW50c0NvdW50CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogIl9iaW5kUGRmTGluayIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2JpbmRQZGZMaW5rKGJ1dHRvbiwgY29udGVudCwgZmlsZW5hbWUpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHZhciBibG9iVXJsOwoKICAgICAgYnV0dG9uLm9uY2xpY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKCFibG9iVXJsKSB7CiAgICAgICAgICBibG9iVXJsID0gVVJMLmNyZWF0ZU9iamVjdFVSTChuZXcgQmxvYihbY29udGVudF0sIHsKICAgICAgICAgICAgdHlwZTogImFwcGxpY2F0aW9uL3BkZiIKICAgICAgICAgIH0pKTsKICAgICAgICB9CgogICAgICAgIHZhciB2aWV3ZXJVcmw7CiAgICAgICAgdmlld2VyVXJsID0gIj9maWxlPSIgKyBlbmNvZGVVUklDb21wb25lbnQoYmxvYlVybCArICIjIiArIGZpbGVuYW1lKTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIHdpbmRvdy5vcGVuKHZpZXdlclVybCk7CiAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIl9iaW5kUGRmTGluazogIi5jb25jYXQoZXgpKTsKICAgICAgICAgIFVSTC5yZXZva2VPYmplY3RVUkwoYmxvYlVybCk7CiAgICAgICAgICBibG9iVXJsID0gbnVsbDsKCiAgICAgICAgICBfdGhpcy5kb3dubG9hZE1hbmFnZXIuZG93bmxvYWREYXRhKGNvbnRlbnQsIGZpbGVuYW1lLCAiYXBwbGljYXRpb24vcGRmIik7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH07CiAgICB9CiAgfSwgewogICAga2V5OiAiX2JpbmRMaW5rIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfYmluZExpbmsoYnV0dG9uLCBjb250ZW50LCBmaWxlbmFtZSkgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIGJ1dHRvbi5vbmNsaWNrID0gZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzMi5kb3dubG9hZE1hbmFnZXIuZG93bmxvYWREYXRhKGNvbnRlbnQsIGZpbGVuYW1lLCAiIik7CgogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJyZW5kZXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlbmRlcihfcmVmMikgewogICAgICB2YXIgYXR0YWNobWVudHMgPSBfcmVmMi5hdHRhY2htZW50cywKICAgICAgICAgIF9yZWYyJGtlZXBSZW5kZXJlZENhcCA9IF9yZWYyLmtlZXBSZW5kZXJlZENhcGFiaWxpdHksCiAgICAgICAgICBrZWVwUmVuZGVyZWRDYXBhYmlsaXR5ID0gX3JlZjIka2VlcFJlbmRlcmVkQ2FwID09PSB2b2lkIDAgPyBmYWxzZSA6IF9yZWYyJGtlZXBSZW5kZXJlZENhcDsKICAgICAgdmFyIGF0dGFjaG1lbnRzQ291bnQgPSAwOwoKICAgICAgaWYgKHRoaXMuYXR0YWNobWVudHMpIHsKICAgICAgICB0aGlzLnJlc2V0KGtlZXBSZW5kZXJlZENhcGFiaWxpdHkgPT09IHRydWUpOwogICAgICB9CgogICAgICB0aGlzLmF0dGFjaG1lbnRzID0gYXR0YWNobWVudHMgfHwgbnVsbDsKCiAgICAgIGlmICghYXR0YWNobWVudHMpIHsKICAgICAgICB0aGlzLl9kaXNwYXRjaEV2ZW50KGF0dGFjaG1lbnRzQ291bnQpOwoKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBuYW1lcyA9IE9iamVjdC5rZXlzKGF0dGFjaG1lbnRzKS5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgcmV0dXJuIGEudG9Mb3dlckNhc2UoKS5sb2NhbGVDb21wYXJlKGIudG9Mb3dlckNhc2UoKSk7CiAgICAgIH0pOwogICAgICBhdHRhY2htZW50c0NvdW50ID0gbmFtZXMubGVuZ3RoOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhdHRhY2htZW50c0NvdW50OyBpKyspIHsKICAgICAgICB2YXIgaXRlbSA9IGF0dGFjaG1lbnRzW25hbWVzW2ldXTsKICAgICAgICB2YXIgZmlsZW5hbWUgPSAoMCwgX3BkZmpzTGliLnJlbW92ZU51bGxDaGFyYWN0ZXJzKSgoMCwgX3BkZmpzTGliLmdldEZpbGVuYW1lRnJvbVVybCkoaXRlbS5maWxlbmFtZSkpOwogICAgICAgIHZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICBkaXYuY2xhc3NOYW1lID0gImF0dGFjaG1lbnRzSXRlbSI7CiAgICAgICAgdmFyIGJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJ1dHRvbiIpOwogICAgICAgIGJ1dHRvbi50ZXh0Q29udGVudCA9IGZpbGVuYW1lOwoKICAgICAgICBpZiAoL1wucGRmJC9pLnRlc3QoZmlsZW5hbWUpICYmICF0aGlzLmRvd25sb2FkTWFuYWdlci5kaXNhYmxlQ3JlYXRlT2JqZWN0VVJMKSB7CiAgICAgICAgICB0aGlzLl9iaW5kUGRmTGluayhidXR0b24sIGl0ZW0uY29udGVudCwgZmlsZW5hbWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLl9iaW5kTGluayhidXR0b24sIGl0ZW0uY29udGVudCwgZmlsZW5hbWUpOwogICAgICAgIH0KCiAgICAgICAgZGl2LmFwcGVuZENoaWxkKGJ1dHRvbik7CiAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQoZGl2KTsKICAgICAgfQoKICAgICAgdGhpcy5fZGlzcGF0Y2hFdmVudChhdHRhY2htZW50c0NvdW50KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfYXBwZW5kQXR0YWNobWVudCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2FwcGVuZEF0dGFjaG1lbnQoX3JlZjMpIHsKICAgICAgdmFyIF90aGlzMyA9IHRoaXM7CgogICAgICB2YXIgaWQgPSBfcmVmMy5pZCwKICAgICAgICAgIGZpbGVuYW1lID0gX3JlZjMuZmlsZW5hbWUsCiAgICAgICAgICBjb250ZW50ID0gX3JlZjMuY29udGVudDsKCiAgICAgIHRoaXMuX3JlbmRlcmVkQ2FwYWJpbGl0eS5wcm9taXNlLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBhdHRhY2htZW50cyA9IF90aGlzMy5hdHRhY2htZW50czsKCiAgICAgICAgaWYgKCFhdHRhY2htZW50cykgewogICAgICAgICAgYXR0YWNobWVudHMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmb3IgKHZhciBuYW1lIGluIGF0dGFjaG1lbnRzKSB7CiAgICAgICAgICAgIGlmIChpZCA9PT0gbmFtZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgYXR0YWNobWVudHNbaWRdID0gewogICAgICAgICAgZmlsZW5hbWU6IGZpbGVuYW1lLAogICAgICAgICAgY29udGVudDogY29udGVudAogICAgICAgIH07CgogICAgICAgIF90aGlzMy5yZW5kZXIoewogICAgICAgICAgYXR0YWNobWVudHM6IGF0dGFjaG1lbnRzLAogICAgICAgICAga2VlcFJlbmRlcmVkQ2FwYWJpbGl0eTogdHJ1ZQogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICB9XSk7CgogIHJldHVybiBQREZBdHRhY2htZW50Vmlld2VyOwp9KCk7CgpleHBvcnRzLlBERkF0dGFjaG1lbnRWaWV3ZXIgPSBQREZBdHRhY2htZW50Vmlld2VyOwoKLyoqKi8gfSksCi8qIDE2ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuUERGRG9jdW1lbnRQcm9wZXJ0aWVzID0gdm9pZCAwOwoKdmFyIF9yZWdlbmVyYXRvciA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX193ZWJwYWNrX3JlcXVpcmVfXygyKSk7Cgp2YXIgX3BkZmpzTGliID0gX193ZWJwYWNrX3JlcXVpcmVfXyg4KTsKCnZhciBfdWlfdXRpbHMgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgImRlZmF1bHQiOiBvYmogfTsgfQoKZnVuY3Rpb24gYXN5bmNHZW5lcmF0b3JTdGVwKGdlbiwgcmVzb2x2ZSwgcmVqZWN0LCBfbmV4dCwgX3Rocm93LCBrZXksIGFyZykgeyB0cnkgeyB2YXIgaW5mbyA9IGdlbltrZXldKGFyZyk7IHZhciB2YWx1ZSA9IGluZm8udmFsdWU7IH0gY2F0Y2ggKGVycm9yKSB7IHJlamVjdChlcnJvcik7IHJldHVybjsgfSBpZiAoaW5mby5kb25lKSB7IHJlc29sdmUodmFsdWUpOyB9IGVsc2UgeyBQcm9taXNlLnJlc29sdmUodmFsdWUpLnRoZW4oX25leHQsIF90aHJvdyk7IH0gfQoKZnVuY3Rpb24gX2FzeW5jVG9HZW5lcmF0b3IoZm4pIHsgcmV0dXJuIGZ1bmN0aW9uICgpIHsgdmFyIHNlbGYgPSB0aGlzLCBhcmdzID0gYXJndW1lbnRzOyByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgeyB2YXIgZ2VuID0gZm4uYXBwbHkoc2VsZiwgYXJncyk7IGZ1bmN0aW9uIF9uZXh0KHZhbHVlKSB7IGFzeW5jR2VuZXJhdG9yU3RlcChnZW4sIHJlc29sdmUsIHJlamVjdCwgX25leHQsIF90aHJvdywgIm5leHQiLCB2YWx1ZSk7IH0gZnVuY3Rpb24gX3Rocm93KGVycikgeyBhc3luY0dlbmVyYXRvclN0ZXAoZ2VuLCByZXNvbHZlLCByZWplY3QsIF9uZXh0LCBfdGhyb3csICJ0aHJvdyIsIGVycik7IH0gX25leHQodW5kZWZpbmVkKTsgfSk7IH07IH0KCmZ1bmN0aW9uIF9zbGljZWRUb0FycmF5KGFyciwgaSkgeyByZXR1cm4gX2FycmF5V2l0aEhvbGVzKGFycikgfHwgX2l0ZXJhYmxlVG9BcnJheUxpbWl0KGFyciwgaSkgfHwgX3Vuc3VwcG9ydGVkSXRlcmFibGVUb0FycmF5KGFyciwgaSkgfHwgX25vbkl0ZXJhYmxlUmVzdCgpOyB9CgpmdW5jdGlvbiBfbm9uSXRlcmFibGVSZXN0KCkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJJbnZhbGlkIGF0dGVtcHQgdG8gZGVzdHJ1Y3R1cmUgbm9uLWl0ZXJhYmxlIGluc3RhbmNlLlxuSW4gb3JkZXIgdG8gYmUgaXRlcmFibGUsIG5vbi1hcnJheSBvYmplY3RzIG11c3QgaGF2ZSBhIFtTeW1ib2wuaXRlcmF0b3JdKCkgbWV0aG9kLiIpOyB9CgpmdW5jdGlvbiBfdW5zdXBwb3J0ZWRJdGVyYWJsZVRvQXJyYXkobywgbWluTGVuKSB7IGlmICghbykgcmV0dXJuOyBpZiAodHlwZW9mIG8gPT09ICJzdHJpbmciKSByZXR1cm4gX2FycmF5TGlrZVRvQXJyYXkobywgbWluTGVuKTsgdmFyIG4gPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwobykuc2xpY2UoOCwgLTEpOyBpZiAobiA9PT0gIk9iamVjdCIgJiYgby5jb25zdHJ1Y3RvcikgbiA9IG8uY29uc3RydWN0b3IubmFtZTsgaWYgKG4gPT09ICJNYXAiIHx8IG4gPT09ICJTZXQiKSByZXR1cm4gQXJyYXkuZnJvbShvKTsgaWYgKG4gPT09ICJBcmd1bWVudHMiIHx8IC9eKD86VWl8SSludCg/Ojh8MTZ8MzIpKD86Q2xhbXBlZCk/QXJyYXkkLy50ZXN0KG4pKSByZXR1cm4gX2FycmF5TGlrZVRvQXJyYXkobywgbWluTGVuKTsgfQoKZnVuY3Rpb24gX2FycmF5TGlrZVRvQXJyYXkoYXJyLCBsZW4pIHsgaWYgKGxlbiA9PSBudWxsIHx8IGxlbiA+IGFyci5sZW5ndGgpIGxlbiA9IGFyci5sZW5ndGg7IGZvciAodmFyIGkgPSAwLCBhcnIyID0gbmV3IEFycmF5KGxlbik7IGkgPCBsZW47IGkrKykgeyBhcnIyW2ldID0gYXJyW2ldOyB9IHJldHVybiBhcnIyOyB9CgpmdW5jdGlvbiBfaXRlcmFibGVUb0FycmF5TGltaXQoYXJyLCBpKSB7IGlmICh0eXBlb2YgU3ltYm9sID09PSAidW5kZWZpbmVkIiB8fCAhKFN5bWJvbC5pdGVyYXRvciBpbiBPYmplY3QoYXJyKSkpIHJldHVybjsgdmFyIF9hcnIgPSBbXTsgdmFyIF9uID0gdHJ1ZTsgdmFyIF9kID0gZmFsc2U7IHZhciBfZSA9IHVuZGVmaW5lZDsgdHJ5IHsgZm9yICh2YXIgX2kgPSBhcnJbU3ltYm9sLml0ZXJhdG9yXSgpLCBfczsgIShfbiA9IChfcyA9IF9pLm5leHQoKSkuZG9uZSk7IF9uID0gdHJ1ZSkgeyBfYXJyLnB1c2goX3MudmFsdWUpOyBpZiAoaSAmJiBfYXJyLmxlbmd0aCA9PT0gaSkgYnJlYWs7IH0gfSBjYXRjaCAoZXJyKSB7IF9kID0gdHJ1ZTsgX2UgPSBlcnI7IH0gZmluYWxseSB7IHRyeSB7IGlmICghX24gJiYgX2lbInJldHVybiJdICE9IG51bGwpIF9pWyJyZXR1cm4iXSgpOyB9IGZpbmFsbHkgeyBpZiAoX2QpIHRocm93IF9lOyB9IH0gcmV0dXJuIF9hcnI7IH0KCmZ1bmN0aW9uIF9hcnJheVdpdGhIb2xlcyhhcnIpIHsgaWYgKEFycmF5LmlzQXJyYXkoYXJyKSkgcmV0dXJuIGFycjsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsgfSB9CgpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfQoKZnVuY3Rpb24gX2NyZWF0ZUNsYXNzKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH0KCnZhciBERUZBVUxUX0ZJRUxEX0NPTlRFTlQgPSAiLSI7CnZhciBOT05fTUVUUklDX0xPQ0FMRVMgPSBbImVuLXVzIiwgImVuLWxyIiwgIm15Il07CnZhciBVU19QQUdFX05BTUVTID0gewogICI4LjV4MTEiOiAiTGV0dGVyIiwKICAiOC41eDE0IjogIkxlZ2FsIgp9Owp2YXIgTUVUUklDX1BBR0VfTkFNRVMgPSB7CiAgIjI5N3g0MjAiOiAiQTMiLAogICIyMTB4Mjk3IjogIkE0Igp9OwoKZnVuY3Rpb24gZ2V0UGFnZU5hbWUoc2l6ZSwgaXNQb3J0cmFpdCwgcGFnZU5hbWVzKSB7CiAgdmFyIHdpZHRoID0gaXNQb3J0cmFpdCA/IHNpemUud2lkdGggOiBzaXplLmhlaWdodDsKICB2YXIgaGVpZ2h0ID0gaXNQb3J0cmFpdCA/IHNpemUuaGVpZ2h0IDogc2l6ZS53aWR0aDsKICByZXR1cm4gcGFnZU5hbWVzWyIiLmNvbmNhdCh3aWR0aCwgIngiKS5jb25jYXQoaGVpZ2h0KV07Cn0KCnZhciBQREZEb2N1bWVudFByb3BlcnRpZXMgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIFBERkRvY3VtZW50UHJvcGVydGllcyhfcmVmLCBvdmVybGF5TWFuYWdlciwgZXZlbnRCdXMpIHsKICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgdmFyIG92ZXJsYXlOYW1lID0gX3JlZi5vdmVybGF5TmFtZSwKICAgICAgICBmaWVsZHMgPSBfcmVmLmZpZWxkcywKICAgICAgICBjb250YWluZXIgPSBfcmVmLmNvbnRhaW5lciwKICAgICAgICBjbG9zZUJ1dHRvbiA9IF9yZWYuY2xvc2VCdXR0b247CiAgICB2YXIgbDEwbiA9IGFyZ3VtZW50cy5sZW5ndGggPiAzICYmIGFyZ3VtZW50c1szXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzNdIDogX3VpX3V0aWxzLk51bGxMMTBuOwoKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBQREZEb2N1bWVudFByb3BlcnRpZXMpOwoKICAgIHRoaXMub3ZlcmxheU5hbWUgPSBvdmVybGF5TmFtZTsKICAgIHRoaXMuZmllbGRzID0gZmllbGRzOwogICAgdGhpcy5jb250YWluZXIgPSBjb250YWluZXI7CiAgICB0aGlzLm92ZXJsYXlNYW5hZ2VyID0gb3ZlcmxheU1hbmFnZXI7CiAgICB0aGlzLmwxMG4gPSBsMTBuOwoKICAgIHRoaXMuX3Jlc2V0KCk7CgogICAgY2xvc2VCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCB0aGlzLmNsb3NlLmJpbmQodGhpcykpOwogICAgdGhpcy5vdmVybGF5TWFuYWdlci5yZWdpc3Rlcih0aGlzLm92ZXJsYXlOYW1lLCB0aGlzLmNvbnRhaW5lciwgdGhpcy5jbG9zZS5iaW5kKHRoaXMpKTsKCiAgICBldmVudEJ1cy5fb24oInBhZ2VjaGFuZ2luZyIsIGZ1bmN0aW9uIChldnQpIHsKICAgICAgX3RoaXMuX2N1cnJlbnRQYWdlTnVtYmVyID0gZXZ0LnBhZ2VOdW1iZXI7CiAgICB9KTsKCiAgICBldmVudEJ1cy5fb24oInJvdGF0aW9uY2hhbmdpbmciLCBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgIF90aGlzLl9wYWdlc1JvdGF0aW9uID0gZXZ0LnBhZ2VzUm90YXRpb247CiAgICB9KTsKCiAgICB0aGlzLl9pc05vbk1ldHJpY0xvY2FsZSA9IHRydWU7CiAgICBsMTBuLmdldExhbmd1YWdlKCkudGhlbihmdW5jdGlvbiAobG9jYWxlKSB7CiAgICAgIF90aGlzLl9pc05vbk1ldHJpY0xvY2FsZSA9IE5PTl9NRVRSSUNfTE9DQUxFUy5pbmNsdWRlcyhsb2NhbGUpOwogICAgfSk7CiAgfQoKICBfY3JlYXRlQ2xhc3MoUERGRG9jdW1lbnRQcm9wZXJ0aWVzLCBbewogICAga2V5OiAib3BlbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gb3BlbigpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICB2YXIgZnJlZXplRmllbGREYXRhID0gZnVuY3Rpb24gZnJlZXplRmllbGREYXRhKGRhdGEpIHsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX3RoaXMyLCAiZmllbGREYXRhIiwgewogICAgICAgICAgdmFsdWU6IE9iamVjdC5mcmVlemUoZGF0YSksCiAgICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgfSk7CiAgICAgIH07CgogICAgICBQcm9taXNlLmFsbChbdGhpcy5vdmVybGF5TWFuYWdlci5vcGVuKHRoaXMub3ZlcmxheU5hbWUpLCB0aGlzLl9kYXRhQXZhaWxhYmxlQ2FwYWJpbGl0eS5wcm9taXNlXSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGN1cnJlbnRQYWdlTnVtYmVyID0gX3RoaXMyLl9jdXJyZW50UGFnZU51bWJlcjsKICAgICAgICB2YXIgcGFnZXNSb3RhdGlvbiA9IF90aGlzMi5fcGFnZXNSb3RhdGlvbjsKCiAgICAgICAgaWYgKF90aGlzMi5maWVsZERhdGEgJiYgY3VycmVudFBhZ2VOdW1iZXIgPT09IF90aGlzMi5maWVsZERhdGEuX2N1cnJlbnRQYWdlTnVtYmVyICYmIHBhZ2VzUm90YXRpb24gPT09IF90aGlzMi5maWVsZERhdGEuX3BhZ2VzUm90YXRpb24pIHsKICAgICAgICAgIF90aGlzMi5fdXBkYXRlVUkoKTsKCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBfdGhpczIucGRmRG9jdW1lbnQuZ2V0TWV0YWRhdGEoKS50aGVuKGZ1bmN0aW9uIChfcmVmMikgewogICAgICAgICAgdmFyIGluZm8gPSBfcmVmMi5pbmZvLAogICAgICAgICAgICAgIG1ldGFkYXRhID0gX3JlZjIubWV0YWRhdGEsCiAgICAgICAgICAgICAgY29udGVudERpc3Bvc2l0aW9uRmlsZW5hbWUgPSBfcmVmMi5jb250ZW50RGlzcG9zaXRpb25GaWxlbmFtZTsKICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbChbaW5mbywgbWV0YWRhdGEsIGNvbnRlbnREaXNwb3NpdGlvbkZpbGVuYW1lIHx8ICgwLCBfdWlfdXRpbHMuZ2V0UERGRmlsZU5hbWVGcm9tVVJMKShfdGhpczIudXJsKSwgX3RoaXMyLl9wYXJzZUZpbGVTaXplKF90aGlzMi5tYXliZUZpbGVTaXplKSwgX3RoaXMyLl9wYXJzZURhdGUoaW5mby5DcmVhdGlvbkRhdGUpLCBfdGhpczIuX3BhcnNlRGF0ZShpbmZvLk1vZERhdGUpLCBfdGhpczIucGRmRG9jdW1lbnQuZ2V0UGFnZShjdXJyZW50UGFnZU51bWJlcikudGhlbihmdW5jdGlvbiAocGRmUGFnZSkgewogICAgICAgICAgICByZXR1cm4gX3RoaXMyLl9wYXJzZVBhZ2VTaXplKCgwLCBfdWlfdXRpbHMuZ2V0UGFnZVNpemVJbmNoZXMpKHBkZlBhZ2UpLCBwYWdlc1JvdGF0aW9uKTsKICAgICAgICAgIH0pLCBfdGhpczIuX3BhcnNlTGluZWFyaXphdGlvbihpbmZvLklzTGluZWFyaXplZCldKTsKICAgICAgICB9KS50aGVuKGZ1bmN0aW9uIChfcmVmMykgewogICAgICAgICAgdmFyIF9yZWY0ID0gX3NsaWNlZFRvQXJyYXkoX3JlZjMsIDgpLAogICAgICAgICAgICAgIGluZm8gPSBfcmVmNFswXSwKICAgICAgICAgICAgICBtZXRhZGF0YSA9IF9yZWY0WzFdLAogICAgICAgICAgICAgIGZpbGVOYW1lID0gX3JlZjRbMl0sCiAgICAgICAgICAgICAgZmlsZVNpemUgPSBfcmVmNFszXSwKICAgICAgICAgICAgICBjcmVhdGlvbkRhdGUgPSBfcmVmNFs0XSwKICAgICAgICAgICAgICBtb2REYXRlID0gX3JlZjRbNV0sCiAgICAgICAgICAgICAgcGFnZVNpemUgPSBfcmVmNFs2XSwKICAgICAgICAgICAgICBpc0xpbmVhcml6ZWQgPSBfcmVmNFs3XTsKCiAgICAgICAgICBmcmVlemVGaWVsZERhdGEoewogICAgICAgICAgICBmaWxlTmFtZTogZmlsZU5hbWUsCiAgICAgICAgICAgIGZpbGVTaXplOiBmaWxlU2l6ZSwKICAgICAgICAgICAgdGl0bGU6IGluZm8uVGl0bGUsCiAgICAgICAgICAgIGF1dGhvcjogaW5mby5BdXRob3IsCiAgICAgICAgICAgIHN1YmplY3Q6IGluZm8uU3ViamVjdCwKICAgICAgICAgICAga2V5d29yZHM6IGluZm8uS2V5d29yZHMsCiAgICAgICAgICAgIGNyZWF0aW9uRGF0ZTogY3JlYXRpb25EYXRlLAogICAgICAgICAgICBtb2RpZmljYXRpb25EYXRlOiBtb2REYXRlLAogICAgICAgICAgICBjcmVhdG9yOiBpbmZvLkNyZWF0b3IsCiAgICAgICAgICAgIHByb2R1Y2VyOiBpbmZvLlByb2R1Y2VyLAogICAgICAgICAgICB2ZXJzaW9uOiBpbmZvLlBERkZvcm1hdFZlcnNpb24sCiAgICAgICAgICAgIHBhZ2VDb3VudDogX3RoaXMyLnBkZkRvY3VtZW50Lm51bVBhZ2VzLAogICAgICAgICAgICBwYWdlU2l6ZTogcGFnZVNpemUsCiAgICAgICAgICAgIGxpbmVhcml6ZWQ6IGlzTGluZWFyaXplZCwKICAgICAgICAgICAgX2N1cnJlbnRQYWdlTnVtYmVyOiBjdXJyZW50UGFnZU51bWJlciwKICAgICAgICAgICAgX3BhZ2VzUm90YXRpb246IHBhZ2VzUm90YXRpb24KICAgICAgICAgIH0pOwoKICAgICAgICAgIF90aGlzMi5fdXBkYXRlVUkoKTsKCiAgICAgICAgICByZXR1cm4gX3RoaXMyLnBkZkRvY3VtZW50LmdldERvd25sb2FkSW5mbygpOwogICAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKF9yZWY1KSB7CiAgICAgICAgICB2YXIgbGVuZ3RoID0gX3JlZjUubGVuZ3RoOwogICAgICAgICAgX3RoaXMyLm1heWJlRmlsZVNpemUgPSBsZW5ndGg7CiAgICAgICAgICByZXR1cm4gX3RoaXMyLl9wYXJzZUZpbGVTaXplKGxlbmd0aCk7CiAgICAgICAgfSkudGhlbihmdW5jdGlvbiAoZmlsZVNpemUpIHsKICAgICAgICAgIGlmIChmaWxlU2l6ZSA9PT0gX3RoaXMyLmZpZWxkRGF0YS5maWxlU2l6ZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGRhdGEgPSBPYmplY3QuYXNzaWduKE9iamVjdC5jcmVhdGUobnVsbCksIF90aGlzMi5maWVsZERhdGEpOwogICAgICAgICAgZGF0YS5maWxlU2l6ZSA9IGZpbGVTaXplOwogICAgICAgICAgZnJlZXplRmllbGREYXRhKGRhdGEpOwoKICAgICAgICAgIF90aGlzMi5fdXBkYXRlVUkoKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiY2xvc2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNsb3NlKCkgewogICAgICB0aGlzLm92ZXJsYXlNYW5hZ2VyLmNsb3NlKHRoaXMub3ZlcmxheU5hbWUpOwogICAgfQogIH0sIHsKICAgIGtleTogInNldERvY3VtZW50IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXREb2N1bWVudChwZGZEb2N1bWVudCkgewogICAgICB2YXIgdXJsID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiBudWxsOwoKICAgICAgaWYgKHRoaXMucGRmRG9jdW1lbnQpIHsKICAgICAgICB0aGlzLl9yZXNldCgpOwoKICAgICAgICB0aGlzLl91cGRhdGVVSSh0cnVlKTsKICAgICAgfQoKICAgICAgaWYgKCFwZGZEb2N1bWVudCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5wZGZEb2N1bWVudCA9IHBkZkRvY3VtZW50OwogICAgICB0aGlzLnVybCA9IHVybDsKCiAgICAgIHRoaXMuX2RhdGFBdmFpbGFibGVDYXBhYmlsaXR5LnJlc29sdmUoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJzZXRGaWxlU2l6ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2V0RmlsZVNpemUoZmlsZVNpemUpIHsKICAgICAgaWYgKE51bWJlci5pc0ludGVnZXIoZmlsZVNpemUpICYmIGZpbGVTaXplID4gMCkgewogICAgICAgIHRoaXMubWF5YmVGaWxlU2l6ZSA9IGZpbGVTaXplOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAiX3Jlc2V0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfcmVzZXQoKSB7CiAgICAgIHRoaXMucGRmRG9jdW1lbnQgPSBudWxsOwogICAgICB0aGlzLnVybCA9IG51bGw7CiAgICAgIHRoaXMubWF5YmVGaWxlU2l6ZSA9IDA7CiAgICAgIGRlbGV0ZSB0aGlzLmZpZWxkRGF0YTsKICAgICAgdGhpcy5fZGF0YUF2YWlsYWJsZUNhcGFiaWxpdHkgPSAoMCwgX3BkZmpzTGliLmNyZWF0ZVByb21pc2VDYXBhYmlsaXR5KSgpOwogICAgICB0aGlzLl9jdXJyZW50UGFnZU51bWJlciA9IDE7CiAgICAgIHRoaXMuX3BhZ2VzUm90YXRpb24gPSAwOwogICAgfQogIH0sIHsKICAgIGtleTogIl91cGRhdGVVSSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3VwZGF0ZVVJKCkgewogICAgICB2YXIgcmVzZXQgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IGZhbHNlOwoKICAgICAgaWYgKHJlc2V0IHx8ICF0aGlzLmZpZWxkRGF0YSkgewogICAgICAgIGZvciAodmFyIGlkIGluIHRoaXMuZmllbGRzKSB7CiAgICAgICAgICB0aGlzLmZpZWxkc1tpZF0udGV4dENvbnRlbnQgPSBERUZBVUxUX0ZJRUxEX0NPTlRFTlQ7CiAgICAgICAgfQoKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLm92ZXJsYXlNYW5hZ2VyLmFjdGl2ZSAhPT0gdGhpcy5vdmVybGF5TmFtZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgZm9yICh2YXIgX2lkIGluIHRoaXMuZmllbGRzKSB7CiAgICAgICAgdmFyIGNvbnRlbnQgPSB0aGlzLmZpZWxkRGF0YVtfaWRdOwogICAgICAgIHRoaXMuZmllbGRzW19pZF0udGV4dENvbnRlbnQgPSBjb250ZW50IHx8IGNvbnRlbnQgPT09IDAgPyBjb250ZW50IDogREVGQVVMVF9GSUVMRF9DT05URU5UOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAiX3BhcnNlRmlsZVNpemUiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9wYXJzZUZpbGVTaXplMiA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ubWFyayhmdW5jdGlvbiBfY2FsbGVlKCkgewogICAgICAgIHZhciBmaWxlU2l6ZSwKICAgICAgICAgICAga2IsCiAgICAgICAgICAgIF9hcmdzID0gYXJndW1lbnRzOwogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JbImRlZmF1bHQiXS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUkKF9jb250ZXh0KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0LnByZXYgPSBfY29udGV4dC5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgZmlsZVNpemUgPSBfYXJncy5sZW5ndGggPiAwICYmIF9hcmdzWzBdICE9PSB1bmRlZmluZWQgPyBfYXJnc1swXSA6IDA7CiAgICAgICAgICAgICAgICBrYiA9IGZpbGVTaXplIC8gMTAyNDsKCiAgICAgICAgICAgICAgICBpZiAoa2IpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDY7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5hYnJ1cHQoInJldHVybiIsIHVuZGVmaW5lZCk7CgogICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICAgIGlmICghKGtiIDwgMTAyNCkpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDg7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5hYnJ1cHQoInJldHVybiIsIHRoaXMubDEwbi5nZXQoImRvY3VtZW50X3Byb3BlcnRpZXNfa2IiLCB7CiAgICAgICAgICAgICAgICAgIHNpemVfa2I6ICgra2IudG9QcmVjaXNpb24oMykpLnRvTG9jYWxlU3RyaW5nKCksCiAgICAgICAgICAgICAgICAgIHNpemVfYjogZmlsZVNpemUudG9Mb2NhbGVTdHJpbmcoKQogICAgICAgICAgICAgICAgfSwgInt7c2l6ZV9rYn19IEtCICh7e3NpemVfYn19IGJ5dGVzKSIpKTsKCiAgICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0LmFicnVwdCgicmV0dXJuIiwgdGhpcy5sMTBuLmdldCgiZG9jdW1lbnRfcHJvcGVydGllc19tYiIsIHsKICAgICAgICAgICAgICAgICAgc2l6ZV9tYjogKCsoa2IgLyAxMDI0KS50b1ByZWNpc2lvbigzKSkudG9Mb2NhbGVTdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgc2l6ZV9iOiBmaWxlU2l6ZS50b0xvY2FsZVN0cmluZygpCiAgICAgICAgICAgICAgICB9LCAie3tzaXplX21ifX0gTUIgKHt7c2l6ZV9ifX0gYnl0ZXMpIikpOwoKICAgICAgICAgICAgICBjYXNlIDk6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlLCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gX3BhcnNlRmlsZVNpemUoKSB7CiAgICAgICAgcmV0dXJuIF9wYXJzZUZpbGVTaXplMi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gX3BhcnNlRmlsZVNpemU7CiAgICB9KCkKICB9LCB7CiAgICBrZXk6ICJfcGFyc2VQYWdlU2l6ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3BhcnNlUGFnZVNpemUyID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JbImRlZmF1bHQiXS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUyKHBhZ2VTaXplSW5jaGVzLCBwYWdlc1JvdGF0aW9uKSB7CiAgICAgICAgdmFyIF90aGlzMyA9IHRoaXM7CgogICAgICAgIHZhciBpc1BvcnRyYWl0LCBzaXplSW5jaGVzLCBzaXplTWlsbGltZXRlcnMsIHBhZ2VOYW1lLCByYXdOYW1lLCBleGFjdE1pbGxpbWV0ZXJzLCBpbnRNaWxsaW1ldGVyczsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ud3JhcChmdW5jdGlvbiBfY2FsbGVlMiQoX2NvbnRleHQyKSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0Mi5wcmV2ID0gX2NvbnRleHQyLm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBpZiAocGFnZVNpemVJbmNoZXMpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQyLm5leHQgPSAyOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyLmFicnVwdCgicmV0dXJuIiwgdW5kZWZpbmVkKTsKCiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgaWYgKHBhZ2VzUm90YXRpb24gJSAxODAgIT09IDApIHsKICAgICAgICAgICAgICAgICAgcGFnZVNpemVJbmNoZXMgPSB7CiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IHBhZ2VTaXplSW5jaGVzLmhlaWdodCwKICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IHBhZ2VTaXplSW5jaGVzLndpZHRoCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaXNQb3J0cmFpdCA9ICgwLCBfdWlfdXRpbHMuaXNQb3J0cmFpdE9yaWVudGF0aW9uKShwYWdlU2l6ZUluY2hlcyk7CiAgICAgICAgICAgICAgICBzaXplSW5jaGVzID0gewogICAgICAgICAgICAgICAgICB3aWR0aDogTWF0aC5yb3VuZChwYWdlU2l6ZUluY2hlcy53aWR0aCAqIDEwMCkgLyAxMDAsCiAgICAgICAgICAgICAgICAgIGhlaWdodDogTWF0aC5yb3VuZChwYWdlU2l6ZUluY2hlcy5oZWlnaHQgKiAxMDApIC8gMTAwCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgc2l6ZU1pbGxpbWV0ZXJzID0gewogICAgICAgICAgICAgICAgICB3aWR0aDogTWF0aC5yb3VuZChwYWdlU2l6ZUluY2hlcy53aWR0aCAqIDI1LjQgKiAxMCkgLyAxMCwKICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBNYXRoLnJvdW5kKHBhZ2VTaXplSW5jaGVzLmhlaWdodCAqIDI1LjQgKiAxMCkgLyAxMAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHBhZ2VOYW1lID0gbnVsbDsKICAgICAgICAgICAgICAgIHJhd05hbWUgPSBnZXRQYWdlTmFtZShzaXplSW5jaGVzLCBpc1BvcnRyYWl0LCBVU19QQUdFX05BTUVTKSB8fCBnZXRQYWdlTmFtZShzaXplTWlsbGltZXRlcnMsIGlzUG9ydHJhaXQsIE1FVFJJQ19QQUdFX05BTUVTKTsKCiAgICAgICAgICAgICAgICBpZiAoIXJhd05hbWUgJiYgIShOdW1iZXIuaXNJbnRlZ2VyKHNpemVNaWxsaW1ldGVycy53aWR0aCkgJiYgTnVtYmVyLmlzSW50ZWdlcihzaXplTWlsbGltZXRlcnMuaGVpZ2h0KSkpIHsKICAgICAgICAgICAgICAgICAgZXhhY3RNaWxsaW1ldGVycyA9IHsKICAgICAgICAgICAgICAgICAgICB3aWR0aDogcGFnZVNpemVJbmNoZXMud2lkdGggKiAyNS40LAogICAgICAgICAgICAgICAgICAgIGhlaWdodDogcGFnZVNpemVJbmNoZXMuaGVpZ2h0ICogMjUuNAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBpbnRNaWxsaW1ldGVycyA9IHsKICAgICAgICAgICAgICAgICAgICB3aWR0aDogTWF0aC5yb3VuZChzaXplTWlsbGltZXRlcnMud2lkdGgpLAogICAgICAgICAgICAgICAgICAgIGhlaWdodDogTWF0aC5yb3VuZChzaXplTWlsbGltZXRlcnMuaGVpZ2h0KQogICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKGV4YWN0TWlsbGltZXRlcnMud2lkdGggLSBpbnRNaWxsaW1ldGVycy53aWR0aCkgPCAwLjEgJiYgTWF0aC5hYnMoZXhhY3RNaWxsaW1ldGVycy5oZWlnaHQgLSBpbnRNaWxsaW1ldGVycy5oZWlnaHQpIDwgMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgcmF3TmFtZSA9IGdldFBhZ2VOYW1lKGludE1pbGxpbWV0ZXJzLCBpc1BvcnRyYWl0LCBNRVRSSUNfUEFHRV9OQU1FUyk7CgogICAgICAgICAgICAgICAgICAgIGlmIChyYXdOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICBzaXplSW5jaGVzID0gewogICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogTWF0aC5yb3VuZChpbnRNaWxsaW1ldGVycy53aWR0aCAvIDI1LjQgKiAxMDApIC8gMTAwLAogICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IE1hdGgucm91bmQoaW50TWlsbGltZXRlcnMuaGVpZ2h0IC8gMjUuNCAqIDEwMCkgLyAxMDAKICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICBzaXplTWlsbGltZXRlcnMgPSBpbnRNaWxsaW1ldGVyczsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAocmF3TmFtZSkgewogICAgICAgICAgICAgICAgICBwYWdlTmFtZSA9IHRoaXMubDEwbi5nZXQoImRvY3VtZW50X3Byb3BlcnRpZXNfcGFnZV9zaXplX25hbWVfIiArIHJhd05hbWUudG9Mb3dlckNhc2UoKSwgbnVsbCwgcmF3TmFtZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Mi5hYnJ1cHQoInJldHVybiIsIFByb21pc2UuYWxsKFt0aGlzLl9pc05vbk1ldHJpY0xvY2FsZSA/IHNpemVJbmNoZXMgOiBzaXplTWlsbGltZXRlcnMsIHRoaXMubDEwbi5nZXQoImRvY3VtZW50X3Byb3BlcnRpZXNfcGFnZV9zaXplX3VuaXRfIiArICh0aGlzLl9pc05vbk1ldHJpY0xvY2FsZSA/ICJpbmNoZXMiIDogIm1pbGxpbWV0ZXJzIiksIG51bGwsIHRoaXMuX2lzTm9uTWV0cmljTG9jYWxlID8gImluIiA6ICJtbSIpLCBwYWdlTmFtZSwgdGhpcy5sMTBuLmdldCgiZG9jdW1lbnRfcHJvcGVydGllc19wYWdlX3NpemVfb3JpZW50YXRpb25fIiArIChpc1BvcnRyYWl0ID8gInBvcnRyYWl0IiA6ICJsYW5kc2NhcGUiKSwgbnVsbCwgaXNQb3J0cmFpdCA/ICJwb3J0cmFpdCIgOiAibGFuZHNjYXBlIildKS50aGVuKGZ1bmN0aW9uIChfcmVmNikgewogICAgICAgICAgICAgICAgICB2YXIgX3JlZjcgPSBfc2xpY2VkVG9BcnJheShfcmVmNiwgNCksCiAgICAgICAgICAgICAgICAgICAgICBfcmVmNyQgPSBfcmVmN1swXSwKICAgICAgICAgICAgICAgICAgICAgIHdpZHRoID0gX3JlZjckLndpZHRoLAogICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0ID0gX3JlZjckLmhlaWdodCwKICAgICAgICAgICAgICAgICAgICAgIHVuaXQgPSBfcmVmN1sxXSwKICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSBfcmVmN1syXSwKICAgICAgICAgICAgICAgICAgICAgIG9yaWVudGF0aW9uID0gX3JlZjdbM107CgogICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMzLmwxMG4uZ2V0KCJkb2N1bWVudF9wcm9wZXJ0aWVzX3BhZ2Vfc2l6ZV9kaW1lbnNpb25fIiArIChuYW1lID8gIm5hbWVfIiA6ICIiKSArICJzdHJpbmciLCB7CiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IHdpZHRoLnRvTG9jYWxlU3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBoZWlnaHQudG9Mb2NhbGVTdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB1bml0OiB1bml0LAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICAgICAgb3JpZW50YXRpb246IG9yaWVudGF0aW9uCiAgICAgICAgICAgICAgICAgIH0sICJ7e3dpZHRofX0gw5cge3toZWlnaHR9fSB7e3VuaXR9fSAoIiArIChuYW1lID8gInt7bmFtZX19LCAiIDogIiIpICsgInt7b3JpZW50YXRpb259fSkiKTsKICAgICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgICAgY2FzZSAxMToKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Mi5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMiwgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIF9wYXJzZVBhZ2VTaXplKF94LCBfeDIpIHsKICAgICAgICByZXR1cm4gX3BhcnNlUGFnZVNpemUyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBfcGFyc2VQYWdlU2l6ZTsKICAgIH0oKQogIH0sIHsKICAgIGtleTogIl9wYXJzZURhdGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9wYXJzZURhdGUyID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JbImRlZmF1bHQiXS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUzKGlucHV0RGF0ZSkgewogICAgICAgIHZhciBkYXRlT2JqZWN0OwogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JbImRlZmF1bHQiXS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUzJChfY29udGV4dDMpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQzLnByZXYgPSBfY29udGV4dDMubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIGRhdGVPYmplY3QgPSBfcGRmanNMaWIuUERGRGF0ZVN0cmluZy50b0RhdGVPYmplY3QoaW5wdXREYXRlKTsKCiAgICAgICAgICAgICAgICBpZiAoZGF0ZU9iamVjdCkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDM7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMuYWJydXB0KCJyZXR1cm4iLCB1bmRlZmluZWQpOwoKICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzLmFicnVwdCgicmV0dXJuIiwgdGhpcy5sMTBuLmdldCgiZG9jdW1lbnRfcHJvcGVydGllc19kYXRlX3N0cmluZyIsIHsKICAgICAgICAgICAgICAgICAgZGF0ZTogZGF0ZU9iamVjdC50b0xvY2FsZURhdGVTdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgdGltZTogZGF0ZU9iamVjdC50b0xvY2FsZVRpbWVTdHJpbmcoKQogICAgICAgICAgICAgICAgfSwgInt7ZGF0ZX19LCB7e3RpbWV9fSIpKTsKCiAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzLnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWUzLCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gX3BhcnNlRGF0ZShfeDMpIHsKICAgICAgICByZXR1cm4gX3BhcnNlRGF0ZTIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIF9wYXJzZURhdGU7CiAgICB9KCkKICB9LCB7CiAgICBrZXk6ICJfcGFyc2VMaW5lYXJpemF0aW9uIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfcGFyc2VMaW5lYXJpemF0aW9uKGlzTGluZWFyaXplZCkgewogICAgICByZXR1cm4gdGhpcy5sMTBuLmdldCgiZG9jdW1lbnRfcHJvcGVydGllc19saW5lYXJpemVkXyIgKyAoaXNMaW5lYXJpemVkID8gInllcyIgOiAibm8iKSwgbnVsbCwgaXNMaW5lYXJpemVkID8gIlllcyIgOiAiTm8iKTsKICAgIH0KICB9XSk7CgogIHJldHVybiBQREZEb2N1bWVudFByb3BlcnRpZXM7Cn0oKTsKCmV4cG9ydHMuUERGRG9jdW1lbnRQcm9wZXJ0aWVzID0gUERGRG9jdW1lbnRQcm9wZXJ0aWVzOwoKLyoqKi8gfSksCi8qIDE3ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuUERGRmluZEJhciA9IHZvaWQgMDsKCnZhciBfcGRmX2ZpbmRfY29udHJvbGxlciA9IF9fd2VicGFja19yZXF1aXJlX18oMTgpOwoKdmFyIF91aV91dGlscyA9IF9fd2VicGFja19yZXF1aXJlX18oNSk7CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOyB9IH0KCmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9CgpmdW5jdGlvbiBfY3JlYXRlQ2xhc3MoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfQoKdmFyIE1BVENIRVNfQ09VTlRfTElNSVQgPSAxMDAwOwoKdmFyIFBERkZpbmRCYXIgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIFBERkZpbmRCYXIob3B0aW9ucywgZXZlbnRCdXMpIHsKICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgdmFyIGwxMG4gPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1syXSA6IF91aV91dGlscy5OdWxsTDEwbjsKCiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgUERGRmluZEJhcik7CgogICAgdGhpcy5vcGVuZWQgPSBmYWxzZTsKICAgIHRoaXMuYmFyID0gb3B0aW9ucy5iYXIgfHwgbnVsbDsKICAgIHRoaXMudG9nZ2xlQnV0dG9uID0gb3B0aW9ucy50b2dnbGVCdXR0b24gfHwgbnVsbDsKICAgIHRoaXMuZmluZEZpZWxkID0gb3B0aW9ucy5maW5kRmllbGQgfHwgbnVsbDsKICAgIHRoaXMuaGlnaGxpZ2h0QWxsID0gb3B0aW9ucy5oaWdobGlnaHRBbGxDaGVja2JveCB8fCBudWxsOwogICAgdGhpcy5jYXNlU2Vuc2l0aXZlID0gb3B0aW9ucy5jYXNlU2Vuc2l0aXZlQ2hlY2tib3ggfHwgbnVsbDsKICAgIHRoaXMuZW50aXJlV29yZCA9IG9wdGlvbnMuZW50aXJlV29yZENoZWNrYm94IHx8IG51bGw7CiAgICB0aGlzLmZpbmRNc2cgPSBvcHRpb25zLmZpbmRNc2cgfHwgbnVsbDsKICAgIHRoaXMuZmluZFJlc3VsdHNDb3VudCA9IG9wdGlvbnMuZmluZFJlc3VsdHNDb3VudCB8fCBudWxsOwogICAgdGhpcy5maW5kUHJldmlvdXNCdXR0b24gPSBvcHRpb25zLmZpbmRQcmV2aW91c0J1dHRvbiB8fCBudWxsOwogICAgdGhpcy5maW5kTmV4dEJ1dHRvbiA9IG9wdGlvbnMuZmluZE5leHRCdXR0b24gfHwgbnVsbDsKICAgIHRoaXMuZXZlbnRCdXMgPSBldmVudEJ1czsKICAgIHRoaXMubDEwbiA9IGwxMG47CiAgICB0aGlzLnRvZ2dsZUJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgX3RoaXMudG9nZ2xlKCk7CiAgICB9KTsKICAgIHRoaXMuZmluZEZpZWxkLmFkZEV2ZW50TGlzdGVuZXIoImlucHV0IiwgZnVuY3Rpb24gKCkgewogICAgICBfdGhpcy5kaXNwYXRjaEV2ZW50KCIiKTsKICAgIH0pOwogICAgdGhpcy5iYXIuYWRkRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsIGZ1bmN0aW9uIChlKSB7CiAgICAgIHN3aXRjaCAoZS5rZXlDb2RlKSB7CiAgICAgICAgY2FzZSAxMzoKICAgICAgICAgIGlmIChlLnRhcmdldCA9PT0gX3RoaXMuZmluZEZpZWxkKSB7CiAgICAgICAgICAgIF90aGlzLmRpc3BhdGNoRXZlbnQoImFnYWluIiwgZS5zaGlmdEtleSk7CiAgICAgICAgICB9CgogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgMjc6CiAgICAgICAgICBfdGhpcy5jbG9zZSgpOwoKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9KTsKICAgIHRoaXMuZmluZFByZXZpb3VzQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgZnVuY3Rpb24gKCkgewogICAgICBfdGhpcy5kaXNwYXRjaEV2ZW50KCJhZ2FpbiIsIHRydWUpOwogICAgfSk7CiAgICB0aGlzLmZpbmROZXh0QnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgZnVuY3Rpb24gKCkgewogICAgICBfdGhpcy5kaXNwYXRjaEV2ZW50KCJhZ2FpbiIsIGZhbHNlKTsKICAgIH0pOwogICAgdGhpcy5oaWdobGlnaHRBbGwuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgIF90aGlzLmRpc3BhdGNoRXZlbnQoImhpZ2hsaWdodGFsbGNoYW5nZSIpOwogICAgfSk7CiAgICB0aGlzLmNhc2VTZW5zaXRpdmUuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgIF90aGlzLmRpc3BhdGNoRXZlbnQoImNhc2VzZW5zaXRpdml0eWNoYW5nZSIpOwogICAgfSk7CiAgICB0aGlzLmVudGlyZVdvcmQuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgIF90aGlzLmRpc3BhdGNoRXZlbnQoImVudGlyZXdvcmRjaGFuZ2UiKTsKICAgIH0pOwoKICAgIHRoaXMuZXZlbnRCdXMuX29uKCJyZXNpemUiLCB0aGlzLl9hZGp1c3RXaWR0aC5iaW5kKHRoaXMpKTsKICB9CgogIF9jcmVhdGVDbGFzcyhQREZGaW5kQmFyLCBbewogICAga2V5OiAicmVzZXQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlc2V0KCkgewogICAgICB0aGlzLnVwZGF0ZVVJU3RhdGUoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJkaXNwYXRjaEV2ZW50IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBkaXNwYXRjaEV2ZW50KHR5cGUsIGZpbmRQcmV2KSB7CiAgICAgIHRoaXMuZXZlbnRCdXMuZGlzcGF0Y2goImZpbmQiLCB7CiAgICAgICAgc291cmNlOiB0aGlzLAogICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgcXVlcnk6IHRoaXMuZmluZEZpZWxkLnZhbHVlLAogICAgICAgIHBocmFzZVNlYXJjaDogdHJ1ZSwKICAgICAgICBjYXNlU2Vuc2l0aXZlOiB0aGlzLmNhc2VTZW5zaXRpdmUuY2hlY2tlZCwKICAgICAgICBlbnRpcmVXb3JkOiB0aGlzLmVudGlyZVdvcmQuY2hlY2tlZCwKICAgICAgICBoaWdobGlnaHRBbGw6IHRoaXMuaGlnaGxpZ2h0QWxsLmNoZWNrZWQsCiAgICAgICAgZmluZFByZXZpb3VzOiBmaW5kUHJldgogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJ1cGRhdGVVSVN0YXRlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB1cGRhdGVVSVN0YXRlKHN0YXRlLCBwcmV2aW91cywgbWF0Y2hlc0NvdW50KSB7CiAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgdmFyIG5vdEZvdW5kID0gZmFsc2U7CiAgICAgIHZhciBmaW5kTXNnID0gIiI7CiAgICAgIHZhciBzdGF0dXMgPSAiIjsKCiAgICAgIHN3aXRjaCAoc3RhdGUpIHsKICAgICAgICBjYXNlIF9wZGZfZmluZF9jb250cm9sbGVyLkZpbmRTdGF0ZS5GT1VORDoKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlIF9wZGZfZmluZF9jb250cm9sbGVyLkZpbmRTdGF0ZS5QRU5ESU5HOgogICAgICAgICAgc3RhdHVzID0gInBlbmRpbmciOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgX3BkZl9maW5kX2NvbnRyb2xsZXIuRmluZFN0YXRlLk5PVF9GT1VORDoKICAgICAgICAgIGZpbmRNc2cgPSB0aGlzLmwxMG4uZ2V0KCJmaW5kX25vdF9mb3VuZCIsIG51bGwsICJQaHJhc2Ugbm90IGZvdW5kIik7CiAgICAgICAgICBub3RGb3VuZCA9IHRydWU7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSBfcGRmX2ZpbmRfY29udHJvbGxlci5GaW5kU3RhdGUuV1JBUFBFRDoKICAgICAgICAgIGlmIChwcmV2aW91cykgewogICAgICAgICAgICBmaW5kTXNnID0gdGhpcy5sMTBuLmdldCgiZmluZF9yZWFjaGVkX3RvcCIsIG51bGwsICJSZWFjaGVkIHRvcCBvZiBkb2N1bWVudCwgY29udGludWVkIGZyb20gYm90dG9tIik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmaW5kTXNnID0gdGhpcy5sMTBuLmdldCgiZmluZF9yZWFjaGVkX2JvdHRvbSIsIG51bGwsICJSZWFjaGVkIGVuZCBvZiBkb2N1bWVudCwgY29udGludWVkIGZyb20gdG9wIik7CiAgICAgICAgICB9CgogICAgICAgICAgYnJlYWs7CiAgICAgIH0KCiAgICAgIHRoaXMuZmluZEZpZWxkLmNsYXNzTGlzdC50b2dnbGUoIm5vdEZvdW5kIiwgbm90Rm91bmQpOwogICAgICB0aGlzLmZpbmRGaWVsZC5zZXRBdHRyaWJ1dGUoImRhdGEtc3RhdHVzIiwgc3RhdHVzKTsKICAgICAgUHJvbWlzZS5yZXNvbHZlKGZpbmRNc2cpLnRoZW4oZnVuY3Rpb24gKG1zZykgewogICAgICAgIF90aGlzMi5maW5kTXNnLnRleHRDb250ZW50ID0gbXNnOwoKICAgICAgICBfdGhpczIuX2FkanVzdFdpZHRoKCk7CiAgICAgIH0pOwogICAgICB0aGlzLnVwZGF0ZVJlc3VsdHNDb3VudChtYXRjaGVzQ291bnQpOwogICAgfQogIH0sIHsKICAgIGtleTogInVwZGF0ZVJlc3VsdHNDb3VudCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdXBkYXRlUmVzdWx0c0NvdW50KCkgewogICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgIHZhciBfcmVmID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiB7fSwKICAgICAgICAgIF9yZWYkY3VycmVudCA9IF9yZWYuY3VycmVudCwKICAgICAgICAgIGN1cnJlbnQgPSBfcmVmJGN1cnJlbnQgPT09IHZvaWQgMCA/IDAgOiBfcmVmJGN1cnJlbnQsCiAgICAgICAgICBfcmVmJHRvdGFsID0gX3JlZi50b3RhbCwKICAgICAgICAgIHRvdGFsID0gX3JlZiR0b3RhbCA9PT0gdm9pZCAwID8gMCA6IF9yZWYkdG90YWw7CgogICAgICBpZiAoIXRoaXMuZmluZFJlc3VsdHNDb3VudCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGxpbWl0ID0gTUFUQ0hFU19DT1VOVF9MSU1JVDsKICAgICAgdmFyIG1hdGNoZXNDb3VudE1zZyA9ICIiOwoKICAgICAgaWYgKHRvdGFsID4gMCkgewogICAgICAgIGlmICh0b3RhbCA+IGxpbWl0KSB7CiAgICAgICAgICBtYXRjaGVzQ291bnRNc2cgPSB0aGlzLmwxMG4uZ2V0KCJmaW5kX21hdGNoX2NvdW50X2xpbWl0IiwgewogICAgICAgICAgICBsaW1pdDogbGltaXQKICAgICAgICAgIH0sICJNb3JlIHRoYW4ge3tsaW1pdH19IG1hdGNoIiArIChsaW1pdCAhPT0gMSA/ICJlcyIgOiAiIikpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBtYXRjaGVzQ291bnRNc2cgPSB0aGlzLmwxMG4uZ2V0KCJmaW5kX21hdGNoX2NvdW50IiwgewogICAgICAgICAgICBjdXJyZW50OiBjdXJyZW50LAogICAgICAgICAgICB0b3RhbDogdG90YWwKICAgICAgICAgIH0sICJ7e2N1cnJlbnR9fSBvZiB7e3RvdGFsfX0gbWF0Y2giICsgKHRvdGFsICE9PSAxID8gImVzIiA6ICIiKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBQcm9taXNlLnJlc29sdmUobWF0Y2hlc0NvdW50TXNnKS50aGVuKGZ1bmN0aW9uIChtc2cpIHsKICAgICAgICBfdGhpczMuZmluZFJlc3VsdHNDb3VudC50ZXh0Q29udGVudCA9IG1zZzsKCiAgICAgICAgX3RoaXMzLmZpbmRSZXN1bHRzQ291bnQuY2xhc3NMaXN0LnRvZ2dsZSgiaGlkZGVuIiwgIXRvdGFsKTsKCiAgICAgICAgX3RoaXMzLl9hZGp1c3RXaWR0aCgpOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJvcGVuIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBvcGVuKCkgewogICAgICBpZiAoIXRoaXMub3BlbmVkKSB7CiAgICAgICAgdGhpcy5vcGVuZWQgPSB0cnVlOwogICAgICAgIHRoaXMudG9nZ2xlQnV0dG9uLmNsYXNzTGlzdC5hZGQoInRvZ2dsZWQiKTsKICAgICAgICB0aGlzLmJhci5jbGFzc0xpc3QucmVtb3ZlKCJoaWRkZW4iKTsKICAgICAgfQoKICAgICAgdGhpcy5maW5kRmllbGQuc2VsZWN0KCk7CiAgICAgIHRoaXMuZmluZEZpZWxkLmZvY3VzKCk7CgogICAgICB0aGlzLl9hZGp1c3RXaWR0aCgpOwogICAgfQogIH0sIHsKICAgIGtleTogImNsb3NlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjbG9zZSgpIHsKICAgICAgaWYgKCF0aGlzLm9wZW5lZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5vcGVuZWQgPSBmYWxzZTsKICAgICAgdGhpcy50b2dnbGVCdXR0b24uY2xhc3NMaXN0LnJlbW92ZSgidG9nZ2xlZCIpOwogICAgICB0aGlzLmJhci5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsKICAgICAgdGhpcy5ldmVudEJ1cy5kaXNwYXRjaCgiZmluZGJhcmNsb3NlIiwgewogICAgICAgIHNvdXJjZTogdGhpcwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJ0b2dnbGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHRvZ2dsZSgpIHsKICAgICAgaWYgKHRoaXMub3BlbmVkKSB7CiAgICAgICAgdGhpcy5jbG9zZSgpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMub3BlbigpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAiX2FkanVzdFdpZHRoIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfYWRqdXN0V2lkdGgoKSB7CiAgICAgIGlmICghdGhpcy5vcGVuZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMuYmFyLmNsYXNzTGlzdC5yZW1vdmUoIndyYXBDb250YWluZXJzIik7CiAgICAgIHZhciBmaW5kYmFySGVpZ2h0ID0gdGhpcy5iYXIuY2xpZW50SGVpZ2h0OwogICAgICB2YXIgaW5wdXRDb250YWluZXJIZWlnaHQgPSB0aGlzLmJhci5maXJzdEVsZW1lbnRDaGlsZC5jbGllbnRIZWlnaHQ7CgogICAgICBpZiAoZmluZGJhckhlaWdodCA+IGlucHV0Q29udGFpbmVySGVpZ2h0KSB7CiAgICAgICAgdGhpcy5iYXIuY2xhc3NMaXN0LmFkZCgid3JhcENvbnRhaW5lcnMiKTsKICAgICAgfQogICAgfQogIH1dKTsKCiAgcmV0dXJuIFBERkZpbmRCYXI7Cn0oKTsKCmV4cG9ydHMuUERGRmluZEJhciA9IFBERkZpbmRCYXI7CgovKioqLyB9KSwKLyogMTggKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKInVzZSBzdHJpY3QiOwoKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKZXhwb3J0cy5QREZGaW5kQ29udHJvbGxlciA9IGV4cG9ydHMuRmluZFN0YXRlID0gdm9pZCAwOwoKdmFyIF9wZGZqc0xpYiA9IF9fd2VicGFja19yZXF1aXJlX18oOCk7Cgp2YXIgX3BkZl9maW5kX3V0aWxzID0gX193ZWJwYWNrX3JlcXVpcmVfXygxOSk7Cgp2YXIgX3VpX3V0aWxzID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1KTsKCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7IH0gfQoKZnVuY3Rpb24gX2RlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoInZhbHVlIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0KCmZ1bmN0aW9uIF9jcmVhdGVDbGFzcyhDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9Cgp2YXIgRmluZFN0YXRlID0gewogIEZPVU5EOiAwLAogIE5PVF9GT1VORDogMSwKICBXUkFQUEVEOiAyLAogIFBFTkRJTkc6IDMKfTsKZXhwb3J0cy5GaW5kU3RhdGUgPSBGaW5kU3RhdGU7CnZhciBGSU5EX1RJTUVPVVQgPSAyNTA7CnZhciBNQVRDSF9TQ1JPTExfT0ZGU0VUX1RPUCA9IC01MDsKdmFyIE1BVENIX1NDUk9MTF9PRkZTRVRfTEVGVCA9IC00MDA7CnZhciBDSEFSQUNURVJTX1RPX05PUk1BTElaRSA9IHsKICAiXHUyMDE4IjogIiciLAogICJcdTIwMTkiOiAiJyIsCiAgIlx1MjAxQSI6ICInIiwKICAiXHUyMDFCIjogIiciLAogICJcdTIwMUMiOiAnIicsCiAgIlx1MjAxRCI6ICciJywKICAiXHUyMDFFIjogJyInLAogICJcdTIwMUYiOiAnIicsCiAgIlx4QkMiOiAiMS80IiwKICAiXHhCRCI6ICIxLzIiLAogICJceEJFIjogIjMvNCIKfTsKdmFyIG5vcm1hbGl6YXRpb25SZWdleCA9IG51bGw7CgpmdW5jdGlvbiBub3JtYWxpemUodGV4dCkgewogIGlmICghbm9ybWFsaXphdGlvblJlZ2V4KSB7CiAgICB2YXIgcmVwbGFjZSA9IE9iamVjdC5rZXlzKENIQVJBQ1RFUlNfVE9fTk9STUFMSVpFKS5qb2luKCIiKTsKICAgIG5vcm1hbGl6YXRpb25SZWdleCA9IG5ldyBSZWdFeHAoIlsiLmNvbmNhdChyZXBsYWNlLCAiXSIpLCAiZyIpOwogIH0KCiAgcmV0dXJuIHRleHQucmVwbGFjZShub3JtYWxpemF0aW9uUmVnZXgsIGZ1bmN0aW9uIChjaCkgewogICAgcmV0dXJuIENIQVJBQ1RFUlNfVE9fTk9STUFMSVpFW2NoXTsKICB9KTsKfQoKdmFyIFBERkZpbmRDb250cm9sbGVyID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICBmdW5jdGlvbiBQREZGaW5kQ29udHJvbGxlcihfcmVmKSB7CiAgICB2YXIgbGlua1NlcnZpY2UgPSBfcmVmLmxpbmtTZXJ2aWNlLAogICAgICAgIGV2ZW50QnVzID0gX3JlZi5ldmVudEJ1czsKCiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgUERGRmluZENvbnRyb2xsZXIpOwoKICAgIHRoaXMuX2xpbmtTZXJ2aWNlID0gbGlua1NlcnZpY2U7CiAgICB0aGlzLl9ldmVudEJ1cyA9IGV2ZW50QnVzOwoKICAgIHRoaXMuX3Jlc2V0KCk7CgogICAgZXZlbnRCdXMuX29uKCJmaW5kYmFyY2xvc2UiLCB0aGlzLl9vbkZpbmRCYXJDbG9zZS5iaW5kKHRoaXMpKTsKICB9CgogIF9jcmVhdGVDbGFzcyhQREZGaW5kQ29udHJvbGxlciwgW3sKICAgIGtleTogInNldERvY3VtZW50IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXREb2N1bWVudChwZGZEb2N1bWVudCkgewogICAgICBpZiAodGhpcy5fcGRmRG9jdW1lbnQpIHsKICAgICAgICB0aGlzLl9yZXNldCgpOwogICAgICB9CgogICAgICBpZiAoIXBkZkRvY3VtZW50KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLl9wZGZEb2N1bWVudCA9IHBkZkRvY3VtZW50OwoKICAgICAgdGhpcy5fZmlyc3RQYWdlQ2FwYWJpbGl0eS5yZXNvbHZlKCk7CiAgICB9CiAgfSwgewogICAga2V5OiAiZXhlY3V0ZUNvbW1hbmQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGV4ZWN1dGVDb21tYW5kKGNtZCwgc3RhdGUpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIGlmICghc3RhdGUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBwZGZEb2N1bWVudCA9IHRoaXMuX3BkZkRvY3VtZW50OwoKICAgICAgaWYgKHRoaXMuX3N0YXRlID09PSBudWxsIHx8IHRoaXMuX3Nob3VsZERpcnR5TWF0Y2goY21kLCBzdGF0ZSkpIHsKICAgICAgICB0aGlzLl9kaXJ0eU1hdGNoID0gdHJ1ZTsKICAgICAgfQoKICAgICAgdGhpcy5fc3RhdGUgPSBzdGF0ZTsKCiAgICAgIGlmIChjbWQgIT09ICJmaW5kaGlnaGxpZ2h0YWxsY2hhbmdlIikgewogICAgICAgIHRoaXMuX3VwZGF0ZVVJU3RhdGUoRmluZFN0YXRlLlBFTkRJTkcpOwogICAgICB9CgogICAgICB0aGlzLl9maXJzdFBhZ2VDYXBhYmlsaXR5LnByb21pc2UudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKCFfdGhpcy5fcGRmRG9jdW1lbnQgfHwgcGRmRG9jdW1lbnQgJiYgX3RoaXMuX3BkZkRvY3VtZW50ICE9PSBwZGZEb2N1bWVudCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgX3RoaXMuX2V4dHJhY3RUZXh0KCk7CgogICAgICAgIHZhciBmaW5kYmFyQ2xvc2VkID0gIV90aGlzLl9oaWdobGlnaHRNYXRjaGVzOwogICAgICAgIHZhciBwZW5kaW5nVGltZW91dCA9ICEhX3RoaXMuX2ZpbmRUaW1lb3V0OwoKICAgICAgICBpZiAoX3RoaXMuX2ZpbmRUaW1lb3V0KSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQoX3RoaXMuX2ZpbmRUaW1lb3V0KTsKICAgICAgICAgIF90aGlzLl9maW5kVGltZW91dCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAoY21kID09PSAiZmluZCIpIHsKICAgICAgICAgIF90aGlzLl9maW5kVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBfdGhpcy5fbmV4dE1hdGNoKCk7CgogICAgICAgICAgICBfdGhpcy5fZmluZFRpbWVvdXQgPSBudWxsOwogICAgICAgICAgfSwgRklORF9USU1FT1VUKTsKICAgICAgICB9IGVsc2UgaWYgKF90aGlzLl9kaXJ0eU1hdGNoKSB7CiAgICAgICAgICBfdGhpcy5fbmV4dE1hdGNoKCk7CiAgICAgICAgfSBlbHNlIGlmIChjbWQgPT09ICJmaW5kYWdhaW4iKSB7CiAgICAgICAgICBfdGhpcy5fbmV4dE1hdGNoKCk7CgogICAgICAgICAgaWYgKGZpbmRiYXJDbG9zZWQgJiYgX3RoaXMuX3N0YXRlLmhpZ2hsaWdodEFsbCkgewogICAgICAgICAgICBfdGhpcy5fdXBkYXRlQWxsUGFnZXMoKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGNtZCA9PT0gImZpbmRoaWdobGlnaHRhbGxjaGFuZ2UiKSB7CiAgICAgICAgICBpZiAocGVuZGluZ1RpbWVvdXQpIHsKICAgICAgICAgICAgX3RoaXMuX25leHRNYXRjaCgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgX3RoaXMuX2hpZ2hsaWdodE1hdGNoZXMgPSB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIF90aGlzLl91cGRhdGVBbGxQYWdlcygpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBfdGhpcy5fbmV4dE1hdGNoKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJzY3JvbGxNYXRjaEludG9WaWV3IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzY3JvbGxNYXRjaEludG9WaWV3KF9yZWYyKSB7CiAgICAgIHZhciBfcmVmMiRlbGVtZW50ID0gX3JlZjIuZWxlbWVudCwKICAgICAgICAgIGVsZW1lbnQgPSBfcmVmMiRlbGVtZW50ID09PSB2b2lkIDAgPyBudWxsIDogX3JlZjIkZWxlbWVudCwKICAgICAgICAgIF9yZWYyJHBhZ2VJbmRleCA9IF9yZWYyLnBhZ2VJbmRleCwKICAgICAgICAgIHBhZ2VJbmRleCA9IF9yZWYyJHBhZ2VJbmRleCA9PT0gdm9pZCAwID8gLTEgOiBfcmVmMiRwYWdlSW5kZXgsCiAgICAgICAgICBfcmVmMiRtYXRjaEluZGV4ID0gX3JlZjIubWF0Y2hJbmRleCwKICAgICAgICAgIG1hdGNoSW5kZXggPSBfcmVmMiRtYXRjaEluZGV4ID09PSB2b2lkIDAgPyAtMSA6IF9yZWYyJG1hdGNoSW5kZXg7CgogICAgICBpZiAoIXRoaXMuX3Njcm9sbE1hdGNoZXMgfHwgIWVsZW1lbnQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0gZWxzZSBpZiAobWF0Y2hJbmRleCA9PT0gLTEgfHwgbWF0Y2hJbmRleCAhPT0gdGhpcy5fc2VsZWN0ZWQubWF0Y2hJZHgpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0gZWxzZSBpZiAocGFnZUluZGV4ID09PSAtMSB8fCBwYWdlSW5kZXggIT09IHRoaXMuX3NlbGVjdGVkLnBhZ2VJZHgpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMuX3Njcm9sbE1hdGNoZXMgPSBmYWxzZTsKICAgICAgdmFyIHNwb3QgPSB7CiAgICAgICAgdG9wOiBNQVRDSF9TQ1JPTExfT0ZGU0VUX1RPUCwKICAgICAgICBsZWZ0OiBNQVRDSF9TQ1JPTExfT0ZGU0VUX0xFRlQKICAgICAgfTsKICAgICAgKDAsIF91aV91dGlscy5zY3JvbGxJbnRvVmlldykoZWxlbWVudCwgc3BvdCwgdHJ1ZSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiX3Jlc2V0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfcmVzZXQoKSB7CiAgICAgIHRoaXMuX2hpZ2hsaWdodE1hdGNoZXMgPSBmYWxzZTsKICAgICAgdGhpcy5fc2Nyb2xsTWF0Y2hlcyA9IGZhbHNlOwogICAgICB0aGlzLl9wZGZEb2N1bWVudCA9IG51bGw7CiAgICAgIHRoaXMuX3BhZ2VNYXRjaGVzID0gW107CiAgICAgIHRoaXMuX3BhZ2VNYXRjaGVzTGVuZ3RoID0gW107CiAgICAgIHRoaXMuX3N0YXRlID0gbnVsbDsKICAgICAgdGhpcy5fc2VsZWN0ZWQgPSB7CiAgICAgICAgcGFnZUlkeDogLTEsCiAgICAgICAgbWF0Y2hJZHg6IC0xCiAgICAgIH07CiAgICAgIHRoaXMuX29mZnNldCA9IHsKICAgICAgICBwYWdlSWR4OiBudWxsLAogICAgICAgIG1hdGNoSWR4OiBudWxsLAogICAgICAgIHdyYXBwZWQ6IGZhbHNlCiAgICAgIH07CiAgICAgIHRoaXMuX2V4dHJhY3RUZXh0UHJvbWlzZXMgPSBbXTsKICAgICAgdGhpcy5fcGFnZUNvbnRlbnRzID0gW107CiAgICAgIHRoaXMuX21hdGNoZXNDb3VudFRvdGFsID0gMDsKICAgICAgdGhpcy5fcGFnZXNUb1NlYXJjaCA9IG51bGw7CiAgICAgIHRoaXMuX3BlbmRpbmdGaW5kTWF0Y2hlcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHRoaXMuX3Jlc3VtZVBhZ2VJZHggPSBudWxsOwogICAgICB0aGlzLl9kaXJ0eU1hdGNoID0gZmFsc2U7CiAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9maW5kVGltZW91dCk7CiAgICAgIHRoaXMuX2ZpbmRUaW1lb3V0ID0gbnVsbDsKICAgICAgdGhpcy5fZmlyc3RQYWdlQ2FwYWJpbGl0eSA9ICgwLCBfcGRmanNMaWIuY3JlYXRlUHJvbWlzZUNhcGFiaWxpdHkpKCk7CiAgICB9CiAgfSwgewogICAga2V5OiAiX3Nob3VsZERpcnR5TWF0Y2giLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9zaG91bGREaXJ0eU1hdGNoKGNtZCwgc3RhdGUpIHsKICAgICAgaWYgKHN0YXRlLnF1ZXJ5ICE9PSB0aGlzLl9zdGF0ZS5xdWVyeSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICBzd2l0Y2ggKGNtZCkgewogICAgICAgIGNhc2UgImZpbmRhZ2FpbiI6CiAgICAgICAgICB2YXIgcGFnZU51bWJlciA9IHRoaXMuX3NlbGVjdGVkLnBhZ2VJZHggKyAxOwogICAgICAgICAgdmFyIGxpbmtTZXJ2aWNlID0gdGhpcy5fbGlua1NlcnZpY2U7CgogICAgICAgICAgaWYgKHBhZ2VOdW1iZXIgPj0gMSAmJiBwYWdlTnVtYmVyIDw9IGxpbmtTZXJ2aWNlLnBhZ2VzQ291bnQgJiYgcGFnZU51bWJlciAhPT0gbGlua1NlcnZpY2UucGFnZSAmJiAhbGlua1NlcnZpY2UuaXNQYWdlVmlzaWJsZShwYWdlTnVtYmVyKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgICAgIGNhc2UgImZpbmRoaWdobGlnaHRhbGxjaGFuZ2UiOgogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfcHJlcGFyZU1hdGNoZXMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9wcmVwYXJlTWF0Y2hlcyhtYXRjaGVzV2l0aExlbmd0aCwgbWF0Y2hlcywgbWF0Y2hlc0xlbmd0aCkgewogICAgICBmdW5jdGlvbiBpc1N1YlRlcm0oY3VycmVudEluZGV4KSB7CiAgICAgICAgdmFyIGN1cnJlbnRFbGVtID0gbWF0Y2hlc1dpdGhMZW5ndGhbY3VycmVudEluZGV4XTsKICAgICAgICB2YXIgbmV4dEVsZW0gPSBtYXRjaGVzV2l0aExlbmd0aFtjdXJyZW50SW5kZXggKyAxXTsKCiAgICAgICAgaWYgKGN1cnJlbnRJbmRleCA8IG1hdGNoZXNXaXRoTGVuZ3RoLmxlbmd0aCAtIDEgJiYgY3VycmVudEVsZW0ubWF0Y2ggPT09IG5leHRFbGVtLm1hdGNoKSB7CiAgICAgICAgICBjdXJyZW50RWxlbS5za2lwcGVkID0gdHJ1ZTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaSA9IGN1cnJlbnRJbmRleCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICB2YXIgcHJldkVsZW0gPSBtYXRjaGVzV2l0aExlbmd0aFtpXTsKCiAgICAgICAgICBpZiAocHJldkVsZW0uc2tpcHBlZCkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAocHJldkVsZW0ubWF0Y2ggKyBwcmV2RWxlbS5tYXRjaExlbmd0aCA8IGN1cnJlbnRFbGVtLm1hdGNoKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChwcmV2RWxlbS5tYXRjaCArIHByZXZFbGVtLm1hdGNoTGVuZ3RoID49IGN1cnJlbnRFbGVtLm1hdGNoICsgY3VycmVudEVsZW0ubWF0Y2hMZW5ndGgpIHsKICAgICAgICAgICAgY3VycmVudEVsZW0uc2tpcHBlZCA9IHRydWU7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICBtYXRjaGVzV2l0aExlbmd0aC5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgcmV0dXJuIGEubWF0Y2ggPT09IGIubWF0Y2ggPyBhLm1hdGNoTGVuZ3RoIC0gYi5tYXRjaExlbmd0aCA6IGEubWF0Y2ggLSBiLm1hdGNoOwogICAgICB9KTsKCiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBtYXRjaGVzV2l0aExlbmd0aC5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgIGlmIChpc1N1YlRlcm0oaSkpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgbWF0Y2hlcy5wdXNoKG1hdGNoZXNXaXRoTGVuZ3RoW2ldLm1hdGNoKTsKICAgICAgICBtYXRjaGVzTGVuZ3RoLnB1c2gobWF0Y2hlc1dpdGhMZW5ndGhbaV0ubWF0Y2hMZW5ndGgpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAiX2lzRW50aXJlV29yZCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2lzRW50aXJlV29yZChjb250ZW50LCBzdGFydElkeCwgbGVuZ3RoKSB7CiAgICAgIGlmIChzdGFydElkeCA+IDApIHsKICAgICAgICB2YXIgZmlyc3QgPSBjb250ZW50LmNoYXJDb2RlQXQoc3RhcnRJZHgpOwogICAgICAgIHZhciBsaW1pdCA9IGNvbnRlbnQuY2hhckNvZGVBdChzdGFydElkeCAtIDEpOwoKICAgICAgICBpZiAoKDAsIF9wZGZfZmluZF91dGlscy5nZXRDaGFyYWN0ZXJUeXBlKShmaXJzdCkgPT09ICgwLCBfcGRmX2ZpbmRfdXRpbHMuZ2V0Q2hhcmFjdGVyVHlwZSkobGltaXQpKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CgogICAgICB2YXIgZW5kSWR4ID0gc3RhcnRJZHggKyBsZW5ndGggLSAxOwoKICAgICAgaWYgKGVuZElkeCA8IGNvbnRlbnQubGVuZ3RoIC0gMSkgewogICAgICAgIHZhciBsYXN0ID0gY29udGVudC5jaGFyQ29kZUF0KGVuZElkeCk7CgogICAgICAgIHZhciBfbGltaXQgPSBjb250ZW50LmNoYXJDb2RlQXQoZW5kSWR4ICsgMSk7CgogICAgICAgIGlmICgoMCwgX3BkZl9maW5kX3V0aWxzLmdldENoYXJhY3RlclR5cGUpKGxhc3QpID09PSAoMCwgX3BkZl9maW5kX3V0aWxzLmdldENoYXJhY3RlclR5cGUpKF9saW1pdCkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0sIHsKICAgIGtleTogIl9jYWxjdWxhdGVQaHJhc2VNYXRjaCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2NhbGN1bGF0ZVBocmFzZU1hdGNoKHF1ZXJ5LCBwYWdlSW5kZXgsIHBhZ2VDb250ZW50LCBlbnRpcmVXb3JkKSB7CiAgICAgIHZhciBtYXRjaGVzID0gW107CiAgICAgIHZhciBxdWVyeUxlbiA9IHF1ZXJ5Lmxlbmd0aDsKICAgICAgdmFyIG1hdGNoSWR4ID0gLXF1ZXJ5TGVuOwoKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBtYXRjaElkeCA9IHBhZ2VDb250ZW50LmluZGV4T2YocXVlcnksIG1hdGNoSWR4ICsgcXVlcnlMZW4pOwoKICAgICAgICBpZiAobWF0Y2hJZHggPT09IC0xKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIGlmIChlbnRpcmVXb3JkICYmICF0aGlzLl9pc0VudGlyZVdvcmQocGFnZUNvbnRlbnQsIG1hdGNoSWR4LCBxdWVyeUxlbikpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgbWF0Y2hlcy5wdXNoKG1hdGNoSWR4KTsKICAgICAgfQoKICAgICAgdGhpcy5fcGFnZU1hdGNoZXNbcGFnZUluZGV4XSA9IG1hdGNoZXM7CiAgICB9CiAgfSwgewogICAga2V5OiAiX2NhbGN1bGF0ZVdvcmRNYXRjaCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2NhbGN1bGF0ZVdvcmRNYXRjaChxdWVyeSwgcGFnZUluZGV4LCBwYWdlQ29udGVudCwgZW50aXJlV29yZCkgewogICAgICB2YXIgbWF0Y2hlc1dpdGhMZW5ndGggPSBbXTsKICAgICAgdmFyIHF1ZXJ5QXJyYXkgPSBxdWVyeS5tYXRjaCgvXFMrL2cpOwoKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHF1ZXJ5QXJyYXkubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICB2YXIgc3VicXVlcnkgPSBxdWVyeUFycmF5W2ldOwogICAgICAgIHZhciBzdWJxdWVyeUxlbiA9IHN1YnF1ZXJ5Lmxlbmd0aDsKICAgICAgICB2YXIgbWF0Y2hJZHggPSAtc3VicXVlcnlMZW47CgogICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICBtYXRjaElkeCA9IHBhZ2VDb250ZW50LmluZGV4T2Yoc3VicXVlcnksIG1hdGNoSWR4ICsgc3VicXVlcnlMZW4pOwoKICAgICAgICAgIGlmIChtYXRjaElkeCA9PT0gLTEpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGVudGlyZVdvcmQgJiYgIXRoaXMuX2lzRW50aXJlV29yZChwYWdlQ29udGVudCwgbWF0Y2hJZHgsIHN1YnF1ZXJ5TGVuKSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBtYXRjaGVzV2l0aExlbmd0aC5wdXNoKHsKICAgICAgICAgICAgbWF0Y2g6IG1hdGNoSWR4LAogICAgICAgICAgICBtYXRjaExlbmd0aDogc3VicXVlcnlMZW4sCiAgICAgICAgICAgIHNraXBwZWQ6IGZhbHNlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuX3BhZ2VNYXRjaGVzTGVuZ3RoW3BhZ2VJbmRleF0gPSBbXTsKICAgICAgdGhpcy5fcGFnZU1hdGNoZXNbcGFnZUluZGV4XSA9IFtdOwoKICAgICAgdGhpcy5fcHJlcGFyZU1hdGNoZXMobWF0Y2hlc1dpdGhMZW5ndGgsIHRoaXMuX3BhZ2VNYXRjaGVzW3BhZ2VJbmRleF0sIHRoaXMuX3BhZ2VNYXRjaGVzTGVuZ3RoW3BhZ2VJbmRleF0pOwogICAgfQogIH0sIHsKICAgIGtleTogIl9jYWxjdWxhdGVNYXRjaCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2NhbGN1bGF0ZU1hdGNoKHBhZ2VJbmRleCkgewogICAgICB2YXIgcGFnZUNvbnRlbnQgPSB0aGlzLl9wYWdlQ29udGVudHNbcGFnZUluZGV4XTsKICAgICAgdmFyIHF1ZXJ5ID0gdGhpcy5fcXVlcnk7CiAgICAgIHZhciBfdGhpcyRfc3RhdGUgPSB0aGlzLl9zdGF0ZSwKICAgICAgICAgIGNhc2VTZW5zaXRpdmUgPSBfdGhpcyRfc3RhdGUuY2FzZVNlbnNpdGl2ZSwKICAgICAgICAgIGVudGlyZVdvcmQgPSBfdGhpcyRfc3RhdGUuZW50aXJlV29yZCwKICAgICAgICAgIHBocmFzZVNlYXJjaCA9IF90aGlzJF9zdGF0ZS5waHJhc2VTZWFyY2g7CgogICAgICBpZiAocXVlcnkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoIWNhc2VTZW5zaXRpdmUpIHsKICAgICAgICBwYWdlQ29udGVudCA9IHBhZ2VDb250ZW50LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgcXVlcnkgPSBxdWVyeS50b0xvd2VyQ2FzZSgpOwogICAgICB9CgogICAgICBpZiAocGhyYXNlU2VhcmNoKSB7CiAgICAgICAgdGhpcy5fY2FsY3VsYXRlUGhyYXNlTWF0Y2gocXVlcnksIHBhZ2VJbmRleCwgcGFnZUNvbnRlbnQsIGVudGlyZVdvcmQpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX2NhbGN1bGF0ZVdvcmRNYXRjaChxdWVyeSwgcGFnZUluZGV4LCBwYWdlQ29udGVudCwgZW50aXJlV29yZCk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9zdGF0ZS5oaWdobGlnaHRBbGwpIHsKICAgICAgICB0aGlzLl91cGRhdGVQYWdlKHBhZ2VJbmRleCk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9yZXN1bWVQYWdlSWR4ID09PSBwYWdlSW5kZXgpIHsKICAgICAgICB0aGlzLl9yZXN1bWVQYWdlSWR4ID0gbnVsbDsKCiAgICAgICAgdGhpcy5fbmV4dFBhZ2VNYXRjaCgpOwogICAgICB9CgogICAgICB2YXIgcGFnZU1hdGNoZXNDb3VudCA9IHRoaXMuX3BhZ2VNYXRjaGVzW3BhZ2VJbmRleF0ubGVuZ3RoOwoKICAgICAgaWYgKHBhZ2VNYXRjaGVzQ291bnQgPiAwKSB7CiAgICAgICAgdGhpcy5fbWF0Y2hlc0NvdW50VG90YWwgKz0gcGFnZU1hdGNoZXNDb3VudDsKCiAgICAgICAgdGhpcy5fdXBkYXRlVUlSZXN1bHRzQ291bnQoKTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogIl9leHRyYWN0VGV4dCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2V4dHJhY3RUZXh0KCkgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIGlmICh0aGlzLl9leHRyYWN0VGV4dFByb21pc2VzLmxlbmd0aCA+IDApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBwcm9taXNlID0gUHJvbWlzZS5yZXNvbHZlKCk7CgogICAgICB2YXIgX2xvb3AgPSBmdW5jdGlvbiBfbG9vcChpLCBpaSkgewogICAgICAgIHZhciBleHRyYWN0VGV4dENhcGFiaWxpdHkgPSAoMCwgX3BkZmpzTGliLmNyZWF0ZVByb21pc2VDYXBhYmlsaXR5KSgpOwogICAgICAgIF90aGlzMi5fZXh0cmFjdFRleHRQcm9taXNlc1tpXSA9IGV4dHJhY3RUZXh0Q2FwYWJpbGl0eS5wcm9taXNlOwogICAgICAgIHByb21pc2UgPSBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIF90aGlzMi5fcGRmRG9jdW1lbnQuZ2V0UGFnZShpICsgMSkudGhlbihmdW5jdGlvbiAocGRmUGFnZSkgewogICAgICAgICAgICByZXR1cm4gcGRmUGFnZS5nZXRUZXh0Q29udGVudCh7CiAgICAgICAgICAgICAgbm9ybWFsaXplV2hpdGVzcGFjZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKHRleHRDb250ZW50KSB7CiAgICAgICAgICAgIHZhciB0ZXh0SXRlbXMgPSB0ZXh0Q29udGVudC5pdGVtczsKICAgICAgICAgICAgdmFyIHN0ckJ1ZiA9IFtdOwoKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGpqID0gdGV4dEl0ZW1zLmxlbmd0aDsgaiA8IGpqOyBqKyspIHsKICAgICAgICAgICAgICBzdHJCdWYucHVzaCh0ZXh0SXRlbXNbal0uc3RyKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX3RoaXMyLl9wYWdlQ29udGVudHNbaV0gPSBub3JtYWxpemUoc3RyQnVmLmpvaW4oIiIpKTsKICAgICAgICAgICAgZXh0cmFjdFRleHRDYXBhYmlsaXR5LnJlc29sdmUoaSk7CiAgICAgICAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIlVuYWJsZSB0byBnZXQgdGV4dCBjb250ZW50IGZvciBwYWdlICIuY29uY2F0KGkgKyAxKSwgcmVhc29uKTsKICAgICAgICAgICAgX3RoaXMyLl9wYWdlQ29udGVudHNbaV0gPSAiIjsKICAgICAgICAgICAgZXh0cmFjdFRleHRDYXBhYmlsaXR5LnJlc29sdmUoaSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfTsKCiAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IHRoaXMuX2xpbmtTZXJ2aWNlLnBhZ2VzQ291bnQ7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgX2xvb3AoaSwgaWkpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAiX3VwZGF0ZVBhZ2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF91cGRhdGVQYWdlKGluZGV4KSB7CiAgICAgIGlmICh0aGlzLl9zY3JvbGxNYXRjaGVzICYmIHRoaXMuX3NlbGVjdGVkLnBhZ2VJZHggPT09IGluZGV4KSB7CiAgICAgICAgdGhpcy5fbGlua1NlcnZpY2UucGFnZSA9IGluZGV4ICsgMTsKICAgICAgfQoKICAgICAgdGhpcy5fZXZlbnRCdXMuZGlzcGF0Y2goInVwZGF0ZXRleHRsYXllcm1hdGNoZXMiLCB7CiAgICAgICAgc291cmNlOiB0aGlzLAogICAgICAgIHBhZ2VJbmRleDogaW5kZXgKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiX3VwZGF0ZUFsbFBhZ2VzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfdXBkYXRlQWxsUGFnZXMoKSB7CiAgICAgIHRoaXMuX2V2ZW50QnVzLmRpc3BhdGNoKCJ1cGRhdGV0ZXh0bGF5ZXJtYXRjaGVzIiwgewogICAgICAgIHNvdXJjZTogdGhpcywKICAgICAgICBwYWdlSW5kZXg6IC0xCiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogIl9uZXh0TWF0Y2giLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9uZXh0TWF0Y2goKSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgdmFyIHByZXZpb3VzID0gdGhpcy5fc3RhdGUuZmluZFByZXZpb3VzOwogICAgICB2YXIgY3VycmVudFBhZ2VJbmRleCA9IHRoaXMuX2xpbmtTZXJ2aWNlLnBhZ2UgLSAxOwogICAgICB2YXIgbnVtUGFnZXMgPSB0aGlzLl9saW5rU2VydmljZS5wYWdlc0NvdW50OwogICAgICB0aGlzLl9oaWdobGlnaHRNYXRjaGVzID0gdHJ1ZTsKCiAgICAgIGlmICh0aGlzLl9kaXJ0eU1hdGNoKSB7CiAgICAgICAgdGhpcy5fZGlydHlNYXRjaCA9IGZhbHNlOwogICAgICAgIHRoaXMuX3NlbGVjdGVkLnBhZ2VJZHggPSB0aGlzLl9zZWxlY3RlZC5tYXRjaElkeCA9IC0xOwogICAgICAgIHRoaXMuX29mZnNldC5wYWdlSWR4ID0gY3VycmVudFBhZ2VJbmRleDsKICAgICAgICB0aGlzLl9vZmZzZXQubWF0Y2hJZHggPSBudWxsOwogICAgICAgIHRoaXMuX29mZnNldC53cmFwcGVkID0gZmFsc2U7CiAgICAgICAgdGhpcy5fcmVzdW1lUGFnZUlkeCA9IG51bGw7CiAgICAgICAgdGhpcy5fcGFnZU1hdGNoZXMubGVuZ3RoID0gMDsKICAgICAgICB0aGlzLl9wYWdlTWF0Y2hlc0xlbmd0aC5sZW5ndGggPSAwOwogICAgICAgIHRoaXMuX21hdGNoZXNDb3VudFRvdGFsID0gMDsKCiAgICAgICAgdGhpcy5fdXBkYXRlQWxsUGFnZXMoKTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBudW1QYWdlczsgaSsrKSB7CiAgICAgICAgICBpZiAodGhpcy5fcGVuZGluZ0ZpbmRNYXRjaGVzW2ldID09PSB0cnVlKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQoKICAgICAgICAgIHRoaXMuX3BlbmRpbmdGaW5kTWF0Y2hlc1tpXSA9IHRydWU7CgogICAgICAgICAgdGhpcy5fZXh0cmFjdFRleHRQcm9taXNlc1tpXS50aGVuKGZ1bmN0aW9uIChwYWdlSWR4KSB7CiAgICAgICAgICAgIGRlbGV0ZSBfdGhpczMuX3BlbmRpbmdGaW5kTWF0Y2hlc1twYWdlSWR4XTsKCiAgICAgICAgICAgIF90aGlzMy5fY2FsY3VsYXRlTWF0Y2gocGFnZUlkeCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9xdWVyeSA9PT0gIiIpIHsKICAgICAgICB0aGlzLl91cGRhdGVVSVN0YXRlKEZpbmRTdGF0ZS5GT1VORCk7CgogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuX3Jlc3VtZVBhZ2VJZHgpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBvZmZzZXQgPSB0aGlzLl9vZmZzZXQ7CiAgICAgIHRoaXMuX3BhZ2VzVG9TZWFyY2ggPSBudW1QYWdlczsKCiAgICAgIGlmIChvZmZzZXQubWF0Y2hJZHggIT09IG51bGwpIHsKICAgICAgICB2YXIgbnVtUGFnZU1hdGNoZXMgPSB0aGlzLl9wYWdlTWF0Y2hlc1tvZmZzZXQucGFnZUlkeF0ubGVuZ3RoOwoKICAgICAgICBpZiAoIXByZXZpb3VzICYmIG9mZnNldC5tYXRjaElkeCArIDEgPCBudW1QYWdlTWF0Y2hlcyB8fCBwcmV2aW91cyAmJiBvZmZzZXQubWF0Y2hJZHggPiAwKSB7CiAgICAgICAgICBvZmZzZXQubWF0Y2hJZHggPSBwcmV2aW91cyA/IG9mZnNldC5tYXRjaElkeCAtIDEgOiBvZmZzZXQubWF0Y2hJZHggKyAxOwoKICAgICAgICAgIHRoaXMuX3VwZGF0ZU1hdGNoKHRydWUpOwoKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRoaXMuX2FkdmFuY2VPZmZzZXRQYWdlKHByZXZpb3VzKTsKICAgICAgfQoKICAgICAgdGhpcy5fbmV4dFBhZ2VNYXRjaCgpOwogICAgfQogIH0sIHsKICAgIGtleTogIl9tYXRjaGVzUmVhZHkiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9tYXRjaGVzUmVhZHkobWF0Y2hlcykgewogICAgICB2YXIgb2Zmc2V0ID0gdGhpcy5fb2Zmc2V0OwogICAgICB2YXIgbnVtTWF0Y2hlcyA9IG1hdGNoZXMubGVuZ3RoOwogICAgICB2YXIgcHJldmlvdXMgPSB0aGlzLl9zdGF0ZS5maW5kUHJldmlvdXM7CgogICAgICBpZiAobnVtTWF0Y2hlcykgewogICAgICAgIG9mZnNldC5tYXRjaElkeCA9IHByZXZpb3VzID8gbnVtTWF0Y2hlcyAtIDEgOiAwOwoKICAgICAgICB0aGlzLl91cGRhdGVNYXRjaCh0cnVlKTsKCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KCiAgICAgIHRoaXMuX2FkdmFuY2VPZmZzZXRQYWdlKHByZXZpb3VzKTsKCiAgICAgIGlmIChvZmZzZXQud3JhcHBlZCkgewogICAgICAgIG9mZnNldC5tYXRjaElkeCA9IG51bGw7CgogICAgICAgIGlmICh0aGlzLl9wYWdlc1RvU2VhcmNoIDwgMCkgewogICAgICAgICAgdGhpcy5fdXBkYXRlTWF0Y2goZmFsc2UpOwoKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0sIHsKICAgIGtleTogIl9uZXh0UGFnZU1hdGNoIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfbmV4dFBhZ2VNYXRjaCgpIHsKICAgICAgaWYgKHRoaXMuX3Jlc3VtZVBhZ2VJZHggIT09IG51bGwpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJUaGVyZSBjYW4gb25seSBiZSBvbmUgcGVuZGluZyBwYWdlLiIpOwogICAgICB9CgogICAgICB2YXIgbWF0Y2hlcyA9IG51bGw7CgogICAgICBkbyB7CiAgICAgICAgdmFyIHBhZ2VJZHggPSB0aGlzLl9vZmZzZXQucGFnZUlkeDsKICAgICAgICBtYXRjaGVzID0gdGhpcy5fcGFnZU1hdGNoZXNbcGFnZUlkeF07CgogICAgICAgIGlmICghbWF0Y2hlcykgewogICAgICAgICAgdGhpcy5fcmVzdW1lUGFnZUlkeCA9IHBhZ2VJZHg7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0gd2hpbGUgKCF0aGlzLl9tYXRjaGVzUmVhZHkobWF0Y2hlcykpOwogICAgfQogIH0sIHsKICAgIGtleTogIl9hZHZhbmNlT2Zmc2V0UGFnZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2FkdmFuY2VPZmZzZXRQYWdlKHByZXZpb3VzKSB7CiAgICAgIHZhciBvZmZzZXQgPSB0aGlzLl9vZmZzZXQ7CiAgICAgIHZhciBudW1QYWdlcyA9IHRoaXMuX2xpbmtTZXJ2aWNlLnBhZ2VzQ291bnQ7CiAgICAgIG9mZnNldC5wYWdlSWR4ID0gcHJldmlvdXMgPyBvZmZzZXQucGFnZUlkeCAtIDEgOiBvZmZzZXQucGFnZUlkeCArIDE7CiAgICAgIG9mZnNldC5tYXRjaElkeCA9IG51bGw7CiAgICAgIHRoaXMuX3BhZ2VzVG9TZWFyY2gtLTsKCiAgICAgIGlmIChvZmZzZXQucGFnZUlkeCA+PSBudW1QYWdlcyB8fCBvZmZzZXQucGFnZUlkeCA8IDApIHsKICAgICAgICBvZmZzZXQucGFnZUlkeCA9IHByZXZpb3VzID8gbnVtUGFnZXMgLSAxIDogMDsKICAgICAgICBvZmZzZXQud3JhcHBlZCA9IHRydWU7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJfdXBkYXRlTWF0Y2giLAogICAgdmFsdWU6IGZ1bmN0aW9uIF91cGRhdGVNYXRjaCgpIHsKICAgICAgdmFyIGZvdW5kID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiBmYWxzZTsKICAgICAgdmFyIHN0YXRlID0gRmluZFN0YXRlLk5PVF9GT1VORDsKICAgICAgdmFyIHdyYXBwZWQgPSB0aGlzLl9vZmZzZXQud3JhcHBlZDsKICAgICAgdGhpcy5fb2Zmc2V0LndyYXBwZWQgPSBmYWxzZTsKCiAgICAgIGlmIChmb3VuZCkgewogICAgICAgIHZhciBwcmV2aW91c1BhZ2UgPSB0aGlzLl9zZWxlY3RlZC5wYWdlSWR4OwogICAgICAgIHRoaXMuX3NlbGVjdGVkLnBhZ2VJZHggPSB0aGlzLl9vZmZzZXQucGFnZUlkeDsKICAgICAgICB0aGlzLl9zZWxlY3RlZC5tYXRjaElkeCA9IHRoaXMuX29mZnNldC5tYXRjaElkeDsKICAgICAgICBzdGF0ZSA9IHdyYXBwZWQgPyBGaW5kU3RhdGUuV1JBUFBFRCA6IEZpbmRTdGF0ZS5GT1VORDsKCiAgICAgICAgaWYgKHByZXZpb3VzUGFnZSAhPT0gLTEgJiYgcHJldmlvdXNQYWdlICE9PSB0aGlzLl9zZWxlY3RlZC5wYWdlSWR4KSB7CiAgICAgICAgICB0aGlzLl91cGRhdGVQYWdlKHByZXZpb3VzUGFnZSk7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLl91cGRhdGVVSVN0YXRlKHN0YXRlLCB0aGlzLl9zdGF0ZS5maW5kUHJldmlvdXMpOwoKICAgICAgaWYgKHRoaXMuX3NlbGVjdGVkLnBhZ2VJZHggIT09IC0xKSB7CiAgICAgICAgdGhpcy5fc2Nyb2xsTWF0Y2hlcyA9IHRydWU7CgogICAgICAgIHRoaXMuX3VwZGF0ZVBhZ2UodGhpcy5fc2VsZWN0ZWQucGFnZUlkeCk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJfb25GaW5kQmFyQ2xvc2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vbkZpbmRCYXJDbG9zZShldnQpIHsKICAgICAgdmFyIF90aGlzNCA9IHRoaXM7CgogICAgICB2YXIgcGRmRG9jdW1lbnQgPSB0aGlzLl9wZGZEb2N1bWVudDsKCiAgICAgIHRoaXMuX2ZpcnN0UGFnZUNhcGFiaWxpdHkucHJvbWlzZS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoIV90aGlzNC5fcGRmRG9jdW1lbnQgfHwgcGRmRG9jdW1lbnQgJiYgX3RoaXM0Ll9wZGZEb2N1bWVudCAhPT0gcGRmRG9jdW1lbnQpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmIChfdGhpczQuX2ZpbmRUaW1lb3V0KSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQoX3RoaXM0Ll9maW5kVGltZW91dCk7CiAgICAgICAgICBfdGhpczQuX2ZpbmRUaW1lb3V0ID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmIChfdGhpczQuX3Jlc3VtZVBhZ2VJZHgpIHsKICAgICAgICAgIF90aGlzNC5fcmVzdW1lUGFnZUlkeCA9IG51bGw7CiAgICAgICAgICBfdGhpczQuX2RpcnR5TWF0Y2ggPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgX3RoaXM0Ll91cGRhdGVVSVN0YXRlKEZpbmRTdGF0ZS5GT1VORCk7CgogICAgICAgIF90aGlzNC5faGlnaGxpZ2h0TWF0Y2hlcyA9IGZhbHNlOwoKICAgICAgICBfdGhpczQuX3VwZGF0ZUFsbFBhZ2VzKCk7CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogIl9yZXF1ZXN0TWF0Y2hlc0NvdW50IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfcmVxdWVzdE1hdGNoZXNDb3VudCgpIHsKICAgICAgdmFyIF90aGlzJF9zZWxlY3RlZCA9IHRoaXMuX3NlbGVjdGVkLAogICAgICAgICAgcGFnZUlkeCA9IF90aGlzJF9zZWxlY3RlZC5wYWdlSWR4LAogICAgICAgICAgbWF0Y2hJZHggPSBfdGhpcyRfc2VsZWN0ZWQubWF0Y2hJZHg7CiAgICAgIHZhciBjdXJyZW50ID0gMCwKICAgICAgICAgIHRvdGFsID0gdGhpcy5fbWF0Y2hlc0NvdW50VG90YWw7CgogICAgICBpZiAobWF0Y2hJZHggIT09IC0xKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYWdlSWR4OyBpKyspIHsKICAgICAgICAgIGN1cnJlbnQgKz0gdGhpcy5fcGFnZU1hdGNoZXNbaV0gJiYgdGhpcy5fcGFnZU1hdGNoZXNbaV0ubGVuZ3RoIHx8IDA7CiAgICAgICAgfQoKICAgICAgICBjdXJyZW50ICs9IG1hdGNoSWR4ICsgMTsKICAgICAgfQoKICAgICAgaWYgKGN1cnJlbnQgPCAxIHx8IGN1cnJlbnQgPiB0b3RhbCkgewogICAgICAgIGN1cnJlbnQgPSB0b3RhbCA9IDA7CiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAgY3VycmVudDogY3VycmVudCwKICAgICAgICB0b3RhbDogdG90YWwKICAgICAgfTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfdXBkYXRlVUlSZXN1bHRzQ291bnQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF91cGRhdGVVSVJlc3VsdHNDb3VudCgpIHsKICAgICAgdGhpcy5fZXZlbnRCdXMuZGlzcGF0Y2goInVwZGF0ZWZpbmRtYXRjaGVzY291bnQiLCB7CiAgICAgICAgc291cmNlOiB0aGlzLAogICAgICAgIG1hdGNoZXNDb3VudDogdGhpcy5fcmVxdWVzdE1hdGNoZXNDb3VudCgpCiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogIl91cGRhdGVVSVN0YXRlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfdXBkYXRlVUlTdGF0ZShzdGF0ZSwgcHJldmlvdXMpIHsKICAgICAgdGhpcy5fZXZlbnRCdXMuZGlzcGF0Y2goInVwZGF0ZWZpbmRjb250cm9sc3RhdGUiLCB7CiAgICAgICAgc291cmNlOiB0aGlzLAogICAgICAgIHN0YXRlOiBzdGF0ZSwKICAgICAgICBwcmV2aW91czogcHJldmlvdXMsCiAgICAgICAgbWF0Y2hlc0NvdW50OiB0aGlzLl9yZXF1ZXN0TWF0Y2hlc0NvdW50KCkKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiaGlnaGxpZ2h0TWF0Y2hlcyIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX2hpZ2hsaWdodE1hdGNoZXM7CiAgICB9CiAgfSwgewogICAga2V5OiAicGFnZU1hdGNoZXMiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9wYWdlTWF0Y2hlczsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJwYWdlTWF0Y2hlc0xlbmd0aCIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3BhZ2VNYXRjaGVzTGVuZ3RoOwogICAgfQogIH0sIHsKICAgIGtleTogInNlbGVjdGVkIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fc2VsZWN0ZWQ7CiAgICB9CiAgfSwgewogICAga2V5OiAic3RhdGUiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zdGF0ZTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfcXVlcnkiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIGlmICh0aGlzLl9zdGF0ZS5xdWVyeSAhPT0gdGhpcy5fcmF3UXVlcnkpIHsKICAgICAgICB0aGlzLl9yYXdRdWVyeSA9IHRoaXMuX3N0YXRlLnF1ZXJ5OwogICAgICAgIHRoaXMuX25vcm1hbGl6ZWRRdWVyeSA9IG5vcm1hbGl6ZSh0aGlzLl9zdGF0ZS5xdWVyeSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLl9ub3JtYWxpemVkUXVlcnk7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gUERGRmluZENvbnRyb2xsZXI7Cn0oKTsKCmV4cG9ydHMuUERGRmluZENvbnRyb2xsZXIgPSBQREZGaW5kQ29udHJvbGxlcjsKCi8qKiovIH0pLAovKiAxOSAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoidXNlIHN0cmljdCI7CgoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLmdldENoYXJhY3RlclR5cGUgPSBnZXRDaGFyYWN0ZXJUeXBlOwpleHBvcnRzLkNoYXJhY3RlclR5cGUgPSB2b2lkIDA7CnZhciBDaGFyYWN0ZXJUeXBlID0gewogIFNQQUNFOiAwLAogIEFMUEhBX0xFVFRFUjogMSwKICBQVU5DVDogMiwKICBIQU5fTEVUVEVSOiAzLAogIEtBVEFLQU5BX0xFVFRFUjogNCwKICBISVJBR0FOQV9MRVRURVI6IDUsCiAgSEFMRldJRFRIX0tBVEFLQU5BX0xFVFRFUjogNiwKICBUSEFJX0xFVFRFUjogNwp9OwpleHBvcnRzLkNoYXJhY3RlclR5cGUgPSBDaGFyYWN0ZXJUeXBlOwoKZnVuY3Rpb24gaXNBbHBoYWJldGljYWxTY3JpcHQoY2hhckNvZGUpIHsKICByZXR1cm4gY2hhckNvZGUgPCAweDJlODA7Cn0KCmZ1bmN0aW9uIGlzQXNjaWkoY2hhckNvZGUpIHsKICByZXR1cm4gKGNoYXJDb2RlICYgMHhmZjgwKSA9PT0gMDsKfQoKZnVuY3Rpb24gaXNBc2NpaUFscGhhKGNoYXJDb2RlKSB7CiAgcmV0dXJuIGNoYXJDb2RlID49IDB4NjEgJiYgY2hhckNvZGUgPD0gMHg3YSB8fCBjaGFyQ29kZSA+PSAweDQxICYmIGNoYXJDb2RlIDw9IDB4NWE7Cn0KCmZ1bmN0aW9uIGlzQXNjaWlEaWdpdChjaGFyQ29kZSkgewogIHJldHVybiBjaGFyQ29kZSA+PSAweDMwICYmIGNoYXJDb2RlIDw9IDB4Mzk7Cn0KCmZ1bmN0aW9uIGlzQXNjaWlTcGFjZShjaGFyQ29kZSkgewogIHJldHVybiBjaGFyQ29kZSA9PT0gMHgyMCB8fCBjaGFyQ29kZSA9PT0gMHgwOSB8fCBjaGFyQ29kZSA9PT0gMHgwZCB8fCBjaGFyQ29kZSA9PT0gMHgwYTsKfQoKZnVuY3Rpb24gaXNIYW4oY2hhckNvZGUpIHsKICByZXR1cm4gY2hhckNvZGUgPj0gMHgzNDAwICYmIGNoYXJDb2RlIDw9IDB4OWZmZiB8fCBjaGFyQ29kZSA+PSAweGY5MDAgJiYgY2hhckNvZGUgPD0gMHhmYWZmOwp9CgpmdW5jdGlvbiBpc0thdGFrYW5hKGNoYXJDb2RlKSB7CiAgcmV0dXJuIGNoYXJDb2RlID49IDB4MzBhMCAmJiBjaGFyQ29kZSA8PSAweDMwZmY7Cn0KCmZ1bmN0aW9uIGlzSGlyYWdhbmEoY2hhckNvZGUpIHsKICByZXR1cm4gY2hhckNvZGUgPj0gMHgzMDQwICYmIGNoYXJDb2RlIDw9IDB4MzA5ZjsKfQoKZnVuY3Rpb24gaXNIYWxmd2lkdGhLYXRha2FuYShjaGFyQ29kZSkgewogIHJldHVybiBjaGFyQ29kZSA+PSAweGZmNjAgJiYgY2hhckNvZGUgPD0gMHhmZjlmOwp9CgpmdW5jdGlvbiBpc1RoYWkoY2hhckNvZGUpIHsKICByZXR1cm4gKGNoYXJDb2RlICYgMHhmZjgwKSA9PT0gMHgwZTAwOwp9CgpmdW5jdGlvbiBnZXRDaGFyYWN0ZXJUeXBlKGNoYXJDb2RlKSB7CiAgaWYgKGlzQWxwaGFiZXRpY2FsU2NyaXB0KGNoYXJDb2RlKSkgewogICAgaWYgKGlzQXNjaWkoY2hhckNvZGUpKSB7CiAgICAgIGlmIChpc0FzY2lpU3BhY2UoY2hhckNvZGUpKSB7CiAgICAgICAgcmV0dXJuIENoYXJhY3RlclR5cGUuU1BBQ0U7CiAgICAgIH0gZWxzZSBpZiAoaXNBc2NpaUFscGhhKGNoYXJDb2RlKSB8fCBpc0FzY2lpRGlnaXQoY2hhckNvZGUpIHx8IGNoYXJDb2RlID09PSAweDVmKSB7CiAgICAgICAgcmV0dXJuIENoYXJhY3RlclR5cGUuQUxQSEFfTEVUVEVSOwogICAgICB9CgogICAgICByZXR1cm4gQ2hhcmFjdGVyVHlwZS5QVU5DVDsKICAgIH0gZWxzZSBpZiAoaXNUaGFpKGNoYXJDb2RlKSkgewogICAgICByZXR1cm4gQ2hhcmFjdGVyVHlwZS5USEFJX0xFVFRFUjsKICAgIH0gZWxzZSBpZiAoY2hhckNvZGUgPT09IDB4YTApIHsKICAgICAgcmV0dXJuIENoYXJhY3RlclR5cGUuU1BBQ0U7CiAgICB9CgogICAgcmV0dXJuIENoYXJhY3RlclR5cGUuQUxQSEFfTEVUVEVSOwogIH0KCiAgaWYgKGlzSGFuKGNoYXJDb2RlKSkgewogICAgcmV0dXJuIENoYXJhY3RlclR5cGUuSEFOX0xFVFRFUjsKICB9IGVsc2UgaWYgKGlzS2F0YWthbmEoY2hhckNvZGUpKSB7CiAgICByZXR1cm4gQ2hhcmFjdGVyVHlwZS5LQVRBS0FOQV9MRVRURVI7CiAgfSBlbHNlIGlmIChpc0hpcmFnYW5hKGNoYXJDb2RlKSkgewogICAgcmV0dXJuIENoYXJhY3RlclR5cGUuSElSQUdBTkFfTEVUVEVSOwogIH0gZWxzZSBpZiAoaXNIYWxmd2lkdGhLYXRha2FuYShjaGFyQ29kZSkpIHsKICAgIHJldHVybiBDaGFyYWN0ZXJUeXBlLkhBTEZXSURUSF9LQVRBS0FOQV9MRVRURVI7CiAgfQoKICByZXR1cm4gQ2hhcmFjdGVyVHlwZS5BTFBIQV9MRVRURVI7Cn0KCi8qKiovIH0pLAovKiAyMCAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoidXNlIHN0cmljdCI7CgoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLmlzRGVzdEhhc2hlc0VxdWFsID0gaXNEZXN0SGFzaGVzRXF1YWw7CmV4cG9ydHMuaXNEZXN0QXJyYXlzRXF1YWwgPSBpc0Rlc3RBcnJheXNFcXVhbDsKZXhwb3J0cy5QREZIaXN0b3J5ID0gdm9pZCAwOwoKdmFyIF91aV91dGlscyA9IF9fd2VicGFja19yZXF1aXJlX18oNSk7CgpmdW5jdGlvbiBfdHlwZW9mKG9iaikgeyAiQGJhYmVsL2hlbHBlcnMgLSB0eXBlb2YiOyBpZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgU3ltYm9sLml0ZXJhdG9yID09PSAic3ltYm9sIikgeyBfdHlwZW9mID0gZnVuY3Rpb24gX3R5cGVvZihvYmopIHsgcmV0dXJuIHR5cGVvZiBvYmo7IH07IH0gZWxzZSB7IF90eXBlb2YgPSBmdW5jdGlvbiBfdHlwZW9mKG9iaikgeyByZXR1cm4gb2JqICYmIHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgb2JqLmNvbnN0cnVjdG9yID09PSBTeW1ib2wgJiYgb2JqICE9PSBTeW1ib2wucHJvdG90eXBlID8gInN5bWJvbCIgOiB0eXBlb2Ygb2JqOyB9OyB9IHJldHVybiBfdHlwZW9mKG9iaik7IH0KCmZ1bmN0aW9uIF9zbGljZWRUb0FycmF5KGFyciwgaSkgeyByZXR1cm4gX2FycmF5V2l0aEhvbGVzKGFycikgfHwgX2l0ZXJhYmxlVG9BcnJheUxpbWl0KGFyciwgaSkgfHwgX3Vuc3VwcG9ydGVkSXRlcmFibGVUb0FycmF5KGFyciwgaSkgfHwgX25vbkl0ZXJhYmxlUmVzdCgpOyB9CgpmdW5jdGlvbiBfbm9uSXRlcmFibGVSZXN0KCkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJJbnZhbGlkIGF0dGVtcHQgdG8gZGVzdHJ1Y3R1cmUgbm9uLWl0ZXJhYmxlIGluc3RhbmNlLlxuSW4gb3JkZXIgdG8gYmUgaXRlcmFibGUsIG5vbi1hcnJheSBvYmplY3RzIG11c3QgaGF2ZSBhIFtTeW1ib2wuaXRlcmF0b3JdKCkgbWV0aG9kLiIpOyB9CgpmdW5jdGlvbiBfdW5zdXBwb3J0ZWRJdGVyYWJsZVRvQXJyYXkobywgbWluTGVuKSB7IGlmICghbykgcmV0dXJuOyBpZiAodHlwZW9mIG8gPT09ICJzdHJpbmciKSByZXR1cm4gX2FycmF5TGlrZVRvQXJyYXkobywgbWluTGVuKTsgdmFyIG4gPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwobykuc2xpY2UoOCwgLTEpOyBpZiAobiA9PT0gIk9iamVjdCIgJiYgby5jb25zdHJ1Y3RvcikgbiA9IG8uY29uc3RydWN0b3IubmFtZTsgaWYgKG4gPT09ICJNYXAiIHx8IG4gPT09ICJTZXQiKSByZXR1cm4gQXJyYXkuZnJvbShvKTsgaWYgKG4gPT09ICJBcmd1bWVudHMiIHx8IC9eKD86VWl8SSludCg/Ojh8MTZ8MzIpKD86Q2xhbXBlZCk/QXJyYXkkLy50ZXN0KG4pKSByZXR1cm4gX2FycmF5TGlrZVRvQXJyYXkobywgbWluTGVuKTsgfQoKZnVuY3Rpb24gX2FycmF5TGlrZVRvQXJyYXkoYXJyLCBsZW4pIHsgaWYgKGxlbiA9PSBudWxsIHx8IGxlbiA+IGFyci5sZW5ndGgpIGxlbiA9IGFyci5sZW5ndGg7IGZvciAodmFyIGkgPSAwLCBhcnIyID0gbmV3IEFycmF5KGxlbik7IGkgPCBsZW47IGkrKykgeyBhcnIyW2ldID0gYXJyW2ldOyB9IHJldHVybiBhcnIyOyB9CgpmdW5jdGlvbiBfaXRlcmFibGVUb0FycmF5TGltaXQoYXJyLCBpKSB7IGlmICh0eXBlb2YgU3ltYm9sID09PSAidW5kZWZpbmVkIiB8fCAhKFN5bWJvbC5pdGVyYXRvciBpbiBPYmplY3QoYXJyKSkpIHJldHVybjsgdmFyIF9hcnIgPSBbXTsgdmFyIF9uID0gdHJ1ZTsgdmFyIF9kID0gZmFsc2U7IHZhciBfZSA9IHVuZGVmaW5lZDsgdHJ5IHsgZm9yICh2YXIgX2kgPSBhcnJbU3ltYm9sLml0ZXJhdG9yXSgpLCBfczsgIShfbiA9IChfcyA9IF9pLm5leHQoKSkuZG9uZSk7IF9uID0gdHJ1ZSkgeyBfYXJyLnB1c2goX3MudmFsdWUpOyBpZiAoaSAmJiBfYXJyLmxlbmd0aCA9PT0gaSkgYnJlYWs7IH0gfSBjYXRjaCAoZXJyKSB7IF9kID0gdHJ1ZTsgX2UgPSBlcnI7IH0gZmluYWxseSB7IHRyeSB7IGlmICghX24gJiYgX2lbInJldHVybiJdICE9IG51bGwpIF9pWyJyZXR1cm4iXSgpOyB9IGZpbmFsbHkgeyBpZiAoX2QpIHRocm93IF9lOyB9IH0gcmV0dXJuIF9hcnI7IH0KCmZ1bmN0aW9uIF9hcnJheVdpdGhIb2xlcyhhcnIpIHsgaWYgKEFycmF5LmlzQXJyYXkoYXJyKSkgcmV0dXJuIGFycjsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsgfSB9CgpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfQoKZnVuY3Rpb24gX2NyZWF0ZUNsYXNzKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH0KCnZhciBIQVNIX0NIQU5HRV9USU1FT1VUID0gMTAwMDsKdmFyIFBPU0lUSU9OX1VQREFURURfVEhSRVNIT0xEID0gNTA7CnZhciBVUERBVEVfVklFV0FSRUFfVElNRU9VVCA9IDEwMDA7CgpmdW5jdGlvbiBnZXRDdXJyZW50SGFzaCgpIHsKICByZXR1cm4gZG9jdW1lbnQubG9jYXRpb24uaGFzaDsKfQoKdmFyIFBERkhpc3RvcnkgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIFBERkhpc3RvcnkoX3JlZikgewogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICB2YXIgbGlua1NlcnZpY2UgPSBfcmVmLmxpbmtTZXJ2aWNlLAogICAgICAgIGV2ZW50QnVzID0gX3JlZi5ldmVudEJ1czsKCiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgUERGSGlzdG9yeSk7CgogICAgdGhpcy5saW5rU2VydmljZSA9IGxpbmtTZXJ2aWNlOwogICAgdGhpcy5ldmVudEJ1cyA9IGV2ZW50QnVzOwogICAgdGhpcy5faW5pdGlhbGl6ZWQgPSBmYWxzZTsKICAgIHRoaXMuX2ZpbmdlcnByaW50ID0gIiI7CiAgICB0aGlzLnJlc2V0KCk7CiAgICB0aGlzLl9ib3VuZEV2ZW50cyA9IG51bGw7CiAgICB0aGlzLl9pc1ZpZXdlckluUHJlc2VudGF0aW9uTW9kZSA9IGZhbHNlOwoKICAgIHRoaXMuZXZlbnRCdXMuX29uKCJwcmVzZW50YXRpb25tb2RlY2hhbmdlZCIsIGZ1bmN0aW9uIChldnQpIHsKICAgICAgX3RoaXMuX2lzVmlld2VySW5QcmVzZW50YXRpb25Nb2RlID0gZXZ0LmFjdGl2ZSB8fCBldnQuc3dpdGNoSW5Qcm9ncmVzczsKICAgIH0pOwoKICAgIHRoaXMuZXZlbnRCdXMuX29uKCJwYWdlc2luaXQiLCBmdW5jdGlvbiAoKSB7CiAgICAgIF90aGlzLl9pc1BhZ2VzTG9hZGVkID0gZmFsc2U7CgogICAgICB2YXIgb25QYWdlc0xvYWRlZCA9IGZ1bmN0aW9uIG9uUGFnZXNMb2FkZWQoZXZ0KSB7CiAgICAgICAgX3RoaXMuZXZlbnRCdXMuX29mZigicGFnZXNsb2FkZWQiLCBvblBhZ2VzTG9hZGVkKTsKCiAgICAgICAgX3RoaXMuX2lzUGFnZXNMb2FkZWQgPSAhIWV2dC5wYWdlc0NvdW50OwogICAgICB9OwoKICAgICAgX3RoaXMuZXZlbnRCdXMuX29uKCJwYWdlc2xvYWRlZCIsIG9uUGFnZXNMb2FkZWQpOwogICAgfSk7CiAgfQoKICBfY3JlYXRlQ2xhc3MoUERGSGlzdG9yeSwgW3sKICAgIGtleTogImluaXRpYWxpemUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGluaXRpYWxpemUoX3JlZjIpIHsKICAgICAgdmFyIGZpbmdlcnByaW50ID0gX3JlZjIuZmluZ2VycHJpbnQsCiAgICAgICAgICBfcmVmMiRyZXNldEhpc3RvcnkgPSBfcmVmMi5yZXNldEhpc3RvcnksCiAgICAgICAgICByZXNldEhpc3RvcnkgPSBfcmVmMiRyZXNldEhpc3RvcnkgPT09IHZvaWQgMCA/IGZhbHNlIDogX3JlZjIkcmVzZXRIaXN0b3J5LAogICAgICAgICAgX3JlZjIkdXBkYXRlVXJsID0gX3JlZjIudXBkYXRlVXJsLAogICAgICAgICAgdXBkYXRlVXJsID0gX3JlZjIkdXBkYXRlVXJsID09PSB2b2lkIDAgPyBmYWxzZSA6IF9yZWYyJHVwZGF0ZVVybDsKCiAgICAgIGlmICghZmluZ2VycHJpbnQgfHwgdHlwZW9mIGZpbmdlcnByaW50ICE9PSAic3RyaW5nIikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ1BERkhpc3RvcnkuaW5pdGlhbGl6ZTogVGhlICJmaW5nZXJwcmludCIgbXVzdCBiZSBhIG5vbi1lbXB0eSBzdHJpbmcuJyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAodGhpcy5faW5pdGlhbGl6ZWQpIHsKICAgICAgICB0aGlzLnJlc2V0KCk7CiAgICAgIH0KCiAgICAgIHZhciByZUluaXRpYWxpemVkID0gdGhpcy5fZmluZ2VycHJpbnQgIT09ICIiICYmIHRoaXMuX2ZpbmdlcnByaW50ICE9PSBmaW5nZXJwcmludDsKICAgICAgdGhpcy5fZmluZ2VycHJpbnQgPSBmaW5nZXJwcmludDsKICAgICAgdGhpcy5fdXBkYXRlVXJsID0gdXBkYXRlVXJsID09PSB0cnVlOwogICAgICB0aGlzLl9pbml0aWFsaXplZCA9IHRydWU7CgogICAgICB0aGlzLl9iaW5kRXZlbnRzKCk7CgogICAgICB2YXIgc3RhdGUgPSB3aW5kb3cuaGlzdG9yeS5zdGF0ZTsKICAgICAgdGhpcy5fcG9wU3RhdGVJblByb2dyZXNzID0gZmFsc2U7CiAgICAgIHRoaXMuX2Jsb2NrSGFzaENoYW5nZSA9IDA7CiAgICAgIHRoaXMuX2N1cnJlbnRIYXNoID0gZ2V0Q3VycmVudEhhc2goKTsKICAgICAgdGhpcy5fbnVtUG9zaXRpb25VcGRhdGVzID0gMDsKICAgICAgdGhpcy5fdWlkID0gdGhpcy5fbWF4VWlkID0gMDsKICAgICAgdGhpcy5fZGVzdGluYXRpb24gPSBudWxsOwogICAgICB0aGlzLl9wb3NpdGlvbiA9IG51bGw7CgogICAgICBpZiAoIXRoaXMuX2lzVmFsaWRTdGF0ZShzdGF0ZSwgdHJ1ZSkgfHwgcmVzZXRIaXN0b3J5KSB7CiAgICAgICAgdmFyIF90aGlzJF9wYXJzZUN1cnJlbnRIYSA9IHRoaXMuX3BhcnNlQ3VycmVudEhhc2godHJ1ZSksCiAgICAgICAgICAgIGhhc2ggPSBfdGhpcyRfcGFyc2VDdXJyZW50SGEuaGFzaCwKICAgICAgICAgICAgcGFnZSA9IF90aGlzJF9wYXJzZUN1cnJlbnRIYS5wYWdlLAogICAgICAgICAgICByb3RhdGlvbiA9IF90aGlzJF9wYXJzZUN1cnJlbnRIYS5yb3RhdGlvbjsKCiAgICAgICAgaWYgKCFoYXNoIHx8IHJlSW5pdGlhbGl6ZWQgfHwgcmVzZXRIaXN0b3J5KSB7CiAgICAgICAgICB0aGlzLl9wdXNoT3JSZXBsYWNlU3RhdGUobnVsbCwgdHJ1ZSk7CgogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fcHVzaE9yUmVwbGFjZVN0YXRlKHsKICAgICAgICAgIGhhc2g6IGhhc2gsCiAgICAgICAgICBwYWdlOiBwYWdlLAogICAgICAgICAgcm90YXRpb246IHJvdGF0aW9uCiAgICAgICAgfSwgdHJ1ZSk7CgogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGRlc3RpbmF0aW9uID0gc3RhdGUuZGVzdGluYXRpb247CgogICAgICB0aGlzLl91cGRhdGVJbnRlcm5hbFN0YXRlKGRlc3RpbmF0aW9uLCBzdGF0ZS51aWQsIHRydWUpOwoKICAgICAgaWYgKHRoaXMuX3VpZCA+IHRoaXMuX21heFVpZCkgewogICAgICAgIHRoaXMuX21heFVpZCA9IHRoaXMuX3VpZDsKICAgICAgfQoKICAgICAgaWYgKGRlc3RpbmF0aW9uLnJvdGF0aW9uICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLl9pbml0aWFsUm90YXRpb24gPSBkZXN0aW5hdGlvbi5yb3RhdGlvbjsKICAgICAgfQoKICAgICAgaWYgKGRlc3RpbmF0aW9uLmRlc3QpIHsKICAgICAgICB0aGlzLl9pbml0aWFsQm9va21hcmsgPSBKU09OLnN0cmluZ2lmeShkZXN0aW5hdGlvbi5kZXN0KTsKICAgICAgICB0aGlzLl9kZXN0aW5hdGlvbi5wYWdlID0gbnVsbDsKICAgICAgfSBlbHNlIGlmIChkZXN0aW5hdGlvbi5oYXNoKSB7CiAgICAgICAgdGhpcy5faW5pdGlhbEJvb2ttYXJrID0gZGVzdGluYXRpb24uaGFzaDsKICAgICAgfSBlbHNlIGlmIChkZXN0aW5hdGlvbi5wYWdlKSB7CiAgICAgICAgdGhpcy5faW5pdGlhbEJvb2ttYXJrID0gInBhZ2U9Ii5jb25jYXQoZGVzdGluYXRpb24ucGFnZSk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJyZXNldCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVzZXQoKSB7CiAgICAgIGlmICh0aGlzLl9pbml0aWFsaXplZCkgewogICAgICAgIHRoaXMuX3BhZ2VIaWRlKCk7CgogICAgICAgIHRoaXMuX2luaXRpYWxpemVkID0gZmFsc2U7CgogICAgICAgIHRoaXMuX3VuYmluZEV2ZW50cygpOwogICAgICB9CgogICAgICBpZiAodGhpcy5fdXBkYXRlVmlld2FyZWFUaW1lb3V0KSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3VwZGF0ZVZpZXdhcmVhVGltZW91dCk7CiAgICAgICAgdGhpcy5fdXBkYXRlVmlld2FyZWFUaW1lb3V0ID0gbnVsbDsKICAgICAgfQoKICAgICAgdGhpcy5faW5pdGlhbEJvb2ttYXJrID0gbnVsbDsKICAgICAgdGhpcy5faW5pdGlhbFJvdGF0aW9uID0gbnVsbDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJwdXNoIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBwdXNoKF9yZWYzKSB7CiAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgdmFyIF9yZWYzJG5hbWVkRGVzdCA9IF9yZWYzLm5hbWVkRGVzdCwKICAgICAgICAgIG5hbWVkRGVzdCA9IF9yZWYzJG5hbWVkRGVzdCA9PT0gdm9pZCAwID8gbnVsbCA6IF9yZWYzJG5hbWVkRGVzdCwKICAgICAgICAgIGV4cGxpY2l0RGVzdCA9IF9yZWYzLmV4cGxpY2l0RGVzdCwKICAgICAgICAgIHBhZ2VOdW1iZXIgPSBfcmVmMy5wYWdlTnVtYmVyOwoKICAgICAgaWYgKCF0aGlzLl9pbml0aWFsaXplZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKG5hbWVkRGVzdCAmJiB0eXBlb2YgbmFtZWREZXN0ICE9PSAic3RyaW5nIikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoIlBERkhpc3RvcnkucHVzaDogIiArICJcIiIuY29uY2F0KG5hbWVkRGVzdCwgIlwiIGlzIG5vdCBhIHZhbGlkIG5hbWVkRGVzdCBwYXJhbWV0ZXIuIikpOwogICAgICAgIHJldHVybjsKICAgICAgfSBlbHNlIGlmICghQXJyYXkuaXNBcnJheShleHBsaWNpdERlc3QpKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiUERGSGlzdG9yeS5wdXNoOiAiICsgIlwiIi5jb25jYXQoZXhwbGljaXREZXN0LCAiXCIgaXMgbm90IGEgdmFsaWQgZXhwbGljaXREZXN0IHBhcmFtZXRlci4iKSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9IGVsc2UgaWYgKCEoTnVtYmVyLmlzSW50ZWdlcihwYWdlTnVtYmVyKSAmJiBwYWdlTnVtYmVyID4gMCAmJiBwYWdlTnVtYmVyIDw9IHRoaXMubGlua1NlcnZpY2UucGFnZXNDb3VudCkpIHsKICAgICAgICBpZiAocGFnZU51bWJlciAhPT0gbnVsbCB8fCB0aGlzLl9kZXN0aW5hdGlvbikgewogICAgICAgICAgY29uc29sZS5lcnJvcigiUERGSGlzdG9yeS5wdXNoOiAiICsgIlwiIi5jb25jYXQocGFnZU51bWJlciwgIlwiIGlzIG5vdCBhIHZhbGlkIHBhZ2VOdW1iZXIgcGFyYW1ldGVyLiIpKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBoYXNoID0gbmFtZWREZXN0IHx8IEpTT04uc3RyaW5naWZ5KGV4cGxpY2l0RGVzdCk7CgogICAgICBpZiAoIWhhc2gpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBmb3JjZVJlcGxhY2UgPSBmYWxzZTsKCiAgICAgIGlmICh0aGlzLl9kZXN0aW5hdGlvbiAmJiAoaXNEZXN0SGFzaGVzRXF1YWwodGhpcy5fZGVzdGluYXRpb24uaGFzaCwgaGFzaCkgfHwgaXNEZXN0QXJyYXlzRXF1YWwodGhpcy5fZGVzdGluYXRpb24uZGVzdCwgZXhwbGljaXREZXN0KSkpIHsKICAgICAgICBpZiAodGhpcy5fZGVzdGluYXRpb24ucGFnZSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZm9yY2VSZXBsYWNlID0gdHJ1ZTsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuX3BvcFN0YXRlSW5Qcm9ncmVzcyAmJiAhZm9yY2VSZXBsYWNlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLl9wdXNoT3JSZXBsYWNlU3RhdGUoewogICAgICAgIGRlc3Q6IGV4cGxpY2l0RGVzdCwKICAgICAgICBoYXNoOiBoYXNoLAogICAgICAgIHBhZ2U6IHBhZ2VOdW1iZXIsCiAgICAgICAgcm90YXRpb246IHRoaXMubGlua1NlcnZpY2Uucm90YXRpb24KICAgICAgfSwgZm9yY2VSZXBsYWNlKTsKCiAgICAgIGlmICghdGhpcy5fcG9wU3RhdGVJblByb2dyZXNzKSB7CiAgICAgICAgdGhpcy5fcG9wU3RhdGVJblByb2dyZXNzID0gdHJ1ZTsKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIF90aGlzMi5fcG9wU3RhdGVJblByb2dyZXNzID0gZmFsc2U7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJwdXNoQ3VycmVudFBvc2l0aW9uIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBwdXNoQ3VycmVudFBvc2l0aW9uKCkgewogICAgICBpZiAoIXRoaXMuX2luaXRpYWxpemVkIHx8IHRoaXMuX3BvcFN0YXRlSW5Qcm9ncmVzcykgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5fdHJ5UHVzaEN1cnJlbnRQb3NpdGlvbigpOwogICAgfQogIH0sIHsKICAgIGtleTogImJhY2siLAogICAgdmFsdWU6IGZ1bmN0aW9uIGJhY2soKSB7CiAgICAgIGlmICghdGhpcy5faW5pdGlhbGl6ZWQgfHwgdGhpcy5fcG9wU3RhdGVJblByb2dyZXNzKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgc3RhdGUgPSB3aW5kb3cuaGlzdG9yeS5zdGF0ZTsKCiAgICAgIGlmICh0aGlzLl9pc1ZhbGlkU3RhdGUoc3RhdGUpICYmIHN0YXRlLnVpZCA+IDApIHsKICAgICAgICB3aW5kb3cuaGlzdG9yeS5iYWNrKCk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJmb3J3YXJkIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBmb3J3YXJkKCkgewogICAgICBpZiAoIXRoaXMuX2luaXRpYWxpemVkIHx8IHRoaXMuX3BvcFN0YXRlSW5Qcm9ncmVzcykgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHN0YXRlID0gd2luZG93Lmhpc3Rvcnkuc3RhdGU7CgogICAgICBpZiAodGhpcy5faXNWYWxpZFN0YXRlKHN0YXRlKSAmJiBzdGF0ZS51aWQgPCB0aGlzLl9tYXhVaWQpIHsKICAgICAgICB3aW5kb3cuaGlzdG9yeS5mb3J3YXJkKCk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJfcHVzaE9yUmVwbGFjZVN0YXRlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfcHVzaE9yUmVwbGFjZVN0YXRlKGRlc3RpbmF0aW9uKSB7CiAgICAgIHZhciBmb3JjZVJlcGxhY2UgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IGZhbHNlOwogICAgICB2YXIgc2hvdWxkUmVwbGFjZSA9IGZvcmNlUmVwbGFjZSB8fCAhdGhpcy5fZGVzdGluYXRpb247CiAgICAgIHZhciBuZXdTdGF0ZSA9IHsKICAgICAgICBmaW5nZXJwcmludDogdGhpcy5fZmluZ2VycHJpbnQsCiAgICAgICAgdWlkOiBzaG91bGRSZXBsYWNlID8gdGhpcy5fdWlkIDogdGhpcy5fdWlkICsgMSwKICAgICAgICBkZXN0aW5hdGlvbjogZGVzdGluYXRpb24KICAgICAgfTsKCiAgICAgIHRoaXMuX3VwZGF0ZUludGVybmFsU3RhdGUoZGVzdGluYXRpb24sIG5ld1N0YXRlLnVpZCk7CgogICAgICB2YXIgbmV3VXJsOwoKICAgICAgaWYgKHRoaXMuX3VwZGF0ZVVybCAmJiBkZXN0aW5hdGlvbiAmJiBkZXN0aW5hdGlvbi5oYXNoKSB7CiAgICAgICAgdmFyIGJhc2VVcmwgPSBkb2N1bWVudC5sb2NhdGlvbi5ocmVmLnNwbGl0KCIjIilbMF07CgogICAgICAgIGlmICghYmFzZVVybC5zdGFydHNXaXRoKCJmaWxlOi8vIikpIHsKICAgICAgICAgIG5ld1VybCA9ICIiLmNvbmNhdChiYXNlVXJsLCAiIyIpLmNvbmNhdChkZXN0aW5hdGlvbi5oYXNoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChzaG91bGRSZXBsYWNlKSB7CiAgICAgICAgd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKG5ld1N0YXRlLCAiIiwgbmV3VXJsKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9tYXhVaWQgPSB0aGlzLl91aWQ7CiAgICAgICAgd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlKG5ld1N0YXRlLCAiIiwgbmV3VXJsKTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogIl90cnlQdXNoQ3VycmVudFBvc2l0aW9uIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfdHJ5UHVzaEN1cnJlbnRQb3NpdGlvbigpIHsKICAgICAgdmFyIHRlbXBvcmFyeSA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDogZmFsc2U7CgogICAgICBpZiAoIXRoaXMuX3Bvc2l0aW9uKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgcG9zaXRpb24gPSB0aGlzLl9wb3NpdGlvbjsKCiAgICAgIGlmICh0ZW1wb3JhcnkpIHsKICAgICAgICBwb3NpdGlvbiA9IE9iamVjdC5hc3NpZ24oT2JqZWN0LmNyZWF0ZShudWxsKSwgdGhpcy5fcG9zaXRpb24pOwogICAgICAgIHBvc2l0aW9uLnRlbXBvcmFyeSA9IHRydWU7CiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5fZGVzdGluYXRpb24pIHsKICAgICAgICB0aGlzLl9wdXNoT3JSZXBsYWNlU3RhdGUocG9zaXRpb24pOwoKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9kZXN0aW5hdGlvbi50ZW1wb3JhcnkpIHsKICAgICAgICB0aGlzLl9wdXNoT3JSZXBsYWNlU3RhdGUocG9zaXRpb24sIHRydWUpOwoKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9kZXN0aW5hdGlvbi5oYXNoID09PSBwb3NpdGlvbi5oYXNoKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoIXRoaXMuX2Rlc3RpbmF0aW9uLnBhZ2UgJiYgKFBPU0lUSU9OX1VQREFURURfVEhSRVNIT0xEIDw9IDAgfHwgdGhpcy5fbnVtUG9zaXRpb25VcGRhdGVzIDw9IFBPU0lUSU9OX1VQREFURURfVEhSRVNIT0xEKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGZvcmNlUmVwbGFjZSA9IGZhbHNlOwoKICAgICAgaWYgKHRoaXMuX2Rlc3RpbmF0aW9uLnBhZ2UgPj0gcG9zaXRpb24uZmlyc3QgJiYgdGhpcy5fZGVzdGluYXRpb24ucGFnZSA8PSBwb3NpdGlvbi5wYWdlKSB7CiAgICAgICAgaWYgKHRoaXMuX2Rlc3RpbmF0aW9uLmRlc3QgfHwgIXRoaXMuX2Rlc3RpbmF0aW9uLmZpcnN0KSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBmb3JjZVJlcGxhY2UgPSB0cnVlOwogICAgICB9CgogICAgICB0aGlzLl9wdXNoT3JSZXBsYWNlU3RhdGUocG9zaXRpb24sIGZvcmNlUmVwbGFjZSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiX2lzVmFsaWRTdGF0ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2lzVmFsaWRTdGF0ZShzdGF0ZSkgewogICAgICB2YXIgY2hlY2tSZWxvYWQgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IGZhbHNlOwoKICAgICAgaWYgKCFzdGF0ZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgaWYgKHN0YXRlLmZpbmdlcnByaW50ICE9PSB0aGlzLl9maW5nZXJwcmludCkgewogICAgICAgIGlmIChjaGVja1JlbG9hZCkgewogICAgICAgICAgaWYgKHR5cGVvZiBzdGF0ZS5maW5nZXJwcmludCAhPT0gInN0cmluZyIgfHwgc3RhdGUuZmluZ2VycHJpbnQubGVuZ3RoICE9PSB0aGlzLl9maW5nZXJwcmludC5sZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBfcGVyZm9ybWFuY2UkZ2V0RW50cmkgPSBwZXJmb3JtYW5jZS5nZXRFbnRyaWVzQnlUeXBlKCJuYXZpZ2F0aW9uIiksCiAgICAgICAgICAgICAgX3BlcmZvcm1hbmNlJGdldEVudHJpMiA9IF9zbGljZWRUb0FycmF5KF9wZXJmb3JtYW5jZSRnZXRFbnRyaSwgMSksCiAgICAgICAgICAgICAgcGVyZkVudHJ5ID0gX3BlcmZvcm1hbmNlJGdldEVudHJpMlswXTsKCiAgICAgICAgICBpZiAoIXBlcmZFbnRyeSB8fCBwZXJmRW50cnkudHlwZSAhPT0gInJlbG9hZCIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoIU51bWJlci5pc0ludGVnZXIoc3RhdGUudWlkKSB8fCBzdGF0ZS51aWQgPCAwKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICBpZiAoc3RhdGUuZGVzdGluYXRpb24gPT09IG51bGwgfHwgX3R5cGVvZihzdGF0ZS5kZXN0aW5hdGlvbikgIT09ICJvYmplY3QiKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfdXBkYXRlSW50ZXJuYWxTdGF0ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3VwZGF0ZUludGVybmFsU3RhdGUoZGVzdGluYXRpb24sIHVpZCkgewogICAgICB2YXIgcmVtb3ZlVGVtcG9yYXJ5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMl0gOiBmYWxzZTsKCiAgICAgIGlmICh0aGlzLl91cGRhdGVWaWV3YXJlYVRpbWVvdXQpIHsKICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fdXBkYXRlVmlld2FyZWFUaW1lb3V0KTsKICAgICAgICB0aGlzLl91cGRhdGVWaWV3YXJlYVRpbWVvdXQgPSBudWxsOwogICAgICB9CgogICAgICBpZiAocmVtb3ZlVGVtcG9yYXJ5ICYmIGRlc3RpbmF0aW9uICYmIGRlc3RpbmF0aW9uLnRlbXBvcmFyeSkgewogICAgICAgIGRlbGV0ZSBkZXN0aW5hdGlvbi50ZW1wb3Jhcnk7CiAgICAgIH0KCiAgICAgIHRoaXMuX2Rlc3RpbmF0aW9uID0gZGVzdGluYXRpb247CiAgICAgIHRoaXMuX3VpZCA9IHVpZDsKICAgICAgdGhpcy5fbnVtUG9zaXRpb25VcGRhdGVzID0gMDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfcGFyc2VDdXJyZW50SGFzaCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3BhcnNlQ3VycmVudEhhc2goKSB7CiAgICAgIHZhciBjaGVja05hbWVkZGVzdCA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDogZmFsc2U7CiAgICAgIHZhciBoYXNoID0gdW5lc2NhcGUoZ2V0Q3VycmVudEhhc2goKSkuc3Vic3RyaW5nKDEpOwogICAgICB2YXIgcGFyYW1zID0gKDAsIF91aV91dGlscy5wYXJzZVF1ZXJ5U3RyaW5nKShoYXNoKTsKICAgICAgdmFyIG5hbWVkZGVzdCA9IHBhcmFtcy5uYW1lZGRlc3QgfHwgIiI7CiAgICAgIHZhciBwYWdlID0gcGFyYW1zLnBhZ2UgfCAwOwoKICAgICAgaWYgKCEoTnVtYmVyLmlzSW50ZWdlcihwYWdlKSAmJiBwYWdlID4gMCAmJiBwYWdlIDw9IHRoaXMubGlua1NlcnZpY2UucGFnZXNDb3VudCkgfHwgY2hlY2tOYW1lZGRlc3QgJiYgbmFtZWRkZXN0Lmxlbmd0aCA+IDApIHsKICAgICAgICBwYWdlID0gbnVsbDsKICAgICAgfQoKICAgICAgcmV0dXJuIHsKICAgICAgICBoYXNoOiBoYXNoLAogICAgICAgIHBhZ2U6IHBhZ2UsCiAgICAgICAgcm90YXRpb246IHRoaXMubGlua1NlcnZpY2Uucm90YXRpb24KICAgICAgfTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfdXBkYXRlVmlld2FyZWEiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF91cGRhdGVWaWV3YXJlYShfcmVmNCkgewogICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgIHZhciBsb2NhdGlvbiA9IF9yZWY0LmxvY2F0aW9uOwoKICAgICAgaWYgKHRoaXMuX3VwZGF0ZVZpZXdhcmVhVGltZW91dCkgewogICAgICAgIGNsZWFyVGltZW91dCh0aGlzLl91cGRhdGVWaWV3YXJlYVRpbWVvdXQpOwogICAgICAgIHRoaXMuX3VwZGF0ZVZpZXdhcmVhVGltZW91dCA9IG51bGw7CiAgICAgIH0KCiAgICAgIHRoaXMuX3Bvc2l0aW9uID0gewogICAgICAgIGhhc2g6IHRoaXMuX2lzVmlld2VySW5QcmVzZW50YXRpb25Nb2RlID8gInBhZ2U9Ii5jb25jYXQobG9jYXRpb24ucGFnZU51bWJlcikgOiBsb2NhdGlvbi5wZGZPcGVuUGFyYW1zLnN1YnN0cmluZygxKSwKICAgICAgICBwYWdlOiB0aGlzLmxpbmtTZXJ2aWNlLnBhZ2UsCiAgICAgICAgZmlyc3Q6IGxvY2F0aW9uLnBhZ2VOdW1iZXIsCiAgICAgICAgcm90YXRpb246IGxvY2F0aW9uLnJvdGF0aW9uCiAgICAgIH07CgogICAgICBpZiAodGhpcy5fcG9wU3RhdGVJblByb2dyZXNzKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoUE9TSVRJT05fVVBEQVRFRF9USFJFU0hPTEQgPiAwICYmIHRoaXMuX2lzUGFnZXNMb2FkZWQgJiYgdGhpcy5fZGVzdGluYXRpb24gJiYgIXRoaXMuX2Rlc3RpbmF0aW9uLnBhZ2UpIHsKICAgICAgICB0aGlzLl9udW1Qb3NpdGlvblVwZGF0ZXMrKzsKICAgICAgfQoKICAgICAgaWYgKFVQREFURV9WSUVXQVJFQV9USU1FT1VUID4gMCkgewogICAgICAgIHRoaXMuX3VwZGF0ZVZpZXdhcmVhVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKCFfdGhpczMuX3BvcFN0YXRlSW5Qcm9ncmVzcykgewogICAgICAgICAgICBfdGhpczMuX3RyeVB1c2hDdXJyZW50UG9zaXRpb24odHJ1ZSk7CiAgICAgICAgICB9CgogICAgICAgICAgX3RoaXMzLl91cGRhdGVWaWV3YXJlYVRpbWVvdXQgPSBudWxsOwogICAgICAgIH0sIFVQREFURV9WSUVXQVJFQV9USU1FT1VUKTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogIl9wb3BTdGF0ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3BvcFN0YXRlKF9yZWY1KSB7CiAgICAgIHZhciBfdGhpczQgPSB0aGlzOwoKICAgICAgdmFyIHN0YXRlID0gX3JlZjUuc3RhdGU7CiAgICAgIHZhciBuZXdIYXNoID0gZ2V0Q3VycmVudEhhc2goKSwKICAgICAgICAgIGhhc2hDaGFuZ2VkID0gdGhpcy5fY3VycmVudEhhc2ggIT09IG5ld0hhc2g7CiAgICAgIHRoaXMuX2N1cnJlbnRIYXNoID0gbmV3SGFzaDsKCiAgICAgIGlmICghc3RhdGUpIHsKICAgICAgICB0aGlzLl91aWQrKzsKCiAgICAgICAgdmFyIF90aGlzJF9wYXJzZUN1cnJlbnRIYTIgPSB0aGlzLl9wYXJzZUN1cnJlbnRIYXNoKCksCiAgICAgICAgICAgIGhhc2ggPSBfdGhpcyRfcGFyc2VDdXJyZW50SGEyLmhhc2gsCiAgICAgICAgICAgIHBhZ2UgPSBfdGhpcyRfcGFyc2VDdXJyZW50SGEyLnBhZ2UsCiAgICAgICAgICAgIHJvdGF0aW9uID0gX3RoaXMkX3BhcnNlQ3VycmVudEhhMi5yb3RhdGlvbjsKCiAgICAgICAgdGhpcy5fcHVzaE9yUmVwbGFjZVN0YXRlKHsKICAgICAgICAgIGhhc2g6IGhhc2gsCiAgICAgICAgICBwYWdlOiBwYWdlLAogICAgICAgICAgcm90YXRpb246IHJvdGF0aW9uCiAgICAgICAgfSwgdHJ1ZSk7CgogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLl9pc1ZhbGlkU3RhdGUoc3RhdGUpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLl9wb3BTdGF0ZUluUHJvZ3Jlc3MgPSB0cnVlOwoKICAgICAgaWYgKGhhc2hDaGFuZ2VkKSB7CiAgICAgICAgdGhpcy5fYmxvY2tIYXNoQ2hhbmdlKys7CiAgICAgICAgKDAsIF91aV91dGlscy53YWl0T25FdmVudE9yVGltZW91dCkoewogICAgICAgICAgdGFyZ2V0OiB3aW5kb3csCiAgICAgICAgICBuYW1lOiAiaGFzaGNoYW5nZSIsCiAgICAgICAgICBkZWxheTogSEFTSF9DSEFOR0VfVElNRU9VVAogICAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgX3RoaXM0Ll9ibG9ja0hhc2hDaGFuZ2UtLTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgdmFyIGRlc3RpbmF0aW9uID0gc3RhdGUuZGVzdGluYXRpb247CgogICAgICB0aGlzLl91cGRhdGVJbnRlcm5hbFN0YXRlKGRlc3RpbmF0aW9uLCBzdGF0ZS51aWQsIHRydWUpOwoKICAgICAgaWYgKHRoaXMuX3VpZCA+IHRoaXMuX21heFVpZCkgewogICAgICAgIHRoaXMuX21heFVpZCA9IHRoaXMuX3VpZDsKICAgICAgfQoKICAgICAgaWYgKCgwLCBfdWlfdXRpbHMuaXNWYWxpZFJvdGF0aW9uKShkZXN0aW5hdGlvbi5yb3RhdGlvbikpIHsKICAgICAgICB0aGlzLmxpbmtTZXJ2aWNlLnJvdGF0aW9uID0gZGVzdGluYXRpb24ucm90YXRpb247CiAgICAgIH0KCiAgICAgIGlmIChkZXN0aW5hdGlvbi5kZXN0KSB7CiAgICAgICAgdGhpcy5saW5rU2VydmljZS5uYXZpZ2F0ZVRvKGRlc3RpbmF0aW9uLmRlc3QpOwogICAgICB9IGVsc2UgaWYgKGRlc3RpbmF0aW9uLmhhc2gpIHsKICAgICAgICB0aGlzLmxpbmtTZXJ2aWNlLnNldEhhc2goZGVzdGluYXRpb24uaGFzaCk7CiAgICAgIH0gZWxzZSBpZiAoZGVzdGluYXRpb24ucGFnZSkgewogICAgICAgIHRoaXMubGlua1NlcnZpY2UucGFnZSA9IGRlc3RpbmF0aW9uLnBhZ2U7CiAgICAgIH0KCiAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzNC5fcG9wU3RhdGVJblByb2dyZXNzID0gZmFsc2U7CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogIl9wYWdlSGlkZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3BhZ2VIaWRlKCkgewogICAgICBpZiAoIXRoaXMuX2Rlc3RpbmF0aW9uIHx8IHRoaXMuX2Rlc3RpbmF0aW9uLnRlbXBvcmFyeSkgewogICAgICAgIHRoaXMuX3RyeVB1c2hDdXJyZW50UG9zaXRpb24oKTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogIl9iaW5kRXZlbnRzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfYmluZEV2ZW50cygpIHsKICAgICAgaWYgKHRoaXMuX2JvdW5kRXZlbnRzKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLl9ib3VuZEV2ZW50cyA9IHsKICAgICAgICB1cGRhdGVWaWV3YXJlYTogdGhpcy5fdXBkYXRlVmlld2FyZWEuYmluZCh0aGlzKSwKICAgICAgICBwb3BTdGF0ZTogdGhpcy5fcG9wU3RhdGUuYmluZCh0aGlzKSwKICAgICAgICBwYWdlSGlkZTogdGhpcy5fcGFnZUhpZGUuYmluZCh0aGlzKQogICAgICB9OwoKICAgICAgdGhpcy5ldmVudEJ1cy5fb24oInVwZGF0ZXZpZXdhcmVhIiwgdGhpcy5fYm91bmRFdmVudHMudXBkYXRlVmlld2FyZWEpOwoKICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInBvcHN0YXRlIiwgdGhpcy5fYm91bmRFdmVudHMucG9wU3RhdGUpOwogICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigicGFnZWhpZGUiLCB0aGlzLl9ib3VuZEV2ZW50cy5wYWdlSGlkZSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiX3VuYmluZEV2ZW50cyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3VuYmluZEV2ZW50cygpIHsKICAgICAgaWYgKCF0aGlzLl9ib3VuZEV2ZW50cykgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5ldmVudEJ1cy5fb2ZmKCJ1cGRhdGV2aWV3YXJlYSIsIHRoaXMuX2JvdW5kRXZlbnRzLnVwZGF0ZVZpZXdhcmVhKTsKCiAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJwb3BzdGF0ZSIsIHRoaXMuX2JvdW5kRXZlbnRzLnBvcFN0YXRlKTsKICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInBhZ2VoaWRlIiwgdGhpcy5fYm91bmRFdmVudHMucGFnZUhpZGUpOwogICAgICB0aGlzLl9ib3VuZEV2ZW50cyA9IG51bGw7CiAgICB9CiAgfSwgewogICAga2V5OiAicG9wU3RhdGVJblByb2dyZXNzIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5faW5pdGlhbGl6ZWQgJiYgKHRoaXMuX3BvcFN0YXRlSW5Qcm9ncmVzcyB8fCB0aGlzLl9ibG9ja0hhc2hDaGFuZ2UgPiAwKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJpbml0aWFsQm9va21hcmsiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9pbml0aWFsaXplZCA/IHRoaXMuX2luaXRpYWxCb29rbWFyayA6IG51bGw7CiAgICB9CiAgfSwgewogICAga2V5OiAiaW5pdGlhbFJvdGF0aW9uIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5faW5pdGlhbGl6ZWQgPyB0aGlzLl9pbml0aWFsUm90YXRpb24gOiBudWxsOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIFBERkhpc3Rvcnk7Cn0oKTsKCmV4cG9ydHMuUERGSGlzdG9yeSA9IFBERkhpc3Rvcnk7CgpmdW5jdGlvbiBpc0Rlc3RIYXNoZXNFcXVhbChkZXN0SGFzaCwgcHVzaEhhc2gpIHsKICBpZiAodHlwZW9mIGRlc3RIYXNoICE9PSAic3RyaW5nIiB8fCB0eXBlb2YgcHVzaEhhc2ggIT09ICJzdHJpbmciKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICBpZiAoZGVzdEhhc2ggPT09IHB1c2hIYXNoKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIHZhciBfcGFyc2VRdWVyeVN0cmluZyA9ICgwLCBfdWlfdXRpbHMucGFyc2VRdWVyeVN0cmluZykoZGVzdEhhc2gpLAogICAgICBuYW1lZGRlc3QgPSBfcGFyc2VRdWVyeVN0cmluZy5uYW1lZGRlc3Q7CgogIGlmIChuYW1lZGRlc3QgPT09IHB1c2hIYXNoKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIHJldHVybiBmYWxzZTsKfQoKZnVuY3Rpb24gaXNEZXN0QXJyYXlzRXF1YWwoZmlyc3REZXN0LCBzZWNvbmREZXN0KSB7CiAgZnVuY3Rpb24gaXNFbnRyeUVxdWFsKGZpcnN0LCBzZWNvbmQpIHsKICAgIGlmIChfdHlwZW9mKGZpcnN0KSAhPT0gX3R5cGVvZihzZWNvbmQpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBpZiAoQXJyYXkuaXNBcnJheShmaXJzdCkgfHwgQXJyYXkuaXNBcnJheShzZWNvbmQpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBpZiAoZmlyc3QgIT09IG51bGwgJiYgX3R5cGVvZihmaXJzdCkgPT09ICJvYmplY3QiICYmIHNlY29uZCAhPT0gbnVsbCkgewogICAgICBpZiAoT2JqZWN0LmtleXMoZmlyc3QpLmxlbmd0aCAhPT0gT2JqZWN0LmtleXMoc2Vjb25kKS5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGZvciAodmFyIGtleSBpbiBmaXJzdCkgewogICAgICAgIGlmICghaXNFbnRyeUVxdWFsKGZpcnN0W2tleV0sIHNlY29uZFtrZXldKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgcmV0dXJuIGZpcnN0ID09PSBzZWNvbmQgfHwgTnVtYmVyLmlzTmFOKGZpcnN0KSAmJiBOdW1iZXIuaXNOYU4oc2Vjb25kKTsKICB9CgogIGlmICghKEFycmF5LmlzQXJyYXkoZmlyc3REZXN0KSAmJiBBcnJheS5pc0FycmF5KHNlY29uZERlc3QpKSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgaWYgKGZpcnN0RGVzdC5sZW5ndGggIT09IHNlY29uZERlc3QubGVuZ3RoKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICBmb3IgKHZhciBpID0gMCwgaWkgPSBmaXJzdERlc3QubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgaWYgKCFpc0VudHJ5RXF1YWwoZmlyc3REZXN0W2ldLCBzZWNvbmREZXN0W2ldKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQoKICByZXR1cm4gdHJ1ZTsKfQoKLyoqKi8gfSksCi8qIDIxICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuU2ltcGxlTGlua1NlcnZpY2UgPSBleHBvcnRzLlBERkxpbmtTZXJ2aWNlID0gdm9pZCAwOwoKdmFyIF91aV91dGlscyA9IF9fd2VicGFja19yZXF1aXJlX18oNSk7CgpmdW5jdGlvbiBfdHlwZW9mKG9iaikgeyAiQGJhYmVsL2hlbHBlcnMgLSB0eXBlb2YiOyBpZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgU3ltYm9sLml0ZXJhdG9yID09PSAic3ltYm9sIikgeyBfdHlwZW9mID0gZnVuY3Rpb24gX3R5cGVvZihvYmopIHsgcmV0dXJuIHR5cGVvZiBvYmo7IH07IH0gZWxzZSB7IF90eXBlb2YgPSBmdW5jdGlvbiBfdHlwZW9mKG9iaikgeyByZXR1cm4gb2JqICYmIHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgb2JqLmNvbnN0cnVjdG9yID09PSBTeW1ib2wgJiYgb2JqICE9PSBTeW1ib2wucHJvdG90eXBlID8gInN5bWJvbCIgOiB0eXBlb2Ygb2JqOyB9OyB9IHJldHVybiBfdHlwZW9mKG9iaik7IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7IH0gfQoKZnVuY3Rpb24gX2RlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoInZhbHVlIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0KCmZ1bmN0aW9uIF9jcmVhdGVDbGFzcyhDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9Cgp2YXIgUERGTGlua1NlcnZpY2UgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIFBERkxpbmtTZXJ2aWNlKCkgewogICAgdmFyIF9yZWYgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IHt9LAogICAgICAgIGV2ZW50QnVzID0gX3JlZi5ldmVudEJ1cywKICAgICAgICBfcmVmJGV4dGVybmFsTGlua1RhcmcgPSBfcmVmLmV4dGVybmFsTGlua1RhcmdldCwKICAgICAgICBleHRlcm5hbExpbmtUYXJnZXQgPSBfcmVmJGV4dGVybmFsTGlua1RhcmcgPT09IHZvaWQgMCA/IG51bGwgOiBfcmVmJGV4dGVybmFsTGlua1RhcmcsCiAgICAgICAgX3JlZiRleHRlcm5hbExpbmtSZWwgPSBfcmVmLmV4dGVybmFsTGlua1JlbCwKICAgICAgICBleHRlcm5hbExpbmtSZWwgPSBfcmVmJGV4dGVybmFsTGlua1JlbCA9PT0gdm9pZCAwID8gbnVsbCA6IF9yZWYkZXh0ZXJuYWxMaW5rUmVsLAogICAgICAgIF9yZWYkZXh0ZXJuYWxMaW5rRW5hYiA9IF9yZWYuZXh0ZXJuYWxMaW5rRW5hYmxlZCwKICAgICAgICBleHRlcm5hbExpbmtFbmFibGVkID0gX3JlZiRleHRlcm5hbExpbmtFbmFiID09PSB2b2lkIDAgPyB0cnVlIDogX3JlZiRleHRlcm5hbExpbmtFbmFiLAogICAgICAgIF9yZWYkaWdub3JlRGVzdGluYXRpbyA9IF9yZWYuaWdub3JlRGVzdGluYXRpb25ab29tLAogICAgICAgIGlnbm9yZURlc3RpbmF0aW9uWm9vbSA9IF9yZWYkaWdub3JlRGVzdGluYXRpbyA9PT0gdm9pZCAwID8gZmFsc2UgOiBfcmVmJGlnbm9yZURlc3RpbmF0aW87CgogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFBERkxpbmtTZXJ2aWNlKTsKCiAgICB0aGlzLmV2ZW50QnVzID0gZXZlbnRCdXM7CiAgICB0aGlzLmV4dGVybmFsTGlua1RhcmdldCA9IGV4dGVybmFsTGlua1RhcmdldDsKICAgIHRoaXMuZXh0ZXJuYWxMaW5rUmVsID0gZXh0ZXJuYWxMaW5rUmVsOwogICAgdGhpcy5leHRlcm5hbExpbmtFbmFibGVkID0gZXh0ZXJuYWxMaW5rRW5hYmxlZDsKICAgIHRoaXMuX2lnbm9yZURlc3RpbmF0aW9uWm9vbSA9IGlnbm9yZURlc3RpbmF0aW9uWm9vbTsKICAgIHRoaXMuYmFzZVVybCA9IG51bGw7CiAgICB0aGlzLnBkZkRvY3VtZW50ID0gbnVsbDsKICAgIHRoaXMucGRmVmlld2VyID0gbnVsbDsKICAgIHRoaXMucGRmSGlzdG9yeSA9IG51bGw7CiAgICB0aGlzLl9wYWdlc1JlZkNhY2hlID0gbnVsbDsKICB9CgogIF9jcmVhdGVDbGFzcyhQREZMaW5rU2VydmljZSwgW3sKICAgIGtleTogInNldERvY3VtZW50IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXREb2N1bWVudChwZGZEb2N1bWVudCkgewogICAgICB2YXIgYmFzZVVybCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDogbnVsbDsKICAgICAgdGhpcy5iYXNlVXJsID0gYmFzZVVybDsKICAgICAgdGhpcy5wZGZEb2N1bWVudCA9IHBkZkRvY3VtZW50OwogICAgICB0aGlzLl9wYWdlc1JlZkNhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJzZXRWaWV3ZXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHNldFZpZXdlcihwZGZWaWV3ZXIpIHsKICAgICAgdGhpcy5wZGZWaWV3ZXIgPSBwZGZWaWV3ZXI7CiAgICB9CiAgfSwgewogICAga2V5OiAic2V0SGlzdG9yeSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2V0SGlzdG9yeShwZGZIaXN0b3J5KSB7CiAgICAgIHRoaXMucGRmSGlzdG9yeSA9IHBkZkhpc3Rvcnk7CiAgICB9CiAgfSwgewogICAga2V5OiAibmF2aWdhdGVUbyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gbmF2aWdhdGVUbyhkZXN0KSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICB2YXIgZ29Ub0Rlc3RpbmF0aW9uID0gZnVuY3Rpb24gZ29Ub0Rlc3RpbmF0aW9uKF9yZWYyKSB7CiAgICAgICAgdmFyIG5hbWVkRGVzdCA9IF9yZWYyLm5hbWVkRGVzdCwKICAgICAgICAgICAgZXhwbGljaXREZXN0ID0gX3JlZjIuZXhwbGljaXREZXN0OwogICAgICAgIHZhciBkZXN0UmVmID0gZXhwbGljaXREZXN0WzBdOwogICAgICAgIHZhciBwYWdlTnVtYmVyOwoKICAgICAgICBpZiAoZGVzdFJlZiBpbnN0YW5jZW9mIE9iamVjdCkgewogICAgICAgICAgcGFnZU51bWJlciA9IF90aGlzLl9jYWNoZWRQYWdlTnVtYmVyKGRlc3RSZWYpOwoKICAgICAgICAgIGlmIChwYWdlTnVtYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgIF90aGlzLnBkZkRvY3VtZW50LmdldFBhZ2VJbmRleChkZXN0UmVmKS50aGVuKGZ1bmN0aW9uIChwYWdlSW5kZXgpIHsKICAgICAgICAgICAgICBfdGhpcy5jYWNoZVBhZ2VSZWYocGFnZUluZGV4ICsgMSwgZGVzdFJlZik7CgogICAgICAgICAgICAgIGdvVG9EZXN0aW5hdGlvbih7CiAgICAgICAgICAgICAgICBuYW1lZERlc3Q6IG5hbWVkRGVzdCwKICAgICAgICAgICAgICAgIGV4cGxpY2l0RGVzdDogZXhwbGljaXREZXN0CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pWyJjYXRjaCJdKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCJQREZMaW5rU2VydmljZS5uYXZpZ2F0ZVRvOiBcIiIuY29uY2F0KGRlc3RSZWYsICJcIiBpcyBub3QgIikgKyAiYSB2YWxpZCBwYWdlIHJlZmVyZW5jZSwgZm9yIGRlc3Q9XCIiLmNvbmNhdChkZXN0LCAiXCIuIikpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKE51bWJlci5pc0ludGVnZXIoZGVzdFJlZikpIHsKICAgICAgICAgIHBhZ2VOdW1iZXIgPSBkZXN0UmVmICsgMTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc29sZS5lcnJvcigiUERGTGlua1NlcnZpY2UubmF2aWdhdGVUbzogXCIiLmNvbmNhdChkZXN0UmVmLCAiXCIgaXMgbm90ICIpICsgImEgdmFsaWQgZGVzdGluYXRpb24gcmVmZXJlbmNlLCBmb3IgZGVzdD1cIiIuY29uY2F0KGRlc3QsICJcIi4iKSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAoIXBhZ2VOdW1iZXIgfHwgcGFnZU51bWJlciA8IDEgfHwgcGFnZU51bWJlciA+IF90aGlzLnBhZ2VzQ291bnQpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIlBERkxpbmtTZXJ2aWNlLm5hdmlnYXRlVG86IFwiIi5jb25jYXQocGFnZU51bWJlciwgIlwiIGlzIG5vdCAiKSArICJhIHZhbGlkIHBhZ2UgbnVtYmVyLCBmb3IgZGVzdD1cIiIuY29uY2F0KGRlc3QsICJcIi4iKSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAoX3RoaXMucGRmSGlzdG9yeSkgewogICAgICAgICAgX3RoaXMucGRmSGlzdG9yeS5wdXNoQ3VycmVudFBvc2l0aW9uKCk7CgogICAgICAgICAgX3RoaXMucGRmSGlzdG9yeS5wdXNoKHsKICAgICAgICAgICAgbmFtZWREZXN0OiBuYW1lZERlc3QsCiAgICAgICAgICAgIGV4cGxpY2l0RGVzdDogZXhwbGljaXREZXN0LAogICAgICAgICAgICBwYWdlTnVtYmVyOiBwYWdlTnVtYmVyCiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF90aGlzLnBkZlZpZXdlci5zY3JvbGxQYWdlSW50b1ZpZXcoewogICAgICAgICAgcGFnZU51bWJlcjogcGFnZU51bWJlciwKICAgICAgICAgIGRlc3RBcnJheTogZXhwbGljaXREZXN0LAogICAgICAgICAgaWdub3JlRGVzdGluYXRpb25ab29tOiBfdGhpcy5faWdub3JlRGVzdGluYXRpb25ab29tCiAgICAgICAgfSk7CiAgICAgIH07CgogICAgICBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgaWYgKHR5cGVvZiBkZXN0ID09PSAic3RyaW5nIikgewogICAgICAgICAgX3RoaXMucGRmRG9jdW1lbnQuZ2V0RGVzdGluYXRpb24oZGVzdCkudGhlbihmdW5jdGlvbiAoZGVzdEFycmF5KSB7CiAgICAgICAgICAgIHJlc29sdmUoewogICAgICAgICAgICAgIG5hbWVkRGVzdDogZGVzdCwKICAgICAgICAgICAgICBleHBsaWNpdERlc3Q6IGRlc3RBcnJheQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHJlc29sdmUoewogICAgICAgICAgbmFtZWREZXN0OiAiIiwKICAgICAgICAgIGV4cGxpY2l0RGVzdDogZGVzdAogICAgICAgIH0pOwogICAgICB9KS50aGVuKGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGRhdGEuZXhwbGljaXREZXN0KSkgewogICAgICAgICAgY29uc29sZS5lcnJvcigiUERGTGlua1NlcnZpY2UubmF2aWdhdGVUbzogXCIiLmNvbmNhdChkYXRhLmV4cGxpY2l0RGVzdCwgIlwiIGlzIikgKyAiIG5vdCBhIHZhbGlkIGRlc3RpbmF0aW9uIGFycmF5LCBmb3IgZGVzdD1cIiIuY29uY2F0KGRlc3QsICJcIi4iKSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBnb1RvRGVzdGluYXRpb24oZGF0YSk7CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogImdldERlc3RpbmF0aW9uSGFzaCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0RGVzdGluYXRpb25IYXNoKGRlc3QpIHsKICAgICAgaWYgKHR5cGVvZiBkZXN0ID09PSAic3RyaW5nIikgewogICAgICAgIHJldHVybiB0aGlzLmdldEFuY2hvclVybCgiIyIgKyBlc2NhcGUoZGVzdCkpOwogICAgICB9CgogICAgICBpZiAoQXJyYXkuaXNBcnJheShkZXN0KSkgewogICAgICAgIHZhciBzdHIgPSBKU09OLnN0cmluZ2lmeShkZXN0KTsKICAgICAgICByZXR1cm4gdGhpcy5nZXRBbmNob3JVcmwoIiMiICsgZXNjYXBlKHN0cikpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5nZXRBbmNob3JVcmwoIiIpOwogICAgfQogIH0sIHsKICAgIGtleTogImdldEFuY2hvclVybCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0QW5jaG9yVXJsKGFuY2hvcikgewogICAgICByZXR1cm4gKHRoaXMuYmFzZVVybCB8fCAiIikgKyBhbmNob3I7CiAgICB9CiAgfSwgewogICAga2V5OiAic2V0SGFzaCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2V0SGFzaChoYXNoKSB7CiAgICAgIHZhciBwYWdlTnVtYmVyLCBkZXN0OwoKICAgICAgaWYgKGhhc2guaW5jbHVkZXMoIj0iKSkgewogICAgICAgIHZhciBwYXJhbXMgPSAoMCwgX3VpX3V0aWxzLnBhcnNlUXVlcnlTdHJpbmcpKGhhc2gpOwoKICAgICAgICBpZiAoInNlYXJjaCIgaW4gcGFyYW1zKSB7CiAgICAgICAgICB0aGlzLmV2ZW50QnVzLmRpc3BhdGNoKCJmaW5kZnJvbXVybGhhc2giLCB7CiAgICAgICAgICAgIHNvdXJjZTogdGhpcywKICAgICAgICAgICAgcXVlcnk6IHBhcmFtcy5zZWFyY2gucmVwbGFjZSgvIi9nLCAiIiksCiAgICAgICAgICAgIHBocmFzZVNlYXJjaDogcGFyYW1zLnBocmFzZSA9PT0gInRydWUiCiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGlmICgicGFnZSIgaW4gcGFyYW1zKSB7CiAgICAgICAgICBwYWdlTnVtYmVyID0gcGFyYW1zLnBhZ2UgfCAwIHx8IDE7CiAgICAgICAgfQoKICAgICAgICBpZiAoInpvb20iIGluIHBhcmFtcykgewogICAgICAgICAgdmFyIHpvb21BcmdzID0gcGFyYW1zLnpvb20uc3BsaXQoIiwiKTsKICAgICAgICAgIHZhciB6b29tQXJnID0gem9vbUFyZ3NbMF07CiAgICAgICAgICB2YXIgem9vbUFyZ051bWJlciA9IHBhcnNlRmxvYXQoem9vbUFyZyk7CgogICAgICAgICAgaWYgKCF6b29tQXJnLmluY2x1ZGVzKCJGaXQiKSkgewogICAgICAgICAgICBkZXN0ID0gW251bGwsIHsKICAgICAgICAgICAgICBuYW1lOiAiWFlaIgogICAgICAgICAgICB9LCB6b29tQXJncy5sZW5ndGggPiAxID8gem9vbUFyZ3NbMV0gfCAwIDogbnVsbCwgem9vbUFyZ3MubGVuZ3RoID4gMiA/IHpvb21BcmdzWzJdIHwgMCA6IG51bGwsIHpvb21BcmdOdW1iZXIgPyB6b29tQXJnTnVtYmVyIC8gMTAwIDogem9vbUFyZ107CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoem9vbUFyZyA9PT0gIkZpdCIgfHwgem9vbUFyZyA9PT0gIkZpdEIiKSB7CiAgICAgICAgICAgICAgZGVzdCA9IFtudWxsLCB7CiAgICAgICAgICAgICAgICBuYW1lOiB6b29tQXJnCiAgICAgICAgICAgICAgfV07CiAgICAgICAgICAgIH0gZWxzZSBpZiAoem9vbUFyZyA9PT0gIkZpdEgiIHx8IHpvb21BcmcgPT09ICJGaXRCSCIgfHwgem9vbUFyZyA9PT0gIkZpdFYiIHx8IHpvb21BcmcgPT09ICJGaXRCViIpIHsKICAgICAgICAgICAgICBkZXN0ID0gW251bGwsIHsKICAgICAgICAgICAgICAgIG5hbWU6IHpvb21BcmcKICAgICAgICAgICAgICB9LCB6b29tQXJncy5sZW5ndGggPiAxID8gem9vbUFyZ3NbMV0gfCAwIDogbnVsbF07CiAgICAgICAgICAgIH0gZWxzZSBpZiAoem9vbUFyZyA9PT0gIkZpdFIiKSB7CiAgICAgICAgICAgICAgaWYgKHpvb21BcmdzLmxlbmd0aCAhPT0gNSkgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignUERGTGlua1NlcnZpY2Uuc2V0SGFzaDogTm90IGVub3VnaCBwYXJhbWV0ZXJzIGZvciAiRml0UiIuJyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRlc3QgPSBbbnVsbCwgewogICAgICAgICAgICAgICAgICBuYW1lOiB6b29tQXJnCiAgICAgICAgICAgICAgICB9LCB6b29tQXJnc1sxXSB8IDAsIHpvb21BcmdzWzJdIHwgMCwgem9vbUFyZ3NbM10gfCAwLCB6b29tQXJnc1s0XSB8IDBdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCJQREZMaW5rU2VydmljZS5zZXRIYXNoOiBcIiIuY29uY2F0KHpvb21BcmcsICJcIiBpcyBub3QgIikgKyAiYSB2YWxpZCB6b29tIHZhbHVlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoZGVzdCkgewogICAgICAgICAgdGhpcy5wZGZWaWV3ZXIuc2Nyb2xsUGFnZUludG9WaWV3KHsKICAgICAgICAgICAgcGFnZU51bWJlcjogcGFnZU51bWJlciB8fCB0aGlzLnBhZ2UsCiAgICAgICAgICAgIGRlc3RBcnJheTogZGVzdCwKICAgICAgICAgICAgYWxsb3dOZWdhdGl2ZU9mZnNldDogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmIChwYWdlTnVtYmVyKSB7CiAgICAgICAgICB0aGlzLnBhZ2UgPSBwYWdlTnVtYmVyOwogICAgICAgIH0KCiAgICAgICAgaWYgKCJwYWdlbW9kZSIgaW4gcGFyYW1zKSB7CiAgICAgICAgICB0aGlzLmV2ZW50QnVzLmRpc3BhdGNoKCJwYWdlbW9kZSIsIHsKICAgICAgICAgICAgc291cmNlOiB0aGlzLAogICAgICAgICAgICBtb2RlOiBwYXJhbXMucGFnZW1vZGUKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaWYgKCJuYW1lZGRlc3QiIGluIHBhcmFtcykgewogICAgICAgICAgdGhpcy5uYXZpZ2F0ZVRvKHBhcmFtcy5uYW1lZGRlc3QpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBkZXN0ID0gdW5lc2NhcGUoaGFzaCk7CgogICAgICAgIHRyeSB7CiAgICAgICAgICBkZXN0ID0gSlNPTi5wYXJzZShkZXN0KTsKCiAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkoZGVzdCkpIHsKICAgICAgICAgICAgZGVzdCA9IGRlc3QudG9TdHJpbmcoKTsKICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChleCkge30KCiAgICAgICAgaWYgKHR5cGVvZiBkZXN0ID09PSAic3RyaW5nIiB8fCBpc1ZhbGlkRXhwbGljaXREZXN0aW5hdGlvbihkZXN0KSkgewogICAgICAgICAgdGhpcy5uYXZpZ2F0ZVRvKGRlc3QpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29uc29sZS5lcnJvcigiUERGTGlua1NlcnZpY2Uuc2V0SGFzaDogXCIiLmNvbmNhdCh1bmVzY2FwZShoYXNoKSwgIlwiIGlzIG5vdCAiKSArICJhIHZhbGlkIGRlc3RpbmF0aW9uLiIpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAiZXhlY3V0ZU5hbWVkQWN0aW9uIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBleGVjdXRlTmFtZWRBY3Rpb24oYWN0aW9uKSB7CiAgICAgIHN3aXRjaCAoYWN0aW9uKSB7CiAgICAgICAgY2FzZSAiR29CYWNrIjoKICAgICAgICAgIGlmICh0aGlzLnBkZkhpc3RvcnkpIHsKICAgICAgICAgICAgdGhpcy5wZGZIaXN0b3J5LmJhY2soKTsKICAgICAgICAgIH0KCiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAiR29Gb3J3YXJkIjoKICAgICAgICAgIGlmICh0aGlzLnBkZkhpc3RvcnkpIHsKICAgICAgICAgICAgdGhpcy5wZGZIaXN0b3J5LmZvcndhcmQoKTsKICAgICAgICAgIH0KCiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAiTmV4dFBhZ2UiOgogICAgICAgICAgaWYgKHRoaXMucGFnZSA8IHRoaXMucGFnZXNDb3VudCkgewogICAgICAgICAgICB0aGlzLnBhZ2UrKzsKICAgICAgICAgIH0KCiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAiUHJldlBhZ2UiOgogICAgICAgICAgaWYgKHRoaXMucGFnZSA+IDEpIHsKICAgICAgICAgICAgdGhpcy5wYWdlLS07CiAgICAgICAgICB9CgogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgIkxhc3RQYWdlIjoKICAgICAgICAgIHRoaXMucGFnZSA9IHRoaXMucGFnZXNDb3VudDsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICJGaXJzdFBhZ2UiOgogICAgICAgICAgdGhpcy5wYWdlID0gMTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgYnJlYWs7CiAgICAgIH0KCiAgICAgIHRoaXMuZXZlbnRCdXMuZGlzcGF0Y2goIm5hbWVkYWN0aW9uIiwgewogICAgICAgIHNvdXJjZTogdGhpcywKICAgICAgICBhY3Rpb246IGFjdGlvbgogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJjYWNoZVBhZ2VSZWYiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNhY2hlUGFnZVJlZihwYWdlTnVtLCBwYWdlUmVmKSB7CiAgICAgIGlmICghcGFnZVJlZikgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHJlZlN0ciA9IHBhZ2VSZWYuZ2VuID09PSAwID8gIiIuY29uY2F0KHBhZ2VSZWYubnVtLCAiUiIpIDogIiIuY29uY2F0KHBhZ2VSZWYubnVtLCAiUiIpLmNvbmNhdChwYWdlUmVmLmdlbik7CiAgICAgIHRoaXMuX3BhZ2VzUmVmQ2FjaGVbcmVmU3RyXSA9IHBhZ2VOdW07CiAgICB9CiAgfSwgewogICAga2V5OiAiX2NhY2hlZFBhZ2VOdW1iZXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9jYWNoZWRQYWdlTnVtYmVyKHBhZ2VSZWYpIHsKICAgICAgdmFyIHJlZlN0ciA9IHBhZ2VSZWYuZ2VuID09PSAwID8gIiIuY29uY2F0KHBhZ2VSZWYubnVtLCAiUiIpIDogIiIuY29uY2F0KHBhZ2VSZWYubnVtLCAiUiIpLmNvbmNhdChwYWdlUmVmLmdlbik7CiAgICAgIHJldHVybiB0aGlzLl9wYWdlc1JlZkNhY2hlICYmIHRoaXMuX3BhZ2VzUmVmQ2FjaGVbcmVmU3RyXSB8fCBudWxsOwogICAgfQogIH0sIHsKICAgIGtleTogImlzUGFnZVZpc2libGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGlzUGFnZVZpc2libGUocGFnZU51bWJlcikgewogICAgICByZXR1cm4gdGhpcy5wZGZWaWV3ZXIuaXNQYWdlVmlzaWJsZShwYWdlTnVtYmVyKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJwYWdlc0NvdW50IiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5wZGZEb2N1bWVudCA/IHRoaXMucGRmRG9jdW1lbnQubnVtUGFnZXMgOiAwOwogICAgfQogIH0sIHsKICAgIGtleTogInBhZ2UiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLnBkZlZpZXdlci5jdXJyZW50UGFnZU51bWJlcjsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uIHNldCh2YWx1ZSkgewogICAgICB0aGlzLnBkZlZpZXdlci5jdXJyZW50UGFnZU51bWJlciA9IHZhbHVlOwogICAgfQogIH0sIHsKICAgIGtleTogInJvdGF0aW9uIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5wZGZWaWV3ZXIucGFnZXNSb3RhdGlvbjsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uIHNldCh2YWx1ZSkgewogICAgICB0aGlzLnBkZlZpZXdlci5wYWdlc1JvdGF0aW9uID0gdmFsdWU7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gUERGTGlua1NlcnZpY2U7Cn0oKTsKCmV4cG9ydHMuUERGTGlua1NlcnZpY2UgPSBQREZMaW5rU2VydmljZTsKCmZ1bmN0aW9uIGlzVmFsaWRFeHBsaWNpdERlc3RpbmF0aW9uKGRlc3QpIHsKICBpZiAoIUFycmF5LmlzQXJyYXkoZGVzdCkpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIHZhciBkZXN0TGVuZ3RoID0gZGVzdC5sZW5ndGg7CgogIGlmIChkZXN0TGVuZ3RoIDwgMikgewogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgdmFyIHBhZ2UgPSBkZXN0WzBdOwoKICBpZiAoIShfdHlwZW9mKHBhZ2UpID09PSAib2JqZWN0IiAmJiBOdW1iZXIuaXNJbnRlZ2VyKHBhZ2UubnVtKSAmJiBOdW1iZXIuaXNJbnRlZ2VyKHBhZ2UuZ2VuKSkgJiYgIShOdW1iZXIuaXNJbnRlZ2VyKHBhZ2UpICYmIHBhZ2UgPj0gMCkpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIHZhciB6b29tID0gZGVzdFsxXTsKCiAgaWYgKCEoX3R5cGVvZih6b29tKSA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHpvb20ubmFtZSA9PT0gInN0cmluZyIpKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICB2YXIgYWxsb3dOdWxsID0gdHJ1ZTsKCiAgc3dpdGNoICh6b29tLm5hbWUpIHsKICAgIGNhc2UgIlhZWiI6CiAgICAgIGlmIChkZXN0TGVuZ3RoICE9PSA1KSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICBicmVhazsKCiAgICBjYXNlICJGaXQiOgogICAgY2FzZSAiRml0QiI6CiAgICAgIHJldHVybiBkZXN0TGVuZ3RoID09PSAyOwoKICAgIGNhc2UgIkZpdEgiOgogICAgY2FzZSAiRml0QkgiOgogICAgY2FzZSAiRml0ViI6CiAgICBjYXNlICJGaXRCViI6CiAgICAgIGlmIChkZXN0TGVuZ3RoICE9PSAzKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICBicmVhazsKCiAgICBjYXNlICJGaXRSIjoKICAgICAgaWYgKGRlc3RMZW5ndGggIT09IDYpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGFsbG93TnVsbCA9IGZhbHNlOwogICAgICBicmVhazsKCiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gZmFsc2U7CiAgfQoKICBmb3IgKHZhciBpID0gMjsgaSA8IGRlc3RMZW5ndGg7IGkrKykgewogICAgdmFyIHBhcmFtID0gZGVzdFtpXTsKCiAgICBpZiAoISh0eXBlb2YgcGFyYW0gPT09ICJudW1iZXIiIHx8IGFsbG93TnVsbCAmJiBwYXJhbSA9PT0gbnVsbCkpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KCiAgcmV0dXJuIHRydWU7Cn0KCnZhciBTaW1wbGVMaW5rU2VydmljZSA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gU2ltcGxlTGlua1NlcnZpY2UoKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgU2ltcGxlTGlua1NlcnZpY2UpOwoKICAgIHRoaXMuZXh0ZXJuYWxMaW5rVGFyZ2V0ID0gbnVsbDsKICAgIHRoaXMuZXh0ZXJuYWxMaW5rUmVsID0gbnVsbDsKICAgIHRoaXMuZXh0ZXJuYWxMaW5rRW5hYmxlZCA9IHRydWU7CiAgICB0aGlzLl9pZ25vcmVEZXN0aW5hdGlvblpvb20gPSBmYWxzZTsKICB9CgogIF9jcmVhdGVDbGFzcyhTaW1wbGVMaW5rU2VydmljZSwgW3sKICAgIGtleTogIm5hdmlnYXRlVG8iLAogICAgdmFsdWU6IGZ1bmN0aW9uIG5hdmlnYXRlVG8oZGVzdCkge30KICB9LCB7CiAgICBrZXk6ICJnZXREZXN0aW5hdGlvbkhhc2giLAogICAgdmFsdWU6IGZ1bmN0aW9uIGdldERlc3RpbmF0aW9uSGFzaChkZXN0KSB7CiAgICAgIHJldHVybiAiIyI7CiAgICB9CiAgfSwgewogICAga2V5OiAiZ2V0QW5jaG9yVXJsIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRBbmNob3JVcmwoaGFzaCkgewogICAgICByZXR1cm4gIiMiOwogICAgfQogIH0sIHsKICAgIGtleTogInNldEhhc2giLAogICAgdmFsdWU6IGZ1bmN0aW9uIHNldEhhc2goaGFzaCkge30KICB9LCB7CiAgICBrZXk6ICJleGVjdXRlTmFtZWRBY3Rpb24iLAogICAgdmFsdWU6IGZ1bmN0aW9uIGV4ZWN1dGVOYW1lZEFjdGlvbihhY3Rpb24pIHt9CiAgfSwgewogICAga2V5OiAiY2FjaGVQYWdlUmVmIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjYWNoZVBhZ2VSZWYocGFnZU51bSwgcGFnZVJlZikge30KICB9LCB7CiAgICBrZXk6ICJpc1BhZ2VWaXNpYmxlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBpc1BhZ2VWaXNpYmxlKHBhZ2VOdW1iZXIpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfSwgewogICAga2V5OiAicGFnZXNDb3VudCIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIDA7CiAgICB9CiAgfSwgewogICAga2V5OiAicGFnZSIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIDA7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbiBzZXQodmFsdWUpIHt9CiAgfSwgewogICAga2V5OiAicm90YXRpb24iLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiAwOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24gc2V0KHZhbHVlKSB7fQogIH1dKTsKCiAgcmV0dXJuIFNpbXBsZUxpbmtTZXJ2aWNlOwp9KCk7CgpleHBvcnRzLlNpbXBsZUxpbmtTZXJ2aWNlID0gU2ltcGxlTGlua1NlcnZpY2U7CgovKioqLyB9KSwKLyogMjIgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKInVzZSBzdHJpY3QiOwoKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKZXhwb3J0cy5QREZPdXRsaW5lVmlld2VyID0gdm9pZCAwOwoKdmFyIF9wZGZqc0xpYiA9IF9fd2VicGFja19yZXF1aXJlX18oOCk7CgpmdW5jdGlvbiBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcihvLCBhbGxvd0FycmF5TGlrZSkgeyB2YXIgaXQ7IGlmICh0eXBlb2YgU3ltYm9sID09PSAidW5kZWZpbmVkIiB8fCBvW1N5bWJvbC5pdGVyYXRvcl0gPT0gbnVsbCkgeyBpZiAoQXJyYXkuaXNBcnJheShvKSB8fCAoaXQgPSBfdW5zdXBwb3J0ZWRJdGVyYWJsZVRvQXJyYXkobykpIHx8IGFsbG93QXJyYXlMaWtlICYmIG8gJiYgdHlwZW9mIG8ubGVuZ3RoID09PSAibnVtYmVyIikgeyBpZiAoaXQpIG8gPSBpdDsgdmFyIGkgPSAwOyB2YXIgRiA9IGZ1bmN0aW9uIEYoKSB7fTsgcmV0dXJuIHsgczogRiwgbjogZnVuY3Rpb24gbigpIHsgaWYgKGkgPj0gby5sZW5ndGgpIHJldHVybiB7IGRvbmU6IHRydWUgfTsgcmV0dXJuIHsgZG9uZTogZmFsc2UsIHZhbHVlOiBvW2krK10gfTsgfSwgZTogZnVuY3Rpb24gZShfZSkgeyB0aHJvdyBfZTsgfSwgZjogRiB9OyB9IHRocm93IG5ldyBUeXBlRXJyb3IoIkludmFsaWQgYXR0ZW1wdCB0byBpdGVyYXRlIG5vbi1pdGVyYWJsZSBpbnN0YW5jZS5cbkluIG9yZGVyIHRvIGJlIGl0ZXJhYmxlLCBub24tYXJyYXkgb2JqZWN0cyBtdXN0IGhhdmUgYSBbU3ltYm9sLml0ZXJhdG9yXSgpIG1ldGhvZC4iKTsgfSB2YXIgbm9ybWFsQ29tcGxldGlvbiA9IHRydWUsIGRpZEVyciA9IGZhbHNlLCBlcnI7IHJldHVybiB7IHM6IGZ1bmN0aW9uIHMoKSB7IGl0ID0gb1tTeW1ib2wuaXRlcmF0b3JdKCk7IH0sIG46IGZ1bmN0aW9uIG4oKSB7IHZhciBzdGVwID0gaXQubmV4dCgpOyBub3JtYWxDb21wbGV0aW9uID0gc3RlcC5kb25lOyByZXR1cm4gc3RlcDsgfSwgZTogZnVuY3Rpb24gZShfZTIpIHsgZGlkRXJyID0gdHJ1ZTsgZXJyID0gX2UyOyB9LCBmOiBmdW5jdGlvbiBmKCkgeyB0cnkgeyBpZiAoIW5vcm1hbENvbXBsZXRpb24gJiYgaXRbInJldHVybiJdICE9IG51bGwpIGl0WyJyZXR1cm4iXSgpOyB9IGZpbmFsbHkgeyBpZiAoZGlkRXJyKSB0aHJvdyBlcnI7IH0gfSB9OyB9CgpmdW5jdGlvbiBfdW5zdXBwb3J0ZWRJdGVyYWJsZVRvQXJyYXkobywgbWluTGVuKSB7IGlmICghbykgcmV0dXJuOyBpZiAodHlwZW9mIG8gPT09ICJzdHJpbmciKSByZXR1cm4gX2FycmF5TGlrZVRvQXJyYXkobywgbWluTGVuKTsgdmFyIG4gPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwobykuc2xpY2UoOCwgLTEpOyBpZiAobiA9PT0gIk9iamVjdCIgJiYgby5jb25zdHJ1Y3RvcikgbiA9IG8uY29uc3RydWN0b3IubmFtZTsgaWYgKG4gPT09ICJNYXAiIHx8IG4gPT09ICJTZXQiKSByZXR1cm4gQXJyYXkuZnJvbShvKTsgaWYgKG4gPT09ICJBcmd1bWVudHMiIHx8IC9eKD86VWl8SSludCg/Ojh8MTZ8MzIpKD86Q2xhbXBlZCk/QXJyYXkkLy50ZXN0KG4pKSByZXR1cm4gX2FycmF5TGlrZVRvQXJyYXkobywgbWluTGVuKTsgfQoKZnVuY3Rpb24gX2FycmF5TGlrZVRvQXJyYXkoYXJyLCBsZW4pIHsgaWYgKGxlbiA9PSBudWxsIHx8IGxlbiA+IGFyci5sZW5ndGgpIGxlbiA9IGFyci5sZW5ndGg7IGZvciAodmFyIGkgPSAwLCBhcnIyID0gbmV3IEFycmF5KGxlbik7IGkgPCBsZW47IGkrKykgeyBhcnIyW2ldID0gYXJyW2ldOyB9IHJldHVybiBhcnIyOyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOyB9IH0KCmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9CgpmdW5jdGlvbiBfY3JlYXRlQ2xhc3MoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfQoKdmFyIERFRkFVTFRfVElUTEUgPSAiXHUyMDEzIjsKCnZhciBQREZPdXRsaW5lVmlld2VyID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICBmdW5jdGlvbiBQREZPdXRsaW5lVmlld2VyKF9yZWYpIHsKICAgIHZhciBjb250YWluZXIgPSBfcmVmLmNvbnRhaW5lciwKICAgICAgICBsaW5rU2VydmljZSA9IF9yZWYubGlua1NlcnZpY2UsCiAgICAgICAgZXZlbnRCdXMgPSBfcmVmLmV2ZW50QnVzOwoKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBQREZPdXRsaW5lVmlld2VyKTsKCiAgICB0aGlzLmNvbnRhaW5lciA9IGNvbnRhaW5lcjsKICAgIHRoaXMubGlua1NlcnZpY2UgPSBsaW5rU2VydmljZTsKICAgIHRoaXMuZXZlbnRCdXMgPSBldmVudEJ1czsKICAgIHRoaXMucmVzZXQoKTsKCiAgICBldmVudEJ1cy5fb24oInRvZ2dsZW91dGxpbmV0cmVlIiwgdGhpcy50b2dnbGVPdXRsaW5lVHJlZS5iaW5kKHRoaXMpKTsKICB9CgogIF9jcmVhdGVDbGFzcyhQREZPdXRsaW5lVmlld2VyLCBbewogICAga2V5OiAicmVzZXQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlc2V0KCkgewogICAgICB0aGlzLm91dGxpbmUgPSBudWxsOwogICAgICB0aGlzLmxhc3RUb2dnbGVJc1Nob3cgPSB0cnVlOwogICAgICB0aGlzLmNvbnRhaW5lci50ZXh0Q29udGVudCA9ICIiOwogICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCJvdXRsaW5lV2l0aERlZXBOZXN0aW5nIik7CiAgICB9CiAgfSwgewogICAga2V5OiAiX2Rpc3BhdGNoRXZlbnQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9kaXNwYXRjaEV2ZW50KG91dGxpbmVDb3VudCkgewogICAgICB0aGlzLmV2ZW50QnVzLmRpc3BhdGNoKCJvdXRsaW5lbG9hZGVkIiwgewogICAgICAgIHNvdXJjZTogdGhpcywKICAgICAgICBvdXRsaW5lQ291bnQ6IG91dGxpbmVDb3VudAogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfYmluZExpbmsiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9iaW5kTGluayhlbGVtZW50LCBfcmVmMikgewogICAgICB2YXIgdXJsID0gX3JlZjIudXJsLAogICAgICAgICAgbmV3V2luZG93ID0gX3JlZjIubmV3V2luZG93LAogICAgICAgICAgZGVzdCA9IF9yZWYyLmRlc3Q7CiAgICAgIHZhciBsaW5rU2VydmljZSA9IHRoaXMubGlua1NlcnZpY2U7CgogICAgICBpZiAodXJsKSB7CiAgICAgICAgKDAsIF9wZGZqc0xpYi5hZGRMaW5rQXR0cmlidXRlcykoZWxlbWVudCwgewogICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICB0YXJnZXQ6IG5ld1dpbmRvdyA/IF9wZGZqc0xpYi5MaW5rVGFyZ2V0LkJMQU5LIDogbGlua1NlcnZpY2UuZXh0ZXJuYWxMaW5rVGFyZ2V0LAogICAgICAgICAgcmVsOiBsaW5rU2VydmljZS5leHRlcm5hbExpbmtSZWwsCiAgICAgICAgICBlbmFibGVkOiBsaW5rU2VydmljZS5leHRlcm5hbExpbmtFbmFibGVkCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBlbGVtZW50LmhyZWYgPSBsaW5rU2VydmljZS5nZXREZXN0aW5hdGlvbkhhc2goZGVzdCk7CgogICAgICBlbGVtZW50Lm9uY2xpY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKGRlc3QpIHsKICAgICAgICAgIGxpbmtTZXJ2aWNlLm5hdmlnYXRlVG8oZGVzdCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH07CiAgICB9CiAgfSwgewogICAga2V5OiAiX3NldFN0eWxlcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3NldFN0eWxlcyhlbGVtZW50LCBfcmVmMykgewogICAgICB2YXIgYm9sZCA9IF9yZWYzLmJvbGQsCiAgICAgICAgICBpdGFsaWMgPSBfcmVmMy5pdGFsaWM7CgogICAgICBpZiAoYm9sZCkgewogICAgICAgIGVsZW1lbnQuc3R5bGUuZm9udFdlaWdodCA9ICJib2xkIjsKICAgICAgfQoKICAgICAgaWYgKGl0YWxpYykgewogICAgICAgIGVsZW1lbnQuc3R5bGUuZm9udFN0eWxlID0gIml0YWxpYyI7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJfYWRkVG9nZ2xlQnV0dG9uIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfYWRkVG9nZ2xlQnV0dG9uKGRpdiwgX3JlZjQpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHZhciBjb3VudCA9IF9yZWY0LmNvdW50LAogICAgICAgICAgaXRlbXMgPSBfcmVmNC5pdGVtczsKICAgICAgdmFyIHRvZ2dsZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgdG9nZ2xlci5jbGFzc05hbWUgPSAib3V0bGluZUl0ZW1Ub2dnbGVyIjsKCiAgICAgIGlmIChjb3VudCA8IDAgJiYgTWF0aC5hYnMoY291bnQpID09PSBpdGVtcy5sZW5ndGgpIHsKICAgICAgICB0b2dnbGVyLmNsYXNzTGlzdC5hZGQoIm91dGxpbmVJdGVtc0hpZGRlbiIpOwogICAgICB9CgogICAgICB0b2dnbGVyLm9uY2xpY2sgPSBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgICAgZXZ0LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgIHRvZ2dsZXIuY2xhc3NMaXN0LnRvZ2dsZSgib3V0bGluZUl0ZW1zSGlkZGVuIik7CgogICAgICAgIGlmIChldnQuc2hpZnRLZXkpIHsKICAgICAgICAgIHZhciBzaG91bGRTaG93QWxsID0gIXRvZ2dsZXIuY2xhc3NMaXN0LmNvbnRhaW5zKCJvdXRsaW5lSXRlbXNIaWRkZW4iKTsKCiAgICAgICAgICBfdGhpcy5fdG9nZ2xlT3V0bGluZUl0ZW0oZGl2LCBzaG91bGRTaG93QWxsKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBkaXYuaW5zZXJ0QmVmb3JlKHRvZ2dsZXIsIGRpdi5maXJzdENoaWxkKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfdG9nZ2xlT3V0bGluZUl0ZW0iLAogICAgdmFsdWU6IGZ1bmN0aW9uIF90b2dnbGVPdXRsaW5lSXRlbShyb290KSB7CiAgICAgIHZhciBzaG93ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiBmYWxzZTsKICAgICAgdGhpcy5sYXN0VG9nZ2xlSXNTaG93ID0gc2hvdzsKCiAgICAgIHZhciBfaXRlcmF0b3IgPSBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcihyb290LnF1ZXJ5U2VsZWN0b3JBbGwoIi5vdXRsaW5lSXRlbVRvZ2dsZXIiKSksCiAgICAgICAgICBfc3RlcDsKCiAgICAgIHRyeSB7CiAgICAgICAgZm9yIChfaXRlcmF0b3IucygpOyAhKF9zdGVwID0gX2l0ZXJhdG9yLm4oKSkuZG9uZTspIHsKICAgICAgICAgIHZhciB0b2dnbGVyID0gX3N0ZXAudmFsdWU7CiAgICAgICAgICB0b2dnbGVyLmNsYXNzTGlzdC50b2dnbGUoIm91dGxpbmVJdGVtc0hpZGRlbiIsICFzaG93KTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIF9pdGVyYXRvci5lKGVycik7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgX2l0ZXJhdG9yLmYoKTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogInRvZ2dsZU91dGxpbmVUcmVlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB0b2dnbGVPdXRsaW5lVHJlZSgpIHsKICAgICAgaWYgKCF0aGlzLm91dGxpbmUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMuX3RvZ2dsZU91dGxpbmVJdGVtKHRoaXMuY29udGFpbmVyLCAhdGhpcy5sYXN0VG9nZ2xlSXNTaG93KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJyZW5kZXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlbmRlcihfcmVmNSkgewogICAgICB2YXIgb3V0bGluZSA9IF9yZWY1Lm91dGxpbmU7CiAgICAgIHZhciBvdXRsaW5lQ291bnQgPSAwOwoKICAgICAgaWYgKHRoaXMub3V0bGluZSkgewogICAgICAgIHRoaXMucmVzZXQoKTsKICAgICAgfQoKICAgICAgdGhpcy5vdXRsaW5lID0gb3V0bGluZSB8fCBudWxsOwoKICAgICAgaWYgKCFvdXRsaW5lKSB7CiAgICAgICAgdGhpcy5fZGlzcGF0Y2hFdmVudChvdXRsaW5lQ291bnQpOwoKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgdmFyIHF1ZXVlID0gW3sKICAgICAgICBwYXJlbnQ6IGZyYWdtZW50LAogICAgICAgIGl0ZW1zOiB0aGlzLm91dGxpbmUKICAgICAgfV07CiAgICAgIHZhciBoYXNBbnlOZXN0aW5nID0gZmFsc2U7CgogICAgICB3aGlsZSAocXVldWUubGVuZ3RoID4gMCkgewogICAgICAgIHZhciBsZXZlbERhdGEgPSBxdWV1ZS5zaGlmdCgpOwoKICAgICAgICB2YXIgX2l0ZXJhdG9yMiA9IF9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyKGxldmVsRGF0YS5pdGVtcyksCiAgICAgICAgICAgIF9zdGVwMjsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIGZvciAoX2l0ZXJhdG9yMi5zKCk7ICEoX3N0ZXAyID0gX2l0ZXJhdG9yMi5uKCkpLmRvbmU7KSB7CiAgICAgICAgICAgIHZhciBpdGVtID0gX3N0ZXAyLnZhbHVlOwogICAgICAgICAgICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgIGRpdi5jbGFzc05hbWUgPSAib3V0bGluZUl0ZW0iOwogICAgICAgICAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsKCiAgICAgICAgICAgIHRoaXMuX2JpbmRMaW5rKGVsZW1lbnQsIGl0ZW0pOwoKICAgICAgICAgICAgdGhpcy5fc2V0U3R5bGVzKGVsZW1lbnQsIGl0ZW0pOwoKICAgICAgICAgICAgZWxlbWVudC50ZXh0Q29udGVudCA9ICgwLCBfcGRmanNMaWIucmVtb3ZlTnVsbENoYXJhY3RlcnMpKGl0ZW0udGl0bGUpIHx8IERFRkFVTFRfVElUTEU7CiAgICAgICAgICAgIGRpdi5hcHBlbmRDaGlsZChlbGVtZW50KTsKCiAgICAgICAgICAgIGlmIChpdGVtLml0ZW1zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBoYXNBbnlOZXN0aW5nID0gdHJ1ZTsKCiAgICAgICAgICAgICAgdGhpcy5fYWRkVG9nZ2xlQnV0dG9uKGRpdiwgaXRlbSk7CgogICAgICAgICAgICAgIHZhciBpdGVtc0RpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICAgIGl0ZW1zRGl2LmNsYXNzTmFtZSA9ICJvdXRsaW5lSXRlbXMiOwogICAgICAgICAgICAgIGRpdi5hcHBlbmRDaGlsZChpdGVtc0Rpdik7CiAgICAgICAgICAgICAgcXVldWUucHVzaCh7CiAgICAgICAgICAgICAgICBwYXJlbnQ6IGl0ZW1zRGl2LAogICAgICAgICAgICAgICAgaXRlbXM6IGl0ZW0uaXRlbXMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGV2ZWxEYXRhLnBhcmVudC5hcHBlbmRDaGlsZChkaXYpOwogICAgICAgICAgICBvdXRsaW5lQ291bnQrKzsKICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIF9pdGVyYXRvcjIuZShlcnIpOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBfaXRlcmF0b3IyLmYoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChoYXNBbnlOZXN0aW5nKSB7CiAgICAgICAgdGhpcy5jb250YWluZXIuY2xhc3NMaXN0LmFkZCgib3V0bGluZVdpdGhEZWVwTmVzdGluZyIpOwogICAgICAgIHRoaXMubGFzdFRvZ2dsZUlzU2hvdyA9IGZyYWdtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoIi5vdXRsaW5lSXRlbXNIaWRkZW4iKS5sZW5ndGggPT09IDA7CiAgICAgIH0KCiAgICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZENoaWxkKGZyYWdtZW50KTsKCiAgICAgIHRoaXMuX2Rpc3BhdGNoRXZlbnQob3V0bGluZUNvdW50KTsKICAgIH0KICB9XSk7CgogIHJldHVybiBQREZPdXRsaW5lVmlld2VyOwp9KCk7CgpleHBvcnRzLlBERk91dGxpbmVWaWV3ZXIgPSBQREZPdXRsaW5lVmlld2VyOwoKLyoqKi8gfSksCi8qIDIzICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuUERGUHJlc2VudGF0aW9uTW9kZSA9IHZvaWQgMDsKCnZhciBfdWlfdXRpbHMgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUpOwoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsgfSB9CgpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfQoKZnVuY3Rpb24gX2NyZWF0ZUNsYXNzKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH0KCnZhciBERUxBWV9CRUZPUkVfUkVTRVRUSU5HX1NXSVRDSF9JTl9QUk9HUkVTUyA9IDE1MDA7CnZhciBERUxBWV9CRUZPUkVfSElESU5HX0NPTlRST0xTID0gMzAwMDsKdmFyIEFDVElWRV9TRUxFQ1RPUiA9ICJwZGZQcmVzZW50YXRpb25Nb2RlIjsKdmFyIENPTlRST0xTX1NFTEVDVE9SID0gInBkZlByZXNlbnRhdGlvbk1vZGVDb250cm9scyI7CnZhciBNT1VTRV9TQ1JPTExfQ09PTERPV05fVElNRSA9IDUwOwp2YXIgUEFHRV9TV0lUQ0hfVEhSRVNIT0xEID0gMC4xOwp2YXIgU1dJUEVfTUlOX0RJU1RBTkNFX1RIUkVTSE9MRCA9IDUwOwp2YXIgU1dJUEVfQU5HTEVfVEhSRVNIT0xEID0gTWF0aC5QSSAvIDY7Cgp2YXIgUERGUHJlc2VudGF0aW9uTW9kZSA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gUERGUHJlc2VudGF0aW9uTW9kZShfcmVmKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIHZhciBjb250YWluZXIgPSBfcmVmLmNvbnRhaW5lciwKICAgICAgICBwZGZWaWV3ZXIgPSBfcmVmLnBkZlZpZXdlciwKICAgICAgICBldmVudEJ1cyA9IF9yZWYuZXZlbnRCdXMsCiAgICAgICAgX3JlZiRjb250ZXh0TWVudUl0ZW1zID0gX3JlZi5jb250ZXh0TWVudUl0ZW1zLAogICAgICAgIGNvbnRleHRNZW51SXRlbXMgPSBfcmVmJGNvbnRleHRNZW51SXRlbXMgPT09IHZvaWQgMCA/IG51bGwgOiBfcmVmJGNvbnRleHRNZW51SXRlbXM7CgogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFBERlByZXNlbnRhdGlvbk1vZGUpOwoKICAgIHRoaXMuY29udGFpbmVyID0gY29udGFpbmVyOwogICAgdGhpcy5wZGZWaWV3ZXIgPSBwZGZWaWV3ZXI7CiAgICB0aGlzLmV2ZW50QnVzID0gZXZlbnRCdXM7CiAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwogICAgdGhpcy5hcmdzID0gbnVsbDsKICAgIHRoaXMuY29udGV4dE1lbnVPcGVuID0gZmFsc2U7CiAgICB0aGlzLm1vdXNlU2Nyb2xsVGltZVN0YW1wID0gMDsKICAgIHRoaXMubW91c2VTY3JvbGxEZWx0YSA9IDA7CiAgICB0aGlzLnRvdWNoU3dpcGVTdGF0ZSA9IG51bGw7CgogICAgaWYgKGNvbnRleHRNZW51SXRlbXMpIHsKICAgICAgY29udGV4dE1lbnVJdGVtcy5jb250ZXh0Rmlyc3RQYWdlLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzLmNvbnRleHRNZW51T3BlbiA9IGZhbHNlOwoKICAgICAgICBfdGhpcy5ldmVudEJ1cy5kaXNwYXRjaCgiZmlyc3RwYWdlIiwgewogICAgICAgICAgc291cmNlOiBfdGhpcwogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgY29udGV4dE1lbnVJdGVtcy5jb250ZXh0TGFzdFBhZ2UuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgX3RoaXMuY29udGV4dE1lbnVPcGVuID0gZmFsc2U7CgogICAgICAgIF90aGlzLmV2ZW50QnVzLmRpc3BhdGNoKCJsYXN0cGFnZSIsIHsKICAgICAgICAgIHNvdXJjZTogX3RoaXMKICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIGNvbnRleHRNZW51SXRlbXMuY29udGV4dFBhZ2VSb3RhdGVDdy5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgICBfdGhpcy5jb250ZXh0TWVudU9wZW4gPSBmYWxzZTsKCiAgICAgICAgX3RoaXMuZXZlbnRCdXMuZGlzcGF0Y2goInJvdGF0ZWN3IiwgewogICAgICAgICAgc291cmNlOiBfdGhpcwogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgY29udGV4dE1lbnVJdGVtcy5jb250ZXh0UGFnZVJvdGF0ZUNjdy5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgICBfdGhpcy5jb250ZXh0TWVudU9wZW4gPSBmYWxzZTsKCiAgICAgICAgX3RoaXMuZXZlbnRCdXMuZGlzcGF0Y2goInJvdGF0ZWNjdyIsIHsKICAgICAgICAgIHNvdXJjZTogX3RoaXMKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfQoKICBfY3JlYXRlQ2xhc3MoUERGUHJlc2VudGF0aW9uTW9kZSwgW3sKICAgIGtleTogInJlcXVlc3QiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlcXVlc3QoKSB7CiAgICAgIGlmICh0aGlzLnN3aXRjaEluUHJvZ3Jlc3MgfHwgdGhpcy5hY3RpdmUgfHwgIXRoaXMucGRmVmlld2VyLnBhZ2VzQ291bnQpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHRoaXMuX2FkZEZ1bGxzY3JlZW5DaGFuZ2VMaXN0ZW5lcnMoKTsKCiAgICAgIHRoaXMuX3NldFN3aXRjaEluUHJvZ3Jlc3MoKTsKCiAgICAgIHRoaXMuX25vdGlmeVN0YXRlQ2hhbmdlKCk7CgogICAgICBpZiAodGhpcy5jb250YWluZXIucmVxdWVzdEZ1bGxzY3JlZW4pIHsKICAgICAgICB0aGlzLmNvbnRhaW5lci5yZXF1ZXN0RnVsbHNjcmVlbigpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuY29udGFpbmVyLm1velJlcXVlc3RGdWxsU2NyZWVuKSB7CiAgICAgICAgdGhpcy5jb250YWluZXIubW96UmVxdWVzdEZ1bGxTY3JlZW4oKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLmNvbnRhaW5lci53ZWJraXRSZXF1ZXN0RnVsbHNjcmVlbikgewogICAgICAgIHRoaXMuY29udGFpbmVyLndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuKEVsZW1lbnQuQUxMT1dfS0VZQk9BUkRfSU5QVVQpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuY29udGFpbmVyLm1zUmVxdWVzdEZ1bGxzY3JlZW4pIHsKICAgICAgICB0aGlzLmNvbnRhaW5lci5tc1JlcXVlc3RGdWxsc2NyZWVuKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICB0aGlzLmFyZ3MgPSB7CiAgICAgICAgcGFnZTogdGhpcy5wZGZWaWV3ZXIuY3VycmVudFBhZ2VOdW1iZXIsCiAgICAgICAgcHJldmlvdXNTY2FsZTogdGhpcy5wZGZWaWV3ZXIuY3VycmVudFNjYWxlVmFsdWUKICAgICAgfTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfSwgewogICAga2V5OiAiX21vdXNlV2hlZWwiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9tb3VzZVdoZWVsKGV2dCkgewogICAgICBpZiAoIXRoaXMuYWN0aXZlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBldnQucHJldmVudERlZmF1bHQoKTsKICAgICAgdmFyIGRlbHRhID0gKDAsIF91aV91dGlscy5ub3JtYWxpemVXaGVlbEV2ZW50RGVsdGEpKGV2dCk7CiAgICAgIHZhciBjdXJyZW50VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgICB2YXIgc3RvcmVkVGltZSA9IHRoaXMubW91c2VTY3JvbGxUaW1lU3RhbXA7CgogICAgICBpZiAoY3VycmVudFRpbWUgPiBzdG9yZWRUaW1lICYmIGN1cnJlbnRUaW1lIC0gc3RvcmVkVGltZSA8IE1PVVNFX1NDUk9MTF9DT09MRE9XTl9USU1FKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAodGhpcy5tb3VzZVNjcm9sbERlbHRhID4gMCAmJiBkZWx0YSA8IDAgfHwgdGhpcy5tb3VzZVNjcm9sbERlbHRhIDwgMCAmJiBkZWx0YSA+IDApIHsKICAgICAgICB0aGlzLl9yZXNldE1vdXNlU2Nyb2xsU3RhdGUoKTsKICAgICAgfQoKICAgICAgdGhpcy5tb3VzZVNjcm9sbERlbHRhICs9IGRlbHRhOwoKICAgICAgaWYgKE1hdGguYWJzKHRoaXMubW91c2VTY3JvbGxEZWx0YSkgPj0gUEFHRV9TV0lUQ0hfVEhSRVNIT0xEKSB7CiAgICAgICAgdmFyIHRvdGFsRGVsdGEgPSB0aGlzLm1vdXNlU2Nyb2xsRGVsdGE7CgogICAgICAgIHRoaXMuX3Jlc2V0TW91c2VTY3JvbGxTdGF0ZSgpOwoKICAgICAgICB2YXIgc3VjY2VzcyA9IHRvdGFsRGVsdGEgPiAwID8gdGhpcy5fZ29Ub1ByZXZpb3VzUGFnZSgpIDogdGhpcy5fZ29Ub05leHRQYWdlKCk7CgogICAgICAgIGlmIChzdWNjZXNzKSB7CiAgICAgICAgICB0aGlzLm1vdXNlU2Nyb2xsVGltZVN0YW1wID0gY3VycmVudFRpbWU7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAiX2dvVG9QcmV2aW91c1BhZ2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9nb1RvUHJldmlvdXNQYWdlKCkgewogICAgICB2YXIgcGFnZSA9IHRoaXMucGRmVmlld2VyLmN1cnJlbnRQYWdlTnVtYmVyOwoKICAgICAgaWYgKHBhZ2UgPD0gMSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgdGhpcy5wZGZWaWV3ZXIuY3VycmVudFBhZ2VOdW1iZXIgPSBwYWdlIC0gMTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfSwgewogICAga2V5OiAiX2dvVG9OZXh0UGFnZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2dvVG9OZXh0UGFnZSgpIHsKICAgICAgdmFyIHBhZ2UgPSB0aGlzLnBkZlZpZXdlci5jdXJyZW50UGFnZU51bWJlcjsKCiAgICAgIGlmIChwYWdlID49IHRoaXMucGRmVmlld2VyLnBhZ2VzQ291bnQpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHRoaXMucGRmVmlld2VyLmN1cnJlbnRQYWdlTnVtYmVyID0gcGFnZSArIDE7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0sIHsKICAgIGtleTogIl9ub3RpZnlTdGF0ZUNoYW5nZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX25vdGlmeVN0YXRlQ2hhbmdlKCkgewogICAgICB0aGlzLmV2ZW50QnVzLmRpc3BhdGNoKCJwcmVzZW50YXRpb25tb2RlY2hhbmdlZCIsIHsKICAgICAgICBzb3VyY2U6IHRoaXMsCiAgICAgICAgYWN0aXZlOiB0aGlzLmFjdGl2ZSwKICAgICAgICBzd2l0Y2hJblByb2dyZXNzOiAhIXRoaXMuc3dpdGNoSW5Qcm9ncmVzcwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfc2V0U3dpdGNoSW5Qcm9ncmVzcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3NldFN3aXRjaEluUHJvZ3Jlc3MoKSB7CiAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgaWYgKHRoaXMuc3dpdGNoSW5Qcm9ncmVzcykgewogICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnN3aXRjaEluUHJvZ3Jlc3MpOwogICAgICB9CgogICAgICB0aGlzLnN3aXRjaEluUHJvZ3Jlc3MgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICBfdGhpczIuX3JlbW92ZUZ1bGxzY3JlZW5DaGFuZ2VMaXN0ZW5lcnMoKTsKCiAgICAgICAgZGVsZXRlIF90aGlzMi5zd2l0Y2hJblByb2dyZXNzOwoKICAgICAgICBfdGhpczIuX25vdGlmeVN0YXRlQ2hhbmdlKCk7CiAgICAgIH0sIERFTEFZX0JFRk9SRV9SRVNFVFRJTkdfU1dJVENIX0lOX1BST0dSRVNTKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfcmVzZXRTd2l0Y2hJblByb2dyZXNzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfcmVzZXRTd2l0Y2hJblByb2dyZXNzKCkgewogICAgICBpZiAodGhpcy5zd2l0Y2hJblByb2dyZXNzKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuc3dpdGNoSW5Qcm9ncmVzcyk7CiAgICAgICAgZGVsZXRlIHRoaXMuc3dpdGNoSW5Qcm9ncmVzczsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogIl9lbnRlciIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2VudGVyKCkgewogICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgIHRoaXMuYWN0aXZlID0gdHJ1ZTsKCiAgICAgIHRoaXMuX3Jlc2V0U3dpdGNoSW5Qcm9ncmVzcygpOwoKICAgICAgdGhpcy5fbm90aWZ5U3RhdGVDaGFuZ2UoKTsKCiAgICAgIHRoaXMuY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoQUNUSVZFX1NFTEVDVE9SKTsKICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgX3RoaXMzLnBkZlZpZXdlci5jdXJyZW50UGFnZU51bWJlciA9IF90aGlzMy5hcmdzLnBhZ2U7CiAgICAgICAgX3RoaXMzLnBkZlZpZXdlci5jdXJyZW50U2NhbGVWYWx1ZSA9ICJwYWdlLWZpdCI7CiAgICAgIH0sIDApOwoKICAgICAgdGhpcy5fYWRkV2luZG93TGlzdGVuZXJzKCk7CgogICAgICB0aGlzLl9zaG93Q29udHJvbHMoKTsKCiAgICAgIHRoaXMuY29udGV4dE1lbnVPcGVuID0gZmFsc2U7CiAgICAgIHRoaXMuY29udGFpbmVyLnNldEF0dHJpYnV0ZSgiY29udGV4dG1lbnUiLCAidmlld2VyQ29udGV4dE1lbnUiKTsKICAgICAgd2luZG93LmdldFNlbGVjdGlvbigpLnJlbW92ZUFsbFJhbmdlcygpOwogICAgfQogIH0sIHsKICAgIGtleTogIl9leGl0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfZXhpdCgpIHsKICAgICAgdmFyIF90aGlzNCA9IHRoaXM7CgogICAgICB2YXIgcGFnZSA9IHRoaXMucGRmVmlld2VyLmN1cnJlbnRQYWdlTnVtYmVyOwogICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKEFDVElWRV9TRUxFQ1RPUik7CiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzNC5hY3RpdmUgPSBmYWxzZTsKCiAgICAgICAgX3RoaXM0Ll9yZW1vdmVGdWxsc2NyZWVuQ2hhbmdlTGlzdGVuZXJzKCk7CgogICAgICAgIF90aGlzNC5fbm90aWZ5U3RhdGVDaGFuZ2UoKTsKCiAgICAgICAgX3RoaXM0LnBkZlZpZXdlci5jdXJyZW50U2NhbGVWYWx1ZSA9IF90aGlzNC5hcmdzLnByZXZpb3VzU2NhbGU7CiAgICAgICAgX3RoaXM0LnBkZlZpZXdlci5jdXJyZW50UGFnZU51bWJlciA9IHBhZ2U7CiAgICAgICAgX3RoaXM0LmFyZ3MgPSBudWxsOwogICAgICB9LCAwKTsKCiAgICAgIHRoaXMuX3JlbW92ZVdpbmRvd0xpc3RlbmVycygpOwoKICAgICAgdGhpcy5faGlkZUNvbnRyb2xzKCk7CgogICAgICB0aGlzLl9yZXNldE1vdXNlU2Nyb2xsU3RhdGUoKTsKCiAgICAgIHRoaXMuY29udGFpbmVyLnJlbW92ZUF0dHJpYnV0ZSgiY29udGV4dG1lbnUiKTsKICAgICAgdGhpcy5jb250ZXh0TWVudU9wZW4gPSBmYWxzZTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfbW91c2VEb3duIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfbW91c2VEb3duKGV2dCkgewogICAgICBpZiAodGhpcy5jb250ZXh0TWVudU9wZW4pIHsKICAgICAgICB0aGlzLmNvbnRleHRNZW51T3BlbiA9IGZhbHNlOwogICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGV2dC5idXR0b24gPT09IDApIHsKICAgICAgICB2YXIgaXNJbnRlcm5hbExpbmsgPSBldnQudGFyZ2V0LmhyZWYgJiYgZXZ0LnRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoImludGVybmFsTGluayIpOwoKICAgICAgICBpZiAoIWlzSW50ZXJuYWxMaW5rKSB7CiAgICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsKCiAgICAgICAgICBpZiAoZXZ0LnNoaWZ0S2V5KSB7CiAgICAgICAgICAgIHRoaXMuX2dvVG9QcmV2aW91c1BhZ2UoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX2dvVG9OZXh0UGFnZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogIl9jb250ZXh0TWVudSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2NvbnRleHRNZW51KCkgewogICAgICB0aGlzLmNvbnRleHRNZW51T3BlbiA9IHRydWU7CiAgICB9CiAgfSwgewogICAga2V5OiAiX3Nob3dDb250cm9scyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3Nob3dDb250cm9scygpIHsKICAgICAgdmFyIF90aGlzNSA9IHRoaXM7CgogICAgICBpZiAodGhpcy5jb250cm9sc1RpbWVvdXQpIHsKICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5jb250cm9sc1RpbWVvdXQpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoQ09OVFJPTFNfU0VMRUNUT1IpOwogICAgICB9CgogICAgICB0aGlzLmNvbnRyb2xzVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzNS5jb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZShDT05UUk9MU19TRUxFQ1RPUik7CgogICAgICAgIGRlbGV0ZSBfdGhpczUuY29udHJvbHNUaW1lb3V0OwogICAgICB9LCBERUxBWV9CRUZPUkVfSElESU5HX0NPTlRST0xTKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfaGlkZUNvbnRyb2xzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfaGlkZUNvbnRyb2xzKCkgewogICAgICBpZiAoIXRoaXMuY29udHJvbHNUaW1lb3V0KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjbGVhclRpbWVvdXQodGhpcy5jb250cm9sc1RpbWVvdXQpOwogICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKENPTlRST0xTX1NFTEVDVE9SKTsKICAgICAgZGVsZXRlIHRoaXMuY29udHJvbHNUaW1lb3V0OwogICAgfQogIH0sIHsKICAgIGtleTogIl9yZXNldE1vdXNlU2Nyb2xsU3RhdGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9yZXNldE1vdXNlU2Nyb2xsU3RhdGUoKSB7CiAgICAgIHRoaXMubW91c2VTY3JvbGxUaW1lU3RhbXAgPSAwOwogICAgICB0aGlzLm1vdXNlU2Nyb2xsRGVsdGEgPSAwOwogICAgfQogIH0sIHsKICAgIGtleTogIl90b3VjaFN3aXBlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfdG91Y2hTd2lwZShldnQpIHsKICAgICAgaWYgKCF0aGlzLmFjdGl2ZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGV2dC50b3VjaGVzLmxlbmd0aCA+IDEpIHsKICAgICAgICB0aGlzLnRvdWNoU3dpcGVTdGF0ZSA9IG51bGw7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBzd2l0Y2ggKGV2dC50eXBlKSB7CiAgICAgICAgY2FzZSAidG91Y2hzdGFydCI6CiAgICAgICAgICB0aGlzLnRvdWNoU3dpcGVTdGF0ZSA9IHsKICAgICAgICAgICAgc3RhcnRYOiBldnQudG91Y2hlc1swXS5wYWdlWCwKICAgICAgICAgICAgc3RhcnRZOiBldnQudG91Y2hlc1swXS5wYWdlWSwKICAgICAgICAgICAgZW5kWDogZXZ0LnRvdWNoZXNbMF0ucGFnZVgsCiAgICAgICAgICAgIGVuZFk6IGV2dC50b3VjaGVzWzBdLnBhZ2VZCiAgICAgICAgICB9OwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgInRvdWNobW92ZSI6CiAgICAgICAgICBpZiAodGhpcy50b3VjaFN3aXBlU3RhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIHRoaXMudG91Y2hTd2lwZVN0YXRlLmVuZFggPSBldnQudG91Y2hlc1swXS5wYWdlWDsKICAgICAgICAgIHRoaXMudG91Y2hTd2lwZVN0YXRlLmVuZFkgPSBldnQudG91Y2hlc1swXS5wYWdlWTsKICAgICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgInRvdWNoZW5kIjoKICAgICAgICAgIGlmICh0aGlzLnRvdWNoU3dpcGVTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGRlbHRhID0gMDsKICAgICAgICAgIHZhciBkeCA9IHRoaXMudG91Y2hTd2lwZVN0YXRlLmVuZFggLSB0aGlzLnRvdWNoU3dpcGVTdGF0ZS5zdGFydFg7CiAgICAgICAgICB2YXIgZHkgPSB0aGlzLnRvdWNoU3dpcGVTdGF0ZS5lbmRZIC0gdGhpcy50b3VjaFN3aXBlU3RhdGUuc3RhcnRZOwogICAgICAgICAgdmFyIGFic0FuZ2xlID0gTWF0aC5hYnMoTWF0aC5hdGFuMihkeSwgZHgpKTsKCiAgICAgICAgICBpZiAoTWF0aC5hYnMoZHgpID4gU1dJUEVfTUlOX0RJU1RBTkNFX1RIUkVTSE9MRCAmJiAoYWJzQW5nbGUgPD0gU1dJUEVfQU5HTEVfVEhSRVNIT0xEIHx8IGFic0FuZ2xlID49IE1hdGguUEkgLSBTV0lQRV9BTkdMRV9USFJFU0hPTEQpKSB7CiAgICAgICAgICAgIGRlbHRhID0gZHg7CiAgICAgICAgICB9IGVsc2UgaWYgKE1hdGguYWJzKGR5KSA+IFNXSVBFX01JTl9ESVNUQU5DRV9USFJFU0hPTEQgJiYgTWF0aC5hYnMoYWJzQW5nbGUgLSBNYXRoLlBJIC8gMikgPD0gU1dJUEVfQU5HTEVfVEhSRVNIT0xEKSB7CiAgICAgICAgICAgIGRlbHRhID0gZHk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGRlbHRhID4gMCkgewogICAgICAgICAgICB0aGlzLl9nb1RvUHJldmlvdXNQYWdlKCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGRlbHRhIDwgMCkgewogICAgICAgICAgICB0aGlzLl9nb1RvTmV4dFBhZ2UoKTsKICAgICAgICAgIH0KCiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogIl9hZGRXaW5kb3dMaXN0ZW5lcnMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9hZGRXaW5kb3dMaXN0ZW5lcnMoKSB7CiAgICAgIHRoaXMuc2hvd0NvbnRyb2xzQmluZCA9IHRoaXMuX3Nob3dDb250cm9scy5iaW5kKHRoaXMpOwogICAgICB0aGlzLm1vdXNlRG93bkJpbmQgPSB0aGlzLl9tb3VzZURvd24uYmluZCh0aGlzKTsKICAgICAgdGhpcy5tb3VzZVdoZWVsQmluZCA9IHRoaXMuX21vdXNlV2hlZWwuYmluZCh0aGlzKTsKICAgICAgdGhpcy5yZXNldE1vdXNlU2Nyb2xsU3RhdGVCaW5kID0gdGhpcy5fcmVzZXRNb3VzZVNjcm9sbFN0YXRlLmJpbmQodGhpcyk7CiAgICAgIHRoaXMuY29udGV4dE1lbnVCaW5kID0gdGhpcy5fY29udGV4dE1lbnUuYmluZCh0aGlzKTsKICAgICAgdGhpcy50b3VjaFN3aXBlQmluZCA9IHRoaXMuX3RvdWNoU3dpcGUuYmluZCh0aGlzKTsKICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlbW92ZSIsIHRoaXMuc2hvd0NvbnRyb2xzQmluZCk7CiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJtb3VzZWRvd24iLCB0aGlzLm1vdXNlRG93bkJpbmQpOwogICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigid2hlZWwiLCB0aGlzLm1vdXNlV2hlZWxCaW5kLCB7CiAgICAgICAgcGFzc2l2ZTogZmFsc2UKICAgICAgfSk7CiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgdGhpcy5yZXNldE1vdXNlU2Nyb2xsU3RhdGVCaW5kKTsKICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImNvbnRleHRtZW51IiwgdGhpcy5jb250ZXh0TWVudUJpbmQpOwogICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigidG91Y2hzdGFydCIsIHRoaXMudG91Y2hTd2lwZUJpbmQpOwogICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigidG91Y2htb3ZlIiwgdGhpcy50b3VjaFN3aXBlQmluZCk7CiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJ0b3VjaGVuZCIsIHRoaXMudG91Y2hTd2lwZUJpbmQpOwogICAgfQogIH0sIHsKICAgIGtleTogIl9yZW1vdmVXaW5kb3dMaXN0ZW5lcnMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9yZW1vdmVXaW5kb3dMaXN0ZW5lcnMoKSB7CiAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJtb3VzZW1vdmUiLCB0aGlzLnNob3dDb250cm9sc0JpbmQpOwogICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigibW91c2Vkb3duIiwgdGhpcy5tb3VzZURvd25CaW5kKTsKICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoIndoZWVsIiwgdGhpcy5tb3VzZVdoZWVsQmluZCwgewogICAgICAgIHBhc3NpdmU6IGZhbHNlCiAgICAgIH0pOwogICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsIHRoaXMucmVzZXRNb3VzZVNjcm9sbFN0YXRlQmluZCk7CiAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJjb250ZXh0bWVudSIsIHRoaXMuY29udGV4dE1lbnVCaW5kKTsKICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInRvdWNoc3RhcnQiLCB0aGlzLnRvdWNoU3dpcGVCaW5kKTsKICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInRvdWNobW92ZSIsIHRoaXMudG91Y2hTd2lwZUJpbmQpOwogICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigidG91Y2hlbmQiLCB0aGlzLnRvdWNoU3dpcGVCaW5kKTsKICAgICAgZGVsZXRlIHRoaXMuc2hvd0NvbnRyb2xzQmluZDsKICAgICAgZGVsZXRlIHRoaXMubW91c2VEb3duQmluZDsKICAgICAgZGVsZXRlIHRoaXMubW91c2VXaGVlbEJpbmQ7CiAgICAgIGRlbGV0ZSB0aGlzLnJlc2V0TW91c2VTY3JvbGxTdGF0ZUJpbmQ7CiAgICAgIGRlbGV0ZSB0aGlzLmNvbnRleHRNZW51QmluZDsKICAgICAgZGVsZXRlIHRoaXMudG91Y2hTd2lwZUJpbmQ7CiAgICB9CiAgfSwgewogICAga2V5OiAiX2Z1bGxzY3JlZW5DaGFuZ2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9mdWxsc2NyZWVuQ2hhbmdlKCkgewogICAgICBpZiAodGhpcy5pc0Z1bGxzY3JlZW4pIHsKICAgICAgICB0aGlzLl9lbnRlcigpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX2V4aXQoKTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogIl9hZGRGdWxsc2NyZWVuQ2hhbmdlTGlzdGVuZXJzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfYWRkRnVsbHNjcmVlbkNoYW5nZUxpc3RlbmVycygpIHsKICAgICAgdGhpcy5mdWxsc2NyZWVuQ2hhbmdlQmluZCA9IHRoaXMuX2Z1bGxzY3JlZW5DaGFuZ2UuYmluZCh0aGlzKTsKICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImZ1bGxzY3JlZW5jaGFuZ2UiLCB0aGlzLmZ1bGxzY3JlZW5DaGFuZ2VCaW5kKTsKICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoIm1vemZ1bGxzY3JlZW5jaGFuZ2UiLCB0aGlzLmZ1bGxzY3JlZW5DaGFuZ2VCaW5kKTsKICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoIndlYmtpdGZ1bGxzY3JlZW5jaGFuZ2UiLCB0aGlzLmZ1bGxzY3JlZW5DaGFuZ2VCaW5kKTsKICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoIk1TRnVsbHNjcmVlbkNoYW5nZSIsIHRoaXMuZnVsbHNjcmVlbkNoYW5nZUJpbmQpOwogICAgfQogIH0sIHsKICAgIGtleTogIl9yZW1vdmVGdWxsc2NyZWVuQ2hhbmdlTGlzdGVuZXJzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfcmVtb3ZlRnVsbHNjcmVlbkNoYW5nZUxpc3RlbmVycygpIHsKICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoImZ1bGxzY3JlZW5jaGFuZ2UiLCB0aGlzLmZ1bGxzY3JlZW5DaGFuZ2VCaW5kKTsKICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vemZ1bGxzY3JlZW5jaGFuZ2UiLCB0aGlzLmZ1bGxzY3JlZW5DaGFuZ2VCaW5kKTsKICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoIndlYmtpdGZ1bGxzY3JlZW5jaGFuZ2UiLCB0aGlzLmZ1bGxzY3JlZW5DaGFuZ2VCaW5kKTsKICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoIk1TRnVsbHNjcmVlbkNoYW5nZSIsIHRoaXMuZnVsbHNjcmVlbkNoYW5nZUJpbmQpOwogICAgICBkZWxldGUgdGhpcy5mdWxsc2NyZWVuQ2hhbmdlQmluZDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJpc0Z1bGxzY3JlZW4iLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiAhIShkb2N1bWVudC5mdWxsc2NyZWVuRWxlbWVudCB8fCBkb2N1bWVudC5tb3pGdWxsU2NyZWVuIHx8IGRvY3VtZW50LndlYmtpdElzRnVsbFNjcmVlbiB8fCBkb2N1bWVudC5tc0Z1bGxzY3JlZW5FbGVtZW50KTsKICAgIH0KICB9XSk7CgogIHJldHVybiBQREZQcmVzZW50YXRpb25Nb2RlOwp9KCk7CgpleHBvcnRzLlBERlByZXNlbnRhdGlvbk1vZGUgPSBQREZQcmVzZW50YXRpb25Nb2RlOwoKLyoqKi8gfSksCi8qIDI0ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuUERGU2lkZWJhclJlc2l6ZXIgPSB2b2lkIDA7Cgp2YXIgX3VpX3V0aWxzID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1KTsKCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7IH0gfQoKZnVuY3Rpb24gX2RlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoInZhbHVlIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0KCmZ1bmN0aW9uIF9jcmVhdGVDbGFzcyhDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9Cgp2YXIgU0lERUJBUl9XSURUSF9WQVIgPSAiLS1zaWRlYmFyLXdpZHRoIjsKdmFyIFNJREVCQVJfTUlOX1dJRFRIID0gMjAwOwp2YXIgU0lERUJBUl9SRVNJWklOR19DTEFTUyA9ICJzaWRlYmFyUmVzaXppbmciOwoKdmFyIFBERlNpZGViYXJSZXNpemVyID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICBmdW5jdGlvbiBQREZTaWRlYmFyUmVzaXplcihvcHRpb25zLCBldmVudEJ1cykgewogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICB2YXIgbDEwbiA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDogX3VpX3V0aWxzLk51bGxMMTBuOwoKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBQREZTaWRlYmFyUmVzaXplcik7CgogICAgdGhpcy5lbmFibGVkID0gZmFsc2U7CiAgICB0aGlzLmlzUlRMID0gZmFsc2U7CiAgICB0aGlzLnNpZGViYXJPcGVuID0gZmFsc2U7CiAgICB0aGlzLmRvYyA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKICAgIHRoaXMuX3dpZHRoID0gbnVsbDsKICAgIHRoaXMuX291dGVyQ29udGFpbmVyV2lkdGggPSBudWxsOwogICAgdGhpcy5fYm91bmRFdmVudHMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgdGhpcy5vdXRlckNvbnRhaW5lciA9IG9wdGlvbnMub3V0ZXJDb250YWluZXI7CiAgICB0aGlzLnJlc2l6ZXIgPSBvcHRpb25zLnJlc2l6ZXI7CiAgICB0aGlzLmV2ZW50QnVzID0gZXZlbnRCdXM7CiAgICB0aGlzLmwxMG4gPSBsMTBuOwoKICAgIGlmICh0eXBlb2YgQ1NTID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgQ1NTLnN1cHBvcnRzICE9PSAiZnVuY3Rpb24iIHx8ICFDU1Muc3VwcG9ydHMoU0lERUJBUl9XSURUSF9WQVIsICJjYWxjKC0xICogIi5jb25jYXQoU0lERUJBUl9NSU5fV0lEVEgsICJweCkiKSkpIHsKICAgICAgY29uc29sZS53YXJuKCJQREZTaWRlYmFyUmVzaXplcjogIiArICJUaGUgYnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IHJlc2l6aW5nIG9mIHRoZSBzaWRlYmFyLiIpOwogICAgICByZXR1cm47CiAgICB9CgogICAgdGhpcy5lbmFibGVkID0gdHJ1ZTsKICAgIHRoaXMucmVzaXplci5jbGFzc0xpc3QucmVtb3ZlKCJoaWRkZW4iKTsKICAgIHRoaXMubDEwbi5nZXREaXJlY3Rpb24oKS50aGVuKGZ1bmN0aW9uIChkaXIpIHsKICAgICAgX3RoaXMuaXNSVEwgPSBkaXIgPT09ICJydGwiOwogICAgfSk7CgogICAgdGhpcy5fYWRkRXZlbnRMaXN0ZW5lcnMoKTsKICB9CgogIF9jcmVhdGVDbGFzcyhQREZTaWRlYmFyUmVzaXplciwgW3sKICAgIGtleTogIl91cGRhdGVXaWR0aCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3VwZGF0ZVdpZHRoKCkgewogICAgICB2YXIgd2lkdGggPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IDA7CgogICAgICBpZiAoIXRoaXMuZW5hYmxlZCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgdmFyIG5ld1dpZHRoID0gKDAsIF91aV91dGlscy5jbGFtcCkod2lkdGgsIFNJREVCQVJfTUlOX1dJRFRILCBNYXRoLmZsb29yKHRoaXMub3V0ZXJDb250YWluZXJXaWR0aCAvIDIpKTsKCiAgICAgIGlmIChuZXdXaWR0aCA9PT0gdGhpcy5fd2lkdGgpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHRoaXMuX3dpZHRoID0gbmV3V2lkdGg7CiAgICAgIHRoaXMuZG9jLnN0eWxlLnNldFByb3BlcnR5KFNJREVCQVJfV0lEVEhfVkFSLCAiIi5jb25jYXQobmV3V2lkdGgsICJweCIpKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfSwgewogICAga2V5OiAiX21vdXNlTW92ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX21vdXNlTW92ZShldnQpIHsKICAgICAgdmFyIHdpZHRoID0gZXZ0LmNsaWVudFg7CgogICAgICBpZiAodGhpcy5pc1JUTCkgewogICAgICAgIHdpZHRoID0gdGhpcy5vdXRlckNvbnRhaW5lcldpZHRoIC0gd2lkdGg7CiAgICAgIH0KCiAgICAgIHRoaXMuX3VwZGF0ZVdpZHRoKHdpZHRoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfbW91c2VVcCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX21vdXNlVXAoZXZ0KSB7CiAgICAgIHRoaXMub3V0ZXJDb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZShTSURFQkFSX1JFU0laSU5HX0NMQVNTKTsKICAgICAgdGhpcy5ldmVudEJ1cy5kaXNwYXRjaCgicmVzaXplIiwgewogICAgICAgIHNvdXJjZTogdGhpcwogICAgICB9KTsKICAgICAgdmFyIF9ib3VuZEV2ZW50cyA9IHRoaXMuX2JvdW5kRXZlbnRzOwogICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigibW91c2Vtb3ZlIiwgX2JvdW5kRXZlbnRzLm1vdXNlTW92ZSk7CiAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJtb3VzZXVwIiwgX2JvdW5kRXZlbnRzLm1vdXNlVXApOwogICAgfQogIH0sIHsKICAgIGtleTogIl9hZGRFdmVudExpc3RlbmVycyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2FkZEV2ZW50TGlzdGVuZXJzKCkgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIGlmICghdGhpcy5lbmFibGVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgX2JvdW5kRXZlbnRzID0gdGhpcy5fYm91bmRFdmVudHM7CiAgICAgIF9ib3VuZEV2ZW50cy5tb3VzZU1vdmUgPSB0aGlzLl9tb3VzZU1vdmUuYmluZCh0aGlzKTsKICAgICAgX2JvdW5kRXZlbnRzLm1vdXNlVXAgPSB0aGlzLl9tb3VzZVVwLmJpbmQodGhpcyk7CiAgICAgIHRoaXMucmVzaXplci5hZGRFdmVudExpc3RlbmVyKCJtb3VzZWRvd24iLCBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgICAgaWYgKGV2dC5idXR0b24gIT09IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIF90aGlzMi5vdXRlckNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKFNJREVCQVJfUkVTSVpJTkdfQ0xBU1MpOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigibW91c2Vtb3ZlIiwgX2JvdW5kRXZlbnRzLm1vdXNlTW92ZSk7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNldXAiLCBfYm91bmRFdmVudHMubW91c2VVcCk7CiAgICAgIH0pOwoKICAgICAgdGhpcy5ldmVudEJ1cy5fb24oInNpZGViYXJ2aWV3Y2hhbmdlZCIsIGZ1bmN0aW9uIChldnQpIHsKICAgICAgICBfdGhpczIuc2lkZWJhck9wZW4gPSAhIShldnQgJiYgZXZ0LnZpZXcpOwogICAgICB9KTsKCiAgICAgIHRoaXMuZXZlbnRCdXMuX29uKCJyZXNpemUiLCBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgICAgaWYgKCFldnQgfHwgZXZ0LnNvdXJjZSAhPT0gd2luZG93KSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBfdGhpczIuX291dGVyQ29udGFpbmVyV2lkdGggPSBudWxsOwoKICAgICAgICBpZiAoIV90aGlzMi5fd2lkdGgpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICghX3RoaXMyLnNpZGViYXJPcGVuKSB7CiAgICAgICAgICBfdGhpczIuX3VwZGF0ZVdpZHRoKF90aGlzMi5fd2lkdGgpOwoKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIF90aGlzMi5vdXRlckNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKFNJREVCQVJfUkVTSVpJTkdfQ0xBU1MpOwoKICAgICAgICB2YXIgdXBkYXRlZCA9IF90aGlzMi5fdXBkYXRlV2lkdGgoX3RoaXMyLl93aWR0aCk7CgogICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgX3RoaXMyLm91dGVyQ29udGFpbmVyLmNsYXNzTGlzdC5yZW1vdmUoU0lERUJBUl9SRVNJWklOR19DTEFTUyk7CgogICAgICAgICAgaWYgKHVwZGF0ZWQpIHsKICAgICAgICAgICAgX3RoaXMyLmV2ZW50QnVzLmRpc3BhdGNoKCJyZXNpemUiLCB7CiAgICAgICAgICAgICAgc291cmNlOiBfdGhpczIKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogIm91dGVyQ29udGFpbmVyV2lkdGgiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIGlmICghdGhpcy5fb3V0ZXJDb250YWluZXJXaWR0aCkgewogICAgICAgIHRoaXMuX291dGVyQ29udGFpbmVyV2lkdGggPSB0aGlzLm91dGVyQ29udGFpbmVyLmNsaWVudFdpZHRoOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5fb3V0ZXJDb250YWluZXJXaWR0aDsKICAgIH0KICB9XSk7CgogIHJldHVybiBQREZTaWRlYmFyUmVzaXplcjsKfSgpOwoKZXhwb3J0cy5QREZTaWRlYmFyUmVzaXplciA9IFBERlNpZGViYXJSZXNpemVyOwoKLyoqKi8gfSksCi8qIDI1ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuUERGVGh1bWJuYWlsVmlld2VyID0gdm9pZCAwOwoKdmFyIF91aV91dGlscyA9IF9fd2VicGFja19yZXF1aXJlX18oNSk7Cgp2YXIgX3BkZl90aHVtYm5haWxfdmlldyA9IF9fd2VicGFja19yZXF1aXJlX18oMjYpOwoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsgfSB9CgpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfQoKZnVuY3Rpb24gX2NyZWF0ZUNsYXNzKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH0KCnZhciBUSFVNQk5BSUxfU0NST0xMX01BUkdJTiA9IC0xOTsKdmFyIFRIVU1CTkFJTF9TRUxFQ1RFRF9DTEFTUyA9ICJzZWxlY3RlZCI7Cgp2YXIgUERGVGh1bWJuYWlsVmlld2VyID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICBmdW5jdGlvbiBQREZUaHVtYm5haWxWaWV3ZXIoX3JlZikgewogICAgdmFyIGNvbnRhaW5lciA9IF9yZWYuY29udGFpbmVyLAogICAgICAgIGxpbmtTZXJ2aWNlID0gX3JlZi5saW5rU2VydmljZSwKICAgICAgICByZW5kZXJpbmdRdWV1ZSA9IF9yZWYucmVuZGVyaW5nUXVldWUsCiAgICAgICAgX3JlZiRsMTBuID0gX3JlZi5sMTBuLAogICAgICAgIGwxMG4gPSBfcmVmJGwxMG4gPT09IHZvaWQgMCA/IF91aV91dGlscy5OdWxsTDEwbiA6IF9yZWYkbDEwbjsKCiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgUERGVGh1bWJuYWlsVmlld2VyKTsKCiAgICB0aGlzLmNvbnRhaW5lciA9IGNvbnRhaW5lcjsKICAgIHRoaXMubGlua1NlcnZpY2UgPSBsaW5rU2VydmljZTsKICAgIHRoaXMucmVuZGVyaW5nUXVldWUgPSByZW5kZXJpbmdRdWV1ZTsKICAgIHRoaXMubDEwbiA9IGwxMG47CiAgICB0aGlzLnNjcm9sbCA9ICgwLCBfdWlfdXRpbHMud2F0Y2hTY3JvbGwpKHRoaXMuY29udGFpbmVyLCB0aGlzLl9zY3JvbGxVcGRhdGVkLmJpbmQodGhpcykpOwoKICAgIHRoaXMuX3Jlc2V0VmlldygpOwogIH0KCiAgX2NyZWF0ZUNsYXNzKFBERlRodW1ibmFpbFZpZXdlciwgW3sKICAgIGtleTogIl9zY3JvbGxVcGRhdGVkIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfc2Nyb2xsVXBkYXRlZCgpIHsKICAgICAgdGhpcy5yZW5kZXJpbmdRdWV1ZS5yZW5kZXJIaWdoZXN0UHJpb3JpdHkoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJnZXRUaHVtYm5haWwiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGdldFRodW1ibmFpbChpbmRleCkgewogICAgICByZXR1cm4gdGhpcy5fdGh1bWJuYWlsc1tpbmRleF07CiAgICB9CiAgfSwgewogICAga2V5OiAiX2dldFZpc2libGVUaHVtYnMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9nZXRWaXNpYmxlVGh1bWJzKCkgewogICAgICByZXR1cm4gKDAsIF91aV91dGlscy5nZXRWaXNpYmxlRWxlbWVudHMpKHRoaXMuY29udGFpbmVyLCB0aGlzLl90aHVtYm5haWxzKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJzY3JvbGxUaHVtYm5haWxJbnRvVmlldyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2Nyb2xsVGh1bWJuYWlsSW50b1ZpZXcocGFnZU51bWJlcikgewogICAgICBpZiAoIXRoaXMucGRmRG9jdW1lbnQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciB0aHVtYm5haWxWaWV3ID0gdGhpcy5fdGh1bWJuYWlsc1twYWdlTnVtYmVyIC0gMV07CgogICAgICBpZiAoIXRodW1ibmFpbFZpZXcpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdzY3JvbGxUaHVtYm5haWxJbnRvVmlldzogSW52YWxpZCAicGFnZU51bWJlciIgcGFyYW1ldGVyLicpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKHBhZ2VOdW1iZXIgIT09IHRoaXMuX2N1cnJlbnRQYWdlTnVtYmVyKSB7CiAgICAgICAgdmFyIHByZXZUaHVtYm5haWxWaWV3ID0gdGhpcy5fdGh1bWJuYWlsc1t0aGlzLl9jdXJyZW50UGFnZU51bWJlciAtIDFdOwogICAgICAgIHByZXZUaHVtYm5haWxWaWV3LmRpdi5jbGFzc0xpc3QucmVtb3ZlKFRIVU1CTkFJTF9TRUxFQ1RFRF9DTEFTUyk7CiAgICAgICAgdGh1bWJuYWlsVmlldy5kaXYuY2xhc3NMaXN0LmFkZChUSFVNQk5BSUxfU0VMRUNURURfQ0xBU1MpOwogICAgICB9CgogICAgICB2YXIgdmlzaWJsZVRodW1icyA9IHRoaXMuX2dldFZpc2libGVUaHVtYnMoKTsKCiAgICAgIHZhciBudW1WaXNpYmxlVGh1bWJzID0gdmlzaWJsZVRodW1icy52aWV3cy5sZW5ndGg7CgogICAgICBpZiAobnVtVmlzaWJsZVRodW1icyA+IDApIHsKICAgICAgICB2YXIgZmlyc3QgPSB2aXNpYmxlVGh1bWJzLmZpcnN0LmlkOwogICAgICAgIHZhciBsYXN0ID0gbnVtVmlzaWJsZVRodW1icyA+IDEgPyB2aXNpYmxlVGh1bWJzLmxhc3QuaWQgOiBmaXJzdDsKICAgICAgICB2YXIgc2hvdWxkU2Nyb2xsID0gZmFsc2U7CgogICAgICAgIGlmIChwYWdlTnVtYmVyIDw9IGZpcnN0IHx8IHBhZ2VOdW1iZXIgPj0gbGFzdCkgewogICAgICAgICAgc2hvdWxkU2Nyb2xsID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmlzaWJsZVRodW1icy52aWV3cy5zb21lKGZ1bmN0aW9uICh2aWV3KSB7CiAgICAgICAgICAgIGlmICh2aWV3LmlkICE9PSBwYWdlTnVtYmVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzaG91bGRTY3JvbGwgPSB2aWV3LnBlcmNlbnQgPCAxMDA7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoc2hvdWxkU2Nyb2xsKSB7CiAgICAgICAgICAoMCwgX3VpX3V0aWxzLnNjcm9sbEludG9WaWV3KSh0aHVtYm5haWxWaWV3LmRpdiwgewogICAgICAgICAgICB0b3A6IFRIVU1CTkFJTF9TQ1JPTExfTUFSR0lOCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuX2N1cnJlbnRQYWdlTnVtYmVyID0gcGFnZU51bWJlcjsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJjbGVhbnVwIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjbGVhbnVwKCkgewogICAgICBfcGRmX3RodW1ibmFpbF92aWV3LlBERlRodW1ibmFpbFZpZXcuY2xlYW51cCgpOwogICAgfQogIH0sIHsKICAgIGtleTogIl9yZXNldFZpZXciLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9yZXNldFZpZXcoKSB7CiAgICAgIHRoaXMuX3RodW1ibmFpbHMgPSBbXTsKICAgICAgdGhpcy5fY3VycmVudFBhZ2VOdW1iZXIgPSAxOwogICAgICB0aGlzLl9wYWdlTGFiZWxzID0gbnVsbDsKICAgICAgdGhpcy5fcGFnZXNSb3RhdGlvbiA9IDA7CiAgICAgIHRoaXMuX3BhZ2VzUmVxdWVzdHMgPSBuZXcgV2Vha01hcCgpOwogICAgICB0aGlzLmNvbnRhaW5lci50ZXh0Q29udGVudCA9ICIiOwogICAgfQogIH0sIHsKICAgIGtleTogInNldERvY3VtZW50IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXREb2N1bWVudChwZGZEb2N1bWVudCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgaWYgKHRoaXMucGRmRG9jdW1lbnQpIHsKICAgICAgICB0aGlzLl9jYW5jZWxSZW5kZXJpbmcoKTsKCiAgICAgICAgdGhpcy5fcmVzZXRWaWV3KCk7CiAgICAgIH0KCiAgICAgIHRoaXMucGRmRG9jdW1lbnQgPSBwZGZEb2N1bWVudDsKCiAgICAgIGlmICghcGRmRG9jdW1lbnQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHBkZkRvY3VtZW50LmdldFBhZ2UoMSkudGhlbihmdW5jdGlvbiAoZmlyc3RQZGZQYWdlKSB7CiAgICAgICAgdmFyIHBhZ2VzQ291bnQgPSBwZGZEb2N1bWVudC5udW1QYWdlczsKICAgICAgICB2YXIgdmlld3BvcnQgPSBmaXJzdFBkZlBhZ2UuZ2V0Vmlld3BvcnQoewogICAgICAgICAgc2NhbGU6IDEKICAgICAgICB9KTsKCiAgICAgICAgZm9yICh2YXIgcGFnZU51bSA9IDE7IHBhZ2VOdW0gPD0gcGFnZXNDb3VudDsgKytwYWdlTnVtKSB7CiAgICAgICAgICB2YXIgdGh1bWJuYWlsID0gbmV3IF9wZGZfdGh1bWJuYWlsX3ZpZXcuUERGVGh1bWJuYWlsVmlldyh7CiAgICAgICAgICAgIGNvbnRhaW5lcjogX3RoaXMuY29udGFpbmVyLAogICAgICAgICAgICBpZDogcGFnZU51bSwKICAgICAgICAgICAgZGVmYXVsdFZpZXdwb3J0OiB2aWV3cG9ydC5jbG9uZSgpLAogICAgICAgICAgICBsaW5rU2VydmljZTogX3RoaXMubGlua1NlcnZpY2UsCiAgICAgICAgICAgIHJlbmRlcmluZ1F1ZXVlOiBfdGhpcy5yZW5kZXJpbmdRdWV1ZSwKICAgICAgICAgICAgZGlzYWJsZUNhbnZhc1RvSW1hZ2VDb252ZXJzaW9uOiBmYWxzZSwKICAgICAgICAgICAgbDEwbjogX3RoaXMubDEwbgogICAgICAgICAgfSk7CgogICAgICAgICAgX3RoaXMuX3RodW1ibmFpbHMucHVzaCh0aHVtYm5haWwpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGZpcnN0VGh1bWJuYWlsVmlldyA9IF90aGlzLl90aHVtYm5haWxzWzBdOwoKICAgICAgICBpZiAoZmlyc3RUaHVtYm5haWxWaWV3KSB7CiAgICAgICAgICBmaXJzdFRodW1ibmFpbFZpZXcuc2V0UGRmUGFnZShmaXJzdFBkZlBhZ2UpOwogICAgICAgIH0KCiAgICAgICAgdmFyIHRodW1ibmFpbFZpZXcgPSBfdGhpcy5fdGh1bWJuYWlsc1tfdGhpcy5fY3VycmVudFBhZ2VOdW1iZXIgLSAxXTsKICAgICAgICB0aHVtYm5haWxWaWV3LmRpdi5jbGFzc0xpc3QuYWRkKFRIVU1CTkFJTF9TRUxFQ1RFRF9DTEFTUyk7CiAgICAgIH0pWyJjYXRjaCJdKGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJVbmFibGUgdG8gaW5pdGlhbGl6ZSB0aHVtYm5haWwgdmlld2VyIiwgcmVhc29uKTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiX2NhbmNlbFJlbmRlcmluZyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2NhbmNlbFJlbmRlcmluZygpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGlpID0gdGhpcy5fdGh1bWJuYWlscy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgaWYgKHRoaXMuX3RodW1ibmFpbHNbaV0pIHsKICAgICAgICAgIHRoaXMuX3RodW1ibmFpbHNbaV0uY2FuY2VsUmVuZGVyaW5nKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAic2V0UGFnZUxhYmVscyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2V0UGFnZUxhYmVscyhsYWJlbHMpIHsKICAgICAgaWYgKCF0aGlzLnBkZkRvY3VtZW50KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoIWxhYmVscykgewogICAgICAgIHRoaXMuX3BhZ2VMYWJlbHMgPSBudWxsOwogICAgICB9IGVsc2UgaWYgKCEoQXJyYXkuaXNBcnJheShsYWJlbHMpICYmIHRoaXMucGRmRG9jdW1lbnQubnVtUGFnZXMgPT09IGxhYmVscy5sZW5ndGgpKSB7CiAgICAgICAgdGhpcy5fcGFnZUxhYmVscyA9IG51bGw7CiAgICAgICAgY29uc29sZS5lcnJvcigiUERGVGh1bWJuYWlsVmlld2VyX3NldFBhZ2VMYWJlbHM6IEludmFsaWQgcGFnZSBsYWJlbHMuIik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fcGFnZUxhYmVscyA9IGxhYmVsczsKICAgICAgfQoKICAgICAgZm9yICh2YXIgaSA9IDAsIGlpID0gdGhpcy5fdGh1bWJuYWlscy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgdmFyIGxhYmVsID0gdGhpcy5fcGFnZUxhYmVscyAmJiB0aGlzLl9wYWdlTGFiZWxzW2ldOwoKICAgICAgICB0aGlzLl90aHVtYm5haWxzW2ldLnNldFBhZ2VMYWJlbChsYWJlbCk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJfZW5zdXJlUGRmUGFnZUxvYWRlZCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2Vuc3VyZVBkZlBhZ2VMb2FkZWQodGh1bWJWaWV3KSB7CiAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgaWYgKHRodW1iVmlldy5wZGZQYWdlKSB7CiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0aHVtYlZpZXcucGRmUGFnZSk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9wYWdlc1JlcXVlc3RzLmhhcyh0aHVtYlZpZXcpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3BhZ2VzUmVxdWVzdHMuZ2V0KHRodW1iVmlldyk7CiAgICAgIH0KCiAgICAgIHZhciBwcm9taXNlID0gdGhpcy5wZGZEb2N1bWVudC5nZXRQYWdlKHRodW1iVmlldy5pZCkudGhlbihmdW5jdGlvbiAocGRmUGFnZSkgewogICAgICAgIGlmICghdGh1bWJWaWV3LnBkZlBhZ2UpIHsKICAgICAgICAgIHRodW1iVmlldy5zZXRQZGZQYWdlKHBkZlBhZ2UpOwogICAgICAgIH0KCiAgICAgICAgX3RoaXMyLl9wYWdlc1JlcXVlc3RzWyJkZWxldGUiXSh0aHVtYlZpZXcpOwoKICAgICAgICByZXR1cm4gcGRmUGFnZTsKICAgICAgfSlbImNhdGNoIl0oZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoIlVuYWJsZSB0byBnZXQgcGFnZSBmb3IgdGh1bWIgdmlldyIsIHJlYXNvbik7CgogICAgICAgIF90aGlzMi5fcGFnZXNSZXF1ZXN0c1siZGVsZXRlIl0odGh1bWJWaWV3KTsKICAgICAgfSk7CgogICAgICB0aGlzLl9wYWdlc1JlcXVlc3RzLnNldCh0aHVtYlZpZXcsIHByb21pc2UpOwoKICAgICAgcmV0dXJuIHByb21pc2U7CiAgICB9CiAgfSwgewogICAga2V5OiAiZm9yY2VSZW5kZXJpbmciLAogICAgdmFsdWU6IGZ1bmN0aW9uIGZvcmNlUmVuZGVyaW5nKCkgewogICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgIHZhciB2aXNpYmxlVGh1bWJzID0gdGhpcy5fZ2V0VmlzaWJsZVRodW1icygpOwoKICAgICAgdmFyIHRodW1iVmlldyA9IHRoaXMucmVuZGVyaW5nUXVldWUuZ2V0SGlnaGVzdFByaW9yaXR5KHZpc2libGVUaHVtYnMsIHRoaXMuX3RodW1ibmFpbHMsIHRoaXMuc2Nyb2xsLmRvd24pOwoKICAgICAgaWYgKHRodW1iVmlldykgewogICAgICAgIHRoaXMuX2Vuc3VyZVBkZlBhZ2VMb2FkZWQodGh1bWJWaWV3KS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIF90aGlzMy5yZW5kZXJpbmdRdWV1ZS5yZW5kZXJWaWV3KHRodW1iVmlldyk7CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSwgewogICAga2V5OiAicGFnZXNSb3RhdGlvbiIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3BhZ2VzUm90YXRpb247CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbiBzZXQocm90YXRpb24pIHsKICAgICAgaWYgKCEoMCwgX3VpX3V0aWxzLmlzVmFsaWRSb3RhdGlvbikocm90YXRpb24pKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHRodW1ibmFpbHMgcm90YXRpb24gYW5nbGUuIik7CiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5wZGZEb2N1bWVudCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuX3BhZ2VzUm90YXRpb24gPT09IHJvdGF0aW9uKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLl9wYWdlc1JvdGF0aW9uID0gcm90YXRpb247CgogICAgICBmb3IgKHZhciBpID0gMCwgaWkgPSB0aGlzLl90aHVtYm5haWxzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICB0aGlzLl90aHVtYm5haWxzW2ldLnVwZGF0ZShyb3RhdGlvbik7CiAgICAgIH0KICAgIH0KICB9XSk7CgogIHJldHVybiBQREZUaHVtYm5haWxWaWV3ZXI7Cn0oKTsKCmV4cG9ydHMuUERGVGh1bWJuYWlsVmlld2VyID0gUERGVGh1bWJuYWlsVmlld2VyOwoKLyoqKi8gfSksCi8qIDI2ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuUERGVGh1bWJuYWlsVmlldyA9IHZvaWQgMDsKCnZhciBfcGRmanNMaWIgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDgpOwoKdmFyIF91aV91dGlscyA9IF9fd2VicGFja19yZXF1aXJlX18oNSk7Cgp2YXIgX3BkZl9yZW5kZXJpbmdfcXVldWUgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDExKTsKCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7IH0gfQoKZnVuY3Rpb24gX2RlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoInZhbHVlIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0KCmZ1bmN0aW9uIF9jcmVhdGVDbGFzcyhDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9Cgp2YXIgTUFYX05VTV9TQ0FMSU5HX1NURVBTID0gMzsKdmFyIFRIVU1CTkFJTF9DQU5WQVNfQk9SREVSX1dJRFRIID0gMTsKdmFyIFRIVU1CTkFJTF9XSURUSCA9IDk4OwoKdmFyIFRlbXBJbWFnZUZhY3RvcnkgPSBmdW5jdGlvbiBUZW1wSW1hZ2VGYWN0b3J5Q2xvc3VyZSgpIHsKICB2YXIgdGVtcENhbnZhc0NhY2hlID0gbnVsbDsKICByZXR1cm4gewogICAgZ2V0Q2FudmFzOiBmdW5jdGlvbiBnZXRDYW52YXMod2lkdGgsIGhlaWdodCkgewogICAgICB2YXIgdGVtcENhbnZhcyA9IHRlbXBDYW52YXNDYWNoZTsKCiAgICAgIGlmICghdGVtcENhbnZhcykgewogICAgICAgIHRlbXBDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKICAgICAgICB0ZW1wQ2FudmFzQ2FjaGUgPSB0ZW1wQ2FudmFzOwogICAgICB9CgogICAgICB0ZW1wQ2FudmFzLndpZHRoID0gd2lkdGg7CiAgICAgIHRlbXBDYW52YXMuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICB0ZW1wQ2FudmFzLm1vek9wYXF1ZSA9IHRydWU7CiAgICAgIHZhciBjdHggPSB0ZW1wQ2FudmFzLmdldENvbnRleHQoIjJkIiwgewogICAgICAgIGFscGhhOiBmYWxzZQogICAgICB9KTsKICAgICAgY3R4LnNhdmUoKTsKICAgICAgY3R4LmZpbGxTdHlsZSA9ICJyZ2IoMjU1LCAyNTUsIDI1NSkiOwogICAgICBjdHguZmlsbFJlY3QoMCwgMCwgd2lkdGgsIGhlaWdodCk7CiAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgIHJldHVybiB0ZW1wQ2FudmFzOwogICAgfSwKICAgIGRlc3Ryb3lDYW52YXM6IGZ1bmN0aW9uIGRlc3Ryb3lDYW52YXMoKSB7CiAgICAgIHZhciB0ZW1wQ2FudmFzID0gdGVtcENhbnZhc0NhY2hlOwoKICAgICAgaWYgKHRlbXBDYW52YXMpIHsKICAgICAgICB0ZW1wQ2FudmFzLndpZHRoID0gMDsKICAgICAgICB0ZW1wQ2FudmFzLmhlaWdodCA9IDA7CiAgICAgIH0KCiAgICAgIHRlbXBDYW52YXNDYWNoZSA9IG51bGw7CiAgICB9CiAgfTsKfSgpOwoKdmFyIFBERlRodW1ibmFpbFZpZXcgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIFBERlRodW1ibmFpbFZpZXcoX3JlZikgewogICAgdmFyIGNvbnRhaW5lciA9IF9yZWYuY29udGFpbmVyLAogICAgICAgIGlkID0gX3JlZi5pZCwKICAgICAgICBkZWZhdWx0Vmlld3BvcnQgPSBfcmVmLmRlZmF1bHRWaWV3cG9ydCwKICAgICAgICBsaW5rU2VydmljZSA9IF9yZWYubGlua1NlcnZpY2UsCiAgICAgICAgcmVuZGVyaW5nUXVldWUgPSBfcmVmLnJlbmRlcmluZ1F1ZXVlLAogICAgICAgIF9yZWYkZGlzYWJsZUNhbnZhc1RvSSA9IF9yZWYuZGlzYWJsZUNhbnZhc1RvSW1hZ2VDb252ZXJzaW9uLAogICAgICAgIGRpc2FibGVDYW52YXNUb0ltYWdlQ29udmVyc2lvbiA9IF9yZWYkZGlzYWJsZUNhbnZhc1RvSSA9PT0gdm9pZCAwID8gZmFsc2UgOiBfcmVmJGRpc2FibGVDYW52YXNUb0ksCiAgICAgICAgX3JlZiRsMTBuID0gX3JlZi5sMTBuLAogICAgICAgIGwxMG4gPSBfcmVmJGwxMG4gPT09IHZvaWQgMCA/IF91aV91dGlscy5OdWxsTDEwbiA6IF9yZWYkbDEwbjsKCiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgUERGVGh1bWJuYWlsVmlldyk7CgogICAgdGhpcy5pZCA9IGlkOwogICAgdGhpcy5yZW5kZXJpbmdJZCA9ICJ0aHVtYm5haWwiICsgaWQ7CiAgICB0aGlzLnBhZ2VMYWJlbCA9IG51bGw7CiAgICB0aGlzLnBkZlBhZ2UgPSBudWxsOwogICAgdGhpcy5yb3RhdGlvbiA9IDA7CiAgICB0aGlzLnZpZXdwb3J0ID0gZGVmYXVsdFZpZXdwb3J0OwogICAgdGhpcy5wZGZQYWdlUm90YXRlID0gZGVmYXVsdFZpZXdwb3J0LnJvdGF0aW9uOwogICAgdGhpcy5saW5rU2VydmljZSA9IGxpbmtTZXJ2aWNlOwogICAgdGhpcy5yZW5kZXJpbmdRdWV1ZSA9IHJlbmRlcmluZ1F1ZXVlOwogICAgdGhpcy5yZW5kZXJUYXNrID0gbnVsbDsKICAgIHRoaXMucmVuZGVyaW5nU3RhdGUgPSBfcGRmX3JlbmRlcmluZ19xdWV1ZS5SZW5kZXJpbmdTdGF0ZXMuSU5JVElBTDsKICAgIHRoaXMucmVzdW1lID0gbnVsbDsKICAgIHRoaXMuZGlzYWJsZUNhbnZhc1RvSW1hZ2VDb252ZXJzaW9uID0gZGlzYWJsZUNhbnZhc1RvSW1hZ2VDb252ZXJzaW9uOwogICAgdGhpcy5wYWdlV2lkdGggPSB0aGlzLnZpZXdwb3J0LndpZHRoOwogICAgdGhpcy5wYWdlSGVpZ2h0ID0gdGhpcy52aWV3cG9ydC5oZWlnaHQ7CiAgICB0aGlzLnBhZ2VSYXRpbyA9IHRoaXMucGFnZVdpZHRoIC8gdGhpcy5wYWdlSGVpZ2h0OwogICAgdGhpcy5jYW52YXNXaWR0aCA9IFRIVU1CTkFJTF9XSURUSDsKICAgIHRoaXMuY2FudmFzSGVpZ2h0ID0gdGhpcy5jYW52YXNXaWR0aCAvIHRoaXMucGFnZVJhdGlvIHwgMDsKICAgIHRoaXMuc2NhbGUgPSB0aGlzLmNhbnZhc1dpZHRoIC8gdGhpcy5wYWdlV2lkdGg7CiAgICB0aGlzLmwxMG4gPSBsMTBuOwogICAgdmFyIGFuY2hvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsKICAgIGFuY2hvci5ocmVmID0gbGlua1NlcnZpY2UuZ2V0QW5jaG9yVXJsKCIjcGFnZT0iICsgaWQpOwoKICAgIHRoaXMuX3RodW1iUGFnZVRpdGxlLnRoZW4oZnVuY3Rpb24gKG1zZykgewogICAgICBhbmNob3IudGl0bGUgPSBtc2c7CiAgICB9KTsKCiAgICBhbmNob3Iub25jbGljayA9IGZ1bmN0aW9uICgpIHsKICAgICAgbGlua1NlcnZpY2UucGFnZSA9IGlkOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwoKICAgIHRoaXMuYW5jaG9yID0gYW5jaG9yOwogICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgZGl2LmNsYXNzTmFtZSA9ICJ0aHVtYm5haWwiOwogICAgZGl2LnNldEF0dHJpYnV0ZSgiZGF0YS1wYWdlLW51bWJlciIsIHRoaXMuaWQpOwogICAgdGhpcy5kaXYgPSBkaXY7CiAgICB2YXIgcmluZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgcmluZy5jbGFzc05hbWUgPSAidGh1bWJuYWlsU2VsZWN0aW9uUmluZyI7CiAgICB2YXIgYm9yZGVyQWRqdXN0bWVudCA9IDIgKiBUSFVNQk5BSUxfQ0FOVkFTX0JPUkRFUl9XSURUSDsKICAgIHJpbmcuc3R5bGUud2lkdGggPSB0aGlzLmNhbnZhc1dpZHRoICsgYm9yZGVyQWRqdXN0bWVudCArICJweCI7CiAgICByaW5nLnN0eWxlLmhlaWdodCA9IHRoaXMuY2FudmFzSGVpZ2h0ICsgYm9yZGVyQWRqdXN0bWVudCArICJweCI7CiAgICB0aGlzLnJpbmcgPSByaW5nOwogICAgZGl2LmFwcGVuZENoaWxkKHJpbmcpOwogICAgYW5jaG9yLmFwcGVuZENoaWxkKGRpdik7CiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoYW5jaG9yKTsKICB9CgogIF9jcmVhdGVDbGFzcyhQREZUaHVtYm5haWxWaWV3LCBbewogICAga2V5OiAic2V0UGRmUGFnZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2V0UGRmUGFnZShwZGZQYWdlKSB7CiAgICAgIHRoaXMucGRmUGFnZSA9IHBkZlBhZ2U7CiAgICAgIHRoaXMucGRmUGFnZVJvdGF0ZSA9IHBkZlBhZ2Uucm90YXRlOwogICAgICB2YXIgdG90YWxSb3RhdGlvbiA9ICh0aGlzLnJvdGF0aW9uICsgdGhpcy5wZGZQYWdlUm90YXRlKSAlIDM2MDsKICAgICAgdGhpcy52aWV3cG9ydCA9IHBkZlBhZ2UuZ2V0Vmlld3BvcnQoewogICAgICAgIHNjYWxlOiAxLAogICAgICAgIHJvdGF0aW9uOiB0b3RhbFJvdGF0aW9uCiAgICAgIH0pOwogICAgICB0aGlzLnJlc2V0KCk7CiAgICB9CiAgfSwgewogICAga2V5OiAicmVzZXQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlc2V0KCkgewogICAgICB0aGlzLmNhbmNlbFJlbmRlcmluZygpOwogICAgICB0aGlzLnJlbmRlcmluZ1N0YXRlID0gX3BkZl9yZW5kZXJpbmdfcXVldWUuUmVuZGVyaW5nU3RhdGVzLklOSVRJQUw7CiAgICAgIHRoaXMucGFnZVdpZHRoID0gdGhpcy52aWV3cG9ydC53aWR0aDsKICAgICAgdGhpcy5wYWdlSGVpZ2h0ID0gdGhpcy52aWV3cG9ydC5oZWlnaHQ7CiAgICAgIHRoaXMucGFnZVJhdGlvID0gdGhpcy5wYWdlV2lkdGggLyB0aGlzLnBhZ2VIZWlnaHQ7CiAgICAgIHRoaXMuY2FudmFzSGVpZ2h0ID0gdGhpcy5jYW52YXNXaWR0aCAvIHRoaXMucGFnZVJhdGlvIHwgMDsKICAgICAgdGhpcy5zY2FsZSA9IHRoaXMuY2FudmFzV2lkdGggLyB0aGlzLnBhZ2VXaWR0aDsKICAgICAgdGhpcy5kaXYucmVtb3ZlQXR0cmlidXRlKCJkYXRhLWxvYWRlZCIpOwogICAgICB2YXIgcmluZyA9IHRoaXMucmluZzsKICAgICAgdmFyIGNoaWxkTm9kZXMgPSByaW5nLmNoaWxkTm9kZXM7CgogICAgICBmb3IgKHZhciBpID0gY2hpbGROb2Rlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIHJpbmcucmVtb3ZlQ2hpbGQoY2hpbGROb2Rlc1tpXSk7CiAgICAgIH0KCiAgICAgIHZhciBib3JkZXJBZGp1c3RtZW50ID0gMiAqIFRIVU1CTkFJTF9DQU5WQVNfQk9SREVSX1dJRFRIOwogICAgICByaW5nLnN0eWxlLndpZHRoID0gdGhpcy5jYW52YXNXaWR0aCArIGJvcmRlckFkanVzdG1lbnQgKyAicHgiOwogICAgICByaW5nLnN0eWxlLmhlaWdodCA9IHRoaXMuY2FudmFzSGVpZ2h0ICsgYm9yZGVyQWRqdXN0bWVudCArICJweCI7CgogICAgICBpZiAodGhpcy5jYW52YXMpIHsKICAgICAgICB0aGlzLmNhbnZhcy53aWR0aCA9IDA7CiAgICAgICAgdGhpcy5jYW52YXMuaGVpZ2h0ID0gMDsKICAgICAgICBkZWxldGUgdGhpcy5jYW52YXM7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmltYWdlKSB7CiAgICAgICAgdGhpcy5pbWFnZS5yZW1vdmVBdHRyaWJ1dGUoInNyYyIpOwogICAgICAgIGRlbGV0ZSB0aGlzLmltYWdlOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAidXBkYXRlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB1cGRhdGUocm90YXRpb24pIHsKICAgICAgaWYgKHR5cGVvZiByb3RhdGlvbiAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICB0aGlzLnJvdGF0aW9uID0gcm90YXRpb247CiAgICAgIH0KCiAgICAgIHZhciB0b3RhbFJvdGF0aW9uID0gKHRoaXMucm90YXRpb24gKyB0aGlzLnBkZlBhZ2VSb3RhdGUpICUgMzYwOwogICAgICB0aGlzLnZpZXdwb3J0ID0gdGhpcy52aWV3cG9ydC5jbG9uZSh7CiAgICAgICAgc2NhbGU6IDEsCiAgICAgICAgcm90YXRpb246IHRvdGFsUm90YXRpb24KICAgICAgfSk7CiAgICAgIHRoaXMucmVzZXQoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJjYW5jZWxSZW5kZXJpbmciLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNhbmNlbFJlbmRlcmluZygpIHsKICAgICAgaWYgKHRoaXMucmVuZGVyVGFzaykgewogICAgICAgIHRoaXMucmVuZGVyVGFzay5jYW5jZWwoKTsKICAgICAgICB0aGlzLnJlbmRlclRhc2sgPSBudWxsOwogICAgICB9CgogICAgICB0aGlzLnJlc3VtZSA9IG51bGw7CiAgICB9CiAgfSwgewogICAga2V5OiAiX2dldFBhZ2VEcmF3Q29udGV4dCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2dldFBhZ2VEcmF3Q29udGV4dCgpIHsKICAgICAgdmFyIG5vQ3R4U2NhbGUgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IGZhbHNlOwogICAgICB2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiY2FudmFzIik7CiAgICAgIHRoaXMuY2FudmFzID0gY2FudmFzOwogICAgICBjYW52YXMubW96T3BhcXVlID0gdHJ1ZTsKICAgICAgdmFyIGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIsIHsKICAgICAgICBhbHBoYTogZmFsc2UKICAgICAgfSk7CiAgICAgIHZhciBvdXRwdXRTY2FsZSA9ICgwLCBfdWlfdXRpbHMuZ2V0T3V0cHV0U2NhbGUpKGN0eCk7CiAgICAgIGNhbnZhcy53aWR0aCA9IHRoaXMuY2FudmFzV2lkdGggKiBvdXRwdXRTY2FsZS5zeCB8IDA7CiAgICAgIGNhbnZhcy5oZWlnaHQgPSB0aGlzLmNhbnZhc0hlaWdodCAqIG91dHB1dFNjYWxlLnN5IHwgMDsKICAgICAgY2FudmFzLnN0eWxlLndpZHRoID0gdGhpcy5jYW52YXNXaWR0aCArICJweCI7CiAgICAgIGNhbnZhcy5zdHlsZS5oZWlnaHQgPSB0aGlzLmNhbnZhc0hlaWdodCArICJweCI7CgogICAgICBpZiAoIW5vQ3R4U2NhbGUgJiYgb3V0cHV0U2NhbGUuc2NhbGVkKSB7CiAgICAgICAgY3R4LnNjYWxlKG91dHB1dFNjYWxlLnN4LCBvdXRwdXRTY2FsZS5zeSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBjdHg7CiAgICB9CiAgfSwgewogICAga2V5OiAiX2NvbnZlcnRDYW52YXNUb0ltYWdlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfY29udmVydENhbnZhc1RvSW1hZ2UoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBpZiAoIXRoaXMuY2FudmFzKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAodGhpcy5yZW5kZXJpbmdTdGF0ZSAhPT0gX3BkZl9yZW5kZXJpbmdfcXVldWUuUmVuZGVyaW5nU3RhdGVzLkZJTklTSEVEKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgY2xhc3NOYW1lID0gInRodW1ibmFpbEltYWdlIjsKCiAgICAgIGlmICh0aGlzLmRpc2FibGVDYW52YXNUb0ltYWdlQ29udmVyc2lvbikgewogICAgICAgIHRoaXMuY2FudmFzLmNsYXNzTmFtZSA9IGNsYXNzTmFtZTsKCiAgICAgICAgdGhpcy5fdGh1bWJQYWdlQ2FudmFzLnRoZW4oZnVuY3Rpb24gKG1zZykgewogICAgICAgICAgX3RoaXMuY2FudmFzLnNldEF0dHJpYnV0ZSgiYXJpYS1sYWJlbCIsIG1zZyk7CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuZGl2LnNldEF0dHJpYnV0ZSgiZGF0YS1sb2FkZWQiLCB0cnVlKTsKICAgICAgICB0aGlzLnJpbmcuYXBwZW5kQ2hpbGQodGhpcy5jYW52YXMpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGltYWdlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW1nIik7CiAgICAgIGltYWdlLmNsYXNzTmFtZSA9IGNsYXNzTmFtZTsKCiAgICAgIHRoaXMuX3RodW1iUGFnZUNhbnZhcy50aGVuKGZ1bmN0aW9uIChtc2cpIHsKICAgICAgICBpbWFnZS5zZXRBdHRyaWJ1dGUoImFyaWEtbGFiZWwiLCBtc2cpOwogICAgICB9KTsKCiAgICAgIGltYWdlLnN0eWxlLndpZHRoID0gdGhpcy5jYW52YXNXaWR0aCArICJweCI7CiAgICAgIGltYWdlLnN0eWxlLmhlaWdodCA9IHRoaXMuY2FudmFzSGVpZ2h0ICsgInB4IjsKICAgICAgaW1hZ2Uuc3JjID0gdGhpcy5jYW52YXMudG9EYXRhVVJMKCk7CiAgICAgIHRoaXMuaW1hZ2UgPSBpbWFnZTsKICAgICAgdGhpcy5kaXYuc2V0QXR0cmlidXRlKCJkYXRhLWxvYWRlZCIsIHRydWUpOwogICAgICB0aGlzLnJpbmcuYXBwZW5kQ2hpbGQoaW1hZ2UpOwogICAgICB0aGlzLmNhbnZhcy53aWR0aCA9IDA7CiAgICAgIHRoaXMuY2FudmFzLmhlaWdodCA9IDA7CiAgICAgIGRlbGV0ZSB0aGlzLmNhbnZhczsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJkcmF3IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBkcmF3KCkgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIGlmICh0aGlzLnJlbmRlcmluZ1N0YXRlICE9PSBfcGRmX3JlbmRlcmluZ19xdWV1ZS5SZW5kZXJpbmdTdGF0ZXMuSU5JVElBTCkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoIk11c3QgYmUgaW4gbmV3IHN0YXRlIGJlZm9yZSBkcmF3aW5nIik7CiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh1bmRlZmluZWQpOwogICAgICB9CgogICAgICB2YXIgcGRmUGFnZSA9IHRoaXMucGRmUGFnZTsKCiAgICAgIGlmICghcGRmUGFnZSkgewogICAgICAgIHRoaXMucmVuZGVyaW5nU3RhdGUgPSBfcGRmX3JlbmRlcmluZ19xdWV1ZS5SZW5kZXJpbmdTdGF0ZXMuRklOSVNIRUQ7CiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcigicGRmUGFnZSBpcyBub3QgbG9hZGVkIikpOwogICAgICB9CgogICAgICB0aGlzLnJlbmRlcmluZ1N0YXRlID0gX3BkZl9yZW5kZXJpbmdfcXVldWUuUmVuZGVyaW5nU3RhdGVzLlJVTk5JTkc7CiAgICAgIHZhciByZW5kZXJDYXBhYmlsaXR5ID0gKDAsIF9wZGZqc0xpYi5jcmVhdGVQcm9taXNlQ2FwYWJpbGl0eSkoKTsKCiAgICAgIHZhciBmaW5pc2hSZW5kZXJUYXNrID0gZnVuY3Rpb24gZmluaXNoUmVuZGVyVGFzayhlcnJvcikgewogICAgICAgIGlmIChyZW5kZXJUYXNrID09PSBfdGhpczIucmVuZGVyVGFzaykgewogICAgICAgICAgX3RoaXMyLnJlbmRlclRhc2sgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgX3BkZmpzTGliLlJlbmRlcmluZ0NhbmNlbGxlZEV4Y2VwdGlvbikgewogICAgICAgICAgcmVuZGVyQ2FwYWJpbGl0eS5yZXNvbHZlKHVuZGVmaW5lZCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBfdGhpczIucmVuZGVyaW5nU3RhdGUgPSBfcGRmX3JlbmRlcmluZ19xdWV1ZS5SZW5kZXJpbmdTdGF0ZXMuRklOSVNIRUQ7CgogICAgICAgIF90aGlzMi5fY29udmVydENhbnZhc1RvSW1hZ2UoKTsKCiAgICAgICAgaWYgKCFlcnJvcikgewogICAgICAgICAgcmVuZGVyQ2FwYWJpbGl0eS5yZXNvbHZlKHVuZGVmaW5lZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlbmRlckNhcGFiaWxpdHkucmVqZWN0KGVycm9yKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICB2YXIgY3R4ID0gdGhpcy5fZ2V0UGFnZURyYXdDb250ZXh0KCk7CgogICAgICB2YXIgZHJhd1ZpZXdwb3J0ID0gdGhpcy52aWV3cG9ydC5jbG9uZSh7CiAgICAgICAgc2NhbGU6IHRoaXMuc2NhbGUKICAgICAgfSk7CgogICAgICB2YXIgcmVuZGVyQ29udGludWVDYWxsYmFjayA9IGZ1bmN0aW9uIHJlbmRlckNvbnRpbnVlQ2FsbGJhY2soY29udCkgewogICAgICAgIGlmICghX3RoaXMyLnJlbmRlcmluZ1F1ZXVlLmlzSGlnaGVzdFByaW9yaXR5KF90aGlzMikpIHsKICAgICAgICAgIF90aGlzMi5yZW5kZXJpbmdTdGF0ZSA9IF9wZGZfcmVuZGVyaW5nX3F1ZXVlLlJlbmRlcmluZ1N0YXRlcy5QQVVTRUQ7CgogICAgICAgICAgX3RoaXMyLnJlc3VtZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgX3RoaXMyLnJlbmRlcmluZ1N0YXRlID0gX3BkZl9yZW5kZXJpbmdfcXVldWUuUmVuZGVyaW5nU3RhdGVzLlJVTk5JTkc7CiAgICAgICAgICAgIGNvbnQoKTsKICAgICAgICAgIH07CgogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29udCgpOwogICAgICB9OwoKICAgICAgdmFyIHJlbmRlckNvbnRleHQgPSB7CiAgICAgICAgY2FudmFzQ29udGV4dDogY3R4LAogICAgICAgIHZpZXdwb3J0OiBkcmF3Vmlld3BvcnQKICAgICAgfTsKICAgICAgdmFyIHJlbmRlclRhc2sgPSB0aGlzLnJlbmRlclRhc2sgPSBwZGZQYWdlLnJlbmRlcihyZW5kZXJDb250ZXh0KTsKICAgICAgcmVuZGVyVGFzay5vbkNvbnRpbnVlID0gcmVuZGVyQ29udGludWVDYWxsYmFjazsKICAgICAgcmVuZGVyVGFzay5wcm9taXNlLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgIGZpbmlzaFJlbmRlclRhc2sobnVsbCk7CiAgICAgIH0sIGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgIGZpbmlzaFJlbmRlclRhc2soZXJyb3IpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJlbmRlckNhcGFiaWxpdHkucHJvbWlzZTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJzZXRJbWFnZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2V0SW1hZ2UocGFnZVZpZXcpIHsKICAgICAgaWYgKHRoaXMucmVuZGVyaW5nU3RhdGUgIT09IF9wZGZfcmVuZGVyaW5nX3F1ZXVlLlJlbmRlcmluZ1N0YXRlcy5JTklUSUFMKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgaW1nID0gcGFnZVZpZXcuY2FudmFzOwoKICAgICAgaWYgKCFpbWcpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5wZGZQYWdlKSB7CiAgICAgICAgdGhpcy5zZXRQZGZQYWdlKHBhZ2VWaWV3LnBkZlBhZ2UpOwogICAgICB9CgogICAgICB0aGlzLnJlbmRlcmluZ1N0YXRlID0gX3BkZl9yZW5kZXJpbmdfcXVldWUuUmVuZGVyaW5nU3RhdGVzLkZJTklTSEVEOwoKICAgICAgdmFyIGN0eCA9IHRoaXMuX2dldFBhZ2VEcmF3Q29udGV4dCh0cnVlKTsKCiAgICAgIHZhciBjYW52YXMgPSBjdHguY2FudmFzOwoKICAgICAgaWYgKGltZy53aWR0aCA8PSAyICogY2FudmFzLndpZHRoKSB7CiAgICAgICAgY3R4LmRyYXdJbWFnZShpbWcsIDAsIDAsIGltZy53aWR0aCwgaW1nLmhlaWdodCwgMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTsKCiAgICAgICAgdGhpcy5fY29udmVydENhbnZhc1RvSW1hZ2UoKTsKCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgcmVkdWNlZFdpZHRoID0gY2FudmFzLndpZHRoIDw8IE1BWF9OVU1fU0NBTElOR19TVEVQUzsKICAgICAgdmFyIHJlZHVjZWRIZWlnaHQgPSBjYW52YXMuaGVpZ2h0IDw8IE1BWF9OVU1fU0NBTElOR19TVEVQUzsKICAgICAgdmFyIHJlZHVjZWRJbWFnZSA9IFRlbXBJbWFnZUZhY3RvcnkuZ2V0Q2FudmFzKHJlZHVjZWRXaWR0aCwgcmVkdWNlZEhlaWdodCk7CiAgICAgIHZhciByZWR1Y2VkSW1hZ2VDdHggPSByZWR1Y2VkSW1hZ2UuZ2V0Q29udGV4dCgiMmQiKTsKCiAgICAgIHdoaWxlIChyZWR1Y2VkV2lkdGggPiBpbWcud2lkdGggfHwgcmVkdWNlZEhlaWdodCA+IGltZy5oZWlnaHQpIHsKICAgICAgICByZWR1Y2VkV2lkdGggPj49IDE7CiAgICAgICAgcmVkdWNlZEhlaWdodCA+Pj0gMTsKICAgICAgfQoKICAgICAgcmVkdWNlZEltYWdlQ3R4LmRyYXdJbWFnZShpbWcsIDAsIDAsIGltZy53aWR0aCwgaW1nLmhlaWdodCwgMCwgMCwgcmVkdWNlZFdpZHRoLCByZWR1Y2VkSGVpZ2h0KTsKCiAgICAgIHdoaWxlIChyZWR1Y2VkV2lkdGggPiAyICogY2FudmFzLndpZHRoKSB7CiAgICAgICAgcmVkdWNlZEltYWdlQ3R4LmRyYXdJbWFnZShyZWR1Y2VkSW1hZ2UsIDAsIDAsIHJlZHVjZWRXaWR0aCwgcmVkdWNlZEhlaWdodCwgMCwgMCwgcmVkdWNlZFdpZHRoID4+IDEsIHJlZHVjZWRIZWlnaHQgPj4gMSk7CiAgICAgICAgcmVkdWNlZFdpZHRoID4+PSAxOwogICAgICAgIHJlZHVjZWRIZWlnaHQgPj49IDE7CiAgICAgIH0KCiAgICAgIGN0eC5kcmF3SW1hZ2UocmVkdWNlZEltYWdlLCAwLCAwLCByZWR1Y2VkV2lkdGgsIHJlZHVjZWRIZWlnaHQsIDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7CgogICAgICB0aGlzLl9jb252ZXJ0Q2FudmFzVG9JbWFnZSgpOwogICAgfQogIH0sIHsKICAgIGtleTogInNldFBhZ2VMYWJlbCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2V0UGFnZUxhYmVsKGxhYmVsKSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgdGhpcy5wYWdlTGFiZWwgPSB0eXBlb2YgbGFiZWwgPT09ICJzdHJpbmciID8gbGFiZWwgOiBudWxsOwoKICAgICAgdGhpcy5fdGh1bWJQYWdlVGl0bGUudGhlbihmdW5jdGlvbiAobXNnKSB7CiAgICAgICAgX3RoaXMzLmFuY2hvci50aXRsZSA9IG1zZzsKICAgICAgfSk7CgogICAgICBpZiAodGhpcy5yZW5kZXJpbmdTdGF0ZSAhPT0gX3BkZl9yZW5kZXJpbmdfcXVldWUuUmVuZGVyaW5nU3RhdGVzLkZJTklTSEVEKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLl90aHVtYlBhZ2VDYW52YXMudGhlbihmdW5jdGlvbiAobXNnKSB7CiAgICAgICAgaWYgKF90aGlzMy5pbWFnZSkgewogICAgICAgICAgX3RoaXMzLmltYWdlLnNldEF0dHJpYnV0ZSgiYXJpYS1sYWJlbCIsIG1zZyk7CiAgICAgICAgfSBlbHNlIGlmIChfdGhpczMuZGlzYWJsZUNhbnZhc1RvSW1hZ2VDb252ZXJzaW9uICYmIF90aGlzMy5jYW52YXMpIHsKICAgICAgICAgIF90aGlzMy5jYW52YXMuc2V0QXR0cmlidXRlKCJhcmlhLWxhYmVsIiwgbXNnKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogIl90aHVtYlBhZ2VUaXRsZSIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMubDEwbi5nZXQoInRodW1iX3BhZ2VfdGl0bGUiLCB7CiAgICAgICAgcGFnZTogdGhpcy5wYWdlTGFiZWwgIT09IG51bGwgPyB0aGlzLnBhZ2VMYWJlbCA6IHRoaXMuaWQKICAgICAgfSwgIlBhZ2Uge3twYWdlfX0iKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfdGh1bWJQYWdlQ2FudmFzIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5sMTBuLmdldCgidGh1bWJfcGFnZV9jYW52YXMiLCB7CiAgICAgICAgcGFnZTogdGhpcy5wYWdlTGFiZWwgIT09IG51bGwgPyB0aGlzLnBhZ2VMYWJlbCA6IHRoaXMuaWQKICAgICAgfSwgIlRodW1ibmFpbCBvZiBQYWdlIHt7cGFnZX19Iik7CiAgICB9CiAgfV0sIFt7CiAgICBrZXk6ICJjbGVhbnVwIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjbGVhbnVwKCkgewogICAgICBUZW1wSW1hZ2VGYWN0b3J5LmRlc3Ryb3lDYW52YXMoKTsKICAgIH0KICB9XSk7CgogIHJldHVybiBQREZUaHVtYm5haWxWaWV3Owp9KCk7CgpleHBvcnRzLlBERlRodW1ibmFpbFZpZXcgPSBQREZUaHVtYm5haWxWaWV3OwoKLyoqKi8gfSksCi8qIDI3ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuUERGVmlld2VyID0gdm9pZCAwOwoKdmFyIF9iYXNlX3ZpZXdlciA9IF9fd2VicGFja19yZXF1aXJlX18oMjgpOwoKdmFyIF9wZGZqc0xpYiA9IF9fd2VicGFja19yZXF1aXJlX18oOCk7CgpmdW5jdGlvbiBfdHlwZW9mKG9iaikgeyAiQGJhYmVsL2hlbHBlcnMgLSB0eXBlb2YiOyBpZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgU3ltYm9sLml0ZXJhdG9yID09PSAic3ltYm9sIikgeyBfdHlwZW9mID0gZnVuY3Rpb24gX3R5cGVvZihvYmopIHsgcmV0dXJuIHR5cGVvZiBvYmo7IH07IH0gZWxzZSB7IF90eXBlb2YgPSBmdW5jdGlvbiBfdHlwZW9mKG9iaikgeyByZXR1cm4gb2JqICYmIHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgb2JqLmNvbnN0cnVjdG9yID09PSBTeW1ib2wgJiYgb2JqICE9PSBTeW1ib2wucHJvdG90eXBlID8gInN5bWJvbCIgOiB0eXBlb2Ygb2JqOyB9OyB9IHJldHVybiBfdHlwZW9mKG9iaik7IH0KCmZ1bmN0aW9uIF9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyKG8sIGFsbG93QXJyYXlMaWtlKSB7IHZhciBpdDsgaWYgKHR5cGVvZiBTeW1ib2wgPT09ICJ1bmRlZmluZWQiIHx8IG9bU3ltYm9sLml0ZXJhdG9yXSA9PSBudWxsKSB7IGlmIChBcnJheS5pc0FycmF5KG8pIHx8IChpdCA9IF91bnN1cHBvcnRlZEl0ZXJhYmxlVG9BcnJheShvKSkgfHwgYWxsb3dBcnJheUxpa2UgJiYgbyAmJiB0eXBlb2Ygby5sZW5ndGggPT09ICJudW1iZXIiKSB7IGlmIChpdCkgbyA9IGl0OyB2YXIgaSA9IDA7IHZhciBGID0gZnVuY3Rpb24gRigpIHt9OyByZXR1cm4geyBzOiBGLCBuOiBmdW5jdGlvbiBuKCkgeyBpZiAoaSA+PSBvLmxlbmd0aCkgcmV0dXJuIHsgZG9uZTogdHJ1ZSB9OyByZXR1cm4geyBkb25lOiBmYWxzZSwgdmFsdWU6IG9baSsrXSB9OyB9LCBlOiBmdW5jdGlvbiBlKF9lKSB7IHRocm93IF9lOyB9LCBmOiBGIH07IH0gdGhyb3cgbmV3IFR5cGVFcnJvcigiSW52YWxpZCBhdHRlbXB0IHRvIGl0ZXJhdGUgbm9uLWl0ZXJhYmxlIGluc3RhbmNlLlxuSW4gb3JkZXIgdG8gYmUgaXRlcmFibGUsIG5vbi1hcnJheSBvYmplY3RzIG11c3QgaGF2ZSBhIFtTeW1ib2wuaXRlcmF0b3JdKCkgbWV0aG9kLiIpOyB9IHZhciBub3JtYWxDb21wbGV0aW9uID0gdHJ1ZSwgZGlkRXJyID0gZmFsc2UsIGVycjsgcmV0dXJuIHsgczogZnVuY3Rpb24gcygpIHsgaXQgPSBvW1N5bWJvbC5pdGVyYXRvcl0oKTsgfSwgbjogZnVuY3Rpb24gbigpIHsgdmFyIHN0ZXAgPSBpdC5uZXh0KCk7IG5vcm1hbENvbXBsZXRpb24gPSBzdGVwLmRvbmU7IHJldHVybiBzdGVwOyB9LCBlOiBmdW5jdGlvbiBlKF9lMikgeyBkaWRFcnIgPSB0cnVlOyBlcnIgPSBfZTI7IH0sIGY6IGZ1bmN0aW9uIGYoKSB7IHRyeSB7IGlmICghbm9ybWFsQ29tcGxldGlvbiAmJiBpdFsicmV0dXJuIl0gIT0gbnVsbCkgaXRbInJldHVybiJdKCk7IH0gZmluYWxseSB7IGlmIChkaWRFcnIpIHRocm93IGVycjsgfSB9IH07IH0KCmZ1bmN0aW9uIF91bnN1cHBvcnRlZEl0ZXJhYmxlVG9BcnJheShvLCBtaW5MZW4pIHsgaWYgKCFvKSByZXR1cm47IGlmICh0eXBlb2YgbyA9PT0gInN0cmluZyIpIHJldHVybiBfYXJyYXlMaWtlVG9BcnJheShvLCBtaW5MZW4pOyB2YXIgbiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvKS5zbGljZSg4LCAtMSk7IGlmIChuID09PSAiT2JqZWN0IiAmJiBvLmNvbnN0cnVjdG9yKSBuID0gby5jb25zdHJ1Y3Rvci5uYW1lOyBpZiAobiA9PT0gIk1hcCIgfHwgbiA9PT0gIlNldCIpIHJldHVybiBBcnJheS5mcm9tKG8pOyBpZiAobiA9PT0gIkFyZ3VtZW50cyIgfHwgL14oPzpVaXxJKW50KD86OHwxNnwzMikoPzpDbGFtcGVkKT9BcnJheSQvLnRlc3QobikpIHJldHVybiBfYXJyYXlMaWtlVG9BcnJheShvLCBtaW5MZW4pOyB9CgpmdW5jdGlvbiBfYXJyYXlMaWtlVG9BcnJheShhcnIsIGxlbikgeyBpZiAobGVuID09IG51bGwgfHwgbGVuID4gYXJyLmxlbmd0aCkgbGVuID0gYXJyLmxlbmd0aDsgZm9yICh2YXIgaSA9IDAsIGFycjIgPSBuZXcgQXJyYXkobGVuKTsgaSA8IGxlbjsgaSsrKSB7IGFycjJbaV0gPSBhcnJbaV07IH0gcmV0dXJuIGFycjI7IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7IH0gfQoKZnVuY3Rpb24gX2RlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoInZhbHVlIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0KCmZ1bmN0aW9uIF9jcmVhdGVDbGFzcyhDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9CgpmdW5jdGlvbiBfZ2V0KHRhcmdldCwgcHJvcGVydHksIHJlY2VpdmVyKSB7IGlmICh0eXBlb2YgUmVmbGVjdCAhPT0gInVuZGVmaW5lZCIgJiYgUmVmbGVjdC5nZXQpIHsgX2dldCA9IFJlZmxlY3QuZ2V0OyB9IGVsc2UgeyBfZ2V0ID0gZnVuY3Rpb24gX2dldCh0YXJnZXQsIHByb3BlcnR5LCByZWNlaXZlcikgeyB2YXIgYmFzZSA9IF9zdXBlclByb3BCYXNlKHRhcmdldCwgcHJvcGVydHkpOyBpZiAoIWJhc2UpIHJldHVybjsgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGJhc2UsIHByb3BlcnR5KTsgaWYgKGRlc2MuZ2V0KSB7IHJldHVybiBkZXNjLmdldC5jYWxsKHJlY2VpdmVyKTsgfSByZXR1cm4gZGVzYy52YWx1ZTsgfTsgfSByZXR1cm4gX2dldCh0YXJnZXQsIHByb3BlcnR5LCByZWNlaXZlciB8fCB0YXJnZXQpOyB9CgpmdW5jdGlvbiBfc3VwZXJQcm9wQmFzZShvYmplY3QsIHByb3BlcnR5KSB7IHdoaWxlICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwgcHJvcGVydHkpKSB7IG9iamVjdCA9IF9nZXRQcm90b3R5cGVPZihvYmplY3QpOyBpZiAob2JqZWN0ID09PSBudWxsKSBicmVhazsgfSByZXR1cm4gb2JqZWN0OyB9CgpmdW5jdGlvbiBfaW5oZXJpdHMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAiZnVuY3Rpb24iICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24iKTsgfSBzdWJDbGFzcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ2xhc3MgJiYgc3VwZXJDbGFzcy5wcm90b3R5cGUsIHsgY29uc3RydWN0b3I6IHsgdmFsdWU6IHN1YkNsYXNzLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0gfSk7IGlmIChzdXBlckNsYXNzKSBfc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpOyB9CgpmdW5jdGlvbiBfc2V0UHJvdG90eXBlT2YobywgcCkgeyBfc2V0UHJvdG90eXBlT2YgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHwgZnVuY3Rpb24gX3NldFByb3RvdHlwZU9mKG8sIHApIHsgby5fX3Byb3RvX18gPSBwOyByZXR1cm4gbzsgfTsgcmV0dXJuIF9zZXRQcm90b3R5cGVPZihvLCBwKTsgfQoKZnVuY3Rpb24gX2NyZWF0ZVN1cGVyKERlcml2ZWQpIHsgdmFyIGhhc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QgPSBfaXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KCk7IHJldHVybiBmdW5jdGlvbiBfY3JlYXRlU3VwZXJJbnRlcm5hbCgpIHsgdmFyIFN1cGVyID0gX2dldFByb3RvdHlwZU9mKERlcml2ZWQpLCByZXN1bHQ7IGlmIChoYXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KSB7IHZhciBOZXdUYXJnZXQgPSBfZ2V0UHJvdG90eXBlT2YodGhpcykuY29uc3RydWN0b3I7IHJlc3VsdCA9IFJlZmxlY3QuY29uc3RydWN0KFN1cGVyLCBhcmd1bWVudHMsIE5ld1RhcmdldCk7IH0gZWxzZSB7IHJlc3VsdCA9IFN1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH0gcmV0dXJuIF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIHJlc3VsdCk7IH07IH0KCmZ1bmN0aW9uIF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHNlbGYsIGNhbGwpIHsgaWYgKGNhbGwgJiYgKF90eXBlb2YoY2FsbCkgPT09ICJvYmplY3QiIHx8IHR5cGVvZiBjYWxsID09PSAiZnVuY3Rpb24iKSkgeyByZXR1cm4gY2FsbDsgfSByZXR1cm4gX2Fzc2VydFRoaXNJbml0aWFsaXplZChzZWxmKTsgfQoKZnVuY3Rpb24gX2Fzc2VydFRoaXNJbml0aWFsaXplZChzZWxmKSB7IGlmIChzZWxmID09PSB2b2lkIDApIHsgdGhyb3cgbmV3IFJlZmVyZW5jZUVycm9yKCJ0aGlzIGhhc24ndCBiZWVuIGluaXRpYWxpc2VkIC0gc3VwZXIoKSBoYXNuJ3QgYmVlbiBjYWxsZWQiKTsgfSByZXR1cm4gc2VsZjsgfQoKZnVuY3Rpb24gX2lzTmF0aXZlUmVmbGVjdENvbnN0cnVjdCgpIHsgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSAidW5kZWZpbmVkIiB8fCAhUmVmbGVjdC5jb25zdHJ1Y3QpIHJldHVybiBmYWxzZTsgaWYgKFJlZmxlY3QuY29uc3RydWN0LnNoYW0pIHJldHVybiBmYWxzZTsgaWYgKHR5cGVvZiBQcm94eSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIHRydWU7IHRyeSB7IERhdGUucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoUmVmbGVjdC5jb25zdHJ1Y3QoRGF0ZSwgW10sIGZ1bmN0aW9uICgpIHt9KSk7IHJldHVybiB0cnVlOyB9IGNhdGNoIChlKSB7IHJldHVybiBmYWxzZTsgfSB9CgpmdW5jdGlvbiBfZ2V0UHJvdG90eXBlT2YobykgeyBfZ2V0UHJvdG90eXBlT2YgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3QuZ2V0UHJvdG90eXBlT2YgOiBmdW5jdGlvbiBfZ2V0UHJvdG90eXBlT2YobykgeyByZXR1cm4gby5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKG8pOyB9OyByZXR1cm4gX2dldFByb3RvdHlwZU9mKG8pOyB9Cgp2YXIgUERGVmlld2VyID0gLyojX19QVVJFX18qL2Z1bmN0aW9uIChfQmFzZVZpZXdlcikgewogIF9pbmhlcml0cyhQREZWaWV3ZXIsIF9CYXNlVmlld2VyKTsKCiAgdmFyIF9zdXBlciA9IF9jcmVhdGVTdXBlcihQREZWaWV3ZXIpOwoKICBmdW5jdGlvbiBQREZWaWV3ZXIoKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgUERGVmlld2VyKTsKCiAgICByZXR1cm4gX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfQoKICBfY3JlYXRlQ2xhc3MoUERGVmlld2VyLCBbewogICAga2V5OiAiX3Njcm9sbEludG9WaWV3IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfc2Nyb2xsSW50b1ZpZXcoX3JlZikgewogICAgICB2YXIgcGFnZURpdiA9IF9yZWYucGFnZURpdiwKICAgICAgICAgIF9yZWYkcGFnZVNwb3QgPSBfcmVmLnBhZ2VTcG90LAogICAgICAgICAgcGFnZVNwb3QgPSBfcmVmJHBhZ2VTcG90ID09PSB2b2lkIDAgPyBudWxsIDogX3JlZiRwYWdlU3BvdCwKICAgICAgICAgIF9yZWYkcGFnZU51bWJlciA9IF9yZWYucGFnZU51bWJlciwKICAgICAgICAgIHBhZ2VOdW1iZXIgPSBfcmVmJHBhZ2VOdW1iZXIgPT09IHZvaWQgMCA/IG51bGwgOiBfcmVmJHBhZ2VOdW1iZXI7CgogICAgICBpZiAoIXBhZ2VTcG90ICYmICF0aGlzLmlzSW5QcmVzZW50YXRpb25Nb2RlKSB7CiAgICAgICAgdmFyIGxlZnQgPSBwYWdlRGl2Lm9mZnNldExlZnQgKyBwYWdlRGl2LmNsaWVudExlZnQ7CiAgICAgICAgdmFyIHJpZ2h0ID0gbGVmdCArIHBhZ2VEaXYuY2xpZW50V2lkdGg7CiAgICAgICAgdmFyIF90aGlzJGNvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyLAogICAgICAgICAgICBzY3JvbGxMZWZ0ID0gX3RoaXMkY29udGFpbmVyLnNjcm9sbExlZnQsCiAgICAgICAgICAgIGNsaWVudFdpZHRoID0gX3RoaXMkY29udGFpbmVyLmNsaWVudFdpZHRoOwoKICAgICAgICBpZiAodGhpcy5faXNTY3JvbGxNb2RlSG9yaXpvbnRhbCB8fCBsZWZ0IDwgc2Nyb2xsTGVmdCB8fCByaWdodCA+IHNjcm9sbExlZnQgKyBjbGllbnRXaWR0aCkgewogICAgICAgICAgcGFnZVNwb3QgPSB7CiAgICAgICAgICAgIGxlZnQ6IDAsCiAgICAgICAgICAgIHRvcDogMAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIF9nZXQoX2dldFByb3RvdHlwZU9mKFBERlZpZXdlci5wcm90b3R5cGUpLCAiX3Njcm9sbEludG9WaWV3IiwgdGhpcykuY2FsbCh0aGlzLCB7CiAgICAgICAgcGFnZURpdjogcGFnZURpdiwKICAgICAgICBwYWdlU3BvdDogcGFnZVNwb3QsCiAgICAgICAgcGFnZU51bWJlcjogcGFnZU51bWJlcgogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfZ2V0VmlzaWJsZVBhZ2VzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfZ2V0VmlzaWJsZVBhZ2VzKCkgewogICAgICBpZiAodGhpcy5pc0luUHJlc2VudGF0aW9uTW9kZSkgewogICAgICAgIHJldHVybiB0aGlzLl9nZXRDdXJyZW50VmlzaWJsZVBhZ2UoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIF9nZXQoX2dldFByb3RvdHlwZU9mKFBERlZpZXdlci5wcm90b3R5cGUpLCAiX2dldFZpc2libGVQYWdlcyIsIHRoaXMpLmNhbGwodGhpcyk7CiAgICB9CiAgfSwgewogICAga2V5OiAiX3VwZGF0ZUhlbHBlciIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3VwZGF0ZUhlbHBlcih2aXNpYmxlUGFnZXMpIHsKICAgICAgaWYgKHRoaXMuaXNJblByZXNlbnRhdGlvbk1vZGUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBjdXJyZW50SWQgPSB0aGlzLl9jdXJyZW50UGFnZU51bWJlcjsKICAgICAgdmFyIHN0aWxsRnVsbHlWaXNpYmxlID0gZmFsc2U7CgogICAgICB2YXIgX2l0ZXJhdG9yID0gX2NyZWF0ZUZvck9mSXRlcmF0b3JIZWxwZXIodmlzaWJsZVBhZ2VzKSwKICAgICAgICAgIF9zdGVwOwoKICAgICAgdHJ5IHsKICAgICAgICBmb3IgKF9pdGVyYXRvci5zKCk7ICEoX3N0ZXAgPSBfaXRlcmF0b3IubigpKS5kb25lOykgewogICAgICAgICAgdmFyIHBhZ2UgPSBfc3RlcC52YWx1ZTsKCiAgICAgICAgICBpZiAocGFnZS5wZXJjZW50IDwgMTAwKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChwYWdlLmlkID09PSBjdXJyZW50SWQpIHsKICAgICAgICAgICAgc3RpbGxGdWxseVZpc2libGUgPSB0cnVlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIF9pdGVyYXRvci5lKGVycik7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgX2l0ZXJhdG9yLmYoKTsKICAgICAgfQoKICAgICAgaWYgKCFzdGlsbEZ1bGx5VmlzaWJsZSkgewogICAgICAgIGN1cnJlbnRJZCA9IHZpc2libGVQYWdlc1swXS5pZDsKICAgICAgfQoKICAgICAgdGhpcy5fc2V0Q3VycmVudFBhZ2VOdW1iZXIoY3VycmVudElkKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfdmlld2VyRWxlbWVudCIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuICgwLCBfcGRmanNMaWIuc2hhZG93KSh0aGlzLCAiX3ZpZXdlckVsZW1lbnQiLCB0aGlzLnZpZXdlcik7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gUERGVmlld2VyOwp9KF9iYXNlX3ZpZXdlci5CYXNlVmlld2VyKTsKCmV4cG9ydHMuUERGVmlld2VyID0gUERGVmlld2VyOwoKLyoqKi8gfSksCi8qIDI4ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuQmFzZVZpZXdlciA9IHZvaWQgMDsKCnZhciBfdWlfdXRpbHMgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUpOwoKdmFyIF9wZGZfcmVuZGVyaW5nX3F1ZXVlID0gX193ZWJwYWNrX3JlcXVpcmVfXygxMSk7Cgp2YXIgX2Fubm90YXRpb25fbGF5ZXJfYnVpbGRlciA9IF9fd2VicGFja19yZXF1aXJlX18oMjkpOwoKdmFyIF9wZGZqc0xpYiA9IF9fd2VicGFja19yZXF1aXJlX18oOCk7Cgp2YXIgX3BkZl9wYWdlX3ZpZXcgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMwKTsKCnZhciBfcGRmX2xpbmtfc2VydmljZSA9IF9fd2VicGFja19yZXF1aXJlX18oMjEpOwoKdmFyIF90ZXh0X2xheWVyX2J1aWxkZXIgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMxKTsKCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7IH0gfQoKZnVuY3Rpb24gX2RlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoInZhbHVlIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0KCmZ1bmN0aW9uIF9jcmVhdGVDbGFzcyhDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9Cgp2YXIgREVGQVVMVF9DQUNIRV9TSVpFID0gMTA7CgpmdW5jdGlvbiBQREZQYWdlVmlld0J1ZmZlcihzaXplKSB7CiAgdmFyIGRhdGEgPSBbXTsKCiAgdGhpcy5wdXNoID0gZnVuY3Rpb24gKHZpZXcpIHsKICAgIHZhciBpID0gZGF0YS5pbmRleE9mKHZpZXcpOwoKICAgIGlmIChpID49IDApIHsKICAgICAgZGF0YS5zcGxpY2UoaSwgMSk7CiAgICB9CgogICAgZGF0YS5wdXNoKHZpZXcpOwoKICAgIGlmIChkYXRhLmxlbmd0aCA+IHNpemUpIHsKICAgICAgZGF0YS5zaGlmdCgpLmRlc3Ryb3koKTsKICAgIH0KICB9OwoKICB0aGlzLnJlc2l6ZSA9IGZ1bmN0aW9uIChuZXdTaXplLCBwYWdlc1RvS2VlcCkgewogICAgc2l6ZSA9IG5ld1NpemU7CgogICAgaWYgKHBhZ2VzVG9LZWVwKSB7CiAgICAgIHZhciBwYWdlSWRzVG9LZWVwID0gbmV3IFNldCgpOwoKICAgICAgZm9yICh2YXIgaSA9IDAsIGlNYXggPSBwYWdlc1RvS2VlcC5sZW5ndGg7IGkgPCBpTWF4OyArK2kpIHsKICAgICAgICBwYWdlSWRzVG9LZWVwLmFkZChwYWdlc1RvS2VlcFtpXS5pZCk7CiAgICAgIH0KCiAgICAgICgwLCBfdWlfdXRpbHMubW92ZVRvRW5kT2ZBcnJheSkoZGF0YSwgZnVuY3Rpb24gKHBhZ2UpIHsKICAgICAgICByZXR1cm4gcGFnZUlkc1RvS2VlcC5oYXMocGFnZS5pZCk7CiAgICAgIH0pOwogICAgfQoKICAgIHdoaWxlIChkYXRhLmxlbmd0aCA+IHNpemUpIHsKICAgICAgZGF0YS5zaGlmdCgpLmRlc3Ryb3koKTsKICAgIH0KICB9Owp9CgpmdW5jdGlvbiBpc1NhbWVTY2FsZShvbGRTY2FsZSwgbmV3U2NhbGUpIHsKICBpZiAobmV3U2NhbGUgPT09IG9sZFNjYWxlKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIGlmIChNYXRoLmFicyhuZXdTY2FsZSAtIG9sZFNjYWxlKSA8IDFlLTE1KSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIHJldHVybiBmYWxzZTsKfQoKdmFyIEJhc2VWaWV3ZXIgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIEJhc2VWaWV3ZXIob3B0aW9ucykgewogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgQmFzZVZpZXdlcik7CgogICAgaWYgKHRoaXMuY29uc3RydWN0b3IgPT09IEJhc2VWaWV3ZXIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgaW5pdGlhbGl6ZSBCYXNlVmlld2VyLiIpOwogICAgfQoKICAgIHRoaXMuX25hbWUgPSB0aGlzLmNvbnN0cnVjdG9yLm5hbWU7CiAgICB0aGlzLmNvbnRhaW5lciA9IG9wdGlvbnMuY29udGFpbmVyOwogICAgdGhpcy52aWV3ZXIgPSBvcHRpb25zLnZpZXdlciB8fCBvcHRpb25zLmNvbnRhaW5lci5maXJzdEVsZW1lbnRDaGlsZDsKICAgIHRoaXMuZXZlbnRCdXMgPSBvcHRpb25zLmV2ZW50QnVzOwogICAgdGhpcy5saW5rU2VydmljZSA9IG9wdGlvbnMubGlua1NlcnZpY2UgfHwgbmV3IF9wZGZfbGlua19zZXJ2aWNlLlNpbXBsZUxpbmtTZXJ2aWNlKCk7CiAgICB0aGlzLmRvd25sb2FkTWFuYWdlciA9IG9wdGlvbnMuZG93bmxvYWRNYW5hZ2VyIHx8IG51bGw7CiAgICB0aGlzLmZpbmRDb250cm9sbGVyID0gb3B0aW9ucy5maW5kQ29udHJvbGxlciB8fCBudWxsOwogICAgdGhpcy5yZW1vdmVQYWdlQm9yZGVycyA9IG9wdGlvbnMucmVtb3ZlUGFnZUJvcmRlcnMgfHwgZmFsc2U7CiAgICB0aGlzLnRleHRMYXllck1vZGUgPSBOdW1iZXIuaXNJbnRlZ2VyKG9wdGlvbnMudGV4dExheWVyTW9kZSkgPyBvcHRpb25zLnRleHRMYXllck1vZGUgOiBfdWlfdXRpbHMuVGV4dExheWVyTW9kZS5FTkFCTEU7CiAgICB0aGlzLmltYWdlUmVzb3VyY2VzUGF0aCA9IG9wdGlvbnMuaW1hZ2VSZXNvdXJjZXNQYXRoIHx8ICIiOwogICAgdGhpcy5yZW5kZXJJbnRlcmFjdGl2ZUZvcm1zID0gb3B0aW9ucy5yZW5kZXJJbnRlcmFjdGl2ZUZvcm1zIHx8IGZhbHNlOwogICAgdGhpcy5lbmFibGVQcmludEF1dG9Sb3RhdGUgPSBvcHRpb25zLmVuYWJsZVByaW50QXV0b1JvdGF0ZSB8fCBmYWxzZTsKICAgIHRoaXMucmVuZGVyZXIgPSBvcHRpb25zLnJlbmRlcmVyIHx8IF91aV91dGlscy5SZW5kZXJlclR5cGUuQ0FOVkFTOwogICAgdGhpcy5lbmFibGVXZWJHTCA9IG9wdGlvbnMuZW5hYmxlV2ViR0wgfHwgZmFsc2U7CiAgICB0aGlzLnVzZU9ubHlDc3Nab29tID0gb3B0aW9ucy51c2VPbmx5Q3NzWm9vbSB8fCBmYWxzZTsKICAgIHRoaXMubWF4Q2FudmFzUGl4ZWxzID0gb3B0aW9ucy5tYXhDYW52YXNQaXhlbHM7CiAgICB0aGlzLmwxMG4gPSBvcHRpb25zLmwxMG4gfHwgX3VpX3V0aWxzLk51bGxMMTBuOwogICAgdGhpcy5kZWZhdWx0UmVuZGVyaW5nUXVldWUgPSAhb3B0aW9ucy5yZW5kZXJpbmdRdWV1ZTsKCiAgICBpZiAodGhpcy5kZWZhdWx0UmVuZGVyaW5nUXVldWUpIHsKICAgICAgdGhpcy5yZW5kZXJpbmdRdWV1ZSA9IG5ldyBfcGRmX3JlbmRlcmluZ19xdWV1ZS5QREZSZW5kZXJpbmdRdWV1ZSgpOwogICAgICB0aGlzLnJlbmRlcmluZ1F1ZXVlLnNldFZpZXdlcih0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMucmVuZGVyaW5nUXVldWUgPSBvcHRpb25zLnJlbmRlcmluZ1F1ZXVlOwogICAgfQoKICAgIHRoaXMuc2Nyb2xsID0gKDAsIF91aV91dGlscy53YXRjaFNjcm9sbCkodGhpcy5jb250YWluZXIsIHRoaXMuX3Njcm9sbFVwZGF0ZS5iaW5kKHRoaXMpKTsKICAgIHRoaXMucHJlc2VudGF0aW9uTW9kZVN0YXRlID0gX3VpX3V0aWxzLlByZXNlbnRhdGlvbk1vZGVTdGF0ZS5VTktOT1dOOwogICAgdGhpcy5fb25CZWZvcmVEcmF3ID0gdGhpcy5fb25BZnRlckRyYXcgPSBudWxsOwoKICAgIHRoaXMuX3Jlc2V0VmlldygpOwoKICAgIGlmICh0aGlzLnJlbW92ZVBhZ2VCb3JkZXJzKSB7CiAgICAgIHRoaXMudmlld2VyLmNsYXNzTGlzdC5hZGQoInJlbW92ZVBhZ2VCb3JkZXJzIik7CiAgICB9CgogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgIF90aGlzLmV2ZW50QnVzLmRpc3BhdGNoKCJiYXNldmlld2VyaW5pdCIsIHsKICAgICAgICBzb3VyY2U6IF90aGlzCiAgICAgIH0pOwogICAgfSk7CiAgfQoKICBfY3JlYXRlQ2xhc3MoQmFzZVZpZXdlciwgW3sKICAgIGtleTogImdldFBhZ2VWaWV3IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRQYWdlVmlldyhpbmRleCkgewogICAgICByZXR1cm4gdGhpcy5fcGFnZXNbaW5kZXhdOwogICAgfQogIH0sIHsKICAgIGtleTogIl9zZXRDdXJyZW50UGFnZU51bWJlciIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3NldEN1cnJlbnRQYWdlTnVtYmVyKHZhbCkgewogICAgICB2YXIgcmVzZXRDdXJyZW50UGFnZVZpZXcgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IGZhbHNlOwoKICAgICAgaWYgKHRoaXMuX2N1cnJlbnRQYWdlTnVtYmVyID09PSB2YWwpIHsKICAgICAgICBpZiAocmVzZXRDdXJyZW50UGFnZVZpZXcpIHsKICAgICAgICAgIHRoaXMuX3Jlc2V0Q3VycmVudFBhZ2VWaWV3KCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgaWYgKCEoMCA8IHZhbCAmJiB2YWwgPD0gdGhpcy5wYWdlc0NvdW50KSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgdGhpcy5fY3VycmVudFBhZ2VOdW1iZXIgPSB2YWw7CiAgICAgIHRoaXMuZXZlbnRCdXMuZGlzcGF0Y2goInBhZ2VjaGFuZ2luZyIsIHsKICAgICAgICBzb3VyY2U6IHRoaXMsCiAgICAgICAgcGFnZU51bWJlcjogdmFsLAogICAgICAgIHBhZ2VMYWJlbDogdGhpcy5fcGFnZUxhYmVscyAmJiB0aGlzLl9wYWdlTGFiZWxzW3ZhbCAtIDFdCiAgICAgIH0pOwoKICAgICAgaWYgKHJlc2V0Q3VycmVudFBhZ2VWaWV3KSB7CiAgICAgICAgdGhpcy5fcmVzZXRDdXJyZW50UGFnZVZpZXcoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfSwgewogICAga2V5OiAiX29uZVBhZ2VSZW5kZXJlZE9yRm9yY2VGZXRjaCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uZVBhZ2VSZW5kZXJlZE9yRm9yY2VGZXRjaCgpIHsKICAgICAgaWYgKCF0aGlzLmNvbnRhaW5lci5vZmZzZXRQYXJlbnQgfHwgdGhpcy5fZ2V0VmlzaWJsZVBhZ2VzKCkudmlld3MubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5fb25lUGFnZVJlbmRlcmVkQ2FwYWJpbGl0eS5wcm9taXNlOwogICAgfQogIH0sIHsKICAgIGtleTogInNldERvY3VtZW50IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXREb2N1bWVudChwZGZEb2N1bWVudCkgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIGlmICh0aGlzLnBkZkRvY3VtZW50KSB7CiAgICAgICAgdGhpcy5fY2FuY2VsUmVuZGVyaW5nKCk7CgogICAgICAgIHRoaXMuX3Jlc2V0VmlldygpOwoKICAgICAgICBpZiAodGhpcy5maW5kQ29udHJvbGxlcikgewogICAgICAgICAgdGhpcy5maW5kQ29udHJvbGxlci5zZXREb2N1bWVudChudWxsKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMucGRmRG9jdW1lbnQgPSBwZGZEb2N1bWVudDsKCiAgICAgIGlmICghcGRmRG9jdW1lbnQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBwYWdlc0NvdW50ID0gcGRmRG9jdW1lbnQubnVtUGFnZXM7CiAgICAgIHZhciBmaXJzdFBhZ2VQcm9taXNlID0gcGRmRG9jdW1lbnQuZ2V0UGFnZSgxKTsKCiAgICAgIHRoaXMuX3BhZ2VzQ2FwYWJpbGl0eS5wcm9taXNlLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzMi5ldmVudEJ1cy5kaXNwYXRjaCgicGFnZXNsb2FkZWQiLCB7CiAgICAgICAgICBzb3VyY2U6IF90aGlzMiwKICAgICAgICAgIHBhZ2VzQ291bnQ6IHBhZ2VzQ291bnQKICAgICAgICB9KTsKICAgICAgfSk7CgogICAgICB0aGlzLl9vbkJlZm9yZURyYXcgPSBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgICAgdmFyIHBhZ2VWaWV3ID0gX3RoaXMyLl9wYWdlc1tldnQucGFnZU51bWJlciAtIDFdOwoKICAgICAgICBpZiAoIXBhZ2VWaWV3KSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBfdGhpczIuX2J1ZmZlci5wdXNoKHBhZ2VWaWV3KTsKICAgICAgfTsKCiAgICAgIHRoaXMuZXZlbnRCdXMuX29uKCJwYWdlcmVuZGVyIiwgdGhpcy5fb25CZWZvcmVEcmF3KTsKCiAgICAgIHRoaXMuX29uQWZ0ZXJEcmF3ID0gZnVuY3Rpb24gKGV2dCkgewogICAgICAgIGlmIChldnQuY3NzVHJhbnNmb3JtIHx8IF90aGlzMi5fb25lUGFnZVJlbmRlcmVkQ2FwYWJpbGl0eS5zZXR0bGVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBfdGhpczIuX29uZVBhZ2VSZW5kZXJlZENhcGFiaWxpdHkucmVzb2x2ZSgpOwoKICAgICAgICBfdGhpczIuZXZlbnRCdXMuX29mZigicGFnZXJlbmRlcmVkIiwgX3RoaXMyLl9vbkFmdGVyRHJhdyk7CgogICAgICAgIF90aGlzMi5fb25BZnRlckRyYXcgPSBudWxsOwogICAgICB9OwoKICAgICAgdGhpcy5ldmVudEJ1cy5fb24oInBhZ2VyZW5kZXJlZCIsIHRoaXMuX29uQWZ0ZXJEcmF3KTsKCiAgICAgIGZpcnN0UGFnZVByb21pc2UudGhlbihmdW5jdGlvbiAoZmlyc3RQZGZQYWdlKSB7CiAgICAgICAgX3RoaXMyLl9maXJzdFBhZ2VDYXBhYmlsaXR5LnJlc29sdmUoZmlyc3RQZGZQYWdlKTsKCiAgICAgICAgdmFyIHNjYWxlID0gX3RoaXMyLmN1cnJlbnRTY2FsZTsKICAgICAgICB2YXIgdmlld3BvcnQgPSBmaXJzdFBkZlBhZ2UuZ2V0Vmlld3BvcnQoewogICAgICAgICAgc2NhbGU6IHNjYWxlICogX3VpX3V0aWxzLkNTU19VTklUUwogICAgICAgIH0pOwogICAgICAgIHZhciB0ZXh0TGF5ZXJGYWN0b3J5ID0gX3RoaXMyLnRleHRMYXllck1vZGUgIT09IF91aV91dGlscy5UZXh0TGF5ZXJNb2RlLkRJU0FCTEUgPyBfdGhpczIgOiBudWxsOwoKICAgICAgICBmb3IgKHZhciBwYWdlTnVtID0gMTsgcGFnZU51bSA8PSBwYWdlc0NvdW50OyArK3BhZ2VOdW0pIHsKICAgICAgICAgIHZhciBwYWdlVmlldyA9IG5ldyBfcGRmX3BhZ2Vfdmlldy5QREZQYWdlVmlldyh7CiAgICAgICAgICAgIGNvbnRhaW5lcjogX3RoaXMyLl92aWV3ZXJFbGVtZW50LAogICAgICAgICAgICBldmVudEJ1czogX3RoaXMyLmV2ZW50QnVzLAogICAgICAgICAgICBpZDogcGFnZU51bSwKICAgICAgICAgICAgc2NhbGU6IHNjYWxlLAogICAgICAgICAgICBkZWZhdWx0Vmlld3BvcnQ6IHZpZXdwb3J0LmNsb25lKCksCiAgICAgICAgICAgIHJlbmRlcmluZ1F1ZXVlOiBfdGhpczIucmVuZGVyaW5nUXVldWUsCiAgICAgICAgICAgIHRleHRMYXllckZhY3Rvcnk6IHRleHRMYXllckZhY3RvcnksCiAgICAgICAgICAgIHRleHRMYXllck1vZGU6IF90aGlzMi50ZXh0TGF5ZXJNb2RlLAogICAgICAgICAgICBhbm5vdGF0aW9uTGF5ZXJGYWN0b3J5OiBfdGhpczIsCiAgICAgICAgICAgIGltYWdlUmVzb3VyY2VzUGF0aDogX3RoaXMyLmltYWdlUmVzb3VyY2VzUGF0aCwKICAgICAgICAgICAgcmVuZGVySW50ZXJhY3RpdmVGb3JtczogX3RoaXMyLnJlbmRlckludGVyYWN0aXZlRm9ybXMsCiAgICAgICAgICAgIHJlbmRlcmVyOiBfdGhpczIucmVuZGVyZXIsCiAgICAgICAgICAgIGVuYWJsZVdlYkdMOiBfdGhpczIuZW5hYmxlV2ViR0wsCiAgICAgICAgICAgIHVzZU9ubHlDc3Nab29tOiBfdGhpczIudXNlT25seUNzc1pvb20sCiAgICAgICAgICAgIG1heENhbnZhc1BpeGVsczogX3RoaXMyLm1heENhbnZhc1BpeGVscywKICAgICAgICAgICAgbDEwbjogX3RoaXMyLmwxMG4KICAgICAgICAgIH0pOwoKICAgICAgICAgIF90aGlzMi5fcGFnZXMucHVzaChwYWdlVmlldyk7CiAgICAgICAgfQoKICAgICAgICB2YXIgZmlyc3RQYWdlVmlldyA9IF90aGlzMi5fcGFnZXNbMF07CgogICAgICAgIGlmIChmaXJzdFBhZ2VWaWV3KSB7CiAgICAgICAgICBmaXJzdFBhZ2VWaWV3LnNldFBkZlBhZ2UoZmlyc3RQZGZQYWdlKTsKCiAgICAgICAgICBfdGhpczIubGlua1NlcnZpY2UuY2FjaGVQYWdlUmVmKDEsIGZpcnN0UGRmUGFnZS5yZWYpOwogICAgICAgIH0KCiAgICAgICAgaWYgKF90aGlzMi5fc3ByZWFkTW9kZSAhPT0gX3VpX3V0aWxzLlNwcmVhZE1vZGUuTk9ORSkgewogICAgICAgICAgX3RoaXMyLl91cGRhdGVTcHJlYWRNb2RlKCk7CiAgICAgICAgfQoKICAgICAgICBfdGhpczIuX29uZVBhZ2VSZW5kZXJlZE9yRm9yY2VGZXRjaCgpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKF90aGlzMi5maW5kQ29udHJvbGxlcikgewogICAgICAgICAgICBfdGhpczIuZmluZENvbnRyb2xsZXIuc2V0RG9jdW1lbnQocGRmRG9jdW1lbnQpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChwZGZEb2N1bWVudC5sb2FkaW5nUGFyYW1zLmRpc2FibGVBdXRvRmV0Y2ggfHwgcGFnZXNDb3VudCA+IDc1MDApIHsKICAgICAgICAgICAgX3RoaXMyLl9wYWdlc0NhcGFiaWxpdHkucmVzb2x2ZSgpOwoKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBnZXRQYWdlc0xlZnQgPSBwYWdlc0NvdW50IC0gMTsKCiAgICAgICAgICBpZiAoZ2V0UGFnZXNMZWZ0IDw9IDApIHsKICAgICAgICAgICAgX3RoaXMyLl9wYWdlc0NhcGFiaWxpdHkucmVzb2x2ZSgpOwoKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBfbG9vcCA9IGZ1bmN0aW9uIF9sb29wKF9wYWdlTnVtKSB7CiAgICAgICAgICAgIHBkZkRvY3VtZW50LmdldFBhZ2UoX3BhZ2VOdW0pLnRoZW4oZnVuY3Rpb24gKHBkZlBhZ2UpIHsKICAgICAgICAgICAgICB2YXIgcGFnZVZpZXcgPSBfdGhpczIuX3BhZ2VzW19wYWdlTnVtIC0gMV07CgogICAgICAgICAgICAgIGlmICghcGFnZVZpZXcucGRmUGFnZSkgewogICAgICAgICAgICAgICAgcGFnZVZpZXcuc2V0UGRmUGFnZShwZGZQYWdlKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIF90aGlzMi5saW5rU2VydmljZS5jYWNoZVBhZ2VSZWYoX3BhZ2VOdW0sIHBkZlBhZ2UucmVmKTsKCiAgICAgICAgICAgICAgaWYgKC0tZ2V0UGFnZXNMZWZ0ID09PSAwKSB7CiAgICAgICAgICAgICAgICBfdGhpczIuX3BhZ2VzQ2FwYWJpbGl0eS5yZXNvbHZlKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigiVW5hYmxlIHRvIGdldCBwYWdlICIuY29uY2F0KF9wYWdlTnVtLCAiIHRvIGluaXRpYWxpemUgdmlld2VyIiksIHJlYXNvbik7CgogICAgICAgICAgICAgIGlmICgtLWdldFBhZ2VzTGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgX3RoaXMyLl9wYWdlc0NhcGFiaWxpdHkucmVzb2x2ZSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwoKICAgICAgICAgIGZvciAodmFyIF9wYWdlTnVtID0gMjsgX3BhZ2VOdW0gPD0gcGFnZXNDb3VudDsgKytfcGFnZU51bSkgewogICAgICAgICAgICBfbG9vcChfcGFnZU51bSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIF90aGlzMi5ldmVudEJ1cy5kaXNwYXRjaCgicGFnZXNpbml0IiwgewogICAgICAgICAgc291cmNlOiBfdGhpczIKICAgICAgICB9KTsKCiAgICAgICAgaWYgKF90aGlzMi5kZWZhdWx0UmVuZGVyaW5nUXVldWUpIHsKICAgICAgICAgIF90aGlzMi51cGRhdGUoKTsKICAgICAgICB9CiAgICAgIH0pWyJjYXRjaCJdKGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJVbmFibGUgdG8gaW5pdGlhbGl6ZSB2aWV3ZXIiLCByZWFzb24pOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJzZXRQYWdlTGFiZWxzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRQYWdlTGFiZWxzKGxhYmVscykgewogICAgICBpZiAoIXRoaXMucGRmRG9jdW1lbnQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICghbGFiZWxzKSB7CiAgICAgICAgdGhpcy5fcGFnZUxhYmVscyA9IG51bGw7CiAgICAgIH0gZWxzZSBpZiAoIShBcnJheS5pc0FycmF5KGxhYmVscykgJiYgdGhpcy5wZGZEb2N1bWVudC5udW1QYWdlcyA9PT0gbGFiZWxzLmxlbmd0aCkpIHsKICAgICAgICB0aGlzLl9wYWdlTGFiZWxzID0gbnVsbDsKICAgICAgICBjb25zb2xlLmVycm9yKCIiLmNvbmNhdCh0aGlzLl9uYW1lLCAiLnNldFBhZ2VMYWJlbHM6IEludmFsaWQgcGFnZSBsYWJlbHMuIikpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX3BhZ2VMYWJlbHMgPSBsYWJlbHM7CiAgICAgIH0KCiAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IHRoaXMuX3BhZ2VzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICB2YXIgcGFnZVZpZXcgPSB0aGlzLl9wYWdlc1tpXTsKICAgICAgICB2YXIgbGFiZWwgPSB0aGlzLl9wYWdlTGFiZWxzICYmIHRoaXMuX3BhZ2VMYWJlbHNbaV07CiAgICAgICAgcGFnZVZpZXcuc2V0UGFnZUxhYmVsKGxhYmVsKTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogIl9yZXNldFZpZXciLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9yZXNldFZpZXcoKSB7CiAgICAgIHRoaXMuX3BhZ2VzID0gW107CiAgICAgIHRoaXMuX2N1cnJlbnRQYWdlTnVtYmVyID0gMTsKICAgICAgdGhpcy5fY3VycmVudFNjYWxlID0gX3VpX3V0aWxzLlVOS05PV05fU0NBTEU7CiAgICAgIHRoaXMuX2N1cnJlbnRTY2FsZVZhbHVlID0gbnVsbDsKICAgICAgdGhpcy5fcGFnZUxhYmVscyA9IG51bGw7CiAgICAgIHRoaXMuX2J1ZmZlciA9IG5ldyBQREZQYWdlVmlld0J1ZmZlcihERUZBVUxUX0NBQ0hFX1NJWkUpOwogICAgICB0aGlzLl9sb2NhdGlvbiA9IG51bGw7CiAgICAgIHRoaXMuX3BhZ2VzUm90YXRpb24gPSAwOwogICAgICB0aGlzLl9wYWdlc1JlcXVlc3RzID0gbmV3IFdlYWtNYXAoKTsKICAgICAgdGhpcy5fZmlyc3RQYWdlQ2FwYWJpbGl0eSA9ICgwLCBfcGRmanNMaWIuY3JlYXRlUHJvbWlzZUNhcGFiaWxpdHkpKCk7CiAgICAgIHRoaXMuX29uZVBhZ2VSZW5kZXJlZENhcGFiaWxpdHkgPSAoMCwgX3BkZmpzTGliLmNyZWF0ZVByb21pc2VDYXBhYmlsaXR5KSgpOwogICAgICB0aGlzLl9wYWdlc0NhcGFiaWxpdHkgPSAoMCwgX3BkZmpzTGliLmNyZWF0ZVByb21pc2VDYXBhYmlsaXR5KSgpOwogICAgICB0aGlzLl9zY3JvbGxNb2RlID0gX3VpX3V0aWxzLlNjcm9sbE1vZGUuVkVSVElDQUw7CiAgICAgIHRoaXMuX3NwcmVhZE1vZGUgPSBfdWlfdXRpbHMuU3ByZWFkTW9kZS5OT05FOwoKICAgICAgaWYgKHRoaXMuX29uQmVmb3JlRHJhdykgewogICAgICAgIHRoaXMuZXZlbnRCdXMuX29mZigicGFnZXJlbmRlciIsIHRoaXMuX29uQmVmb3JlRHJhdyk7CgogICAgICAgIHRoaXMuX29uQmVmb3JlRHJhdyA9IG51bGw7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9vbkFmdGVyRHJhdykgewogICAgICAgIHRoaXMuZXZlbnRCdXMuX29mZigicGFnZXJlbmRlcmVkIiwgdGhpcy5fb25BZnRlckRyYXcpOwoKICAgICAgICB0aGlzLl9vbkFmdGVyRHJhdyA9IG51bGw7CiAgICAgIH0KCiAgICAgIHRoaXMudmlld2VyLnRleHRDb250ZW50ID0gIiI7CgogICAgICB0aGlzLl91cGRhdGVTY3JvbGxNb2RlKCk7CiAgICB9CiAgfSwgewogICAga2V5OiAiX3Njcm9sbFVwZGF0ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3Njcm9sbFVwZGF0ZSgpIHsKICAgICAgaWYgKHRoaXMucGFnZXNDb3VudCA9PT0gMCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy51cGRhdGUoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfc2Nyb2xsSW50b1ZpZXciLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9zY3JvbGxJbnRvVmlldyhfcmVmKSB7CiAgICAgIHZhciBwYWdlRGl2ID0gX3JlZi5wYWdlRGl2LAogICAgICAgICAgX3JlZiRwYWdlU3BvdCA9IF9yZWYucGFnZVNwb3QsCiAgICAgICAgICBwYWdlU3BvdCA9IF9yZWYkcGFnZVNwb3QgPT09IHZvaWQgMCA/IG51bGwgOiBfcmVmJHBhZ2VTcG90LAogICAgICAgICAgX3JlZiRwYWdlTnVtYmVyID0gX3JlZi5wYWdlTnVtYmVyLAogICAgICAgICAgcGFnZU51bWJlciA9IF9yZWYkcGFnZU51bWJlciA9PT0gdm9pZCAwID8gbnVsbCA6IF9yZWYkcGFnZU51bWJlcjsKICAgICAgKDAsIF91aV91dGlscy5zY3JvbGxJbnRvVmlldykocGFnZURpdiwgcGFnZVNwb3QpOwogICAgfQogIH0sIHsKICAgIGtleTogIl9zZXRTY2FsZVVwZGF0ZVBhZ2VzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfc2V0U2NhbGVVcGRhdGVQYWdlcyhuZXdTY2FsZSwgbmV3VmFsdWUpIHsKICAgICAgdmFyIG5vU2Nyb2xsID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMl0gOiBmYWxzZTsKICAgICAgdmFyIHByZXNldCA9IGFyZ3VtZW50cy5sZW5ndGggPiAzICYmIGFyZ3VtZW50c1szXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzNdIDogZmFsc2U7CiAgICAgIHRoaXMuX2N1cnJlbnRTY2FsZVZhbHVlID0gbmV3VmFsdWUudG9TdHJpbmcoKTsKCiAgICAgIGlmIChpc1NhbWVTY2FsZSh0aGlzLl9jdXJyZW50U2NhbGUsIG5ld1NjYWxlKSkgewogICAgICAgIGlmIChwcmVzZXQpIHsKICAgICAgICAgIHRoaXMuZXZlbnRCdXMuZGlzcGF0Y2goInNjYWxlY2hhbmdpbmciLCB7CiAgICAgICAgICAgIHNvdXJjZTogdGhpcywKICAgICAgICAgICAgc2NhbGU6IG5ld1NjYWxlLAogICAgICAgICAgICBwcmVzZXRWYWx1ZTogbmV3VmFsdWUKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBmb3IgKHZhciBpID0gMCwgaWkgPSB0aGlzLl9wYWdlcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgdGhpcy5fcGFnZXNbaV0udXBkYXRlKG5ld1NjYWxlKTsKICAgICAgfQoKICAgICAgdGhpcy5fY3VycmVudFNjYWxlID0gbmV3U2NhbGU7CgogICAgICBpZiAoIW5vU2Nyb2xsKSB7CiAgICAgICAgdmFyIHBhZ2UgPSB0aGlzLl9jdXJyZW50UGFnZU51bWJlciwKICAgICAgICAgICAgZGVzdDsKCiAgICAgICAgaWYgKHRoaXMuX2xvY2F0aW9uICYmICEodGhpcy5pc0luUHJlc2VudGF0aW9uTW9kZSB8fCB0aGlzLmlzQ2hhbmdpbmdQcmVzZW50YXRpb25Nb2RlKSkgewogICAgICAgICAgcGFnZSA9IHRoaXMuX2xvY2F0aW9uLnBhZ2VOdW1iZXI7CiAgICAgICAgICBkZXN0ID0gW251bGwsIHsKICAgICAgICAgICAgbmFtZTogIlhZWiIKICAgICAgICAgIH0sIHRoaXMuX2xvY2F0aW9uLmxlZnQsIHRoaXMuX2xvY2F0aW9uLnRvcCwgbnVsbF07CiAgICAgICAgfQoKICAgICAgICB0aGlzLnNjcm9sbFBhZ2VJbnRvVmlldyh7CiAgICAgICAgICBwYWdlTnVtYmVyOiBwYWdlLAogICAgICAgICAgZGVzdEFycmF5OiBkZXN0LAogICAgICAgICAgYWxsb3dOZWdhdGl2ZU9mZnNldDogdHJ1ZQogICAgICAgIH0pOwogICAgICB9CgogICAgICB0aGlzLmV2ZW50QnVzLmRpc3BhdGNoKCJzY2FsZWNoYW5naW5nIiwgewogICAgICAgIHNvdXJjZTogdGhpcywKICAgICAgICBzY2FsZTogbmV3U2NhbGUsCiAgICAgICAgcHJlc2V0VmFsdWU6IHByZXNldCA/IG5ld1ZhbHVlIDogdW5kZWZpbmVkCiAgICAgIH0pOwoKICAgICAgaWYgKHRoaXMuZGVmYXVsdFJlbmRlcmluZ1F1ZXVlKSB7CiAgICAgICAgdGhpcy51cGRhdGUoKTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogIl9zZXRTY2FsZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3NldFNjYWxlKHZhbHVlKSB7CiAgICAgIHZhciBub1Njcm9sbCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDogZmFsc2U7CiAgICAgIHZhciBzY2FsZSA9IHBhcnNlRmxvYXQodmFsdWUpOwoKICAgICAgaWYgKHNjYWxlID4gMCkgewogICAgICAgIHRoaXMuX3NldFNjYWxlVXBkYXRlUGFnZXMoc2NhbGUsIHZhbHVlLCBub1Njcm9sbCwgZmFsc2UpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBjdXJyZW50UGFnZSA9IHRoaXMuX3BhZ2VzW3RoaXMuX2N1cnJlbnRQYWdlTnVtYmVyIC0gMV07CgogICAgICAgIGlmICghY3VycmVudFBhZ2UpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBub1BhZGRpbmcgPSB0aGlzLmlzSW5QcmVzZW50YXRpb25Nb2RlIHx8IHRoaXMucmVtb3ZlUGFnZUJvcmRlcnM7CiAgICAgICAgdmFyIGhQYWRkaW5nID0gbm9QYWRkaW5nID8gMCA6IF91aV91dGlscy5TQ1JPTExCQVJfUEFERElORzsKICAgICAgICB2YXIgdlBhZGRpbmcgPSBub1BhZGRpbmcgPyAwIDogX3VpX3V0aWxzLlZFUlRJQ0FMX1BBRERJTkc7CgogICAgICAgIGlmICghbm9QYWRkaW5nICYmIHRoaXMuX2lzU2Nyb2xsTW9kZUhvcml6b250YWwpIHsKICAgICAgICAgIHZhciBfcmVmMiA9IFt2UGFkZGluZywgaFBhZGRpbmddOwogICAgICAgICAgaFBhZGRpbmcgPSBfcmVmMlswXTsKICAgICAgICAgIHZQYWRkaW5nID0gX3JlZjJbMV07CiAgICAgICAgfQoKICAgICAgICB2YXIgcGFnZVdpZHRoU2NhbGUgPSAodGhpcy5jb250YWluZXIuY2xpZW50V2lkdGggLSBoUGFkZGluZykgLyBjdXJyZW50UGFnZS53aWR0aCAqIGN1cnJlbnRQYWdlLnNjYWxlOwogICAgICAgIHZhciBwYWdlSGVpZ2h0U2NhbGUgPSAodGhpcy5jb250YWluZXIuY2xpZW50SGVpZ2h0IC0gdlBhZGRpbmcpIC8gY3VycmVudFBhZ2UuaGVpZ2h0ICogY3VycmVudFBhZ2Uuc2NhbGU7CgogICAgICAgIHN3aXRjaCAodmFsdWUpIHsKICAgICAgICAgIGNhc2UgInBhZ2UtYWN0dWFsIjoKICAgICAgICAgICAgc2NhbGUgPSAxOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlICJwYWdlLXdpZHRoIjoKICAgICAgICAgICAgc2NhbGUgPSBwYWdlV2lkdGhTY2FsZTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSAicGFnZS1oZWlnaHQiOgogICAgICAgICAgICBzY2FsZSA9IHBhZ2VIZWlnaHRTY2FsZTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSAicGFnZS1maXQiOgogICAgICAgICAgICBzY2FsZSA9IE1hdGgubWluKHBhZ2VXaWR0aFNjYWxlLCBwYWdlSGVpZ2h0U2NhbGUpOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlICJhdXRvIjoKICAgICAgICAgICAgdmFyIGhvcml6b250YWxTY2FsZSA9ICgwLCBfdWlfdXRpbHMuaXNQb3J0cmFpdE9yaWVudGF0aW9uKShjdXJyZW50UGFnZSkgPyBwYWdlV2lkdGhTY2FsZSA6IE1hdGgubWluKHBhZ2VIZWlnaHRTY2FsZSwgcGFnZVdpZHRoU2NhbGUpOwogICAgICAgICAgICBzY2FsZSA9IE1hdGgubWluKF91aV91dGlscy5NQVhfQVVUT19TQ0FMRSwgaG9yaXpvbnRhbFNjYWxlKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgY29uc29sZS5lcnJvcigiIi5jb25jYXQodGhpcy5fbmFtZSwgIi5fc2V0U2NhbGU6IFwiIikuY29uY2F0KHZhbHVlLCAiXCIgaXMgYW4gdW5rbm93biB6b29tIHZhbHVlLiIpKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fc2V0U2NhbGVVcGRhdGVQYWdlcyhzY2FsZSwgdmFsdWUsIG5vU2Nyb2xsLCB0cnVlKTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogIl9yZXNldEN1cnJlbnRQYWdlVmlldyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3Jlc2V0Q3VycmVudFBhZ2VWaWV3KCkgewogICAgICBpZiAodGhpcy5pc0luUHJlc2VudGF0aW9uTW9kZSkgewogICAgICAgIHRoaXMuX3NldFNjYWxlKHRoaXMuX2N1cnJlbnRTY2FsZVZhbHVlLCB0cnVlKTsKICAgICAgfQoKICAgICAgdmFyIHBhZ2VWaWV3ID0gdGhpcy5fcGFnZXNbdGhpcy5fY3VycmVudFBhZ2VOdW1iZXIgLSAxXTsKCiAgICAgIHRoaXMuX3Njcm9sbEludG9WaWV3KHsKICAgICAgICBwYWdlRGl2OiBwYWdlVmlldy5kaXYKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAic2Nyb2xsUGFnZUludG9WaWV3IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzY3JvbGxQYWdlSW50b1ZpZXcoX3JlZjMpIHsKICAgICAgdmFyIHBhZ2VOdW1iZXIgPSBfcmVmMy5wYWdlTnVtYmVyLAogICAgICAgICAgX3JlZjMkZGVzdEFycmF5ID0gX3JlZjMuZGVzdEFycmF5LAogICAgICAgICAgZGVzdEFycmF5ID0gX3JlZjMkZGVzdEFycmF5ID09PSB2b2lkIDAgPyBudWxsIDogX3JlZjMkZGVzdEFycmF5LAogICAgICAgICAgX3JlZjMkYWxsb3dOZWdhdGl2ZU9mID0gX3JlZjMuYWxsb3dOZWdhdGl2ZU9mZnNldCwKICAgICAgICAgIGFsbG93TmVnYXRpdmVPZmZzZXQgPSBfcmVmMyRhbGxvd05lZ2F0aXZlT2YgPT09IHZvaWQgMCA/IGZhbHNlIDogX3JlZjMkYWxsb3dOZWdhdGl2ZU9mLAogICAgICAgICAgX3JlZjMkaWdub3JlRGVzdGluYXRpID0gX3JlZjMuaWdub3JlRGVzdGluYXRpb25ab29tLAogICAgICAgICAgaWdub3JlRGVzdGluYXRpb25ab29tID0gX3JlZjMkaWdub3JlRGVzdGluYXRpID09PSB2b2lkIDAgPyBmYWxzZSA6IF9yZWYzJGlnbm9yZURlc3RpbmF0aTsKCiAgICAgIGlmICghdGhpcy5wZGZEb2N1bWVudCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHBhZ2VWaWV3ID0gTnVtYmVyLmlzSW50ZWdlcihwYWdlTnVtYmVyKSAmJiB0aGlzLl9wYWdlc1twYWdlTnVtYmVyIC0gMV07CgogICAgICBpZiAoIXBhZ2VWaWV3KSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiIi5jb25jYXQodGhpcy5fbmFtZSwgIi5zY3JvbGxQYWdlSW50b1ZpZXc6ICIpICsgIlwiIi5jb25jYXQocGFnZU51bWJlciwgIlwiIGlzIG5vdCBhIHZhbGlkIHBhZ2VOdW1iZXIgcGFyYW1ldGVyLiIpKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmlzSW5QcmVzZW50YXRpb25Nb2RlIHx8ICFkZXN0QXJyYXkpIHsKICAgICAgICB0aGlzLl9zZXRDdXJyZW50UGFnZU51bWJlcihwYWdlTnVtYmVyLCB0cnVlKTsKCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgeCA9IDAsCiAgICAgICAgICB5ID0gMDsKICAgICAgdmFyIHdpZHRoID0gMCwKICAgICAgICAgIGhlaWdodCA9IDAsCiAgICAgICAgICB3aWR0aFNjYWxlLAogICAgICAgICAgaGVpZ2h0U2NhbGU7CiAgICAgIHZhciBjaGFuZ2VPcmllbnRhdGlvbiA9IHBhZ2VWaWV3LnJvdGF0aW9uICUgMTgwICE9PSAwOwogICAgICB2YXIgcGFnZVdpZHRoID0gKGNoYW5nZU9yaWVudGF0aW9uID8gcGFnZVZpZXcuaGVpZ2h0IDogcGFnZVZpZXcud2lkdGgpIC8gcGFnZVZpZXcuc2NhbGUgLyBfdWlfdXRpbHMuQ1NTX1VOSVRTOwogICAgICB2YXIgcGFnZUhlaWdodCA9IChjaGFuZ2VPcmllbnRhdGlvbiA/IHBhZ2VWaWV3LndpZHRoIDogcGFnZVZpZXcuaGVpZ2h0KSAvIHBhZ2VWaWV3LnNjYWxlIC8gX3VpX3V0aWxzLkNTU19VTklUUzsKICAgICAgdmFyIHNjYWxlID0gMDsKCiAgICAgIHN3aXRjaCAoZGVzdEFycmF5WzFdLm5hbWUpIHsKICAgICAgICBjYXNlICJYWVoiOgogICAgICAgICAgeCA9IGRlc3RBcnJheVsyXTsKICAgICAgICAgIHkgPSBkZXN0QXJyYXlbM107CiAgICAgICAgICBzY2FsZSA9IGRlc3RBcnJheVs0XTsKICAgICAgICAgIHggPSB4ICE9PSBudWxsID8geCA6IDA7CiAgICAgICAgICB5ID0geSAhPT0gbnVsbCA/IHkgOiBwYWdlSGVpZ2h0OwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgIkZpdCI6CiAgICAgICAgY2FzZSAiRml0QiI6CiAgICAgICAgICBzY2FsZSA9ICJwYWdlLWZpdCI7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAiRml0SCI6CiAgICAgICAgY2FzZSAiRml0QkgiOgogICAgICAgICAgeSA9IGRlc3RBcnJheVsyXTsKICAgICAgICAgIHNjYWxlID0gInBhZ2Utd2lkdGgiOwoKICAgICAgICAgIGlmICh5ID09PSBudWxsICYmIHRoaXMuX2xvY2F0aW9uKSB7CiAgICAgICAgICAgIHggPSB0aGlzLl9sb2NhdGlvbi5sZWZ0OwogICAgICAgICAgICB5ID0gdGhpcy5fbG9jYXRpb24udG9wOwogICAgICAgICAgfQoKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICJGaXRWIjoKICAgICAgICBjYXNlICJGaXRCViI6CiAgICAgICAgICB4ID0gZGVzdEFycmF5WzJdOwogICAgICAgICAgd2lkdGggPSBwYWdlV2lkdGg7CiAgICAgICAgICBoZWlnaHQgPSBwYWdlSGVpZ2h0OwogICAgICAgICAgc2NhbGUgPSAicGFnZS1oZWlnaHQiOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgIkZpdFIiOgogICAgICAgICAgeCA9IGRlc3RBcnJheVsyXTsKICAgICAgICAgIHkgPSBkZXN0QXJyYXlbM107CiAgICAgICAgICB3aWR0aCA9IGRlc3RBcnJheVs0XSAtIHg7CiAgICAgICAgICBoZWlnaHQgPSBkZXN0QXJyYXlbNV0gLSB5OwogICAgICAgICAgdmFyIGhQYWRkaW5nID0gdGhpcy5yZW1vdmVQYWdlQm9yZGVycyA/IDAgOiBfdWlfdXRpbHMuU0NST0xMQkFSX1BBRERJTkc7CiAgICAgICAgICB2YXIgdlBhZGRpbmcgPSB0aGlzLnJlbW92ZVBhZ2VCb3JkZXJzID8gMCA6IF91aV91dGlscy5WRVJUSUNBTF9QQURESU5HOwogICAgICAgICAgd2lkdGhTY2FsZSA9ICh0aGlzLmNvbnRhaW5lci5jbGllbnRXaWR0aCAtIGhQYWRkaW5nKSAvIHdpZHRoIC8gX3VpX3V0aWxzLkNTU19VTklUUzsKICAgICAgICAgIGhlaWdodFNjYWxlID0gKHRoaXMuY29udGFpbmVyLmNsaWVudEhlaWdodCAtIHZQYWRkaW5nKSAvIGhlaWdodCAvIF91aV91dGlscy5DU1NfVU5JVFM7CiAgICAgICAgICBzY2FsZSA9IE1hdGgubWluKE1hdGguYWJzKHdpZHRoU2NhbGUpLCBNYXRoLmFicyhoZWlnaHRTY2FsZSkpOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBjb25zb2xlLmVycm9yKCIiLmNvbmNhdCh0aGlzLl9uYW1lLCAiLnNjcm9sbFBhZ2VJbnRvVmlldzogIikgKyAiXCIiLmNvbmNhdChkZXN0QXJyYXlbMV0ubmFtZSwgIlwiIGlzIG5vdCBhIHZhbGlkIGRlc3RpbmF0aW9uIHR5cGUuIikpOwogICAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoIWlnbm9yZURlc3RpbmF0aW9uWm9vbSkgewogICAgICAgIGlmIChzY2FsZSAmJiBzY2FsZSAhPT0gdGhpcy5fY3VycmVudFNjYWxlKSB7CiAgICAgICAgICB0aGlzLmN1cnJlbnRTY2FsZVZhbHVlID0gc2NhbGU7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9jdXJyZW50U2NhbGUgPT09IF91aV91dGlscy5VTktOT1dOX1NDQUxFKSB7CiAgICAgICAgICB0aGlzLmN1cnJlbnRTY2FsZVZhbHVlID0gX3VpX3V0aWxzLkRFRkFVTFRfU0NBTEVfVkFMVUU7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoc2NhbGUgPT09ICJwYWdlLWZpdCIgJiYgIWRlc3RBcnJheVs0XSkgewogICAgICAgIHRoaXMuX3Njcm9sbEludG9WaWV3KHsKICAgICAgICAgIHBhZ2VEaXY6IHBhZ2VWaWV3LmRpdiwKICAgICAgICAgIHBhZ2VOdW1iZXI6IHBhZ2VOdW1iZXIKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgYm91bmRpbmdSZWN0ID0gW3BhZ2VWaWV3LnZpZXdwb3J0LmNvbnZlcnRUb1ZpZXdwb3J0UG9pbnQoeCwgeSksIHBhZ2VWaWV3LnZpZXdwb3J0LmNvbnZlcnRUb1ZpZXdwb3J0UG9pbnQoeCArIHdpZHRoLCB5ICsgaGVpZ2h0KV07CiAgICAgIHZhciBsZWZ0ID0gTWF0aC5taW4oYm91bmRpbmdSZWN0WzBdWzBdLCBib3VuZGluZ1JlY3RbMV1bMF0pOwogICAgICB2YXIgdG9wID0gTWF0aC5taW4oYm91bmRpbmdSZWN0WzBdWzFdLCBib3VuZGluZ1JlY3RbMV1bMV0pOwoKICAgICAgaWYgKCFhbGxvd05lZ2F0aXZlT2Zmc2V0KSB7CiAgICAgICAgbGVmdCA9IE1hdGgubWF4KGxlZnQsIDApOwogICAgICAgIHRvcCA9IE1hdGgubWF4KHRvcCwgMCk7CiAgICAgIH0KCiAgICAgIHRoaXMuX3Njcm9sbEludG9WaWV3KHsKICAgICAgICBwYWdlRGl2OiBwYWdlVmlldy5kaXYsCiAgICAgICAgcGFnZVNwb3Q6IHsKICAgICAgICAgIGxlZnQ6IGxlZnQsCiAgICAgICAgICB0b3A6IHRvcAogICAgICAgIH0sCiAgICAgICAgcGFnZU51bWJlcjogcGFnZU51bWJlcgogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfdXBkYXRlTG9jYXRpb24iLAogICAgdmFsdWU6IGZ1bmN0aW9uIF91cGRhdGVMb2NhdGlvbihmaXJzdFBhZ2UpIHsKICAgICAgdmFyIGN1cnJlbnRTY2FsZSA9IHRoaXMuX2N1cnJlbnRTY2FsZTsKICAgICAgdmFyIGN1cnJlbnRTY2FsZVZhbHVlID0gdGhpcy5fY3VycmVudFNjYWxlVmFsdWU7CiAgICAgIHZhciBub3JtYWxpemVkU2NhbGVWYWx1ZSA9IHBhcnNlRmxvYXQoY3VycmVudFNjYWxlVmFsdWUpID09PSBjdXJyZW50U2NhbGUgPyBNYXRoLnJvdW5kKGN1cnJlbnRTY2FsZSAqIDEwMDAwKSAvIDEwMCA6IGN1cnJlbnRTY2FsZVZhbHVlOwogICAgICB2YXIgcGFnZU51bWJlciA9IGZpcnN0UGFnZS5pZDsKICAgICAgdmFyIHBkZk9wZW5QYXJhbXMgPSAiI3BhZ2U9IiArIHBhZ2VOdW1iZXI7CiAgICAgIHBkZk9wZW5QYXJhbXMgKz0gIiZ6b29tPSIgKyBub3JtYWxpemVkU2NhbGVWYWx1ZTsKICAgICAgdmFyIGN1cnJlbnRQYWdlVmlldyA9IHRoaXMuX3BhZ2VzW3BhZ2VOdW1iZXIgLSAxXTsKICAgICAgdmFyIGNvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyOwogICAgICB2YXIgdG9wTGVmdCA9IGN1cnJlbnRQYWdlVmlldy5nZXRQYWdlUG9pbnQoY29udGFpbmVyLnNjcm9sbExlZnQgLSBmaXJzdFBhZ2UueCwgY29udGFpbmVyLnNjcm9sbFRvcCAtIGZpcnN0UGFnZS55KTsKICAgICAgdmFyIGludExlZnQgPSBNYXRoLnJvdW5kKHRvcExlZnRbMF0pOwogICAgICB2YXIgaW50VG9wID0gTWF0aC5yb3VuZCh0b3BMZWZ0WzFdKTsKICAgICAgcGRmT3BlblBhcmFtcyArPSAiLCIgKyBpbnRMZWZ0ICsgIiwiICsgaW50VG9wOwogICAgICB0aGlzLl9sb2NhdGlvbiA9IHsKICAgICAgICBwYWdlTnVtYmVyOiBwYWdlTnVtYmVyLAogICAgICAgIHNjYWxlOiBub3JtYWxpemVkU2NhbGVWYWx1ZSwKICAgICAgICB0b3A6IGludFRvcCwKICAgICAgICBsZWZ0OiBpbnRMZWZ0LAogICAgICAgIHJvdGF0aW9uOiB0aGlzLl9wYWdlc1JvdGF0aW9uLAogICAgICAgIHBkZk9wZW5QYXJhbXM6IHBkZk9wZW5QYXJhbXMKICAgICAgfTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfdXBkYXRlSGVscGVyIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfdXBkYXRlSGVscGVyKHZpc2libGVQYWdlcykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIk5vdCBpbXBsZW1lbnRlZDogX3VwZGF0ZUhlbHBlciIpOwogICAgfQogIH0sIHsKICAgIGtleTogInVwZGF0ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdXBkYXRlKCkgewogICAgICB2YXIgdmlzaWJsZSA9IHRoaXMuX2dldFZpc2libGVQYWdlcygpOwoKICAgICAgdmFyIHZpc2libGVQYWdlcyA9IHZpc2libGUudmlld3MsCiAgICAgICAgICBudW1WaXNpYmxlUGFnZXMgPSB2aXNpYmxlUGFnZXMubGVuZ3RoOwoKICAgICAgaWYgKG51bVZpc2libGVQYWdlcyA9PT0gMCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIG5ld0NhY2hlU2l6ZSA9IE1hdGgubWF4KERFRkFVTFRfQ0FDSEVfU0laRSwgMiAqIG51bVZpc2libGVQYWdlcyArIDEpOwoKICAgICAgdGhpcy5fYnVmZmVyLnJlc2l6ZShuZXdDYWNoZVNpemUsIHZpc2libGVQYWdlcyk7CgogICAgICB0aGlzLnJlbmRlcmluZ1F1ZXVlLnJlbmRlckhpZ2hlc3RQcmlvcml0eSh2aXNpYmxlKTsKCiAgICAgIHRoaXMuX3VwZGF0ZUhlbHBlcih2aXNpYmxlUGFnZXMpOwoKICAgICAgdGhpcy5fdXBkYXRlTG9jYXRpb24odmlzaWJsZS5maXJzdCk7CgogICAgICB0aGlzLmV2ZW50QnVzLmRpc3BhdGNoKCJ1cGRhdGV2aWV3YXJlYSIsIHsKICAgICAgICBzb3VyY2U6IHRoaXMsCiAgICAgICAgbG9jYXRpb246IHRoaXMuX2xvY2F0aW9uCiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogImNvbnRhaW5zRWxlbWVudCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY29udGFpbnNFbGVtZW50KGVsZW1lbnQpIHsKICAgICAgcmV0dXJuIHRoaXMuY29udGFpbmVyLmNvbnRhaW5zKGVsZW1lbnQpOwogICAgfQogIH0sIHsKICAgIGtleTogImZvY3VzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBmb2N1cygpIHsKICAgICAgdGhpcy5jb250YWluZXIuZm9jdXMoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfZ2V0Q3VycmVudFZpc2libGVQYWdlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfZ2V0Q3VycmVudFZpc2libGVQYWdlKCkgewogICAgICBpZiAoIXRoaXMucGFnZXNDb3VudCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICB2aWV3czogW10KICAgICAgICB9OwogICAgICB9CgogICAgICB2YXIgcGFnZVZpZXcgPSB0aGlzLl9wYWdlc1t0aGlzLl9jdXJyZW50UGFnZU51bWJlciAtIDFdOwogICAgICB2YXIgZWxlbWVudCA9IHBhZ2VWaWV3LmRpdjsKICAgICAgdmFyIHZpZXcgPSB7CiAgICAgICAgaWQ6IHBhZ2VWaWV3LmlkLAogICAgICAgIHg6IGVsZW1lbnQub2Zmc2V0TGVmdCArIGVsZW1lbnQuY2xpZW50TGVmdCwKICAgICAgICB5OiBlbGVtZW50Lm9mZnNldFRvcCArIGVsZW1lbnQuY2xpZW50VG9wLAogICAgICAgIHZpZXc6IHBhZ2VWaWV3CiAgICAgIH07CiAgICAgIHJldHVybiB7CiAgICAgICAgZmlyc3Q6IHZpZXcsCiAgICAgICAgbGFzdDogdmlldywKICAgICAgICB2aWV3czogW3ZpZXddCiAgICAgIH07CiAgICB9CiAgfSwgewogICAga2V5OiAiX2dldFZpc2libGVQYWdlcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2dldFZpc2libGVQYWdlcygpIHsKICAgICAgcmV0dXJuICgwLCBfdWlfdXRpbHMuZ2V0VmlzaWJsZUVsZW1lbnRzKSh0aGlzLmNvbnRhaW5lciwgdGhpcy5fcGFnZXMsIHRydWUsIHRoaXMuX2lzU2Nyb2xsTW9kZUhvcml6b250YWwpOwogICAgfQogIH0sIHsKICAgIGtleTogImlzUGFnZVZpc2libGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGlzUGFnZVZpc2libGUocGFnZU51bWJlcikgewogICAgICBpZiAoIXRoaXMucGRmRG9jdW1lbnQpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGlmIChwYWdlTnVtYmVyIDwgMSB8fCBwYWdlTnVtYmVyID4gdGhpcy5wYWdlc0NvdW50KSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiIi5jb25jYXQodGhpcy5fbmFtZSwgIi5pc1BhZ2VWaXNpYmxlOiBcIiIpLmNvbmNhdChwYWdlTnVtYmVyLCAiXCIgaXMgb3V0IG9mIGJvdW5kcy4iKSk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5fZ2V0VmlzaWJsZVBhZ2VzKCkudmlld3Muc29tZShmdW5jdGlvbiAodmlldykgewogICAgICAgIHJldHVybiB2aWV3LmlkID09PSBwYWdlTnVtYmVyOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJjbGVhbnVwIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjbGVhbnVwKCkgewogICAgICBmb3IgKHZhciBpID0gMCwgaWkgPSB0aGlzLl9wYWdlcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgaWYgKHRoaXMuX3BhZ2VzW2ldICYmIHRoaXMuX3BhZ2VzW2ldLnJlbmRlcmluZ1N0YXRlICE9PSBfcGRmX3JlbmRlcmluZ19xdWV1ZS5SZW5kZXJpbmdTdGF0ZXMuRklOSVNIRUQpIHsKICAgICAgICAgIHRoaXMuX3BhZ2VzW2ldLnJlc2V0KCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAiX2NhbmNlbFJlbmRlcmluZyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2NhbmNlbFJlbmRlcmluZygpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGlpID0gdGhpcy5fcGFnZXMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgIGlmICh0aGlzLl9wYWdlc1tpXSkgewogICAgICAgICAgdGhpcy5fcGFnZXNbaV0uY2FuY2VsUmVuZGVyaW5nKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAiX2Vuc3VyZVBkZlBhZ2VMb2FkZWQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9lbnN1cmVQZGZQYWdlTG9hZGVkKHBhZ2VWaWV3KSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgaWYgKHBhZ2VWaWV3LnBkZlBhZ2UpIHsKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHBhZ2VWaWV3LnBkZlBhZ2UpOwogICAgICB9CgogICAgICBpZiAodGhpcy5fcGFnZXNSZXF1ZXN0cy5oYXMocGFnZVZpZXcpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3BhZ2VzUmVxdWVzdHMuZ2V0KHBhZ2VWaWV3KTsKICAgICAgfQoKICAgICAgdmFyIHByb21pc2UgPSB0aGlzLnBkZkRvY3VtZW50LmdldFBhZ2UocGFnZVZpZXcuaWQpLnRoZW4oZnVuY3Rpb24gKHBkZlBhZ2UpIHsKICAgICAgICBpZiAoIXBhZ2VWaWV3LnBkZlBhZ2UpIHsKICAgICAgICAgIHBhZ2VWaWV3LnNldFBkZlBhZ2UocGRmUGFnZSk7CiAgICAgICAgfQoKICAgICAgICBfdGhpczMuX3BhZ2VzUmVxdWVzdHNbImRlbGV0ZSJdKHBhZ2VWaWV3KTsKCiAgICAgICAgcmV0dXJuIHBkZlBhZ2U7CiAgICAgIH0pWyJjYXRjaCJdKGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJVbmFibGUgdG8gZ2V0IHBhZ2UgZm9yIHBhZ2UgdmlldyIsIHJlYXNvbik7CgogICAgICAgIF90aGlzMy5fcGFnZXNSZXF1ZXN0c1siZGVsZXRlIl0ocGFnZVZpZXcpOwogICAgICB9KTsKCiAgICAgIHRoaXMuX3BhZ2VzUmVxdWVzdHMuc2V0KHBhZ2VWaWV3LCBwcm9taXNlKTsKCiAgICAgIHJldHVybiBwcm9taXNlOwogICAgfQogIH0sIHsKICAgIGtleTogImZvcmNlUmVuZGVyaW5nIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBmb3JjZVJlbmRlcmluZyhjdXJyZW50bHlWaXNpYmxlUGFnZXMpIHsKICAgICAgdmFyIF90aGlzNCA9IHRoaXM7CgogICAgICB2YXIgdmlzaWJsZVBhZ2VzID0gY3VycmVudGx5VmlzaWJsZVBhZ2VzIHx8IHRoaXMuX2dldFZpc2libGVQYWdlcygpOwoKICAgICAgdmFyIHNjcm9sbEFoZWFkID0gdGhpcy5faXNTY3JvbGxNb2RlSG9yaXpvbnRhbCA/IHRoaXMuc2Nyb2xsLnJpZ2h0IDogdGhpcy5zY3JvbGwuZG93bjsKICAgICAgdmFyIHBhZ2VWaWV3ID0gdGhpcy5yZW5kZXJpbmdRdWV1ZS5nZXRIaWdoZXN0UHJpb3JpdHkodmlzaWJsZVBhZ2VzLCB0aGlzLl9wYWdlcywgc2Nyb2xsQWhlYWQpOwoKICAgICAgaWYgKHBhZ2VWaWV3KSB7CiAgICAgICAgdGhpcy5fZW5zdXJlUGRmUGFnZUxvYWRlZChwYWdlVmlldykudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICBfdGhpczQucmVuZGVyaW5nUXVldWUucmVuZGVyVmlldyhwYWdlVmlldyk7CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSwgewogICAga2V5OiAiY3JlYXRlVGV4dExheWVyQnVpbGRlciIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlVGV4dExheWVyQnVpbGRlcih0ZXh0TGF5ZXJEaXYsIHBhZ2VJbmRleCwgdmlld3BvcnQpIHsKICAgICAgdmFyIGVuaGFuY2VUZXh0U2VsZWN0aW9uID0gYXJndW1lbnRzLmxlbmd0aCA+IDMgJiYgYXJndW1lbnRzWzNdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbM10gOiBmYWxzZTsKICAgICAgdmFyIGV2ZW50QnVzID0gYXJndW1lbnRzLmxlbmd0aCA+IDQgPyBhcmd1bWVudHNbNF0gOiB1bmRlZmluZWQ7CiAgICAgIHJldHVybiBuZXcgX3RleHRfbGF5ZXJfYnVpbGRlci5UZXh0TGF5ZXJCdWlsZGVyKHsKICAgICAgICB0ZXh0TGF5ZXJEaXY6IHRleHRMYXllckRpdiwKICAgICAgICBldmVudEJ1czogZXZlbnRCdXMsCiAgICAgICAgcGFnZUluZGV4OiBwYWdlSW5kZXgsCiAgICAgICAgdmlld3BvcnQ6IHZpZXdwb3J0LAogICAgICAgIGZpbmRDb250cm9sbGVyOiB0aGlzLmlzSW5QcmVzZW50YXRpb25Nb2RlID8gbnVsbCA6IHRoaXMuZmluZENvbnRyb2xsZXIsCiAgICAgICAgZW5oYW5jZVRleHRTZWxlY3Rpb246IHRoaXMuaXNJblByZXNlbnRhdGlvbk1vZGUgPyBmYWxzZSA6IGVuaGFuY2VUZXh0U2VsZWN0aW9uCiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogImNyZWF0ZUFubm90YXRpb25MYXllckJ1aWxkZXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZUFubm90YXRpb25MYXllckJ1aWxkZXIocGFnZURpdiwgcGRmUGFnZSkgewogICAgICB2YXIgaW1hZ2VSZXNvdXJjZXNQYXRoID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMl0gOiAiIjsKICAgICAgdmFyIHJlbmRlckludGVyYWN0aXZlRm9ybXMgPSBhcmd1bWVudHMubGVuZ3RoID4gMyAmJiBhcmd1bWVudHNbM10gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1szXSA6IGZhbHNlOwogICAgICB2YXIgbDEwbiA9IGFyZ3VtZW50cy5sZW5ndGggPiA0ICYmIGFyZ3VtZW50c1s0XSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzRdIDogX3VpX3V0aWxzLk51bGxMMTBuOwogICAgICByZXR1cm4gbmV3IF9hbm5vdGF0aW9uX2xheWVyX2J1aWxkZXIuQW5ub3RhdGlvbkxheWVyQnVpbGRlcih7CiAgICAgICAgcGFnZURpdjogcGFnZURpdiwKICAgICAgICBwZGZQYWdlOiBwZGZQYWdlLAogICAgICAgIGltYWdlUmVzb3VyY2VzUGF0aDogaW1hZ2VSZXNvdXJjZXNQYXRoLAogICAgICAgIHJlbmRlckludGVyYWN0aXZlRm9ybXM6IHJlbmRlckludGVyYWN0aXZlRm9ybXMsCiAgICAgICAgbGlua1NlcnZpY2U6IHRoaXMubGlua1NlcnZpY2UsCiAgICAgICAgZG93bmxvYWRNYW5hZ2VyOiB0aGlzLmRvd25sb2FkTWFuYWdlciwKICAgICAgICBsMTBuOiBsMTBuCiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogImdldFBhZ2VzT3ZlcnZpZXciLAogICAgdmFsdWU6IGZ1bmN0aW9uIGdldFBhZ2VzT3ZlcnZpZXcoKSB7CiAgICAgIHZhciBwYWdlc092ZXJ2aWV3ID0gdGhpcy5fcGFnZXMubWFwKGZ1bmN0aW9uIChwYWdlVmlldykgewogICAgICAgIHZhciB2aWV3cG9ydCA9IHBhZ2VWaWV3LnBkZlBhZ2UuZ2V0Vmlld3BvcnQoewogICAgICAgICAgc2NhbGU6IDEKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgd2lkdGg6IHZpZXdwb3J0LndpZHRoLAogICAgICAgICAgaGVpZ2h0OiB2aWV3cG9ydC5oZWlnaHQsCiAgICAgICAgICByb3RhdGlvbjogdmlld3BvcnQucm90YXRpb24KICAgICAgICB9OwogICAgICB9KTsKCiAgICAgIGlmICghdGhpcy5lbmFibGVQcmludEF1dG9Sb3RhdGUpIHsKICAgICAgICByZXR1cm4gcGFnZXNPdmVydmlldzsKICAgICAgfQoKICAgICAgdmFyIGlzRmlyc3RQYWdlUG9ydHJhaXQgPSAoMCwgX3VpX3V0aWxzLmlzUG9ydHJhaXRPcmllbnRhdGlvbikocGFnZXNPdmVydmlld1swXSk7CiAgICAgIHJldHVybiBwYWdlc092ZXJ2aWV3Lm1hcChmdW5jdGlvbiAoc2l6ZSkgewogICAgICAgIGlmIChpc0ZpcnN0UGFnZVBvcnRyYWl0ID09PSAoMCwgX3VpX3V0aWxzLmlzUG9ydHJhaXRPcmllbnRhdGlvbikoc2l6ZSkpIHsKICAgICAgICAgIHJldHVybiBzaXplOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHdpZHRoOiBzaXplLmhlaWdodCwKICAgICAgICAgIGhlaWdodDogc2l6ZS53aWR0aCwKICAgICAgICAgIHJvdGF0aW9uOiAoc2l6ZS5yb3RhdGlvbiArIDkwKSAlIDM2MAogICAgICAgIH07CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogIl91cGRhdGVTY3JvbGxNb2RlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfdXBkYXRlU2Nyb2xsTW9kZSgpIHsKICAgICAgdmFyIHBhZ2VOdW1iZXIgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IG51bGw7CiAgICAgIHZhciBzY3JvbGxNb2RlID0gdGhpcy5fc2Nyb2xsTW9kZSwKICAgICAgICAgIHZpZXdlciA9IHRoaXMudmlld2VyOwogICAgICB2aWV3ZXIuY2xhc3NMaXN0LnRvZ2dsZSgic2Nyb2xsSG9yaXpvbnRhbCIsIHNjcm9sbE1vZGUgPT09IF91aV91dGlscy5TY3JvbGxNb2RlLkhPUklaT05UQUwpOwogICAgICB2aWV3ZXIuY2xhc3NMaXN0LnRvZ2dsZSgic2Nyb2xsV3JhcHBlZCIsIHNjcm9sbE1vZGUgPT09IF91aV91dGlscy5TY3JvbGxNb2RlLldSQVBQRUQpOwoKICAgICAgaWYgKCF0aGlzLnBkZkRvY3VtZW50IHx8ICFwYWdlTnVtYmVyKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAodGhpcy5fY3VycmVudFNjYWxlVmFsdWUgJiYgaXNOYU4odGhpcy5fY3VycmVudFNjYWxlVmFsdWUpKSB7CiAgICAgICAgdGhpcy5fc2V0U2NhbGUodGhpcy5fY3VycmVudFNjYWxlVmFsdWUsIHRydWUpOwogICAgICB9CgogICAgICB0aGlzLl9zZXRDdXJyZW50UGFnZU51bWJlcihwYWdlTnVtYmVyLCB0cnVlKTsKCiAgICAgIHRoaXMudXBkYXRlKCk7CiAgICB9CiAgfSwgewogICAga2V5OiAiX3VwZGF0ZVNwcmVhZE1vZGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF91cGRhdGVTcHJlYWRNb2RlKCkgewogICAgICB2YXIgcGFnZU51bWJlciA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDogbnVsbDsKCiAgICAgIGlmICghdGhpcy5wZGZEb2N1bWVudCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHZpZXdlciA9IHRoaXMudmlld2VyLAogICAgICAgICAgcGFnZXMgPSB0aGlzLl9wYWdlczsKICAgICAgdmlld2VyLnRleHRDb250ZW50ID0gIiI7CgogICAgICBpZiAodGhpcy5fc3ByZWFkTW9kZSA9PT0gX3VpX3V0aWxzLlNwcmVhZE1vZGUuTk9ORSkgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBpTWF4ID0gcGFnZXMubGVuZ3RoOyBpIDwgaU1heDsgKytpKSB7CiAgICAgICAgICB2aWV3ZXIuYXBwZW5kQ2hpbGQocGFnZXNbaV0uZGl2KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHBhcml0eSA9IHRoaXMuX3NwcmVhZE1vZGUgLSAxOwogICAgICAgIHZhciBzcHJlYWQgPSBudWxsOwoKICAgICAgICBmb3IgKHZhciBfaSA9IDAsIF9pTWF4ID0gcGFnZXMubGVuZ3RoOyBfaSA8IF9pTWF4OyArK19pKSB7CiAgICAgICAgICBpZiAoc3ByZWFkID09PSBudWxsKSB7CiAgICAgICAgICAgIHNwcmVhZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICBzcHJlYWQuY2xhc3NOYW1lID0gInNwcmVhZCI7CiAgICAgICAgICAgIHZpZXdlci5hcHBlbmRDaGlsZChzcHJlYWQpOwogICAgICAgICAgfSBlbHNlIGlmIChfaSAlIDIgPT09IHBhcml0eSkgewogICAgICAgICAgICBzcHJlYWQgPSBzcHJlYWQuY2xvbmVOb2RlKGZhbHNlKTsKICAgICAgICAgICAgdmlld2VyLmFwcGVuZENoaWxkKHNwcmVhZCk7CiAgICAgICAgICB9CgogICAgICAgICAgc3ByZWFkLmFwcGVuZENoaWxkKHBhZ2VzW19pXS5kaXYpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKCFwYWdlTnVtYmVyKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLl9zZXRDdXJyZW50UGFnZU51bWJlcihwYWdlTnVtYmVyLCB0cnVlKTsKCiAgICAgIHRoaXMudXBkYXRlKCk7CiAgICB9CiAgfSwgewogICAga2V5OiAicGFnZXNDb3VudCIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3BhZ2VzLmxlbmd0aDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJwYWdlVmlld3NSZWFkeSIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgaWYgKCF0aGlzLl9wYWdlc0NhcGFiaWxpdHkuc2V0dGxlZCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuX3BhZ2VzLmV2ZXJ5KGZ1bmN0aW9uIChwYWdlVmlldykgewogICAgICAgIHJldHVybiBwYWdlVmlldyAmJiBwYWdlVmlldy5wZGZQYWdlOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJjdXJyZW50UGFnZU51bWJlciIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX2N1cnJlbnRQYWdlTnVtYmVyOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24gc2V0KHZhbCkgewogICAgICBpZiAoIU51bWJlci5pc0ludGVnZXIodmFsKSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBwYWdlIG51bWJlci4iKTsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLnBkZkRvY3VtZW50KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoIXRoaXMuX3NldEN1cnJlbnRQYWdlTnVtYmVyKHZhbCwgdHJ1ZSkpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCIiLmNvbmNhdCh0aGlzLl9uYW1lLCAiLmN1cnJlbnRQYWdlTnVtYmVyOiBcIiIpLmNvbmNhdCh2YWwsICJcIiBpcyBub3QgYSB2YWxpZCBwYWdlLiIpKTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogImN1cnJlbnRQYWdlTGFiZWwiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9wYWdlTGFiZWxzICYmIHRoaXMuX3BhZ2VMYWJlbHNbdGhpcy5fY3VycmVudFBhZ2VOdW1iZXIgLSAxXTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uIHNldCh2YWwpIHsKICAgICAgaWYgKCF0aGlzLnBkZkRvY3VtZW50KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgcGFnZSA9IHZhbCB8IDA7CgogICAgICBpZiAodGhpcy5fcGFnZUxhYmVscykgewogICAgICAgIHZhciBpID0gdGhpcy5fcGFnZUxhYmVscy5pbmRleE9mKHZhbCk7CgogICAgICAgIGlmIChpID49IDApIHsKICAgICAgICAgIHBhZ2UgPSBpICsgMTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5fc2V0Q3VycmVudFBhZ2VOdW1iZXIocGFnZSwgdHJ1ZSkpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCIiLmNvbmNhdCh0aGlzLl9uYW1lLCAiLmN1cnJlbnRQYWdlTGFiZWw6IFwiIikuY29uY2F0KHZhbCwgIlwiIGlzIG5vdCBhIHZhbGlkIHBhZ2UuIikpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAiY3VycmVudFNjYWxlIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fY3VycmVudFNjYWxlICE9PSBfdWlfdXRpbHMuVU5LTk9XTl9TQ0FMRSA/IHRoaXMuX2N1cnJlbnRTY2FsZSA6IF91aV91dGlscy5ERUZBVUxUX1NDQUxFOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24gc2V0KHZhbCkgewogICAgICBpZiAoaXNOYU4odmFsKSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBudW1lcmljIHNjYWxlLiIpOwogICAgICB9CgogICAgICBpZiAoIXRoaXMucGRmRG9jdW1lbnQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMuX3NldFNjYWxlKHZhbCwgZmFsc2UpOwogICAgfQogIH0sIHsKICAgIGtleTogImN1cnJlbnRTY2FsZVZhbHVlIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fY3VycmVudFNjYWxlVmFsdWU7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbiBzZXQodmFsKSB7CiAgICAgIGlmICghdGhpcy5wZGZEb2N1bWVudCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5fc2V0U2NhbGUodmFsLCBmYWxzZSk7CiAgICB9CiAgfSwgewogICAga2V5OiAicGFnZXNSb3RhdGlvbiIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3BhZ2VzUm90YXRpb247CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbiBzZXQocm90YXRpb24pIHsKICAgICAgaWYgKCEoMCwgX3VpX3V0aWxzLmlzVmFsaWRSb3RhdGlvbikocm90YXRpb24pKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHBhZ2VzIHJvdGF0aW9uIGFuZ2xlLiIpOwogICAgICB9CgogICAgICBpZiAoIXRoaXMucGRmRG9jdW1lbnQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9wYWdlc1JvdGF0aW9uID09PSByb3RhdGlvbikgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5fcGFnZXNSb3RhdGlvbiA9IHJvdGF0aW9uOwogICAgICB2YXIgcGFnZU51bWJlciA9IHRoaXMuX2N1cnJlbnRQYWdlTnVtYmVyOwoKICAgICAgZm9yICh2YXIgaSA9IDAsIGlpID0gdGhpcy5fcGFnZXMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgIHZhciBwYWdlVmlldyA9IHRoaXMuX3BhZ2VzW2ldOwogICAgICAgIHBhZ2VWaWV3LnVwZGF0ZShwYWdlVmlldy5zY2FsZSwgcm90YXRpb24pOwogICAgICB9CgogICAgICBpZiAodGhpcy5fY3VycmVudFNjYWxlVmFsdWUpIHsKICAgICAgICB0aGlzLl9zZXRTY2FsZSh0aGlzLl9jdXJyZW50U2NhbGVWYWx1ZSwgdHJ1ZSk7CiAgICAgIH0KCiAgICAgIHRoaXMuZXZlbnRCdXMuZGlzcGF0Y2goInJvdGF0aW9uY2hhbmdpbmciLCB7CiAgICAgICAgc291cmNlOiB0aGlzLAogICAgICAgIHBhZ2VzUm90YXRpb246IHJvdGF0aW9uLAogICAgICAgIHBhZ2VOdW1iZXI6IHBhZ2VOdW1iZXIKICAgICAgfSk7CgogICAgICBpZiAodGhpcy5kZWZhdWx0UmVuZGVyaW5nUXVldWUpIHsKICAgICAgICB0aGlzLnVwZGF0ZSgpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAiZmlyc3RQYWdlUHJvbWlzZSIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMucGRmRG9jdW1lbnQgPyB0aGlzLl9maXJzdFBhZ2VDYXBhYmlsaXR5LnByb21pc2UgOiBudWxsOwogICAgfQogIH0sIHsKICAgIGtleTogIm9uZVBhZ2VSZW5kZXJlZCIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMucGRmRG9jdW1lbnQgPyB0aGlzLl9vbmVQYWdlUmVuZGVyZWRDYXBhYmlsaXR5LnByb21pc2UgOiBudWxsOwogICAgfQogIH0sIHsKICAgIGtleTogInBhZ2VzUHJvbWlzZSIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMucGRmRG9jdW1lbnQgPyB0aGlzLl9wYWdlc0NhcGFiaWxpdHkucHJvbWlzZSA6IG51bGw7CiAgICB9CiAgfSwgewogICAga2V5OiAiX3ZpZXdlckVsZW1lbnQiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiTm90IGltcGxlbWVudGVkOiBfdmlld2VyRWxlbWVudCIpOwogICAgfQogIH0sIHsKICAgIGtleTogIl9pc1Njcm9sbE1vZGVIb3Jpem9udGFsIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5pc0luUHJlc2VudGF0aW9uTW9kZSA/IGZhbHNlIDogdGhpcy5fc2Nyb2xsTW9kZSA9PT0gX3VpX3V0aWxzLlNjcm9sbE1vZGUuSE9SSVpPTlRBTDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJpc0luUHJlc2VudGF0aW9uTW9kZSIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMucHJlc2VudGF0aW9uTW9kZVN0YXRlID09PSBfdWlfdXRpbHMuUHJlc2VudGF0aW9uTW9kZVN0YXRlLkZVTExTQ1JFRU47CiAgICB9CiAgfSwgewogICAga2V5OiAiaXNDaGFuZ2luZ1ByZXNlbnRhdGlvbk1vZGUiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLnByZXNlbnRhdGlvbk1vZGVTdGF0ZSA9PT0gX3VpX3V0aWxzLlByZXNlbnRhdGlvbk1vZGVTdGF0ZS5DSEFOR0lORzsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJpc0hvcml6b250YWxTY3JvbGxiYXJFbmFibGVkIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5pc0luUHJlc2VudGF0aW9uTW9kZSA/IGZhbHNlIDogdGhpcy5jb250YWluZXIuc2Nyb2xsV2lkdGggPiB0aGlzLmNvbnRhaW5lci5jbGllbnRXaWR0aDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJpc1ZlcnRpY2FsU2Nyb2xsYmFyRW5hYmxlZCIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuaXNJblByZXNlbnRhdGlvbk1vZGUgPyBmYWxzZSA6IHRoaXMuY29udGFpbmVyLnNjcm9sbEhlaWdodCA+IHRoaXMuY29udGFpbmVyLmNsaWVudEhlaWdodDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJoYXNFcXVhbFBhZ2VTaXplcyIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgdmFyIGZpcnN0UGFnZVZpZXcgPSB0aGlzLl9wYWdlc1swXTsKCiAgICAgIGZvciAodmFyIGkgPSAxLCBpaSA9IHRoaXMuX3BhZ2VzLmxlbmd0aDsgaSA8IGlpOyArK2kpIHsKICAgICAgICB2YXIgcGFnZVZpZXcgPSB0aGlzLl9wYWdlc1tpXTsKCiAgICAgICAgaWYgKHBhZ2VWaWV3LndpZHRoICE9PSBmaXJzdFBhZ2VWaWV3LndpZHRoIHx8IHBhZ2VWaWV3LmhlaWdodCAhPT0gZmlyc3RQYWdlVmlldy5oZWlnaHQpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0sIHsKICAgIGtleTogInNjcm9sbE1vZGUiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zY3JvbGxNb2RlOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24gc2V0KG1vZGUpIHsKICAgICAgaWYgKHRoaXMuX3Njcm9sbE1vZGUgPT09IG1vZGUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICghKDAsIF91aV91dGlscy5pc1ZhbGlkU2Nyb2xsTW9kZSkobW9kZSkpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgc2Nyb2xsIG1vZGU6ICIuY29uY2F0KG1vZGUpKTsKICAgICAgfQoKICAgICAgdGhpcy5fc2Nyb2xsTW9kZSA9IG1vZGU7CiAgICAgIHRoaXMuZXZlbnRCdXMuZGlzcGF0Y2goInNjcm9sbG1vZGVjaGFuZ2VkIiwgewogICAgICAgIHNvdXJjZTogdGhpcywKICAgICAgICBtb2RlOiBtb2RlCiAgICAgIH0pOwoKICAgICAgdGhpcy5fdXBkYXRlU2Nyb2xsTW9kZSh0aGlzLl9jdXJyZW50UGFnZU51bWJlcik7CiAgICB9CiAgfSwgewogICAga2V5OiAic3ByZWFkTW9kZSIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3NwcmVhZE1vZGU7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbiBzZXQobW9kZSkgewogICAgICBpZiAodGhpcy5fc3ByZWFkTW9kZSA9PT0gbW9kZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKCEoMCwgX3VpX3V0aWxzLmlzVmFsaWRTcHJlYWRNb2RlKShtb2RlKSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBzcHJlYWQgbW9kZTogIi5jb25jYXQobW9kZSkpOwogICAgICB9CgogICAgICB0aGlzLl9zcHJlYWRNb2RlID0gbW9kZTsKICAgICAgdGhpcy5ldmVudEJ1cy5kaXNwYXRjaCgic3ByZWFkbW9kZWNoYW5nZWQiLCB7CiAgICAgICAgc291cmNlOiB0aGlzLAogICAgICAgIG1vZGU6IG1vZGUKICAgICAgfSk7CgogICAgICB0aGlzLl91cGRhdGVTcHJlYWRNb2RlKHRoaXMuX2N1cnJlbnRQYWdlTnVtYmVyKTsKICAgIH0KICB9XSk7CgogIHJldHVybiBCYXNlVmlld2VyOwp9KCk7CgpleHBvcnRzLkJhc2VWaWV3ZXIgPSBCYXNlVmlld2VyOwoKLyoqKi8gfSksCi8qIDI5ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuRGVmYXVsdEFubm90YXRpb25MYXllckZhY3RvcnkgPSBleHBvcnRzLkFubm90YXRpb25MYXllckJ1aWxkZXIgPSB2b2lkIDA7Cgp2YXIgX3BkZmpzTGliID0gX193ZWJwYWNrX3JlcXVpcmVfXyg4KTsKCnZhciBfdWlfdXRpbHMgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUpOwoKdmFyIF9wZGZfbGlua19zZXJ2aWNlID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMSk7CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOyB9IH0KCmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9CgpmdW5jdGlvbiBfY3JlYXRlQ2xhc3MoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfQoKdmFyIEFubm90YXRpb25MYXllckJ1aWxkZXIgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIEFubm90YXRpb25MYXllckJ1aWxkZXIoX3JlZikgewogICAgdmFyIHBhZ2VEaXYgPSBfcmVmLnBhZ2VEaXYsCiAgICAgICAgcGRmUGFnZSA9IF9yZWYucGRmUGFnZSwKICAgICAgICBsaW5rU2VydmljZSA9IF9yZWYubGlua1NlcnZpY2UsCiAgICAgICAgZG93bmxvYWRNYW5hZ2VyID0gX3JlZi5kb3dubG9hZE1hbmFnZXIsCiAgICAgICAgX3JlZiRpbWFnZVJlc291cmNlc1BhID0gX3JlZi5pbWFnZVJlc291cmNlc1BhdGgsCiAgICAgICAgaW1hZ2VSZXNvdXJjZXNQYXRoID0gX3JlZiRpbWFnZVJlc291cmNlc1BhID09PSB2b2lkIDAgPyAiIiA6IF9yZWYkaW1hZ2VSZXNvdXJjZXNQYSwKICAgICAgICBfcmVmJHJlbmRlckludGVyYWN0aXYgPSBfcmVmLnJlbmRlckludGVyYWN0aXZlRm9ybXMsCiAgICAgICAgcmVuZGVySW50ZXJhY3RpdmVGb3JtcyA9IF9yZWYkcmVuZGVySW50ZXJhY3RpdiA9PT0gdm9pZCAwID8gZmFsc2UgOiBfcmVmJHJlbmRlckludGVyYWN0aXYsCiAgICAgICAgX3JlZiRsMTBuID0gX3JlZi5sMTBuLAogICAgICAgIGwxMG4gPSBfcmVmJGwxMG4gPT09IHZvaWQgMCA/IF91aV91dGlscy5OdWxsTDEwbiA6IF9yZWYkbDEwbjsKCiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgQW5ub3RhdGlvbkxheWVyQnVpbGRlcik7CgogICAgdGhpcy5wYWdlRGl2ID0gcGFnZURpdjsKICAgIHRoaXMucGRmUGFnZSA9IHBkZlBhZ2U7CiAgICB0aGlzLmxpbmtTZXJ2aWNlID0gbGlua1NlcnZpY2U7CiAgICB0aGlzLmRvd25sb2FkTWFuYWdlciA9IGRvd25sb2FkTWFuYWdlcjsKICAgIHRoaXMuaW1hZ2VSZXNvdXJjZXNQYXRoID0gaW1hZ2VSZXNvdXJjZXNQYXRoOwogICAgdGhpcy5yZW5kZXJJbnRlcmFjdGl2ZUZvcm1zID0gcmVuZGVySW50ZXJhY3RpdmVGb3JtczsKICAgIHRoaXMubDEwbiA9IGwxMG47CiAgICB0aGlzLmRpdiA9IG51bGw7CiAgICB0aGlzLl9jYW5jZWxsZWQgPSBmYWxzZTsKICB9CgogIF9jcmVhdGVDbGFzcyhBbm5vdGF0aW9uTGF5ZXJCdWlsZGVyLCBbewogICAga2V5OiAicmVuZGVyIiwKICAgIHZhbHVlOiBmdW5jdGlvbiByZW5kZXIodmlld3BvcnQpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHZhciBpbnRlbnQgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6ICJkaXNwbGF5IjsKICAgICAgdGhpcy5wZGZQYWdlLmdldEFubm90YXRpb25zKHsKICAgICAgICBpbnRlbnQ6IGludGVudAogICAgICB9KS50aGVuKGZ1bmN0aW9uIChhbm5vdGF0aW9ucykgewogICAgICAgIGlmIChfdGhpcy5fY2FuY2VsbGVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgcGFyYW1ldGVycyA9IHsKICAgICAgICAgIHZpZXdwb3J0OiB2aWV3cG9ydC5jbG9uZSh7CiAgICAgICAgICAgIGRvbnRGbGlwOiB0cnVlCiAgICAgICAgICB9KSwKICAgICAgICAgIGRpdjogX3RoaXMuZGl2LAogICAgICAgICAgYW5ub3RhdGlvbnM6IGFubm90YXRpb25zLAogICAgICAgICAgcGFnZTogX3RoaXMucGRmUGFnZSwKICAgICAgICAgIGltYWdlUmVzb3VyY2VzUGF0aDogX3RoaXMuaW1hZ2VSZXNvdXJjZXNQYXRoLAogICAgICAgICAgcmVuZGVySW50ZXJhY3RpdmVGb3JtczogX3RoaXMucmVuZGVySW50ZXJhY3RpdmVGb3JtcywKICAgICAgICAgIGxpbmtTZXJ2aWNlOiBfdGhpcy5saW5rU2VydmljZSwKICAgICAgICAgIGRvd25sb2FkTWFuYWdlcjogX3RoaXMuZG93bmxvYWRNYW5hZ2VyCiAgICAgICAgfTsKCiAgICAgICAgaWYgKF90aGlzLmRpdikgewogICAgICAgICAgX3BkZmpzTGliLkFubm90YXRpb25MYXllci51cGRhdGUocGFyYW1ldGVycyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChhbm5vdGF0aW9ucy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIF90aGlzLmRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgX3RoaXMuZGl2LmNsYXNzTmFtZSA9ICJhbm5vdGF0aW9uTGF5ZXIiOwoKICAgICAgICAgIF90aGlzLnBhZ2VEaXYuYXBwZW5kQ2hpbGQoX3RoaXMuZGl2KTsKCiAgICAgICAgICBwYXJhbWV0ZXJzLmRpdiA9IF90aGlzLmRpdjsKCiAgICAgICAgICBfcGRmanNMaWIuQW5ub3RhdGlvbkxheWVyLnJlbmRlcihwYXJhbWV0ZXJzKTsKCiAgICAgICAgICBfdGhpcy5sMTBuLnRyYW5zbGF0ZShfdGhpcy5kaXYpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiY2FuY2VsIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjYW5jZWwoKSB7CiAgICAgIHRoaXMuX2NhbmNlbGxlZCA9IHRydWU7CiAgICB9CiAgfSwgewogICAga2V5OiAiaGlkZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gaGlkZSgpIHsKICAgICAgaWYgKCF0aGlzLmRpdikgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5kaXYuc2V0QXR0cmlidXRlKCJoaWRkZW4iLCAidHJ1ZSIpOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIEFubm90YXRpb25MYXllckJ1aWxkZXI7Cn0oKTsKCmV4cG9ydHMuQW5ub3RhdGlvbkxheWVyQnVpbGRlciA9IEFubm90YXRpb25MYXllckJ1aWxkZXI7Cgp2YXIgRGVmYXVsdEFubm90YXRpb25MYXllckZhY3RvcnkgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIERlZmF1bHRBbm5vdGF0aW9uTGF5ZXJGYWN0b3J5KCkgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIERlZmF1bHRBbm5vdGF0aW9uTGF5ZXJGYWN0b3J5KTsKICB9CgogIF9jcmVhdGVDbGFzcyhEZWZhdWx0QW5ub3RhdGlvbkxheWVyRmFjdG9yeSwgW3sKICAgIGtleTogImNyZWF0ZUFubm90YXRpb25MYXllckJ1aWxkZXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZUFubm90YXRpb25MYXllckJ1aWxkZXIocGFnZURpdiwgcGRmUGFnZSkgewogICAgICB2YXIgaW1hZ2VSZXNvdXJjZXNQYXRoID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMl0gOiAiIjsKICAgICAgdmFyIHJlbmRlckludGVyYWN0aXZlRm9ybXMgPSBhcmd1bWVudHMubGVuZ3RoID4gMyAmJiBhcmd1bWVudHNbM10gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1szXSA6IGZhbHNlOwogICAgICB2YXIgbDEwbiA9IGFyZ3VtZW50cy5sZW5ndGggPiA0ICYmIGFyZ3VtZW50c1s0XSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzRdIDogX3VpX3V0aWxzLk51bGxMMTBuOwogICAgICByZXR1cm4gbmV3IEFubm90YXRpb25MYXllckJ1aWxkZXIoewogICAgICAgIHBhZ2VEaXY6IHBhZ2VEaXYsCiAgICAgICAgcGRmUGFnZTogcGRmUGFnZSwKICAgICAgICBpbWFnZVJlc291cmNlc1BhdGg6IGltYWdlUmVzb3VyY2VzUGF0aCwKICAgICAgICByZW5kZXJJbnRlcmFjdGl2ZUZvcm1zOiByZW5kZXJJbnRlcmFjdGl2ZUZvcm1zLAogICAgICAgIGxpbmtTZXJ2aWNlOiBuZXcgX3BkZl9saW5rX3NlcnZpY2UuU2ltcGxlTGlua1NlcnZpY2UoKSwKICAgICAgICBsMTBuOiBsMTBuCiAgICAgIH0pOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIERlZmF1bHRBbm5vdGF0aW9uTGF5ZXJGYWN0b3J5Owp9KCk7CgpleHBvcnRzLkRlZmF1bHRBbm5vdGF0aW9uTGF5ZXJGYWN0b3J5ID0gRGVmYXVsdEFubm90YXRpb25MYXllckZhY3Rvcnk7CgovKioqLyB9KSwKLyogMzAgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKInVzZSBzdHJpY3QiOwoKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKZXhwb3J0cy5QREZQYWdlVmlldyA9IHZvaWQgMDsKCnZhciBfcmVnZW5lcmF0b3IgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9fd2VicGFja19yZXF1aXJlX18oMikpOwoKdmFyIF91aV91dGlscyA9IF9fd2VicGFja19yZXF1aXJlX18oNSk7Cgp2YXIgX3BkZmpzTGliID0gX193ZWJwYWNrX3JlcXVpcmVfXyg4KTsKCnZhciBfcGRmX3JlbmRlcmluZ19xdWV1ZSA9IF9fd2VicGFja19yZXF1aXJlX18oMTEpOwoKdmFyIF92aWV3ZXJfY29tcGF0aWJpbGl0eSA9IF9fd2VicGFja19yZXF1aXJlX18oNyk7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAiZGVmYXVsdCI6IG9iaiB9OyB9CgpmdW5jdGlvbiBhc3luY0dlbmVyYXRvclN0ZXAoZ2VuLCByZXNvbHZlLCByZWplY3QsIF9uZXh0LCBfdGhyb3csIGtleSwgYXJnKSB7IHRyeSB7IHZhciBpbmZvID0gZ2VuW2tleV0oYXJnKTsgdmFyIHZhbHVlID0gaW5mby52YWx1ZTsgfSBjYXRjaCAoZXJyb3IpIHsgcmVqZWN0KGVycm9yKTsgcmV0dXJuOyB9IGlmIChpbmZvLmRvbmUpIHsgcmVzb2x2ZSh2YWx1ZSk7IH0gZWxzZSB7IFByb21pc2UucmVzb2x2ZSh2YWx1ZSkudGhlbihfbmV4dCwgX3Rocm93KTsgfSB9CgpmdW5jdGlvbiBfYXN5bmNUb0dlbmVyYXRvcihmbikgeyByZXR1cm4gZnVuY3Rpb24gKCkgeyB2YXIgc2VsZiA9IHRoaXMsIGFyZ3MgPSBhcmd1bWVudHM7IHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7IHZhciBnZW4gPSBmbi5hcHBseShzZWxmLCBhcmdzKTsgZnVuY3Rpb24gX25leHQodmFsdWUpIHsgYXN5bmNHZW5lcmF0b3JTdGVwKGdlbiwgcmVzb2x2ZSwgcmVqZWN0LCBfbmV4dCwgX3Rocm93LCAibmV4dCIsIHZhbHVlKTsgfSBmdW5jdGlvbiBfdGhyb3coZXJyKSB7IGFzeW5jR2VuZXJhdG9yU3RlcChnZW4sIHJlc29sdmUsIHJlamVjdCwgX25leHQsIF90aHJvdywgInRocm93IiwgZXJyKTsgfSBfbmV4dCh1bmRlZmluZWQpOyB9KTsgfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsgfSB9CgpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfQoKZnVuY3Rpb24gX2NyZWF0ZUNsYXNzKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH0KCnZhciBNQVhfQ0FOVkFTX1BJWEVMUyA9IF92aWV3ZXJfY29tcGF0aWJpbGl0eS52aWV3ZXJDb21wYXRpYmlsaXR5UGFyYW1zLm1heENhbnZhc1BpeGVscyB8fCAxNjc3NzIxNjsKCnZhciBQREZQYWdlVmlldyA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gUERGUGFnZVZpZXcob3B0aW9ucykgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFBERlBhZ2VWaWV3KTsKCiAgICB2YXIgY29udGFpbmVyID0gb3B0aW9ucy5jb250YWluZXI7CiAgICB2YXIgZGVmYXVsdFZpZXdwb3J0ID0gb3B0aW9ucy5kZWZhdWx0Vmlld3BvcnQ7CiAgICB0aGlzLmlkID0gb3B0aW9ucy5pZDsKICAgIHRoaXMucmVuZGVyaW5nSWQgPSAicGFnZSIgKyB0aGlzLmlkOwogICAgdGhpcy5wZGZQYWdlID0gbnVsbDsKICAgIHRoaXMucGFnZUxhYmVsID0gbnVsbDsKICAgIHRoaXMucm90YXRpb24gPSAwOwogICAgdGhpcy5zY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgX3VpX3V0aWxzLkRFRkFVTFRfU0NBTEU7CiAgICB0aGlzLnZpZXdwb3J0ID0gZGVmYXVsdFZpZXdwb3J0OwogICAgdGhpcy5wZGZQYWdlUm90YXRlID0gZGVmYXVsdFZpZXdwb3J0LnJvdGF0aW9uOwogICAgdGhpcy5oYXNSZXN0cmljdGVkU2NhbGluZyA9IGZhbHNlOwogICAgdGhpcy50ZXh0TGF5ZXJNb2RlID0gTnVtYmVyLmlzSW50ZWdlcihvcHRpb25zLnRleHRMYXllck1vZGUpID8gb3B0aW9ucy50ZXh0TGF5ZXJNb2RlIDogX3VpX3V0aWxzLlRleHRMYXllck1vZGUuRU5BQkxFOwogICAgdGhpcy5pbWFnZVJlc291cmNlc1BhdGggPSBvcHRpb25zLmltYWdlUmVzb3VyY2VzUGF0aCB8fCAiIjsKICAgIHRoaXMucmVuZGVySW50ZXJhY3RpdmVGb3JtcyA9IG9wdGlvbnMucmVuZGVySW50ZXJhY3RpdmVGb3JtcyB8fCBmYWxzZTsKICAgIHRoaXMudXNlT25seUNzc1pvb20gPSBvcHRpb25zLnVzZU9ubHlDc3Nab29tIHx8IGZhbHNlOwogICAgdGhpcy5tYXhDYW52YXNQaXhlbHMgPSBvcHRpb25zLm1heENhbnZhc1BpeGVscyB8fCBNQVhfQ0FOVkFTX1BJWEVMUzsKICAgIHRoaXMuZXZlbnRCdXMgPSBvcHRpb25zLmV2ZW50QnVzOwogICAgdGhpcy5yZW5kZXJpbmdRdWV1ZSA9IG9wdGlvbnMucmVuZGVyaW5nUXVldWU7CiAgICB0aGlzLnRleHRMYXllckZhY3RvcnkgPSBvcHRpb25zLnRleHRMYXllckZhY3Rvcnk7CiAgICB0aGlzLmFubm90YXRpb25MYXllckZhY3RvcnkgPSBvcHRpb25zLmFubm90YXRpb25MYXllckZhY3Rvcnk7CiAgICB0aGlzLnJlbmRlcmVyID0gb3B0aW9ucy5yZW5kZXJlciB8fCBfdWlfdXRpbHMuUmVuZGVyZXJUeXBlLkNBTlZBUzsKICAgIHRoaXMuZW5hYmxlV2ViR0wgPSBvcHRpb25zLmVuYWJsZVdlYkdMIHx8IGZhbHNlOwogICAgdGhpcy5sMTBuID0gb3B0aW9ucy5sMTBuIHx8IF91aV91dGlscy5OdWxsTDEwbjsKICAgIHRoaXMucGFpbnRUYXNrID0gbnVsbDsKICAgIHRoaXMucGFpbnRlZFZpZXdwb3J0TWFwID0gbmV3IFdlYWtNYXAoKTsKICAgIHRoaXMucmVuZGVyaW5nU3RhdGUgPSBfcGRmX3JlbmRlcmluZ19xdWV1ZS5SZW5kZXJpbmdTdGF0ZXMuSU5JVElBTDsKICAgIHRoaXMucmVzdW1lID0gbnVsbDsKICAgIHRoaXMuZXJyb3IgPSBudWxsOwogICAgdGhpcy5hbm5vdGF0aW9uTGF5ZXIgPSBudWxsOwogICAgdGhpcy50ZXh0TGF5ZXIgPSBudWxsOwogICAgdGhpcy56b29tTGF5ZXIgPSBudWxsOwogICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgZGl2LmNsYXNzTmFtZSA9ICJwYWdlIjsKICAgIGRpdi5zdHlsZS53aWR0aCA9IE1hdGguZmxvb3IodGhpcy52aWV3cG9ydC53aWR0aCkgKyAicHgiOwogICAgZGl2LnN0eWxlLmhlaWdodCA9IE1hdGguZmxvb3IodGhpcy52aWV3cG9ydC5oZWlnaHQpICsgInB4IjsKICAgIGRpdi5zZXRBdHRyaWJ1dGUoImRhdGEtcGFnZS1udW1iZXIiLCB0aGlzLmlkKTsKICAgIHRoaXMuZGl2ID0gZGl2OwogICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGRpdik7CiAgfQoKICBfY3JlYXRlQ2xhc3MoUERGUGFnZVZpZXcsIFt7CiAgICBrZXk6ICJzZXRQZGZQYWdlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRQZGZQYWdlKHBkZlBhZ2UpIHsKICAgICAgdGhpcy5wZGZQYWdlID0gcGRmUGFnZTsKICAgICAgdGhpcy5wZGZQYWdlUm90YXRlID0gcGRmUGFnZS5yb3RhdGU7CiAgICAgIHZhciB0b3RhbFJvdGF0aW9uID0gKHRoaXMucm90YXRpb24gKyB0aGlzLnBkZlBhZ2VSb3RhdGUpICUgMzYwOwogICAgICB0aGlzLnZpZXdwb3J0ID0gcGRmUGFnZS5nZXRWaWV3cG9ydCh7CiAgICAgICAgc2NhbGU6IHRoaXMuc2NhbGUgKiBfdWlfdXRpbHMuQ1NTX1VOSVRTLAogICAgICAgIHJvdGF0aW9uOiB0b3RhbFJvdGF0aW9uCiAgICAgIH0pOwogICAgICB0aGlzLnN0YXRzID0gcGRmUGFnZS5zdGF0czsKICAgICAgdGhpcy5yZXNldCgpOwogICAgfQogIH0sIHsKICAgIGtleTogImRlc3Ryb3kiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgIHRoaXMucmVzZXQoKTsKCiAgICAgIGlmICh0aGlzLnBkZlBhZ2UpIHsKICAgICAgICB0aGlzLnBkZlBhZ2UuY2xlYW51cCgpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAiX3Jlc2V0Wm9vbUxheWVyIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfcmVzZXRab29tTGF5ZXIoKSB7CiAgICAgIHZhciByZW1vdmVGcm9tRE9NID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiBmYWxzZTsKCiAgICAgIGlmICghdGhpcy56b29tTGF5ZXIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciB6b29tTGF5ZXJDYW52YXMgPSB0aGlzLnpvb21MYXllci5maXJzdENoaWxkOwogICAgICB0aGlzLnBhaW50ZWRWaWV3cG9ydE1hcFsiZGVsZXRlIl0oem9vbUxheWVyQ2FudmFzKTsKICAgICAgem9vbUxheWVyQ2FudmFzLndpZHRoID0gMDsKICAgICAgem9vbUxheWVyQ2FudmFzLmhlaWdodCA9IDA7CgogICAgICBpZiAocmVtb3ZlRnJvbURPTSkgewogICAgICAgIHRoaXMuem9vbUxheWVyLnJlbW92ZSgpOwogICAgICB9CgogICAgICB0aGlzLnpvb21MYXllciA9IG51bGw7CiAgICB9CiAgfSwgewogICAga2V5OiAicmVzZXQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlc2V0KCkgewogICAgICB2YXIga2VlcFpvb21MYXllciA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDogZmFsc2U7CiAgICAgIHZhciBrZWVwQW5ub3RhdGlvbnMgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IGZhbHNlOwogICAgICB0aGlzLmNhbmNlbFJlbmRlcmluZyhrZWVwQW5ub3RhdGlvbnMpOwogICAgICB0aGlzLnJlbmRlcmluZ1N0YXRlID0gX3BkZl9yZW5kZXJpbmdfcXVldWUuUmVuZGVyaW5nU3RhdGVzLklOSVRJQUw7CiAgICAgIHZhciBkaXYgPSB0aGlzLmRpdjsKICAgICAgZGl2LnN0eWxlLndpZHRoID0gTWF0aC5mbG9vcih0aGlzLnZpZXdwb3J0LndpZHRoKSArICJweCI7CiAgICAgIGRpdi5zdHlsZS5oZWlnaHQgPSBNYXRoLmZsb29yKHRoaXMudmlld3BvcnQuaGVpZ2h0KSArICJweCI7CiAgICAgIHZhciBjaGlsZE5vZGVzID0gZGl2LmNoaWxkTm9kZXM7CiAgICAgIHZhciBjdXJyZW50Wm9vbUxheWVyTm9kZSA9IGtlZXBab29tTGF5ZXIgJiYgdGhpcy56b29tTGF5ZXIgfHwgbnVsbDsKICAgICAgdmFyIGN1cnJlbnRBbm5vdGF0aW9uTm9kZSA9IGtlZXBBbm5vdGF0aW9ucyAmJiB0aGlzLmFubm90YXRpb25MYXllciAmJiB0aGlzLmFubm90YXRpb25MYXllci5kaXYgfHwgbnVsbDsKCiAgICAgIGZvciAodmFyIGkgPSBjaGlsZE5vZGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgdmFyIG5vZGUgPSBjaGlsZE5vZGVzW2ldOwoKICAgICAgICBpZiAoY3VycmVudFpvb21MYXllck5vZGUgPT09IG5vZGUgfHwgY3VycmVudEFubm90YXRpb25Ob2RlID09PSBub2RlKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIGRpdi5yZW1vdmVDaGlsZChub2RlKTsKICAgICAgfQoKICAgICAgZGl2LnJlbW92ZUF0dHJpYnV0ZSgiZGF0YS1sb2FkZWQiKTsKCiAgICAgIGlmIChjdXJyZW50QW5ub3RhdGlvbk5vZGUpIHsKICAgICAgICB0aGlzLmFubm90YXRpb25MYXllci5oaWRlKCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5hbm5vdGF0aW9uTGF5ZXIpIHsKICAgICAgICB0aGlzLmFubm90YXRpb25MYXllci5jYW5jZWwoKTsKICAgICAgICB0aGlzLmFubm90YXRpb25MYXllciA9IG51bGw7CiAgICAgIH0KCiAgICAgIGlmICghY3VycmVudFpvb21MYXllck5vZGUpIHsKICAgICAgICBpZiAodGhpcy5jYW52YXMpIHsKICAgICAgICAgIHRoaXMucGFpbnRlZFZpZXdwb3J0TWFwWyJkZWxldGUiXSh0aGlzLmNhbnZhcyk7CiAgICAgICAgICB0aGlzLmNhbnZhcy53aWR0aCA9IDA7CiAgICAgICAgICB0aGlzLmNhbnZhcy5oZWlnaHQgPSAwOwogICAgICAgICAgZGVsZXRlIHRoaXMuY2FudmFzOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fcmVzZXRab29tTGF5ZXIoKTsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuc3ZnKSB7CiAgICAgICAgdGhpcy5wYWludGVkVmlld3BvcnRNYXBbImRlbGV0ZSJdKHRoaXMuc3ZnKTsKICAgICAgICBkZWxldGUgdGhpcy5zdmc7CiAgICAgIH0KCiAgICAgIHRoaXMubG9hZGluZ0ljb25EaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgdGhpcy5sb2FkaW5nSWNvbkRpdi5jbGFzc05hbWUgPSAibG9hZGluZ0ljb24iOwogICAgICBkaXYuYXBwZW5kQ2hpbGQodGhpcy5sb2FkaW5nSWNvbkRpdik7CiAgICB9CiAgfSwgewogICAga2V5OiAidXBkYXRlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB1cGRhdGUoc2NhbGUsIHJvdGF0aW9uKSB7CiAgICAgIHRoaXMuc2NhbGUgPSBzY2FsZSB8fCB0aGlzLnNjYWxlOwoKICAgICAgaWYgKHR5cGVvZiByb3RhdGlvbiAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICB0aGlzLnJvdGF0aW9uID0gcm90YXRpb247CiAgICAgIH0KCiAgICAgIHZhciB0b3RhbFJvdGF0aW9uID0gKHRoaXMucm90YXRpb24gKyB0aGlzLnBkZlBhZ2VSb3RhdGUpICUgMzYwOwogICAgICB0aGlzLnZpZXdwb3J0ID0gdGhpcy52aWV3cG9ydC5jbG9uZSh7CiAgICAgICAgc2NhbGU6IHRoaXMuc2NhbGUgKiBfdWlfdXRpbHMuQ1NTX1VOSVRTLAogICAgICAgIHJvdGF0aW9uOiB0b3RhbFJvdGF0aW9uCiAgICAgIH0pOwoKICAgICAgaWYgKHRoaXMuc3ZnKSB7CiAgICAgICAgdGhpcy5jc3NUcmFuc2Zvcm0odGhpcy5zdmcsIHRydWUpOwogICAgICAgIHRoaXMuZXZlbnRCdXMuZGlzcGF0Y2goInBhZ2VyZW5kZXJlZCIsIHsKICAgICAgICAgIHNvdXJjZTogdGhpcywKICAgICAgICAgIHBhZ2VOdW1iZXI6IHRoaXMuaWQsCiAgICAgICAgICBjc3NUcmFuc2Zvcm06IHRydWUsCiAgICAgICAgICB0aW1lc3RhbXA6IHBlcmZvcm1hbmNlLm5vdygpCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgaXNTY2FsaW5nUmVzdHJpY3RlZCA9IGZhbHNlOwoKICAgICAgaWYgKHRoaXMuY2FudmFzICYmIHRoaXMubWF4Q2FudmFzUGl4ZWxzID4gMCkgewogICAgICAgIHZhciBvdXRwdXRTY2FsZSA9IHRoaXMub3V0cHV0U2NhbGU7CgogICAgICAgIGlmICgoTWF0aC5mbG9vcih0aGlzLnZpZXdwb3J0LndpZHRoKSAqIG91dHB1dFNjYWxlLnN4IHwgMCkgKiAoTWF0aC5mbG9vcih0aGlzLnZpZXdwb3J0LmhlaWdodCkgKiBvdXRwdXRTY2FsZS5zeSB8IDApID4gdGhpcy5tYXhDYW52YXNQaXhlbHMpIHsKICAgICAgICAgIGlzU2NhbGluZ1Jlc3RyaWN0ZWQgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHRoaXMuY2FudmFzKSB7CiAgICAgICAgaWYgKHRoaXMudXNlT25seUNzc1pvb20gfHwgdGhpcy5oYXNSZXN0cmljdGVkU2NhbGluZyAmJiBpc1NjYWxpbmdSZXN0cmljdGVkKSB7CiAgICAgICAgICB0aGlzLmNzc1RyYW5zZm9ybSh0aGlzLmNhbnZhcywgdHJ1ZSk7CiAgICAgICAgICB0aGlzLmV2ZW50QnVzLmRpc3BhdGNoKCJwYWdlcmVuZGVyZWQiLCB7CiAgICAgICAgICAgIHNvdXJjZTogdGhpcywKICAgICAgICAgICAgcGFnZU51bWJlcjogdGhpcy5pZCwKICAgICAgICAgICAgY3NzVHJhbnNmb3JtOiB0cnVlLAogICAgICAgICAgICB0aW1lc3RhbXA6IHBlcmZvcm1hbmNlLm5vdygpCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICghdGhpcy56b29tTGF5ZXIgJiYgIXRoaXMuY2FudmFzLmhhc0F0dHJpYnV0ZSgiaGlkZGVuIikpIHsKICAgICAgICAgIHRoaXMuem9vbUxheWVyID0gdGhpcy5jYW52YXMucGFyZW50Tm9kZTsKICAgICAgICAgIHRoaXMuem9vbUxheWVyLnN0eWxlLnBvc2l0aW9uID0gImFic29sdXRlIjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnpvb21MYXllcikgewogICAgICAgIHRoaXMuY3NzVHJhbnNmb3JtKHRoaXMuem9vbUxheWVyLmZpcnN0Q2hpbGQpOwogICAgICB9CgogICAgICB0aGlzLnJlc2V0KHRydWUsIHRydWUpOwogICAgfQogIH0sIHsKICAgIGtleTogImNhbmNlbFJlbmRlcmluZyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY2FuY2VsUmVuZGVyaW5nKCkgewogICAgICB2YXIga2VlcEFubm90YXRpb25zID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiBmYWxzZTsKCiAgICAgIGlmICh0aGlzLnBhaW50VGFzaykgewogICAgICAgIHRoaXMucGFpbnRUYXNrLmNhbmNlbCgpOwogICAgICAgIHRoaXMucGFpbnRUYXNrID0gbnVsbDsKICAgICAgfQoKICAgICAgdGhpcy5yZXN1bWUgPSBudWxsOwoKICAgICAgaWYgKHRoaXMudGV4dExheWVyKSB7CiAgICAgICAgdGhpcy50ZXh0TGF5ZXIuY2FuY2VsKCk7CiAgICAgICAgdGhpcy50ZXh0TGF5ZXIgPSBudWxsOwogICAgICB9CgogICAgICBpZiAoIWtlZXBBbm5vdGF0aW9ucyAmJiB0aGlzLmFubm90YXRpb25MYXllcikgewogICAgICAgIHRoaXMuYW5ub3RhdGlvbkxheWVyLmNhbmNlbCgpOwogICAgICAgIHRoaXMuYW5ub3RhdGlvbkxheWVyID0gbnVsbDsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogImNzc1RyYW5zZm9ybSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY3NzVHJhbnNmb3JtKHRhcmdldCkgewogICAgICB2YXIgcmVkcmF3QW5ub3RhdGlvbnMgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IGZhbHNlOwogICAgICB2YXIgd2lkdGggPSB0aGlzLnZpZXdwb3J0LndpZHRoOwogICAgICB2YXIgaGVpZ2h0ID0gdGhpcy52aWV3cG9ydC5oZWlnaHQ7CiAgICAgIHZhciBkaXYgPSB0aGlzLmRpdjsKICAgICAgdGFyZ2V0LnN0eWxlLndpZHRoID0gdGFyZ2V0LnBhcmVudE5vZGUuc3R5bGUud2lkdGggPSBkaXYuc3R5bGUud2lkdGggPSBNYXRoLmZsb29yKHdpZHRoKSArICJweCI7CiAgICAgIHRhcmdldC5zdHlsZS5oZWlnaHQgPSB0YXJnZXQucGFyZW50Tm9kZS5zdHlsZS5oZWlnaHQgPSBkaXYuc3R5bGUuaGVpZ2h0ID0gTWF0aC5mbG9vcihoZWlnaHQpICsgInB4IjsKICAgICAgdmFyIHJlbGF0aXZlUm90YXRpb24gPSB0aGlzLnZpZXdwb3J0LnJvdGF0aW9uIC0gdGhpcy5wYWludGVkVmlld3BvcnRNYXAuZ2V0KHRhcmdldCkucm90YXRpb247CiAgICAgIHZhciBhYnNSb3RhdGlvbiA9IE1hdGguYWJzKHJlbGF0aXZlUm90YXRpb24pOwogICAgICB2YXIgc2NhbGVYID0gMSwKICAgICAgICAgIHNjYWxlWSA9IDE7CgogICAgICBpZiAoYWJzUm90YXRpb24gPT09IDkwIHx8IGFic1JvdGF0aW9uID09PSAyNzApIHsKICAgICAgICBzY2FsZVggPSBoZWlnaHQgLyB3aWR0aDsKICAgICAgICBzY2FsZVkgPSB3aWR0aCAvIGhlaWdodDsKICAgICAgfQoKICAgICAgdmFyIGNzc1RyYW5zZm9ybSA9ICJyb3RhdGUoIiArIHJlbGF0aXZlUm90YXRpb24gKyAiZGVnKSAiICsgInNjYWxlKCIgKyBzY2FsZVggKyAiLCIgKyBzY2FsZVkgKyAiKSI7CiAgICAgIHRhcmdldC5zdHlsZS50cmFuc2Zvcm0gPSBjc3NUcmFuc2Zvcm07CgogICAgICBpZiAodGhpcy50ZXh0TGF5ZXIpIHsKICAgICAgICB2YXIgdGV4dExheWVyVmlld3BvcnQgPSB0aGlzLnRleHRMYXllci52aWV3cG9ydDsKICAgICAgICB2YXIgdGV4dFJlbGF0aXZlUm90YXRpb24gPSB0aGlzLnZpZXdwb3J0LnJvdGF0aW9uIC0gdGV4dExheWVyVmlld3BvcnQucm90YXRpb247CiAgICAgICAgdmFyIHRleHRBYnNSb3RhdGlvbiA9IE1hdGguYWJzKHRleHRSZWxhdGl2ZVJvdGF0aW9uKTsKICAgICAgICB2YXIgc2NhbGUgPSB3aWR0aCAvIHRleHRMYXllclZpZXdwb3J0LndpZHRoOwoKICAgICAgICBpZiAodGV4dEFic1JvdGF0aW9uID09PSA5MCB8fCB0ZXh0QWJzUm90YXRpb24gPT09IDI3MCkgewogICAgICAgICAgc2NhbGUgPSB3aWR0aCAvIHRleHRMYXllclZpZXdwb3J0LmhlaWdodDsKICAgICAgICB9CgogICAgICAgIHZhciB0ZXh0TGF5ZXJEaXYgPSB0aGlzLnRleHRMYXllci50ZXh0TGF5ZXJEaXY7CiAgICAgICAgdmFyIHRyYW5zWCwgdHJhbnNZOwoKICAgICAgICBzd2l0Y2ggKHRleHRBYnNSb3RhdGlvbikgewogICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICB0cmFuc1ggPSB0cmFuc1kgPSAwOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIDkwOgogICAgICAgICAgICB0cmFuc1ggPSAwOwogICAgICAgICAgICB0cmFuc1kgPSAiLSIgKyB0ZXh0TGF5ZXJEaXYuc3R5bGUuaGVpZ2h0OwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIDE4MDoKICAgICAgICAgICAgdHJhbnNYID0gIi0iICsgdGV4dExheWVyRGl2LnN0eWxlLndpZHRoOwogICAgICAgICAgICB0cmFuc1kgPSAiLSIgKyB0ZXh0TGF5ZXJEaXYuc3R5bGUuaGVpZ2h0OwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIDI3MDoKICAgICAgICAgICAgdHJhbnNYID0gIi0iICsgdGV4dExheWVyRGl2LnN0eWxlLndpZHRoOwogICAgICAgICAgICB0cmFuc1kgPSAwOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBjb25zb2xlLmVycm9yKCJCYWQgcm90YXRpb24gdmFsdWUuIik7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgdGV4dExheWVyRGl2LnN0eWxlLnRyYW5zZm9ybSA9ICJyb3RhdGUoIiArIHRleHRBYnNSb3RhdGlvbiArICJkZWcpICIgKyAic2NhbGUoIiArIHNjYWxlICsgIiwgIiArIHNjYWxlICsgIikgIiArICJ0cmFuc2xhdGUoIiArIHRyYW5zWCArICIsICIgKyB0cmFuc1kgKyAiKSI7CiAgICAgICAgdGV4dExheWVyRGl2LnN0eWxlLnRyYW5zZm9ybU9yaWdpbiA9ICIwJSAwJSI7CiAgICAgIH0KCiAgICAgIGlmIChyZWRyYXdBbm5vdGF0aW9ucyAmJiB0aGlzLmFubm90YXRpb25MYXllcikgewogICAgICAgIHRoaXMuYW5ub3RhdGlvbkxheWVyLnJlbmRlcih0aGlzLnZpZXdwb3J0LCAiZGlzcGxheSIpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAiZ2V0UGFnZVBvaW50IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRQYWdlUG9pbnQoeCwgeSkgewogICAgICByZXR1cm4gdGhpcy52aWV3cG9ydC5jb252ZXJ0VG9QZGZQb2ludCh4LCB5KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJkcmF3IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBkcmF3KCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgaWYgKHRoaXMucmVuZGVyaW5nU3RhdGUgIT09IF9wZGZfcmVuZGVyaW5nX3F1ZXVlLlJlbmRlcmluZ1N0YXRlcy5JTklUSUFMKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiTXVzdCBiZSBpbiBuZXcgc3RhdGUgYmVmb3JlIGRyYXdpbmciKTsKICAgICAgICB0aGlzLnJlc2V0KCk7CiAgICAgIH0KCiAgICAgIHZhciBkaXYgPSB0aGlzLmRpdiwKICAgICAgICAgIHBkZlBhZ2UgPSB0aGlzLnBkZlBhZ2U7CgogICAgICBpZiAoIXBkZlBhZ2UpIHsKICAgICAgICB0aGlzLnJlbmRlcmluZ1N0YXRlID0gX3BkZl9yZW5kZXJpbmdfcXVldWUuUmVuZGVyaW5nU3RhdGVzLkZJTklTSEVEOwoKICAgICAgICBpZiAodGhpcy5sb2FkaW5nSWNvbkRpdikgewogICAgICAgICAgZGl2LnJlbW92ZUNoaWxkKHRoaXMubG9hZGluZ0ljb25EaXYpOwogICAgICAgICAgZGVsZXRlIHRoaXMubG9hZGluZ0ljb25EaXY7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCJwZGZQYWdlIGlzIG5vdCBsb2FkZWQiKSk7CiAgICAgIH0KCiAgICAgIHRoaXMucmVuZGVyaW5nU3RhdGUgPSBfcGRmX3JlbmRlcmluZ19xdWV1ZS5SZW5kZXJpbmdTdGF0ZXMuUlVOTklORzsKICAgICAgdmFyIGNhbnZhc1dyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgY2FudmFzV3JhcHBlci5zdHlsZS53aWR0aCA9IGRpdi5zdHlsZS53aWR0aDsKICAgICAgY2FudmFzV3JhcHBlci5zdHlsZS5oZWlnaHQgPSBkaXYuc3R5bGUuaGVpZ2h0OwogICAgICBjYW52YXNXcmFwcGVyLmNsYXNzTGlzdC5hZGQoImNhbnZhc1dyYXBwZXIiKTsKCiAgICAgIGlmICh0aGlzLmFubm90YXRpb25MYXllciAmJiB0aGlzLmFubm90YXRpb25MYXllci5kaXYpIHsKICAgICAgICBkaXYuaW5zZXJ0QmVmb3JlKGNhbnZhc1dyYXBwZXIsIHRoaXMuYW5ub3RhdGlvbkxheWVyLmRpdik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGl2LmFwcGVuZENoaWxkKGNhbnZhc1dyYXBwZXIpOwogICAgICB9CgogICAgICB2YXIgdGV4dExheWVyID0gbnVsbDsKCiAgICAgIGlmICh0aGlzLnRleHRMYXllck1vZGUgIT09IF91aV91dGlscy5UZXh0TGF5ZXJNb2RlLkRJU0FCTEUgJiYgdGhpcy50ZXh0TGF5ZXJGYWN0b3J5KSB7CiAgICAgICAgdmFyIHRleHRMYXllckRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgIHRleHRMYXllckRpdi5jbGFzc05hbWUgPSAidGV4dExheWVyIjsKICAgICAgICB0ZXh0TGF5ZXJEaXYuc3R5bGUud2lkdGggPSBjYW52YXNXcmFwcGVyLnN0eWxlLndpZHRoOwogICAgICAgIHRleHRMYXllckRpdi5zdHlsZS5oZWlnaHQgPSBjYW52YXNXcmFwcGVyLnN0eWxlLmhlaWdodDsKCiAgICAgICAgaWYgKHRoaXMuYW5ub3RhdGlvbkxheWVyICYmIHRoaXMuYW5ub3RhdGlvbkxheWVyLmRpdikgewogICAgICAgICAgZGl2Lmluc2VydEJlZm9yZSh0ZXh0TGF5ZXJEaXYsIHRoaXMuYW5ub3RhdGlvbkxheWVyLmRpdik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRpdi5hcHBlbmRDaGlsZCh0ZXh0TGF5ZXJEaXYpOwogICAgICAgIH0KCiAgICAgICAgdGV4dExheWVyID0gdGhpcy50ZXh0TGF5ZXJGYWN0b3J5LmNyZWF0ZVRleHRMYXllckJ1aWxkZXIodGV4dExheWVyRGl2LCB0aGlzLmlkIC0gMSwgdGhpcy52aWV3cG9ydCwgdGhpcy50ZXh0TGF5ZXJNb2RlID09PSBfdWlfdXRpbHMuVGV4dExheWVyTW9kZS5FTkFCTEVfRU5IQU5DRSwgdGhpcy5ldmVudEJ1cyk7CiAgICAgIH0KCiAgICAgIHRoaXMudGV4dExheWVyID0gdGV4dExheWVyOwogICAgICB2YXIgcmVuZGVyQ29udGludWVDYWxsYmFjayA9IG51bGw7CgogICAgICBpZiAodGhpcy5yZW5kZXJpbmdRdWV1ZSkgewogICAgICAgIHJlbmRlckNvbnRpbnVlQ2FsbGJhY2sgPSBmdW5jdGlvbiByZW5kZXJDb250aW51ZUNhbGxiYWNrKGNvbnQpIHsKICAgICAgICAgIGlmICghX3RoaXMucmVuZGVyaW5nUXVldWUuaXNIaWdoZXN0UHJpb3JpdHkoX3RoaXMpKSB7CiAgICAgICAgICAgIF90aGlzLnJlbmRlcmluZ1N0YXRlID0gX3BkZl9yZW5kZXJpbmdfcXVldWUuUmVuZGVyaW5nU3RhdGVzLlBBVVNFRDsKCiAgICAgICAgICAgIF90aGlzLnJlc3VtZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBfdGhpcy5yZW5kZXJpbmdTdGF0ZSA9IF9wZGZfcmVuZGVyaW5nX3F1ZXVlLlJlbmRlcmluZ1N0YXRlcy5SVU5OSU5HOwogICAgICAgICAgICAgIGNvbnQoKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBjb250KCk7CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgdmFyIGZpbmlzaFBhaW50VGFzayA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIF9yZWYgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclsiZGVmYXVsdCJdLm1hcmsoZnVuY3Rpb24gX2NhbGxlZShlcnJvcikgewogICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclsiZGVmYXVsdCJdLndyYXAoZnVuY3Rpb24gX2NhbGxlZSQoX2NvbnRleHQpIHsKICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0LnByZXYgPSBfY29udGV4dC5uZXh0KSB7CiAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgIGlmIChwYWludFRhc2sgPT09IF90aGlzLnBhaW50VGFzaykgewogICAgICAgICAgICAgICAgICAgIF90aGlzLnBhaW50VGFzayA9IG51bGw7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmICghKGVycm9yIGluc3RhbmNlb2YgX3BkZmpzTGliLlJlbmRlcmluZ0NhbmNlbGxlZEV4Y2VwdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICBfY29udGV4dC5uZXh0ID0gNDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgX3RoaXMuZXJyb3IgPSBudWxsOwogICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQuYWJydXB0KCJyZXR1cm4iKTsKCiAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICAgIF90aGlzLnJlbmRlcmluZ1N0YXRlID0gX3BkZl9yZW5kZXJpbmdfcXVldWUuUmVuZGVyaW5nU3RhdGVzLkZJTklTSEVEOwoKICAgICAgICAgICAgICAgICAgaWYgKF90aGlzLmxvYWRpbmdJY29uRGl2KSB7CiAgICAgICAgICAgICAgICAgICAgZGl2LnJlbW92ZUNoaWxkKF90aGlzLmxvYWRpbmdJY29uRGl2KTsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgX3RoaXMubG9hZGluZ0ljb25EaXY7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIF90aGlzLl9yZXNldFpvb21MYXllcih0cnVlKTsKCiAgICAgICAgICAgICAgICAgIF90aGlzLmVycm9yID0gZXJyb3I7CiAgICAgICAgICAgICAgICAgIF90aGlzLnN0YXRzID0gcGRmUGFnZS5zdGF0czsKCiAgICAgICAgICAgICAgICAgIF90aGlzLmV2ZW50QnVzLmRpc3BhdGNoKCJwYWdlcmVuZGVyZWQiLCB7CiAgICAgICAgICAgICAgICAgICAgc291cmNlOiBfdGhpcywKICAgICAgICAgICAgICAgICAgICBwYWdlTnVtYmVyOiBfdGhpcy5pZCwKICAgICAgICAgICAgICAgICAgICBjc3NUcmFuc2Zvcm06IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogcGVyZm9ybWFuY2Uubm93KCkKICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICBpZiAoIWVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDEyOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjsKCiAgICAgICAgICAgICAgICBjYXNlIDEyOgogICAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0LnN0b3AoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIF9jYWxsZWUpOwogICAgICAgIH0pKTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGZpbmlzaFBhaW50VGFzayhfeCkgewogICAgICAgICAgcmV0dXJuIF9yZWYuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9OwogICAgICB9KCk7CgogICAgICB2YXIgcGFpbnRUYXNrID0gdGhpcy5yZW5kZXJlciA9PT0gX3VpX3V0aWxzLlJlbmRlcmVyVHlwZS5TVkcgPyB0aGlzLnBhaW50T25TdmcoY2FudmFzV3JhcHBlcikgOiB0aGlzLnBhaW50T25DYW52YXMoY2FudmFzV3JhcHBlcik7CiAgICAgIHBhaW50VGFzay5vblJlbmRlckNvbnRpbnVlID0gcmVuZGVyQ29udGludWVDYWxsYmFjazsKICAgICAgdGhpcy5wYWludFRhc2sgPSBwYWludFRhc2s7CiAgICAgIHZhciByZXN1bHRQcm9taXNlID0gcGFpbnRUYXNrLnByb21pc2UudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGZpbmlzaFBhaW50VGFzayhudWxsKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICh0ZXh0TGF5ZXIpIHsKICAgICAgICAgICAgdmFyIHJlYWRhYmxlU3RyZWFtID0gcGRmUGFnZS5zdHJlYW1UZXh0Q29udGVudCh7CiAgICAgICAgICAgICAgbm9ybWFsaXplV2hpdGVzcGFjZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGV4dExheWVyLnNldFRleHRDb250ZW50U3RyZWFtKHJlYWRhYmxlU3RyZWFtKTsKICAgICAgICAgICAgdGV4dExheWVyLnJlbmRlcigpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgcmV0dXJuIGZpbmlzaFBhaW50VGFzayhyZWFzb24pOwogICAgICB9KTsKCiAgICAgIGlmICh0aGlzLmFubm90YXRpb25MYXllckZhY3RvcnkpIHsKICAgICAgICBpZiAoIXRoaXMuYW5ub3RhdGlvbkxheWVyKSB7CiAgICAgICAgICB0aGlzLmFubm90YXRpb25MYXllciA9IHRoaXMuYW5ub3RhdGlvbkxheWVyRmFjdG9yeS5jcmVhdGVBbm5vdGF0aW9uTGF5ZXJCdWlsZGVyKGRpdiwgcGRmUGFnZSwgdGhpcy5pbWFnZVJlc291cmNlc1BhdGgsIHRoaXMucmVuZGVySW50ZXJhY3RpdmVGb3JtcywgdGhpcy5sMTBuKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuYW5ub3RhdGlvbkxheWVyLnJlbmRlcih0aGlzLnZpZXdwb3J0LCAiZGlzcGxheSIpOwogICAgICB9CgogICAgICBkaXYuc2V0QXR0cmlidXRlKCJkYXRhLWxvYWRlZCIsIHRydWUpOwogICAgICB0aGlzLmV2ZW50QnVzLmRpc3BhdGNoKCJwYWdlcmVuZGVyIiwgewogICAgICAgIHNvdXJjZTogdGhpcywKICAgICAgICBwYWdlTnVtYmVyOiB0aGlzLmlkCiAgICAgIH0pOwogICAgICByZXR1cm4gcmVzdWx0UHJvbWlzZTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJwYWludE9uQ2FudmFzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBwYWludE9uQ2FudmFzKGNhbnZhc1dyYXBwZXIpIHsKICAgICAgdmFyIHJlbmRlckNhcGFiaWxpdHkgPSAoMCwgX3BkZmpzTGliLmNyZWF0ZVByb21pc2VDYXBhYmlsaXR5KSgpOwogICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgIHByb21pc2U6IHJlbmRlckNhcGFiaWxpdHkucHJvbWlzZSwKICAgICAgICBvblJlbmRlckNvbnRpbnVlOiBmdW5jdGlvbiBvblJlbmRlckNvbnRpbnVlKGNvbnQpIHsKICAgICAgICAgIGNvbnQoKTsKICAgICAgICB9LAogICAgICAgIGNhbmNlbDogZnVuY3Rpb24gY2FuY2VsKCkgewogICAgICAgICAgcmVuZGVyVGFzay5jYW5jZWwoKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIHZhciB2aWV3cG9ydCA9IHRoaXMudmlld3BvcnQ7CiAgICAgIHZhciBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKICAgICAgdGhpcy5sMTBuLmdldCgicGFnZV9jYW52YXMiLCB7CiAgICAgICAgcGFnZTogdGhpcy5pZAogICAgICB9LCAiUGFnZSB7e3BhZ2V9fSIpLnRoZW4oZnVuY3Rpb24gKG1zZykgewogICAgICAgIGNhbnZhcy5zZXRBdHRyaWJ1dGUoImFyaWEtbGFiZWwiLCBtc2cpOwogICAgICB9KTsKICAgICAgY2FudmFzLnNldEF0dHJpYnV0ZSgiaGlkZGVuIiwgImhpZGRlbiIpOwogICAgICB2YXIgaXNDYW52YXNIaWRkZW4gPSB0cnVlOwoKICAgICAgdmFyIHNob3dDYW52YXMgPSBmdW5jdGlvbiBzaG93Q2FudmFzKCkgewogICAgICAgIGlmIChpc0NhbnZhc0hpZGRlbikgewogICAgICAgICAgY2FudmFzLnJlbW92ZUF0dHJpYnV0ZSgiaGlkZGVuIik7CiAgICAgICAgICBpc0NhbnZhc0hpZGRlbiA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGNhbnZhc1dyYXBwZXIuYXBwZW5kQ2hpbGQoY2FudmFzKTsKICAgICAgdGhpcy5jYW52YXMgPSBjYW52YXM7CiAgICAgIGNhbnZhcy5tb3pPcGFxdWUgPSB0cnVlOwogICAgICB2YXIgY3R4ID0gY2FudmFzLmdldENvbnRleHQoIjJkIiwgewogICAgICAgIGFscGhhOiBmYWxzZQogICAgICB9KTsKICAgICAgdmFyIG91dHB1dFNjYWxlID0gKDAsIF91aV91dGlscy5nZXRPdXRwdXRTY2FsZSkoY3R4KTsKICAgICAgdGhpcy5vdXRwdXRTY2FsZSA9IG91dHB1dFNjYWxlOwoKICAgICAgaWYgKHRoaXMudXNlT25seUNzc1pvb20pIHsKICAgICAgICB2YXIgYWN0dWFsU2l6ZVZpZXdwb3J0ID0gdmlld3BvcnQuY2xvbmUoewogICAgICAgICAgc2NhbGU6IF91aV91dGlscy5DU1NfVU5JVFMKICAgICAgICB9KTsKICAgICAgICBvdXRwdXRTY2FsZS5zeCAqPSBhY3R1YWxTaXplVmlld3BvcnQud2lkdGggLyB2aWV3cG9ydC53aWR0aDsKICAgICAgICBvdXRwdXRTY2FsZS5zeSAqPSBhY3R1YWxTaXplVmlld3BvcnQuaGVpZ2h0IC8gdmlld3BvcnQuaGVpZ2h0OwogICAgICAgIG91dHB1dFNjYWxlLnNjYWxlZCA9IHRydWU7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLm1heENhbnZhc1BpeGVscyA+IDApIHsKICAgICAgICB2YXIgcGl4ZWxzSW5WaWV3cG9ydCA9IHZpZXdwb3J0LndpZHRoICogdmlld3BvcnQuaGVpZ2h0OwogICAgICAgIHZhciBtYXhTY2FsZSA9IE1hdGguc3FydCh0aGlzLm1heENhbnZhc1BpeGVscyAvIHBpeGVsc0luVmlld3BvcnQpOwoKICAgICAgICBpZiAob3V0cHV0U2NhbGUuc3ggPiBtYXhTY2FsZSB8fCBvdXRwdXRTY2FsZS5zeSA+IG1heFNjYWxlKSB7CiAgICAgICAgICBvdXRwdXRTY2FsZS5zeCA9IG1heFNjYWxlOwogICAgICAgICAgb3V0cHV0U2NhbGUuc3kgPSBtYXhTY2FsZTsKICAgICAgICAgIG91dHB1dFNjYWxlLnNjYWxlZCA9IHRydWU7CiAgICAgICAgICB0aGlzLmhhc1Jlc3RyaWN0ZWRTY2FsaW5nID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5oYXNSZXN0cmljdGVkU2NhbGluZyA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIHNmeCA9ICgwLCBfdWlfdXRpbHMuYXBwcm94aW1hdGVGcmFjdGlvbikob3V0cHV0U2NhbGUuc3gpOwogICAgICB2YXIgc2Z5ID0gKDAsIF91aV91dGlscy5hcHByb3hpbWF0ZUZyYWN0aW9uKShvdXRwdXRTY2FsZS5zeSk7CiAgICAgIGNhbnZhcy53aWR0aCA9ICgwLCBfdWlfdXRpbHMucm91bmRUb0RpdmlkZSkodmlld3BvcnQud2lkdGggKiBvdXRwdXRTY2FsZS5zeCwgc2Z4WzBdKTsKICAgICAgY2FudmFzLmhlaWdodCA9ICgwLCBfdWlfdXRpbHMucm91bmRUb0RpdmlkZSkodmlld3BvcnQuaGVpZ2h0ICogb3V0cHV0U2NhbGUuc3ksIHNmeVswXSk7CiAgICAgIGNhbnZhcy5zdHlsZS53aWR0aCA9ICgwLCBfdWlfdXRpbHMucm91bmRUb0RpdmlkZSkodmlld3BvcnQud2lkdGgsIHNmeFsxXSkgKyAicHgiOwogICAgICBjYW52YXMuc3R5bGUuaGVpZ2h0ID0gKDAsIF91aV91dGlscy5yb3VuZFRvRGl2aWRlKSh2aWV3cG9ydC5oZWlnaHQsIHNmeVsxXSkgKyAicHgiOwogICAgICB0aGlzLnBhaW50ZWRWaWV3cG9ydE1hcC5zZXQoY2FudmFzLCB2aWV3cG9ydCk7CiAgICAgIHZhciB0cmFuc2Zvcm0gPSAhb3V0cHV0U2NhbGUuc2NhbGVkID8gbnVsbCA6IFtvdXRwdXRTY2FsZS5zeCwgMCwgMCwgb3V0cHV0U2NhbGUuc3ksIDAsIDBdOwogICAgICB2YXIgcmVuZGVyQ29udGV4dCA9IHsKICAgICAgICBjYW52YXNDb250ZXh0OiBjdHgsCiAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2Zvcm0sCiAgICAgICAgdmlld3BvcnQ6IHRoaXMudmlld3BvcnQsCiAgICAgICAgZW5hYmxlV2ViR0w6IHRoaXMuZW5hYmxlV2ViR0wsCiAgICAgICAgcmVuZGVySW50ZXJhY3RpdmVGb3JtczogdGhpcy5yZW5kZXJJbnRlcmFjdGl2ZUZvcm1zCiAgICAgIH07CiAgICAgIHZhciByZW5kZXJUYXNrID0gdGhpcy5wZGZQYWdlLnJlbmRlcihyZW5kZXJDb250ZXh0KTsKCiAgICAgIHJlbmRlclRhc2sub25Db250aW51ZSA9IGZ1bmN0aW9uIChjb250KSB7CiAgICAgICAgc2hvd0NhbnZhcygpOwoKICAgICAgICBpZiAocmVzdWx0Lm9uUmVuZGVyQ29udGludWUpIHsKICAgICAgICAgIHJlc3VsdC5vblJlbmRlckNvbnRpbnVlKGNvbnQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb250KCk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgcmVuZGVyVGFzay5wcm9taXNlLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgIHNob3dDYW52YXMoKTsKICAgICAgICByZW5kZXJDYXBhYmlsaXR5LnJlc29sdmUodW5kZWZpbmVkKTsKICAgICAgfSwgZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgc2hvd0NhbnZhcygpOwogICAgICAgIHJlbmRlckNhcGFiaWxpdHkucmVqZWN0KGVycm9yKTsKICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgfSwgewogICAga2V5OiAicGFpbnRPblN2ZyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcGFpbnRPblN2Zyh3cmFwcGVyKSB7CiAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgdmFyIGNhbmNlbGxlZCA9IGZhbHNlOwoKICAgICAgdmFyIGVuc3VyZU5vdENhbmNlbGxlZCA9IGZ1bmN0aW9uIGVuc3VyZU5vdENhbmNlbGxlZCgpIHsKICAgICAgICBpZiAoY2FuY2VsbGVkKSB7CiAgICAgICAgICB0aHJvdyBuZXcgX3BkZmpzTGliLlJlbmRlcmluZ0NhbmNlbGxlZEV4Y2VwdGlvbigiUmVuZGVyaW5nIGNhbmNlbGxlZCwgcGFnZSAiLmNvbmNhdChfdGhpczIuaWQpLCAic3ZnIik7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgdmFyIHBkZlBhZ2UgPSB0aGlzLnBkZlBhZ2U7CiAgICAgIHZhciBhY3R1YWxTaXplVmlld3BvcnQgPSB0aGlzLnZpZXdwb3J0LmNsb25lKHsKICAgICAgICBzY2FsZTogX3VpX3V0aWxzLkNTU19VTklUUwogICAgICB9KTsKICAgICAgdmFyIHByb21pc2UgPSBwZGZQYWdlLmdldE9wZXJhdG9yTGlzdCgpLnRoZW4oZnVuY3Rpb24gKG9wTGlzdCkgewogICAgICAgIGVuc3VyZU5vdENhbmNlbGxlZCgpOwogICAgICAgIHZhciBzdmdHZnggPSBuZXcgX3BkZmpzTGliLlNWR0dyYXBoaWNzKHBkZlBhZ2UuY29tbW9uT2JqcywgcGRmUGFnZS5vYmpzKTsKICAgICAgICByZXR1cm4gc3ZnR2Z4LmdldFNWRyhvcExpc3QsIGFjdHVhbFNpemVWaWV3cG9ydCkudGhlbihmdW5jdGlvbiAoc3ZnKSB7CiAgICAgICAgICBlbnN1cmVOb3RDYW5jZWxsZWQoKTsKICAgICAgICAgIF90aGlzMi5zdmcgPSBzdmc7CgogICAgICAgICAgX3RoaXMyLnBhaW50ZWRWaWV3cG9ydE1hcC5zZXQoc3ZnLCBhY3R1YWxTaXplVmlld3BvcnQpOwoKICAgICAgICAgIHN2Zy5zdHlsZS53aWR0aCA9IHdyYXBwZXIuc3R5bGUud2lkdGg7CiAgICAgICAgICBzdmcuc3R5bGUuaGVpZ2h0ID0gd3JhcHBlci5zdHlsZS5oZWlnaHQ7CiAgICAgICAgICBfdGhpczIucmVuZGVyaW5nU3RhdGUgPSBfcGRmX3JlbmRlcmluZ19xdWV1ZS5SZW5kZXJpbmdTdGF0ZXMuRklOSVNIRUQ7CiAgICAgICAgICB3cmFwcGVyLmFwcGVuZENoaWxkKHN2Zyk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gewogICAgICAgIHByb21pc2U6IHByb21pc2UsCiAgICAgICAgb25SZW5kZXJDb250aW51ZTogZnVuY3Rpb24gb25SZW5kZXJDb250aW51ZShjb250KSB7CiAgICAgICAgICBjb250KCk7CiAgICAgICAgfSwKICAgICAgICBjYW5jZWw6IGZ1bmN0aW9uIGNhbmNlbCgpIHsKICAgICAgICAgIGNhbmNlbGxlZCA9IHRydWU7CiAgICAgICAgfQogICAgICB9OwogICAgfQogIH0sIHsKICAgIGtleTogInNldFBhZ2VMYWJlbCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2V0UGFnZUxhYmVsKGxhYmVsKSB7CiAgICAgIHRoaXMucGFnZUxhYmVsID0gdHlwZW9mIGxhYmVsID09PSAic3RyaW5nIiA/IGxhYmVsIDogbnVsbDsKCiAgICAgIGlmICh0aGlzLnBhZ2VMYWJlbCAhPT0gbnVsbCkgewogICAgICAgIHRoaXMuZGl2LnNldEF0dHJpYnV0ZSgiZGF0YS1wYWdlLWxhYmVsIiwgdGhpcy5wYWdlTGFiZWwpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuZGl2LnJlbW92ZUF0dHJpYnV0ZSgiZGF0YS1wYWdlLWxhYmVsIik7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJ3aWR0aCIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMudmlld3BvcnQud2lkdGg7CiAgICB9CiAgfSwgewogICAga2V5OiAiaGVpZ2h0IiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy52aWV3cG9ydC5oZWlnaHQ7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gUERGUGFnZVZpZXc7Cn0oKTsKCmV4cG9ydHMuUERGUGFnZVZpZXcgPSBQREZQYWdlVmlldzsKCi8qKiovIH0pLAovKiAzMSAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoidXNlIHN0cmljdCI7CgoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLkRlZmF1bHRUZXh0TGF5ZXJGYWN0b3J5ID0gZXhwb3J0cy5UZXh0TGF5ZXJCdWlsZGVyID0gdm9pZCAwOwoKdmFyIF9wZGZqc0xpYiA9IF9fd2VicGFja19yZXF1aXJlX18oOCk7CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOyB9IH0KCmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9CgpmdW5jdGlvbiBfY3JlYXRlQ2xhc3MoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfQoKdmFyIEVYUEFORF9ESVZTX1RJTUVPVVQgPSAzMDA7Cgp2YXIgVGV4dExheWVyQnVpbGRlciA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gVGV4dExheWVyQnVpbGRlcihfcmVmKSB7CiAgICB2YXIgdGV4dExheWVyRGl2ID0gX3JlZi50ZXh0TGF5ZXJEaXYsCiAgICAgICAgZXZlbnRCdXMgPSBfcmVmLmV2ZW50QnVzLAogICAgICAgIHBhZ2VJbmRleCA9IF9yZWYucGFnZUluZGV4LAogICAgICAgIHZpZXdwb3J0ID0gX3JlZi52aWV3cG9ydCwKICAgICAgICBfcmVmJGZpbmRDb250cm9sbGVyID0gX3JlZi5maW5kQ29udHJvbGxlciwKICAgICAgICBmaW5kQ29udHJvbGxlciA9IF9yZWYkZmluZENvbnRyb2xsZXIgPT09IHZvaWQgMCA/IG51bGwgOiBfcmVmJGZpbmRDb250cm9sbGVyLAogICAgICAgIF9yZWYkZW5oYW5jZVRleHRTZWxlYyA9IF9yZWYuZW5oYW5jZVRleHRTZWxlY3Rpb24sCiAgICAgICAgZW5oYW5jZVRleHRTZWxlY3Rpb24gPSBfcmVmJGVuaGFuY2VUZXh0U2VsZWMgPT09IHZvaWQgMCA/IGZhbHNlIDogX3JlZiRlbmhhbmNlVGV4dFNlbGVjOwoKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBUZXh0TGF5ZXJCdWlsZGVyKTsKCiAgICB0aGlzLnRleHRMYXllckRpdiA9IHRleHRMYXllckRpdjsKICAgIHRoaXMuZXZlbnRCdXMgPSBldmVudEJ1czsKICAgIHRoaXMudGV4dENvbnRlbnQgPSBudWxsOwogICAgdGhpcy50ZXh0Q29udGVudEl0ZW1zU3RyID0gW107CiAgICB0aGlzLnRleHRDb250ZW50U3RyZWFtID0gbnVsbDsKICAgIHRoaXMucmVuZGVyaW5nRG9uZSA9IGZhbHNlOwogICAgdGhpcy5wYWdlSWR4ID0gcGFnZUluZGV4OwogICAgdGhpcy5wYWdlTnVtYmVyID0gdGhpcy5wYWdlSWR4ICsgMTsKICAgIHRoaXMubWF0Y2hlcyA9IFtdOwogICAgdGhpcy52aWV3cG9ydCA9IHZpZXdwb3J0OwogICAgdGhpcy50ZXh0RGl2cyA9IFtdOwogICAgdGhpcy5maW5kQ29udHJvbGxlciA9IGZpbmRDb250cm9sbGVyOwogICAgdGhpcy50ZXh0TGF5ZXJSZW5kZXJUYXNrID0gbnVsbDsKICAgIHRoaXMuZW5oYW5jZVRleHRTZWxlY3Rpb24gPSBlbmhhbmNlVGV4dFNlbGVjdGlvbjsKICAgIHRoaXMuX29uVXBkYXRlVGV4dExheWVyTWF0Y2hlcyA9IG51bGw7CgogICAgdGhpcy5fYmluZE1vdXNlKCk7CiAgfQoKICBfY3JlYXRlQ2xhc3MoVGV4dExheWVyQnVpbGRlciwgW3sKICAgIGtleTogIl9maW5pc2hSZW5kZXJpbmciLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9maW5pc2hSZW5kZXJpbmcoKSB7CiAgICAgIHRoaXMucmVuZGVyaW5nRG9uZSA9IHRydWU7CgogICAgICBpZiAoIXRoaXMuZW5oYW5jZVRleHRTZWxlY3Rpb24pIHsKICAgICAgICB2YXIgZW5kT2ZDb250ZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgZW5kT2ZDb250ZW50LmNsYXNzTmFtZSA9ICJlbmRPZkNvbnRlbnQiOwogICAgICAgIHRoaXMudGV4dExheWVyRGl2LmFwcGVuZENoaWxkKGVuZE9mQ29udGVudCk7CiAgICAgIH0KCiAgICAgIHRoaXMuZXZlbnRCdXMuZGlzcGF0Y2goInRleHRsYXllcnJlbmRlcmVkIiwgewogICAgICAgIHNvdXJjZTogdGhpcywKICAgICAgICBwYWdlTnVtYmVyOiB0aGlzLnBhZ2VOdW1iZXIsCiAgICAgICAgbnVtVGV4dERpdnM6IHRoaXMudGV4dERpdnMubGVuZ3RoCiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogInJlbmRlciIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIHRpbWVvdXQgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IDA7CgogICAgICBpZiAoISh0aGlzLnRleHRDb250ZW50IHx8IHRoaXMudGV4dENvbnRlbnRTdHJlYW0pIHx8IHRoaXMucmVuZGVyaW5nRG9uZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5jYW5jZWwoKTsKICAgICAgdGhpcy50ZXh0RGl2cyA9IFtdOwogICAgICB2YXIgdGV4dExheWVyRnJhZyA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgdGhpcy50ZXh0TGF5ZXJSZW5kZXJUYXNrID0gKDAsIF9wZGZqc0xpYi5yZW5kZXJUZXh0TGF5ZXIpKHsKICAgICAgICB0ZXh0Q29udGVudDogdGhpcy50ZXh0Q29udGVudCwKICAgICAgICB0ZXh0Q29udGVudFN0cmVhbTogdGhpcy50ZXh0Q29udGVudFN0cmVhbSwKICAgICAgICBjb250YWluZXI6IHRleHRMYXllckZyYWcsCiAgICAgICAgdmlld3BvcnQ6IHRoaXMudmlld3BvcnQsCiAgICAgICAgdGV4dERpdnM6IHRoaXMudGV4dERpdnMsCiAgICAgICAgdGV4dENvbnRlbnRJdGVtc1N0cjogdGhpcy50ZXh0Q29udGVudEl0ZW1zU3RyLAogICAgICAgIHRpbWVvdXQ6IHRpbWVvdXQsCiAgICAgICAgZW5oYW5jZVRleHRTZWxlY3Rpb246IHRoaXMuZW5oYW5jZVRleHRTZWxlY3Rpb24KICAgICAgfSk7CiAgICAgIHRoaXMudGV4dExheWVyUmVuZGVyVGFzay5wcm9taXNlLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzLnRleHRMYXllckRpdi5hcHBlbmRDaGlsZCh0ZXh0TGF5ZXJGcmFnKTsKCiAgICAgICAgX3RoaXMuX2ZpbmlzaFJlbmRlcmluZygpOwoKICAgICAgICBfdGhpcy5fdXBkYXRlTWF0Y2hlcygpOwogICAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7fSk7CgogICAgICBpZiAoIXRoaXMuX29uVXBkYXRlVGV4dExheWVyTWF0Y2hlcykgewogICAgICAgIHRoaXMuX29uVXBkYXRlVGV4dExheWVyTWF0Y2hlcyA9IGZ1bmN0aW9uIChldnQpIHsKICAgICAgICAgIGlmIChldnQucGFnZUluZGV4ID09PSBfdGhpcy5wYWdlSWR4IHx8IGV2dC5wYWdlSW5kZXggPT09IC0xKSB7CiAgICAgICAgICAgIF90aGlzLl91cGRhdGVNYXRjaGVzKCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5ldmVudEJ1cy5fb24oInVwZGF0ZXRleHRsYXllcm1hdGNoZXMiLCB0aGlzLl9vblVwZGF0ZVRleHRMYXllck1hdGNoZXMpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAiY2FuY2VsIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjYW5jZWwoKSB7CiAgICAgIGlmICh0aGlzLnRleHRMYXllclJlbmRlclRhc2spIHsKICAgICAgICB0aGlzLnRleHRMYXllclJlbmRlclRhc2suY2FuY2VsKCk7CiAgICAgICAgdGhpcy50ZXh0TGF5ZXJSZW5kZXJUYXNrID0gbnVsbDsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuX29uVXBkYXRlVGV4dExheWVyTWF0Y2hlcykgewogICAgICAgIHRoaXMuZXZlbnRCdXMuX29mZigidXBkYXRldGV4dGxheWVybWF0Y2hlcyIsIHRoaXMuX29uVXBkYXRlVGV4dExheWVyTWF0Y2hlcyk7CgogICAgICAgIHRoaXMuX29uVXBkYXRlVGV4dExheWVyTWF0Y2hlcyA9IG51bGw7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJzZXRUZXh0Q29udGVudFN0cmVhbSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2V0VGV4dENvbnRlbnRTdHJlYW0ocmVhZGFibGVTdHJlYW0pIHsKICAgICAgdGhpcy5jYW5jZWwoKTsKICAgICAgdGhpcy50ZXh0Q29udGVudFN0cmVhbSA9IHJlYWRhYmxlU3RyZWFtOwogICAgfQogIH0sIHsKICAgIGtleTogInNldFRleHRDb250ZW50IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRUZXh0Q29udGVudCh0ZXh0Q29udGVudCkgewogICAgICB0aGlzLmNhbmNlbCgpOwogICAgICB0aGlzLnRleHRDb250ZW50ID0gdGV4dENvbnRlbnQ7CiAgICB9CiAgfSwgewogICAga2V5OiAiX2NvbnZlcnRNYXRjaGVzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfY29udmVydE1hdGNoZXMobWF0Y2hlcywgbWF0Y2hlc0xlbmd0aCkgewogICAgICBpZiAoIW1hdGNoZXMpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KCiAgICAgIHZhciBmaW5kQ29udHJvbGxlciA9IHRoaXMuZmluZENvbnRyb2xsZXIsCiAgICAgICAgICB0ZXh0Q29udGVudEl0ZW1zU3RyID0gdGhpcy50ZXh0Q29udGVudEl0ZW1zU3RyOwogICAgICB2YXIgaSA9IDAsCiAgICAgICAgICBpSW5kZXggPSAwOwogICAgICB2YXIgZW5kID0gdGV4dENvbnRlbnRJdGVtc1N0ci5sZW5ndGggLSAxOwogICAgICB2YXIgcXVlcnlMZW4gPSBmaW5kQ29udHJvbGxlci5zdGF0ZS5xdWVyeS5sZW5ndGg7CiAgICAgIHZhciByZXN1bHQgPSBbXTsKCiAgICAgIGZvciAodmFyIG0gPSAwLCBtbSA9IG1hdGNoZXMubGVuZ3RoOyBtIDwgbW07IG0rKykgewogICAgICAgIHZhciBtYXRjaElkeCA9IG1hdGNoZXNbbV07CgogICAgICAgIHdoaWxlIChpICE9PSBlbmQgJiYgbWF0Y2hJZHggPj0gaUluZGV4ICsgdGV4dENvbnRlbnRJdGVtc1N0cltpXS5sZW5ndGgpIHsKICAgICAgICAgIGlJbmRleCArPSB0ZXh0Q29udGVudEl0ZW1zU3RyW2ldLmxlbmd0aDsKICAgICAgICAgIGkrKzsKICAgICAgICB9CgogICAgICAgIGlmIChpID09PSB0ZXh0Q29udGVudEl0ZW1zU3RyLmxlbmd0aCkgewogICAgICAgICAgY29uc29sZS5lcnJvcigiQ291bGQgbm90IGZpbmQgYSBtYXRjaGluZyBtYXBwaW5nIik7CiAgICAgICAgfQoKICAgICAgICB2YXIgbWF0Y2ggPSB7CiAgICAgICAgICBiZWdpbjogewogICAgICAgICAgICBkaXZJZHg6IGksCiAgICAgICAgICAgIG9mZnNldDogbWF0Y2hJZHggLSBpSW5kZXgKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBpZiAobWF0Y2hlc0xlbmd0aCkgewogICAgICAgICAgbWF0Y2hJZHggKz0gbWF0Y2hlc0xlbmd0aFttXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWF0Y2hJZHggKz0gcXVlcnlMZW47CiAgICAgICAgfQoKICAgICAgICB3aGlsZSAoaSAhPT0gZW5kICYmIG1hdGNoSWR4ID4gaUluZGV4ICsgdGV4dENvbnRlbnRJdGVtc1N0cltpXS5sZW5ndGgpIHsKICAgICAgICAgIGlJbmRleCArPSB0ZXh0Q29udGVudEl0ZW1zU3RyW2ldLmxlbmd0aDsKICAgICAgICAgIGkrKzsKICAgICAgICB9CgogICAgICAgIG1hdGNoLmVuZCA9IHsKICAgICAgICAgIGRpdklkeDogaSwKICAgICAgICAgIG9mZnNldDogbWF0Y2hJZHggLSBpSW5kZXgKICAgICAgICB9OwogICAgICAgIHJlc3VsdC5wdXNoKG1hdGNoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfcmVuZGVyTWF0Y2hlcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3JlbmRlck1hdGNoZXMobWF0Y2hlcykgewogICAgICBpZiAobWF0Y2hlcy5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBmaW5kQ29udHJvbGxlciA9IHRoaXMuZmluZENvbnRyb2xsZXIsCiAgICAgICAgICBwYWdlSWR4ID0gdGhpcy5wYWdlSWR4LAogICAgICAgICAgdGV4dENvbnRlbnRJdGVtc1N0ciA9IHRoaXMudGV4dENvbnRlbnRJdGVtc1N0ciwKICAgICAgICAgIHRleHREaXZzID0gdGhpcy50ZXh0RGl2czsKICAgICAgdmFyIGlzU2VsZWN0ZWRQYWdlID0gcGFnZUlkeCA9PT0gZmluZENvbnRyb2xsZXIuc2VsZWN0ZWQucGFnZUlkeDsKICAgICAgdmFyIHNlbGVjdGVkTWF0Y2hJZHggPSBmaW5kQ29udHJvbGxlci5zZWxlY3RlZC5tYXRjaElkeDsKICAgICAgdmFyIGhpZ2hsaWdodEFsbCA9IGZpbmRDb250cm9sbGVyLnN0YXRlLmhpZ2hsaWdodEFsbDsKICAgICAgdmFyIHByZXZFbmQgPSBudWxsOwogICAgICB2YXIgaW5maW5pdHkgPSB7CiAgICAgICAgZGl2SWR4OiAtMSwKICAgICAgICBvZmZzZXQ6IHVuZGVmaW5lZAogICAgICB9OwoKICAgICAgZnVuY3Rpb24gYmVnaW5UZXh0KGJlZ2luLCBjbGFzc05hbWUpIHsKICAgICAgICB2YXIgZGl2SWR4ID0gYmVnaW4uZGl2SWR4OwogICAgICAgIHRleHREaXZzW2RpdklkeF0udGV4dENvbnRlbnQgPSAiIjsKICAgICAgICBhcHBlbmRUZXh0VG9EaXYoZGl2SWR4LCAwLCBiZWdpbi5vZmZzZXQsIGNsYXNzTmFtZSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGFwcGVuZFRleHRUb0RpdihkaXZJZHgsIGZyb21PZmZzZXQsIHRvT2Zmc2V0LCBjbGFzc05hbWUpIHsKICAgICAgICB2YXIgZGl2ID0gdGV4dERpdnNbZGl2SWR4XTsKICAgICAgICB2YXIgY29udGVudCA9IHRleHRDb250ZW50SXRlbXNTdHJbZGl2SWR4XS5zdWJzdHJpbmcoZnJvbU9mZnNldCwgdG9PZmZzZXQpOwogICAgICAgIHZhciBub2RlID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoY29udGVudCk7CgogICAgICAgIGlmIChjbGFzc05hbWUpIHsKICAgICAgICAgIHZhciBzcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOwogICAgICAgICAgc3Bhbi5jbGFzc05hbWUgPSBjbGFzc05hbWU7CiAgICAgICAgICBzcGFuLmFwcGVuZENoaWxkKG5vZGUpOwogICAgICAgICAgZGl2LmFwcGVuZENoaWxkKHNwYW4pOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZGl2LmFwcGVuZENoaWxkKG5vZGUpOwogICAgICB9CgogICAgICB2YXIgaTAgPSBzZWxlY3RlZE1hdGNoSWR4LAogICAgICAgICAgaTEgPSBpMCArIDE7CgogICAgICBpZiAoaGlnaGxpZ2h0QWxsKSB7CiAgICAgICAgaTAgPSAwOwogICAgICAgIGkxID0gbWF0Y2hlcy5sZW5ndGg7CiAgICAgIH0gZWxzZSBpZiAoIWlzU2VsZWN0ZWRQYWdlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBmb3IgKHZhciBpID0gaTA7IGkgPCBpMTsgaSsrKSB7CiAgICAgICAgdmFyIG1hdGNoID0gbWF0Y2hlc1tpXTsKICAgICAgICB2YXIgYmVnaW4gPSBtYXRjaC5iZWdpbjsKICAgICAgICB2YXIgZW5kID0gbWF0Y2guZW5kOwogICAgICAgIHZhciBpc1NlbGVjdGVkID0gaXNTZWxlY3RlZFBhZ2UgJiYgaSA9PT0gc2VsZWN0ZWRNYXRjaElkeDsKICAgICAgICB2YXIgaGlnaGxpZ2h0U3VmZml4ID0gaXNTZWxlY3RlZCA/ICIgc2VsZWN0ZWQiIDogIiI7CgogICAgICAgIGlmIChpc1NlbGVjdGVkKSB7CiAgICAgICAgICBmaW5kQ29udHJvbGxlci5zY3JvbGxNYXRjaEludG9WaWV3KHsKICAgICAgICAgICAgZWxlbWVudDogdGV4dERpdnNbYmVnaW4uZGl2SWR4XSwKICAgICAgICAgICAgcGFnZUluZGV4OiBwYWdlSWR4LAogICAgICAgICAgICBtYXRjaEluZGV4OiBzZWxlY3RlZE1hdGNoSWR4CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGlmICghcHJldkVuZCB8fCBiZWdpbi5kaXZJZHggIT09IHByZXZFbmQuZGl2SWR4KSB7CiAgICAgICAgICBpZiAocHJldkVuZCAhPT0gbnVsbCkgewogICAgICAgICAgICBhcHBlbmRUZXh0VG9EaXYocHJldkVuZC5kaXZJZHgsIHByZXZFbmQub2Zmc2V0LCBpbmZpbml0eS5vZmZzZXQpOwogICAgICAgICAgfQoKICAgICAgICAgIGJlZ2luVGV4dChiZWdpbik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFwcGVuZFRleHRUb0RpdihwcmV2RW5kLmRpdklkeCwgcHJldkVuZC5vZmZzZXQsIGJlZ2luLm9mZnNldCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoYmVnaW4uZGl2SWR4ID09PSBlbmQuZGl2SWR4KSB7CiAgICAgICAgICBhcHBlbmRUZXh0VG9EaXYoYmVnaW4uZGl2SWR4LCBiZWdpbi5vZmZzZXQsIGVuZC5vZmZzZXQsICJoaWdobGlnaHQiICsgaGlnaGxpZ2h0U3VmZml4KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYXBwZW5kVGV4dFRvRGl2KGJlZ2luLmRpdklkeCwgYmVnaW4ub2Zmc2V0LCBpbmZpbml0eS5vZmZzZXQsICJoaWdobGlnaHQgYmVnaW4iICsgaGlnaGxpZ2h0U3VmZml4KTsKCiAgICAgICAgICBmb3IgKHZhciBuMCA9IGJlZ2luLmRpdklkeCArIDEsIG4xID0gZW5kLmRpdklkeDsgbjAgPCBuMTsgbjArKykgewogICAgICAgICAgICB0ZXh0RGl2c1tuMF0uY2xhc3NOYW1lID0gImhpZ2hsaWdodCBtaWRkbGUiICsgaGlnaGxpZ2h0U3VmZml4OwogICAgICAgICAgfQoKICAgICAgICAgIGJlZ2luVGV4dChlbmQsICJoaWdobGlnaHQgZW5kIiArIGhpZ2hsaWdodFN1ZmZpeCk7CiAgICAgICAgfQoKICAgICAgICBwcmV2RW5kID0gZW5kOwogICAgICB9CgogICAgICBpZiAocHJldkVuZCkgewogICAgICAgIGFwcGVuZFRleHRUb0RpdihwcmV2RW5kLmRpdklkeCwgcHJldkVuZC5vZmZzZXQsIGluZmluaXR5Lm9mZnNldCk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJfdXBkYXRlTWF0Y2hlcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3VwZGF0ZU1hdGNoZXMoKSB7CiAgICAgIGlmICghdGhpcy5yZW5kZXJpbmdEb25lKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgZmluZENvbnRyb2xsZXIgPSB0aGlzLmZpbmRDb250cm9sbGVyLAogICAgICAgICAgbWF0Y2hlcyA9IHRoaXMubWF0Y2hlcywKICAgICAgICAgIHBhZ2VJZHggPSB0aGlzLnBhZ2VJZHgsCiAgICAgICAgICB0ZXh0Q29udGVudEl0ZW1zU3RyID0gdGhpcy50ZXh0Q29udGVudEl0ZW1zU3RyLAogICAgICAgICAgdGV4dERpdnMgPSB0aGlzLnRleHREaXZzOwogICAgICB2YXIgY2xlYXJlZFVudGlsRGl2SWR4ID0gLTE7CgogICAgICBmb3IgKHZhciBpID0gMCwgaWkgPSBtYXRjaGVzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICB2YXIgbWF0Y2ggPSBtYXRjaGVzW2ldOwogICAgICAgIHZhciBiZWdpbiA9IE1hdGgubWF4KGNsZWFyZWRVbnRpbERpdklkeCwgbWF0Y2guYmVnaW4uZGl2SWR4KTsKCiAgICAgICAgZm9yICh2YXIgbiA9IGJlZ2luLCBlbmQgPSBtYXRjaC5lbmQuZGl2SWR4OyBuIDw9IGVuZDsgbisrKSB7CiAgICAgICAgICB2YXIgZGl2ID0gdGV4dERpdnNbbl07CiAgICAgICAgICBkaXYudGV4dENvbnRlbnQgPSB0ZXh0Q29udGVudEl0ZW1zU3RyW25dOwogICAgICAgICAgZGl2LmNsYXNzTmFtZSA9ICIiOwogICAgICAgIH0KCiAgICAgICAgY2xlYXJlZFVudGlsRGl2SWR4ID0gbWF0Y2guZW5kLmRpdklkeCArIDE7CiAgICAgIH0KCiAgICAgIGlmICghZmluZENvbnRyb2xsZXIgfHwgIWZpbmRDb250cm9sbGVyLmhpZ2hsaWdodE1hdGNoZXMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBwYWdlTWF0Y2hlcyA9IGZpbmRDb250cm9sbGVyLnBhZ2VNYXRjaGVzW3BhZ2VJZHhdIHx8IG51bGw7CiAgICAgIHZhciBwYWdlTWF0Y2hlc0xlbmd0aCA9IGZpbmRDb250cm9sbGVyLnBhZ2VNYXRjaGVzTGVuZ3RoW3BhZ2VJZHhdIHx8IG51bGw7CiAgICAgIHRoaXMubWF0Y2hlcyA9IHRoaXMuX2NvbnZlcnRNYXRjaGVzKHBhZ2VNYXRjaGVzLCBwYWdlTWF0Y2hlc0xlbmd0aCk7CgogICAgICB0aGlzLl9yZW5kZXJNYXRjaGVzKHRoaXMubWF0Y2hlcyk7CiAgICB9CiAgfSwgewogICAga2V5OiAiX2JpbmRNb3VzZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2JpbmRNb3VzZSgpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICB2YXIgZGl2ID0gdGhpcy50ZXh0TGF5ZXJEaXY7CiAgICAgIHZhciBleHBhbmREaXZzVGltZXIgPSBudWxsOwogICAgICBkaXYuYWRkRXZlbnRMaXN0ZW5lcigibW91c2Vkb3duIiwgZnVuY3Rpb24gKGV2dCkgewogICAgICAgIGlmIChfdGhpczIuZW5oYW5jZVRleHRTZWxlY3Rpb24gJiYgX3RoaXMyLnRleHRMYXllclJlbmRlclRhc2spIHsKICAgICAgICAgIF90aGlzMi50ZXh0TGF5ZXJSZW5kZXJUYXNrLmV4cGFuZFRleHREaXZzKHRydWUpOwoKICAgICAgICAgIGlmIChleHBhbmREaXZzVGltZXIpIHsKICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGV4cGFuZERpdnNUaW1lcik7CiAgICAgICAgICAgIGV4cGFuZERpdnNUaW1lciA9IG51bGw7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGVuZCA9IGRpdi5xdWVyeVNlbGVjdG9yKCIuZW5kT2ZDb250ZW50Iik7CgogICAgICAgIGlmICghZW5kKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgYWRqdXN0VG9wID0gZXZ0LnRhcmdldCAhPT0gZGl2OwogICAgICAgIGFkanVzdFRvcCA9IGFkanVzdFRvcCAmJiB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbmQpLmdldFByb3BlcnR5VmFsdWUoIi1tb3otdXNlci1zZWxlY3QiKSAhPT0gIm5vbmUiOwoKICAgICAgICBpZiAoYWRqdXN0VG9wKSB7CiAgICAgICAgICB2YXIgZGl2Qm91bmRzID0gZGl2LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgICAgdmFyIHIgPSBNYXRoLm1heCgwLCAoZXZ0LnBhZ2VZIC0gZGl2Qm91bmRzLnRvcCkgLyBkaXZCb3VuZHMuaGVpZ2h0KTsKICAgICAgICAgIGVuZC5zdHlsZS50b3AgPSAociAqIDEwMCkudG9GaXhlZCgyKSArICIlIjsKICAgICAgICB9CgogICAgICAgIGVuZC5jbGFzc0xpc3QuYWRkKCJhY3RpdmUiKTsKICAgICAgfSk7CiAgICAgIGRpdi5hZGRFdmVudExpc3RlbmVyKCJtb3VzZXVwIiwgZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChfdGhpczIuZW5oYW5jZVRleHRTZWxlY3Rpb24gJiYgX3RoaXMyLnRleHRMYXllclJlbmRlclRhc2spIHsKICAgICAgICAgIGV4cGFuZERpdnNUaW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoX3RoaXMyLnRleHRMYXllclJlbmRlclRhc2spIHsKICAgICAgICAgICAgICBfdGhpczIudGV4dExheWVyUmVuZGVyVGFzay5leHBhbmRUZXh0RGl2cyhmYWxzZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGV4cGFuZERpdnNUaW1lciA9IG51bGw7CiAgICAgICAgICB9LCBFWFBBTkRfRElWU19USU1FT1VUKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBlbmQgPSBkaXYucXVlcnlTZWxlY3RvcigiLmVuZE9mQ29udGVudCIpOwoKICAgICAgICBpZiAoIWVuZCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZW5kLnN0eWxlLnRvcCA9ICIiOwogICAgICAgIGVuZC5jbGFzc0xpc3QucmVtb3ZlKCJhY3RpdmUiKTsKICAgICAgfSk7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gVGV4dExheWVyQnVpbGRlcjsKfSgpOwoKZXhwb3J0cy5UZXh0TGF5ZXJCdWlsZGVyID0gVGV4dExheWVyQnVpbGRlcjsKCnZhciBEZWZhdWx0VGV4dExheWVyRmFjdG9yeSA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gRGVmYXVsdFRleHRMYXllckZhY3RvcnkoKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgRGVmYXVsdFRleHRMYXllckZhY3RvcnkpOwogIH0KCiAgX2NyZWF0ZUNsYXNzKERlZmF1bHRUZXh0TGF5ZXJGYWN0b3J5LCBbewogICAga2V5OiAiY3JlYXRlVGV4dExheWVyQnVpbGRlciIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlVGV4dExheWVyQnVpbGRlcih0ZXh0TGF5ZXJEaXYsIHBhZ2VJbmRleCwgdmlld3BvcnQpIHsKICAgICAgdmFyIGVuaGFuY2VUZXh0U2VsZWN0aW9uID0gYXJndW1lbnRzLmxlbmd0aCA+IDMgJiYgYXJndW1lbnRzWzNdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbM10gOiBmYWxzZTsKICAgICAgdmFyIGV2ZW50QnVzID0gYXJndW1lbnRzLmxlbmd0aCA+IDQgPyBhcmd1bWVudHNbNF0gOiB1bmRlZmluZWQ7CiAgICAgIHJldHVybiBuZXcgVGV4dExheWVyQnVpbGRlcih7CiAgICAgICAgdGV4dExheWVyRGl2OiB0ZXh0TGF5ZXJEaXYsCiAgICAgICAgcGFnZUluZGV4OiBwYWdlSW5kZXgsCiAgICAgICAgdmlld3BvcnQ6IHZpZXdwb3J0LAogICAgICAgIGVuaGFuY2VUZXh0U2VsZWN0aW9uOiBlbmhhbmNlVGV4dFNlbGVjdGlvbiwKICAgICAgICBldmVudEJ1czogZXZlbnRCdXMKICAgICAgfSk7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gRGVmYXVsdFRleHRMYXllckZhY3Rvcnk7Cn0oKTsKCmV4cG9ydHMuRGVmYXVsdFRleHRMYXllckZhY3RvcnkgPSBEZWZhdWx0VGV4dExheWVyRmFjdG9yeTsKCi8qKiovIH0pLAovKiAzMiAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoidXNlIHN0cmljdCI7CgoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLlNlY29uZGFyeVRvb2xiYXIgPSB2b2lkIDA7Cgp2YXIgX3VpX3V0aWxzID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1KTsKCnZhciBfcGRmX2N1cnNvcl90b29scyA9IF9fd2VicGFja19yZXF1aXJlX18oOSk7Cgp2YXIgX3BkZl9zaW5nbGVfcGFnZV92aWV3ZXIgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMzKTsKCmZ1bmN0aW9uIF9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyKG8sIGFsbG93QXJyYXlMaWtlKSB7IHZhciBpdDsgaWYgKHR5cGVvZiBTeW1ib2wgPT09ICJ1bmRlZmluZWQiIHx8IG9bU3ltYm9sLml0ZXJhdG9yXSA9PSBudWxsKSB7IGlmIChBcnJheS5pc0FycmF5KG8pIHx8IChpdCA9IF91bnN1cHBvcnRlZEl0ZXJhYmxlVG9BcnJheShvKSkgfHwgYWxsb3dBcnJheUxpa2UgJiYgbyAmJiB0eXBlb2Ygby5sZW5ndGggPT09ICJudW1iZXIiKSB7IGlmIChpdCkgbyA9IGl0OyB2YXIgaSA9IDA7IHZhciBGID0gZnVuY3Rpb24gRigpIHt9OyByZXR1cm4geyBzOiBGLCBuOiBmdW5jdGlvbiBuKCkgeyBpZiAoaSA+PSBvLmxlbmd0aCkgcmV0dXJuIHsgZG9uZTogdHJ1ZSB9OyByZXR1cm4geyBkb25lOiBmYWxzZSwgdmFsdWU6IG9baSsrXSB9OyB9LCBlOiBmdW5jdGlvbiBlKF9lKSB7IHRocm93IF9lOyB9LCBmOiBGIH07IH0gdGhyb3cgbmV3IFR5cGVFcnJvcigiSW52YWxpZCBhdHRlbXB0IHRvIGl0ZXJhdGUgbm9uLWl0ZXJhYmxlIGluc3RhbmNlLlxuSW4gb3JkZXIgdG8gYmUgaXRlcmFibGUsIG5vbi1hcnJheSBvYmplY3RzIG11c3QgaGF2ZSBhIFtTeW1ib2wuaXRlcmF0b3JdKCkgbWV0aG9kLiIpOyB9IHZhciBub3JtYWxDb21wbGV0aW9uID0gdHJ1ZSwgZGlkRXJyID0gZmFsc2UsIGVycjsgcmV0dXJuIHsgczogZnVuY3Rpb24gcygpIHsgaXQgPSBvW1N5bWJvbC5pdGVyYXRvcl0oKTsgfSwgbjogZnVuY3Rpb24gbigpIHsgdmFyIHN0ZXAgPSBpdC5uZXh0KCk7IG5vcm1hbENvbXBsZXRpb24gPSBzdGVwLmRvbmU7IHJldHVybiBzdGVwOyB9LCBlOiBmdW5jdGlvbiBlKF9lMikgeyBkaWRFcnIgPSB0cnVlOyBlcnIgPSBfZTI7IH0sIGY6IGZ1bmN0aW9uIGYoKSB7IHRyeSB7IGlmICghbm9ybWFsQ29tcGxldGlvbiAmJiBpdFsicmV0dXJuIl0gIT0gbnVsbCkgaXRbInJldHVybiJdKCk7IH0gZmluYWxseSB7IGlmIChkaWRFcnIpIHRocm93IGVycjsgfSB9IH07IH0KCmZ1bmN0aW9uIF91bnN1cHBvcnRlZEl0ZXJhYmxlVG9BcnJheShvLCBtaW5MZW4pIHsgaWYgKCFvKSByZXR1cm47IGlmICh0eXBlb2YgbyA9PT0gInN0cmluZyIpIHJldHVybiBfYXJyYXlMaWtlVG9BcnJheShvLCBtaW5MZW4pOyB2YXIgbiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvKS5zbGljZSg4LCAtMSk7IGlmIChuID09PSAiT2JqZWN0IiAmJiBvLmNvbnN0cnVjdG9yKSBuID0gby5jb25zdHJ1Y3Rvci5uYW1lOyBpZiAobiA9PT0gIk1hcCIgfHwgbiA9PT0gIlNldCIpIHJldHVybiBBcnJheS5mcm9tKG8pOyBpZiAobiA9PT0gIkFyZ3VtZW50cyIgfHwgL14oPzpVaXxJKW50KD86OHwxNnwzMikoPzpDbGFtcGVkKT9BcnJheSQvLnRlc3QobikpIHJldHVybiBfYXJyYXlMaWtlVG9BcnJheShvLCBtaW5MZW4pOyB9CgpmdW5jdGlvbiBfYXJyYXlMaWtlVG9BcnJheShhcnIsIGxlbikgeyBpZiAobGVuID09IG51bGwgfHwgbGVuID4gYXJyLmxlbmd0aCkgbGVuID0gYXJyLmxlbmd0aDsgZm9yICh2YXIgaSA9IDAsIGFycjIgPSBuZXcgQXJyYXkobGVuKTsgaSA8IGxlbjsgaSsrKSB7IGFycjJbaV0gPSBhcnJbaV07IH0gcmV0dXJuIGFycjI7IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7IH0gfQoKZnVuY3Rpb24gX2RlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoInZhbHVlIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0KCmZ1bmN0aW9uIF9jcmVhdGVDbGFzcyhDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9Cgp2YXIgU2Vjb25kYXJ5VG9vbGJhciA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gU2Vjb25kYXJ5VG9vbGJhcihvcHRpb25zLCBtYWluQ29udGFpbmVyLCBldmVudEJ1cykgewogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgU2Vjb25kYXJ5VG9vbGJhcik7CgogICAgdGhpcy50b29sYmFyID0gb3B0aW9ucy50b29sYmFyOwogICAgdGhpcy50b2dnbGVCdXR0b24gPSBvcHRpb25zLnRvZ2dsZUJ1dHRvbjsKICAgIHRoaXMudG9vbGJhckJ1dHRvbkNvbnRhaW5lciA9IG9wdGlvbnMudG9vbGJhckJ1dHRvbkNvbnRhaW5lcjsKICAgIHRoaXMuYnV0dG9ucyA9IFt7CiAgICAgIGVsZW1lbnQ6IG9wdGlvbnMucHJlc2VudGF0aW9uTW9kZUJ1dHRvbiwKICAgICAgZXZlbnROYW1lOiAicHJlc2VudGF0aW9ubW9kZSIsCiAgICAgIGNsb3NlOiB0cnVlCiAgICB9LCB7CiAgICAgIGVsZW1lbnQ6IG9wdGlvbnMub3BlbkZpbGVCdXR0b24sCiAgICAgIGV2ZW50TmFtZTogIm9wZW5maWxlIiwKICAgICAgY2xvc2U6IHRydWUKICAgIH0sIHsKICAgICAgZWxlbWVudDogb3B0aW9ucy5wcmludEJ1dHRvbiwKICAgICAgZXZlbnROYW1lOiAicHJpbnQiLAogICAgICBjbG9zZTogdHJ1ZQogICAgfSwgewogICAgICBlbGVtZW50OiBvcHRpb25zLmRvd25sb2FkQnV0dG9uLAogICAgICBldmVudE5hbWU6ICJkb3dubG9hZCIsCiAgICAgIGNsb3NlOiB0cnVlCiAgICB9LCB7CiAgICAgIGVsZW1lbnQ6IG9wdGlvbnMudmlld0Jvb2ttYXJrQnV0dG9uLAogICAgICBldmVudE5hbWU6IG51bGwsCiAgICAgIGNsb3NlOiB0cnVlCiAgICB9LCB7CiAgICAgIGVsZW1lbnQ6IG9wdGlvbnMuZmlyc3RQYWdlQnV0dG9uLAogICAgICBldmVudE5hbWU6ICJmaXJzdHBhZ2UiLAogICAgICBjbG9zZTogdHJ1ZQogICAgfSwgewogICAgICBlbGVtZW50OiBvcHRpb25zLmxhc3RQYWdlQnV0dG9uLAogICAgICBldmVudE5hbWU6ICJsYXN0cGFnZSIsCiAgICAgIGNsb3NlOiB0cnVlCiAgICB9LCB7CiAgICAgIGVsZW1lbnQ6IG9wdGlvbnMucGFnZVJvdGF0ZUN3QnV0dG9uLAogICAgICBldmVudE5hbWU6ICJyb3RhdGVjdyIsCiAgICAgIGNsb3NlOiBmYWxzZQogICAgfSwgewogICAgICBlbGVtZW50OiBvcHRpb25zLnBhZ2VSb3RhdGVDY3dCdXR0b24sCiAgICAgIGV2ZW50TmFtZTogInJvdGF0ZWNjdyIsCiAgICAgIGNsb3NlOiBmYWxzZQogICAgfSwgewogICAgICBlbGVtZW50OiBvcHRpb25zLmN1cnNvclNlbGVjdFRvb2xCdXR0b24sCiAgICAgIGV2ZW50TmFtZTogInN3aXRjaGN1cnNvcnRvb2wiLAogICAgICBldmVudERldGFpbHM6IHsKICAgICAgICB0b29sOiBfcGRmX2N1cnNvcl90b29scy5DdXJzb3JUb29sLlNFTEVDVAogICAgICB9LAogICAgICBjbG9zZTogdHJ1ZQogICAgfSwgewogICAgICBlbGVtZW50OiBvcHRpb25zLmN1cnNvckhhbmRUb29sQnV0dG9uLAogICAgICBldmVudE5hbWU6ICJzd2l0Y2hjdXJzb3J0b29sIiwKICAgICAgZXZlbnREZXRhaWxzOiB7CiAgICAgICAgdG9vbDogX3BkZl9jdXJzb3JfdG9vbHMuQ3Vyc29yVG9vbC5IQU5ECiAgICAgIH0sCiAgICAgIGNsb3NlOiB0cnVlCiAgICB9LCB7CiAgICAgIGVsZW1lbnQ6IG9wdGlvbnMuc2Nyb2xsVmVydGljYWxCdXR0b24sCiAgICAgIGV2ZW50TmFtZTogInN3aXRjaHNjcm9sbG1vZGUiLAogICAgICBldmVudERldGFpbHM6IHsKICAgICAgICBtb2RlOiBfdWlfdXRpbHMuU2Nyb2xsTW9kZS5WRVJUSUNBTAogICAgICB9LAogICAgICBjbG9zZTogdHJ1ZQogICAgfSwgewogICAgICBlbGVtZW50OiBvcHRpb25zLnNjcm9sbEhvcml6b250YWxCdXR0b24sCiAgICAgIGV2ZW50TmFtZTogInN3aXRjaHNjcm9sbG1vZGUiLAogICAgICBldmVudERldGFpbHM6IHsKICAgICAgICBtb2RlOiBfdWlfdXRpbHMuU2Nyb2xsTW9kZS5IT1JJWk9OVEFMCiAgICAgIH0sCiAgICAgIGNsb3NlOiB0cnVlCiAgICB9LCB7CiAgICAgIGVsZW1lbnQ6IG9wdGlvbnMuc2Nyb2xsV3JhcHBlZEJ1dHRvbiwKICAgICAgZXZlbnROYW1lOiAic3dpdGNoc2Nyb2xsbW9kZSIsCiAgICAgIGV2ZW50RGV0YWlsczogewogICAgICAgIG1vZGU6IF91aV91dGlscy5TY3JvbGxNb2RlLldSQVBQRUQKICAgICAgfSwKICAgICAgY2xvc2U6IHRydWUKICAgIH0sIHsKICAgICAgZWxlbWVudDogb3B0aW9ucy5zcHJlYWROb25lQnV0dG9uLAogICAgICBldmVudE5hbWU6ICJzd2l0Y2hzcHJlYWRtb2RlIiwKICAgICAgZXZlbnREZXRhaWxzOiB7CiAgICAgICAgbW9kZTogX3VpX3V0aWxzLlNwcmVhZE1vZGUuTk9ORQogICAgICB9LAogICAgICBjbG9zZTogdHJ1ZQogICAgfSwgewogICAgICBlbGVtZW50OiBvcHRpb25zLnNwcmVhZE9kZEJ1dHRvbiwKICAgICAgZXZlbnROYW1lOiAic3dpdGNoc3ByZWFkbW9kZSIsCiAgICAgIGV2ZW50RGV0YWlsczogewogICAgICAgIG1vZGU6IF91aV91dGlscy5TcHJlYWRNb2RlLk9ERAogICAgICB9LAogICAgICBjbG9zZTogdHJ1ZQogICAgfSwgewogICAgICBlbGVtZW50OiBvcHRpb25zLnNwcmVhZEV2ZW5CdXR0b24sCiAgICAgIGV2ZW50TmFtZTogInN3aXRjaHNwcmVhZG1vZGUiLAogICAgICBldmVudERldGFpbHM6IHsKICAgICAgICBtb2RlOiBfdWlfdXRpbHMuU3ByZWFkTW9kZS5FVkVOCiAgICAgIH0sCiAgICAgIGNsb3NlOiB0cnVlCiAgICB9LCB7CiAgICAgIGVsZW1lbnQ6IG9wdGlvbnMuZG9jdW1lbnRQcm9wZXJ0aWVzQnV0dG9uLAogICAgICBldmVudE5hbWU6ICJkb2N1bWVudHByb3BlcnRpZXMiLAogICAgICBjbG9zZTogdHJ1ZQogICAgfV07CiAgICB0aGlzLml0ZW1zID0gewogICAgICBmaXJzdFBhZ2U6IG9wdGlvbnMuZmlyc3RQYWdlQnV0dG9uLAogICAgICBsYXN0UGFnZTogb3B0aW9ucy5sYXN0UGFnZUJ1dHRvbiwKICAgICAgcGFnZVJvdGF0ZUN3OiBvcHRpb25zLnBhZ2VSb3RhdGVDd0J1dHRvbiwKICAgICAgcGFnZVJvdGF0ZUNjdzogb3B0aW9ucy5wYWdlUm90YXRlQ2N3QnV0dG9uCiAgICB9OwogICAgdGhpcy5tYWluQ29udGFpbmVyID0gbWFpbkNvbnRhaW5lcjsKICAgIHRoaXMuZXZlbnRCdXMgPSBldmVudEJ1czsKICAgIHRoaXMub3BlbmVkID0gZmFsc2U7CiAgICB0aGlzLmNvbnRhaW5lckhlaWdodCA9IG51bGw7CiAgICB0aGlzLnByZXZpb3VzQ29udGFpbmVySGVpZ2h0ID0gbnVsbDsKICAgIHRoaXMucmVzZXQoKTsKCiAgICB0aGlzLl9iaW5kQ2xpY2tMaXN0ZW5lcnMoKTsKCiAgICB0aGlzLl9iaW5kQ3Vyc29yVG9vbHNMaXN0ZW5lcihvcHRpb25zKTsKCiAgICB0aGlzLl9iaW5kU2Nyb2xsTW9kZUxpc3RlbmVyKG9wdGlvbnMpOwoKICAgIHRoaXMuX2JpbmRTcHJlYWRNb2RlTGlzdGVuZXIob3B0aW9ucyk7CgogICAgdGhpcy5ldmVudEJ1cy5fb24oInJlc2l6ZSIsIHRoaXMuX3NldE1heEhlaWdodC5iaW5kKHRoaXMpKTsKCiAgICB0aGlzLmV2ZW50QnVzLl9vbigiYmFzZXZpZXdlcmluaXQiLCBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgIGlmIChldnQuc291cmNlIGluc3RhbmNlb2YgX3BkZl9zaW5nbGVfcGFnZV92aWV3ZXIuUERGU2luZ2xlUGFnZVZpZXdlcikgewogICAgICAgIF90aGlzLnRvb2xiYXJCdXR0b25Db250YWluZXIuY2xhc3NMaXN0LmFkZCgiaGlkZGVuU2Nyb2xsTW9kZUJ1dHRvbnMiLCAiaGlkZGVuU3ByZWFkTW9kZUJ1dHRvbnMiKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBfdGhpcy50b29sYmFyQnV0dG9uQ29udGFpbmVyLmNsYXNzTGlzdC5yZW1vdmUoImhpZGRlblNjcm9sbE1vZGVCdXR0b25zIiwgImhpZGRlblNwcmVhZE1vZGVCdXR0b25zIik7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgX2NyZWF0ZUNsYXNzKFNlY29uZGFyeVRvb2xiYXIsIFt7CiAgICBrZXk6ICJzZXRQYWdlTnVtYmVyIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRQYWdlTnVtYmVyKHBhZ2VOdW1iZXIpIHsKICAgICAgdGhpcy5wYWdlTnVtYmVyID0gcGFnZU51bWJlcjsKCiAgICAgIHRoaXMuX3VwZGF0ZVVJU3RhdGUoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJzZXRQYWdlc0NvdW50IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRQYWdlc0NvdW50KHBhZ2VzQ291bnQpIHsKICAgICAgdGhpcy5wYWdlc0NvdW50ID0gcGFnZXNDb3VudDsKCiAgICAgIHRoaXMuX3VwZGF0ZVVJU3RhdGUoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJyZXNldCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVzZXQoKSB7CiAgICAgIHRoaXMucGFnZU51bWJlciA9IDA7CiAgICAgIHRoaXMucGFnZXNDb3VudCA9IDA7CgogICAgICB0aGlzLl91cGRhdGVVSVN0YXRlKCk7CgogICAgICB0aGlzLmV2ZW50QnVzLmRpc3BhdGNoKCJzZWNvbmRhcnl0b29sYmFycmVzZXQiLCB7CiAgICAgICAgc291cmNlOiB0aGlzCiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogIl91cGRhdGVVSVN0YXRlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfdXBkYXRlVUlTdGF0ZSgpIHsKICAgICAgdGhpcy5pdGVtcy5maXJzdFBhZ2UuZGlzYWJsZWQgPSB0aGlzLnBhZ2VOdW1iZXIgPD0gMTsKICAgICAgdGhpcy5pdGVtcy5sYXN0UGFnZS5kaXNhYmxlZCA9IHRoaXMucGFnZU51bWJlciA+PSB0aGlzLnBhZ2VzQ291bnQ7CiAgICAgIHRoaXMuaXRlbXMucGFnZVJvdGF0ZUN3LmRpc2FibGVkID0gdGhpcy5wYWdlc0NvdW50ID09PSAwOwogICAgICB0aGlzLml0ZW1zLnBhZ2VSb3RhdGVDY3cuZGlzYWJsZWQgPSB0aGlzLnBhZ2VzQ291bnQgPT09IDA7CiAgICB9CiAgfSwgewogICAga2V5OiAiX2JpbmRDbGlja0xpc3RlbmVycyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2JpbmRDbGlja0xpc3RlbmVycygpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICB0aGlzLnRvZ2dsZUJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIHRoaXMudG9nZ2xlLmJpbmQodGhpcykpOwoKICAgICAgdmFyIF9pdGVyYXRvciA9IF9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyKHRoaXMuYnV0dG9ucyksCiAgICAgICAgICBfc3RlcDsKCiAgICAgIHRyeSB7CiAgICAgICAgdmFyIF9sb29wID0gZnVuY3Rpb24gX2xvb3AoKSB7CiAgICAgICAgICB2YXIgX3N0ZXAkdmFsdWUgPSBfc3RlcC52YWx1ZSwKICAgICAgICAgICAgICBlbGVtZW50ID0gX3N0ZXAkdmFsdWUuZWxlbWVudCwKICAgICAgICAgICAgICBldmVudE5hbWUgPSBfc3RlcCR2YWx1ZS5ldmVudE5hbWUsCiAgICAgICAgICAgICAgY2xvc2UgPSBfc3RlcCR2YWx1ZS5jbG9zZSwKICAgICAgICAgICAgICBldmVudERldGFpbHMgPSBfc3RlcCR2YWx1ZS5ldmVudERldGFpbHM7CiAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgZnVuY3Rpb24gKGV2dCkgewogICAgICAgICAgICBpZiAoZXZlbnROYW1lICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGRldGFpbHMgPSB7CiAgICAgICAgICAgICAgICBzb3VyY2U6IF90aGlzMgogICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgIGZvciAodmFyIHByb3BlcnR5IGluIGV2ZW50RGV0YWlscykgewogICAgICAgICAgICAgICAgZGV0YWlsc1twcm9wZXJ0eV0gPSBldmVudERldGFpbHNbcHJvcGVydHldOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgX3RoaXMyLmV2ZW50QnVzLmRpc3BhdGNoKGV2ZW50TmFtZSwgZGV0YWlscyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjbG9zZSkgewogICAgICAgICAgICAgIF90aGlzMi5jbG9zZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBmb3IgKF9pdGVyYXRvci5zKCk7ICEoX3N0ZXAgPSBfaXRlcmF0b3IubigpKS5kb25lOykgewogICAgICAgICAgX2xvb3AoKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIF9pdGVyYXRvci5lKGVycik7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgX2l0ZXJhdG9yLmYoKTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogIl9iaW5kQ3Vyc29yVG9vbHNMaXN0ZW5lciIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2JpbmRDdXJzb3JUb29sc0xpc3RlbmVyKGJ1dHRvbnMpIHsKICAgICAgdGhpcy5ldmVudEJ1cy5fb24oImN1cnNvcnRvb2xjaGFuZ2VkIiwgZnVuY3Rpb24gKF9yZWYpIHsKICAgICAgICB2YXIgdG9vbCA9IF9yZWYudG9vbDsKICAgICAgICBidXR0b25zLmN1cnNvclNlbGVjdFRvb2xCdXR0b24uY2xhc3NMaXN0LnRvZ2dsZSgidG9nZ2xlZCIsIHRvb2wgPT09IF9wZGZfY3Vyc29yX3Rvb2xzLkN1cnNvclRvb2wuU0VMRUNUKTsKICAgICAgICBidXR0b25zLmN1cnNvckhhbmRUb29sQnV0dG9uLmNsYXNzTGlzdC50b2dnbGUoInRvZ2dsZWQiLCB0b29sID09PSBfcGRmX2N1cnNvcl90b29scy5DdXJzb3JUb29sLkhBTkQpOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfYmluZFNjcm9sbE1vZGVMaXN0ZW5lciIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2JpbmRTY3JvbGxNb2RlTGlzdGVuZXIoYnV0dG9ucykgewogICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgIGZ1bmN0aW9uIHNjcm9sbE1vZGVDaGFuZ2VkKF9yZWYyKSB7CiAgICAgICAgdmFyIG1vZGUgPSBfcmVmMi5tb2RlOwogICAgICAgIGJ1dHRvbnMuc2Nyb2xsVmVydGljYWxCdXR0b24uY2xhc3NMaXN0LnRvZ2dsZSgidG9nZ2xlZCIsIG1vZGUgPT09IF91aV91dGlscy5TY3JvbGxNb2RlLlZFUlRJQ0FMKTsKICAgICAgICBidXR0b25zLnNjcm9sbEhvcml6b250YWxCdXR0b24uY2xhc3NMaXN0LnRvZ2dsZSgidG9nZ2xlZCIsIG1vZGUgPT09IF91aV91dGlscy5TY3JvbGxNb2RlLkhPUklaT05UQUwpOwogICAgICAgIGJ1dHRvbnMuc2Nyb2xsV3JhcHBlZEJ1dHRvbi5jbGFzc0xpc3QudG9nZ2xlKCJ0b2dnbGVkIiwgbW9kZSA9PT0gX3VpX3V0aWxzLlNjcm9sbE1vZGUuV1JBUFBFRCk7CiAgICAgICAgdmFyIGlzU2Nyb2xsTW9kZUhvcml6b250YWwgPSBtb2RlID09PSBfdWlfdXRpbHMuU2Nyb2xsTW9kZS5IT1JJWk9OVEFMOwogICAgICAgIGJ1dHRvbnMuc3ByZWFkTm9uZUJ1dHRvbi5kaXNhYmxlZCA9IGlzU2Nyb2xsTW9kZUhvcml6b250YWw7CiAgICAgICAgYnV0dG9ucy5zcHJlYWRPZGRCdXR0b24uZGlzYWJsZWQgPSBpc1Njcm9sbE1vZGVIb3Jpem9udGFsOwogICAgICAgIGJ1dHRvbnMuc3ByZWFkRXZlbkJ1dHRvbi5kaXNhYmxlZCA9IGlzU2Nyb2xsTW9kZUhvcml6b250YWw7CiAgICAgIH0KCiAgICAgIHRoaXMuZXZlbnRCdXMuX29uKCJzY3JvbGxtb2RlY2hhbmdlZCIsIHNjcm9sbE1vZGVDaGFuZ2VkKTsKCiAgICAgIHRoaXMuZXZlbnRCdXMuX29uKCJzZWNvbmRhcnl0b29sYmFycmVzZXQiLCBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgICAgaWYgKGV2dC5zb3VyY2UgPT09IF90aGlzMykgewogICAgICAgICAgc2Nyb2xsTW9kZUNoYW5nZWQoewogICAgICAgICAgICBtb2RlOiBfdWlfdXRpbHMuU2Nyb2xsTW9kZS5WRVJUSUNBTAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfYmluZFNwcmVhZE1vZGVMaXN0ZW5lciIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2JpbmRTcHJlYWRNb2RlTGlzdGVuZXIoYnV0dG9ucykgewogICAgICB2YXIgX3RoaXM0ID0gdGhpczsKCiAgICAgIGZ1bmN0aW9uIHNwcmVhZE1vZGVDaGFuZ2VkKF9yZWYzKSB7CiAgICAgICAgdmFyIG1vZGUgPSBfcmVmMy5tb2RlOwogICAgICAgIGJ1dHRvbnMuc3ByZWFkTm9uZUJ1dHRvbi5jbGFzc0xpc3QudG9nZ2xlKCJ0b2dnbGVkIiwgbW9kZSA9PT0gX3VpX3V0aWxzLlNwcmVhZE1vZGUuTk9ORSk7CiAgICAgICAgYnV0dG9ucy5zcHJlYWRPZGRCdXR0b24uY2xhc3NMaXN0LnRvZ2dsZSgidG9nZ2xlZCIsIG1vZGUgPT09IF91aV91dGlscy5TcHJlYWRNb2RlLk9ERCk7CiAgICAgICAgYnV0dG9ucy5zcHJlYWRFdmVuQnV0dG9uLmNsYXNzTGlzdC50b2dnbGUoInRvZ2dsZWQiLCBtb2RlID09PSBfdWlfdXRpbHMuU3ByZWFkTW9kZS5FVkVOKTsKICAgICAgfQoKICAgICAgdGhpcy5ldmVudEJ1cy5fb24oInNwcmVhZG1vZGVjaGFuZ2VkIiwgc3ByZWFkTW9kZUNoYW5nZWQpOwoKICAgICAgdGhpcy5ldmVudEJ1cy5fb24oInNlY29uZGFyeXRvb2xiYXJyZXNldCIsIGZ1bmN0aW9uIChldnQpIHsKICAgICAgICBpZiAoZXZ0LnNvdXJjZSA9PT0gX3RoaXM0KSB7CiAgICAgICAgICBzcHJlYWRNb2RlQ2hhbmdlZCh7CiAgICAgICAgICAgIG1vZGU6IF91aV91dGlscy5TcHJlYWRNb2RlLk5PTkUKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAib3BlbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gb3BlbigpIHsKICAgICAgaWYgKHRoaXMub3BlbmVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLm9wZW5lZCA9IHRydWU7CgogICAgICB0aGlzLl9zZXRNYXhIZWlnaHQoKTsKCiAgICAgIHRoaXMudG9nZ2xlQnV0dG9uLmNsYXNzTGlzdC5hZGQoInRvZ2dsZWQiKTsKICAgICAgdGhpcy50b29sYmFyLmNsYXNzTGlzdC5yZW1vdmUoImhpZGRlbiIpOwogICAgfQogIH0sIHsKICAgIGtleTogImNsb3NlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjbG9zZSgpIHsKICAgICAgaWYgKCF0aGlzLm9wZW5lZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5vcGVuZWQgPSBmYWxzZTsKICAgICAgdGhpcy50b29sYmFyLmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOwogICAgICB0aGlzLnRvZ2dsZUJ1dHRvbi5jbGFzc0xpc3QucmVtb3ZlKCJ0b2dnbGVkIik7CiAgICB9CiAgfSwgewogICAga2V5OiAidG9nZ2xlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB0b2dnbGUoKSB7CiAgICAgIGlmICh0aGlzLm9wZW5lZCkgewogICAgICAgIHRoaXMuY2xvc2UoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wZW4oKTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogIl9zZXRNYXhIZWlnaHQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9zZXRNYXhIZWlnaHQoKSB7CiAgICAgIGlmICghdGhpcy5vcGVuZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMuY29udGFpbmVySGVpZ2h0ID0gdGhpcy5tYWluQ29udGFpbmVyLmNsaWVudEhlaWdodDsKCiAgICAgIGlmICh0aGlzLmNvbnRhaW5lckhlaWdodCA9PT0gdGhpcy5wcmV2aW91c0NvbnRhaW5lckhlaWdodCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy50b29sYmFyQnV0dG9uQ29udGFpbmVyLnN0eWxlLm1heEhlaWdodCA9ICIiLmNvbmNhdCh0aGlzLmNvbnRhaW5lckhlaWdodCAtIF91aV91dGlscy5TQ1JPTExCQVJfUEFERElORywgInB4Iik7CiAgICAgIHRoaXMucHJldmlvdXNDb250YWluZXJIZWlnaHQgPSB0aGlzLmNvbnRhaW5lckhlaWdodDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJpc09wZW4iLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLm9wZW5lZDsKICAgIH0KICB9XSk7CgogIHJldHVybiBTZWNvbmRhcnlUb29sYmFyOwp9KCk7CgpleHBvcnRzLlNlY29uZGFyeVRvb2xiYXIgPSBTZWNvbmRhcnlUb29sYmFyOwoKLyoqKi8gfSksCi8qIDMzICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuUERGU2luZ2xlUGFnZVZpZXdlciA9IHZvaWQgMDsKCnZhciBfYmFzZV92aWV3ZXIgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDI4KTsKCnZhciBfcGRmanNMaWIgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDgpOwoKZnVuY3Rpb24gX3R5cGVvZihvYmopIHsgIkBiYWJlbC9oZWxwZXJzIC0gdHlwZW9mIjsgaWYgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIFN5bWJvbC5pdGVyYXRvciA9PT0gInN5bWJvbCIpIHsgX3R5cGVvZiA9IGZ1bmN0aW9uIF90eXBlb2Yob2JqKSB7IHJldHVybiB0eXBlb2Ygb2JqOyB9OyB9IGVsc2UgeyBfdHlwZW9mID0gZnVuY3Rpb24gX3R5cGVvZihvYmopIHsgcmV0dXJuIG9iaiAmJiB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIG9iai5jb25zdHJ1Y3RvciA9PT0gU3ltYm9sICYmIG9iaiAhPT0gU3ltYm9sLnByb3RvdHlwZSA/ICJzeW1ib2wiIDogdHlwZW9mIG9iajsgfTsgfSByZXR1cm4gX3R5cGVvZihvYmopOyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOyB9IH0KCmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9CgpmdW5jdGlvbiBfY3JlYXRlQ2xhc3MoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfQoKZnVuY3Rpb24gX2dldCh0YXJnZXQsIHByb3BlcnR5LCByZWNlaXZlcikgeyBpZiAodHlwZW9mIFJlZmxlY3QgIT09ICJ1bmRlZmluZWQiICYmIFJlZmxlY3QuZ2V0KSB7IF9nZXQgPSBSZWZsZWN0LmdldDsgfSBlbHNlIHsgX2dldCA9IGZ1bmN0aW9uIF9nZXQodGFyZ2V0LCBwcm9wZXJ0eSwgcmVjZWl2ZXIpIHsgdmFyIGJhc2UgPSBfc3VwZXJQcm9wQmFzZSh0YXJnZXQsIHByb3BlcnR5KTsgaWYgKCFiYXNlKSByZXR1cm47IHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihiYXNlLCBwcm9wZXJ0eSk7IGlmIChkZXNjLmdldCkgeyByZXR1cm4gZGVzYy5nZXQuY2FsbChyZWNlaXZlcik7IH0gcmV0dXJuIGRlc2MudmFsdWU7IH07IH0gcmV0dXJuIF9nZXQodGFyZ2V0LCBwcm9wZXJ0eSwgcmVjZWl2ZXIgfHwgdGFyZ2V0KTsgfQoKZnVuY3Rpb24gX3N1cGVyUHJvcEJhc2Uob2JqZWN0LCBwcm9wZXJ0eSkgeyB3aGlsZSAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIHByb3BlcnR5KSkgeyBvYmplY3QgPSBfZ2V0UHJvdG90eXBlT2Yob2JqZWN0KTsgaWYgKG9iamVjdCA9PT0gbnVsbCkgYnJlYWs7IH0gcmV0dXJuIG9iamVjdDsgfQoKZnVuY3Rpb24gX2luaGVyaXRzKHN1YkNsYXNzLCBzdXBlckNsYXNzKSB7IGlmICh0eXBlb2Ygc3VwZXJDbGFzcyAhPT0gImZ1bmN0aW9uIiAmJiBzdXBlckNsYXNzICE9PSBudWxsKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIlN1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uIik7IH0gc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzICYmIHN1cGVyQ2xhc3MucHJvdG90eXBlLCB7IGNvbnN0cnVjdG9yOiB7IHZhbHVlOiBzdWJDbGFzcywgd3JpdGFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9IH0pOyBpZiAoc3VwZXJDbGFzcykgX3NldFByb3RvdHlwZU9mKHN1YkNsYXNzLCBzdXBlckNsYXNzKTsgfQoKZnVuY3Rpb24gX3NldFByb3RvdHlwZU9mKG8sIHApIHsgX3NldFByb3RvdHlwZU9mID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8IGZ1bmN0aW9uIF9zZXRQcm90b3R5cGVPZihvLCBwKSB7IG8uX19wcm90b19fID0gcDsgcmV0dXJuIG87IH07IHJldHVybiBfc2V0UHJvdG90eXBlT2YobywgcCk7IH0KCmZ1bmN0aW9uIF9jcmVhdGVTdXBlcihEZXJpdmVkKSB7IHZhciBoYXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0ID0gX2lzTmF0aXZlUmVmbGVjdENvbnN0cnVjdCgpOyByZXR1cm4gZnVuY3Rpb24gX2NyZWF0ZVN1cGVySW50ZXJuYWwoKSB7IHZhciBTdXBlciA9IF9nZXRQcm90b3R5cGVPZihEZXJpdmVkKSwgcmVzdWx0OyBpZiAoaGFzTmF0aXZlUmVmbGVjdENvbnN0cnVjdCkgeyB2YXIgTmV3VGFyZ2V0ID0gX2dldFByb3RvdHlwZU9mKHRoaXMpLmNvbnN0cnVjdG9yOyByZXN1bHQgPSBSZWZsZWN0LmNvbnN0cnVjdChTdXBlciwgYXJndW1lbnRzLCBOZXdUYXJnZXQpOyB9IGVsc2UgeyByZXN1bHQgPSBTdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyB9IHJldHVybiBfcG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCByZXN1bHQpOyB9OyB9CgpmdW5jdGlvbiBfcG9zc2libGVDb25zdHJ1Y3RvclJldHVybihzZWxmLCBjYWxsKSB7IGlmIChjYWxsICYmIChfdHlwZW9mKGNhbGwpID09PSAib2JqZWN0IiB8fCB0eXBlb2YgY2FsbCA9PT0gImZ1bmN0aW9uIikpIHsgcmV0dXJuIGNhbGw7IH0gcmV0dXJuIF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoc2VsZik7IH0KCmZ1bmN0aW9uIF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoc2VsZikgeyBpZiAoc2VsZiA9PT0gdm9pZCAwKSB7IHRocm93IG5ldyBSZWZlcmVuY2VFcnJvcigidGhpcyBoYXNuJ3QgYmVlbiBpbml0aWFsaXNlZCAtIHN1cGVyKCkgaGFzbid0IGJlZW4gY2FsbGVkIik7IH0gcmV0dXJuIHNlbGY7IH0KCmZ1bmN0aW9uIF9pc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QoKSB7IGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gInVuZGVmaW5lZCIgfHwgIVJlZmxlY3QuY29uc3RydWN0KSByZXR1cm4gZmFsc2U7IGlmIChSZWZsZWN0LmNvbnN0cnVjdC5zaGFtKSByZXR1cm4gZmFsc2U7IGlmICh0eXBlb2YgUHJveHkgPT09ICJmdW5jdGlvbiIpIHJldHVybiB0cnVlOyB0cnkgeyBEYXRlLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKFJlZmxlY3QuY29uc3RydWN0KERhdGUsIFtdLCBmdW5jdGlvbiAoKSB7fSkpOyByZXR1cm4gdHJ1ZTsgfSBjYXRjaCAoZSkgeyByZXR1cm4gZmFsc2U7IH0gfQoKZnVuY3Rpb24gX2dldFByb3RvdHlwZU9mKG8pIHsgX2dldFByb3RvdHlwZU9mID0gT2JqZWN0LnNldFByb3RvdHlwZU9mID8gT2JqZWN0LmdldFByb3RvdHlwZU9mIDogZnVuY3Rpb24gX2dldFByb3RvdHlwZU9mKG8pIHsgcmV0dXJuIG8uX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihvKTsgfTsgcmV0dXJuIF9nZXRQcm90b3R5cGVPZihvKTsgfQoKdmFyIFBERlNpbmdsZVBhZ2VWaWV3ZXIgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKF9CYXNlVmlld2VyKSB7CiAgX2luaGVyaXRzKFBERlNpbmdsZVBhZ2VWaWV3ZXIsIF9CYXNlVmlld2VyKTsKCiAgdmFyIF9zdXBlciA9IF9jcmVhdGVTdXBlcihQREZTaW5nbGVQYWdlVmlld2VyKTsKCiAgZnVuY3Rpb24gUERGU2luZ2xlUGFnZVZpZXdlcihvcHRpb25zKSB7CiAgICB2YXIgX3RoaXM7CgogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFBERlNpbmdsZVBhZ2VWaWV3ZXIpOwoKICAgIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcywgb3B0aW9ucyk7CgogICAgX3RoaXMuZXZlbnRCdXMuX29uKCJwYWdlc2luaXQiLCBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgIF90aGlzLl9lbnN1cmVQYWdlVmlld1Zpc2libGUoKTsKICAgIH0pOwoKICAgIHJldHVybiBfdGhpczsKICB9CgogIF9jcmVhdGVDbGFzcyhQREZTaW5nbGVQYWdlVmlld2VyLCBbewogICAga2V5OiAiX3Jlc2V0VmlldyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3Jlc2V0VmlldygpIHsKICAgICAgX2dldChfZ2V0UHJvdG90eXBlT2YoUERGU2luZ2xlUGFnZVZpZXdlci5wcm90b3R5cGUpLCAiX3Jlc2V0VmlldyIsIHRoaXMpLmNhbGwodGhpcyk7CgogICAgICB0aGlzLl9wcmV2aW91c1BhZ2VOdW1iZXIgPSAxOwogICAgICB0aGlzLl9zaGFkb3dWaWV3ZXIgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgIHRoaXMuX3VwZGF0ZVNjcm9sbERvd24gPSBudWxsOwogICAgfQogIH0sIHsKICAgIGtleTogIl9lbnN1cmVQYWdlVmlld1Zpc2libGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9lbnN1cmVQYWdlVmlld1Zpc2libGUoKSB7CiAgICAgIHZhciBwYWdlVmlldyA9IHRoaXMuX3BhZ2VzW3RoaXMuX2N1cnJlbnRQYWdlTnVtYmVyIC0gMV07CiAgICAgIHZhciBwcmV2aW91c1BhZ2VWaWV3ID0gdGhpcy5fcGFnZXNbdGhpcy5fcHJldmlvdXNQYWdlTnVtYmVyIC0gMV07CiAgICAgIHZhciB2aWV3ZXJOb2RlcyA9IHRoaXMudmlld2VyLmNoaWxkTm9kZXM7CgogICAgICBzd2l0Y2ggKHZpZXdlck5vZGVzLmxlbmd0aCkgewogICAgICAgIGNhc2UgMDoKICAgICAgICAgIHRoaXMudmlld2VyLmFwcGVuZENoaWxkKHBhZ2VWaWV3LmRpdik7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAxOgogICAgICAgICAgaWYgKHZpZXdlck5vZGVzWzBdICE9PSBwcmV2aW91c1BhZ2VWaWV3LmRpdikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIl9lbnN1cmVQYWdlVmlld1Zpc2libGU6IFVuZXhwZWN0ZWQgcHJldmlvdXNseSB2aXNpYmxlIHBhZ2UuIik7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHBhZ2VWaWV3ID09PSBwcmV2aW91c1BhZ2VWaWV3KSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQoKICAgICAgICAgIHRoaXMuX3NoYWRvd1ZpZXdlci5hcHBlbmRDaGlsZChwcmV2aW91c1BhZ2VWaWV3LmRpdik7CgogICAgICAgICAgdGhpcy52aWV3ZXIuYXBwZW5kQ2hpbGQocGFnZVZpZXcuZGl2KTsKICAgICAgICAgIHRoaXMuY29udGFpbmVyLnNjcm9sbFRvcCA9IDA7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiX2Vuc3VyZVBhZ2VWaWV3VmlzaWJsZTogT25seSBvbmUgcGFnZSBzaG91bGQgYmUgdmlzaWJsZSBhdCBhIHRpbWUuIik7CiAgICAgIH0KCiAgICAgIHRoaXMuX3ByZXZpb3VzUGFnZU51bWJlciA9IHRoaXMuX2N1cnJlbnRQYWdlTnVtYmVyOwogICAgfQogIH0sIHsKICAgIGtleTogIl9zY3JvbGxVcGRhdGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9zY3JvbGxVcGRhdGUoKSB7CiAgICAgIGlmICh0aGlzLl91cGRhdGVTY3JvbGxEb3duKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlU2Nyb2xsRG93bigpOwogICAgICB9CgogICAgICBfZ2V0KF9nZXRQcm90b3R5cGVPZihQREZTaW5nbGVQYWdlVmlld2VyLnByb3RvdHlwZSksICJfc2Nyb2xsVXBkYXRlIiwgdGhpcykuY2FsbCh0aGlzKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfc2Nyb2xsSW50b1ZpZXciLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9zY3JvbGxJbnRvVmlldyhfcmVmKSB7CiAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgdmFyIHBhZ2VEaXYgPSBfcmVmLnBhZ2VEaXYsCiAgICAgICAgICBfcmVmJHBhZ2VTcG90ID0gX3JlZi5wYWdlU3BvdCwKICAgICAgICAgIHBhZ2VTcG90ID0gX3JlZiRwYWdlU3BvdCA9PT0gdm9pZCAwID8gbnVsbCA6IF9yZWYkcGFnZVNwb3QsCiAgICAgICAgICBfcmVmJHBhZ2VOdW1iZXIgPSBfcmVmLnBhZ2VOdW1iZXIsCiAgICAgICAgICBwYWdlTnVtYmVyID0gX3JlZiRwYWdlTnVtYmVyID09PSB2b2lkIDAgPyBudWxsIDogX3JlZiRwYWdlTnVtYmVyOwoKICAgICAgaWYgKHBhZ2VOdW1iZXIpIHsKICAgICAgICB0aGlzLl9zZXRDdXJyZW50UGFnZU51bWJlcihwYWdlTnVtYmVyKTsKICAgICAgfQoKICAgICAgdmFyIHNjcm9sbGVkRG93biA9IHRoaXMuX2N1cnJlbnRQYWdlTnVtYmVyID49IHRoaXMuX3ByZXZpb3VzUGFnZU51bWJlcjsKCiAgICAgIHRoaXMuX2Vuc3VyZVBhZ2VWaWV3VmlzaWJsZSgpOwoKICAgICAgdGhpcy51cGRhdGUoKTsKCiAgICAgIF9nZXQoX2dldFByb3RvdHlwZU9mKFBERlNpbmdsZVBhZ2VWaWV3ZXIucHJvdG90eXBlKSwgIl9zY3JvbGxJbnRvVmlldyIsIHRoaXMpLmNhbGwodGhpcywgewogICAgICAgIHBhZ2VEaXY6IHBhZ2VEaXYsCiAgICAgICAgcGFnZVNwb3Q6IHBhZ2VTcG90LAogICAgICAgIHBhZ2VOdW1iZXI6IHBhZ2VOdW1iZXIKICAgICAgfSk7CgogICAgICB0aGlzLl91cGRhdGVTY3JvbGxEb3duID0gZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzMi5zY3JvbGwuZG93biA9IHNjcm9sbGVkRG93bjsKICAgICAgICBfdGhpczIuX3VwZGF0ZVNjcm9sbERvd24gPSBudWxsOwogICAgICB9OwogICAgfQogIH0sIHsKICAgIGtleTogIl9nZXRWaXNpYmxlUGFnZXMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9nZXRWaXNpYmxlUGFnZXMoKSB7CiAgICAgIHJldHVybiB0aGlzLl9nZXRDdXJyZW50VmlzaWJsZVBhZ2UoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfdXBkYXRlSGVscGVyIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfdXBkYXRlSGVscGVyKHZpc2libGVQYWdlcykge30KICB9LCB7CiAgICBrZXk6ICJfdXBkYXRlU2Nyb2xsTW9kZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3VwZGF0ZVNjcm9sbE1vZGUoKSB7fQogIH0sIHsKICAgIGtleTogIl91cGRhdGVTcHJlYWRNb2RlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfdXBkYXRlU3ByZWFkTW9kZSgpIHt9CiAgfSwgewogICAga2V5OiAiX3ZpZXdlckVsZW1lbnQiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiAoMCwgX3BkZmpzTGliLnNoYWRvdykodGhpcywgIl92aWV3ZXJFbGVtZW50IiwgdGhpcy5fc2hhZG93Vmlld2VyKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfaXNTY3JvbGxNb2RlSG9yaXpvbnRhbCIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuICgwLCBfcGRmanNMaWIuc2hhZG93KSh0aGlzLCAiX2lzU2Nyb2xsTW9kZUhvcml6b250YWwiLCBmYWxzZSk7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gUERGU2luZ2xlUGFnZVZpZXdlcjsKfShfYmFzZV92aWV3ZXIuQmFzZVZpZXdlcik7CgpleHBvcnRzLlBERlNpbmdsZVBhZ2VWaWV3ZXIgPSBQREZTaW5nbGVQYWdlVmlld2VyOwoKLyoqKi8gfSksCi8qIDM0ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuVG9vbGJhciA9IHZvaWQgMDsKCnZhciBfcmVnZW5lcmF0b3IgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9fd2VicGFja19yZXF1aXJlX18oMikpOwoKdmFyIF91aV91dGlscyA9IF9fd2VicGFja19yZXF1aXJlX18oNSk7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAiZGVmYXVsdCI6IG9iaiB9OyB9CgpmdW5jdGlvbiBhc3luY0dlbmVyYXRvclN0ZXAoZ2VuLCByZXNvbHZlLCByZWplY3QsIF9uZXh0LCBfdGhyb3csIGtleSwgYXJnKSB7IHRyeSB7IHZhciBpbmZvID0gZ2VuW2tleV0oYXJnKTsgdmFyIHZhbHVlID0gaW5mby52YWx1ZTsgfSBjYXRjaCAoZXJyb3IpIHsgcmVqZWN0KGVycm9yKTsgcmV0dXJuOyB9IGlmIChpbmZvLmRvbmUpIHsgcmVzb2x2ZSh2YWx1ZSk7IH0gZWxzZSB7IFByb21pc2UucmVzb2x2ZSh2YWx1ZSkudGhlbihfbmV4dCwgX3Rocm93KTsgfSB9CgpmdW5jdGlvbiBfYXN5bmNUb0dlbmVyYXRvcihmbikgeyByZXR1cm4gZnVuY3Rpb24gKCkgeyB2YXIgc2VsZiA9IHRoaXMsIGFyZ3MgPSBhcmd1bWVudHM7IHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7IHZhciBnZW4gPSBmbi5hcHBseShzZWxmLCBhcmdzKTsgZnVuY3Rpb24gX25leHQodmFsdWUpIHsgYXN5bmNHZW5lcmF0b3JTdGVwKGdlbiwgcmVzb2x2ZSwgcmVqZWN0LCBfbmV4dCwgX3Rocm93LCAibmV4dCIsIHZhbHVlKTsgfSBmdW5jdGlvbiBfdGhyb3coZXJyKSB7IGFzeW5jR2VuZXJhdG9yU3RlcChnZW4sIHJlc29sdmUsIHJlamVjdCwgX25leHQsIF90aHJvdywgInRocm93IiwgZXJyKTsgfSBfbmV4dCh1bmRlZmluZWQpOyB9KTsgfTsgfQoKZnVuY3Rpb24gX2NyZWF0ZUZvck9mSXRlcmF0b3JIZWxwZXIobywgYWxsb3dBcnJheUxpa2UpIHsgdmFyIGl0OyBpZiAodHlwZW9mIFN5bWJvbCA9PT0gInVuZGVmaW5lZCIgfHwgb1tTeW1ib2wuaXRlcmF0b3JdID09IG51bGwpIHsgaWYgKEFycmF5LmlzQXJyYXkobykgfHwgKGl0ID0gX3Vuc3VwcG9ydGVkSXRlcmFibGVUb0FycmF5KG8pKSB8fCBhbGxvd0FycmF5TGlrZSAmJiBvICYmIHR5cGVvZiBvLmxlbmd0aCA9PT0gIm51bWJlciIpIHsgaWYgKGl0KSBvID0gaXQ7IHZhciBpID0gMDsgdmFyIEYgPSBmdW5jdGlvbiBGKCkge307IHJldHVybiB7IHM6IEYsIG46IGZ1bmN0aW9uIG4oKSB7IGlmIChpID49IG8ubGVuZ3RoKSByZXR1cm4geyBkb25lOiB0cnVlIH07IHJldHVybiB7IGRvbmU6IGZhbHNlLCB2YWx1ZTogb1tpKytdIH07IH0sIGU6IGZ1bmN0aW9uIGUoX2UpIHsgdGhyb3cgX2U7IH0sIGY6IEYgfTsgfSB0aHJvdyBuZXcgVHlwZUVycm9yKCJJbnZhbGlkIGF0dGVtcHQgdG8gaXRlcmF0ZSBub24taXRlcmFibGUgaW5zdGFuY2UuXG5JbiBvcmRlciB0byBiZSBpdGVyYWJsZSwgbm9uLWFycmF5IG9iamVjdHMgbXVzdCBoYXZlIGEgW1N5bWJvbC5pdGVyYXRvcl0oKSBtZXRob2QuIik7IH0gdmFyIG5vcm1hbENvbXBsZXRpb24gPSB0cnVlLCBkaWRFcnIgPSBmYWxzZSwgZXJyOyByZXR1cm4geyBzOiBmdW5jdGlvbiBzKCkgeyBpdCA9IG9bU3ltYm9sLml0ZXJhdG9yXSgpOyB9LCBuOiBmdW5jdGlvbiBuKCkgeyB2YXIgc3RlcCA9IGl0Lm5leHQoKTsgbm9ybWFsQ29tcGxldGlvbiA9IHN0ZXAuZG9uZTsgcmV0dXJuIHN0ZXA7IH0sIGU6IGZ1bmN0aW9uIGUoX2UyKSB7IGRpZEVyciA9IHRydWU7IGVyciA9IF9lMjsgfSwgZjogZnVuY3Rpb24gZigpIHsgdHJ5IHsgaWYgKCFub3JtYWxDb21wbGV0aW9uICYmIGl0WyJyZXR1cm4iXSAhPSBudWxsKSBpdFsicmV0dXJuIl0oKTsgfSBmaW5hbGx5IHsgaWYgKGRpZEVycikgdGhyb3cgZXJyOyB9IH0gfTsgfQoKZnVuY3Rpb24gX3Vuc3VwcG9ydGVkSXRlcmFibGVUb0FycmF5KG8sIG1pbkxlbikgeyBpZiAoIW8pIHJldHVybjsgaWYgKHR5cGVvZiBvID09PSAic3RyaW5nIikgcmV0dXJuIF9hcnJheUxpa2VUb0FycmF5KG8sIG1pbkxlbik7IHZhciBuID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG8pLnNsaWNlKDgsIC0xKTsgaWYgKG4gPT09ICJPYmplY3QiICYmIG8uY29uc3RydWN0b3IpIG4gPSBvLmNvbnN0cnVjdG9yLm5hbWU7IGlmIChuID09PSAiTWFwIiB8fCBuID09PSAiU2V0IikgcmV0dXJuIEFycmF5LmZyb20obyk7IGlmIChuID09PSAiQXJndW1lbnRzIiB8fCAvXig/OlVpfEkpbnQoPzo4fDE2fDMyKSg/OkNsYW1wZWQpP0FycmF5JC8udGVzdChuKSkgcmV0dXJuIF9hcnJheUxpa2VUb0FycmF5KG8sIG1pbkxlbik7IH0KCmZ1bmN0aW9uIF9hcnJheUxpa2VUb0FycmF5KGFyciwgbGVuKSB7IGlmIChsZW4gPT0gbnVsbCB8fCBsZW4gPiBhcnIubGVuZ3RoKSBsZW4gPSBhcnIubGVuZ3RoOyBmb3IgKHZhciBpID0gMCwgYXJyMiA9IG5ldyBBcnJheShsZW4pOyBpIDwgbGVuOyBpKyspIHsgYXJyMltpXSA9IGFycltpXTsgfSByZXR1cm4gYXJyMjsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsgfSB9CgpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfQoKZnVuY3Rpb24gX2NyZWF0ZUNsYXNzKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH0KCnZhciBQQUdFX05VTUJFUl9MT0FESU5HX0lORElDQVRPUiA9ICJ2aXNpYmxlUGFnZUlzTG9hZGluZyI7CnZhciBTQ0FMRV9TRUxFQ1RfQ09OVEFJTkVSX1dJRFRIID0gMTQwOwp2YXIgU0NBTEVfU0VMRUNUX1dJRFRIID0gMTYyOwoKdmFyIFRvb2xiYXIgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIFRvb2xiYXIob3B0aW9ucywgZXZlbnRCdXMpIHsKICAgIHZhciBsMTBuID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMl0gOiBfdWlfdXRpbHMuTnVsbEwxMG47CgogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFRvb2xiYXIpOwoKICAgIHRoaXMudG9vbGJhciA9IG9wdGlvbnMuY29udGFpbmVyOwogICAgdGhpcy5ldmVudEJ1cyA9IGV2ZW50QnVzOwogICAgdGhpcy5sMTBuID0gbDEwbjsKICAgIHRoaXMuYnV0dG9ucyA9IFt7CiAgICAgIGVsZW1lbnQ6IG9wdGlvbnMucHJldmlvdXMsCiAgICAgIGV2ZW50TmFtZTogInByZXZpb3VzcGFnZSIKICAgIH0sIHsKICAgICAgZWxlbWVudDogb3B0aW9ucy5uZXh0LAogICAgICBldmVudE5hbWU6ICJuZXh0cGFnZSIKICAgIH0sIHsKICAgICAgZWxlbWVudDogb3B0aW9ucy56b29tSW4sCiAgICAgIGV2ZW50TmFtZTogInpvb21pbiIKICAgIH0sIHsKICAgICAgZWxlbWVudDogb3B0aW9ucy56b29tT3V0LAogICAgICBldmVudE5hbWU6ICJ6b29tb3V0IgogICAgfSwgewogICAgICBlbGVtZW50OiBvcHRpb25zLm9wZW5GaWxlLAogICAgICBldmVudE5hbWU6ICJvcGVuZmlsZSIKICAgIH0sIHsKICAgICAgZWxlbWVudDogb3B0aW9ucy5wcmludCwKICAgICAgZXZlbnROYW1lOiAicHJpbnQiCiAgICB9LCB7CiAgICAgIGVsZW1lbnQ6IG9wdGlvbnMucHJlc2VudGF0aW9uTW9kZUJ1dHRvbiwKICAgICAgZXZlbnROYW1lOiAicHJlc2VudGF0aW9ubW9kZSIKICAgIH0sIHsKICAgICAgZWxlbWVudDogb3B0aW9ucy5kb3dubG9hZCwKICAgICAgZXZlbnROYW1lOiAiZG93bmxvYWQiCiAgICB9LCB7CiAgICAgIGVsZW1lbnQ6IG9wdGlvbnMudmlld0Jvb2ttYXJrLAogICAgICBldmVudE5hbWU6IG51bGwKICAgIH1dOwogICAgdGhpcy5pdGVtcyA9IHsKICAgICAgbnVtUGFnZXM6IG9wdGlvbnMubnVtUGFnZXMsCiAgICAgIHBhZ2VOdW1iZXI6IG9wdGlvbnMucGFnZU51bWJlciwKICAgICAgc2NhbGVTZWxlY3RDb250YWluZXI6IG9wdGlvbnMuc2NhbGVTZWxlY3RDb250YWluZXIsCiAgICAgIHNjYWxlU2VsZWN0OiBvcHRpb25zLnNjYWxlU2VsZWN0LAogICAgICBjdXN0b21TY2FsZU9wdGlvbjogb3B0aW9ucy5jdXN0b21TY2FsZU9wdGlvbiwKICAgICAgcHJldmlvdXM6IG9wdGlvbnMucHJldmlvdXMsCiAgICAgIG5leHQ6IG9wdGlvbnMubmV4dCwKICAgICAgem9vbUluOiBvcHRpb25zLnpvb21JbiwKICAgICAgem9vbU91dDogb3B0aW9ucy56b29tT3V0CiAgICB9OwogICAgdGhpcy5fd2FzTG9jYWxpemVkID0gZmFsc2U7CiAgICB0aGlzLnJlc2V0KCk7CgogICAgdGhpcy5fYmluZExpc3RlbmVycygpOwogIH0KCiAgX2NyZWF0ZUNsYXNzKFRvb2xiYXIsIFt7CiAgICBrZXk6ICJzZXRQYWdlTnVtYmVyIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRQYWdlTnVtYmVyKHBhZ2VOdW1iZXIsIHBhZ2VMYWJlbCkgewogICAgICB0aGlzLnBhZ2VOdW1iZXIgPSBwYWdlTnVtYmVyOwogICAgICB0aGlzLnBhZ2VMYWJlbCA9IHBhZ2VMYWJlbDsKCiAgICAgIHRoaXMuX3VwZGF0ZVVJU3RhdGUoZmFsc2UpOwogICAgfQogIH0sIHsKICAgIGtleTogInNldFBhZ2VzQ291bnQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHNldFBhZ2VzQ291bnQocGFnZXNDb3VudCwgaGFzUGFnZUxhYmVscykgewogICAgICB0aGlzLnBhZ2VzQ291bnQgPSBwYWdlc0NvdW50OwogICAgICB0aGlzLmhhc1BhZ2VMYWJlbHMgPSBoYXNQYWdlTGFiZWxzOwoKICAgICAgdGhpcy5fdXBkYXRlVUlTdGF0ZSh0cnVlKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJzZXRQYWdlU2NhbGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHNldFBhZ2VTY2FsZShwYWdlU2NhbGVWYWx1ZSwgcGFnZVNjYWxlKSB7CiAgICAgIHRoaXMucGFnZVNjYWxlVmFsdWUgPSAocGFnZVNjYWxlVmFsdWUgfHwgcGFnZVNjYWxlKS50b1N0cmluZygpOwogICAgICB0aGlzLnBhZ2VTY2FsZSA9IHBhZ2VTY2FsZTsKCiAgICAgIHRoaXMuX3VwZGF0ZVVJU3RhdGUoZmFsc2UpOwogICAgfQogIH0sIHsKICAgIGtleTogInJlc2V0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiByZXNldCgpIHsKICAgICAgdGhpcy5wYWdlTnVtYmVyID0gMDsKICAgICAgdGhpcy5wYWdlTGFiZWwgPSBudWxsOwogICAgICB0aGlzLmhhc1BhZ2VMYWJlbHMgPSBmYWxzZTsKICAgICAgdGhpcy5wYWdlc0NvdW50ID0gMDsKICAgICAgdGhpcy5wYWdlU2NhbGVWYWx1ZSA9IF91aV91dGlscy5ERUZBVUxUX1NDQUxFX1ZBTFVFOwogICAgICB0aGlzLnBhZ2VTY2FsZSA9IF91aV91dGlscy5ERUZBVUxUX1NDQUxFOwoKICAgICAgdGhpcy5fdXBkYXRlVUlTdGF0ZSh0cnVlKTsKCiAgICAgIHRoaXMudXBkYXRlTG9hZGluZ0luZGljYXRvclN0YXRlKCk7CiAgICB9CiAgfSwgewogICAga2V5OiAiX2JpbmRMaXN0ZW5lcnMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9iaW5kTGlzdGVuZXJzKCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIF90aGlzJGl0ZW1zID0gdGhpcy5pdGVtcywKICAgICAgICAgIHBhZ2VOdW1iZXIgPSBfdGhpcyRpdGVtcy5wYWdlTnVtYmVyLAogICAgICAgICAgc2NhbGVTZWxlY3QgPSBfdGhpcyRpdGVtcy5zY2FsZVNlbGVjdDsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgdmFyIF9pdGVyYXRvciA9IF9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyKHRoaXMuYnV0dG9ucyksCiAgICAgICAgICBfc3RlcDsKCiAgICAgIHRyeSB7CiAgICAgICAgdmFyIF9sb29wID0gZnVuY3Rpb24gX2xvb3AoKSB7CiAgICAgICAgICB2YXIgX3N0ZXAkdmFsdWUgPSBfc3RlcC52YWx1ZSwKICAgICAgICAgICAgICBlbGVtZW50ID0gX3N0ZXAkdmFsdWUuZWxlbWVudCwKICAgICAgICAgICAgICBldmVudE5hbWUgPSBfc3RlcCR2YWx1ZS5ldmVudE5hbWU7CiAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgZnVuY3Rpb24gKGV2dCkgewogICAgICAgICAgICBpZiAoZXZlbnROYW1lICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgX3RoaXMuZXZlbnRCdXMuZGlzcGF0Y2goZXZlbnROYW1lLCB7CiAgICAgICAgICAgICAgICBzb3VyY2U6IF90aGlzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIGZvciAoX2l0ZXJhdG9yLnMoKTsgIShfc3RlcCA9IF9pdGVyYXRvci5uKCkpLmRvbmU7KSB7CiAgICAgICAgICBfbG9vcCgpOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgX2l0ZXJhdG9yLmUoZXJyKTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBfaXRlcmF0b3IuZigpOwogICAgICB9CgogICAgICBwYWdlTnVtYmVyLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMuc2VsZWN0KCk7CiAgICAgIH0pOwogICAgICBwYWdlTnVtYmVyLmFkZEV2ZW50TGlzdGVuZXIoImNoYW5nZSIsIGZ1bmN0aW9uICgpIHsKICAgICAgICBzZWxmLmV2ZW50QnVzLmRpc3BhdGNoKCJwYWdlbnVtYmVyY2hhbmdlZCIsIHsKICAgICAgICAgIHNvdXJjZTogc2VsZiwKICAgICAgICAgIHZhbHVlOiB0aGlzLnZhbHVlCiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICBzY2FsZVNlbGVjdC5hZGRFdmVudExpc3RlbmVyKCJjaGFuZ2UiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHRoaXMudmFsdWUgPT09ICJjdXN0b20iKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBzZWxmLmV2ZW50QnVzLmRpc3BhdGNoKCJzY2FsZWNoYW5nZWQiLCB7CiAgICAgICAgICBzb3VyY2U6IHNlbGYsCiAgICAgICAgICB2YWx1ZTogdGhpcy52YWx1ZQogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgc2NhbGVTZWxlY3Qub25jb250ZXh0bWVudSA9IF91aV91dGlscy5ub0NvbnRleHRNZW51SGFuZGxlcjsKCiAgICAgIHRoaXMuZXZlbnRCdXMuX29uKCJsb2NhbGl6ZWQiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgX3RoaXMuX3dhc0xvY2FsaXplZCA9IHRydWU7CgogICAgICAgIF90aGlzLl9hZGp1c3RTY2FsZVdpZHRoKCk7CgogICAgICAgIF90aGlzLl91cGRhdGVVSVN0YXRlKHRydWUpOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfdXBkYXRlVUlTdGF0ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3VwZGF0ZVVJU3RhdGUoKSB7CiAgICAgIHZhciByZXNldE51bVBhZ2VzID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiBmYWxzZTsKCiAgICAgIGlmICghdGhpcy5fd2FzTG9jYWxpemVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgcGFnZU51bWJlciA9IHRoaXMucGFnZU51bWJlciwKICAgICAgICAgIHBhZ2VzQ291bnQgPSB0aGlzLnBhZ2VzQ291bnQsCiAgICAgICAgICBwYWdlU2NhbGVWYWx1ZSA9IHRoaXMucGFnZVNjYWxlVmFsdWUsCiAgICAgICAgICBwYWdlU2NhbGUgPSB0aGlzLnBhZ2VTY2FsZSwKICAgICAgICAgIGl0ZW1zID0gdGhpcy5pdGVtczsKCiAgICAgIGlmIChyZXNldE51bVBhZ2VzKSB7CiAgICAgICAgaWYgKHRoaXMuaGFzUGFnZUxhYmVscykgewogICAgICAgICAgaXRlbXMucGFnZU51bWJlci50eXBlID0gInRleHQiOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpdGVtcy5wYWdlTnVtYmVyLnR5cGUgPSAibnVtYmVyIjsKICAgICAgICAgIHRoaXMubDEwbi5nZXQoIm9mX3BhZ2VzIiwgewogICAgICAgICAgICBwYWdlc0NvdW50OiBwYWdlc0NvdW50CiAgICAgICAgICB9LCAib2Yge3twYWdlc0NvdW50fX0iKS50aGVuKGZ1bmN0aW9uIChtc2cpIHsKICAgICAgICAgICAgaXRlbXMubnVtUGFnZXMudGV4dENvbnRlbnQgPSBtc2c7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGl0ZW1zLnBhZ2VOdW1iZXIubWF4ID0gcGFnZXNDb3VudDsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuaGFzUGFnZUxhYmVscykgewogICAgICAgIGl0ZW1zLnBhZ2VOdW1iZXIudmFsdWUgPSB0aGlzLnBhZ2VMYWJlbDsKICAgICAgICB0aGlzLmwxMG4uZ2V0KCJwYWdlX29mX3BhZ2VzIiwgewogICAgICAgICAgcGFnZU51bWJlcjogcGFnZU51bWJlciwKICAgICAgICAgIHBhZ2VzQ291bnQ6IHBhZ2VzQ291bnQKICAgICAgICB9LCAiKHt7cGFnZU51bWJlcn19IG9mIHt7cGFnZXNDb3VudH19KSIpLnRoZW4oZnVuY3Rpb24gKG1zZykgewogICAgICAgICAgaXRlbXMubnVtUGFnZXMudGV4dENvbnRlbnQgPSBtc2c7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaXRlbXMucGFnZU51bWJlci52YWx1ZSA9IHBhZ2VOdW1iZXI7CiAgICAgIH0KCiAgICAgIGl0ZW1zLnByZXZpb3VzLmRpc2FibGVkID0gcGFnZU51bWJlciA8PSAxOwogICAgICBpdGVtcy5uZXh0LmRpc2FibGVkID0gcGFnZU51bWJlciA+PSBwYWdlc0NvdW50OwogICAgICBpdGVtcy56b29tT3V0LmRpc2FibGVkID0gcGFnZVNjYWxlIDw9IF91aV91dGlscy5NSU5fU0NBTEU7CiAgICAgIGl0ZW1zLnpvb21Jbi5kaXNhYmxlZCA9IHBhZ2VTY2FsZSA+PSBfdWlfdXRpbHMuTUFYX1NDQUxFOwogICAgICB2YXIgY3VzdG9tU2NhbGUgPSBNYXRoLnJvdW5kKHBhZ2VTY2FsZSAqIDEwMDAwKSAvIDEwMDsKICAgICAgdGhpcy5sMTBuLmdldCgicGFnZV9zY2FsZV9wZXJjZW50IiwgewogICAgICAgIHNjYWxlOiBjdXN0b21TY2FsZQogICAgICB9LCAie3tzY2FsZX19JSIpLnRoZW4oZnVuY3Rpb24gKG1zZykgewogICAgICAgIHZhciBwcmVkZWZpbmVkVmFsdWVGb3VuZCA9IGZhbHNlOwoKICAgICAgICB2YXIgX2l0ZXJhdG9yMiA9IF9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyKGl0ZW1zLnNjYWxlU2VsZWN0Lm9wdGlvbnMpLAogICAgICAgICAgICBfc3RlcDI7CgogICAgICAgIHRyeSB7CiAgICAgICAgICBmb3IgKF9pdGVyYXRvcjIucygpOyAhKF9zdGVwMiA9IF9pdGVyYXRvcjIubigpKS5kb25lOykgewogICAgICAgICAgICB2YXIgb3B0aW9uID0gX3N0ZXAyLnZhbHVlOwoKICAgICAgICAgICAgaWYgKG9wdGlvbi52YWx1ZSAhPT0gcGFnZVNjYWxlVmFsdWUpIHsKICAgICAgICAgICAgICBvcHRpb24uc2VsZWN0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgb3B0aW9uLnNlbGVjdGVkID0gdHJ1ZTsKICAgICAgICAgICAgcHJlZGVmaW5lZFZhbHVlRm91bmQgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgX2l0ZXJhdG9yMi5lKGVycik7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIF9pdGVyYXRvcjIuZigpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFwcmVkZWZpbmVkVmFsdWVGb3VuZCkgewogICAgICAgICAgaXRlbXMuY3VzdG9tU2NhbGVPcHRpb24udGV4dENvbnRlbnQgPSBtc2c7CiAgICAgICAgICBpdGVtcy5jdXN0b21TY2FsZU9wdGlvbi5zZWxlY3RlZCA9IHRydWU7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJ1cGRhdGVMb2FkaW5nSW5kaWNhdG9yU3RhdGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHVwZGF0ZUxvYWRpbmdJbmRpY2F0b3JTdGF0ZSgpIHsKICAgICAgdmFyIGxvYWRpbmcgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IGZhbHNlOwogICAgICB2YXIgcGFnZU51bWJlcklucHV0ID0gdGhpcy5pdGVtcy5wYWdlTnVtYmVyOwogICAgICBwYWdlTnVtYmVySW5wdXQuY2xhc3NMaXN0LnRvZ2dsZShQQUdFX05VTUJFUl9MT0FESU5HX0lORElDQVRPUiwgbG9hZGluZyk7CiAgICB9CiAgfSwgewogICAga2V5OiAiX2FkanVzdFNjYWxlV2lkdGgiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9hZGp1c3RTY2FsZVdpZHRoMiA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ubWFyayhmdW5jdGlvbiBfY2FsbGVlKCkgewogICAgICAgIHZhciBpdGVtcywgbDEwbiwgcHJlZGVmaW5lZFZhbHVlc1Byb21pc2UsIGNhbnZhcywgY3R4LCBfZ2V0Q29tcHV0ZWRTdHlsZSwgZm9udFNpemUsIGZvbnRGYW1pbHksIG1heFdpZHRoLCBfaXRlcmF0b3IzLCBfc3RlcDMsIHByZWRlZmluZWRWYWx1ZSwgX2N0eCRtZWFzdXJlVGV4dCwgd2lkdGgsIG92ZXJmbG93OwoKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ud3JhcChmdW5jdGlvbiBfY2FsbGVlJChfY29udGV4dCkgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dC5wcmV2ID0gX2NvbnRleHQubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIGl0ZW1zID0gdGhpcy5pdGVtcywgbDEwbiA9IHRoaXMubDEwbjsKICAgICAgICAgICAgICAgIHByZWRlZmluZWRWYWx1ZXNQcm9taXNlID0gUHJvbWlzZS5hbGwoW2wxMG4uZ2V0KCJwYWdlX3NjYWxlX2F1dG8iLCBudWxsLCAiQXV0b21hdGljIFpvb20iKSwgbDEwbi5nZXQoInBhZ2Vfc2NhbGVfYWN0dWFsIiwgbnVsbCwgIkFjdHVhbCBTaXplIiksIGwxMG4uZ2V0KCJwYWdlX3NjYWxlX2ZpdCIsIG51bGwsICJQYWdlIEZpdCIpLCBsMTBuLmdldCgicGFnZV9zY2FsZV93aWR0aCIsIG51bGwsICJQYWdlIFdpZHRoIildKTsKICAgICAgICAgICAgICAgIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpOwogICAgICAgICAgICAgICAgY2FudmFzLm1vek9wYXF1ZSA9IHRydWU7CiAgICAgICAgICAgICAgICBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgiMmQiLCB7CiAgICAgICAgICAgICAgICAgIGFscGhhOiBmYWxzZQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBfY29udGV4dC5uZXh0ID0gNzsKICAgICAgICAgICAgICAgIHJldHVybiBfdWlfdXRpbHMuYW5pbWF0aW9uU3RhcnRlZDsKCiAgICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgICAgX2dldENvbXB1dGVkU3R5bGUgPSBnZXRDb21wdXRlZFN0eWxlKGl0ZW1zLnNjYWxlU2VsZWN0KSwgZm9udFNpemUgPSBfZ2V0Q29tcHV0ZWRTdHlsZS5mb250U2l6ZSwgZm9udEZhbWlseSA9IF9nZXRDb21wdXRlZFN0eWxlLmZvbnRGYW1pbHk7CiAgICAgICAgICAgICAgICBjdHguZm9udCA9ICIiLmNvbmNhdChmb250U2l6ZSwgIiAiKS5jb25jYXQoZm9udEZhbWlseSk7CiAgICAgICAgICAgICAgICBtYXhXaWR0aCA9IDA7CiAgICAgICAgICAgICAgICBfY29udGV4dC50MCA9IF9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyOwogICAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDEzOwogICAgICAgICAgICAgICAgcmV0dXJuIHByZWRlZmluZWRWYWx1ZXNQcm9taXNlOwoKICAgICAgICAgICAgICBjYXNlIDEzOgogICAgICAgICAgICAgICAgX2NvbnRleHQudDEgPSBfY29udGV4dC5zZW50OwogICAgICAgICAgICAgICAgX2l0ZXJhdG9yMyA9ICgwLCBfY29udGV4dC50MCkoX2NvbnRleHQudDEpOwoKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGZvciAoX2l0ZXJhdG9yMy5zKCk7ICEoX3N0ZXAzID0gX2l0ZXJhdG9yMy5uKCkpLmRvbmU7KSB7CiAgICAgICAgICAgICAgICAgICAgcHJlZGVmaW5lZFZhbHVlID0gX3N0ZXAzLnZhbHVlOwogICAgICAgICAgICAgICAgICAgIF9jdHgkbWVhc3VyZVRleHQgPSBjdHgubWVhc3VyZVRleHQocHJlZGVmaW5lZFZhbHVlKSwgd2lkdGggPSBfY3R4JG1lYXN1cmVUZXh0LndpZHRoOwoKICAgICAgICAgICAgICAgICAgICBpZiAod2lkdGggPiBtYXhXaWR0aCkgewogICAgICAgICAgICAgICAgICAgICAgbWF4V2lkdGggPSB3aWR0aDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgICAgICBfaXRlcmF0b3IzLmUoZXJyKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIF9pdGVyYXRvcjMuZigpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG92ZXJmbG93ID0gU0NBTEVfU0VMRUNUX1dJRFRIIC0gU0NBTEVfU0VMRUNUX0NPTlRBSU5FUl9XSURUSDsKICAgICAgICAgICAgICAgIG1heFdpZHRoICs9IDEuNSAqIG92ZXJmbG93OwoKICAgICAgICAgICAgICAgIGlmIChtYXhXaWR0aCA+IFNDQUxFX1NFTEVDVF9DT05UQUlORVJfV0lEVEgpIHsKICAgICAgICAgICAgICAgICAgaXRlbXMuc2NhbGVTZWxlY3Quc3R5bGUud2lkdGggPSAiIi5jb25jYXQobWF4V2lkdGggKyBvdmVyZmxvdywgInB4Iik7CiAgICAgICAgICAgICAgICAgIGl0ZW1zLnNjYWxlU2VsZWN0Q29udGFpbmVyLnN0eWxlLndpZHRoID0gIiIuY29uY2F0KG1heFdpZHRoLCAicHgiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYW52YXMud2lkdGggPSAwOwogICAgICAgICAgICAgICAgY2FudmFzLmhlaWdodCA9IDA7CiAgICAgICAgICAgICAgICBjYW52YXMgPSBjdHggPSBudWxsOwoKICAgICAgICAgICAgICBjYXNlIDIyOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZSwgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIF9hZGp1c3RTY2FsZVdpZHRoKCkgewogICAgICAgIHJldHVybiBfYWRqdXN0U2NhbGVXaWR0aDIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIF9hZGp1c3RTY2FsZVdpZHRoOwogICAgfSgpCiAgfV0pOwoKICByZXR1cm4gVG9vbGJhcjsKfSgpOwoKZXhwb3J0cy5Ub29sYmFyID0gVG9vbGJhcjsKCi8qKiovIH0pLAovKiAzNSAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoidXNlIHN0cmljdCI7CgoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLlZpZXdIaXN0b3J5ID0gdm9pZCAwOwoKdmFyIF9yZWdlbmVyYXRvciA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX193ZWJwYWNrX3JlcXVpcmVfXygyKSk7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAiZGVmYXVsdCI6IG9iaiB9OyB9CgpmdW5jdGlvbiBhc3luY0dlbmVyYXRvclN0ZXAoZ2VuLCByZXNvbHZlLCByZWplY3QsIF9uZXh0LCBfdGhyb3csIGtleSwgYXJnKSB7IHRyeSB7IHZhciBpbmZvID0gZ2VuW2tleV0oYXJnKTsgdmFyIHZhbHVlID0gaW5mby52YWx1ZTsgfSBjYXRjaCAoZXJyb3IpIHsgcmVqZWN0KGVycm9yKTsgcmV0dXJuOyB9IGlmIChpbmZvLmRvbmUpIHsgcmVzb2x2ZSh2YWx1ZSk7IH0gZWxzZSB7IFByb21pc2UucmVzb2x2ZSh2YWx1ZSkudGhlbihfbmV4dCwgX3Rocm93KTsgfSB9CgpmdW5jdGlvbiBfYXN5bmNUb0dlbmVyYXRvcihmbikgeyByZXR1cm4gZnVuY3Rpb24gKCkgeyB2YXIgc2VsZiA9IHRoaXMsIGFyZ3MgPSBhcmd1bWVudHM7IHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7IHZhciBnZW4gPSBmbi5hcHBseShzZWxmLCBhcmdzKTsgZnVuY3Rpb24gX25leHQodmFsdWUpIHsgYXN5bmNHZW5lcmF0b3JTdGVwKGdlbiwgcmVzb2x2ZSwgcmVqZWN0LCBfbmV4dCwgX3Rocm93LCAibmV4dCIsIHZhbHVlKTsgfSBmdW5jdGlvbiBfdGhyb3coZXJyKSB7IGFzeW5jR2VuZXJhdG9yU3RlcChnZW4sIHJlc29sdmUsIHJlamVjdCwgX25leHQsIF90aHJvdywgInRocm93IiwgZXJyKTsgfSBfbmV4dCh1bmRlZmluZWQpOyB9KTsgfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsgfSB9CgpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfQoKZnVuY3Rpb24gX2NyZWF0ZUNsYXNzKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH0KCnZhciBERUZBVUxUX1ZJRVdfSElTVE9SWV9DQUNIRV9TSVpFID0gMjA7Cgp2YXIgVmlld0hpc3RvcnkgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIFZpZXdIaXN0b3J5KGZpbmdlcnByaW50KSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIHZhciBjYWNoZVNpemUgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IERFRkFVTFRfVklFV19ISVNUT1JZX0NBQ0hFX1NJWkU7CgogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFZpZXdIaXN0b3J5KTsKCiAgICB0aGlzLmZpbmdlcnByaW50ID0gZmluZ2VycHJpbnQ7CiAgICB0aGlzLmNhY2hlU2l6ZSA9IGNhY2hlU2l6ZTsKICAgIHRoaXMuX2luaXRpYWxpemVkUHJvbWlzZSA9IHRoaXMuX3JlYWRGcm9tU3RvcmFnZSgpLnRoZW4oZnVuY3Rpb24gKGRhdGFiYXNlU3RyKSB7CiAgICAgIHZhciBkYXRhYmFzZSA9IEpTT04ucGFyc2UoZGF0YWJhc2VTdHIgfHwgInt9Iik7CiAgICAgIHZhciBpbmRleCA9IC0xOwoKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGRhdGFiYXNlLmZpbGVzKSkgewogICAgICAgIGRhdGFiYXNlLmZpbGVzID0gW107CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd2hpbGUgKGRhdGFiYXNlLmZpbGVzLmxlbmd0aCA+PSBfdGhpcy5jYWNoZVNpemUpIHsKICAgICAgICAgIGRhdGFiYXNlLmZpbGVzLnNoaWZ0KCk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBpID0gMCwgaWkgPSBkYXRhYmFzZS5maWxlcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICB2YXIgYnJhbmNoID0gZGF0YWJhc2UuZmlsZXNbaV07CgogICAgICAgICAgaWYgKGJyYW5jaC5maW5nZXJwcmludCA9PT0gX3RoaXMuZmluZ2VycHJpbnQpIHsKICAgICAgICAgICAgaW5kZXggPSBpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChpbmRleCA9PT0gLTEpIHsKICAgICAgICBpbmRleCA9IGRhdGFiYXNlLmZpbGVzLnB1c2goewogICAgICAgICAgZmluZ2VycHJpbnQ6IF90aGlzLmZpbmdlcnByaW50CiAgICAgICAgfSkgLSAxOwogICAgICB9CgogICAgICBfdGhpcy5maWxlID0gZGF0YWJhc2UuZmlsZXNbaW5kZXhdOwogICAgICBfdGhpcy5kYXRhYmFzZSA9IGRhdGFiYXNlOwogICAgfSk7CiAgfQoKICBfY3JlYXRlQ2xhc3MoVmlld0hpc3RvcnksIFt7CiAgICBrZXk6ICJfd3JpdGVUb1N0b3JhZ2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF93cml0ZVRvU3RvcmFnZTIgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclsiZGVmYXVsdCJdLm1hcmsoZnVuY3Rpb24gX2NhbGxlZSgpIHsKICAgICAgICB2YXIgZGF0YWJhc2VTdHI7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclsiZGVmYXVsdCJdLndyYXAoZnVuY3Rpb24gX2NhbGxlZSQoX2NvbnRleHQpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQucHJldiA9IF9jb250ZXh0Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBkYXRhYmFzZVN0ciA9IEpTT04uc3RyaW5naWZ5KHRoaXMuZGF0YWJhc2UpOwogICAgICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oInBkZmpzLmhpc3RvcnkiLCBkYXRhYmFzZVN0cik7CgogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWUsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBfd3JpdGVUb1N0b3JhZ2UoKSB7CiAgICAgICAgcmV0dXJuIF93cml0ZVRvU3RvcmFnZTIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIF93cml0ZVRvU3RvcmFnZTsKICAgIH0oKQogIH0sIHsKICAgIGtleTogIl9yZWFkRnJvbVN0b3JhZ2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9yZWFkRnJvbVN0b3JhZ2UyID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JbImRlZmF1bHQiXS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUyKCkgewogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JbImRlZmF1bHQiXS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUyJChfY29udGV4dDIpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQyLnByZXYgPSBfY29udGV4dDIubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIuYWJydXB0KCJyZXR1cm4iLCBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgicGRmanMuaGlzdG9yeSIpKTsKCiAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyLnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWUyKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gX3JlYWRGcm9tU3RvcmFnZSgpIHsKICAgICAgICByZXR1cm4gX3JlYWRGcm9tU3RvcmFnZTIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIF9yZWFkRnJvbVN0b3JhZ2U7CiAgICB9KCkKICB9LCB7CiAgICBrZXk6ICJzZXQiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9zZXQgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclsiZGVmYXVsdCJdLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTMobmFtZSwgdmFsKSB7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclsiZGVmYXVsdCJdLndyYXAoZnVuY3Rpb24gX2NhbGxlZTMkKF9jb250ZXh0MykgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDMucHJldiA9IF9jb250ZXh0My5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgX2NvbnRleHQzLm5leHQgPSAyOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2luaXRpYWxpemVkUHJvbWlzZTsKCiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgdGhpcy5maWxlW25hbWVdID0gdmFsOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0My5hYnJ1cHQoInJldHVybiIsIHRoaXMuX3dyaXRlVG9TdG9yYWdlKCkpOwoKICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTMsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBzZXQoX3gsIF94MikgewogICAgICAgIHJldHVybiBfc2V0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBzZXQ7CiAgICB9KCkKICB9LCB7CiAgICBrZXk6ICJzZXRNdWx0aXBsZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3NldE11bHRpcGxlID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JbImRlZmF1bHQiXS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU0KHByb3BlcnRpZXMpIHsKICAgICAgICB2YXIgbmFtZTsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ud3JhcChmdW5jdGlvbiBfY2FsbGVlNCQoX2NvbnRleHQ0KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0NC5wcmV2ID0gX2NvbnRleHQ0Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBfY29udGV4dDQubmV4dCA9IDI7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5faW5pdGlhbGl6ZWRQcm9taXNlOwoKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICBmb3IgKG5hbWUgaW4gcHJvcGVydGllcykgewogICAgICAgICAgICAgICAgICB0aGlzLmZpbGVbbmFtZV0gPSBwcm9wZXJ0aWVzW25hbWVdOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDQuYWJydXB0KCJyZXR1cm4iLCB0aGlzLl93cml0ZVRvU3RvcmFnZSgpKTsKCiAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ0LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWU0LCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gc2V0TXVsdGlwbGUoX3gzKSB7CiAgICAgICAgcmV0dXJuIF9zZXRNdWx0aXBsZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gc2V0TXVsdGlwbGU7CiAgICB9KCkKICB9LCB7CiAgICBrZXk6ICJnZXQiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9nZXQgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclsiZGVmYXVsdCJdLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTUobmFtZSwgZGVmYXVsdFZhbHVlKSB7CiAgICAgICAgdmFyIHZhbDsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ud3JhcChmdW5jdGlvbiBfY2FsbGVlNSQoX2NvbnRleHQ1KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0NS5wcmV2ID0gX2NvbnRleHQ1Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBfY29udGV4dDUubmV4dCA9IDI7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5faW5pdGlhbGl6ZWRQcm9taXNlOwoKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICB2YWwgPSB0aGlzLmZpbGVbbmFtZV07CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ1LmFicnVwdCgicmV0dXJuIiwgdmFsICE9PSB1bmRlZmluZWQgPyB2YWwgOiBkZWZhdWx0VmFsdWUpOwoKICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDUuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTUsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBnZXQoX3g0LCBfeDUpIHsKICAgICAgICByZXR1cm4gX2dldC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gZ2V0OwogICAgfSgpCiAgfSwgewogICAga2V5OiAiZ2V0TXVsdGlwbGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9nZXRNdWx0aXBsZSA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ubWFyayhmdW5jdGlvbiBfY2FsbGVlNihwcm9wZXJ0aWVzKSB7CiAgICAgICAgdmFyIHZhbHVlcywgbmFtZSwgdmFsOwogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JbImRlZmF1bHQiXS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU2JChfY29udGV4dDYpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ2LnByZXYgPSBfY29udGV4dDYubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIF9jb250ZXh0Ni5uZXh0ID0gMjsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9pbml0aWFsaXplZFByb21pc2U7CgogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIHZhbHVlcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CgogICAgICAgICAgICAgICAgZm9yIChuYW1lIGluIHByb3BlcnRpZXMpIHsKICAgICAgICAgICAgICAgICAgdmFsID0gdGhpcy5maWxlW25hbWVdOwogICAgICAgICAgICAgICAgICB2YWx1ZXNbbmFtZV0gPSB2YWwgIT09IHVuZGVmaW5lZCA/IHZhbCA6IHByb3BlcnRpZXNbbmFtZV07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ni5hYnJ1cHQoInJldHVybiIsIHZhbHVlcyk7CgogICAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ni5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlNiwgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIGdldE11bHRpcGxlKF94NikgewogICAgICAgIHJldHVybiBfZ2V0TXVsdGlwbGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGdldE11bHRpcGxlOwogICAgfSgpCiAgfV0pOwoKICByZXR1cm4gVmlld0hpc3Rvcnk7Cn0oKTsKCmV4cG9ydHMuVmlld0hpc3RvcnkgPSBWaWV3SGlzdG9yeTsKCi8qKiovIH0pLAovKiAzNiAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoidXNlIHN0cmljdCI7CgoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLkdlbmVyaWNDb20gPSB2b2lkIDA7Cgp2YXIgX3JlZ2VuZXJhdG9yID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfX3dlYnBhY2tfcmVxdWlyZV9fKDIpKTsKCnZhciBfYXBwID0gX193ZWJwYWNrX3JlcXVpcmVfXygxKTsKCnZhciBfcHJlZmVyZW5jZXMgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDM3KTsKCnZhciBfZG93bmxvYWRfbWFuYWdlciA9IF9fd2VicGFja19yZXF1aXJlX18oMzgpOwoKdmFyIF9nZW5lcmljbDEwbiA9IF9fd2VicGFja19yZXF1aXJlX18oMzkpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgImRlZmF1bHQiOiBvYmogfTsgfQoKZnVuY3Rpb24gX3R5cGVvZihvYmopIHsgIkBiYWJlbC9oZWxwZXJzIC0gdHlwZW9mIjsgaWYgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIFN5bWJvbC5pdGVyYXRvciA9PT0gInN5bWJvbCIpIHsgX3R5cGVvZiA9IGZ1bmN0aW9uIF90eXBlb2Yob2JqKSB7IHJldHVybiB0eXBlb2Ygb2JqOyB9OyB9IGVsc2UgeyBfdHlwZW9mID0gZnVuY3Rpb24gX3R5cGVvZihvYmopIHsgcmV0dXJuIG9iaiAmJiB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIG9iai5jb25zdHJ1Y3RvciA9PT0gU3ltYm9sICYmIG9iaiAhPT0gU3ltYm9sLnByb3RvdHlwZSA/ICJzeW1ib2wiIDogdHlwZW9mIG9iajsgfTsgfSByZXR1cm4gX3R5cGVvZihvYmopOyB9CgpmdW5jdGlvbiBhc3luY0dlbmVyYXRvclN0ZXAoZ2VuLCByZXNvbHZlLCByZWplY3QsIF9uZXh0LCBfdGhyb3csIGtleSwgYXJnKSB7IHRyeSB7IHZhciBpbmZvID0gZ2VuW2tleV0oYXJnKTsgdmFyIHZhbHVlID0gaW5mby52YWx1ZTsgfSBjYXRjaCAoZXJyb3IpIHsgcmVqZWN0KGVycm9yKTsgcmV0dXJuOyB9IGlmIChpbmZvLmRvbmUpIHsgcmVzb2x2ZSh2YWx1ZSk7IH0gZWxzZSB7IFByb21pc2UucmVzb2x2ZSh2YWx1ZSkudGhlbihfbmV4dCwgX3Rocm93KTsgfSB9CgpmdW5jdGlvbiBfYXN5bmNUb0dlbmVyYXRvcihmbikgeyByZXR1cm4gZnVuY3Rpb24gKCkgeyB2YXIgc2VsZiA9IHRoaXMsIGFyZ3MgPSBhcmd1bWVudHM7IHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7IHZhciBnZW4gPSBmbi5hcHBseShzZWxmLCBhcmdzKTsgZnVuY3Rpb24gX25leHQodmFsdWUpIHsgYXN5bmNHZW5lcmF0b3JTdGVwKGdlbiwgcmVzb2x2ZSwgcmVqZWN0LCBfbmV4dCwgX3Rocm93LCAibmV4dCIsIHZhbHVlKTsgfSBmdW5jdGlvbiBfdGhyb3coZXJyKSB7IGFzeW5jR2VuZXJhdG9yU3RlcChnZW4sIHJlc29sdmUsIHJlamVjdCwgX25leHQsIF90aHJvdywgInRocm93IiwgZXJyKTsgfSBfbmV4dCh1bmRlZmluZWQpOyB9KTsgfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsgfSB9CgpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfQoKZnVuY3Rpb24gX2NyZWF0ZUNsYXNzKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH0KCmZ1bmN0aW9uIF9pbmhlcml0cyhzdWJDbGFzcywgc3VwZXJDbGFzcykgeyBpZiAodHlwZW9mIHN1cGVyQ2xhc3MgIT09ICJmdW5jdGlvbiIgJiYgc3VwZXJDbGFzcyAhPT0gbnVsbCkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJTdXBlciBleHByZXNzaW9uIG11c3QgZWl0aGVyIGJlIG51bGwgb3IgYSBmdW5jdGlvbiIpOyB9IHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcyAmJiBzdXBlckNsYXNzLnByb3RvdHlwZSwgeyBjb25zdHJ1Y3RvcjogeyB2YWx1ZTogc3ViQ2xhc3MsIHdyaXRhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUgfSB9KTsgaWYgKHN1cGVyQ2xhc3MpIF9zZXRQcm90b3R5cGVPZihzdWJDbGFzcywgc3VwZXJDbGFzcyk7IH0KCmZ1bmN0aW9uIF9zZXRQcm90b3R5cGVPZihvLCBwKSB7IF9zZXRQcm90b3R5cGVPZiA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fCBmdW5jdGlvbiBfc2V0UHJvdG90eXBlT2YobywgcCkgeyBvLl9fcHJvdG9fXyA9IHA7IHJldHVybiBvOyB9OyByZXR1cm4gX3NldFByb3RvdHlwZU9mKG8sIHApOyB9CgpmdW5jdGlvbiBfY3JlYXRlU3VwZXIoRGVyaXZlZCkgeyB2YXIgaGFzTmF0aXZlUmVmbGVjdENvbnN0cnVjdCA9IF9pc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QoKTsgcmV0dXJuIGZ1bmN0aW9uIF9jcmVhdGVTdXBlckludGVybmFsKCkgeyB2YXIgU3VwZXIgPSBfZ2V0UHJvdG90eXBlT2YoRGVyaXZlZCksIHJlc3VsdDsgaWYgKGhhc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QpIHsgdmFyIE5ld1RhcmdldCA9IF9nZXRQcm90b3R5cGVPZih0aGlzKS5jb25zdHJ1Y3RvcjsgcmVzdWx0ID0gUmVmbGVjdC5jb25zdHJ1Y3QoU3VwZXIsIGFyZ3VtZW50cywgTmV3VGFyZ2V0KTsgfSBlbHNlIHsgcmVzdWx0ID0gU3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsgfSByZXR1cm4gX3Bvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgcmVzdWx0KTsgfTsgfQoKZnVuY3Rpb24gX3Bvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4oc2VsZiwgY2FsbCkgeyBpZiAoY2FsbCAmJiAoX3R5cGVvZihjYWxsKSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIGNhbGwgPT09ICJmdW5jdGlvbiIpKSB7IHJldHVybiBjYWxsOyB9IHJldHVybiBfYXNzZXJ0VGhpc0luaXRpYWxpemVkKHNlbGYpOyB9CgpmdW5jdGlvbiBfYXNzZXJ0VGhpc0luaXRpYWxpemVkKHNlbGYpIHsgaWYgKHNlbGYgPT09IHZvaWQgMCkgeyB0aHJvdyBuZXcgUmVmZXJlbmNlRXJyb3IoInRoaXMgaGFzbid0IGJlZW4gaW5pdGlhbGlzZWQgLSBzdXBlcigpIGhhc24ndCBiZWVuIGNhbGxlZCIpOyB9IHJldHVybiBzZWxmOyB9CgpmdW5jdGlvbiBfaXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KCkgeyBpZiAodHlwZW9mIFJlZmxlY3QgPT09ICJ1bmRlZmluZWQiIHx8ICFSZWZsZWN0LmNvbnN0cnVjdCkgcmV0dXJuIGZhbHNlOyBpZiAoUmVmbGVjdC5jb25zdHJ1Y3Quc2hhbSkgcmV0dXJuIGZhbHNlOyBpZiAodHlwZW9mIFByb3h5ID09PSAiZnVuY3Rpb24iKSByZXR1cm4gdHJ1ZTsgdHJ5IHsgRGF0ZS5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChSZWZsZWN0LmNvbnN0cnVjdChEYXRlLCBbXSwgZnVuY3Rpb24gKCkge30pKTsgcmV0dXJuIHRydWU7IH0gY2F0Y2ggKGUpIHsgcmV0dXJuIGZhbHNlOyB9IH0KCmZ1bmN0aW9uIF9nZXRQcm90b3R5cGVPZihvKSB7IF9nZXRQcm90b3R5cGVPZiA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiA/IE9iamVjdC5nZXRQcm90b3R5cGVPZiA6IGZ1bmN0aW9uIF9nZXRQcm90b3R5cGVPZihvKSB7IHJldHVybiBvLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2Yobyk7IH07IHJldHVybiBfZ2V0UHJvdG90eXBlT2Yobyk7IH0KCjsKdmFyIEdlbmVyaWNDb20gPSB7fTsKZXhwb3J0cy5HZW5lcmljQ29tID0gR2VuZXJpY0NvbTsKCnZhciBHZW5lcmljUHJlZmVyZW5jZXMgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKF9CYXNlUHJlZmVyZW5jZXMpIHsKICBfaW5oZXJpdHMoR2VuZXJpY1ByZWZlcmVuY2VzLCBfQmFzZVByZWZlcmVuY2VzKTsKCiAgdmFyIF9zdXBlciA9IF9jcmVhdGVTdXBlcihHZW5lcmljUHJlZmVyZW5jZXMpOwoKICBmdW5jdGlvbiBHZW5lcmljUHJlZmVyZW5jZXMoKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgR2VuZXJpY1ByZWZlcmVuY2VzKTsKCiAgICByZXR1cm4gX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfQoKICBfY3JlYXRlQ2xhc3MoR2VuZXJpY1ByZWZlcmVuY2VzLCBbewogICAga2V5OiAiX3dyaXRlVG9TdG9yYWdlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfd3JpdGVUb1N0b3JhZ2UyID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JbImRlZmF1bHQiXS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUocHJlZk9iaikgewogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JbImRlZmF1bHQiXS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUkKF9jb250ZXh0KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0LnByZXYgPSBfY29udGV4dC5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oInBkZmpzLnByZWZlcmVuY2VzIiwgSlNPTi5zdHJpbmdpZnkocHJlZk9iaikpOwoKICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gX3dyaXRlVG9TdG9yYWdlKF94KSB7CiAgICAgICAgcmV0dXJuIF93cml0ZVRvU3RvcmFnZTIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIF93cml0ZVRvU3RvcmFnZTsKICAgIH0oKQogIH0sIHsKICAgIGtleTogIl9yZWFkRnJvbVN0b3JhZ2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9yZWFkRnJvbVN0b3JhZ2UyID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JbImRlZmF1bHQiXS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUyKHByZWZPYmopIHsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ud3JhcChmdW5jdGlvbiBfY2FsbGVlMiQoX2NvbnRleHQyKSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0Mi5wcmV2ID0gX2NvbnRleHQyLm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyLmFicnVwdCgicmV0dXJuIiwgSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgicGRmanMucHJlZmVyZW5jZXMiKSkpOwoKICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTIpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBfcmVhZEZyb21TdG9yYWdlKF94MikgewogICAgICAgIHJldHVybiBfcmVhZEZyb21TdG9yYWdlMi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gX3JlYWRGcm9tU3RvcmFnZTsKICAgIH0oKQogIH1dKTsKCiAgcmV0dXJuIEdlbmVyaWNQcmVmZXJlbmNlczsKfShfcHJlZmVyZW5jZXMuQmFzZVByZWZlcmVuY2VzKTsKCnZhciBHZW5lcmljRXh0ZXJuYWxTZXJ2aWNlcyA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoX0RlZmF1bHRFeHRlcm5hbFNlcnZpKSB7CiAgX2luaGVyaXRzKEdlbmVyaWNFeHRlcm5hbFNlcnZpY2VzLCBfRGVmYXVsdEV4dGVybmFsU2VydmkpOwoKICB2YXIgX3N1cGVyMiA9IF9jcmVhdGVTdXBlcihHZW5lcmljRXh0ZXJuYWxTZXJ2aWNlcyk7CgogIGZ1bmN0aW9uIEdlbmVyaWNFeHRlcm5hbFNlcnZpY2VzKCkgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEdlbmVyaWNFeHRlcm5hbFNlcnZpY2VzKTsKCiAgICByZXR1cm4gX3N1cGVyMi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0KCiAgX2NyZWF0ZUNsYXNzKEdlbmVyaWNFeHRlcm5hbFNlcnZpY2VzLCBudWxsLCBbewogICAga2V5OiAiY3JlYXRlRG93bmxvYWRNYW5hZ2VyIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVEb3dubG9hZE1hbmFnZXIob3B0aW9ucykgewogICAgICByZXR1cm4gbmV3IF9kb3dubG9hZF9tYW5hZ2VyLkRvd25sb2FkTWFuYWdlcihvcHRpb25zKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJjcmVhdGVQcmVmZXJlbmNlcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlUHJlZmVyZW5jZXMoKSB7CiAgICAgIHJldHVybiBuZXcgR2VuZXJpY1ByZWZlcmVuY2VzKCk7CiAgICB9CiAgfSwgewogICAga2V5OiAiY3JlYXRlTDEwbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlTDEwbihfcmVmKSB7CiAgICAgIHZhciBfcmVmJGxvY2FsZSA9IF9yZWYubG9jYWxlLAogICAgICAgICAgbG9jYWxlID0gX3JlZiRsb2NhbGUgPT09IHZvaWQgMCA/ICJlbi1VUyIgOiBfcmVmJGxvY2FsZTsKICAgICAgcmV0dXJuIG5ldyBfZ2VuZXJpY2wxMG4uR2VuZXJpY0wxMG4obG9jYWxlKTsKICAgIH0KICB9XSk7CgogIHJldHVybiBHZW5lcmljRXh0ZXJuYWxTZXJ2aWNlczsKfShfYXBwLkRlZmF1bHRFeHRlcm5hbFNlcnZpY2VzKTsKCl9hcHAuUERGVmlld2VyQXBwbGljYXRpb24uZXh0ZXJuYWxTZXJ2aWNlcyA9IEdlbmVyaWNFeHRlcm5hbFNlcnZpY2VzOwoKLyoqKi8gfSksCi8qIDM3ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuQmFzZVByZWZlcmVuY2VzID0gdm9pZCAwOwoKdmFyIF9yZWdlbmVyYXRvciA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX193ZWJwYWNrX3JlcXVpcmVfXygyKSk7Cgp2YXIgX2FwcF9vcHRpb25zID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ICJkZWZhdWx0Ijogb2JqIH07IH0KCmZ1bmN0aW9uIGFzeW5jR2VuZXJhdG9yU3RlcChnZW4sIHJlc29sdmUsIHJlamVjdCwgX25leHQsIF90aHJvdywga2V5LCBhcmcpIHsgdHJ5IHsgdmFyIGluZm8gPSBnZW5ba2V5XShhcmcpOyB2YXIgdmFsdWUgPSBpbmZvLnZhbHVlOyB9IGNhdGNoIChlcnJvcikgeyByZWplY3QoZXJyb3IpOyByZXR1cm47IH0gaWYgKGluZm8uZG9uZSkgeyByZXNvbHZlKHZhbHVlKTsgfSBlbHNlIHsgUHJvbWlzZS5yZXNvbHZlKHZhbHVlKS50aGVuKF9uZXh0LCBfdGhyb3cpOyB9IH0KCmZ1bmN0aW9uIF9hc3luY1RvR2VuZXJhdG9yKGZuKSB7IHJldHVybiBmdW5jdGlvbiAoKSB7IHZhciBzZWxmID0gdGhpcywgYXJncyA9IGFyZ3VtZW50czsgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsgdmFyIGdlbiA9IGZuLmFwcGx5KHNlbGYsIGFyZ3MpOyBmdW5jdGlvbiBfbmV4dCh2YWx1ZSkgeyBhc3luY0dlbmVyYXRvclN0ZXAoZ2VuLCByZXNvbHZlLCByZWplY3QsIF9uZXh0LCBfdGhyb3csICJuZXh0IiwgdmFsdWUpOyB9IGZ1bmN0aW9uIF90aHJvdyhlcnIpIHsgYXN5bmNHZW5lcmF0b3JTdGVwKGdlbiwgcmVzb2x2ZSwgcmVqZWN0LCBfbmV4dCwgX3Rocm93LCAidGhyb3ciLCBlcnIpOyB9IF9uZXh0KHVuZGVmaW5lZCk7IH0pOyB9OyB9CgpmdW5jdGlvbiBfdHlwZW9mKG9iaikgeyAiQGJhYmVsL2hlbHBlcnMgLSB0eXBlb2YiOyBpZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgU3ltYm9sLml0ZXJhdG9yID09PSAic3ltYm9sIikgeyBfdHlwZW9mID0gZnVuY3Rpb24gX3R5cGVvZihvYmopIHsgcmV0dXJuIHR5cGVvZiBvYmo7IH07IH0gZWxzZSB7IF90eXBlb2YgPSBmdW5jdGlvbiBfdHlwZW9mKG9iaikgeyByZXR1cm4gb2JqICYmIHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgb2JqLmNvbnN0cnVjdG9yID09PSBTeW1ib2wgJiYgb2JqICE9PSBTeW1ib2wucHJvdG90eXBlID8gInN5bWJvbCIgOiB0eXBlb2Ygb2JqOyB9OyB9IHJldHVybiBfdHlwZW9mKG9iaik7IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7IH0gfQoKZnVuY3Rpb24gX2RlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoInZhbHVlIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0KCmZ1bmN0aW9uIF9jcmVhdGVDbGFzcyhDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9Cgp2YXIgZGVmYXVsdFByZWZlcmVuY2VzID0gbnVsbDsKCmZ1bmN0aW9uIGdldERlZmF1bHRQcmVmZXJlbmNlcygpIHsKICBpZiAoIWRlZmF1bHRQcmVmZXJlbmNlcykgewogICAgZGVmYXVsdFByZWZlcmVuY2VzID0gUHJvbWlzZS5yZXNvbHZlKHsKICAgICAgImN1cnNvclRvb2xPbkxvYWQiOiAwLAogICAgICAiZGVmYXVsdFpvb21WYWx1ZSI6ICIiLAogICAgICAiZGlzYWJsZVBhZ2VMYWJlbHMiOiBmYWxzZSwKICAgICAgImVuYWJsZVBlcm1pc3Npb25zIjogZmFsc2UsCiAgICAgICJlbmFibGVQcmludEF1dG9Sb3RhdGUiOiBmYWxzZSwKICAgICAgImVuYWJsZVdlYkdMIjogZmFsc2UsCiAgICAgICJleHRlcm5hbExpbmtUYXJnZXQiOiAwLAogICAgICAiaGlzdG9yeVVwZGF0ZVVybCI6IGZhbHNlLAogICAgICAiaWdub3JlRGVzdGluYXRpb25ab29tIjogZmFsc2UsCiAgICAgICJwZGZCdWdFbmFibGVkIjogZmFsc2UsCiAgICAgICJyZW5kZXJlciI6ICJjYW52YXMiLAogICAgICAicmVuZGVySW50ZXJhY3RpdmVGb3JtcyI6IGZhbHNlLAogICAgICAic2lkZWJhclZpZXdPbkxvYWQiOiAtMSwKICAgICAgInNjcm9sbE1vZGVPbkxvYWQiOiAtMSwKICAgICAgInNwcmVhZE1vZGVPbkxvYWQiOiAtMSwKICAgICAgInRleHRMYXllck1vZGUiOiAxLAogICAgICAidXNlT25seUNzc1pvb20iOiBmYWxzZSwKICAgICAgInZpZXdPbkxvYWQiOiAwLAogICAgICAiZGlzYWJsZUF1dG9GZXRjaCI6IGZhbHNlLAogICAgICAiZGlzYWJsZUZvbnRGYWNlIjogZmFsc2UsCiAgICAgICJkaXNhYmxlUmFuZ2UiOiBmYWxzZSwKICAgICAgImRpc2FibGVTdHJlYW0iOiBmYWxzZQogICAgfSk7CiAgfQoKICByZXR1cm4gZGVmYXVsdFByZWZlcmVuY2VzOwp9Cgp2YXIgQmFzZVByZWZlcmVuY2VzID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICBmdW5jdGlvbiBCYXNlUHJlZmVyZW5jZXMoKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBCYXNlUHJlZmVyZW5jZXMpOwoKICAgIGlmICh0aGlzLmNvbnN0cnVjdG9yID09PSBCYXNlUHJlZmVyZW5jZXMpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgaW5pdGlhbGl6ZSBCYXNlUHJlZmVyZW5jZXMuIik7CiAgICB9CgogICAgdGhpcy5wcmVmcyA9IG51bGw7CiAgICB0aGlzLl9pbml0aWFsaXplZFByb21pc2UgPSBnZXREZWZhdWx0UHJlZmVyZW5jZXMoKS50aGVuKGZ1bmN0aW9uIChkZWZhdWx0cykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoX3RoaXMsICJkZWZhdWx0cyIsIHsKICAgICAgICB2YWx1ZTogT2JqZWN0LmZyZWV6ZShkZWZhdWx0cyksCiAgICAgICAgd3JpdGFibGU6IGZhbHNlLAogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZQogICAgICB9KTsKICAgICAgX3RoaXMucHJlZnMgPSBPYmplY3QuYXNzaWduKE9iamVjdC5jcmVhdGUobnVsbCksIGRlZmF1bHRzKTsKICAgICAgcmV0dXJuIF90aGlzLl9yZWFkRnJvbVN0b3JhZ2UoZGVmYXVsdHMpOwogICAgfSkudGhlbihmdW5jdGlvbiAocHJlZnMpIHsKICAgICAgaWYgKCFwcmVmcykgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgZm9yICh2YXIgbmFtZSBpbiBwcmVmcykgewogICAgICAgIHZhciBkZWZhdWx0VmFsdWUgPSBfdGhpcy5kZWZhdWx0c1tuYW1lXSwKICAgICAgICAgICAgcHJlZlZhbHVlID0gcHJlZnNbbmFtZV07CgogICAgICAgIGlmIChkZWZhdWx0VmFsdWUgPT09IHVuZGVmaW5lZCB8fCBfdHlwZW9mKHByZWZWYWx1ZSkgIT09IF90eXBlb2YoZGVmYXVsdFZhbHVlKSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICBfdGhpcy5wcmVmc1tuYW1lXSA9IHByZWZWYWx1ZTsKICAgICAgfQogICAgfSk7CiAgfQoKICBfY3JlYXRlQ2xhc3MoQmFzZVByZWZlcmVuY2VzLCBbewogICAga2V5OiAiX3dyaXRlVG9TdG9yYWdlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfd3JpdGVUb1N0b3JhZ2UyID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JbImRlZmF1bHQiXS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUocHJlZk9iaikgewogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JbImRlZmF1bHQiXS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUkKF9jb250ZXh0KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0LnByZXYgPSBfY29udGV4dC5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJOb3QgaW1wbGVtZW50ZWQ6IF93cml0ZVRvU3RvcmFnZSIpOwoKICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gX3dyaXRlVG9TdG9yYWdlKF94KSB7CiAgICAgICAgcmV0dXJuIF93cml0ZVRvU3RvcmFnZTIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIF93cml0ZVRvU3RvcmFnZTsKICAgIH0oKQogIH0sIHsKICAgIGtleTogIl9yZWFkRnJvbVN0b3JhZ2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9yZWFkRnJvbVN0b3JhZ2UyID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JbImRlZmF1bHQiXS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUyKHByZWZPYmopIHsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ud3JhcChmdW5jdGlvbiBfY2FsbGVlMiQoX2NvbnRleHQyKSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0Mi5wcmV2ID0gX2NvbnRleHQyLm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk5vdCBpbXBsZW1lbnRlZDogX3JlYWRGcm9tU3RvcmFnZSIpOwoKICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTIpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBfcmVhZEZyb21TdG9yYWdlKF94MikgewogICAgICAgIHJldHVybiBfcmVhZEZyb21TdG9yYWdlMi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gX3JlYWRGcm9tU3RvcmFnZTsKICAgIH0oKQogIH0sIHsKICAgIGtleTogInJlc2V0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfcmVzZXQgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclsiZGVmYXVsdCJdLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTMoKSB7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclsiZGVmYXVsdCJdLndyYXAoZnVuY3Rpb24gX2NhbGxlZTMkKF9jb250ZXh0MykgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDMucHJldiA9IF9jb250ZXh0My5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgX2NvbnRleHQzLm5leHQgPSAyOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2luaXRpYWxpemVkUHJvbWlzZTsKCiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgdGhpcy5wcmVmcyA9IE9iamVjdC5hc3NpZ24oT2JqZWN0LmNyZWF0ZShudWxsKSwgdGhpcy5kZWZhdWx0cyk7CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzLmFicnVwdCgicmV0dXJuIiwgdGhpcy5fd3JpdGVUb1N0b3JhZ2UodGhpcy5kZWZhdWx0cykpOwoKICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTMsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiByZXNldCgpIHsKICAgICAgICByZXR1cm4gX3Jlc2V0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiByZXNldDsKICAgIH0oKQogIH0sIHsKICAgIGtleTogInNldCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3NldCA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ubWFyayhmdW5jdGlvbiBfY2FsbGVlNChuYW1lLCB2YWx1ZSkgewogICAgICAgIHZhciBkZWZhdWx0VmFsdWUsIHZhbHVlVHlwZSwgZGVmYXVsdFR5cGU7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclsiZGVmYXVsdCJdLndyYXAoZnVuY3Rpb24gX2NhbGxlZTQkKF9jb250ZXh0NCkgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDQucHJldiA9IF9jb250ZXh0NC5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgX2NvbnRleHQ0Lm5leHQgPSAyOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2luaXRpYWxpemVkUHJvbWlzZTsKCiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgZGVmYXVsdFZhbHVlID0gdGhpcy5kZWZhdWx0c1tuYW1lXTsKCiAgICAgICAgICAgICAgICBpZiAoIShkZWZhdWx0VmFsdWUgPT09IHVuZGVmaW5lZCkpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ0Lm5leHQgPSA3OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNldCBwcmVmZXJlbmNlOiBcIiIuY29uY2F0KG5hbWUsICJcIiBpcyB1bmRlZmluZWQuIikpOwoKICAgICAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgICAgICBpZiAoISh2YWx1ZSA9PT0gdW5kZWZpbmVkKSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDQubmV4dCA9IDk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2V0IHByZWZlcmVuY2U6IG5vIHZhbHVlIGlzIHNwZWNpZmllZC4iKTsKCiAgICAgICAgICAgICAgY2FzZSA5OgogICAgICAgICAgICAgICAgdmFsdWVUeXBlID0gX3R5cGVvZih2YWx1ZSk7CiAgICAgICAgICAgICAgICBkZWZhdWx0VHlwZSA9IF90eXBlb2YoZGVmYXVsdFZhbHVlKTsKCiAgICAgICAgICAgICAgICBpZiAoISh2YWx1ZVR5cGUgIT09IGRlZmF1bHRUeXBlKSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDQubmV4dCA9IDE5OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoISh2YWx1ZVR5cGUgPT09ICJudW1iZXIiICYmIGRlZmF1bHRUeXBlID09PSAic3RyaW5nIikpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ0Lm5leHQgPSAxNjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS50b1N0cmluZygpOwogICAgICAgICAgICAgICAgX2NvbnRleHQ0Lm5leHQgPSAxNzsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICBjYXNlIDE2OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTZXQgcHJlZmVyZW5jZTogXCIiLmNvbmNhdCh2YWx1ZSwgIlwiIGlzIGEgIikuY29uY2F0KHZhbHVlVHlwZSwgIiwgIikgKyAiZXhwZWN0ZWQgYSAiLmNvbmNhdChkZWZhdWx0VHlwZSwgIi4iKSk7CgogICAgICAgICAgICAgIGNhc2UgMTc6CiAgICAgICAgICAgICAgICBfY29udGV4dDQubmV4dCA9IDIxOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGNhc2UgMTk6CiAgICAgICAgICAgICAgICBpZiAoISh2YWx1ZVR5cGUgPT09ICJudW1iZXIiICYmICFOdW1iZXIuaXNJbnRlZ2VyKHZhbHVlKSkpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ0Lm5leHQgPSAyMTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTZXQgcHJlZmVyZW5jZTogXCIiLmNvbmNhdCh2YWx1ZSwgIlwiIG11c3QgYmUgYW4gaW50ZWdlci4iKSk7CgogICAgICAgICAgICAgIGNhc2UgMjE6CiAgICAgICAgICAgICAgICB0aGlzLnByZWZzW25hbWVdID0gdmFsdWU7CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ0LmFicnVwdCgicmV0dXJuIiwgdGhpcy5fd3JpdGVUb1N0b3JhZ2UodGhpcy5wcmVmcykpOwoKICAgICAgICAgICAgICBjYXNlIDIzOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ0LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWU0LCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gc2V0KF94MywgX3g0KSB7CiAgICAgICAgcmV0dXJuIF9zZXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHNldDsKICAgIH0oKQogIH0sIHsKICAgIGtleTogImdldCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX2dldCA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ubWFyayhmdW5jdGlvbiBfY2FsbGVlNShuYW1lKSB7CiAgICAgICAgdmFyIGRlZmF1bHRWYWx1ZSwgcHJlZlZhbHVlOwogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JbImRlZmF1bHQiXS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU1JChfY29udGV4dDUpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ1LnByZXYgPSBfY29udGV4dDUubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIF9jb250ZXh0NS5uZXh0ID0gMjsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9pbml0aWFsaXplZFByb21pc2U7CgogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIGRlZmF1bHRWYWx1ZSA9IHRoaXMuZGVmYXVsdHNbbmFtZV07CgogICAgICAgICAgICAgICAgaWYgKCEoZGVmYXVsdFZhbHVlID09PSB1bmRlZmluZWQpKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0NS5uZXh0ID0gNzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJHZXQgcHJlZmVyZW5jZTogXCIiLmNvbmNhdChuYW1lLCAiXCIgaXMgdW5kZWZpbmVkLiIpKTsKCiAgICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgICAgcHJlZlZhbHVlID0gdGhpcy5wcmVmc1tuYW1lXTsKCiAgICAgICAgICAgICAgICBpZiAoIShwcmVmVmFsdWUgIT09IHVuZGVmaW5lZCkpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ1Lm5leHQgPSAxMDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NS5hYnJ1cHQoInJldHVybiIsIHByZWZWYWx1ZSk7CgogICAgICAgICAgICAgIGNhc2UgMTA6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ1LmFicnVwdCgicmV0dXJuIiwgZGVmYXVsdFZhbHVlKTsKCiAgICAgICAgICAgICAgY2FzZSAxMToKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NS5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlNSwgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIGdldChfeDUpIHsKICAgICAgICByZXR1cm4gX2dldC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gZ2V0OwogICAgfSgpCiAgfSwgewogICAga2V5OiAiZ2V0QWxsIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfZ2V0QWxsID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JbImRlZmF1bHQiXS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU2KCkgewogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JbImRlZmF1bHQiXS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU2JChfY29udGV4dDYpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ2LnByZXYgPSBfY29udGV4dDYubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIF9jb250ZXh0Ni5uZXh0ID0gMjsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9pbml0aWFsaXplZFByb21pc2U7CgogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDYuYWJydXB0KCJyZXR1cm4iLCBPYmplY3QuYXNzaWduKE9iamVjdC5jcmVhdGUobnVsbCksIHRoaXMuZGVmYXVsdHMsIHRoaXMucHJlZnMpKTsKCiAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ2LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWU2LCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gZ2V0QWxsKCkgewogICAgICAgIHJldHVybiBfZ2V0QWxsLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBnZXRBbGw7CiAgICB9KCkKICB9XSk7CgogIHJldHVybiBCYXNlUHJlZmVyZW5jZXM7Cn0oKTsKCmV4cG9ydHMuQmFzZVByZWZlcmVuY2VzID0gQmFzZVByZWZlcmVuY2VzOwoKLyoqKi8gfSksCi8qIDM4ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuRG93bmxvYWRNYW5hZ2VyID0gdm9pZCAwOwoKdmFyIF9wZGZqc0xpYiA9IF9fd2VicGFja19yZXF1aXJlX18oOCk7Cgp2YXIgX3ZpZXdlcl9jb21wYXRpYmlsaXR5ID0gX193ZWJwYWNrX3JlcXVpcmVfXyg3KTsKCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7IH0gfQoKZnVuY3Rpb24gX2RlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoInZhbHVlIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0KCmZ1bmN0aW9uIF9jcmVhdGVDbGFzcyhDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9Cgo7CnZhciBESVNBQkxFX0NSRUFURV9PQkpFQ1RfVVJMID0gX3ZpZXdlcl9jb21wYXRpYmlsaXR5LnZpZXdlckNvbXBhdGliaWxpdHlQYXJhbXMuZGlzYWJsZUNyZWF0ZU9iamVjdFVSTCB8fCBmYWxzZTsKCmZ1bmN0aW9uIF9kb3dubG9hZChibG9iVXJsLCBmaWxlbmFtZSkgewogIHZhciBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwoKICBpZiAoIWEuY2xpY2spIHsKICAgIHRocm93IG5ldyBFcnJvcignRG93bmxvYWRNYW5hZ2VyOiAiYS5jbGljaygpIiBpcyBub3Qgc3VwcG9ydGVkLicpOwogIH0KCiAgYS5ocmVmID0gYmxvYlVybDsKICBhLnRhcmdldCA9ICJfcGFyZW50IjsKCiAgaWYgKCJkb3dubG9hZCIgaW4gYSkgewogICAgYS5kb3dubG9hZCA9IGZpbGVuYW1lOwogIH0KCiAgKGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KS5hcHBlbmRDaGlsZChhKTsKICBhLmNsaWNrKCk7CiAgYS5yZW1vdmUoKTsKfQoKdmFyIERvd25sb2FkTWFuYWdlciA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gRG93bmxvYWRNYW5hZ2VyKF9yZWYpIHsKICAgIHZhciBfcmVmJGRpc2FibGVDcmVhdGVPYmogPSBfcmVmLmRpc2FibGVDcmVhdGVPYmplY3RVUkwsCiAgICAgICAgZGlzYWJsZUNyZWF0ZU9iamVjdFVSTCA9IF9yZWYkZGlzYWJsZUNyZWF0ZU9iaiA9PT0gdm9pZCAwID8gRElTQUJMRV9DUkVBVEVfT0JKRUNUX1VSTCA6IF9yZWYkZGlzYWJsZUNyZWF0ZU9iajsKCiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgRG93bmxvYWRNYW5hZ2VyKTsKCiAgICB0aGlzLmRpc2FibGVDcmVhdGVPYmplY3RVUkwgPSBkaXNhYmxlQ3JlYXRlT2JqZWN0VVJMOwogIH0KCiAgX2NyZWF0ZUNsYXNzKERvd25sb2FkTWFuYWdlciwgW3sKICAgIGtleTogImRvd25sb2FkVXJsIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBkb3dubG9hZFVybCh1cmwsIGZpbGVuYW1lKSB7CiAgICAgIGlmICghKDAsIF9wZGZqc0xpYi5jcmVhdGVWYWxpZEFic29sdXRlVXJsKSh1cmwsICJodHRwOi8vZXhhbXBsZS5jb20iKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgX2Rvd25sb2FkKHVybCArICIjcGRmanMuYWN0aW9uPWRvd25sb2FkIiwgZmlsZW5hbWUpOwogICAgfQogIH0sIHsKICAgIGtleTogImRvd25sb2FkRGF0YSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZG93bmxvYWREYXRhKGRhdGEsIGZpbGVuYW1lLCBjb250ZW50VHlwZSkgewogICAgICBpZiAobmF2aWdhdG9yLm1zU2F2ZUJsb2IpIHsKICAgICAgICBuYXZpZ2F0b3IubXNTYXZlQmxvYihuZXcgQmxvYihbZGF0YV0sIHsKICAgICAgICAgIHR5cGU6IGNvbnRlbnRUeXBlCiAgICAgICAgfSksIGZpbGVuYW1lKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBibG9iVXJsID0gKDAsIF9wZGZqc0xpYi5jcmVhdGVPYmplY3RVUkwpKGRhdGEsIGNvbnRlbnRUeXBlLCB0aGlzLmRpc2FibGVDcmVhdGVPYmplY3RVUkwpOwoKICAgICAgX2Rvd25sb2FkKGJsb2JVcmwsIGZpbGVuYW1lKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJkb3dubG9hZCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZG93bmxvYWQoYmxvYiwgdXJsLCBmaWxlbmFtZSkgewogICAgICBpZiAobmF2aWdhdG9yLm1zU2F2ZUJsb2IpIHsKICAgICAgICBpZiAoIW5hdmlnYXRvci5tc1NhdmVCbG9iKGJsb2IsIGZpbGVuYW1lKSkgewogICAgICAgICAgdGhpcy5kb3dubG9hZFVybCh1cmwsIGZpbGVuYW1lKTsKICAgICAgICB9CgogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuZGlzYWJsZUNyZWF0ZU9iamVjdFVSTCkgewogICAgICAgIHRoaXMuZG93bmxvYWRVcmwodXJsLCBmaWxlbmFtZSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgYmxvYlVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7CgogICAgICBfZG93bmxvYWQoYmxvYlVybCwgZmlsZW5hbWUpOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIERvd25sb2FkTWFuYWdlcjsKfSgpOwoKZXhwb3J0cy5Eb3dubG9hZE1hbmFnZXIgPSBEb3dubG9hZE1hbmFnZXI7CgovKioqLyB9KSwKLyogMzkgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKInVzZSBzdHJpY3QiOwoKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKZXhwb3J0cy5HZW5lcmljTDEwbiA9IHZvaWQgMDsKCnZhciBfcmVnZW5lcmF0b3IgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9fd2VicGFja19yZXF1aXJlX18oMikpOwoKX193ZWJwYWNrX3JlcXVpcmVfXyg0MCk7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAiZGVmYXVsdCI6IG9iaiB9OyB9CgpmdW5jdGlvbiBhc3luY0dlbmVyYXRvclN0ZXAoZ2VuLCByZXNvbHZlLCByZWplY3QsIF9uZXh0LCBfdGhyb3csIGtleSwgYXJnKSB7IHRyeSB7IHZhciBpbmZvID0gZ2VuW2tleV0oYXJnKTsgdmFyIHZhbHVlID0gaW5mby52YWx1ZTsgfSBjYXRjaCAoZXJyb3IpIHsgcmVqZWN0KGVycm9yKTsgcmV0dXJuOyB9IGlmIChpbmZvLmRvbmUpIHsgcmVzb2x2ZSh2YWx1ZSk7IH0gZWxzZSB7IFByb21pc2UucmVzb2x2ZSh2YWx1ZSkudGhlbihfbmV4dCwgX3Rocm93KTsgfSB9CgpmdW5jdGlvbiBfYXN5bmNUb0dlbmVyYXRvcihmbikgeyByZXR1cm4gZnVuY3Rpb24gKCkgeyB2YXIgc2VsZiA9IHRoaXMsIGFyZ3MgPSBhcmd1bWVudHM7IHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7IHZhciBnZW4gPSBmbi5hcHBseShzZWxmLCBhcmdzKTsgZnVuY3Rpb24gX25leHQodmFsdWUpIHsgYXN5bmNHZW5lcmF0b3JTdGVwKGdlbiwgcmVzb2x2ZSwgcmVqZWN0LCBfbmV4dCwgX3Rocm93LCAibmV4dCIsIHZhbHVlKTsgfSBmdW5jdGlvbiBfdGhyb3coZXJyKSB7IGFzeW5jR2VuZXJhdG9yU3RlcChnZW4sIHJlc29sdmUsIHJlamVjdCwgX25leHQsIF90aHJvdywgInRocm93IiwgZXJyKTsgfSBfbmV4dCh1bmRlZmluZWQpOyB9KTsgfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsgfSB9CgpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfQoKZnVuY3Rpb24gX2NyZWF0ZUNsYXNzKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH0KCnZhciB3ZWJMMTBuID0gZG9jdW1lbnQud2ViTDEwbjsKCnZhciBHZW5lcmljTDEwbiA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gR2VuZXJpY0wxMG4obGFuZykgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEdlbmVyaWNMMTBuKTsKCiAgICB0aGlzLl9sYW5nID0gbGFuZzsKICAgIHRoaXMuX3JlYWR5ID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICB3ZWJMMTBuLnNldExhbmd1YWdlKGxhbmcsIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXNvbHZlKHdlYkwxMG4pOwogICAgICB9KTsKICAgIH0pOwogIH0KCiAgX2NyZWF0ZUNsYXNzKEdlbmVyaWNMMTBuLCBbewogICAga2V5OiAiZ2V0TGFuZ3VhZ2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9nZXRMYW5ndWFnZSA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ubWFyayhmdW5jdGlvbiBfY2FsbGVlKCkgewogICAgICAgIHZhciBsMTBuOwogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JbImRlZmF1bHQiXS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUkKF9jb250ZXh0KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0LnByZXYgPSBfY29udGV4dC5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDI7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcmVhZHk7CgogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIGwxMG4gPSBfY29udGV4dC5zZW50OwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0LmFicnVwdCgicmV0dXJuIiwgbDEwbi5nZXRMYW5ndWFnZSgpKTsKCiAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZSwgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIGdldExhbmd1YWdlKCkgewogICAgICAgIHJldHVybiBfZ2V0TGFuZ3VhZ2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGdldExhbmd1YWdlOwogICAgfSgpCiAgfSwgewogICAga2V5OiAiZ2V0RGlyZWN0aW9uIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfZ2V0RGlyZWN0aW9uID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JbImRlZmF1bHQiXS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUyKCkgewogICAgICAgIHZhciBsMTBuOwogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JbImRlZmF1bHQiXS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUyJChfY29udGV4dDIpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQyLnByZXYgPSBfY29udGV4dDIubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIF9jb250ZXh0Mi5uZXh0ID0gMjsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9yZWFkeTsKCiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgbDEwbiA9IF9jb250ZXh0Mi5zZW50OwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Mi5hYnJ1cHQoInJldHVybiIsIGwxMG4uZ2V0RGlyZWN0aW9uKCkpOwoKICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTIsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBnZXREaXJlY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIF9nZXREaXJlY3Rpb24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGdldERpcmVjdGlvbjsKICAgIH0oKQogIH0sIHsKICAgIGtleTogImdldCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX2dldCA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ubWFyayhmdW5jdGlvbiBfY2FsbGVlMyhwcm9wZXJ0eSwgYXJncywgZmFsbGJhY2spIHsKICAgICAgICB2YXIgbDEwbjsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yWyJkZWZhdWx0Il0ud3JhcChmdW5jdGlvbiBfY2FsbGVlMyQoX2NvbnRleHQzKSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0My5wcmV2ID0gX2NvbnRleHQzLm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDI7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcmVhZHk7CgogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIGwxMG4gPSBfY29udGV4dDMuc2VudDsKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMuYWJydXB0KCJyZXR1cm4iLCBsMTBuLmdldChwcm9wZXJ0eSwgYXJncywgZmFsbGJhY2spKTsKCiAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzLnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWUzLCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gZ2V0KF94LCBfeDIsIF94MykgewogICAgICAgIHJldHVybiBfZ2V0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBnZXQ7CiAgICB9KCkKICB9LCB7CiAgICBrZXk6ICJ0cmFuc2xhdGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF90cmFuc2xhdGUgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclsiZGVmYXVsdCJdLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTQoZWxlbWVudCkgewogICAgICAgIHZhciBsMTBuOwogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JbImRlZmF1bHQiXS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU0JChfY29udGV4dDQpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ0LnByZXYgPSBfY29udGV4dDQubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIF9jb250ZXh0NC5uZXh0ID0gMjsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9yZWFkeTsKCiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgbDEwbiA9IF9jb250ZXh0NC5zZW50OwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NC5hYnJ1cHQoInJldHVybiIsIGwxMG4udHJhbnNsYXRlKGVsZW1lbnQpKTsKCiAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ0LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWU0LCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gdHJhbnNsYXRlKF94NCkgewogICAgICAgIHJldHVybiBfdHJhbnNsYXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0cmFuc2xhdGU7CiAgICB9KCkKICB9XSk7CgogIHJldHVybiBHZW5lcmljTDEwbjsKfSgpOwoKZXhwb3J0cy5HZW5lcmljTDEwbiA9IEdlbmVyaWNMMTBuOwoKLyoqKi8gfSksCi8qIDQwICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCiJ1c2Ugc3RyaWN0IjsKCgpkb2N1bWVudC53ZWJMMTBuID0gZnVuY3Rpb24gKHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCkgewogIHZhciBnTDEwbkRhdGEgPSB7fTsKICB2YXIgZ1RleHREYXRhID0gJyc7CiAgdmFyIGdUZXh0UHJvcCA9ICd0ZXh0Q29udGVudCc7CiAgdmFyIGdMYW5ndWFnZSA9ICcnOwogIHZhciBnTWFjcm9zID0ge307CiAgdmFyIGdSZWFkeVN0YXRlID0gJ2xvYWRpbmcnOwogIHZhciBnQXN5bmNSZXNvdXJjZUxvYWRpbmcgPSB0cnVlOwoKICBmdW5jdGlvbiBnZXRMMTBuUmVzb3VyY2VMaW5rcygpIHsKICAgIHJldHVybiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdsaW5rW3R5cGU9ImFwcGxpY2F0aW9uL2wxMG4iXScpOwogIH0KCiAgZnVuY3Rpb24gZ2V0TDEwbkRpY3Rpb25hcnkoKSB7CiAgICB2YXIgc2NyaXB0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcignc2NyaXB0W3R5cGU9ImFwcGxpY2F0aW9uL2wxMG4iXScpOwogICAgcmV0dXJuIHNjcmlwdCA/IEpTT04ucGFyc2Uoc2NyaXB0LmlubmVySFRNTCkgOiBudWxsOwogIH0KCiAgZnVuY3Rpb24gZ2V0VHJhbnNsYXRhYmxlQ2hpbGRyZW4oZWxlbWVudCkgewogICAgcmV0dXJuIGVsZW1lbnQgPyBlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJypbZGF0YS1sMTBuLWlkXScpIDogW107CiAgfQoKICBmdW5jdGlvbiBnZXRMMTBuQXR0cmlidXRlcyhlbGVtZW50KSB7CiAgICBpZiAoIWVsZW1lbnQpIHJldHVybiB7fTsKICAgIHZhciBsMTBuSWQgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgnZGF0YS1sMTBuLWlkJyk7CiAgICB2YXIgbDEwbkFyZ3MgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgnZGF0YS1sMTBuLWFyZ3MnKTsKICAgIHZhciBhcmdzID0ge307CgogICAgaWYgKGwxMG5BcmdzKSB7CiAgICAgIHRyeSB7CiAgICAgICAgYXJncyA9IEpTT04ucGFyc2UobDEwbkFyZ3MpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS53YXJuKCdjb3VsZCBub3QgcGFyc2UgYXJndW1lbnRzIGZvciAjJyArIGwxMG5JZCk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gewogICAgICBpZDogbDEwbklkLAogICAgICBhcmdzOiBhcmdzCiAgICB9OwogIH0KCiAgZnVuY3Rpb24geGhyTG9hZFRleHQodXJsLCBvblN1Y2Nlc3MsIG9uRmFpbHVyZSkgewogICAgb25TdWNjZXNzID0gb25TdWNjZXNzIHx8IGZ1bmN0aW9uIF9vblN1Y2Nlc3MoZGF0YSkge307CgogICAgb25GYWlsdXJlID0gb25GYWlsdXJlIHx8IGZ1bmN0aW9uIF9vbkZhaWx1cmUoKSB7fTsKCiAgICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICB4aHIub3BlbignR0VUJywgdXJsLCBnQXN5bmNSZXNvdXJjZUxvYWRpbmcpOwoKICAgIGlmICh4aHIub3ZlcnJpZGVNaW1lVHlwZSkgewogICAgICB4aHIub3ZlcnJpZGVNaW1lVHlwZSgndGV4dC9wbGFpbjsgY2hhcnNldD11dGYtOCcpOwogICAgfQoKICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PSA0KSB7CiAgICAgICAgaWYgKHhoci5zdGF0dXMgPT0gMjAwIHx8IHhoci5zdGF0dXMgPT09IDApIHsKICAgICAgICAgIG9uU3VjY2Vzcyh4aHIucmVzcG9uc2VUZXh0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgb25GYWlsdXJlKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIHhoci5vbmVycm9yID0gb25GYWlsdXJlOwogICAgeGhyLm9udGltZW91dCA9IG9uRmFpbHVyZTsKCiAgICB0cnkgewogICAgICB4aHIuc2VuZChudWxsKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgb25GYWlsdXJlKCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBwYXJzZVJlc291cmNlKGhyZWYsIGxhbmcsIHN1Y2Nlc3NDYWxsYmFjaywgZmFpbHVyZUNhbGxiYWNrKSB7CiAgICB2YXIgYmFzZVVSTCA9IGhyZWYucmVwbGFjZSgvW15cL10qJC8sICcnKSB8fCAnLi8nOwoKICAgIGZ1bmN0aW9uIGV2YWxTdHJpbmcodGV4dCkgewogICAgICBpZiAodGV4dC5sYXN0SW5kZXhPZignXFwnKSA8IDApIHJldHVybiB0ZXh0OwogICAgICByZXR1cm4gdGV4dC5yZXBsYWNlKC9cXFxcL2csICdcXCcpLnJlcGxhY2UoL1xcbi9nLCAnXG4nKS5yZXBsYWNlKC9cXHIvZywgJ1xyJykucmVwbGFjZSgvXFx0L2csICdcdCcpLnJlcGxhY2UoL1xcYi9nLCAnXGInKS5yZXBsYWNlKC9cXGYvZywgJ1xmJykucmVwbGFjZSgvXFx7L2csICd7JykucmVwbGFjZSgvXFx9L2csICd9JykucmVwbGFjZSgvXFwiL2csICciJykucmVwbGFjZSgvXFwnL2csICInIik7CiAgICB9CgogICAgZnVuY3Rpb24gcGFyc2VQcm9wZXJ0aWVzKHRleHQsIHBhcnNlZFByb3BlcnRpZXNDYWxsYmFjaykgewogICAgICB2YXIgZGljdGlvbmFyeSA9IHt9OwogICAgICB2YXIgcmVCbGFuayA9IC9eXHMqfFxzKiQvOwogICAgICB2YXIgcmVDb21tZW50ID0gL15ccyojfF5ccyokLzsKICAgICAgdmFyIHJlU2VjdGlvbiA9IC9eXHMqXFsoLiopXF1ccyokLzsKICAgICAgdmFyIHJlSW1wb3J0ID0gL15ccypAaW1wb3J0XHMrdXJsXCgoLiopXClccyokL2k7CiAgICAgIHZhciByZVNwbGl0ID0gL14oW149XHNdKilccyo9XHMqKC4rKSQvOwoKICAgICAgZnVuY3Rpb24gcGFyc2VSYXdMaW5lcyhyYXdUZXh0LCBleHRlbmRlZFN5bnRheCwgcGFyc2VkUmF3TGluZXNDYWxsYmFjaykgewogICAgICAgIHZhciBlbnRyaWVzID0gcmF3VGV4dC5yZXBsYWNlKHJlQmxhbmssICcnKS5zcGxpdCgvW1xyXG5dKy8pOwogICAgICAgIHZhciBjdXJyZW50TGFuZyA9ICcqJzsKICAgICAgICB2YXIgZ2VuZXJpY0xhbmcgPSBsYW5nLnNwbGl0KCctJywgMSlbMF07CiAgICAgICAgdmFyIHNraXBMYW5nID0gZmFsc2U7CiAgICAgICAgdmFyIG1hdGNoID0gJyc7CgogICAgICAgIGZ1bmN0aW9uIG5leHRFbnRyeSgpIHsKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIGlmICghZW50cmllcy5sZW5ndGgpIHsKICAgICAgICAgICAgICBwYXJzZWRSYXdMaW5lc0NhbGxiYWNrKCk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgbGluZSA9IGVudHJpZXMuc2hpZnQoKTsKICAgICAgICAgICAgaWYgKHJlQ29tbWVudC50ZXN0KGxpbmUpKSBjb250aW51ZTsKCiAgICAgICAgICAgIGlmIChleHRlbmRlZFN5bnRheCkgewogICAgICAgICAgICAgIG1hdGNoID0gcmVTZWN0aW9uLmV4ZWMobGluZSk7CgogICAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgICAgY3VycmVudExhbmcgPSBtYXRjaFsxXS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgc2tpcExhbmcgPSBjdXJyZW50TGFuZyAhPT0gJyonICYmIGN1cnJlbnRMYW5nICE9PSBsYW5nICYmIGN1cnJlbnRMYW5nICE9PSBnZW5lcmljTGFuZzsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoc2tpcExhbmcpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgbWF0Y2ggPSByZUltcG9ydC5leGVjKGxpbmUpOwoKICAgICAgICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgICAgIGxvYWRJbXBvcnQoYmFzZVVSTCArIG1hdGNoWzFdLCBuZXh0RW50cnkpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHRtcCA9IGxpbmUubWF0Y2gocmVTcGxpdCk7CgogICAgICAgICAgICBpZiAodG1wICYmIHRtcC5sZW5ndGggPT0gMykgewogICAgICAgICAgICAgIGRpY3Rpb25hcnlbdG1wWzFdXSA9IGV2YWxTdHJpbmcodG1wWzJdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbmV4dEVudHJ5KCk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGxvYWRJbXBvcnQodXJsLCBjYWxsYmFjaykgewogICAgICAgIHhockxvYWRUZXh0KHVybCwgZnVuY3Rpb24gKGNvbnRlbnQpIHsKICAgICAgICAgIHBhcnNlUmF3TGluZXMoY29udGVudCwgZmFsc2UsIGNhbGxiYWNrKTsKICAgICAgICB9LCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjb25zb2xlLndhcm4odXJsICsgJyBub3QgZm91bmQuJyk7CiAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBwYXJzZVJhd0xpbmVzKHRleHQsIHRydWUsIGZ1bmN0aW9uICgpIHsKICAgICAgICBwYXJzZWRQcm9wZXJ0aWVzQ2FsbGJhY2soZGljdGlvbmFyeSk7CiAgICAgIH0pOwogICAgfQoKICAgIHhockxvYWRUZXh0KGhyZWYsIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBnVGV4dERhdGEgKz0gcmVzcG9uc2U7CiAgICAgIHBhcnNlUHJvcGVydGllcyhyZXNwb25zZSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkgewogICAgICAgICAgdmFyIGlkLAogICAgICAgICAgICAgIHByb3AsCiAgICAgICAgICAgICAgaW5kZXggPSBrZXkubGFzdEluZGV4T2YoJy4nKTsKCiAgICAgICAgICBpZiAoaW5kZXggPiAwKSB7CiAgICAgICAgICAgIGlkID0ga2V5LnN1YnN0cmluZygwLCBpbmRleCk7CiAgICAgICAgICAgIHByb3AgPSBrZXkuc3Vic3RyaW5nKGluZGV4ICsgMSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZCA9IGtleTsKICAgICAgICAgICAgcHJvcCA9IGdUZXh0UHJvcDsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoIWdMMTBuRGF0YVtpZF0pIHsKICAgICAgICAgICAgZ0wxMG5EYXRhW2lkXSA9IHt9OwogICAgICAgICAgfQoKICAgICAgICAgIGdMMTBuRGF0YVtpZF1bcHJvcF0gPSBkYXRhW2tleV07CiAgICAgICAgfQoKICAgICAgICBpZiAoc3VjY2Vzc0NhbGxiYWNrKSB7CiAgICAgICAgICBzdWNjZXNzQ2FsbGJhY2soKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwgZmFpbHVyZUNhbGxiYWNrKTsKICB9CgogIGZ1bmN0aW9uIGxvYWRMb2NhbGUobGFuZywgY2FsbGJhY2spIHsKICAgIGlmIChsYW5nKSB7CiAgICAgIGxhbmcgPSBsYW5nLnRvTG93ZXJDYXNlKCk7CiAgICB9CgogICAgY2FsbGJhY2sgPSBjYWxsYmFjayB8fCBmdW5jdGlvbiBfY2FsbGJhY2soKSB7fTsKCiAgICBjbGVhcigpOwogICAgZ0xhbmd1YWdlID0gbGFuZzsKICAgIHZhciBsYW5nTGlua3MgPSBnZXRMMTBuUmVzb3VyY2VMaW5rcygpOwogICAgdmFyIGxhbmdDb3VudCA9IGxhbmdMaW5rcy5sZW5ndGg7CgogICAgaWYgKGxhbmdDb3VudCA9PT0gMCkgewogICAgICB2YXIgZGljdCA9IGdldEwxMG5EaWN0aW9uYXJ5KCk7CgogICAgICBpZiAoZGljdCAmJiBkaWN0LmxvY2FsZXMgJiYgZGljdC5kZWZhdWx0X2xvY2FsZSkgewogICAgICAgIGNvbnNvbGUubG9nKCd1c2luZyB0aGUgZW1iZWRkZWQgSlNPTiBkaXJlY3RvcnksIGVhcmx5IHdheSBvdXQnKTsKICAgICAgICBnTDEwbkRhdGEgPSBkaWN0LmxvY2FsZXNbbGFuZ107CgogICAgICAgIGlmICghZ0wxMG5EYXRhKSB7CiAgICAgICAgICB2YXIgZGVmYXVsdExvY2FsZSA9IGRpY3QuZGVmYXVsdF9sb2NhbGUudG9Mb3dlckNhc2UoKTsKCiAgICAgICAgICBmb3IgKHZhciBhbnlDYXNlTGFuZyBpbiBkaWN0LmxvY2FsZXMpIHsKICAgICAgICAgICAgYW55Q2FzZUxhbmcgPSBhbnlDYXNlTGFuZy50b0xvd2VyQ2FzZSgpOwoKICAgICAgICAgICAgaWYgKGFueUNhc2VMYW5nID09PSBsYW5nKSB7CiAgICAgICAgICAgICAgZ0wxMG5EYXRhID0gZGljdC5sb2NhbGVzW2xhbmddOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9IGVsc2UgaWYgKGFueUNhc2VMYW5nID09PSBkZWZhdWx0TG9jYWxlKSB7CiAgICAgICAgICAgICAgZ0wxMG5EYXRhID0gZGljdC5sb2NhbGVzW2RlZmF1bHRMb2NhbGVdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjYWxsYmFjaygpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUubG9nKCdubyByZXNvdXJjZSB0byBsb2FkLCBlYXJseSB3YXkgb3V0Jyk7CiAgICAgIH0KCiAgICAgIGdSZWFkeVN0YXRlID0gJ2NvbXBsZXRlJzsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBvblJlc291cmNlTG9hZGVkID0gbnVsbDsKICAgIHZhciBnUmVzb3VyY2VDb3VudCA9IDA7CgogICAgb25SZXNvdXJjZUxvYWRlZCA9IGZ1bmN0aW9uIG9uUmVzb3VyY2VMb2FkZWQoKSB7CiAgICAgIGdSZXNvdXJjZUNvdW50Kys7CgogICAgICBpZiAoZ1Jlc291cmNlQ291bnQgPj0gbGFuZ0NvdW50KSB7CiAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICBnUmVhZHlTdGF0ZSA9ICdjb21wbGV0ZSc7CiAgICAgIH0KICAgIH07CgogICAgZnVuY3Rpb24gTDEwblJlc291cmNlTGluayhsaW5rKSB7CiAgICAgIHZhciBocmVmID0gbGluay5ocmVmOwoKICAgICAgdGhpcy5sb2FkID0gZnVuY3Rpb24gKGxhbmcsIGNhbGxiYWNrKSB7CiAgICAgICAgcGFyc2VSZXNvdXJjZShocmVmLCBsYW5nLCBjYWxsYmFjaywgZnVuY3Rpb24gKCkgewogICAgICAgICAgY29uc29sZS53YXJuKGhyZWYgKyAnIG5vdCBmb3VuZC4nKTsKICAgICAgICAgIGNvbnNvbGUud2FybignIicgKyBsYW5nICsgJyIgcmVzb3VyY2Ugbm90IGZvdW5kJyk7CiAgICAgICAgICBnTGFuZ3VhZ2UgPSAnJzsKICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsYW5nQ291bnQ7IGkrKykgewogICAgICB2YXIgcmVzb3VyY2UgPSBuZXcgTDEwblJlc291cmNlTGluayhsYW5nTGlua3NbaV0pOwogICAgICByZXNvdXJjZS5sb2FkKGxhbmcsIG9uUmVzb3VyY2VMb2FkZWQpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY2xlYXIoKSB7CiAgICBnTDEwbkRhdGEgPSB7fTsKICAgIGdUZXh0RGF0YSA9ICcnOwogICAgZ0xhbmd1YWdlID0gJyc7CiAgfQoKICBmdW5jdGlvbiBnZXRQbHVyYWxSdWxlcyhsYW5nKSB7CiAgICB2YXIgbG9jYWxlczJydWxlcyA9IHsKICAgICAgJ2FmJzogMywKICAgICAgJ2FrJzogNCwKICAgICAgJ2FtJzogNCwKICAgICAgJ2FyJzogMSwKICAgICAgJ2FzYSc6IDMsCiAgICAgICdheic6IDAsCiAgICAgICdiZSc6IDExLAogICAgICAnYmVtJzogMywKICAgICAgJ2Jleic6IDMsCiAgICAgICdiZyc6IDMsCiAgICAgICdiaCc6IDQsCiAgICAgICdibSc6IDAsCiAgICAgICdibic6IDMsCiAgICAgICdibyc6IDAsCiAgICAgICdicic6IDIwLAogICAgICAnYnJ4JzogMywKICAgICAgJ2JzJzogMTEsCiAgICAgICdjYSc6IDMsCiAgICAgICdjZ2cnOiAzLAogICAgICAnY2hyJzogMywKICAgICAgJ2NzJzogMTIsCiAgICAgICdjeSc6IDE3LAogICAgICAnZGEnOiAzLAogICAgICAnZGUnOiAzLAogICAgICAnZHYnOiAzLAogICAgICAnZHonOiAwLAogICAgICAnZWUnOiAzLAogICAgICAnZWwnOiAzLAogICAgICAnZW4nOiAzLAogICAgICAnZW8nOiAzLAogICAgICAnZXMnOiAzLAogICAgICAnZXQnOiAzLAogICAgICAnZXUnOiAzLAogICAgICAnZmEnOiAwLAogICAgICAnZmYnOiA1LAogICAgICAnZmknOiAzLAogICAgICAnZmlsJzogNCwKICAgICAgJ2ZvJzogMywKICAgICAgJ2ZyJzogNSwKICAgICAgJ2Z1cic6IDMsCiAgICAgICdmeSc6IDMsCiAgICAgICdnYSc6IDgsCiAgICAgICdnZCc6IDI0LAogICAgICAnZ2wnOiAzLAogICAgICAnZ3N3JzogMywKICAgICAgJ2d1JzogMywKICAgICAgJ2d1dyc6IDQsCiAgICAgICdndic6IDIzLAogICAgICAnaGEnOiAzLAogICAgICAnaGF3JzogMywKICAgICAgJ2hlJzogMiwKICAgICAgJ2hpJzogNCwKICAgICAgJ2hyJzogMTEsCiAgICAgICdodSc6IDAsCiAgICAgICdpZCc6IDAsCiAgICAgICdpZyc6IDAsCiAgICAgICdpaSc6IDAsCiAgICAgICdpcyc6IDMsCiAgICAgICdpdCc6IDMsCiAgICAgICdpdSc6IDcsCiAgICAgICdqYSc6IDAsCiAgICAgICdqbWMnOiAzLAogICAgICAnanYnOiAwLAogICAgICAna2EnOiAwLAogICAgICAna2FiJzogNSwKICAgICAgJ2thaic6IDMsCiAgICAgICdrY2cnOiAzLAogICAgICAna2RlJzogMCwKICAgICAgJ2tlYSc6IDAsCiAgICAgICdrayc6IDMsCiAgICAgICdrbCc6IDMsCiAgICAgICdrbSc6IDAsCiAgICAgICdrbic6IDAsCiAgICAgICdrbyc6IDAsCiAgICAgICdrc2InOiAzLAogICAgICAna3NoJzogMjEsCiAgICAgICdrdSc6IDMsCiAgICAgICdrdyc6IDcsCiAgICAgICdsYWcnOiAxOCwKICAgICAgJ2xiJzogMywKICAgICAgJ2xnJzogMywKICAgICAgJ2xuJzogNCwKICAgICAgJ2xvJzogMCwKICAgICAgJ2x0JzogMTAsCiAgICAgICdsdic6IDYsCiAgICAgICdtYXMnOiAzLAogICAgICAnbWcnOiA0LAogICAgICAnbWsnOiAxNiwKICAgICAgJ21sJzogMywKICAgICAgJ21uJzogMywKICAgICAgJ21vJzogOSwKICAgICAgJ21yJzogMywKICAgICAgJ21zJzogMCwKICAgICAgJ210JzogMTUsCiAgICAgICdteSc6IDAsCiAgICAgICduYWgnOiAzLAogICAgICAnbmFxJzogNywKICAgICAgJ25iJzogMywKICAgICAgJ25kJzogMywKICAgICAgJ25lJzogMywKICAgICAgJ25sJzogMywKICAgICAgJ25uJzogMywKICAgICAgJ25vJzogMywKICAgICAgJ25yJzogMywKICAgICAgJ25zbyc6IDQsCiAgICAgICdueSc6IDMsCiAgICAgICdueW4nOiAzLAogICAgICAnb20nOiAzLAogICAgICAnb3InOiAzLAogICAgICAncGEnOiAzLAogICAgICAncGFwJzogMywKICAgICAgJ3BsJzogMTMsCiAgICAgICdwcyc6IDMsCiAgICAgICdwdCc6IDMsCiAgICAgICdybSc6IDMsCiAgICAgICdybyc6IDksCiAgICAgICdyb2YnOiAzLAogICAgICAncnUnOiAxMSwKICAgICAgJ3J3ayc6IDMsCiAgICAgICdzYWgnOiAwLAogICAgICAnc2FxJzogMywKICAgICAgJ3NlJzogNywKICAgICAgJ3NlaCc6IDMsCiAgICAgICdzZXMnOiAwLAogICAgICAnc2cnOiAwLAogICAgICAnc2gnOiAxMSwKICAgICAgJ3NoaSc6IDE5LAogICAgICAnc2snOiAxMiwKICAgICAgJ3NsJzogMTQsCiAgICAgICdzbWEnOiA3LAogICAgICAnc21pJzogNywKICAgICAgJ3Ntaic6IDcsCiAgICAgICdzbW4nOiA3LAogICAgICAnc21zJzogNywKICAgICAgJ3NuJzogMywKICAgICAgJ3NvJzogMywKICAgICAgJ3NxJzogMywKICAgICAgJ3NyJzogMTEsCiAgICAgICdzcyc6IDMsCiAgICAgICdzc3knOiAzLAogICAgICAnc3QnOiAzLAogICAgICAnc3YnOiAzLAogICAgICAnc3cnOiAzLAogICAgICAnc3lyJzogMywKICAgICAgJ3RhJzogMywKICAgICAgJ3RlJzogMywKICAgICAgJ3Rlbyc6IDMsCiAgICAgICd0aCc6IDAsCiAgICAgICd0aSc6IDQsCiAgICAgICd0aWcnOiAzLAogICAgICAndGsnOiAzLAogICAgICAndGwnOiA0LAogICAgICAndG4nOiAzLAogICAgICAndG8nOiAwLAogICAgICAndHInOiAwLAogICAgICAndHMnOiAzLAogICAgICAndHptJzogMjIsCiAgICAgICd1ayc6IDExLAogICAgICAndXInOiAzLAogICAgICAndmUnOiAzLAogICAgICAndmknOiAwLAogICAgICAndnVuJzogMywKICAgICAgJ3dhJzogNCwKICAgICAgJ3dhZSc6IDMsCiAgICAgICd3byc6IDAsCiAgICAgICd4aCc6IDMsCiAgICAgICd4b2cnOiAzLAogICAgICAneW8nOiAwLAogICAgICAnemgnOiAwLAogICAgICAnenUnOiAzCiAgICB9OwoKICAgIGZ1bmN0aW9uIGlzSW4obiwgbGlzdCkgewogICAgICByZXR1cm4gbGlzdC5pbmRleE9mKG4pICE9PSAtMTsKICAgIH0KCiAgICBmdW5jdGlvbiBpc0JldHdlZW4obiwgc3RhcnQsIGVuZCkgewogICAgICByZXR1cm4gc3RhcnQgPD0gbiAmJiBuIDw9IGVuZDsKICAgIH0KCiAgICB2YXIgcGx1cmFsUnVsZXMgPSB7CiAgICAgICcwJzogZnVuY3Rpb24gXyhuKSB7CiAgICAgICAgcmV0dXJuICdvdGhlcic7CiAgICAgIH0sCiAgICAgICcxJzogZnVuY3Rpb24gXyhuKSB7CiAgICAgICAgaWYgKGlzQmV0d2VlbihuICUgMTAwLCAzLCAxMCkpIHJldHVybiAnZmV3JzsKICAgICAgICBpZiAobiA9PT0gMCkgcmV0dXJuICd6ZXJvJzsKICAgICAgICBpZiAoaXNCZXR3ZWVuKG4gJSAxMDAsIDExLCA5OSkpIHJldHVybiAnbWFueSc7CiAgICAgICAgaWYgKG4gPT0gMikgcmV0dXJuICd0d28nOwogICAgICAgIGlmIChuID09IDEpIHJldHVybiAnb25lJzsKICAgICAgICByZXR1cm4gJ290aGVyJzsKICAgICAgfSwKICAgICAgJzInOiBmdW5jdGlvbiBfKG4pIHsKICAgICAgICBpZiAobiAhPT0gMCAmJiBuICUgMTAgPT09IDApIHJldHVybiAnbWFueSc7CiAgICAgICAgaWYgKG4gPT0gMikgcmV0dXJuICd0d28nOwogICAgICAgIGlmIChuID09IDEpIHJldHVybiAnb25lJzsKICAgICAgICByZXR1cm4gJ290aGVyJzsKICAgICAgfSwKICAgICAgJzMnOiBmdW5jdGlvbiBfKG4pIHsKICAgICAgICBpZiAobiA9PSAxKSByZXR1cm4gJ29uZSc7CiAgICAgICAgcmV0dXJuICdvdGhlcic7CiAgICAgIH0sCiAgICAgICc0JzogZnVuY3Rpb24gXyhuKSB7CiAgICAgICAgaWYgKGlzQmV0d2VlbihuLCAwLCAxKSkgcmV0dXJuICdvbmUnOwogICAgICAgIHJldHVybiAnb3RoZXInOwogICAgICB9LAogICAgICAnNSc6IGZ1bmN0aW9uIF8obikgewogICAgICAgIGlmIChpc0JldHdlZW4obiwgMCwgMikgJiYgbiAhPSAyKSByZXR1cm4gJ29uZSc7CiAgICAgICAgcmV0dXJuICdvdGhlcic7CiAgICAgIH0sCiAgICAgICc2JzogZnVuY3Rpb24gXyhuKSB7CiAgICAgICAgaWYgKG4gPT09IDApIHJldHVybiAnemVybyc7CiAgICAgICAgaWYgKG4gJSAxMCA9PSAxICYmIG4gJSAxMDAgIT0gMTEpIHJldHVybiAnb25lJzsKICAgICAgICByZXR1cm4gJ290aGVyJzsKICAgICAgfSwKICAgICAgJzcnOiBmdW5jdGlvbiBfKG4pIHsKICAgICAgICBpZiAobiA9PSAyKSByZXR1cm4gJ3R3byc7CiAgICAgICAgaWYgKG4gPT0gMSkgcmV0dXJuICdvbmUnOwogICAgICAgIHJldHVybiAnb3RoZXInOwogICAgICB9LAogICAgICAnOCc6IGZ1bmN0aW9uIF8obikgewogICAgICAgIGlmIChpc0JldHdlZW4obiwgMywgNikpIHJldHVybiAnZmV3JzsKICAgICAgICBpZiAoaXNCZXR3ZWVuKG4sIDcsIDEwKSkgcmV0dXJuICdtYW55JzsKICAgICAgICBpZiAobiA9PSAyKSByZXR1cm4gJ3R3byc7CiAgICAgICAgaWYgKG4gPT0gMSkgcmV0dXJuICdvbmUnOwogICAgICAgIHJldHVybiAnb3RoZXInOwogICAgICB9LAogICAgICAnOSc6IGZ1bmN0aW9uIF8obikgewogICAgICAgIGlmIChuID09PSAwIHx8IG4gIT0gMSAmJiBpc0JldHdlZW4obiAlIDEwMCwgMSwgMTkpKSByZXR1cm4gJ2Zldyc7CiAgICAgICAgaWYgKG4gPT0gMSkgcmV0dXJuICdvbmUnOwogICAgICAgIHJldHVybiAnb3RoZXInOwogICAgICB9LAogICAgICAnMTAnOiBmdW5jdGlvbiBfKG4pIHsKICAgICAgICBpZiAoaXNCZXR3ZWVuKG4gJSAxMCwgMiwgOSkgJiYgIWlzQmV0d2VlbihuICUgMTAwLCAxMSwgMTkpKSByZXR1cm4gJ2Zldyc7CiAgICAgICAgaWYgKG4gJSAxMCA9PSAxICYmICFpc0JldHdlZW4obiAlIDEwMCwgMTEsIDE5KSkgcmV0dXJuICdvbmUnOwogICAgICAgIHJldHVybiAnb3RoZXInOwogICAgICB9LAogICAgICAnMTEnOiBmdW5jdGlvbiBfKG4pIHsKICAgICAgICBpZiAoaXNCZXR3ZWVuKG4gJSAxMCwgMiwgNCkgJiYgIWlzQmV0d2VlbihuICUgMTAwLCAxMiwgMTQpKSByZXR1cm4gJ2Zldyc7CiAgICAgICAgaWYgKG4gJSAxMCA9PT0gMCB8fCBpc0JldHdlZW4obiAlIDEwLCA1LCA5KSB8fCBpc0JldHdlZW4obiAlIDEwMCwgMTEsIDE0KSkgcmV0dXJuICdtYW55JzsKICAgICAgICBpZiAobiAlIDEwID09IDEgJiYgbiAlIDEwMCAhPSAxMSkgcmV0dXJuICdvbmUnOwogICAgICAgIHJldHVybiAnb3RoZXInOwogICAgICB9LAogICAgICAnMTInOiBmdW5jdGlvbiBfKG4pIHsKICAgICAgICBpZiAoaXNCZXR3ZWVuKG4sIDIsIDQpKSByZXR1cm4gJ2Zldyc7CiAgICAgICAgaWYgKG4gPT0gMSkgcmV0dXJuICdvbmUnOwogICAgICAgIHJldHVybiAnb3RoZXInOwogICAgICB9LAogICAgICAnMTMnOiBmdW5jdGlvbiBfKG4pIHsKICAgICAgICBpZiAoaXNCZXR3ZWVuKG4gJSAxMCwgMiwgNCkgJiYgIWlzQmV0d2VlbihuICUgMTAwLCAxMiwgMTQpKSByZXR1cm4gJ2Zldyc7CiAgICAgICAgaWYgKG4gIT0gMSAmJiBpc0JldHdlZW4obiAlIDEwLCAwLCAxKSB8fCBpc0JldHdlZW4obiAlIDEwLCA1LCA5KSB8fCBpc0JldHdlZW4obiAlIDEwMCwgMTIsIDE0KSkgcmV0dXJuICdtYW55JzsKICAgICAgICBpZiAobiA9PSAxKSByZXR1cm4gJ29uZSc7CiAgICAgICAgcmV0dXJuICdvdGhlcic7CiAgICAgIH0sCiAgICAgICcxNCc6IGZ1bmN0aW9uIF8obikgewogICAgICAgIGlmIChpc0JldHdlZW4obiAlIDEwMCwgMywgNCkpIHJldHVybiAnZmV3JzsKICAgICAgICBpZiAobiAlIDEwMCA9PSAyKSByZXR1cm4gJ3R3byc7CiAgICAgICAgaWYgKG4gJSAxMDAgPT0gMSkgcmV0dXJuICdvbmUnOwogICAgICAgIHJldHVybiAnb3RoZXInOwogICAgICB9LAogICAgICAnMTUnOiBmdW5jdGlvbiBfKG4pIHsKICAgICAgICBpZiAobiA9PT0gMCB8fCBpc0JldHdlZW4obiAlIDEwMCwgMiwgMTApKSByZXR1cm4gJ2Zldyc7CiAgICAgICAgaWYgKGlzQmV0d2VlbihuICUgMTAwLCAxMSwgMTkpKSByZXR1cm4gJ21hbnknOwogICAgICAgIGlmIChuID09IDEpIHJldHVybiAnb25lJzsKICAgICAgICByZXR1cm4gJ290aGVyJzsKICAgICAgfSwKICAgICAgJzE2JzogZnVuY3Rpb24gXyhuKSB7CiAgICAgICAgaWYgKG4gJSAxMCA9PSAxICYmIG4gIT0gMTEpIHJldHVybiAnb25lJzsKICAgICAgICByZXR1cm4gJ290aGVyJzsKICAgICAgfSwKICAgICAgJzE3JzogZnVuY3Rpb24gXyhuKSB7CiAgICAgICAgaWYgKG4gPT0gMykgcmV0dXJuICdmZXcnOwogICAgICAgIGlmIChuID09PSAwKSByZXR1cm4gJ3plcm8nOwogICAgICAgIGlmIChuID09IDYpIHJldHVybiAnbWFueSc7CiAgICAgICAgaWYgKG4gPT0gMikgcmV0dXJuICd0d28nOwogICAgICAgIGlmIChuID09IDEpIHJldHVybiAnb25lJzsKICAgICAgICByZXR1cm4gJ290aGVyJzsKICAgICAgfSwKICAgICAgJzE4JzogZnVuY3Rpb24gXyhuKSB7CiAgICAgICAgaWYgKG4gPT09IDApIHJldHVybiAnemVybyc7CiAgICAgICAgaWYgKGlzQmV0d2VlbihuLCAwLCAyKSAmJiBuICE9PSAwICYmIG4gIT0gMikgcmV0dXJuICdvbmUnOwogICAgICAgIHJldHVybiAnb3RoZXInOwogICAgICB9LAogICAgICAnMTknOiBmdW5jdGlvbiBfKG4pIHsKICAgICAgICBpZiAoaXNCZXR3ZWVuKG4sIDIsIDEwKSkgcmV0dXJuICdmZXcnOwogICAgICAgIGlmIChpc0JldHdlZW4obiwgMCwgMSkpIHJldHVybiAnb25lJzsKICAgICAgICByZXR1cm4gJ290aGVyJzsKICAgICAgfSwKICAgICAgJzIwJzogZnVuY3Rpb24gXyhuKSB7CiAgICAgICAgaWYgKChpc0JldHdlZW4obiAlIDEwLCAzLCA0KSB8fCBuICUgMTAgPT0gOSkgJiYgIShpc0JldHdlZW4obiAlIDEwMCwgMTAsIDE5KSB8fCBpc0JldHdlZW4obiAlIDEwMCwgNzAsIDc5KSB8fCBpc0JldHdlZW4obiAlIDEwMCwgOTAsIDk5KSkpIHJldHVybiAnZmV3JzsKICAgICAgICBpZiAobiAlIDEwMDAwMDAgPT09IDAgJiYgbiAhPT0gMCkgcmV0dXJuICdtYW55JzsKICAgICAgICBpZiAobiAlIDEwID09IDIgJiYgIWlzSW4obiAlIDEwMCwgWzEyLCA3MiwgOTJdKSkgcmV0dXJuICd0d28nOwogICAgICAgIGlmIChuICUgMTAgPT0gMSAmJiAhaXNJbihuICUgMTAwLCBbMTEsIDcxLCA5MV0pKSByZXR1cm4gJ29uZSc7CiAgICAgICAgcmV0dXJuICdvdGhlcic7CiAgICAgIH0sCiAgICAgICcyMSc6IGZ1bmN0aW9uIF8obikgewogICAgICAgIGlmIChuID09PSAwKSByZXR1cm4gJ3plcm8nOwogICAgICAgIGlmIChuID09IDEpIHJldHVybiAnb25lJzsKICAgICAgICByZXR1cm4gJ290aGVyJzsKICAgICAgfSwKICAgICAgJzIyJzogZnVuY3Rpb24gXyhuKSB7CiAgICAgICAgaWYgKGlzQmV0d2VlbihuLCAwLCAxKSB8fCBpc0JldHdlZW4obiwgMTEsIDk5KSkgcmV0dXJuICdvbmUnOwogICAgICAgIHJldHVybiAnb3RoZXInOwogICAgICB9LAogICAgICAnMjMnOiBmdW5jdGlvbiBfKG4pIHsKICAgICAgICBpZiAoaXNCZXR3ZWVuKG4gJSAxMCwgMSwgMikgfHwgbiAlIDIwID09PSAwKSByZXR1cm4gJ29uZSc7CiAgICAgICAgcmV0dXJuICdvdGhlcic7CiAgICAgIH0sCiAgICAgICcyNCc6IGZ1bmN0aW9uIF8obikgewogICAgICAgIGlmIChpc0JldHdlZW4obiwgMywgMTApIHx8IGlzQmV0d2VlbihuLCAxMywgMTkpKSByZXR1cm4gJ2Zldyc7CiAgICAgICAgaWYgKGlzSW4obiwgWzIsIDEyXSkpIHJldHVybiAndHdvJzsKICAgICAgICBpZiAoaXNJbihuLCBbMSwgMTFdKSkgcmV0dXJuICdvbmUnOwogICAgICAgIHJldHVybiAnb3RoZXInOwogICAgICB9CiAgICB9OwogICAgdmFyIGluZGV4ID0gbG9jYWxlczJydWxlc1tsYW5nLnJlcGxhY2UoLy0uKiQvLCAnJyldOwoKICAgIGlmICghKGluZGV4IGluIHBsdXJhbFJ1bGVzKSkgewogICAgICBjb25zb2xlLndhcm4oJ3BsdXJhbCBmb3JtIHVua25vd24gZm9yIFsnICsgbGFuZyArICddJyk7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICdvdGhlcic7CiAgICAgIH07CiAgICB9CgogICAgcmV0dXJuIHBsdXJhbFJ1bGVzW2luZGV4XTsKICB9CgogIGdNYWNyb3MucGx1cmFsID0gZnVuY3Rpb24gKHN0ciwgcGFyYW0sIGtleSwgcHJvcCkgewogICAgdmFyIG4gPSBwYXJzZUZsb2F0KHBhcmFtKTsKICAgIGlmIChpc05hTihuKSkgcmV0dXJuIHN0cjsKICAgIGlmIChwcm9wICE9IGdUZXh0UHJvcCkgcmV0dXJuIHN0cjsKCiAgICBpZiAoIWdNYWNyb3MuX3BsdXJhbFJ1bGVzKSB7CiAgICAgIGdNYWNyb3MuX3BsdXJhbFJ1bGVzID0gZ2V0UGx1cmFsUnVsZXMoZ0xhbmd1YWdlKTsKICAgIH0KCiAgICB2YXIgaW5kZXggPSAnWycgKyBnTWFjcm9zLl9wbHVyYWxSdWxlcyhuKSArICddJzsKCiAgICBpZiAobiA9PT0gMCAmJiBrZXkgKyAnW3plcm9dJyBpbiBnTDEwbkRhdGEpIHsKICAgICAgc3RyID0gZ0wxMG5EYXRhW2tleSArICdbemVyb10nXVtwcm9wXTsKICAgIH0gZWxzZSBpZiAobiA9PSAxICYmIGtleSArICdbb25lXScgaW4gZ0wxMG5EYXRhKSB7CiAgICAgIHN0ciA9IGdMMTBuRGF0YVtrZXkgKyAnW29uZV0nXVtwcm9wXTsKICAgIH0gZWxzZSBpZiAobiA9PSAyICYmIGtleSArICdbdHdvXScgaW4gZ0wxMG5EYXRhKSB7CiAgICAgIHN0ciA9IGdMMTBuRGF0YVtrZXkgKyAnW3R3b10nXVtwcm9wXTsKICAgIH0gZWxzZSBpZiAoa2V5ICsgaW5kZXggaW4gZ0wxMG5EYXRhKSB7CiAgICAgIHN0ciA9IGdMMTBuRGF0YVtrZXkgKyBpbmRleF1bcHJvcF07CiAgICB9IGVsc2UgaWYgKGtleSArICdbb3RoZXJdJyBpbiBnTDEwbkRhdGEpIHsKICAgICAgc3RyID0gZ0wxMG5EYXRhW2tleSArICdbb3RoZXJdJ11bcHJvcF07CiAgICB9CgogICAgcmV0dXJuIHN0cjsKICB9OwoKICBmdW5jdGlvbiBnZXRMMTBuRGF0YShrZXksIGFyZ3MsIGZhbGxiYWNrKSB7CiAgICB2YXIgZGF0YSA9IGdMMTBuRGF0YVtrZXldOwoKICAgIGlmICghZGF0YSkgewogICAgICBjb25zb2xlLndhcm4oJyMnICsga2V5ICsgJyBpcyB1bmRlZmluZWQuJyk7CgogICAgICBpZiAoIWZhbGxiYWNrKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KCiAgICAgIGRhdGEgPSBmYWxsYmFjazsKICAgIH0KCiAgICB2YXIgcnYgPSB7fTsKCiAgICBmb3IgKHZhciBwcm9wIGluIGRhdGEpIHsKICAgICAgdmFyIHN0ciA9IGRhdGFbcHJvcF07CiAgICAgIHN0ciA9IHN1YnN0SW5kZXhlcyhzdHIsIGFyZ3MsIGtleSwgcHJvcCk7CiAgICAgIHN0ciA9IHN1YnN0QXJndW1lbnRzKHN0ciwgYXJncywga2V5KTsKICAgICAgcnZbcHJvcF0gPSBzdHI7CiAgICB9CgogICAgcmV0dXJuIHJ2OwogIH0KCiAgZnVuY3Rpb24gc3Vic3RJbmRleGVzKHN0ciwgYXJncywga2V5LCBwcm9wKSB7CiAgICB2YXIgcmVJbmRleCA9IC9ce1xbXHMqKFthLXpBLVpdKylcKChbYS16QS1aXSspXClccypcXVx9LzsKICAgIHZhciByZU1hdGNoID0gcmVJbmRleC5leGVjKHN0cik7CiAgICBpZiAoIXJlTWF0Y2ggfHwgIXJlTWF0Y2gubGVuZ3RoKSByZXR1cm4gc3RyOwogICAgdmFyIG1hY3JvTmFtZSA9IHJlTWF0Y2hbMV07CiAgICB2YXIgcGFyYW1OYW1lID0gcmVNYXRjaFsyXTsKICAgIHZhciBwYXJhbTsKCiAgICBpZiAoYXJncyAmJiBwYXJhbU5hbWUgaW4gYXJncykgewogICAgICBwYXJhbSA9IGFyZ3NbcGFyYW1OYW1lXTsKICAgIH0gZWxzZSBpZiAocGFyYW1OYW1lIGluIGdMMTBuRGF0YSkgewogICAgICBwYXJhbSA9IGdMMTBuRGF0YVtwYXJhbU5hbWVdOwogICAgfQoKICAgIGlmIChtYWNyb05hbWUgaW4gZ01hY3JvcykgewogICAgICB2YXIgbWFjcm8gPSBnTWFjcm9zW21hY3JvTmFtZV07CiAgICAgIHN0ciA9IG1hY3JvKHN0ciwgcGFyYW0sIGtleSwgcHJvcCk7CiAgICB9CgogICAgcmV0dXJuIHN0cjsKICB9CgogIGZ1bmN0aW9uIHN1YnN0QXJndW1lbnRzKHN0ciwgYXJncywga2V5KSB7CiAgICB2YXIgcmVBcmdzID0gL1x7XHtccyooLis/KVxzKlx9XH0vZzsKICAgIHJldHVybiBzdHIucmVwbGFjZShyZUFyZ3MsIGZ1bmN0aW9uIChtYXRjaGVkX3RleHQsIGFyZykgewogICAgICBpZiAoYXJncyAmJiBhcmcgaW4gYXJncykgewogICAgICAgIHJldHVybiBhcmdzW2FyZ107CiAgICAgIH0KCiAgICAgIGlmIChhcmcgaW4gZ0wxMG5EYXRhKSB7CiAgICAgICAgcmV0dXJuIGdMMTBuRGF0YVthcmddOwogICAgICB9CgogICAgICBjb25zb2xlLmxvZygnYXJndW1lbnQge3snICsgYXJnICsgJ319IGZvciAjJyArIGtleSArICcgaXMgdW5kZWZpbmVkLicpOwogICAgICByZXR1cm4gbWF0Y2hlZF90ZXh0OwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiB0cmFuc2xhdGVFbGVtZW50KGVsZW1lbnQpIHsKICAgIHZhciBsMTBuID0gZ2V0TDEwbkF0dHJpYnV0ZXMoZWxlbWVudCk7CiAgICBpZiAoIWwxMG4uaWQpIHJldHVybjsKICAgIHZhciBkYXRhID0gZ2V0TDEwbkRhdGEobDEwbi5pZCwgbDEwbi5hcmdzKTsKCiAgICBpZiAoIWRhdGEpIHsKICAgICAgY29uc29sZS53YXJuKCcjJyArIGwxMG4uaWQgKyAnIGlzIHVuZGVmaW5lZC4nKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChkYXRhW2dUZXh0UHJvcF0pIHsKICAgICAgaWYgKGdldENoaWxkRWxlbWVudENvdW50KGVsZW1lbnQpID09PSAwKSB7CiAgICAgICAgZWxlbWVudFtnVGV4dFByb3BdID0gZGF0YVtnVGV4dFByb3BdOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBjaGlsZHJlbiA9IGVsZW1lbnQuY2hpbGROb2RlczsKICAgICAgICB2YXIgZm91bmQgPSBmYWxzZTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjaGlsZHJlbi5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIGlmIChjaGlsZHJlbltpXS5ub2RlVHlwZSA9PT0gMyAmJiAvXFMvLnRlc3QoY2hpbGRyZW5baV0ubm9kZVZhbHVlKSkgewogICAgICAgICAgICBpZiAoZm91bmQpIHsKICAgICAgICAgICAgICBjaGlsZHJlbltpXS5ub2RlVmFsdWUgPSAnJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjaGlsZHJlbltpXS5ub2RlVmFsdWUgPSBkYXRhW2dUZXh0UHJvcF07CiAgICAgICAgICAgICAgZm91bmQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoIWZvdW5kKSB7CiAgICAgICAgICB2YXIgdGV4dE5vZGUgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShkYXRhW2dUZXh0UHJvcF0pOwogICAgICAgICAgZWxlbWVudC5pbnNlcnRCZWZvcmUodGV4dE5vZGUsIGVsZW1lbnQuZmlyc3RDaGlsZCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBkZWxldGUgZGF0YVtnVGV4dFByb3BdOwogICAgfQoKICAgIGZvciAodmFyIGsgaW4gZGF0YSkgewogICAgICBlbGVtZW50W2tdID0gZGF0YVtrXTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGdldENoaWxkRWxlbWVudENvdW50KGVsZW1lbnQpIHsKICAgIGlmIChlbGVtZW50LmNoaWxkcmVuKSB7CiAgICAgIHJldHVybiBlbGVtZW50LmNoaWxkcmVuLmxlbmd0aDsKICAgIH0KCiAgICBpZiAodHlwZW9mIGVsZW1lbnQuY2hpbGRFbGVtZW50Q291bnQgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHJldHVybiBlbGVtZW50LmNoaWxkRWxlbWVudENvdW50OwogICAgfQoKICAgIHZhciBjb3VudCA9IDA7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbGVtZW50LmNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgY291bnQgKz0gZWxlbWVudC5ub2RlVHlwZSA9PT0gMSA/IDEgOiAwOwogICAgfQoKICAgIHJldHVybiBjb3VudDsKICB9CgogIGZ1bmN0aW9uIHRyYW5zbGF0ZUZyYWdtZW50KGVsZW1lbnQpIHsKICAgIGVsZW1lbnQgPSBlbGVtZW50IHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKICAgIHZhciBjaGlsZHJlbiA9IGdldFRyYW5zbGF0YWJsZUNoaWxkcmVuKGVsZW1lbnQpOwogICAgdmFyIGVsZW1lbnRDb3VudCA9IGNoaWxkcmVuLmxlbmd0aDsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGVsZW1lbnRDb3VudDsgaSsrKSB7CiAgICAgIHRyYW5zbGF0ZUVsZW1lbnQoY2hpbGRyZW5baV0pOwogICAgfQoKICAgIHRyYW5zbGF0ZUVsZW1lbnQoZWxlbWVudCk7CiAgfQoKICByZXR1cm4gewogICAgZ2V0OiBmdW5jdGlvbiBnZXQoa2V5LCBhcmdzLCBmYWxsYmFja1N0cmluZykgewogICAgICB2YXIgaW5kZXggPSBrZXkubGFzdEluZGV4T2YoJy4nKTsKICAgICAgdmFyIHByb3AgPSBnVGV4dFByb3A7CgogICAgICBpZiAoaW5kZXggPiAwKSB7CiAgICAgICAgcHJvcCA9IGtleS5zdWJzdHJpbmcoaW5kZXggKyAxKTsKICAgICAgICBrZXkgPSBrZXkuc3Vic3RyaW5nKDAsIGluZGV4KTsKICAgICAgfQoKICAgICAgdmFyIGZhbGxiYWNrOwoKICAgICAgaWYgKGZhbGxiYWNrU3RyaW5nKSB7CiAgICAgICAgZmFsbGJhY2sgPSB7fTsKICAgICAgICBmYWxsYmFja1twcm9wXSA9IGZhbGxiYWNrU3RyaW5nOwogICAgICB9CgogICAgICB2YXIgZGF0YSA9IGdldEwxMG5EYXRhKGtleSwgYXJncywgZmFsbGJhY2spOwoKICAgICAgaWYgKGRhdGEgJiYgcHJvcCBpbiBkYXRhKSB7CiAgICAgICAgcmV0dXJuIGRhdGFbcHJvcF07CiAgICAgIH0KCiAgICAgIHJldHVybiAne3snICsga2V5ICsgJ319JzsKICAgIH0sCiAgICBnZXREYXRhOiBmdW5jdGlvbiBnZXREYXRhKCkgewogICAgICByZXR1cm4gZ0wxMG5EYXRhOwogICAgfSwKICAgIGdldFRleHQ6IGZ1bmN0aW9uIGdldFRleHQoKSB7CiAgICAgIHJldHVybiBnVGV4dERhdGE7CiAgICB9LAogICAgZ2V0TGFuZ3VhZ2U6IGZ1bmN0aW9uIGdldExhbmd1YWdlKCkgewogICAgICByZXR1cm4gZ0xhbmd1YWdlOwogICAgfSwKICAgIHNldExhbmd1YWdlOiBmdW5jdGlvbiBzZXRMYW5ndWFnZShsYW5nLCBjYWxsYmFjaykgewogICAgICBsb2FkTG9jYWxlKGxhbmcsIGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKCk7CiAgICAgIH0pOwogICAgfSwKICAgIGdldERpcmVjdGlvbjogZnVuY3Rpb24gZ2V0RGlyZWN0aW9uKCkgewogICAgICB2YXIgcnRsTGlzdCA9IFsnYXInLCAnaGUnLCAnZmEnLCAncHMnLCAndXInXTsKICAgICAgdmFyIHNob3J0Q29kZSA9IGdMYW5ndWFnZS5zcGxpdCgnLScsIDEpWzBdOwogICAgICByZXR1cm4gcnRsTGlzdC5pbmRleE9mKHNob3J0Q29kZSkgPj0gMCA/ICdydGwnIDogJ2x0cic7CiAgICB9LAogICAgdHJhbnNsYXRlOiB0cmFuc2xhdGVGcmFnbWVudCwKICAgIGdldFJlYWR5U3RhdGU6IGZ1bmN0aW9uIGdldFJlYWR5U3RhdGUoKSB7CiAgICAgIHJldHVybiBnUmVhZHlTdGF0ZTsKICAgIH0sCiAgICByZWFkeTogZnVuY3Rpb24gcmVhZHkoY2FsbGJhY2spIHsKICAgICAgaWYgKCFjYWxsYmFjaykgewogICAgICAgIHJldHVybjsKICAgICAgfSBlbHNlIGlmIChnUmVhZHlTdGF0ZSA9PSAnY29tcGxldGUnIHx8IGdSZWFkeVN0YXRlID09ICdpbnRlcmFjdGl2ZScpIHsKICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdsb2NhbGl6ZWQnLCBmdW5jdGlvbiBvbmNlKCkgewogICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbG9jYWxpemVkJywgb25jZSk7CiAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfTsKfSh3aW5kb3csIGRvY3VtZW50KTsKCi8qKiovIH0pLAovKiA0MSAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoidXNlIHN0cmljdCI7CgoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLlBERlByaW50U2VydmljZSA9IFBERlByaW50U2VydmljZTsKCnZhciBfdWlfdXRpbHMgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUpOwoKdmFyIF9hcHAgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDEpOwoKdmFyIF9hcHBfb3B0aW9ucyA9IF9fd2VicGFja19yZXF1aXJlX18oNik7Cgp2YXIgYWN0aXZlU2VydmljZSA9IG51bGw7CnZhciBvdmVybGF5TWFuYWdlciA9IG51bGw7CgpmdW5jdGlvbiByZW5kZXJQYWdlKGFjdGl2ZVNlcnZpY2VPbkVudHJ5LCBwZGZEb2N1bWVudCwgcGFnZU51bWJlciwgc2l6ZSkgewogIHZhciBzY3JhdGNoQ2FudmFzID0gYWN0aXZlU2VydmljZS5zY3JhdGNoQ2FudmFzOwogIHZhciBQUklOVF9SRVNPTFVUSU9OID0gX2FwcF9vcHRpb25zLkFwcE9wdGlvbnMuZ2V0KCJwcmludFJlc29sdXRpb24iKSB8fCAxNTA7CiAgdmFyIFBSSU5UX1VOSVRTID0gUFJJTlRfUkVTT0xVVElPTiAvIDcyLjA7CiAgc2NyYXRjaENhbnZhcy53aWR0aCA9IE1hdGguZmxvb3Ioc2l6ZS53aWR0aCAqIFBSSU5UX1VOSVRTKTsKICBzY3JhdGNoQ2FudmFzLmhlaWdodCA9IE1hdGguZmxvb3Ioc2l6ZS5oZWlnaHQgKiBQUklOVF9VTklUUyk7CiAgdmFyIHdpZHRoID0gTWF0aC5mbG9vcihzaXplLndpZHRoICogX3VpX3V0aWxzLkNTU19VTklUUykgKyAicHgiOwogIHZhciBoZWlnaHQgPSBNYXRoLmZsb29yKHNpemUuaGVpZ2h0ICogX3VpX3V0aWxzLkNTU19VTklUUykgKyAicHgiOwogIHZhciBjdHggPSBzY3JhdGNoQ2FudmFzLmdldENvbnRleHQoIjJkIik7CiAgY3R4LnNhdmUoKTsKICBjdHguZmlsbFN0eWxlID0gInJnYigyNTUsIDI1NSwgMjU1KSI7CiAgY3R4LmZpbGxSZWN0KDAsIDAsIHNjcmF0Y2hDYW52YXMud2lkdGgsIHNjcmF0Y2hDYW52YXMuaGVpZ2h0KTsKICBjdHgucmVzdG9yZSgpOwogIHJldHVybiBwZGZEb2N1bWVudC5nZXRQYWdlKHBhZ2VOdW1iZXIpLnRoZW4oZnVuY3Rpb24gKHBkZlBhZ2UpIHsKICAgIHZhciByZW5kZXJDb250ZXh0ID0gewogICAgICBjYW52YXNDb250ZXh0OiBjdHgsCiAgICAgIHRyYW5zZm9ybTogW1BSSU5UX1VOSVRTLCAwLCAwLCBQUklOVF9VTklUUywgMCwgMF0sCiAgICAgIHZpZXdwb3J0OiBwZGZQYWdlLmdldFZpZXdwb3J0KHsKICAgICAgICBzY2FsZTogMSwKICAgICAgICByb3RhdGlvbjogc2l6ZS5yb3RhdGlvbgogICAgICB9KSwKICAgICAgaW50ZW50OiAicHJpbnQiCiAgICB9OwogICAgcmV0dXJuIHBkZlBhZ2UucmVuZGVyKHJlbmRlckNvbnRleHQpLnByb21pc2U7CiAgfSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gewogICAgICB3aWR0aDogd2lkdGgsCiAgICAgIGhlaWdodDogaGVpZ2h0CiAgICB9OwogIH0pOwp9CgpmdW5jdGlvbiBQREZQcmludFNlcnZpY2UocGRmRG9jdW1lbnQsIHBhZ2VzT3ZlcnZpZXcsIHByaW50Q29udGFpbmVyLCBsMTBuKSB7CiAgdGhpcy5wZGZEb2N1bWVudCA9IHBkZkRvY3VtZW50OwogIHRoaXMucGFnZXNPdmVydmlldyA9IHBhZ2VzT3ZlcnZpZXc7CiAgdGhpcy5wcmludENvbnRhaW5lciA9IHByaW50Q29udGFpbmVyOwogIHRoaXMubDEwbiA9IGwxMG4gfHwgX3VpX3V0aWxzLk51bGxMMTBuOwogIHRoaXMuZGlzYWJsZUNyZWF0ZU9iamVjdFVSTCA9IF9hcHBfb3B0aW9ucy5BcHBPcHRpb25zLmdldCgiZGlzYWJsZUNyZWF0ZU9iamVjdFVSTCIpOwogIHRoaXMuY3VycmVudFBhZ2UgPSAtMTsKICB0aGlzLnNjcmF0Y2hDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKfQoKUERGUHJpbnRTZXJ2aWNlLnByb3RvdHlwZSA9IHsKICBsYXlvdXQ6IGZ1bmN0aW9uIGxheW91dCgpIHsKICAgIHRoaXMudGhyb3dJZkluYWN0aXZlKCk7CiAgICB2YXIgYm9keSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoImJvZHkiKTsKICAgIGJvZHkuc2V0QXR0cmlidXRlKCJkYXRhLXBkZmpzcHJpbnRpbmciLCB0cnVlKTsKICAgIHZhciBoYXNFcXVhbFBhZ2VTaXplcyA9IHRoaXMucGFnZXNPdmVydmlldy5ldmVyeShmdW5jdGlvbiAoc2l6ZSkgewogICAgICByZXR1cm4gc2l6ZS53aWR0aCA9PT0gdGhpcy5wYWdlc092ZXJ2aWV3WzBdLndpZHRoICYmIHNpemUuaGVpZ2h0ID09PSB0aGlzLnBhZ2VzT3ZlcnZpZXdbMF0uaGVpZ2h0OwogICAgfSwgdGhpcyk7CgogICAgaWYgKCFoYXNFcXVhbFBhZ2VTaXplcykgewogICAgICBjb25zb2xlLndhcm4oIk5vdCBhbGwgcGFnZXMgaGF2ZSB0aGUgc2FtZSBzaXplLiBUaGUgcHJpbnRlZCAiICsgInJlc3VsdCBtYXkgYmUgaW5jb3JyZWN0ISIpOwogICAgfQoKICAgIHRoaXMucGFnZVN0eWxlU2hlZXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHlsZSIpOwogICAgdmFyIHBhZ2VTaXplID0gdGhpcy5wYWdlc092ZXJ2aWV3WzBdOwogICAgdGhpcy5wYWdlU3R5bGVTaGVldC50ZXh0Q29udGVudCA9ICJAc3VwcG9ydHMgKChzaXplOkE0KSBhbmQgKHNpemU6MXB0IDFwdCkpIHsiICsgIkBwYWdlIHsgc2l6ZTogIiArIHBhZ2VTaXplLndpZHRoICsgInB0ICIgKyBwYWdlU2l6ZS5oZWlnaHQgKyAicHQ7fSIgKyAifSI7CiAgICBib2R5LmFwcGVuZENoaWxkKHRoaXMucGFnZVN0eWxlU2hlZXQpOwogIH0sCiAgZGVzdHJveTogZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgIGlmIChhY3RpdmVTZXJ2aWNlICE9PSB0aGlzKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzLnByaW50Q29udGFpbmVyLnRleHRDb250ZW50ID0gIiI7CiAgICB2YXIgYm9keSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoImJvZHkiKTsKICAgIGJvZHkucmVtb3ZlQXR0cmlidXRlKCJkYXRhLXBkZmpzcHJpbnRpbmciKTsKCiAgICBpZiAodGhpcy5wYWdlU3R5bGVTaGVldCkgewogICAgICB0aGlzLnBhZ2VTdHlsZVNoZWV0LnJlbW92ZSgpOwogICAgICB0aGlzLnBhZ2VTdHlsZVNoZWV0ID0gbnVsbDsKICAgIH0KCiAgICB0aGlzLnNjcmF0Y2hDYW52YXMud2lkdGggPSB0aGlzLnNjcmF0Y2hDYW52YXMuaGVpZ2h0ID0gMDsKICAgIHRoaXMuc2NyYXRjaENhbnZhcyA9IG51bGw7CiAgICBhY3RpdmVTZXJ2aWNlID0gbnVsbDsKICAgIGVuc3VyZU92ZXJsYXkoKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKG92ZXJsYXlNYW5hZ2VyLmFjdGl2ZSAhPT0gInByaW50U2VydmljZU92ZXJsYXkiKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBvdmVybGF5TWFuYWdlci5jbG9zZSgicHJpbnRTZXJ2aWNlT3ZlcmxheSIpOwogICAgfSk7CiAgfSwKICByZW5kZXJQYWdlczogZnVuY3Rpb24gcmVuZGVyUGFnZXMoKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIHZhciBwYWdlQ291bnQgPSB0aGlzLnBhZ2VzT3ZlcnZpZXcubGVuZ3RoOwoKICAgIHZhciByZW5kZXJOZXh0UGFnZSA9IGZ1bmN0aW9uIHJlbmRlck5leHRQYWdlKHJlc29sdmUsIHJlamVjdCkgewogICAgICBfdGhpcy50aHJvd0lmSW5hY3RpdmUoKTsKCiAgICAgIGlmICgrK190aGlzLmN1cnJlbnRQYWdlID49IHBhZ2VDb3VudCkgewogICAgICAgIHJlbmRlclByb2dyZXNzKHBhZ2VDb3VudCwgcGFnZUNvdW50LCBfdGhpcy5sMTBuKTsKICAgICAgICByZXNvbHZlKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgaW5kZXggPSBfdGhpcy5jdXJyZW50UGFnZTsKICAgICAgcmVuZGVyUHJvZ3Jlc3MoaW5kZXgsIHBhZ2VDb3VudCwgX3RoaXMubDEwbik7CiAgICAgIHJlbmRlclBhZ2UoX3RoaXMsIF90aGlzLnBkZkRvY3VtZW50LCBpbmRleCArIDEsIF90aGlzLnBhZ2VzT3ZlcnZpZXdbaW5kZXhdKS50aGVuKF90aGlzLnVzZVJlbmRlcmVkUGFnZS5iaW5kKF90aGlzKSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgcmVuZGVyTmV4dFBhZ2UocmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgfSwgcmVqZWN0KTsKICAgIH07CgogICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlbmRlck5leHRQYWdlKTsKICB9LAogIHVzZVJlbmRlcmVkUGFnZTogZnVuY3Rpb24gdXNlUmVuZGVyZWRQYWdlKHByaW50SXRlbSkgewogICAgdGhpcy50aHJvd0lmSW5hY3RpdmUoKTsKICAgIHZhciBpbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbWciKTsKICAgIGltZy5zdHlsZS53aWR0aCA9IHByaW50SXRlbS53aWR0aDsKICAgIGltZy5zdHlsZS5oZWlnaHQgPSBwcmludEl0ZW0uaGVpZ2h0OwogICAgdmFyIHNjcmF0Y2hDYW52YXMgPSB0aGlzLnNjcmF0Y2hDYW52YXM7CgogICAgaWYgKCJ0b0Jsb2IiIGluIHNjcmF0Y2hDYW52YXMgJiYgIXRoaXMuZGlzYWJsZUNyZWF0ZU9iamVjdFVSTCkgewogICAgICBzY3JhdGNoQ2FudmFzLnRvQmxvYihmdW5jdGlvbiAoYmxvYikgewogICAgICAgIGltZy5zcmMgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGltZy5zcmMgPSBzY3JhdGNoQ2FudmFzLnRvRGF0YVVSTCgpOwogICAgfQoKICAgIHZhciB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICB3cmFwcGVyLmFwcGVuZENoaWxkKGltZyk7CiAgICB0aGlzLnByaW50Q29udGFpbmVyLmFwcGVuZENoaWxkKHdyYXBwZXIpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgaW1nLm9ubG9hZCA9IHJlc29sdmU7CiAgICAgIGltZy5vbmVycm9yID0gcmVqZWN0OwogICAgfSk7CiAgfSwKICBwZXJmb3JtUHJpbnQ6IGZ1bmN0aW9uIHBlcmZvcm1QcmludCgpIHsKICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgIHRoaXMudGhyb3dJZkluYWN0aXZlKCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUpIHsKICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKCFfdGhpczIuYWN0aXZlKSB7CiAgICAgICAgICByZXNvbHZlKCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBwcmludC5jYWxsKHdpbmRvdyk7CiAgICAgICAgc2V0VGltZW91dChyZXNvbHZlLCAyMCk7CiAgICAgIH0sIDApOwogICAgfSk7CiAgfSwKCiAgZ2V0IGFjdGl2ZSgpIHsKICAgIHJldHVybiB0aGlzID09PSBhY3RpdmVTZXJ2aWNlOwogIH0sCgogIHRocm93SWZJbmFjdGl2ZTogZnVuY3Rpb24gdGhyb3dJZkluYWN0aXZlKCkgewogICAgaWYgKCF0aGlzLmFjdGl2ZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoaXMgcHJpbnQgcmVxdWVzdCB3YXMgY2FuY2VsbGVkIG9yIGNvbXBsZXRlZC4iKTsKICAgIH0KICB9Cn07CnZhciBwcmludCA9IHdpbmRvdy5wcmludDsKCndpbmRvdy5wcmludCA9IGZ1bmN0aW9uICgpIHsKICBpZiAoYWN0aXZlU2VydmljZSkgewogICAgY29uc29sZS53YXJuKCJJZ25vcmVkIHdpbmRvdy5wcmludCgpIGJlY2F1c2Ugb2YgYSBwZW5kaW5nIHByaW50IGpvYi4iKTsKICAgIHJldHVybjsKICB9CgogIGVuc3VyZU92ZXJsYXkoKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgIGlmIChhY3RpdmVTZXJ2aWNlKSB7CiAgICAgIG92ZXJsYXlNYW5hZ2VyLm9wZW4oInByaW50U2VydmljZU92ZXJsYXkiKTsKICAgIH0KICB9KTsKCiAgdHJ5IHsKICAgIGRpc3BhdGNoRXZlbnQoImJlZm9yZXByaW50Iik7CiAgfSBmaW5hbGx5IHsKICAgIGlmICghYWN0aXZlU2VydmljZSkgewogICAgICBjb25zb2xlLmVycm9yKCJFeHBlY3RlZCBwcmludCBzZXJ2aWNlIHRvIGJlIGluaXRpYWxpemVkLiIpOwogICAgICBlbnN1cmVPdmVybGF5KCkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKG92ZXJsYXlNYW5hZ2VyLmFjdGl2ZSA9PT0gInByaW50U2VydmljZU92ZXJsYXkiKSB7CiAgICAgICAgICBvdmVybGF5TWFuYWdlci5jbG9zZSgicHJpbnRTZXJ2aWNlT3ZlcmxheSIpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgYWN0aXZlU2VydmljZU9uRW50cnkgPSBhY3RpdmVTZXJ2aWNlOwogICAgYWN0aXZlU2VydmljZS5yZW5kZXJQYWdlcygpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gYWN0aXZlU2VydmljZU9uRW50cnkucGVyZm9ybVByaW50KCk7CiAgICB9KVsiY2F0Y2giXShmdW5jdGlvbiAoKSB7fSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChhY3RpdmVTZXJ2aWNlT25FbnRyeS5hY3RpdmUpIHsKICAgICAgICBhYm9ydCgpOwogICAgICB9CiAgICB9KTsKICB9Cn07CgpmdW5jdGlvbiBkaXNwYXRjaEV2ZW50KGV2ZW50VHlwZSkgewogIHZhciBldmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCJDdXN0b21FdmVudCIpOwogIGV2ZW50LmluaXRDdXN0b21FdmVudChldmVudFR5cGUsIGZhbHNlLCBmYWxzZSwgImN1c3RvbSIpOwogIHdpbmRvdy5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKfQoKZnVuY3Rpb24gYWJvcnQoKSB7CiAgaWYgKGFjdGl2ZVNlcnZpY2UpIHsKICAgIGFjdGl2ZVNlcnZpY2UuZGVzdHJveSgpOwogICAgZGlzcGF0Y2hFdmVudCgiYWZ0ZXJwcmludCIpOwogIH0KfQoKZnVuY3Rpb24gcmVuZGVyUHJvZ3Jlc3MoaW5kZXgsIHRvdGFsLCBsMTBuKSB7CiAgdmFyIHByb2dyZXNzQ29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInByaW50U2VydmljZU92ZXJsYXkiKTsKICB2YXIgcHJvZ3Jlc3MgPSBNYXRoLnJvdW5kKDEwMCAqIGluZGV4IC8gdG90YWwpOwogIHZhciBwcm9ncmVzc0JhciA9IHByb2dyZXNzQ29udGFpbmVyLnF1ZXJ5U2VsZWN0b3IoInByb2dyZXNzIik7CiAgdmFyIHByb2dyZXNzUGVyYyA9IHByb2dyZXNzQ29udGFpbmVyLnF1ZXJ5U2VsZWN0b3IoIi5yZWxhdGl2ZS1wcm9ncmVzcyIpOwogIHByb2dyZXNzQmFyLnZhbHVlID0gcHJvZ3Jlc3M7CiAgbDEwbi5nZXQoInByaW50X3Byb2dyZXNzX3BlcmNlbnQiLCB7CiAgICBwcm9ncmVzczogcHJvZ3Jlc3MKICB9LCBwcm9ncmVzcyArICIlIikudGhlbihmdW5jdGlvbiAobXNnKSB7CiAgICBwcm9ncmVzc1BlcmMudGV4dENvbnRlbnQgPSBtc2c7CiAgfSk7Cn0KCndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgaWYgKGV2ZW50LmtleUNvZGUgPT09IDgwICYmIChldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkpICYmICFldmVudC5hbHRLZXkgJiYgKCFldmVudC5zaGlmdEtleSB8fCB3aW5kb3cuY2hyb21lIHx8IHdpbmRvdy5vcGVyYSkpIHsKICAgIHdpbmRvdy5wcmludCgpOwogICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKCiAgICBpZiAoZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKSB7CiAgICAgIGV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwogICAgfSBlbHNlIHsKICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICB9CiAgfQp9LCB0cnVlKTsKCmlmICgib25iZWZvcmVwcmludCIgaW4gd2luZG93KSB7CiAgdmFyIHN0b3BQcm9wYWdhdGlvbklmTmVlZGVkID0gZnVuY3Rpb24gc3RvcFByb3BhZ2F0aW9uSWZOZWVkZWQoZXZlbnQpIHsKICAgIGlmIChldmVudC5kZXRhaWwgIT09ICJjdXN0b20iICYmIGV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbikgewogICAgICBldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKICAgIH0KICB9OwoKICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigiYmVmb3JlcHJpbnQiLCBzdG9wUHJvcGFnYXRpb25JZk5lZWRlZCk7CiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImFmdGVycHJpbnQiLCBzdG9wUHJvcGFnYXRpb25JZk5lZWRlZCk7Cn0KCnZhciBvdmVybGF5UHJvbWlzZTsKCmZ1bmN0aW9uIGVuc3VyZU92ZXJsYXkoKSB7CiAgaWYgKCFvdmVybGF5UHJvbWlzZSkgewogICAgb3ZlcmxheU1hbmFnZXIgPSBfYXBwLlBERlZpZXdlckFwcGxpY2F0aW9uLm92ZXJsYXlNYW5hZ2VyOwoKICAgIGlmICghb3ZlcmxheU1hbmFnZXIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgb3ZlcmxheSBtYW5hZ2VyIGhhcyBub3QgeWV0IGJlZW4gaW5pdGlhbGl6ZWQuIik7CiAgICB9CgogICAgb3ZlcmxheVByb21pc2UgPSBvdmVybGF5TWFuYWdlci5yZWdpc3RlcigicHJpbnRTZXJ2aWNlT3ZlcmxheSIsIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJwcmludFNlcnZpY2VPdmVybGF5IiksIGFib3J0LCB0cnVlKTsKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJwcmludENhbmNlbCIpLm9uY2xpY2sgPSBhYm9ydDsKICB9CgogIHJldHVybiBvdmVybGF5UHJvbWlzZTsKfQoKX2FwcC5QREZQcmludFNlcnZpY2VGYWN0b3J5Lmluc3RhbmNlID0gewogIHN1cHBvcnRzUHJpbnRpbmc6IHRydWUsCiAgY3JlYXRlUHJpbnRTZXJ2aWNlOiBmdW5jdGlvbiBjcmVhdGVQcmludFNlcnZpY2UocGRmRG9jdW1lbnQsIHBhZ2VzT3ZlcnZpZXcsIHByaW50Q29udGFpbmVyLCBsMTBuKSB7CiAgICBpZiAoYWN0aXZlU2VydmljZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBwcmludCBzZXJ2aWNlIGlzIGNyZWF0ZWQgYW5kIGFjdGl2ZS4iKTsKICAgIH0KCiAgICBhY3RpdmVTZXJ2aWNlID0gbmV3IFBERlByaW50U2VydmljZShwZGZEb2N1bWVudCwgcGFnZXNPdmVydmlldywgcHJpbnRDb250YWluZXIsIGwxMG4pOwogICAgcmV0dXJuIGFjdGl2ZVNlcnZpY2U7CiAgfQp9OwoKLyoqKi8gfSkKLyoqKioqKi8gXSk7Ci8vIyBzb3VyY2VNYXBwaW5nVVJMPXZpZXdlci5qcy5tYXAK';
  export function getBundle() {
    return bundle;
  }
  export function getBundleMd5() {
    return 'd2035704874125838463e0b871be9d76';
  }
  export function getFileName() {
    return 'viewer.js';
  }
  